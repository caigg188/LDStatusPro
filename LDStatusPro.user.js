 // ==UserScript==
    // @name         LDStatus Pro
    // @namespace    http://tampermonkey.net/
    // @version      3.5.4.13
    // @description  åœ¨ Linux.do å’Œ IDCFlare é¡µé¢æ˜¾ç¤ºä¿¡ä»»çº§åˆ«è¿›åº¦ï¼Œæ”¯æŒå†å²è¶‹åŠ¿ã€é‡Œç¨‹ç¢‘é€šçŸ¥ã€é˜…è¯»æ—¶é—´ç»Ÿè®¡ã€æ’è¡Œæ¦œç³»ç»Ÿã€æˆ‘çš„æ´»åŠ¨æŸ¥çœ‹ã€‚ä¸¤ç«™ç‚¹å‡æ”¯æŒæ’è¡Œæ¦œå’Œäº‘åŒæ­¥åŠŸèƒ½
    // @author       JackLiii
    // @license      MIT
    // @match        https://linux.do/*
    // @match        https://idcflare.com/*
    // @match        https://cdk.linux.do/*
    // @match        https://credit.linux.do/*
    // @run-at       document-start
    // @grant        GM_xmlhttpRequest
    // @grant        GM_setValue    
    // @grant        GM_getValue
    // @grant        GM_info
    // @grant        GM_notification
    // @connect      connect.linux.do
    // @connect      linux.do
    // @connect      credit.linux.do
    // @connect      cdk.linux.do
    // @connect      connect.idcflare.com
    // @connect      idcflare.com
    // @connect      github.com
    // @connect      raw.githubusercontent.com
    // @connect      api.ldspro.qzz.io
    // @updateURL    https://raw.githubusercontent.com/caigg188/LDStatusPro/main/LDStatusPro.user.js
    // @downloadURL  https://raw.githubusercontent.com/caigg188/LDStatusPro/main/LDStatusPro.user.js
    // @icon         https://linux.do/uploads/default/optimized/4X/6/a/6/6a6affc7b1ce8140279e959d32671304db06d5ab_2_180x180.png
    // ==/UserScript==

    (function() {
        'use strict';

        // ==================== CDK/LDC æ¡¥æ¥é¡µé¢ ====================
        // åœ¨ cdk.linux.do æˆ– credit.linux.do è¿è¡Œæ—¶ä½œä¸ºæ•°æ®æ¡¥æ¥ï¼Œç”¨åŸç”Ÿ fetch è¯·æ±‚ APIï¼ˆåŒåŸŸè‡ªåŠ¨å¸¦ cookieï¼‰
        if (location.hostname === 'cdk.linux.do') {
            window.addEventListener('message', async (e) => {
                if (!ALLOWED_ORIGINS.includes(e.origin) || e.data?.type !== 'ldsp-cdk-request') {
                    debugBridgeLog('CDK bridge reject', { origin: e.origin, type: e.data?.type });
                    return;
                }
                const { requestId, url } = e.data;
                try {
                    const res = await fetch(url, { credentials: 'include' });
                    let data;
                    try { data = await res.json(); } catch { data = { _error: 'è§£æå¤±è´¥' }; }
                    window.parent?.postMessage({ type: 'ldsp-cdk-response', requestId, status: res.status, data }, e.origin);
                } catch (err) {
                    debugBridgeLog('CDK bridge error', err?.message || err);
                    window.parent?.postMessage({ type: 'ldsp-cdk-response', requestId, status: 0, data: { _error: 'ç½‘ç»œé”™è¯¯' } }, e.origin);
                }
            });
            return; // æ¡¥æ¥é¡µé¢ä¸æ‰§è¡Œä¸»ç¨‹åº
        }
        
        // LDC (credit.linux.do) æ¡¥æ¥
        if (location.hostname === 'credit.linux.do') {
            window.addEventListener('message', async (e) => {
                if (!ALLOWED_ORIGINS.includes(e.origin) || e.data?.type !== 'ldsp-ldc-request') {
                    debugBridgeLog('LDC bridge reject', { origin: e.origin, type: e.data?.type });
                    return;
                }
                const { requestId, url, method = 'GET', data } = e.data;
                try {
                    const res = await fetch(url, {
                        method,
                        credentials: 'include',
                        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                        body: data ? JSON.stringify(data) : undefined
                    });
                    let resData;
                    try { resData = await res.json(); } catch { resData = { _error: 'è§£æå¤±è´¥' }; }
                    window.parent?.postMessage({ type: 'ldsp-ldc-response', requestId, status: res.status, data: resData }, e.origin);
                } catch (err) {
                    debugBridgeLog('LDC bridge error', err?.message || err);
                    window.parent?.postMessage({ type: 'ldsp-ldc-response', requestId, status: 0, data: { _error: 'ç½‘ç»œé”™è¯¯' } }, e.origin);
                }
            });
            return; // æ¡¥æ¥é¡µé¢ä¸æ‰§è¡Œä¸»ç¨‹åº
        }

        // ==================== å°½æ—©æ•è· OAuth ç™»å½•ç»“æœ =====================
        // ç”±äº Discourse è·¯ç”±å¯èƒ½ä¼šå¤„ç†æ‰ URL hashï¼Œéœ€è¦åœ¨è„šæœ¬æœ€å¼€å§‹å°±æå–
        let _pendingOAuthData = null;
        try {
            const hash = window.location.hash;
            console.log('[OAuth] Initial hash check:', hash ? hash.substring(0, 100) + '...' : '(empty)');
            if (hash) {
                const match = hash.match(/ldsp_oauth=([^&]+)/);
                if (match) {
                    console.log('[OAuth] Found ldsp_oauth in hash, decoding...');
                    const encoded = match[1];
                    const decoded = JSON.parse(decodeURIComponent(atob(encoded)));
                    console.log('[OAuth] Decoded data:', { hasToken: !!decoded.t, hasUser: !!decoded.u, ts: decoded.ts });
                    // æ£€æŸ¥æ—¶æ•ˆæ€§ï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
                    if (decoded.ts && Date.now() - decoded.ts < 5 * 60 * 1000) {
                        _pendingOAuthData = {
                            success: true,
                            token: decoded.t,
                            user: decoded.u,
                            isJoined: decoded.j === 1
                        };
                        console.log('[OAuth] âœ… Captured login data from URL hash, user:', decoded.u?.username);
                    } else {
                        console.log('[OAuth] âš ï¸ Login data expired, age:', Date.now() - decoded.ts, 'ms');
                    }
                    // ç«‹å³æ¸…é™¤ URL ä¸­çš„ç™»å½•å‚æ•°
                    let newHash = hash.replace(/[#&]?ldsp_oauth=[^&]*/, '').replace(/^[#&]+/, '').replace(/[#&]+$/, '');
                    const newUrl = window.location.pathname + window.location.search + (newHash ? '#' + newHash : '');
                    history.replaceState(null, '', newUrl);
                }
            }
        } catch (e) {
            console.warn('[OAuth] Failed to capture OAuth data:', e);
        }

        // ==================== æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥ ====================
        // æ£€æµ‹å¿…éœ€çš„ API æ˜¯å¦å­˜åœ¨
        if (typeof Map === 'undefined' || typeof Set === 'undefined' || typeof Promise === 'undefined') {
            console.error('[LDStatus Pro] æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½ï¼Œè¯·å‡çº§æµè§ˆå™¨');
            return;
        }

        // å…¼å®¹æ€§ï¼šrequestIdleCallback polyfillï¼ˆFirefox å’Œæ—§ç‰ˆæµè§ˆå™¨ï¼‰
        const requestIdleCallback = window.requestIdleCallback || function(cb) {
            const start = Date.now();
            return setTimeout(() => cb({ didTimeout: false, timeRemaining: () => Math.max(0, 50 - (Date.now() - start)) }), 1);
        };
        const _cancelIdleCallback = window.cancelIdleCallback || clearTimeout;
        const ALLOWED_ORIGINS = ['https://linux.do', 'https://www.linux.do', 'https://idcflare.com', 'https://www.idcflare.com'];
        const DEBUG = {
            bridgeLogs: (typeof GM_getValue === 'function' && GM_getValue('ldsp_debug_bridge', false)) || false
        };
        const debugBridgeLog = (...args) => {
            if (DEBUG.bridgeLogs) console.debug('[LDSP][bridge]', ...args);
        };

        // ==================== ç½‘ç«™é…ç½® ====================
        const SITE_CONFIGS = {
            'linux.do': {
                name: 'Linux.do',
                icon: 'https://linux.do/uploads/default/optimized/4X/6/a/6/6a6affc7b1ce8140279e959d32671304db06d5ab_2_180x180.png',
                apiUrl: 'https://connect.linux.do',
                supportsLeaderboard: true
            },
            'idcflare.com': {
                name: 'IDCFlare',
                icon: 'https://idcflare.com/uploads/default/optimized/1X/8746f94a48ddc8140e8c7a52084742f38d3f5085_2_180x180.png',
                apiUrl: 'https://connect.idcflare.com',
                supportsLeaderboard: true
            }
        };

        const CURRENT_SITE = (() => {
            const hostname = window.location.hostname;
            for (const [domain, config] of Object.entries(SITE_CONFIGS)) {
                if (hostname === domain || hostname.endsWith(`.${domain}`)) {
                    return { domain, prefix: domain.replace('.', '_'), ...config };
                }
            }
            return null;
        })();

        if (!CURRENT_SITE) {
            console.warn('[LDStatus Pro] ä¸æ”¯æŒçš„ç½‘ç«™');
            return;
        }

        // ==================== Discourse é‰´æƒå¤´å·¥å…· ====================
        const getCsrfToken = () => document.querySelector('meta[name="csrf-token"]')?.content || '';
        const buildAuthHeaders = (url, extra = {}) => {
            const headers = { ...extra };
            let host = '';
            try { host = new URL(url, location.href).hostname; } catch {}
            const needDiscourseHeaders = host && (host.endsWith('linux.do') || host.endsWith('idcflare.com'));
            if (needDiscourseHeaders) {
                if (!headers['X-Requested-With'] && !headers['x-requested-with']) headers['X-Requested-With'] = 'XMLHttpRequest';
                if (!headers['Discourse-Logged-In']) headers['Discourse-Logged-In'] = 'true';
                if (!headers['Discourse-Present']) headers['Discourse-Present'] = 'true';
                const csrf = getCsrfToken();
                if (csrf && !headers['X-CSRF-Token'] && !headers['x-csrf-token']) headers['X-CSRF-Token'] = csrf;
                if (!headers['Referer']) headers['Referer'] = `${location.origin}/`;
            }
            return headers;
        };

        // ==================== äº‹ä»¶æ€»çº¿ï¼ˆè·¨æ¨¡å—é€šä¿¡ï¼‰ ====================
        const EventBus = {
            _listeners: new Map(),
            
            // è®¢é˜…äº‹ä»¶
            on(event, callback) {
                if (!this._listeners.has(event)) {
                    this._listeners.set(event, new Set());
                }
                this._listeners.get(event).add(callback);
                // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
                return () => this.off(event, callback);
            },
            
            // å–æ¶ˆè®¢é˜…
            off(event, callback) {
                this._listeners.get(event)?.delete(callback);
            },
            
            // å‘å¸ƒäº‹ä»¶
            emit(event, data) {
                this._listeners.get(event)?.forEach(cb => {
                    try { cb(data); } catch (e) { /* é™é»˜å¤±è´¥ */ }
                });
            },
            
            // ä¸€æ¬¡æ€§è®¢é˜…
            once(event, callback) {
                const wrapper = (data) => {
                    this.off(event, wrapper);
                    callback(data);
                };
                return this.on(event, wrapper);
            },
            
            // æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
            clear() {
                this._listeners.clear();
            }
        };

        // ==================== è·¨æ ‡ç­¾é¡µé¢†å¯¼è€…ç®¡ç†å™¨ï¼ˆå…¨å±€å•ä¾‹ï¼‰ ====================
        // ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ ‡ç­¾é¡µæ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼ˆé˜…è¯»è®¡æ—¶ã€åŒæ­¥ã€åˆ·æ–°ç­‰ï¼‰
        const TabLeader = {
            LEADER_KEY: `ldsp_tab_leader_${CURRENT_SITE.prefix}`,
            HEARTBEAT: 5000,    // 5ç§’å¿ƒè·³
            TIMEOUT: 10000,     // 10ç§’è¶…æ—¶ï¼ˆå‡å°‘é™ˆæ—§æ•°æ®å¯¼è‡´çš„ç­‰å¾…æ—¶é—´ï¼‰
            _tabId: Date.now().toString(36) + Math.random().toString(36).slice(2, 8),
            _isLeader: false,
            _initialized: false,
            _interval: null,
            _callbacks: [],     // é¢†å¯¼è€…çŠ¶æ€å˜åŒ–å›è°ƒ
            
            init() {
                if (this._initialized) return;
                this._initialized = true;
                
                this._tryBecomeLeader();
                this._interval = setInterval(() => this._tryBecomeLeader(), this.HEARTBEAT);
                
                // ç›‘å¬å…¶ä»–æ ‡ç­¾é¡µçš„å˜åŒ–
                this._storageHandler = (e) => {
                    if (e.key === this.LEADER_KEY) this._tryBecomeLeader();
                };
                window.addEventListener('storage', this._storageHandler);
                
                // é¡µé¢å¸è½½æ—¶é‡Šæ”¾é¢†å¯¼è€…
                this._unloadHandler = () => this._release();
                window.addEventListener('beforeunload', this._unloadHandler);
            },
            
            _tryBecomeLeader() {
                const now = Date.now();
                let data = {};
                
                // æ£€æŸ¥ localStorage æ˜¯å¦å¯ç”¨ï¼ˆéšç§æ¨¡å¼ã€å­˜å‚¨æ»¡ç­‰æƒ…å†µï¼‰
                if (!this._storageAvailable) {
                    if (this._storageAvailable === undefined) {
                        try {
                            const testKey = '__ldsp_test__';
                            localStorage.setItem(testKey, '1');
                            localStorage.removeItem(testKey);
                            this._storageAvailable = true;
                        } catch (e) {
                            this._storageAvailable = false;
                            Logger.log('localStorage not available, becoming sole leader');
                        }
                    }
                    // localStorage ä¸å¯ç”¨ï¼Œç›´æ¥æˆä¸ºé¢†å¯¼è€…
                    if (!this._storageAvailable) {
                        if (!this._isLeader) {
                            this._isLeader = true;
                            this._notifyCallbacks(true);
                            EventBus.emit('leader:change', { isLeader: true, tabId: this._tabId });
                        }
                        return;
                    }
                }
                
                try {
                    const stored = localStorage.getItem(this.LEADER_KEY);
                    if (stored) data = JSON.parse(stored);
                } catch (e) { /* è§£æå¤±è´¥è§†ä¸ºæ— æ•°æ® */ }
                
                const expired = !data.timestamp || (now - data.timestamp) > this.TIMEOUT;
                const iAmLeader = data.tabId === this._tabId;
                
                if (expired || iAmLeader) {
                    const wasLeader = this._isLeader;
                    this._isLeader = true;
                    try {
                        localStorage.setItem(this.LEADER_KEY, JSON.stringify({
                            tabId: this._tabId,
                            timestamp: now
                        }));
                    } catch (e) { /* å­˜å‚¨å¤±è´¥ä¸å½±å“é€»è¾‘ */ }
                    if (!wasLeader) {
                        this._notifyCallbacks(true);
                        EventBus.emit('leader:change', { isLeader: true, tabId: this._tabId });
                    }
                } else if (this._isLeader) {
                    this._isLeader = false;
                    this._notifyCallbacks(false);
                    EventBus.emit('leader:change', { isLeader: false, tabId: this._tabId });
                }
            },
            
            _release() {
                if (this._isLeader) {
                    try {
                        const stored = localStorage.getItem(this.LEADER_KEY);
                        if (stored) {
                            const data = JSON.parse(stored);
                            if (data.tabId === this._tabId) {
                                localStorage.removeItem(this.LEADER_KEY);
                            }
                        }
                    } catch (e) { /* é™é»˜å¤±è´¥ */ }
                }
            },
            
            _notifyCallbacks(isLeader) {
                this._callbacks.forEach(cb => {
                    try { cb(isLeader); } catch (e) { /* é™é»˜å¤±è´¥ */ }
                });
            },
            
            // å…¬å¼€æ–¹æ³•ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯é¢†å¯¼è€…
            isLeader() {
                return this._isLeader;
            },
            
            // å…¬å¼€æ–¹æ³•ï¼šè·å–å½“å‰æ ‡ç­¾é¡µ ID
            getTabId() {
                return this._tabId;
            },
            
            // å…¬å¼€æ–¹æ³•ï¼šæ³¨å†Œé¢†å¯¼è€…çŠ¶æ€å˜åŒ–å›è°ƒ
            onLeaderChange(callback) {
                if (typeof callback === 'function') {
                    this._callbacks.push(callback);
                }
            },
            
            // å…¬å¼€æ–¹æ³•ï¼šé”€æ¯
            destroy() {
                if (this._interval) {
                    clearInterval(this._interval);
                    this._interval = null;
                }
                if (this._storageHandler) {
                    window.removeEventListener('storage', this._storageHandler);
                }
                if (this._unloadHandler) {
                    window.removeEventListener('beforeunload', this._unloadHandler);
                }
                this._release();
                this._callbacks = [];
                this._initialized = false;
            }
        };

        // ==================== å¸¸é‡é…ç½® ====================
        const CONFIG = {
            // æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰- ä¼˜åŒ–ç‰ˆï¼šå‡å°‘è¯·æ±‚é¢‘ç‡
            INTERVALS: {
                REFRESH: 300000,           // æ•°æ®åˆ·æ–°é—´éš”
                READING_TRACK: 10000,      // é˜…è¯»è¿½è¸ªé—´éš”
                READING_SAVE: 30000,       // é˜…è¯»ä¿å­˜é—´éš”
                READING_IDLE: 60000,       // ç©ºé—²é˜ˆå€¼
                STORAGE_DEBOUNCE: 1000,    // å­˜å‚¨é˜²æŠ–
                READING_UPDATE: 2000,      // é˜…è¯»æ—¶é—´UIæ›´æ–°ï¼ˆ2ç§’ï¼Œå‡å°‘æ›´æ–°é¢‘ç‡é¿å…åŠ¨ç”»é—ªçƒï¼‰
                LEADERBOARD_SYNC: 900000,  // æ’è¡Œæ¦œåŒæ­¥ï¼ˆ15åˆ†é’Ÿï¼ŒåŸ10åˆ†é’Ÿï¼‰
                CLOUD_UPLOAD: 3600000,     // äº‘åŒæ­¥ä¸Šä¼ ï¼ˆ60åˆ†é’Ÿï¼ŒåŸ30åˆ†é’Ÿï¼‰
                CLOUD_DOWNLOAD: 43200000,  // äº‘åŒæ­¥ä¸‹è½½ï¼ˆ12å°æ—¶ï¼ŒåŸ6å°æ—¶ï¼‰
                CLOUD_CHECK: 600000,       // äº‘åŒæ­¥æ£€æŸ¥ï¼ˆ10åˆ†é’Ÿï¼ŒåŸ5åˆ†é’Ÿï¼‰
                REQ_SYNC_INCREMENTAL: 3600000, // å‡çº§è¦æ±‚å¢é‡åŒæ­¥ï¼ˆ1å°æ—¶ï¼‰
                REQ_SYNC_FULL: 43200000,   // å‡çº§è¦æ±‚å…¨é‡åŒæ­¥ï¼ˆ12å°æ—¶ï¼Œä¸readingåŒæ­¥é—´éš”ä¸€è‡´ï¼‰
                SYNC_RETRY_DELAY: 60000    // åŒæ­¥å¤±è´¥åé‡è¯•å»¶è¿Ÿï¼ˆ1åˆ†é’Ÿï¼‰
            },
            // ç¼“å­˜é…ç½®
            CACHE: {
                MAX_HISTORY_DAYS: 365,
                LRU_SIZE: 50,
                VALUE_TTL: 5000,
                SCREEN_TTL: 100,
                YEAR_DATA_TTL: 5000,
                HISTORY_TTL: 1000,
                LEADERBOARD_DAILY_TTL: 600000,     // æ—¥æ¦œç¼“å­˜ 10 åˆ†é’Ÿï¼ˆå‡å°‘è¯·æ±‚é¢‘ç‡ï¼‰
                LEADERBOARD_WEEKLY_TTL: 7200000,   // å‘¨æ¦œç¼“å­˜ 2 å°æ—¶
                LEADERBOARD_MONTHLY_TTL: 21600000  // æœˆæ¦œç¼“å­˜ 6 å°æ—¶
            },
            // ç½‘ç»œé…ç½®
            NETWORK: {
                RETRY_COUNT: 3,
                RETRY_DELAY: 1000,
                TIMEOUT: 15000
            },
            // é‡Œç¨‹ç¢‘é…ç½®
            MILESTONES: {
                'æµè§ˆè¯é¢˜': [100, 500, 1000, 2000, 5000],
                'å·²è¯»å¸–å­': [500, 1000, 5000, 10000, 20000],
                'è·èµ': [10, 50, 100, 500, 1000],
                'é€å‡ºèµ': [50, 100, 500, 1000, 2000],
                'å›å¤': [10, 50, 100, 500, 1000]
            },
            // è¶‹åŠ¿å­—æ®µé…ç½®
            TREND_FIELDS: [
                { key: 'æµè§ˆè¯é¢˜', search: 'æµè§ˆçš„è¯é¢˜', label: 'æµè§ˆè¯é¢˜' },
                { key: 'å·²è¯»å¸–å­', search: 'å·²è¯»å¸–å­', label: 'å·²è¯»å¸–å­' },
                { key: 'ç‚¹èµ', search: 'é€å‡ºèµ', label: 'ç‚¹èµ' },
                { key: 'å›å¤', search: 'å›å¤', label: 'å›å¤' },
                { key: 'è·èµ', search: 'è·èµ', label: 'è·èµ' }
            ],
            // é˜…è¯»ç­‰çº§é¢„è®¾æ ·å¼ï¼ˆå›¾æ ‡ã€é¢œè‰²ã€èƒŒæ™¯è‰²å›ºå®šï¼ŒæŒ‰ç´¢å¼•åŒ¹é…ï¼Œå…±10çº§ï¼‰
            READING_LEVEL_PRESETS: [
                { icon: 'ğŸŒ±', color: '#94a3b8', bg: 'rgba(148,163,184,0.15)' },  // 0: ç°è‰² - åˆšèµ·æ­¥
                { icon: 'ğŸ“–', color: '#60a5fa', bg: 'rgba(96,165,250,0.15)' },  // 1: è“è‰² - çƒ­èº«ä¸­
                { icon: 'ğŸ“š', color: '#34d399', bg: 'rgba(52,211,153,0.15)' },  // 2: ç»¿è‰² - æ¸å…¥ä½³å¢ƒ
                { icon: 'ğŸ”¥', color: '#fbbf24', bg: 'rgba(251,191,36,0.15)' },  // 3: é»„è‰² - æ²‰æµ¸é˜…è¯»
                { icon: 'âš¡', color: '#f97316', bg: 'rgba(249,115,22,0.15)' },  // 4: æ©™è‰² - æ·±åº¦å­¦ä¹ 
                { icon: 'ğŸ†', color: '#a855f7', bg: 'rgba(168,85,247,0.15)' },  // 5: ç´«è‰² - LDè¾¾äºº
                { icon: 'ğŸ‘‘', color: '#ec4899', bg: 'rgba(236,72,153,0.15)' },  // 6: ç²‰è‰² - è¶…çº§æ°´æ€ª
                { icon: 'ğŸ’', color: '#06b6d4', bg: 'rgba(6,182,212,0.15)' },   // 7: é’è‰² - é’»çŸ³çº§
                { icon: 'ğŸŒŸ', color: '#eab308', bg: 'rgba(234,179,8,0.15)' },   // 8: é‡‘è‰² - ä¼ å¥‡çº§
                { icon: 'ğŸš€', color: '#ef4444', bg: 'rgba(239,68,68,0.15)' }    // 9: çº¢è‰² - ç¥è¯çº§
            ],
            // é˜…è¯»ç­‰çº§é»˜è®¤é˜ˆå€¼å’Œæ ‡ç­¾ï¼ˆä¸ PRESETS ç´¢å¼•å¯¹åº”ï¼‰
            READING_LEVELS_DEFAULT: [
                { min: 0, label: 'åˆšèµ·æ­¥' },
                { min: 30, label: 'çƒ­èº«ä¸­' },
                { min: 90, label: 'æ¸å…¥ä½³å¢ƒ' },
                { min: 180, label: 'æ²‰æµ¸é˜…è¯»' },
                { min: 300, label: 'æ·±åº¦å­¦ä¹ ' },
                { min: 450, label: 'LDè¾¾äºº' },
                { min: 600, label: 'è¶…çº§æ°´æ€ª' }
            ],
            // åŠ¨æ€é˜…è¯»ç­‰çº§é…ç½®ï¼ˆè¿è¡Œæ—¶ä»æœåŠ¡å™¨åŠ è½½ï¼‰
            READING_LEVELS: null,
            // é˜…è¯»ç­‰çº§é…ç½®åˆ·æ–°é—´éš”ï¼ˆ24å°æ—¶ï¼‰
            READING_LEVELS_REFRESH: 24 * 60 * 60 * 1000,
            // åç§°æ›¿æ¢æ˜ å°„
            NAME_MAP: new Map([
                ['å·²è¯»å¸–å­ï¼ˆæ‰€æœ‰æ—¶é—´ï¼‰', 'å·²è¯»å¸–å­'],
                ['æµè§ˆçš„è¯é¢˜ï¼ˆæ‰€æœ‰æ—¶é—´ï¼‰', 'æµè§ˆè¯é¢˜'],
                ['è·èµï¼šç‚¹èµç”¨æˆ·æ•°é‡', 'ç‚¹èµç”¨æˆ·'],
                ['è·èµï¼šå•æ—¥æœ€é«˜æ•°é‡', 'è·èµå¤©æ•°'],
                ['è¢«ç¦è¨€ï¼ˆè¿‡å» 6 ä¸ªæœˆï¼‰', 'ç¦è¨€'],
                ['è¢«å°ç¦ï¼ˆè¿‡å» 6 ä¸ªæœˆï¼‰', 'å°ç¦'],
                ['å‘å¸–æ•°é‡', 'å‘å¸–'],
                ['å›å¤æ•°é‡', 'å›å¤'],
                ['è¢«ä¸¾æŠ¥çš„å¸–å­ï¼ˆè¿‡å» 6 ä¸ªæœˆï¼‰', 'è¢«ä¸¾æŠ¥å¸–å­'],
                ['å‘èµ·ä¸¾æŠ¥çš„ç”¨æˆ·ï¼ˆè¿‡å» 6 ä¸ªæœˆï¼‰', 'å‘èµ·ä¸¾æŠ¥']
            ]),
            // å­˜å‚¨é”®
            STORAGE_KEYS: {
                position: 'position', collapsed: 'collapsed', theme: 'theme',
                trendTab: 'trend_tab', history: 'history', milestones: 'milestones',
                lastNotify: 'last_notify', lastVisit: 'last_visit', todayData: 'today_data',
                userAvatar: 'user_avatar', readingTime: 'reading_time', currentUser: 'current_user',
                lastCloudSync: 'last_cloud_sync', lastDownloadSync: 'last_download_sync',
                lastUploadHash: 'last_upload_hash', leaderboardToken: 'leaderboard_token',
                leaderboardUser: 'leaderboard_user', leaderboardJoined: 'leaderboard_joined',
                leaderboardTab: 'leaderboard_tab',
                readingLevels: 'reading_levels', readingLevelsTime: 'reading_levels_time',
                websiteUrl: 'website_url', websiteUrlDate: 'website_url_date'
            },
            // ç”¨æˆ·ç‰¹å®šçš„å­˜å‚¨é”®
            USER_KEYS: new Set(['history', 'milestones', 'lastVisit', 'todayData', 'userAvatar', 'readingTime']),
            // å‘¨å’Œæœˆåç§°
            WEEKDAYS: ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'],
            MONTHS: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
            // APIåœ°å€ï¼ˆä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼Œå¯ç”¨ Cloudflare è¾¹ç¼˜é˜²æŠ¤ï¼‰
            LEADERBOARD_API: 'https://api.ldspro.qzz.io'
        };

        // é¢„ç¼–è¯‘æ­£åˆ™
        const PATTERNS = {
            REVERSE: /è¢«ä¸¾æŠ¥|å‘èµ·ä¸¾æŠ¥|ç¦è¨€|å°ç¦/,
            USERNAME: /\/u\/([^/]+)/,
            TRUST_LEVEL: /(.*) - ä¿¡ä»»çº§åˆ« (\d+)/,
            TRUST_LEVEL_H1: /ä½ å¥½ï¼Œ.*?\(([^)]+)\)\s*(\d+)çº§ç”¨æˆ·/,  // åŒ¹é… h1 ä¸­çš„ "ä½ å¥½ï¼ŒXX (username) Xçº§ç”¨æˆ·"
            VERSION: /@version\s+([\d.]+)/,
            AVATAR_SIZE: /\/\d+\//,
            NUMBER: /(\d+)/
        };

        // ==================== è°ƒè¯•ä¸æ—¥å¿— ====================
        const Logger = {
            _enabled: false,  // ç”Ÿäº§ç¯å¢ƒé»˜è®¤å…³é—­è¯¦ç»†æ—¥å¿—
            _prefix: '[LDSP]',
            
            enable() { this._enabled = true; },
            disable() { this._enabled = false; },
            
            log(...args) {
                if (this._enabled) console.log(this._prefix, ...args);
            },
            warn(...args) {
                console.warn(this._prefix, ...args);
            },
            error(...args) {
                console.error(this._prefix, ...args);
            },
            // å¸¦æ ‡ç­¾çš„æ—¥å¿—ï¼ˆç”¨äºè¿½è¸ªç‰¹å®šæ¨¡å—ï¼‰
            tag(tag) {
                return {
                    log: (...args) => this._enabled && console.log(`${this._prefix}[${tag}]`, ...args),
                    warn: (...args) => console.warn(`${this._prefix}[${tag}]`, ...args),
                    error: (...args) => console.error(`${this._prefix}[${tag}]`, ...args)
                };
            }
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        const Utils = {
            _nameCache: new Map(),
            _htmlEntities: { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;' },

            // HTML è½¬ä¹‰ï¼ˆé˜²æ­¢ XSSï¼‰
            escapeHtml(str) {
                if (!str || typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, c => this._htmlEntities[c]);
            },

            // æ¸…ç†ç”¨æˆ·è¾“å…¥ï¼ˆç§»é™¤æ§åˆ¶å­—ç¬¦ï¼Œé™åˆ¶é•¿åº¦ï¼‰
            sanitize(str, maxLen = 100) {
                if (!str || typeof str !== 'string') return '';
                return str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '').substring(0, maxLen).trim();
            },
            
            // å®‰å…¨çš„æ•°å€¼è½¬æ¢ï¼ˆé˜²æ­¢ NaN å’Œ Infinityï¼‰
            toSafeNumber(val, defaultVal = 0) {
                const num = Number(val);
                return Number.isFinite(num) ? num : defaultVal;
            },
            
            // å®‰å…¨çš„æ•´æ•°è½¬æ¢
            toSafeInt(val, defaultVal = 0) {
                const num = parseInt(val, 10);
                return Number.isFinite(num) ? num : defaultVal;
            },
            
            // æ·±åº¦å†»ç»“å¯¹è±¡ï¼ˆé˜²æ­¢æ„å¤–ä¿®æ”¹ï¼‰
            deepFreeze(obj) {
                if (obj && typeof obj === 'object') {
                    Object.keys(obj).forEach(key => this.deepFreeze(obj[key]));
                    return Object.freeze(obj);
                }
                return obj;
            },

            // ç‰ˆæœ¬æ¯”è¾ƒ
            compareVersion(v1, v2) {
                if (!v1 || !v2) return 0;
                const [p1, p2] = [v1, v2].map(v => String(v).split('.').map(n => this.toSafeInt(n)));
                const len = Math.max(p1.length, p2.length);
                for (let i = 0; i < len; i++) {
                    const diff = (p1[i] || 0) - (p2[i] || 0);
                    if (diff !== 0) return diff > 0 ? 1 : -1;
                }
                return 0;
            },

            // ç®€åŒ–åç§°
            simplifyName(name) {
                if (this._nameCache.has(name)) return this._nameCache.get(name);
                let result = CONFIG.NAME_MAP.get(name);
                if (!result) {
                    for (const [from, to] of CONFIG.NAME_MAP) {
                        if (name.includes(from.split('ï¼ˆ')[0])) {
                            result = name.replace(from, to);
                            break;
                        }
                    }
                }
                result = result || name;
                this._nameCache.set(name, result);
                return result;
            },

            // æ ¼å¼åŒ–æ—¥æœŸ
            formatDate(ts, format = 'short') {
                const d = new Date(ts);
                const [m, day] = [d.getMonth() + 1, d.getDate()];
                if (format === 'short') return `${m}/${day}`;
                if (format === 'time') return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                return `${m}æœˆ${day}æ—¥`;
            },

            // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´ï¼ˆå°†UTCæ—¶é—´è½¬ä¸ºæœ¬åœ°æ—¶é—´å¹¶æ˜¾ç¤ºä¸ºxxå‰ï¼‰
            formatRelativeTime(utcStr) {
                if (!utcStr) return '';
                const d = new Date(utcStr); // è‡ªåŠ¨è½¬æ¢UTCåˆ°æœ¬åœ°æ—¶åŒº
                const now = new Date();
                const diff = (now - d) / 1000;
                if (diff < 60) return 'åˆšåˆš';
                if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
                if (diff < 2592000) return `${Math.floor(diff / 86400)}å¤©å‰`;
                if (diff < 31536000) return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
                return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
            },

            // æ ¼å¼åŒ–å®Œæ•´æ—¥æœŸæ—¶é—´ï¼ˆå¹´æœˆæ—¥æ—¶åˆ†ï¼‰
            formatDateTime(utcStr) {
                if (!utcStr) return '';
                const d = new Date(utcStr);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hour = String(d.getHours()).padStart(2, '0');
                const minute = String(d.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hour}:${minute}`;
            },

            // è·å–ä»Šæ—¥é”®
            getTodayKey: () => new Date().toDateString(),

            // æ ¼å¼åŒ–é˜…è¯»æ—¶é—´
            formatReadingTime(minutes) {
                if (minutes < 1) return '< 1åˆ†é’Ÿ';
                if (minutes < 60) return `${Math.round(minutes)}åˆ†é’Ÿ`;
                const h = Math.floor(minutes / 60);
                const m = Math.round(minutes % 60);
                return m > 0 ? `${h}å°æ—¶${m}åˆ†` : `${h}å°æ—¶`;
            },

            // è·å–é˜…è¯»ç­‰çº§ï¼ˆåˆå¹¶æœåŠ¡ç«¯é…ç½®å’Œé¢„è®¾æ ·å¼ï¼‰
            getReadingLevel(minutes) {
                const levels = CONFIG.READING_LEVELS || CONFIG.READING_LEVELS_DEFAULT;
                const presets = CONFIG.READING_LEVEL_PRESETS;
                
                for (let i = levels.length - 1; i >= 0; i--) {
                    if (minutes >= levels[i].min) {
                        const level = levels[i];
                        const preset = presets[i] || presets[presets.length - 1];
                        // åˆå¹¶ï¼šä½¿ç”¨æœåŠ¡ç«¯çš„ min/labelï¼Œé¢„è®¾çš„ icon/color/bg
                        return {
                            min: level.min,
                            label: level.label,
                            icon: preset.icon,
                            color: preset.color,
                            bg: preset.bg
                        };
                    }
                }
                const first = levels[0];
                const preset = presets[0];
                return {
                    min: first.min,
                    label: first.label,
                    icon: preset.icon,
                    color: preset.color,
                    bg: preset.bg
                };
            },

            // è·å–çƒ­åŠ›å›¾ç­‰çº§
            getHeatmapLevel(minutes) {
                if (minutes < 1) return 0;
                if (minutes < 60) return 1;
                if (minutes < 180) return 2;
                if (minutes < 300) return 3;
                return 4;
            },

            // é‡æ’éœ€æ±‚é¡¹ï¼ˆå°†ä¸¾æŠ¥ç›¸å…³é¡¹ç§»åˆ°ç¦è¨€å‰ï¼‰
            reorderRequirements(reqs) {
                const reports = [], others = [];
                reqs.forEach(r => {
                    (r.name.includes('è¢«ä¸¾æŠ¥') || r.name.includes('å‘èµ·ä¸¾æŠ¥') ? reports : others).push(r);
                });
                const banIdx = others.findIndex(r => r.name.includes('ç¦è¨€'));
                if (banIdx >= 0) others.splice(banIdx, 0, ...reports);
                else others.push(...reports);
                return others;
            },

            // é˜²æŠ–ï¼ˆå¸¦å–æ¶ˆåŠŸèƒ½ï¼‰
            debounce(fn, wait) {
                let timer = null;
                const debounced = function(...args) {
                    if (timer !== null) clearTimeout(timer);
                    timer = setTimeout(() => {
                        timer = null;
                        fn.apply(this, args);
                    }, wait);
                };
                debounced.cancel = () => {
                    if (timer !== null) {
                        clearTimeout(timer);
                        timer = null;
                    }
                };
                return debounced;
            },

            // èŠ‚æµï¼ˆä¿è¯é¦–æ¬¡ç«‹å³æ‰§è¡Œï¼Œåç»­æŒ‰é—´éš”æ‰§è¡Œï¼‰
            throttle(fn, limit) {
                let lastTime = 0;
                return function(...args) {
                    const now = Date.now();
                    if (now - lastTime >= limit) {
                        lastTime = now;
                        fn.apply(this, args);
                    }
                };
            },

            // å®‰å…¨æ‰§è¡Œï¼ˆæ•è·å¼‚å¸¸ï¼‰
            safeCall(fn, fallback = null) {
                try {
                    return fn();
                } catch (e) {
                    return fallback;
                }
            },
            
            // å®‰å…¨çš„å¼‚æ­¥æ‰§è¡Œï¼ˆæ•è· Promise å¼‚å¸¸ï¼‰
            async safeAsync(fn, fallback = null) {
                try {
                    return await fn();
                } catch (e) {
                    Logger.warn('Async operation failed:', e.message);
                    return fallback;
                }
            },
            
            // ç”Ÿæˆå”¯ä¸€ ID
            uid() {
                return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
            },
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ URL
            isValidUrl(str) {
                if (!str || typeof str !== 'string') return false;
                try {
                    const url = new URL(str);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch {
                    return false;
                }
            },
            
            // å®‰å…¨è·å–åµŒå¥—å¯¹è±¡å±æ€§
            get(obj, path, defaultVal = undefined) {
                if (!obj || typeof path !== 'string') return defaultVal;
                const keys = path.split('.');
                let result = obj;
                for (const key of keys) {
                    if (result == null || typeof result !== 'object') return defaultVal;
                    result = result[key];
                }
                return result !== undefined ? result : defaultVal;
            },
            
            // å…‹éš†å¯¹è±¡ï¼ˆæµ…æ‹·è´ï¼Œç”¨äºé…ç½®ç­‰ï¼‰
            clone(obj) {
                if (!obj || typeof obj !== 'object') return obj;
                return Array.isArray(obj) ? [...obj] : { ...obj };
            }
        };

        // ==================== å±å¹•å·¥å…· ====================
        const Screen = {
            _cache: null,
            _cacheTime: 0,

            // åŠ¨æ€è®¡ç®—é¢æ¿é…ç½® - åŸºäºè§†å£å°ºå¯¸çš„ç›¸å¯¹è®¡ç®—
            // ç¡®ä¿é¢æ¿å§‹ç»ˆåœ¨çª—å£å†…æ˜¾ç¤ºï¼Œé’ˆå¯¹ç§»åŠ¨è®¾å¤‡ä¼˜åŒ–
            getConfig() {
                const { innerWidth: vw, innerHeight: vh } = window;
                const isMobile = vw < 500 || vh < 700;
                const isVerySmall = vw < 360 || vh < 500;
                
                // é¢æ¿å®½åº¦ï¼šç§»åŠ¨è®¾å¤‡ä½¿ç”¨æ›´å°çš„åŸºç¡€å®½åº¦
                // æ¡Œé¢: è§†å£å®½åº¦çš„18%ï¼Œé™åˆ¶åœ¨260-360px
                // ç§»åŠ¨: è§†å£å®½åº¦çš„65%ï¼Œé™åˆ¶åœ¨220-280px
                let width;
                if (isVerySmall) {
                    width = Math.max(200, Math.min(240, Math.round(vw * 0.7)));
                } else if (isMobile) {
                    width = Math.max(220, Math.min(280, Math.round(vw * 0.65)));
                } else {
                    width = Math.max(260, Math.min(360, Math.round(vw * 0.18)));
                }
                
                // é¢æ¿æœ€å¤§é«˜åº¦ï¼šè§†å£é«˜åº¦å‡å»è¾¹è·
                // ç§»åŠ¨è®¾å¤‡é¢„ç•™æ›´å°çš„è¾¹è·ä»¥è·å¾—æ›´å¤šæ˜¾ç¤ºç©ºé—´
                const topMargin = isMobile 
                    ? Math.max(15, Math.round(vh * 0.03))
                    : Math.max(30, Math.round(vh * 0.06));
                const bottomMargin = isMobile ? 10 : 20;
                const maxHeight = vh - topMargin - bottomMargin;
                
                // å­—ä½“å¤§å°ï¼šç§»åŠ¨è®¾å¤‡ä½¿ç”¨è¾ƒå°å­—å·
                // æ¡Œé¢: 10-13pxï¼Œç§»åŠ¨: 9-11px
                const fontSize = isMobile
                    ? Math.max(9, Math.min(11, Math.round(vh / 70)))
                    : Math.max(10, Math.min(13, Math.round(vh / 70)));
                
                // å†…è¾¹è·ï¼šæ ¹æ®å®½åº¦ç¼©æ”¾
                // æ¡Œé¢: 10-14pxï¼Œç§»åŠ¨: 6-10px
                const padding = isMobile
                    ? Math.max(6, Math.min(10, Math.round(width / 28)))
                    : Math.max(10, Math.min(14, Math.round(width / 24)));
                
                // å¤´åƒå¤§å°ï¼šç§»åŠ¨è®¾å¤‡ä½¿ç”¨è¾ƒå°å¤´åƒ
                // æ¡Œé¢: 40-52pxï¼Œç§»åŠ¨: 32-42px
                const avatarSize = isMobile
                    ? Math.max(32, Math.min(42, Math.round(width / 7)))
                    : Math.max(40, Math.min(52, Math.round(width / 6.5)));
                
                // ç¯å½¢å›¾å¤§å°ï¼šæ ¹æ®é«˜åº¦ç¼©æ”¾
                // æ¡Œé¢: 65-85pxï¼Œç§»åŠ¨: 50-65px
                const ringSize = isMobile
                    ? Math.max(50, Math.min(65, Math.round(vh / 12)))
                    : Math.max(65, Math.min(85, Math.round(vh / 11)));
                
                return {
                    width,
                    maxHeight,
                    fontSize,
                    padding,
                    avatarSize,
                    ringSize,
                    top: topMargin,
                    vw,
                    vh,
                    isMobile,
                    isVerySmall
                };
            }
        };

        // ==================== LRU ç¼“å­˜ ====================
        class LRUCache {
            constructor(maxSize = CONFIG.CACHE.LRU_SIZE) {
                this.maxSize = maxSize;
                this.cache = new Map();
            }

            get(key) {
                if (!this.cache.has(key)) return undefined;
                const value = this.cache.get(key);
                this.cache.delete(key);
                this.cache.set(key, value);
                return value;
            }

            set(key, value) {
                this.cache.has(key) && this.cache.delete(key);
                if (this.cache.size >= this.maxSize) {
                    this.cache.delete(this.cache.keys().next().value);
                }
                this.cache.set(key, value);
            }

            has(key) { return this.cache.has(key); }
            clear() { this.cache.clear(); }
        }

        // ==================== å­˜å‚¨ç®¡ç†å™¨ ====================
        class Storage {
            constructor() {
                this._pending = new Map();
                this._timer = null;
                this._user = null;
                this._keyCache = new Map();
                this._valueCache = new Map();
                this._valueCacheTime = new Map();
            }

            // è·å–å½“å‰ç”¨æˆ·
            getUser() {
                if (this._user) return this._user;
                const link = document.querySelector('.current-user a[href^="/u/"]');
                if (link) {
                    const match = link.getAttribute('href').match(PATTERNS.USERNAME);
                    if (match) {
                        this._user = match[1];
                        GM_setValue(this._globalKey('currentUser'), this._user);
                        return this._user;
                    }
                }
                return this._user = GM_getValue(this._globalKey('currentUser'), null);
            }

            setUser(username) {
                if (this._user !== username) {
                    this._user = username;
                    this._keyCache.clear();  // ç”¨æˆ·å˜åŒ–æ—¶æ¸…é™¤ key ç¼“å­˜
                    GM_setValue(this._globalKey('currentUser'), username);
                }
            }

            // ç”Ÿæˆå…¨å±€é”®
            _globalKey(key) {
                return `ldsp_${CURRENT_SITE.prefix}_${CONFIG.STORAGE_KEYS[key] || key}`;
            }

            // ç”Ÿæˆç”¨æˆ·é”®
            _userKey(key) {
                const cacheKey = `${key}_${this._user || ''}`;
                if (this._keyCache.has(cacheKey)) return this._keyCache.get(cacheKey);
                
                const base = CONFIG.STORAGE_KEYS[key] || key;
                const user = this.getUser();
                const result = user && CONFIG.USER_KEYS.has(key) 
                    ? `ldsp_${CURRENT_SITE.prefix}_${base}_${user}`
                    : `ldsp_${CURRENT_SITE.prefix}_${base}`;
                
                this._keyCache.set(cacheKey, result);
                return result;
            }

            // è·å–ç”¨æˆ·æ•°æ®
            get(key, defaultValue = null) {
                const storageKey = this._userKey(key);
                const now = Date.now();
                
                if (this._valueCache.has(storageKey)) {
                    const cacheTime = this._valueCacheTime.get(storageKey);
                    if ((now - cacheTime) < CONFIG.CACHE.VALUE_TTL) {
                        return this._valueCache.get(storageKey);
                    }
                }
                
                const value = GM_getValue(storageKey, defaultValue);
                this._valueCache.set(storageKey, value);
                this._valueCacheTime.set(storageKey, now);
                return value;
            }

            // è®¾ç½®ç”¨æˆ·æ•°æ®ï¼ˆå¸¦é˜²æŠ–ï¼‰
            set(key, value) {
                const storageKey = this._userKey(key);
                this._valueCache.set(storageKey, value);
                this._valueCacheTime.set(storageKey, Date.now());
                this._pending.set(storageKey, value);
                this._scheduleWrite();
            }

            // ç«‹å³è®¾ç½®ç”¨æˆ·æ•°æ®
            setNow(key, value) {
                const storageKey = this._userKey(key);
                this._valueCache.set(storageKey, value);
                this._valueCacheTime.set(storageKey, Date.now());
                GM_setValue(storageKey, value);
            }

            // è·å–å…¨å±€æ•°æ®
            getGlobal(key, defaultValue = null) {
                return GM_getValue(this._globalKey(key), defaultValue);
            }

            // è®¾ç½®å…¨å±€æ•°æ®ï¼ˆå¸¦é˜²æŠ–ï¼‰
            setGlobal(key, value) {
                this._pending.set(this._globalKey(key), value);
                this._scheduleWrite();
            }

            // ç«‹å³è®¾ç½®å…¨å±€æ•°æ®
            setGlobalNow(key, value) {
                GM_setValue(this._globalKey(key), value);
            }

            // è°ƒåº¦å†™å…¥
            _scheduleWrite() {
                if (this._timer) return;
                this._timer = setTimeout(() => {
                    this.flush();
                    this._timer = null;
                }, CONFIG.INTERVALS.STORAGE_DEBOUNCE);
            }

            // åˆ·æ–°æ‰€æœ‰å¾…å†™å…¥æ•°æ®
            flush() {
                this._pending.forEach((value, key) => {
                    try { GM_setValue(key, value); } catch (e) { console.error('[Storage]', key, e); }
                });
                this._pending.clear();
            }

            // æ¸…é™¤ç¼“å­˜
            invalidateCache(key) {
                if (key) {
                    const storageKey = this._userKey(key);
                    this._valueCache.delete(storageKey);
                    this._valueCacheTime.delete(storageKey);
                } else {
                    this._valueCache.clear();
                    this._valueCacheTime.clear();
                }
            }

            // è¿ç§»æ—§æ•°æ®
            migrate(username) {
                const flag = `ldsp_migrated_v3_${username}`;
                if (GM_getValue(flag, false)) return;

                CONFIG.USER_KEYS.forEach(key => {
                    const oldKey = CONFIG.STORAGE_KEYS[key];
                    const newKey = `ldsp_${CURRENT_SITE.prefix}_${oldKey}_${username}`;
                    const oldData = GM_getValue(oldKey, null);
                    if (oldData !== null && GM_getValue(newKey, null) === null) {
                        GM_setValue(newKey, oldData);
                    }
                });

                this._migrateReadingTime(username);
                GM_setValue(flag, true);
            }

            // è¿ç§»é˜…è¯»æ—¶é—´æ•°æ®
            _migrateReadingTime(username) {
                const key = `ldsp_${CURRENT_SITE.prefix}_reading_time_${username}`;
                const data = GM_getValue(key, null);
                if (!data || typeof data !== 'object') return;

                if (data.date && data.minutes !== undefined && !data.dailyData) {
                    GM_setValue(key, {
                        version: 3,
                        dailyData: { [data.date]: { totalMinutes: data.minutes || 0, lastActive: data.lastActive || Date.now(), sessions: [] } },
                        monthlyCache: {},
                        yearlyCache: {}
                    });
                } else if (data.version === 2) {
                    data.version = 3;
                    data.monthlyCache = data.monthlyCache || {};
                    data.yearlyCache = data.yearlyCache || {};
                    if (data.dailyData) {
                        Object.entries(data.dailyData).forEach(([dateKey, dayData]) => {
                            try {
                                const d = new Date(dateKey);
                                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                                const yearKey = `${d.getFullYear()}`;
                                const minutes = dayData.totalMinutes || 0;
                                data.monthlyCache[monthKey] = (data.monthlyCache[monthKey] || 0) + minutes;
                                data.yearlyCache[yearKey] = (data.yearlyCache[yearKey] || 0) + minutes;
                            } catch (e) {}
                        });
                    }
                    GM_setValue(key, data);
                }
            }
        }

        // ==================== è‡ªå®šä¹‰é”™è¯¯ç±»å‹ ====================
        class NetworkError extends Error {
            constructor(message, code = 'NETWORK_ERROR', status = 0) {
                super(message);
                this.name = 'NetworkError';
                this.code = code;
                this.status = status;
            }
            
            get isTimeout() { return this.code === 'TIMEOUT'; }
            get isAuth() { return this.code === 'UNAUTHORIZED' || this.status === 401; }
            get isNotFound() { return this.status === 404; }
            get isServerError() { return this.status >= 500; }
        }
        
        // ==================== é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–å·¥å…· ====================
        // v3.5.2.9: ç»Ÿä¸€çš„ç”¨æˆ·å‹å¥½é”™è¯¯æ¶ˆæ¯
        const ErrorFormatter = {
            // é”™è¯¯ç åˆ°å‹å¥½æ¶ˆæ¯çš„æ˜ å°„
            _codeMap: {
                'NETWORK_ERROR': 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ',
                'TIMEOUT': 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',
                'IP_BANNED': 'IP å·²è¢«å°ç¦ï¼Œè¯·æ›´æ¢ç½‘ç»œèŠ‚ç‚¹',
                'IP_PERMANENTLY_BANNED': 'IP å·²è¢«æ°¸ä¹…å°ç¦ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
                'RATE_LIMITED': 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•',
                'NOT_LOGGED_IN': 'è¯·å…ˆç™»å½•',
                'AUTH_EXPIRED': 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
                'INVALID_TOKEN': 'ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•',
                'TOKEN_EXPIRED': 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
                'NOT_JOINED': 'è¯·å…ˆåŠ å…¥æ’è¡Œæ¦œ',
                'UNAUTHORIZED': 'æ²¡æœ‰è®¿é—®æƒé™',
                'NOT_FOUND': 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨',
                'SERVER_ERROR': 'æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•',
                'VALIDATION_FAILED': 'æ•°æ®éªŒè¯å¤±è´¥',
                'SYNC_FAILED': 'åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
            },
            
            // å°†é”™è¯¯å¯¹è±¡è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯
            format(error) {
                if (!error) return 'æœªçŸ¥é”™è¯¯';
                
                // å­—ç¬¦ä¸²ç›´æ¥è¿”å›
                if (typeof error === 'string') return this._simplify(error);
                
                // æå–é”™è¯¯ä¿¡æ¯
                const msg = error.message || '';
                const code = error.code || '';
                const status = error.status || 0;
                
                // 1. ä¼˜å…ˆåŒ¹é…é”™è¯¯ç 
                if (code && this._codeMap[code]) {
                    return this._codeMap[code];
                }
                
                // 2. æ£€æŸ¥æ¶ˆæ¯ä¸­çš„å…³é”®è¯
                const lowerMsg = msg.toLowerCase();
                
                // ç½‘ç»œç›¸å…³
                if (lowerMsg.includes('network') || lowerMsg.includes('ç½‘ç»œ')) {
                    return 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                }
                if (lowerMsg.includes('timeout') || lowerMsg.includes('è¶…æ—¶')) {
                    return 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                // è®¤è¯ç›¸å…³
                if (lowerMsg.includes('ç™»å½•') || lowerMsg.includes('login') || 
                    lowerMsg.includes('token') || lowerMsg.includes('auth')) {
                    if (lowerMsg.includes('è¿‡æœŸ') || lowerMsg.includes('expire') || lowerMsg.includes('å¤±æ•ˆ')) {
                        return 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
                    }
                    return 'è¯·å…ˆç™»å½•';
                }
                
                // IP å°ç¦
                if (lowerMsg.includes('ip') && (lowerMsg.includes('ban') || lowerMsg.includes('å°ç¦') || lowerMsg.includes('block'))) {
                    return 'IP å·²è¢«å°ç¦ï¼Œè¯·æ›´æ¢ç½‘ç»œèŠ‚ç‚¹';
                }
                
                // é¢‘ç‡é™åˆ¶
                if (lowerMsg.includes('é¢‘ç¹') || lowerMsg.includes('rate') || lowerMsg.includes('429')) {
                    // å°è¯•æå–ç­‰å¾…æ—¶é—´
                    const waitMatch = msg.match(/(\d+)\s*(ç§’|åˆ†é’Ÿ|second|minute)/i);
                    if (waitMatch) {
                        return `è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… ${waitMatch[1]} ${waitMatch[2]}åé‡è¯•`;
                    }
                    return 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                // æœåŠ¡å™¨é”™è¯¯
                if (status >= 500 || lowerMsg.includes('server') || lowerMsg.includes('æœåŠ¡å™¨')) {
                    return 'æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                // 3. ç®€åŒ–å¹¶è¿”å›åŸå§‹æ¶ˆæ¯
                return this._simplify(msg) || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            },
            
            // ç®€åŒ–é”™è¯¯æ¶ˆæ¯ï¼ˆç§»é™¤æŠ€æœ¯ç»†èŠ‚ï¼‰
            _simplify(msg) {
                if (!msg) return '';
                
                // ç§»é™¤ HTTP çŠ¶æ€ç ç»†èŠ‚
                msg = msg.replace(/\s*\(HTTP \d+\)|\s*HTTP \d+:?/gi, '');
                // ç§»é™¤é”™è¯¯ç å‰ç¼€
                msg = msg.replace(/^[A-Z_]+:\s*/i, '');
                // ç§»é™¤ "Error:" å‰ç¼€
                msg = msg.replace(/^Error:\s*/i, '');
                // é™åˆ¶é•¿åº¦
                if (msg.length > 50) msg = msg.substring(0, 47) + '...';
                
                return msg.trim();
            },
            
            // è·å–å¸¦å›¾æ ‡çš„é”™è¯¯æ¶ˆæ¯
            withIcon(error) {
                const msg = this.format(error);
                // æ ¹æ®é”™è¯¯ç±»å‹é€‰æ‹©å›¾æ ‡
                if (msg.includes('ç½‘ç»œ') || msg.includes('è¿æ¥')) return `ğŸ“¡ ${msg}`;
                if (msg.includes('ç™»å½•') || msg.includes('æƒé™')) return `ğŸ” ${msg}`;
                if (msg.includes('å°ç¦')) return `ğŸš« ${msg}`;
                if (msg.includes('é¢‘ç¹') || msg.includes('ç­‰å¾…')) return `â³ ${msg}`;
                if (msg.includes('æœåŠ¡å™¨')) return `ğŸ”§ ${msg}`;
                if (msg.includes('è¶…æ—¶')) return `â±ï¸ ${msg}`;
                return `âŒ ${msg}`;
            }
        };

        // ==================== ç½‘ç»œç®¡ç†å™¨ ====================
        class Network {
            // å…¬å…±æ¥å£429é™æµå†·å´æ—¶é—´ï¼ˆ2åˆ†é’Ÿï¼‰
            static RATE_LIMIT_COOLDOWN = 2 * 60 * 1000;
            // 429é™æµè®°å½•ï¼ˆè®°å½•ä¸Šæ¬¡æ”¶åˆ°429çš„æ—¶é—´æˆ³ï¼‰
            static _rateLimitedAt = 0;
            // v3.5.2.9: å…¨å±€è¯·æ±‚é˜Ÿåˆ— - é˜²æ­¢å¹¶å‘è¯·æ±‚å¯¼è‡´429
            static _requestQueue = [];
            static _isProcessingQueue = false;
            static _lastRequestTime = 0;
            static MIN_REQUEST_INTERVAL = 300; // æœ€å°è¯·æ±‚é—´éš” 300ms
            
            constructor() {
                this._pending = new Map();
                this._apiCache = new Map();
                this._apiCacheTime = new Map();
            }
            
            // v3.5.2.9: å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œç¡®ä¿è¯·æ±‚é—´éš”
            static async queueRequest(requestFn) {
                return new Promise((resolve, reject) => {
                    Network._requestQueue.push({ requestFn, resolve, reject });
                    Network._processQueue();
                });
            }
            
            // v3.5.2.9: å¤„ç†è¯·æ±‚é˜Ÿåˆ—
            static async _processQueue() {
                if (Network._isProcessingQueue || Network._requestQueue.length === 0) return;
                Network._isProcessingQueue = true;
                
                while (Network._requestQueue.length > 0) {
                    const { requestFn, resolve, reject } = Network._requestQueue.shift();
                    
                    // ç¡®ä¿è¯·æ±‚é—´éš”
                    const now = Date.now();
                    const elapsed = now - Network._lastRequestTime;
                    if (elapsed < Network.MIN_REQUEST_INTERVAL) {
                        await new Promise(r => setTimeout(r, Network.MIN_REQUEST_INTERVAL - elapsed));
                    }
                    
                    Network._lastRequestTime = Date.now();
                    
                    try {
                        const result = await requestFn();
                        resolve(result);
                    } catch (e) {
                        reject(e);
                    }
                }
                
                Network._isProcessingQueue = false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å¤„äº429é™æµå†·å´æœŸ
            static isRateLimited() {
                if (!Network._rateLimitedAt) return false;
                const elapsed = Date.now() - Network._rateLimitedAt;
                if (elapsed >= Network.RATE_LIMIT_COOLDOWN) {
                    Network._rateLimitedAt = 0; // å†·å´æœŸç»“æŸï¼Œæ¸…é™¤è®°å½•
                    return false;
                }
                return true;
            }
            
            // è·å–å‰©ä½™å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
            static getRateLimitRemaining() {
                if (!Network._rateLimitedAt) return 0;
                const remaining = Network.RATE_LIMIT_COOLDOWN - (Date.now() - Network._rateLimitedAt);
                return remaining > 0 ? Math.ceil(remaining / 1000) : 0;
            }
            
            // è®°å½•æ”¶åˆ°429å“åº”
            static recordRateLimit() {
                Network._rateLimitedAt = Date.now();
                Logger.warn('API rate limited, cooling down for 2 minutes');
            }
            
            // åˆ›å»ºç»Ÿä¸€çš„é”™è¯¯å¯¹è±¡
            static createError(message, code = 'UNKNOWN', status = 0) {
                return new NetworkError(message, code, status);
            }

            // é™æ€æ–¹æ³•ï¼šåŠ è½½é˜…è¯»ç­‰çº§é…ç½®ï¼ˆä»æœåŠ¡ç«¯è·å–ï¼Œæœ¬åœ°ç¼“å­˜24å°æ—¶ï¼‰
            static async loadReadingLevels() {
                const storageKey = `ldsp_reading_levels`;
                const timeKey = `ldsp_reading_levels_time`;
                
                try {
                    // æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶åˆ·æ–°ä¸€æ¬¡ï¼‰
                    const cachedTime = GM_getValue(timeKey, 0);
                    const now = Date.now();
                    
                    if (cachedTime && (now - cachedTime) < CONFIG.READING_LEVELS_REFRESH) {
                        // ç¼“å­˜æœªè¿‡æœŸï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
                        const cached = GM_getValue(storageKey, null);
                        if (cached && Array.isArray(cached) && cached.length > 0) {
                            CONFIG.READING_LEVELS = cached;
                            return;
                        }
                    }
                    
                    // éœ€è¦ä»æœåŠ¡ç«¯è·å–
                    const response = await new Promise((resolve, reject) => {
                        GM_xmlhttpRequest({
                            method: 'GET',
                            url: `${CONFIG.LEADERBOARD_API}/api/config/reading-levels`,
                            headers: { 'Content-Type': 'application/json' },
                            timeout: 10000,
                            onload: res => {
                                if (res.status >= 200 && res.status < 300) {
                                    try {
                                        resolve(JSON.parse(res.responseText));
                                    } catch (e) {
                                        reject(new Error('Parse error'));
                                    }
                                } else {
                                    reject(new Error(`HTTP ${res.status}`));
                                }
                            },
                            onerror: () => reject(new Error('Network error')),
                            ontimeout: () => reject(new Error('Timeout'))
                        });
                    });
                    
                    if (response.success && response.data?.levels && Array.isArray(response.data.levels)) {
                        const levels = response.data.levels;
                        CONFIG.READING_LEVELS = levels;
                        GM_setValue(storageKey, levels);
                        GM_setValue(timeKey, now);
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (e) {
                    // å°è¯•ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆå³ä½¿è¿‡æœŸä¹Ÿæ¯”æ²¡æœ‰å¥½ï¼‰
                    const cached = GM_getValue(storageKey, null);
                    if (cached && Array.isArray(cached) && cached.length > 0) {
                        CONFIG.READING_LEVELS = cached;
                    } else {
                        // ä½¿ç”¨é»˜è®¤é…ç½®
                        CONFIG.READING_LEVELS = CONFIG.READING_LEVELS_DEFAULT;
                    }
                }
            }

            async fetch(url, options = {}) {
                const key = this._buildPendingKey(url, options);
                if (this._pending.has(key)) return this._pending.get(key);
                
                const promise = this._fetchWithRetry(url, options);
                this._pending.set(key, promise);
                
                try {
                    return await promise;
                } finally {
                    this._pending.delete(key);
                }
            }

            _buildPendingKey(url, options = {}) {
                const method = (options.method || 'GET').toUpperCase();
                // å½’ä¸€åŒ– headersï¼Œé¿å…å¯¹è±¡å¼•ç”¨å¯¼è‡´çš„é‡å¤å‘½ä¸­
                let headersSig = '';
                const headers = options.headers;
                if (headers) {
                    const normalized = {};
                    if (headers instanceof Headers) {
                        headers.forEach((v, k) => { normalized[k] = v; });
                    } else if (typeof headers === 'object') {
                        Object.entries(headers).forEach(([k, v]) => { normalized[k] = v; });
                    }
                    headersSig = JSON.stringify(Object.keys(normalized).sort().reduce((acc, k) => { acc[k] = normalized[k]; return acc; }, {}));
                }
                let bodySig = '';
                const body = options.body;
                if (body) {
                    if (typeof body === 'string') bodySig = body.slice(0, 128);
                    else if (typeof body === 'object') { try { bodySig = JSON.stringify(body).slice(0, 128); } catch {} }
                }
                return `${method}:${url}#${headersSig}:${bodySig}`;
            }

            // æ¸…é™¤ API ç¼“å­˜
            clearApiCache(endpoint) {
                if (endpoint) {
                    this._apiCache.delete(endpoint);
                    this._apiCacheTime.delete(endpoint);
                } else {
                    this._apiCache.clear();
                    this._apiCacheTime.clear();
                }
            }

            async _fetchWithRetry(url, options = {}) {
                const { maxRetries = CONFIG.NETWORK.RETRY_COUNT, timeout = CONFIG.NETWORK.TIMEOUT, headers = {}, method = 'GET', body = undefined } = options;
                const finalHeaders = this._buildHeaders(url, { 'Accept': 'application/json, text/html, */*', ...headers });
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        return await this._doFetch(url, { timeout, headers: finalHeaders, method, body });
                    } catch (e) {
                        if (i === maxRetries - 1) throw e;
                        await new Promise(r => setTimeout(r, CONFIG.NETWORK.RETRY_DELAY * Math.pow(2, i)));
                    }
                }
            }

            async _doFetch(url, { timeout, headers = {}, method = 'GET', body = undefined }) {
                // æ£€æµ‹æ˜¯å¦ä¸ºåŒæºè¯·æ±‚
                const isSameOrigin = this._isSameOrigin(url);
                
                // åŒæºè¯·æ±‚ä¼˜å…ˆä½¿ç”¨åŸç”Ÿ fetchï¼ˆå¯ä»¥æ­£ç¡®æºå¸¦ cookieï¼‰
                // v3.5.4.9: ä¿®å¤0/1çº§ç”¨æˆ·è·å–å‡çº§è¦æ±‚æ•°æ®æ—¶éœ€è¦æºå¸¦cookieçš„é—®é¢˜
                if (isSameOrigin) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);
                        const resp = await fetch(url, { 
                            credentials: 'include',
                            method,
                            body,
                            headers,
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        return await resp.text();
                    } catch (e) {
                        if (e.name === 'AbortError') throw new Error('Timeout');
                        // åŸç”Ÿ fetch å¤±è´¥ï¼Œfallback åˆ° GMï¼ˆå¯èƒ½æ˜¯æ‰©å±•ç¯å¢ƒé—®é¢˜ï¼‰
                    }
                }
                
                // æ£€æµ‹ GM_xmlhttpRequest æ˜¯å¦å¯ç”¨
                const hasGM = typeof GM_xmlhttpRequest === 'function';
                
                // GM_xmlhttpRequestï¼ˆå¯ç»•è¿‡è·¨åŸŸï¼Œå¹¶æºå¸¦ cookieï¼‰
                if (hasGM) {
                    const result = await new Promise((resolve, reject) => {
                        let settled = false;
                        const timeoutId = setTimeout(() => {
                            if (!settled) {
                                settled = true;
                                reject(new Error('Timeout'));
                            }
                        }, timeout);
                        
                        try {
                            GM_xmlhttpRequest({
                                method,
                                url,
                                timeout,
                                // v3.5.4.9: æ·»åŠ  withCredentials æºå¸¦ cookie
                                withCredentials: true,
                                headers,
                                data: body && typeof body === 'object' && !(body instanceof FormData) ? JSON.stringify(body) : body,
                                onload: res => {
                                    if (settled) return;
                                    settled = true;
                                    clearTimeout(timeoutId);
                                    if (res.status >= 200 && res.status < 300) {
                                        resolve(res.responseText);
                                    } else {
                                        reject(new Error(`HTTP ${res.status}`));
                                    }
                                },
                                onerror: () => {
                                    if (settled) return;
                                    settled = true;
                                    clearTimeout(timeoutId);
                                    reject(new Error('Network error'));
                                },
                                ontimeout: () => {
                                    if (settled) return;
                                    settled = true;
                                    clearTimeout(timeoutId);
                                    reject(new Error('GM Timeout'));
                                }
                            });
                        } catch (gmCallError) {
                            if (settled) return;
                            settled = true;
                            clearTimeout(timeoutId);
                            reject(gmCallError);
                        }
                    });
                    return result;
                }
                
                // æ²¡æœ‰ GM ä¸”éåŒæºè¯·æ±‚ï¼Œå°è¯•åŸç”Ÿ fetchï¼ˆå¯èƒ½ä¼šå¤±è´¥ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                const resp = await fetch(url, { 
                    credentials: 'include',
                    method,
                    body,
                    headers,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                return await resp.text();
            }

            _buildHeaders(url, headers = {}) {
                const merged = { ...headers };
                if (!merged['Accept'] && !merged['accept']) merged['Accept'] = 'application/json, text/html, */*';
                return buildAuthHeaders(url, merged);
            }

            // API è¯·æ±‚ï¼ˆå¸¦è®¤è¯å’Œç¼“å­˜ï¼‰
            async api(endpoint, options = {}) {
                const method = options.method || 'GET';
                const cacheTtl = options.cacheTtl || 0;
                
                // æ£€æŸ¥æ˜¯å¦å¤„äº429é™æµå†·å´æœŸï¼ˆå…¬å…±æ¥å£ä¿æŠ¤ï¼‰
                if (Network.isRateLimited()) {
                    const remaining = Network.getRateLimitRemaining();
                    throw new Error(`è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… ${remaining} ç§’åé‡è¯•`);
                }
                
                // GET è¯·æ±‚æ”¯æŒç¼“å­˜
                if (method === 'GET' && cacheTtl > 0) {
                    const now = Date.now();
                    const cacheKey = `${endpoint}_${options.token || ''}`;
                    if (this._apiCache.has(cacheKey)) {
                        const cacheTime = this._apiCacheTime.get(cacheKey);
                        if (now - cacheTime < cacheTtl) {
                            return this._apiCache.get(cacheKey);
                        }
                    }
                }

                // v3.5.2.9: ä½¿ç”¨å…¨å±€è¯·æ±‚é˜Ÿåˆ—ï¼Œé˜²æ­¢å¹¶å‘è¯·æ±‚å¯¼è‡´429
                return Network.queueRequest(() => this._doApiRequest(endpoint, options, method, cacheTtl));
            }
            
            // v3.5.2.9: å®é™…æ‰§è¡Œ API è¯·æ±‚
            _doApiRequest(endpoint, options, method, cacheTtl) {
                return new Promise((resolve, reject) => {
                    // ç¡®ä¿ body æ˜¯å­—ç¬¦ä¸²
                    let bodyData = options.body;
                    if (bodyData && typeof bodyData === 'object') {
                        bodyData = JSON.stringify(bodyData);
                    }
                    
                    GM_xmlhttpRequest({
                        method,
                        url: `${CONFIG.LEADERBOARD_API}${endpoint}`,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Client-Version': GM_info.script.version || 'unknown',
                            ...(options.token ? { 'Authorization': `Bearer ${options.token}` } : {})
                        },
                        data: bodyData || undefined,
                        timeout: CONFIG.NETWORK.TIMEOUT,
                        onload: res => {
                            try {
                                const data = JSON.parse(res.responseText);
                                if (res.status >= 200 && res.status < 300) {
                                    // ç¼“å­˜æˆåŠŸå“åº”
                                    if (method === 'GET' && cacheTtl > 0) {
                                        const cacheKey = `${endpoint}_${options.token || ''}`;
                                        this._apiCache.set(cacheKey, data);
                                        this._apiCacheTime.set(cacheKey, Date.now());
                                    }
                                    resolve(data);
                                } else {
                                    // æ£€æµ‹ç‰¹æ®Šé”™è¯¯ç å¹¶æä¾›å‹å¥½æç¤º
                                    const errorCode = data.error?.code || '';
                                    
                                    // 429 é™é€Ÿï¼šè®°å½•å¹¶è§¦å‘å†·å´
                                    if (res.status === 429) {
                                        Network.recordRateLimit();
                                        const retryAfter = data.error?.retryAfter || 120;
                                        reject(new Error(`è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… ${retryAfter} ç§’åé‡è¯•`));
                                        return;
                                    }
                                    
                                    // IP è¢«å°ç¦ï¼šæä¾›å‹å¥½æç¤º
                                    if (errorCode === 'IP_BANNED' || errorCode === 'IP_PERMANENTLY_BANNED') {
                                        const isPermanent = errorCode === 'IP_PERMANENTLY_BANNED';
                                        const banMsg = isPermanent 
                                            ? 'IP å·²è¢«æ°¸ä¹…å°ç¦ï¼Œè¯·æ›´æ¢ç½‘ç»œèŠ‚ç‚¹æˆ–è”ç³»ç®¡ç†å‘˜'
                                            : `IP å·²è¢«ä¸´æ—¶å°ç¦ï¼Œè¯·ç¨åé‡è¯•æˆ–æ›´æ¢ç½‘ç»œèŠ‚ç‚¹`;
                                        reject(new Error(banMsg));
                                        return;
                                    }
                                    
                                    // å…¶ä»–é”™è¯¯ï¼šæ„å»ºé”™è¯¯æ¶ˆæ¯
                                    const errorMsg = data.error?.message || data.error || `HTTP ${res.status}`;
                                    reject(new Error(errorCode ? `${errorCode}: ${errorMsg}` : errorMsg));
                                }
                            } catch (e) {
                                // JSON è§£æå¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨è¿”å›é JSON å“åº”
                                // æ£€æŸ¥å¸¸è§çš„ HTTP çŠ¶æ€ç 
                                if (res.status === 429) {
                                    Network.recordRateLimit();
                                    reject(new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… 2 åˆ†é’Ÿåé‡è¯•'));
                                } else if (res.status === 403) {
                                    reject(new Error('IP å¯èƒ½è¢«å°ç¦ï¼Œè¯·æ›´æ¢ç½‘ç»œèŠ‚ç‚¹æˆ–è”ç³»ç®¡ç†å‘˜'));
                                } else if (res.status >= 500) {
                                    reject(new Error('æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'));
                                } else {
                                    reject(new Error(`è¯·æ±‚å¤±è´¥ (${res.status})`));
                                }
                            }
                        },
                        onerror: () => reject(new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')),
                        ontimeout: () => reject(new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•'))
                    });
                });
            }

            // è·å– JSON æ•°æ®ï¼ˆå¸¦ cookie åŒæºè¯·æ±‚ï¼‰
            // iOS Safari ä¸­ GM_xmlhttpRequest çš„ withCredentials å¯èƒ½æ— æ³•æ­£ç¡®ä¼ é€’ cookie
            // å› æ­¤å¯¹åŒæºè¯·æ±‚ä¼˜å…ˆä½¿ç”¨åŸç”Ÿ fetchï¼Œå¯ä»¥æ­£ç¡®æºå¸¦ cookie
            async fetchJson(url, options = {}) {
                const timeout = options.timeout || CONFIG.NETWORK.TIMEOUT;
                const headers = this._buildHeaders(url, { 'Accept': 'application/json', ...(options.headers || {}) });
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºåŒæºè¯·æ±‚
                const isSameOrigin = this._isSameOrigin(url);
                
                // åŒæºè¯·æ±‚ä¼˜å…ˆä½¿ç”¨åŸç”Ÿ fetchï¼ˆiOS Safari å…¼å®¹æ€§æ›´å¥½ï¼‰
                if (isSameOrigin) {
                    return this._fetchJsonNative(url, timeout, headers);
                }
                
                // è·¨åŸŸè¯·æ±‚ä½¿ç”¨ GM_xmlhttpRequest
                return this._fetchJsonGM(url, timeout, headers);
            }
            
            // æ£€æŸ¥ URL æ˜¯å¦ä¸å½“å‰é¡µé¢åŒæº
            _isSameOrigin(url) {
                try {
                    const urlObj = new URL(url, location.href);
                    return urlObj.origin === location.origin;
                } catch {
                    return false;
                }
            }
            
            // ä½¿ç”¨åŸç”Ÿ fetch è·å– JSONï¼ˆåŒæºè¯·æ±‚ï¼Œæ›´å¥½çš„ cookie æ”¯æŒï¼‰
            async _fetchJsonNative(url, timeout, headers = {}) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const resp = await fetch(url, {
                        method: 'GET',
                        headers,
                        credentials: 'include',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (resp.status >= 200 && resp.status < 300) {
                        return await resp.json();
                    } else if (resp.status === 403 || resp.status === 401) {
                        throw new Error('éœ€è¦ç™»å½•åè®¿é—®');
                    } else {
                        throw new Error(`HTTP ${resp.status}`);
                    }
                } catch (e) {
                    clearTimeout(timeoutId);
                    if (e.name === 'AbortError') {
                        throw new Error('è¯·æ±‚è¶…æ—¶');
                    }
                    throw e;
                }
            }
            
            // ä½¿ç”¨ GM_xmlhttpRequest è·å– JSONï¼ˆè·¨åŸŸè¯·æ±‚ï¼‰
            _fetchJsonGM(url, timeout, headers = {}) {
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => reject(new Error('Timeout')), timeout);
                    
                    GM_xmlhttpRequest({
                        method: 'GET',
                        url,
                        headers,
                        timeout,
                        withCredentials: true,
                        onload: res => {
                            clearTimeout(timeoutId);
                            try {
                                if (res.status >= 200 && res.status < 300) {
                                    resolve(JSON.parse(res.responseText));
                                } else if (res.status === 403 || res.status === 401) {
                                    reject(new Error('éœ€è¦ç™»å½•åè®¿é—®'));
                                } else {
                                    reject(new Error(`HTTP ${res.status}`));
                                }
                            } catch (e) {
                                reject(new Error('è§£æå“åº”å¤±è´¥'));
                            }
                        },
                        onerror: () => {
                            clearTimeout(timeoutId);
                            reject(new Error('ç½‘ç»œé”™è¯¯'));
                        },
                        ontimeout: () => {
                            clearTimeout(timeoutId);
                            reject(new Error('è¯·æ±‚è¶…æ—¶'));
                        }
                    });
                });
            }
        }

        // ==================== å†å²æ•°æ®ç®¡ç†å™¨ ====================
        class HistoryManager {
            constructor(storage) {
                this.storage = storage;
                this.cache = new LRUCache();
                this._history = null;
                this._historyTime = 0;
            }

            getHistory() {
                const now = Date.now();
                if (this._history && (now - this._historyTime) < CONFIG.CACHE.HISTORY_TTL) {
                    return this._history;
                }
                
                const history = this.storage.get('history', []);
                const cutoff = now - CONFIG.CACHE.MAX_HISTORY_DAYS * 86400000;
                this._history = history.filter(h => h.ts > cutoff);
                this._historyTime = now;
                return this._history;
            }

            addHistory(data, readingTime = 0) {
                const history = this.getHistory();
                const now = Date.now();
                const today = new Date().toDateString();
                const record = { ts: now, data, readingTime };

                const idx = history.findIndex(h => new Date(h.ts).toDateString() === today);
                idx >= 0 ? history[idx] = record : history.push(record);

                this.storage.set('history', history);
                this._history = history;
                this._historyTime = now;
                this.cache.clear();
                return history;
            }

            // èšåˆæ¯æ—¥å¢é‡
            aggregateDaily(history, reqs, maxDays) {
                const cacheKey = `daily_${maxDays}_${history.length}`;
                if (this.cache.has(cacheKey)) return this.cache.get(cacheKey);

                const byDay = new Map();
                history.forEach(h => {
                    const day = new Date(h.ts).toDateString();
                    byDay.has(day) ? byDay.get(day).push(h) : byDay.set(day, [h]);
                });

                const sortedDays = [...byDay.keys()].sort((a, b) => new Date(a) - new Date(b));
                const result = new Map();
                let prevData = null;

                sortedDays.forEach(day => {
                    const latest = byDay.get(day).at(-1);
                    const dayData = {};
                    reqs.forEach(r => {
                        dayData[r.name] = (latest.data[r.name] || 0) - (prevData?.[r.name] || 0);
                    });
                    result.set(day, dayData);
                    prevData = { ...latest.data };
                });

                this.cache.set(cacheKey, result);
                return result;
            }

            // èšåˆæ¯å‘¨å¢é‡
            aggregateWeekly(history, reqs) {
                const cacheKey = `weekly_${history.length}`;
                if (this.cache.has(cacheKey)) return this.cache.get(cacheKey);

                const now = new Date();
                const [year, month] = [now.getFullYear(), now.getMonth()];
                const weeks = this._getWeeksInMonth(year, month);
                const result = new Map();
                const byWeek = new Map(weeks.map((_, i) => [i, []]));

                history.forEach(h => {
                    const d = new Date(h.ts);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        weeks.forEach((week, i) => {
                            if (d >= week.start && d <= week.end) byWeek.get(i).push(h);
                        });
                    }
                });

                let prevData = null;
                const lastMonth = history.filter(h => new Date(h.ts) < new Date(year, month, 1));
                if (lastMonth.length) prevData = { ...lastMonth.at(-1).data };

                weeks.forEach((week, i) => {
                    const records = byWeek.get(i);
                    const weekData = {};
                    if (records.length) {
                        const latest = records.at(-1);
                        reqs.forEach(r => {
                            weekData[r.name] = (latest.data[r.name] || 0) - (prevData?.[r.name] || 0);
                        });
                        prevData = { ...latest.data };
                    } else {
                        reqs.forEach(r => weekData[r.name] = 0);
                    }
                    result.set(i, { weekNum: i + 1, start: week.start, end: week.end, label: `ç¬¬${i + 1}å‘¨`, data: weekData });
                });

                this.cache.set(cacheKey, result);
                return result;
            }

            // èšåˆæ¯æœˆå¢é‡
            aggregateMonthly(history, reqs) {
                const cacheKey = `monthly_${history.length}`;
                if (this.cache.has(cacheKey)) return this.cache.get(cacheKey);

                const byMonth = new Map();
                history.forEach(h => {
                    const d = new Date(h.ts);
                    const key = new Date(d.getFullYear(), d.getMonth(), 1).toDateString();
                    byMonth.has(key) ? byMonth.get(key).push(h) : byMonth.set(key, [h]);
                });

                const sortedMonths = [...byMonth.keys()].sort((a, b) => new Date(a) - new Date(b));
                const result = new Map();
                let prevData = null;

                sortedMonths.forEach(month => {
                    const latest = byMonth.get(month).at(-1);
                    const monthData = {};
                    reqs.forEach(r => {
                        monthData[r.name] = (latest.data[r.name] || 0) - (prevData?.[r.name] || 0);
                    });
                    result.set(month, monthData);
                    prevData = { ...latest.data };
                });

                this.cache.set(cacheKey, result);
                return result;
            }

            _getWeeksInMonth(year, month) {
                const weeks = [];
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const lastDay = new Date(year, month + 1, 0);
                // v3.5.2.9: åªç”Ÿæˆåˆ°å½“å‰æ—¥æœŸä¸ºæ­¢çš„å‘¨ï¼Œä¸æ˜¾ç¤ºæœªæ¥çš„å‘¨
                const effectiveLastDay = (year === now.getFullYear() && month === now.getMonth()) 
                    ? (today < lastDay ? today : lastDay)
                    : lastDay;
                let start = new Date(year, month, 1);
                
                while (start <= effectiveLastDay) {
                    let end = new Date(start);
                    end.setDate(end.getDate() + 6);
                    if (end > effectiveLastDay) end = new Date(effectiveLastDay);
                    weeks.push({ start: new Date(start), end });
                    start = new Date(end);
                    start.setDate(start.getDate() + 1);
                }
                return weeks;
            }
        }

        // ==================== é˜…è¯»æ—¶é—´è¿½è¸ªå™¨ ====================
        class ReadingTracker {
            constructor(storage) {
                this.storage = storage;
                this.isActive = true;
                this.lastActivity = Date.now();
                this.lastSave = Date.now();
                this._intervals = [];
                this._initialized = false;
                this._yearCache = null;
                this._yearCacheTime = 0;
            }

            init(username) {
                if (this._initialized) return;
                this.storage.migrate(username);
                this._bindEvents();
                
                // å§‹ç»ˆå¯åŠ¨æ´»åŠ¨çŠ¶æ€è¿½è¸ªï¼ˆç”¨äº UI æ˜¾ç¤ºï¼‰
                // ä½†åªæœ‰é¢†å¯¼è€…æ‰ä¼šæ‰§è¡Œæ•°æ®ä¿å­˜ï¼ˆé¿å…å¤šæ ‡ç­¾é¡µé‡å¤å†™å…¥ï¼‰
                this._startTracking();
                
                this._initialized = true;
            }
            
            _stopTracking() {
                this._intervals.forEach(id => clearInterval(id));
                this._intervals = [];
                this._tracking = false;
                // åœæ­¢å‰ä¿å­˜å½“å‰æ•°æ®
                this.save();
            }

            _bindEvents() {
                try {
                    // ä½¿ç”¨èŠ‚æµçš„æ´»åŠ¨å¤„ç†å™¨
                    // æ™®é€šäº‹ä»¶ï¼šæ¯ç§’æœ€å¤šè§¦å‘ä¸€æ¬¡
                    this._activityHandler = Utils.throttle(() => this._onActivity(), 1000);
                    // é«˜é¢‘äº‹ä»¶ï¼ˆå¦‚ mousemoveï¼‰ï¼šæ¯ 3 ç§’æœ€å¤šè§¦å‘ä¸€æ¬¡
                    this._highFreqHandler = Utils.throttle(() => this._onActivity(), 3000);
                    
                    // ç›‘å¬ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
                    // ä½¿ç”¨ capture: true ç¡®ä¿åœ¨äº‹ä»¶æ•è·é˜¶æ®µå°±èƒ½è·å–ï¼Œé¿å…è¢«å…¶ä»–è„šæœ¬é˜»æ­¢
                    // æ™®é€šé¢‘ç‡äº‹ä»¶ï¼šç‚¹å‡»ã€æŒ‰é”®ã€è§¦æ‘¸å¼€å§‹
                    this._normalEvents = ['mousedown', 'keydown', 'click', 'touchstart', 'pointerdown'];
                    this._normalEvents.forEach(e => {
                        document.addEventListener(e, this._activityHandler, { passive: true, capture: true });
                    });
                    
                    // é«˜é¢‘äº‹ä»¶ï¼šç§»åŠ¨ã€æ»šåŠ¨ï¼ˆä½¿ç”¨æ›´é•¿çš„èŠ‚æµæ—¶é—´ï¼‰
                    this._highFreqEvents = ['mousemove', 'scroll', 'wheel', 'touchmove', 'pointermove'];
                    this._highFreqEvents.forEach(e => {
                        document.addEventListener(e, this._highFreqHandler, { passive: true, capture: true });
                    });

                    // é¡µé¢å¯è§æ€§å˜åŒ–
                    this._visibilityHandler = () => {
                        if (document.hidden) {
                            this.save();
                            this.isActive = false;
                        } else {
                            // é¡µé¢æ¢å¤å¯è§æ—¶ï¼Œå‡å®šç”¨æˆ·æ­£åœ¨æŸ¥çœ‹ï¼Œæ¢å¤æ´»åŠ¨çŠ¶æ€
                            // å¦‚æœç”¨æˆ·60ç§’å†…æ— ä»»ä½•æ“ä½œï¼Œå®šæ—¶å™¨ä¼šè‡ªåŠ¨è®¾ä¸º inactive
                            this.lastActivity = Date.now();
                            this.isActive = true;
                        }
                    };
                    document.addEventListener('visibilitychange', this._visibilityHandler);
                    
                    // Safari/iOS å…¼å®¹ï¼špageshow/pagehide äº‹ä»¶æ¯” visibilitychange æ›´å¯é 
                    this._pageShowHandler = (e) => {
                        // e.persisted è¡¨ç¤ºé¡µé¢ä» bfcache æ¢å¤
                        this.lastActivity = Date.now();
                        this.isActive = true;
                    };
                    this._pageHideHandler = () => {
                        this.save();
                        this.isActive = false;
                    };
                    window.addEventListener('pageshow', this._pageShowHandler);
                    window.addEventListener('pagehide', this._pageHideHandler);
                    
                    // çª—å£è·å¾—ç„¦ç‚¹æ—¶æ›´æ–°æ´»åŠ¨çŠ¶æ€ï¼ˆåŒæ—¶ç›‘å¬ window å’Œ documentï¼‰
                    this._focusHandler = () => {
                        this.lastActivity = Date.now();
                        // Safari ä¸Š focus äº‹ä»¶æ›´å¯é ï¼Œç›´æ¥è®¾ç½® active
                        this.isActive = true;
                    };
                    this._blurHandler = () => {
                        // çª—å£å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜æ•°æ®ï¼ˆSafari ä¸Š visibilitychange å¯èƒ½ä¸è§¦å‘ï¼‰
                        this.save();
                    };
                    window.addEventListener('focus', this._focusHandler);
                    window.addEventListener('blur', this._blurHandler);
                    document.addEventListener('focus', this._focusHandler);

                    // é¡µé¢å¸è½½å‰ä¿å­˜
                    this._beforeUnloadHandler = () => this.save();
                    window.addEventListener('beforeunload', this._beforeUnloadHandler);
                    
                } catch (e) {
                    Logger.log('Failed to bind events:', e);
                    // é™çº§ï¼šå³ä½¿äº‹ä»¶ç»‘å®šå¤±è´¥ï¼Œä¹Ÿå°è¯•å¯åŠ¨åŸºæœ¬åŠŸèƒ½
                }
            }

            _onActivity() {
                const now = Date.now();
                if (!this.isActive) this.isActive = true;
                this.lastActivity = now;
            }

            _startTracking() {
                // é˜²æ­¢é‡å¤å¯åŠ¨
                if (this._tracking) return;
                this._tracking = true;
                
                // ç”¨äºæ£€æµ‹ç³»ç»Ÿä¼‘çœ /æ¢å¤
                let lastCheckTime = Date.now();
                
                // è®°å½•å®šæ—¶å™¨å¯åŠ¨æ—¶é—´ï¼Œç”¨äºå¥åº·æ£€æŸ¥
                this._trackingStartTime = Date.now();
                
                this._intervals.push(
                    setInterval(() => {
                        const now = Date.now();
                        const checkGap = now - lastCheckTime;
                        
                        // æ£€æµ‹ç³»ç»Ÿä¼‘çœ ï¼šå¦‚æœä¸¤æ¬¡æ£€æŸ¥é—´éš”è¶…è¿‡é¢„æœŸçš„ 3 å€ï¼Œè¯´æ˜å¯èƒ½ä¼‘çœ è¿‡
                        // ä¾‹å¦‚ï¼šREADING_TRACK=10ç§’ï¼Œå¦‚æœé—´éš”è¶…è¿‡ 30 ç§’ï¼Œè¯´æ˜ç³»ç»Ÿæš‚åœè¿‡
                        if (checkGap > CONFIG.INTERVALS.READING_TRACK * 3) {
                            // ç³»ç»Ÿåˆšä»ä¼‘çœ æ¢å¤ï¼Œé‡ç½®çŠ¶æ€é¿å…ç´¯ç§¯é”™è¯¯æ—¶é—´
                            this.isActive = false;
                            this.lastActivity = now;
                            this.lastSave = now;
                            lastCheckTime = now;
                            Logger.log('System resume detected, reset tracking state');
                            return; // è·³è¿‡æœ¬æ¬¡ç©ºé—²æ£€æµ‹ï¼Œç­‰å¾…ç”¨æˆ·æ–°æ´»åŠ¨
                        }
                        lastCheckTime = now;
                        
                        // ç©ºé—²æ£€æµ‹é€»è¾‘ï¼šåªè´Ÿè´£å°† active çŠ¶æ€è®¾ä¸º false
                        // isActive = true åªèƒ½é€šè¿‡ç”¨æˆ·æ´»åŠ¨äº‹ä»¶è§¦å‘ï¼ˆ_onActivityï¼‰
                        const idle = now - this.lastActivity;
                        if (this.isActive && idle > CONFIG.INTERVALS.READING_IDLE) {
                            this.isActive = false;
                        }
                        // æ³¨æ„ï¼šä¸å†è‡ªåŠ¨å°† isActive è®¾ä¸º true
                        // ç”¨æˆ·å¿…é¡»æœ‰æ–°æ´»åŠ¨æ‰èƒ½æ¢å¤è®°å½•çŠ¶æ€
                    }, CONFIG.INTERVALS.READING_TRACK),
                    setInterval(() => this.save(), CONFIG.INTERVALS.READING_SAVE)
                );
                
                // å¥åº·æ£€æŸ¥ï¼šæ¯ 60 ç§’æ£€æŸ¥å®šæ—¶å™¨æ˜¯å¦è¿˜å­˜æ´»
                // å¦‚æœå®šæ—¶å™¨æ„å¤–è¢«æ¸…é™¤ï¼Œå°è¯•é‡æ–°å¯åŠ¨
                this._healthCheckId = setInterval(() => {
                    if (this._tracking && this._intervals.length === 0) {
                        Logger.log('Tracking timers died, restarting...');
                        this._tracking = false;
                        this._startTracking();
                    }
                }, 60000);
            }

            save() {
                if (!this.storage.getUser()) return;

                const todayKey = Utils.getTodayKey();
                const now = Date.now();
                
                // è®¡ç®—è¿™æ¬¡åº”è¯¥åŠ çš„æ—¶é—´ï¼ˆåŸºäºæœ¬æ ‡ç­¾é¡µçš„æ´»åŠ¨çŠ¶æ€ï¼‰
                const elapsed = (now - this.lastSave) / 1000;
                const idle = now - this.lastActivity;
                
                // é˜²æŠ¤ï¼šæ£€æµ‹å¼‚å¸¸æ•°æ®
                // 1. elapsed ä¸ºè´Ÿæ•°ï¼ˆç³»ç»Ÿæ—¶é—´è¢«è°ƒæ•´ï¼‰
                // 2. elapsed è¿‡å¤§ï¼ˆè¶…è¿‡ 2 åˆ†é’Ÿï¼Œå¯èƒ½æ˜¯ä¼‘çœ æ¢å¤ï¼‰
                // 3. idle ä¸ºè´Ÿæ•°ï¼ˆç³»ç»Ÿæ—¶é—´è¢«è°ƒæ•´ï¼‰
                if (elapsed < 0 || elapsed > 120 || idle < 0) {
                    // é‡ç½®çŠ¶æ€ï¼Œä¸è®°å½•è¿™æ®µå¼‚å¸¸æ—¶é—´
                    this.lastSave = now;
                    this.lastActivity = now;
                    this.isActive = false;
                    return;
                }
                
                let toAdd = 0;
                if (elapsed > 0) {
                    // è®¡ç®—æœ‰æ•ˆçš„æ´»åŠ¨æ—¶é—´
                    // å¦‚æœç”¨æˆ·ä¸€ç›´æ´»è·ƒï¼ˆidle <= 60ç§’ï¼‰ï¼Œè®°å½•å…¨éƒ¨ elapsed æ—¶é—´
                    // å¦‚æœç”¨æˆ·ç©ºé—²äº†ï¼Œå‡å»è¶…å‡ºç©ºé—²é˜ˆå€¼çš„éƒ¨åˆ†
                    toAdd = idle <= CONFIG.INTERVALS.READING_IDLE 
                        ? elapsed 
                        : Math.max(0, elapsed - (idle - CONFIG.INTERVALS.READING_IDLE) / 1000);
                    
                    // é¢å¤–é˜²æŠ¤ï¼šå•æ¬¡ä¿å­˜ä¸èƒ½è¶…è¿‡ä¿å­˜é—´éš”çš„ 1.5 å€ï¼ˆæ­£å¸¸çº¦45ç§’ï¼‰
                    const maxToAdd = CONFIG.INTERVALS.READING_SAVE / 1000 * 1.5;
                    toAdd = Math.min(toAdd, maxToAdd);
                }
                
                // æ— è®ºæ˜¯å¦æ˜¯é¢†å¯¼è€…ï¼Œéƒ½æ›´æ–° lastSaveï¼ˆé¿å…æ—¶é—´ç´¯ç§¯ï¼‰
                this.lastSave = now;
                
                // åªæœ‰é¢†å¯¼è€…æ‰å†™å…¥ storage
                if (!TabLeader.isLeader()) return;

                let stored = this.storage.get('readingTime', null);

                if (!stored?.dailyData) {
                    stored = { version: 3, dailyData: {}, monthlyCache: {}, yearlyCache: {} };
                }

                let today = stored.dailyData[todayKey] || { totalMinutes: 0, lastActive: now, sessions: [] };

                const minutes = toAdd / 60;
                if (minutes > 0.1) {
                    today.totalMinutes += minutes;
                    today.lastActive = now;
                    today.sessions = (today.sessions || []).slice(-20); // é™åˆ¶ä¼šè¯æ•°é‡
                    today.sessions.push({ time: now, added: minutes });

                    stored.dailyData[todayKey] = today;
                    this._updateCache(stored, todayKey, minutes);
                    this._cleanOld(stored);
                    this.storage.set('readingTime', stored);
                    this._yearCache = null;
                }
            }

            _updateCache(stored, dateKey, minutes) {
                try {
                    const d = new Date(dateKey);
                    const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    const yearKey = `${d.getFullYear()}`;
                    stored.monthlyCache[monthKey] = (stored.monthlyCache[monthKey] || 0) + minutes;
                    stored.yearlyCache[yearKey] = (stored.yearlyCache[yearKey] || 0) + minutes;
                } catch (e) {}
            }

            _cleanOld(stored) {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - CONFIG.CACHE.MAX_HISTORY_DAYS);

                Object.keys(stored.dailyData).forEach(key => {
                    if (new Date(key) < cutoff) delete stored.dailyData[key];
                });

                Object.keys(stored.monthlyCache || {}).forEach(key => {
                    const [y, m] = key.split('-');
                    if (new Date(+y, +m - 1, 1) < cutoff) delete stored.monthlyCache[key];
                });
            }

            getTodayTime() {
                if (!this.storage.getUser()) return 0;
                
                const stored = this.storage.get('readingTime', null);
                const saved = stored?.dailyData?.[Utils.getTodayKey()]?.totalMinutes || 0;
                
                const now = Date.now();
                const elapsed = (now - this.lastSave) / 1000;
                const idle = now - this.lastActivity;
                
                let unsaved = 0;
                if (idle <= CONFIG.INTERVALS.READING_IDLE) {
                    unsaved = elapsed / 60;
                } else {
                    unsaved = Math.max(0, elapsed - (idle - CONFIG.INTERVALS.READING_IDLE) / 1000) / 60;
                }

                return saved + Math.max(0, unsaved);
            }

            getTimeForDate(dateKey) {
                return this.storage.get('readingTime', null)?.dailyData?.[dateKey]?.totalMinutes || 0;
            }

            getWeekHistory() {
                const result = [];
                const now = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(now);
                    d.setDate(d.getDate() - i);
                    const key = d.toDateString();
                    result.push({
                        date: key,
                        label: Utils.formatDate(d.getTime()),
                        day: CONFIG.WEEKDAYS[d.getDay()],
                        minutes: i === 0 ? this.getTodayTime() : this.getTimeForDate(key),
                        isToday: i === 0
                    });
                }
                return result;
            }

            getYearData() {
                const now = Date.now();
                if (this._yearCache && (now - this._yearCacheTime) < CONFIG.CACHE.YEAR_DATA_TTL) {
                    return this._yearCache;
                }

                const today = new Date();
                const year = today.getFullYear();
                const stored = this.storage.get('readingTime', null);
                const daily = stored?.dailyData || {};
                const result = new Map();

                Object.entries(daily).forEach(([key, data]) => {
                    if (new Date(key).getFullYear() === year) {
                        result.set(key, data.totalMinutes || 0);
                    }
                });
                result.set(Utils.getTodayKey(), this.getTodayTime());

                this._yearCache = result;
                this._yearCacheTime = now;
                return result;
            }

            getTotalTime() {
                const stored = this.storage.get('readingTime', null);
                if (!stored?.dailyData) return this.getTodayTime();

                const todayKey = Utils.getTodayKey();
                let total = 0;
                Object.entries(stored.dailyData).forEach(([key, data]) => {
                    total += key === todayKey ? this.getTodayTime() : (data.totalMinutes || 0);
                });
                return total;
            }
            
            destroy() {
                // æ¸…é™¤è®¡æ—¶å®šæ—¶å™¨
                this._intervals.forEach(id => clearInterval(id));
                this._intervals = [];
                this._tracking = false;
                
                // æ¸…é™¤å¥åº·æ£€æŸ¥å®šæ—¶å™¨
                if (this._healthCheckId) {
                    clearInterval(this._healthCheckId);
                    this._healthCheckId = null;
                }
                
                // ç§»é™¤æ™®é€šäº‹ä»¶ç›‘å¬å™¨ï¼ˆæ³¨æ„ï¼šcapture å¿…é¡»ä¸æ·»åŠ æ—¶ä¸€è‡´ï¼‰
                if (this._activityHandler && this._normalEvents) {
                    this._normalEvents.forEach(e => {
                        document.removeEventListener(e, this._activityHandler, { passive: true, capture: true });
                    });
                }
                // ç§»é™¤é«˜é¢‘äº‹ä»¶ç›‘å¬å™¨
                if (this._highFreqHandler && this._highFreqEvents) {
                    this._highFreqEvents.forEach(e => {
                        document.removeEventListener(e, this._highFreqHandler, { passive: true, capture: true });
                    });
                }
                if (this._visibilityHandler) {
                    document.removeEventListener('visibilitychange', this._visibilityHandler);
                }
                // ç§»é™¤ Safari å…¼å®¹äº‹ä»¶
                if (this._pageShowHandler) {
                    window.removeEventListener('pageshow', this._pageShowHandler);
                }
                if (this._pageHideHandler) {
                    window.removeEventListener('pagehide', this._pageHideHandler);
                }
                // ç§»é™¤ç„¦ç‚¹äº‹ä»¶
                if (this._focusHandler) {
                    window.removeEventListener('focus', this._focusHandler);
                    document.removeEventListener('focus', this._focusHandler);
                }
                if (this._blurHandler) {
                    window.removeEventListener('blur', this._blurHandler);
                }
                if (this._beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', this._beforeUnloadHandler);
                }
                
                // ä¿å­˜æ•°æ®
                this.save();
            }
        }

        // ==================== é€šçŸ¥ç®¡ç†å™¨ ====================
        class Notifier {
            constructor(storage) {
                this.storage = storage;
            }

            check(reqs) {
                const achieved = this.storage.get('milestones', {});
                const newMilestones = [];

                reqs.forEach(r => {
                    Object.entries(CONFIG.MILESTONES).forEach(([key, thresholds]) => {
                        if (r.name.includes(key)) {
                            thresholds.forEach(t => {
                                const k = `${key}_${t}`;
                                if (r.currentValue >= t && !achieved[k]) {
                                    newMilestones.push({ name: key, threshold: t });
                                    achieved[k] = true;
                                }
                            });
                        }
                    });

                    const reqKey = `req_${r.name}`;
                    if (r.isSuccess && !achieved[reqKey]) {
                        newMilestones.push({ name: r.name, type: 'req' });
                        achieved[reqKey] = true;
                    }
                });

                if (newMilestones.length) {
                    this.storage.set('milestones', achieved);
                    this._notify(newMilestones);
                }
            }

            _notify(milestones) {
                const last = this.storage.get('lastNotify', 0);
                if (Date.now() - last < 60000) return;
                
                this.storage.set('lastNotify', Date.now());
                const msg = milestones.slice(0, 3).map(m => 
                    m.type === 'req' ? `âœ… ${m.name}` : `ğŸ† ${m.name} â†’ ${m.threshold}`
                ).join('\n');

                typeof GM_notification !== 'undefined' && GM_notification({
                    title: 'ğŸ‰ è¾¾æˆé‡Œç¨‹ç¢‘ï¼',
                    text: msg,
                    timeout: 5000
                });
            }
        }

        // ==================== OAuth ç®¡ç†å™¨ ====================
        class OAuthManager {
            constructor(storage, network) {
                this.storage = storage;
                this.network = network;
            }

            getToken() { return this.storage.getGlobal('leaderboardToken', null); }
            setToken(token) { this.storage.setGlobalNow('leaderboardToken', token); }
            
            getUserInfo() { return this.storage.getGlobal('leaderboardUser', null); }
            setUserInfo(user) { this.storage.setGlobalNow('leaderboardUser', user); }
            
            /**
             * æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ä¸” Token æœªè¿‡æœŸ
             */
            isLoggedIn() {
                const token = this.getToken();
                const user = this.getUserInfo();
                if (!token || !user) return false;
                
                // æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ
                if (this._isTokenExpired(token)) {
                    Logger.log('Token expired, logging out');
                    this.logout();
                    return false;
                }
                return true;
            }
            
            /**
             * è§£æ JWT Token æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
             */
            _isTokenExpired(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) return true;
                    
                    // è§£æ payload (base64url)
                    const payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                    const decoded = JSON.parse(atob(payload));
                    
                    // æ£€æŸ¥è¿‡æœŸæ—¶é—´ (exp æ˜¯ç§’çº§æ—¶é—´æˆ³)
                    if (!decoded.exp) return false; // æ— è¿‡æœŸæ—¶é—´åˆ™è®¤ä¸ºæœ‰æ•ˆ
                    
                    const now = Math.floor(Date.now() / 1000);
                    // æå‰ 10 åˆ†é’Ÿåˆ¤æ–­ä¸ºè¿‡æœŸï¼Œå¢åŠ å®¹é”™æ—¶é—´é¿å…è¾¹ç•Œæƒ…å†µ
                    return decoded.exp < (now + 600);
                } catch (e) {
                    console.error('[LDStatus Pro] Token parse error:', e);
                    return true; // è§£æå¤±è´¥è§†ä¸ºè¿‡æœŸ
                }
            }
            
            isJoined() { return this.storage.getGlobal('leaderboardJoined', false); }
            setJoined(v) { this.storage.setGlobalNow('leaderboardJoined', v); }

            /**
             * æ£€æŸ¥ URL hash ä¸­çš„ç™»å½•ç»“æœ
             * ç»Ÿä¸€åŒçª—å£ç™»å½•æ¨¡å¼ï¼šå›è°ƒåé€šè¿‡ URL hash ä¼ é€’ç™»å½•ç»“æœ
             */
            _checkUrlHashLogin() {
                try {
                    const hash = window.location.hash;
                    if (!hash) return null;
                    
                    // æŸ¥æ‰¾ ldsp_oauth å‚æ•°
                    const match = hash.match(/ldsp_oauth=([^&]+)/);
                    if (!match) return null;
                    
                    const encoded = match[1];
                    // è§£ç  base64
                    const decoded = JSON.parse(decodeURIComponent(atob(encoded)));
                    
                    // æ£€æŸ¥æ—¶æ•ˆæ€§ï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
                    if (decoded.ts && Date.now() - decoded.ts > 5 * 60 * 1000) {
                        console.log('[OAuth] URL login result expired');
                        this._clearUrlHash();
                        return null;
                    }
                    
                    // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
                    const result = {
                        success: true,
                        token: decoded.t,
                        user: decoded.u,
                        isJoined: decoded.j === 1
                    };
                    
                    // æ¸…é™¤ URL ä¸­çš„ç™»å½•å‚æ•°ï¼Œä¿æŒ URL å¹²å‡€
                    this._clearUrlHash();
                    
                    return result;
                } catch (e) {
                    console.error('[OAuth] Failed to parse URL hash login:', e);
                    this._clearUrlHash();
                    return null;
                }
            }
            
            /**
             * æ¸…é™¤ URL ä¸­çš„ OAuth ç™»å½•å‚æ•°
             */
            _clearUrlHash() {
                try {
                    const hash = window.location.hash;
                    if (!hash || !hash.includes('ldsp_oauth=')) return;
                    
                    // ç§»é™¤ ldsp_oauth å‚æ•°
                    let newHash = hash.replace(/[#&]?ldsp_oauth=[^&]*/, '');
                    // æ¸…ç†å¤šä½™çš„ # å’Œ &
                    newHash = newHash.replace(/^[#&]+/, '').replace(/[#&]+$/, '');
                    
                    // æ›´æ–° URLï¼ˆä¸è§¦å‘é¡µé¢åˆ·æ–°ï¼‰
                    const newUrl = window.location.pathname + window.location.search + (newHash ? '#' + newHash : '');
                    history.replaceState(null, '', newUrl);
                } catch (e) {
                    console.warn('[OAuth] Failed to clear URL hash:', e);
                }
            }

            /**
             * ç»Ÿä¸€åŒçª—å£ç™»å½•
             * æ‰€æœ‰ç¯å¢ƒéƒ½ä½¿ç”¨åŒçª—å£è·³è½¬æ–¹å¼ï¼Œé¿å…å¼¹çª—æ‹¦æˆªå’Œè·¨çª—å£é€šä¿¡é—®é¢˜
             */
            async login() {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ç™»å½•ç»“æœï¼ˆä» URL hash ä¸­è·å–ï¼‰
                const pendingResult = this._checkUrlHashLogin();
                if (pendingResult?.success && pendingResult.token && pendingResult.user) {
                    this.setToken(pendingResult.token);
                    this.setUserInfo(pendingResult.user);
                    this.setJoined(pendingResult.isJoined || false);
                    return pendingResult.user;
                }

                // è·å–æˆæƒé“¾æ¥å¹¶è·³è½¬ï¼ˆåŒçª—å£æ¨¡å¼ï¼‰
                const siteParam = encodeURIComponent(CURRENT_SITE.domain);
                // ä½¿ç”¨ä¸å¸¦ hash çš„ URL ä½œä¸ºè¿”å›åœ°å€
                const returnUrl = encodeURIComponent(window.location.origin + window.location.pathname + window.location.search);
                
                try {
                    const result = await this.network.api(`/api/auth/init?site=${siteParam}&return_url=${returnUrl}`);
                    
                    if (result.success && result.data?.auth_url) {
                        // è·³è½¬åˆ°æˆæƒé¡µé¢
                        window.location.href = result.data.auth_url;
                        // è¿”å›ä¸€ä¸ªæ°¸ä¸ resolve çš„ Promiseï¼ˆé¡µé¢ä¼šè·³è½¬ï¼Œä¸ä¼šæ‰§è¡Œåç»­ä»£ç ï¼‰
                        return new Promise(() => {});
                    } else {
                        throw new Error(result.error?.message || 'è·å–æˆæƒé“¾æ¥å¤±è´¥');
                    }
                } catch (e) {
                    throw new Error(e.message || 'ç™»å½•è¯·æ±‚å¤±è´¥');
                }
            }

            logout() {
                this.setToken(null);
                this.setUserInfo(null);
                this.setJoined(false);
            }

            /**
             * å‘èµ· API è¯·æ±‚ï¼Œè‡ªåŠ¨å¤„ç† Token è¿‡æœŸ
             * @param {string} endpoint - API ç«¯ç‚¹
             * @param {Object} options - è¯·æ±‚é€‰é¡¹
             * @param {boolean} options.requireAuth - æ˜¯å¦éœ€è¦ç™»å½•ï¼ˆé»˜è®¤ trueï¼‰
             */
            async api(endpoint, options = {}) {
                const { requireAuth = true, ...restOptions } = options;
                
                // éœ€è¦ç™»å½•çš„æ¥å£ï¼Œå…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆåŒ…å« Token è¿‡æœŸæ£€æµ‹ï¼‰
                if (requireAuth) {
                    const token = this.getToken();
                    // æ—  Token æˆ– Token å·²è¿‡æœŸï¼Œç›´æ¥è¿”å›é”™è¯¯
                    if (!token || this._isTokenExpired(token)) {
                        // æ¸…ç†è¿‡æœŸçŠ¶æ€
                        if (token) this.logout();
                        return { success: false, error: { code: 'NOT_LOGGED_IN', message: 'Not logged in or token expired' } };
                    }
                }
                
                try {
                    const result = await this.network.api(endpoint, { ...restOptions, token: this.getToken() });
                    return result;
                } catch (e) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ Token è¿‡æœŸé”™è¯¯
                    const errMsg = e.message || '';
                    const isAuthError = errMsg.includes('expired') || errMsg.includes('TOKEN_EXPIRED') || 
                        errMsg.includes('INVALID_TOKEN') || errMsg.includes('401') ||
                        errMsg.includes('Unauthorized') || (e instanceof NetworkError && e.isAuth);
                    
                    if (isAuthError) {
                        this.logout();
                        // é€šè¿‡äº‹ä»¶æ€»çº¿é€šçŸ¥ï¼ˆæ›¿ä»£å…¨å±€ window äº‹ä»¶ï¼‰
                        EventBus.emit('auth:expired', { endpoint });
                    }
                    throw e;
                }
            }
        }

        // ==================== æ’è¡Œæ¦œç®¡ç†å™¨ ====================
        class LeaderboardManager {
            constructor(oauth, readingTracker, storage) {
                this.oauth = oauth;
                this.tracker = readingTracker;
                this.storage = storage;  // v3.2.7: ç”¨äºæ™ºèƒ½åŒæ­¥ç¼“å­˜
                this.cache = new Map();
                this._syncTimer = null;
                this._lastSync = 0;
                this._manualRefreshTime = new Map(); // è®°å½•æ¯ç§æ¦œçš„æ‰‹åŠ¨åˆ·æ–°æ—¶é—´
            }

            // æ‰‹åŠ¨åˆ·æ–°å†·å´æ—¶é—´ 5 åˆ†é’Ÿ
            static MANUAL_REFRESH_COOLDOWN = 5 * 60 * 1000;

            async getLeaderboard(type = 'daily') {
                const key = `lb_${type}`;
                const cached = this.cache.get(key);
                const now = Date.now();
                const ttlMap = {
                    daily: CONFIG.CACHE.LEADERBOARD_DAILY_TTL,
                    weekly: CONFIG.CACHE.LEADERBOARD_WEEKLY_TTL,
                    monthly: CONFIG.CACHE.LEADERBOARD_MONTHLY_TTL
                };
                const ttl = ttlMap[type] || CONFIG.CACHE.LEADERBOARD_DAILY_TTL;

                if (cached && (now - cached.time) < ttl) return cached.data;

                try {
                    // oauth.api() å†…ç½®ç™»å½•æ£€æŸ¥ï¼Œæœªç™»å½•æ—¶è¿”å› { success: false }
                    const result = await this.oauth.api(`/api/leaderboard/${type}`);
                    if (result.success) {
                        const data = {
                            rankings: result.data.rankings || [],
                            period: result.data.period,
                            myRank: result.data.myRank
                        };
                        this.cache.set(key, { data, time: now });
                        return data;
                    }
                    throw new Error(result.error || 'è·å–æ’è¡Œæ¦œå¤±è´¥');
                } catch (e) {
                    if (cached) return cached.data;
                    throw e;
                }
            }

            // æ‰‹åŠ¨åˆ·æ–°æ’è¡Œæ¦œï¼ˆæœ‰5åˆ†é’Ÿå†·å´æ—¶é—´ï¼‰
            async forceRefresh(type = 'daily') {
                const key = `lb_${type}`;
                const now = Date.now();
                const lastRefresh = this._manualRefreshTime.get(type) || 0;

                // æ£€æŸ¥å†·å´æ—¶é—´
                if (now - lastRefresh < LeaderboardManager.MANUAL_REFRESH_COOLDOWN) {
                    // å†·å´ä¸­ï¼Œè¿”å›ç¼“å­˜
                    const cached = this.cache.get(key);
                    if (cached) return { data: cached.data, fromCache: true };
                    throw new Error('åˆ·æ–°å†·å´ä¸­');
                }

                try {
                    const result = await this.oauth.api(`/api/leaderboard/${type}`);
                    if (result.success) {
                        const data = {
                            rankings: result.data.rankings || [],
                            period: result.data.period,
                            myRank: result.data.myRank
                        };
                        this.cache.set(key, { data, time: now });
                        this._manualRefreshTime.set(type, now);
                        return { data, fromCache: false };
                    }
                    throw new Error(result.error || 'è·å–æ’è¡Œæ¦œå¤±è´¥');
                } catch (e) {
                    const cached = this.cache.get(key);
                    if (cached) return { data: cached.data, fromCache: true };
                    throw e;
                }
            }

            // è·å–æ‰‹åŠ¨åˆ·æ–°å‰©ä½™å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
            getRefreshCooldown(type = 'daily') {
                const lastRefresh = this._manualRefreshTime.get(type) || 0;
                const elapsed = Date.now() - lastRefresh;
                const remaining = LeaderboardManager.MANUAL_REFRESH_COOLDOWN - elapsed;
                return remaining > 0 ? Math.ceil(remaining / 1000) : 0;
            }

            async join() {
                const result = await this.oauth.api('/api/user/register', { method: 'POST' });
                if (result.success) {
                    this.oauth.setJoined(true);
                    return true;
                }
                // æ£€æµ‹ç™»å½•å¤±æ•ˆæƒ…å†µ
                const errCode = result.error?.code;
                if (errCode === 'NOT_LOGGED_IN' || errCode === 'AUTH_EXPIRED' || errCode === 'INVALID_TOKEN') {
                    throw new Error('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                }
                throw new Error(result.error?.message || result.error || 'åŠ å…¥å¤±è´¥');
            }

            async quit() {
                const result = await this.oauth.api('/api/user/quit', { method: 'POST' });
                if (result.success) {
                    this.oauth.setJoined(false);
                    return true;
                }
                // æ£€æµ‹ç™»å½•å¤±æ•ˆæƒ…å†µ
                const errCode = result.error?.code;
                if (errCode === 'NOT_LOGGED_IN' || errCode === 'AUTH_EXPIRED' || errCode === 'INVALID_TOKEN') {
                    throw new Error('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                }
                throw new Error(result.error?.message || result.error || 'é€€å‡ºå¤±è´¥');
            }

            async syncReadingTime() {
                if (!this.oauth.isLoggedIn() || !this.oauth.isJoined()) return;
                // åªæœ‰é¢†å¯¼è€…æ ‡ç­¾é¡µæ‰æ‰§è¡ŒåŒæ­¥ï¼Œé¿å…å¤šæ ‡ç­¾é¡µé‡å¤è¯·æ±‚
                if (!TabLeader.isLeader()) return;
                if (Date.now() - this._lastSync < 60000) return;

                try {
                    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    const currentMinutes = this.tracker.getTodayTime();
                    
                    // v3.2.7 ä¼˜åŒ–ï¼ˆæ–¹æ¡ˆEï¼‰ï¼šæ™ºèƒ½åŒæ­¥ - åªåœ¨æ•°æ®å˜åŒ–æ—¶æ‰å‘é€è¯·æ±‚
                    // èŠ‚çœçº¦ 30% çš„ D1 å†™å…¥é¢åº¦
                    const lastSyncedKey = `lastSynced_${today}`;
                    const lastSyncedMinutes = this.storage?.getGlobal(lastSyncedKey, -1) ?? -1;
                    
                    if (currentMinutes === lastSyncedMinutes) {
                        // æ•°æ®æ²¡å˜åŒ–ï¼Œè·³è¿‡åŒæ­¥
                        return;
                    }
                    
                    const result = await this.oauth.api('/api/reading/sync', {
                        method: 'POST',
                        body: { 
                            date: today,
                            minutes: currentMinutes,
                            client_timestamp: Date.now()
                        }
                    });
                    
                    // ç™»å½•å¤±æ•ˆæˆ–è¯·æ±‚å¤±è´¥ï¼Œä¸æ›´æ–°æœ¬åœ°çŠ¶æ€
                    if (!result?.success && !result?.server_minutes) {
                        return;
                    }
                    
                    this._lastSync = Date.now();
                    
                    // v3.4.2 ä¿®å¤ï¼šæ¸è¿›åŒæ­¥ - å¤„ç†æœåŠ¡å™¨æˆªæ–­å“åº”
                    // æœåŠ¡å™¨é˜²åˆ·æœºåˆ¶ä¼šé™åˆ¶å•æ¬¡å¢é‡ï¼Œéœ€è¦å¤šæ¬¡åŒæ­¥æ‰èƒ½å®Œæˆå¤§å¹…å¢é‡
                    if (result && result.server_minutes !== undefined) {
                        // ä»¥æœåŠ¡å™¨å®é™…æ¥å—çš„åˆ†é’Ÿæ•°ä¸ºå‡†
                        const serverAccepted = result.server_minutes;
                        this.storage?.setGlobal(lastSyncedKey, serverAccepted);
                        
                        if (result.truncated && serverAccepted < currentMinutes) {
                            // æœåŠ¡å™¨æˆªæ–­äº†æ•°æ®ï¼Œéœ€è¦ç»§ç»­åŒæ­¥
                            Logger.log(`Leaderboard sync truncated: server=${serverAccepted}, client=${currentMinutes}, will retry`);
                            // 35ç§’åå†æ¬¡å°è¯•åŒæ­¥å‰©ä½™æ•°æ®ï¼ˆæœåŠ¡å™¨é™åˆ¶æ˜¯30ç§’ï¼‰
                            setTimeout(() => {
                                this._lastSync = 0; // é‡ç½®å†·å´æ—¶é—´
                                this.syncReadingTime();
                            }, 35000);
                        } else if (result.rateLimited) {
                            // è¢«æœåŠ¡å™¨é™é€Ÿï¼Œç¨åé‡è¯•
                            Logger.log('Leaderboard rate limited, will retry later');
                            setTimeout(() => {
                                this._lastSync = 0;
                                this.syncReadingTime();
                            }, 35000);
                        }
                    } else {
                        // å…¼å®¹æ—§ç‰ˆå“åº”æ ¼å¼
                        this.storage?.setGlobal(lastSyncedKey, currentMinutes);
                    }
                } catch (e) {
                    console.warn('[Leaderboard] Sync failed:', e.message || e);
                }
            }

            startSync() {
                if (this._syncTimer) return;
                // å»¶è¿Ÿ5ç§’åé¦–æ¬¡åŒæ­¥ï¼Œé¿å…ä¸é¡µé¢åŠ è½½æ—¶çš„å…¶ä»–è¯·æ±‚å¹¶å‘
                setTimeout(() => this.syncReadingTime(), 5000);
                this._syncTimer = setInterval(() => this.syncReadingTime(), CONFIG.INTERVALS.LEADERBOARD_SYNC);
            }

            stopSync() {
                this._syncTimer && clearInterval(this._syncTimer);
                this._syncTimer = null;
            }

            clearCache() { this.cache.clear(); }
            
            destroy() {
                this.stopSync();
                this.clearCache();
            }
        }

        // ==================== äº‘åŒæ­¥ç®¡ç†å™¨ ====================
        class CloudSyncManager {
            constructor(storage, oauth, tracker) {
                this.storage = storage;
                this.oauth = oauth;
                this.tracker = tracker;
                this._timer = null;
                this._syncing = false;
                this._lastUpload = storage.getGlobal('lastCloudSync', 0);
                this._lastDownload = storage.getGlobal('lastDownloadSync', 0);
                this._lastHash = storage.getGlobal('lastUploadHash', '');
                this._onSyncStateChange = null;  // åŒæ­¥çŠ¶æ€å˜åŒ–å›è°ƒ
                
                // å¤±è´¥é‡è¯•æœºåˆ¶
                this._failureCount = { reading: 0, requirements: 0 };
                this._lastFailure = { reading: 0, requirements: 0 };
                
                // trust_level ç¼“å­˜ï¼ˆé¿å…é‡å¤è°ƒç”¨ requirements æ¥å£ï¼‰
                this._trustLevelCache = storage.getGlobal('trustLevelCache', null);
                this._trustLevelCacheTime = storage.getGlobal('trustLevelCacheTime', 0);
            }
            
            // è®¡ç®—é€€é¿å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼Œæœ€å¤§ 30 åˆ†é’Ÿï¼‰
            _getBackoffDelay(type) {
                const failures = this._failureCount[type] || 0;
                if (failures === 0) return 0;
                const baseDelay = CONFIG.INTERVALS.SYNC_RETRY_DELAY || 60000;
                return Math.min(baseDelay * Math.pow(2, failures - 1), 30 * 60 * 1000);
            }
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥é‡è¯•
            _canRetry(type) {
                const lastFail = this._lastFailure[type] || 0;
                const backoff = this._getBackoffDelay(type);
                return Date.now() - lastFail >= backoff;
            }
            
            // è®°å½•å¤±è´¥
            _recordFailure(type) {
                this._failureCount[type] = Math.min((this._failureCount[type] || 0) + 1, 6);
                this._lastFailure[type] = Date.now();
            }
            
            // è®°å½•æˆåŠŸï¼ˆé‡ç½®å¤±è´¥è®¡æ•°ï¼‰
            _recordSuccess(type) {
                this._failureCount[type] = 0;
                this._lastFailure[type] = 0;
            }
            
            // æ£€æŸ¥ç”¨æˆ· trust_level æ˜¯å¦è¶³å¤Ÿ
            // ä¼˜å…ˆä» OAuth ç”¨æˆ·ä¿¡æ¯è·å–ï¼Œå…¶æ¬¡ä½¿ç”¨ç¼“å­˜
            _hasSufficientTrustLevel() {
                // 1. ä¼˜å…ˆä» OAuth ç”¨æˆ·ä¿¡æ¯è·å– trust_levelï¼ˆæœ€å‡†ç¡®ï¼‰
                // v3.4.7: å…¼å®¹ trust_level å’Œ trustLevel ä¸¤ç§å‘½åæ ¼å¼
                const userInfo = this.oauth.getUserInfo();
                const trustLevel = userInfo?.trust_level ?? userInfo?.trustLevel;
                if (userInfo && typeof trustLevel === 'number') {
                    const hasTrust = trustLevel >= 2;
                    // æ›´æ–°ç¼“å­˜ä»¥ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨
                    if (this._trustLevelCache !== hasTrust) {
                        this._updateTrustLevelCache(hasTrust);
                    }
                    return hasTrust;
                }
                
                // 2. ä½¿ç”¨ç¼“å­˜ï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰
                const now = Date.now();
                const cacheAge = now - this._trustLevelCacheTime;
                if (this._trustLevelCache !== null && cacheAge < 24 * 60 * 60 * 1000) {
                    return this._trustLevelCache;
                }
                
                // 3. æ— æ³•ç¡®å®šï¼Œè¿”å› nullï¼ˆéœ€è¦ä» API è·å–ï¼‰
                return null;
            }
            
            // æ›´æ–° trust_level ç¼“å­˜ï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰
            _updateTrustLevelCache(hasTrust) {
                // v3.4.8: ç§»é™¤ç­‰çº§é™åˆ¶ï¼Œå§‹ç»ˆç¼“å­˜ä¸º true
                this._trustLevelCache = true;
                this._trustLevelCacheTime = Date.now();
                this.storage.setGlobalNow('trustLevelCache', true);
                this.storage.setGlobalNow('trustLevelCacheTime', this._trustLevelCacheTime);
            }

            // è®¾ç½®åŒæ­¥çŠ¶æ€å˜åŒ–å›è°ƒ
            setSyncStateCallback(callback) {
                this._onSyncStateChange = callback;
            }

            // æ›´æ–°åŒæ­¥çŠ¶æ€
            _setSyncing(syncing) {
                this._syncing = syncing;
                this._onSyncStateChange?.(syncing);
            }

            // è·å–åŒæ­¥çŠ¶æ€
            isSyncing() {
                return this._syncing;
            }

            _getDataHash() {
                const data = this.storage.get('readingTime', null);
                if (!data?.dailyData) return '';
                const days = Object.keys(data.dailyData).length;
                const total = Object.values(data.dailyData).reduce((s, d) => s + (d.totalMinutes || 0), 0);
                return `${days}:${Math.round(total)}`;
            }

            async download() {
                // æ£€æŸ¥é€€é¿å»¶è¿Ÿ
                if (!this._canRetry('reading')) {
                    return null;
                }

                try {
                    const result = await this.oauth.api('/api/reading/history?days=365');
                    if (!result.success) {
                        this._recordFailure('reading');
                        return null;
                    }
                    
                    this._recordSuccess('reading');

                    const cloud = result.data.dailyData || {};
                    let local = this.storage.get('readingTime', null);

                    if (!local?.dailyData) {
                        local = { version: 3, dailyData: cloud, monthlyCache: {}, yearlyCache: {} };
                        this._rebuildCache(local);
                        this.storage.setNow('readingTime', local);
                        // é€šçŸ¥ UI é˜…è¯»æ•°æ®å·²æ›´æ–°ï¼ˆæ–°è®¾å¤‡é¦–æ¬¡åŒæ­¥ï¼‰
                        EventBus.emit('reading:synced', { merged: Object.keys(cloud).length, source: 'cloud' });
                        return { merged: Object.keys(cloud).length, source: 'cloud' };
                    }

                    let merged = 0;
                    Object.entries(cloud).forEach(([key, cloudDay]) => {
                        const localMinutes = local.dailyData[key]?.totalMinutes || 0;
                        const cloudMinutes = cloudDay.totalMinutes || 0;
                        if (cloudMinutes > localMinutes) {
                            local.dailyData[key] = {
                                totalMinutes: cloudMinutes,
                                lastActive: cloudDay.lastActive || Date.now(),
                                sessions: local.dailyData[key]?.sessions || []
                            };
                            merged++;
                        }
                    });

                    if (merged > 0) {
                        this._rebuildCache(local);
                        this.storage.setNow('readingTime', local);
                        // é€šçŸ¥ UI é˜…è¯»æ•°æ®å·²æ›´æ–°
                        EventBus.emit('reading:synced', { merged, source: 'merge' });
                    }
                    return { merged, source: 'merge' };
                } catch (e) {
                    console.error('[CloudSync] Download failed:', e);
                    this._recordFailure('reading');
                    return null;
                }
            }

            async upload() {
                // å‰ç½®æ£€æŸ¥ï¼šç™»å½•çŠ¶æ€ + åŒæ­¥çŠ¶æ€ + æ•°æ®æœ‰æ•ˆæ€§
                if (!this.oauth.isLoggedIn() || this._syncing) return null;
                
                const local = this.storage.get('readingTime', null);
                if (!local?.dailyData || Object.keys(local.dailyData).length === 0) {
                    return null;
                }
                
                // æ£€æŸ¥é€€é¿å»¶è¿Ÿ
                if (!this._canRetry('reading')) {
                    return null;
                }

                try {
                    this._setSyncing(true);

                    // ä¼˜åŒ–ï¼šåªä¸Šä¼ æœ€è¿‘ 90 å¤©çš„æ•°æ®ï¼Œå‡å°‘è¯·æ±‚å¤§å°
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - 90);
                    const _cutoff = cutoffDate.toDateString();
                    
                    const recentData = {};
                    let count = 0;
                    for (const [key, value] of Object.entries(local.dailyData)) {
                        // åªä¿ç•™æœ€è¿‘90å¤©çš„æ•°æ®
                        try {
                            const date = new Date(key);
                            if (date >= cutoffDate && count < 100) { // æœ€å¤š100æ¡
                                recentData[key] = value;
                                count++;
                            }
                        } catch (e) {}
                    }
                    
                    if (Object.keys(recentData).length === 0) {
                        this._setSyncing(false);
                        return null;
                    }

                    const result = await this.oauth.api('/api/reading/sync-full', {
                        method: 'POST',
                        body: { dailyData: recentData, lastSyncTime: Date.now() }
                    });

                    if (result.success) {
                        this._lastUpload = Date.now();
                        this.storage.setGlobalNow('lastCloudSync', this._lastUpload);
                        this._recordSuccess('reading');
                        return result.data;
                    }
                    this._recordFailure('reading');
                    throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                } catch (e) {
                    console.error('[CloudSync] Upload failed:', e);
                    this._recordFailure('reading');
                    return null;
                } finally {
                    this._setSyncing(false);
                }
            }

            async onPageLoad() {
                if (!this.oauth.isLoggedIn()) return;

                const now = Date.now();
                const local = this.storage.get('readingTime', null);
                const hasLocal = local?.dailyData && Object.keys(local.dailyData).length > 0;
                const isNew = !hasLocal || this._lastDownload === 0;

                // ä¸²è¡Œæ‰§è¡ŒåŒæ­¥è¯·æ±‚ï¼Œé¿å…å¹¶å‘å‹åŠ›
                // 1. ä¸‹è½½æ£€æŸ¥ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
                if (isNew || (now - this._lastDownload) > CONFIG.INTERVALS.CLOUD_DOWNLOAD) {
                    const result = await this.download();
                    if (result) {
                        this._lastDownload = now;
                        this.storage.setGlobalNow('lastDownloadSync', now);
                        if (isNew && result.merged > 0) this.tracker._yearCache = null;
                    }
                }

                // 2. ä¸Šä¼ æ£€æŸ¥ï¼ˆä»…åœ¨æ•°æ®å˜åŒ–æ—¶ï¼‰
                const hash = this._getDataHash();
                if (hash && hash !== this._lastHash && (now - this._lastUpload) > 5 * 60 * 1000) {
                    // è‡³å°‘é—´éš” 5 åˆ†é’Ÿæ‰ä¸Šä¼ 
                    const result = await this.upload();
                    if (result) {
                        this._lastHash = hash;
                        this.storage.setGlobalNow('lastUploadHash', hash);
                    }
                }

                this._startPeriodicSync();
            }

            async fullSync() {
                // å‰ç½®ç™»å½•æ£€æŸ¥
                if (!this.oauth.isLoggedIn() || this._syncing) return;
                
                try {
                    this._setSyncing(true);
                    
                    await this.download();
                    this._lastDownload = Date.now();
                    this.storage.setGlobalNow('lastDownloadSync', this._lastDownload);

                    // ä¸Šä¼ æœ¬åœ°æ•°æ®ï¼ˆåªä¸Šä¼ æœ€è¿‘ 90 å¤©ï¼Œå‡å°‘è¯·æ±‚å¤§å°ï¼‰
                    const local = this.storage.get('readingTime', null);
                    if (local?.dailyData && Object.keys(local.dailyData).length > 0) {
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - 90);
                        
                        const recentData = {};
                        let count = 0;
                        for (const [key, value] of Object.entries(local.dailyData)) {
                            try {
                                const date = new Date(key);
                                if (date >= cutoffDate && count < 100) {
                                    recentData[key] = value;
                                    count++;
                                }
                            } catch (e) {}
                        }
                        
                        if (Object.keys(recentData).length > 0) {
                            const result = await this.oauth.api('/api/reading/sync-full', {
                                method: 'POST',
                                body: { dailyData: recentData, lastSyncTime: Date.now() }
                            });
                            if (result?.success) {
                                this._lastUpload = Date.now();
                                this.storage.setGlobalNow('lastCloudSync', this._lastUpload);
                            }
                        }
                    }
                    this._lastHash = this._getDataHash();
                    this.storage.setGlobalNow('lastUploadHash', this._lastHash);

                    this._startPeriodicSync();
                } finally {
                    this._setSyncing(false);
                }
            }

            _startPeriodicSync() {
                if (this._timer) return;
                this._timer = setInterval(async () => {
                    if (!this.oauth.isLoggedIn()) return;
                    // åªæœ‰é¢†å¯¼è€…æ ‡ç­¾é¡µæ‰æ‰§è¡Œå®šæœŸåŒæ­¥ï¼Œé¿å…å¤šæ ‡ç­¾é¡µé‡å¤è¯·æ±‚
                    if (!TabLeader.isLeader()) return;
                    if (this._syncing) return; // é¿å…å¹¶å‘

                    const now = Date.now();
                    const hash = this._getDataHash();

                    // ä¸Šä¼ æ£€æŸ¥ï¼šæ•°æ®å˜åŒ– + é—´éš”è¶³å¤Ÿ + ä¸åœ¨é€€é¿æœŸ
                    if (hash !== this._lastHash && 
                        (now - this._lastUpload) > CONFIG.INTERVALS.CLOUD_UPLOAD &&
                        this._canRetry('reading')) {
                        const result = await this.upload();
                        if (result) {
                            this._lastHash = hash;
                            this.storage.setGlobalNow('lastUploadHash', hash);
                        }
                    }

                    // ä¸‹è½½æ£€æŸ¥ï¼šé—´éš”è¶³å¤Ÿ + ä¸åœ¨é€€é¿æœŸ
                    if ((now - this._lastDownload) > CONFIG.INTERVALS.CLOUD_DOWNLOAD &&
                        this._canRetry('reading')) {
                        const result = await this.download();
                        if (result) {
                            this._lastDownload = now;
                            this.storage.setGlobalNow('lastDownloadSync', now);
                        }
                    }
                }, CONFIG.INTERVALS.CLOUD_CHECK);
            }

            _rebuildCache(data) {
                data.monthlyCache = {};
                data.yearlyCache = {};
                Object.entries(data.dailyData).forEach(([key, day]) => {
                    try {
                        const d = new Date(key);
                        if (isNaN(d.getTime())) return;
                        const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        const yearKey = `${d.getFullYear()}`;
                        const minutes = day.totalMinutes || 0;
                        data.monthlyCache[monthKey] = (data.monthlyCache[monthKey] || 0) + minutes;
                        data.yearlyCache[yearKey] = (data.yearlyCache[yearKey] || 0) + minutes;
                    } catch (e) {}
                });
            }

            // ==================== å‡çº§è¦æ±‚å†å²åŒæ­¥ (trust_level >= 2) ====================

            /**
             * è®¾ç½® HistoryManager å¼•ç”¨ï¼ˆç”¨äºå‡çº§è¦æ±‚åŒæ­¥ï¼‰
             */
            setHistoryManager(historyMgr) {
                this._historyMgr = historyMgr;
                // å…¼å®¹æ—§ç‰ˆæœ¬å­˜å‚¨ key
                this._reqLastDownload = this.storage.getGlobal('lastReqDownload', 0);
                this._reqLastFullSync = this.storage.getGlobal('lastReqFullSync', 0) || 
                                        this.storage.getGlobal('lastReqSync', 0); // å…¼å®¹æ—§ key
                this._reqLastIncrementalSync = this.storage.getGlobal('lastReqIncrementalSync', 0);
            }

            /**
             * è·å–å‡çº§è¦æ±‚å†å²æ•°æ®çš„ hash
             */
            _getReqHash() {
                if (!this._historyMgr) return '';
                const history = this._historyMgr.getHistory();
                if (!history.length) return '';
                return `${history.length}:${history[history.length - 1].ts}`;
            }

            /**
             * ä¸‹è½½å‡çº§è¦æ±‚å†å²æ•°æ®
             */
            async downloadRequirements() {
                // å‰ç½®æ£€æŸ¥ï¼šç™»å½•çŠ¶æ€ + åªæœ‰é¢†å¯¼è€…æ ‡ç­¾é¡µæ‰§è¡Œ
                if (!this.oauth.isLoggedIn() || !this._historyMgr) return null;
                if (!TabLeader.isLeader()) return null;
                
                // æ£€æŸ¥é€€é¿å»¶è¿Ÿ
                if (!this._canRetry('requirements')) {
                    return null;
                }

                try {
                    // å‡å°‘è¯·æ±‚æ•°æ®é‡ï¼šä» 100 å¤©å‡å°‘åˆ° 60 å¤©
                    const result = await this.oauth.api('/api/requirements/history?days=60');
                    
                    if (!result.success) {
                        // æƒé™ä¸è¶³ï¼ˆtrust_level < 2ï¼‰æ˜¯æ­£å¸¸æƒ…å†µï¼Œç¼“å­˜ç»“æœé¿å…é‡å¤è¯·æ±‚
                        if (result.error?.code === 'INSUFFICIENT_TRUST_LEVEL') {
                            this._updateTrustLevelCache(false);
                            return null;
                        }
                        this._recordFailure('requirements');
                        return null;
                    }
                    
                    // è¯·æ±‚æˆåŠŸï¼Œè¯´æ˜æœ‰è¶³å¤Ÿæƒé™
                    this._updateTrustLevelCache(true);
                    this._recordSuccess('requirements');

                    const cloudHistory = result.data.history || [];
                    if (!cloudHistory.length) return { merged: 0, source: 'empty' };

                    let localHistory = this._historyMgr.getHistory();
                    const localByDay = new Map();
                    localHistory.forEach(h => {
                        const day = new Date(h.ts).toDateString();
                        localByDay.set(day, h);
                    });

                    let merged = 0;
                    cloudHistory.forEach(cloudRecord => {
                        const day = new Date(cloudRecord.ts).toDateString();
                        const localRecord = localByDay.get(day);

                        if (!localRecord) {
                            // æœ¬åœ°æ²¡æœ‰ï¼Œæ·»åŠ äº‘ç«¯æ•°æ®
                            localHistory.push(cloudRecord);
                            merged++;
                        } else {
                            // æœ¬åœ°æœ‰ï¼Œåˆå¹¶æ•°æ®ï¼ˆå–æ¯ä¸ªå­—æ®µçš„è¾ƒå¤§å€¼ï¼‰
                            let changed = false;
                            for (const [key, cloudValue] of Object.entries(cloudRecord.data)) {
                                if (typeof cloudValue === 'number') {
                                    const localValue = localRecord.data[key] || 0;
                                    if (cloudValue > localValue) {
                                        localRecord.data[key] = cloudValue;
                                        changed = true;
                                    }
                                }
                            }
                            if (cloudRecord.readingTime > (localRecord.readingTime || 0)) {
                                localRecord.readingTime = cloudRecord.readingTime;
                                changed = true;
                            }
                            if (changed) merged++;
                        }
                    });

                    if (merged > 0) {
                        // æŒ‰æ—¶é—´æ’åº
                        localHistory.sort((a, b) => a.ts - b.ts);
                        this.storage.set('history', localHistory);
                        this._historyMgr._history = localHistory;
                        this._historyMgr._historyTime = Date.now();
                        this._historyMgr.cache.clear();
                    }

                    return { merged, source: 'merge' };
                } catch (e) {
                    console.error('[CloudSync] Requirements download failed:', e);
                    this._recordFailure('requirements');
                    return null;
                }
            }

            /**
             * å¢é‡åŒæ­¥å½“å¤©çš„å‡çº§è¦æ±‚æ•°æ®
             * @param {Object} todayRecord - ä»Šå¤©çš„å†å²è®°å½• {ts, data, readingTime}
             */
            async syncTodayRequirements(todayRecord) {
                // å‰ç½®æ£€æŸ¥ï¼šç™»å½•çŠ¶æ€ + æ•°æ®æœ‰æ•ˆæ€§
                if (!this.oauth.isLoggedIn() || !this._historyMgr) return null;
                if (!todayRecord?.data || Object.keys(todayRecord.data).length === 0) return null;
                
                // æ£€æŸ¥é€€é¿å»¶è¿Ÿ
                if (!this._canRetry('requirements')) {
                    return null;
                }

                try {
                    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    const result = await this.oauth.api('/api/requirements/sync', {
                        method: 'POST',
                        body: { 
                            date: today,
                            requirements: todayRecord.data,
                            readingTime: todayRecord.readingTime || 0
                        }
                    });

                    if (result.success) {
                        this._reqLastIncrementalSync = Date.now();
                        this.storage.setGlobalNow('lastReqIncrementalSync', this._reqLastIncrementalSync);
                        this._updateTrustLevelCache(true);
                        this._recordSuccess('requirements');
                        return result.data;
                    }
                    
                    // æƒé™ä¸è¶³æ˜¯æ­£å¸¸æƒ…å†µï¼Œç¼“å­˜ç»“æœ
                    if (result.error?.code === 'INSUFFICIENT_TRUST_LEVEL') {
                        this._updateTrustLevelCache(false);
                        return null;
                    }
                    
                    this._recordFailure('requirements');
                    return null;
                } catch (e) {
                    console.error('[CloudSync] Requirements incremental sync failed:', e);
                    this._recordFailure('requirements');
                    return null;
                }
            }

            /**
             * å…¨é‡ä¸Šä¼ å‡çº§è¦æ±‚å†å²æ•°æ®ï¼ˆä»…åœ¨éœ€è¦æ—¶è°ƒç”¨ï¼‰
             */
            async uploadRequirementsFull() {
                // å‰ç½®æ£€æŸ¥ï¼šç™»å½•çŠ¶æ€ + æ•°æ®æœ‰æ•ˆæ€§
                if (!this.oauth.isLoggedIn() || !this._historyMgr || this._syncing) return null;
                
                const history = this._historyMgr.getHistory();
                if (!history.length) return null;
                
                // æ£€æŸ¥é€€é¿å»¶è¿Ÿ
                if (!this._canRetry('requirements')) {
                    return null;
                }

                try {
                    // é™åˆ¶ä¸Šä¼ æ•°æ®é‡ï¼Œæœ€å¤š 60 å¤©
                    const recentHistory = history.slice(-60);
                    
                    const result = await this.oauth.api('/api/requirements/sync-full', {
                        method: 'POST',
                        body: { history: recentHistory, lastSyncTime: Date.now() }
                    });

                    if (result.success) {
                        this._reqLastFullSync = Date.now();
                        this.storage.setGlobalNow('lastReqFullSync', this._reqLastFullSync);
                        this._updateTrustLevelCache(true);
                        this._recordSuccess('requirements');
                        return result.data;
                    }
                    
                    // æƒé™ä¸è¶³æ˜¯æ­£å¸¸æƒ…å†µï¼Œç¼“å­˜ç»“æœ
                    if (result.error?.code === 'INSUFFICIENT_TRUST_LEVEL') {
                        this._updateTrustLevelCache(false);
                        return null;
                    }
                    
                    this._recordFailure('requirements');
                    throw new Error(result.error?.message || 'ä¸Šä¼ å¤±è´¥');
                } catch (e) {
                    console.error('[CloudSync] Requirements full upload failed:', e);
                    this._recordFailure('requirements');
                    return null;
                }
            }

            /**
             * å…¼å®¹æ—§è°ƒç”¨ - é‡å®šå‘åˆ°å¢é‡åŒæ­¥
             * @deprecated ä½¿ç”¨ syncTodayRequirements æˆ– uploadRequirementsFull
             */
            async uploadRequirements() {
                // è·å–ä»Šå¤©çš„è®°å½•å¹¶è¿›è¡Œå¢é‡åŒæ­¥
                const history = this._historyMgr?.getHistory() || [];
                const today = new Date().toDateString();
                const todayRecord = history.find(h => new Date(h.ts).toDateString() === today);
                return this.syncTodayRequirements(todayRecord);
            }

            /**
             * é¡µé¢åŠ è½½æ—¶åŒæ­¥å‡çº§è¦æ±‚æ•°æ®
             * ä»… trust_level >= 2 çš„ç”¨æˆ·å¯ç”¨
             * 
             * ä¼˜åŒ–ç­–ç•¥ï¼ˆv3.3.1ï¼‰ï¼š
             * 1. å¢é‡åŒæ­¥ï¼šé»˜è®¤åªåŒæ­¥å½“å¤©æ•°æ®ï¼ˆ1å°æ—¶é—´éš”ï¼‰
             * 2. å…¨é‡åŒæ­¥ï¼šä»…åœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ï¼ˆ12å°æ—¶é—´éš”ï¼‰ï¼š
             *    - é¦–æ¬¡ç™»å½•ï¼ˆä»æœªä¸‹è½½è¿‡äº‘ç«¯æ•°æ®ï¼‰
             *    - æœ¬åœ°æ•°æ®å¤©æ•°ä¸äº‘ç«¯ä¸ä¸€è‡´
             */
            async syncRequirementsOnLoad() {
                // å‰ç½®æ£€æŸ¥ï¼šç™»å½•çŠ¶æ€ + åªæœ‰é¢†å¯¼è€…æ ‡ç­¾é¡µæ‰§è¡Œ
                if (!this.oauth.isLoggedIn() || !this._historyMgr) return;
                if (!TabLeader.isLeader()) return;

                const now = Date.now();
                const localHistory = this._historyMgr.getHistory();
                const INCREMENTAL_INTERVAL = CONFIG.INTERVALS.REQ_SYNC_INCREMENTAL || 3600000; // 1å°æ—¶
                const FULL_INTERVAL = CONFIG.INTERVALS.REQ_SYNC_FULL || 43200000; // 12å°æ—¶
                
                // ========== åˆ¤æ–­æ˜¯å¦éœ€è¦å…¨é‡åŒæ­¥ ==========
                const isFirstTime = this._reqLastDownload === 0;
                const needFullSync = isFirstTime || (now - (this._reqLastFullSync || 0)) > FULL_INTERVAL;
                
                if (needFullSync) {
                    // 1. å…ˆä¸‹è½½äº‘ç«¯æ•°æ®
                    const downloadResult = await this.downloadRequirements();
                    if (downloadResult) {
                        this._reqLastDownload = now;
                        this.storage.setGlobalNow('lastReqDownload', now);
                        
                        // 2. å¦‚æœæœ¬åœ°æœ‰æ•°æ®ä¸”äº‘ç«¯æ•°æ®è¾ƒå°‘ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®
                        const cloudDays = downloadResult.merged || 0;
                        const localDays = localHistory.length;
                        
                        if (localDays > 0 && (isFirstTime || localDays > cloudDays)) {
                            const uploadResult = await this.uploadRequirementsFull();
                            if (uploadResult) {
                                this._reqLastFullSync = now;
                                this.storage.setGlobalNow('lastReqFullSync', now);
                            }
                        } else {
                            this._reqLastFullSync = now;
                            this.storage.setGlobalNow('lastReqFullSync', now);
                        }
                    }
                    return;
                }
                
                // ========== å¢é‡åŒæ­¥ï¼šåªåŒæ­¥å½“å¤©æ•°æ® ==========
                const lastIncremental = this._reqLastIncrementalSync || 0;
                if ((now - lastIncremental) < INCREMENTAL_INTERVAL) {
                    return;
                }
                
                // è·å–ä»Šå¤©çš„è®°å½•
                const today = new Date().toDateString();
                const todayRecord = localHistory.find(h => new Date(h.ts).toDateString() === today);
                
                if (todayRecord) {
                    await this.syncTodayRequirements(todayRecord);
                }
            }

            /**
             * è·å–ç³»ç»Ÿå…¬å‘Šï¼ˆå…¬å¼€æ¥å£ï¼Œä¸éœ€è¦ç™»å½•ï¼‰
             * @returns {Promise<{enabled: boolean, content: string, type: string}|null>}
             */
            async getAnnouncement() {
                try {
                    const response = await fetch(`${CONFIG.LEADERBOARD_API}/api/config/announcement`);
                    if (!response.ok) return null;
                    const result = await response.json();
                    if (result.success && result.data) {
                        return result.data;
                    }
                    return null;
                } catch (e) {
                    console.error('[CloudSync] Get announcement failed:', e);
                    return null;
                }
            }

            /**
             * è·å–å®˜ç½‘URLï¼ˆå…¬å¼€æ¥å£ï¼Œä¸éœ€è¦ç™»å½•ï¼‰
             * æ¯å¤©æœ€å¤šè¯·æ±‚ä¸€æ¬¡ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜
             * @returns {Promise<string>} å®˜ç½‘URL
             */
            async getWebsiteUrl() {
                const DEFAULT_URL = 'https://ldspro.qzz.io/';
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                
                try {
                    // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²è¯·æ±‚è¿‡
                    const cachedDate = GM_getValue('ldsp_website_url_date', null);
                    const cachedUrl = GM_getValue('ldsp_website_url', null);
                    
                    if (cachedDate === today && cachedUrl) {
                        return cachedUrl;
                    }
                    
                    // ä»Šæ—¥æœªè¯·æ±‚ï¼Œå‘èµ·è¯·æ±‚
                    const response = await fetch(`${CONFIG.LEADERBOARD_API}/api/config/website-url`);
                    if (!response.ok) {
                        // è¯·æ±‚å¤±è´¥ï¼Œè¿”å›ç¼“å­˜æˆ–é»˜è®¤å€¼
                        return cachedUrl || DEFAULT_URL;
                    }
                    
                    const result = await response.json();
                    if (result.success && result.data?.url) {
                        // æ›´æ–°ç¼“å­˜
                        GM_setValue('ldsp_website_url', result.data.url);
                        GM_setValue('ldsp_website_url_date', today);
                        return result.data.url;
                    }
                    
                    return cachedUrl || DEFAULT_URL;
                } catch (e) {
                    console.error('[CloudSync] Get website URL failed:', e);
                    // å‡ºé”™æ—¶è¿”å›ç¼“å­˜æˆ–é»˜è®¤å€¼
                    const cachedUrl = GM_getValue('ldsp_website_url', null);
                    return cachedUrl || DEFAULT_URL;
                }
            }

            destroy() {
                this._timer && clearInterval(this._timer);
                this._timer = null;
            }
        }

        // ==================== æ ·å¼ç®¡ç†å™¨ ====================
        const Styles = {
            _injected: false,

            inject() {
                if (this._injected) return;
                const cfg = Screen.getConfig();
                const style = document.createElement('style');
                style.id = 'ldsp-styles';
                style.textContent = this._css(cfg);
                document.head.appendChild(style);
                this._injected = true;
            },

            _css(c) {
                return `
    #ldsp-panel{--dur-fast:120ms;--dur:200ms;--dur-slow:350ms;--ease:cubic-bezier(.22,1,.36,1);--ease-circ:cubic-bezier(.85,0,.15,1);--ease-spring:cubic-bezier(.175,.885,.32,1.275);--ease-out:cubic-bezier(0,.55,.45,1);--bg:#12131a;--bg-card:rgba(24,26,36,.92);--bg-hover:rgba(38,42,56,.95);--bg-el:rgba(32,35,48,.88);--bg-glass:rgba(255,255,255,.02);--txt:#e4e6ed;--txt-sec:#9499ad;--txt-mut:#5d6275;--accent:#6b8cef;--accent-light:#8aa4f4;--accent2:#5bb5a6;--accent2-light:#7cc9bc;--accent3:#e07a8d;--grad:linear-gradient(135deg,#5a7de0 0%,#4a6bc9 100%);--grad-accent:linear-gradient(135deg,#4a6bc9,#3d5aaa);--grad-warm:linear-gradient(135deg,#e07a8d,#c9606e);--grad-gold:linear-gradient(135deg,#d4a853 0%,#c49339 100%);--ok:#5bb5a6;--ok-light:#7cc9bc;--ok-bg:rgba(91,181,166,.12);--err:#e07a8d;--err-light:#ea9aa8;--err-bg:rgba(224,122,141,.12);--warn:#d4a853;--warn-bg:rgba(212,168,83,.12);--border:rgba(255,255,255,.06);--border2:rgba(255,255,255,.1);--border-accent:rgba(107,140,239,.3);--border-panel:rgba(0,0,0,.25);--shadow:0 1.25rem 3rem rgba(0,0,0,.4);--shadow-lg:0 1.5rem 4rem rgba(0,0,0,.5),0 0 2rem rgba(107,140,239,.06);--shadow-glow:0 0 1.25rem rgba(107,140,239,.15);--glow-accent:0 0 1rem rgba(107,140,239,.2);--scrollbar:rgba(140,150,175,.5);--scrollbar-hover:rgba(140,150,175,.7);--r-xs:0.25em;--r-sm:0.5em;--r-md:0.75em;--r-lg:1em;--r-xl:1.25em;--w:${c.width}px;--h:${c.maxHeight}px;--fs:${c.fontSize}px;--pd:${c.padding}px;--av:${c.avatarSize}px;--ring:${c.ringSize}px;--min-w:220px;--max-w:420px;--min-h:300px;display:flex;flex-direction:column;position:fixed;left:0.5vw;top:${c.top}px;right:auto;width:var(--w);max-height:var(--h);min-width:var(--min-w);max-width:var(--max-w);min-height:var(--min-h);background:var(--bg);border-radius:var(--r-lg);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Noto Sans SC',sans-serif;font-size:var(--fs);color:var(--txt);box-shadow:var(--shadow);z-index:99999;overflow:hidden;border:none;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
    #ldsp-panel,#ldsp-panel *{transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease);user-select:none;-webkit-font-smoothing:antialiased}
    #ldsp-panel{transform:translateZ(0);backface-visibility:hidden}
    #ldsp-panel input,#ldsp-panel textarea{cursor:text;user-select:text}
    #ldsp-panel [data-clickable],#ldsp-panel [data-clickable] *,#ldsp-panel button,#ldsp-panel a,#ldsp-panel .ldsp-tab,#ldsp-panel .ldsp-subtab,#ldsp-panel .ldsp-ring-lvl,#ldsp-panel .ldsp-rd-day-bar,#ldsp-panel .ldsp-year-cell:not(.empty),#ldsp-panel .ldsp-rank-item,#ldsp-panel .ldsp-ticket-item,#ldsp-panel .ldsp-ticket-type,#ldsp-panel .ldsp-ticket-tab,#ldsp-panel .ldsp-ticket-close,#ldsp-panel .ldsp-ticket-back,#ldsp-panel .ldsp-lb-refresh,#ldsp-panel .ldsp-modal-btn,#ldsp-panel .ldsp-lb-btn,#ldsp-panel .ldsp-update-bubble-close{cursor:pointer}
    #ldsp-panel.no-trans,#ldsp-panel.no-trans *{transition:none!important;animation-play-state:paused!important}
    #ldsp-panel.anim{transition:width var(--dur-slow) var(--ease),height var(--dur-slow) var(--ease),min-width var(--dur-slow) var(--ease),min-height var(--dur-slow) var(--ease),max-width var(--dur-slow) var(--ease),max-height var(--dur-slow) var(--ease),top var(--dur-slow) var(--ease),border-radius var(--dur-slow) var(--ease);transform:none!important}
    #ldsp-panel.light{--bg:rgba(250,251,254,.97);--bg-card:rgba(245,247,252,.94);--bg-hover:rgba(238,242,250,.96);--bg-el:rgba(255,255,255,.94);--bg-glass:rgba(0,0,0,.012);--txt:#1e2030;--txt-sec:#4a5068;--txt-mut:#8590a6;--accent:#5070d0;--accent-light:#6b8cef;--accent2:#4a9e8f;--accent2-light:#5bb5a6;--ok:#4a9e8f;--ok-light:#5bb5a6;--ok-bg:rgba(74,158,143,.08);--err:#d45d6e;--err-light:#e07a8d;--err-bg:rgba(212,93,110,.08);--warn:#c49339;--warn-bg:rgba(196,147,57,.08);--border:rgba(0,0,0,.08);--border2:rgba(0,0,0,.1);--border-accent:rgba(80,112,208,.2);--border-panel:rgba(0,0,0,.1);--shadow:0 1.25rem 3rem rgba(0,0,0,.08);--shadow-lg:0 1.5rem 4rem rgba(0,0,0,.12);--glow-accent:0 0 1rem rgba(80,112,208,.1);--scrollbar:var(--accent);--scrollbar-hover:var(--accent-light)}
    #ldsp-panel.collapsed{width:48px!important;height:48px!important;min-width:48px!important;min-height:48px!important;max-height:48px!important;border-radius:var(--r-md);cursor:pointer;touch-action:none;background:linear-gradient(135deg,#7a9bf5 0%,#5a7de0 50%,#5bb5a6 100%);border:none;box-shadow:var(--shadow),0 0 20px rgba(107,140,239,.35)}
    #ldsp-panel.collapsed .ldsp-hdr{padding:0;justify-content:center;align-items:center;height:100%;background:0 0;min-height:0}
    #ldsp-panel.collapsed .ldsp-hdr-info{opacity:0;visibility:hidden;pointer-events:none;position:absolute;transform:translateX(-10px)}
    #ldsp-panel .ldsp-body{transition:max-height var(--dur-slow) var(--ease),opacity var(--dur-fast) var(--ease);opacity:1;max-height:calc(var(--h) - 120px);}
    #ldsp-panel.collapsed .ldsp-body{max-height:0!important;opacity:0;pointer-events:none;overflow:hidden}
    #ldsp-panel.collapsed .ldsp-hdr-btns>button:not(.ldsp-toggle){opacity:0;visibility:hidden;pointer-events:none;transform:scale(0.8);position:absolute}
    #ldsp-panel.collapsed .ldsp-hdr-btns{justify-content:center;width:100%;height:100%;margin-left:0}
    #ldsp-panel.collapsed,#ldsp-panel.collapsed *{cursor:pointer!important}
    #ldsp-panel.collapsed .ldsp-toggle{width:100%;height:100%;font-size:18px;background:0 0;display:flex;align-items:center;justify-content:center;color:#fff;position:absolute;inset:0;margin:0;padding:0;box-sizing:border-box}
    #ldsp-panel.collapsed .ldsp-toggle .ldsp-toggle-arrow{display:none}
    #ldsp-panel.collapsed .ldsp-toggle .ldsp-toggle-logo{display:block;width:24px;height:24px;filter:brightness(1.05) drop-shadow(0 0 2px rgba(140,180,255,.2));transition:filter .2s var(--ease),transform .2s var(--ease)}
    #ldsp-panel:not(.collapsed) .ldsp-toggle .ldsp-toggle-logo{display:none}
    @media (hover:hover){#ldsp-panel.collapsed:hover{transform:scale(1.08);box-shadow:var(--shadow-lg),0 0 35px rgba(120,160,255,.6)}#ldsp-panel.collapsed:hover .ldsp-toggle-logo{filter:brightness(1.6) drop-shadow(0 0 12px rgba(160,200,255,1)) drop-shadow(0 0 20px rgba(140,180,255,.8));transform:scale(1.15) rotate(360deg);transition:filter .3s var(--ease),transform .6s var(--ease-spring)}}
    #ldsp-panel.collapsed:active .ldsp-toggle-logo{filter:brightness(2) drop-shadow(0 0 16px rgba(200,230,255,1)) drop-shadow(0 0 30px rgba(160,200,255,1));transform:scale(0.92)}
    #ldsp-panel.collapsed.no-hover-effect{transform:none!important}#ldsp-panel.collapsed.no-hover-effect .ldsp-toggle-logo{filter:brightness(1.05) drop-shadow(0 0 2px rgba(140,180,255,.2))!important;transform:none!important}
    .ldsp-hdr{display:flex;align-items:center;padding:10px 12px;background:var(--grad);cursor:move;user-select:none;touch-action:none;position:relative;gap:8px;min-height:52px;box-sizing:border-box;flex-shrink:0}
    .ldsp-hdr::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.1) 0%,transparent 100%);pointer-events:none}
    .ldsp-hdr::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 60%);opacity:0;transition:opacity .5s;pointer-events:none}
    .ldsp-hdr:hover::after{opacity:1}
    .ldsp-hdr-info{display:flex;align-items:center;gap:8px;min-width:0;flex:1 1 auto;position:relative;z-index:1;transition:opacity .25s var(--ease),visibility .25s,transform .25s var(--ease);overflow:hidden}
    .ldsp-site-wrap{display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0;position:relative}
    .ldsp-site-icon{width:26px;height:26px;border-radius:7px;border:2px solid rgba(255,255,255,.25);flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .ldsp-hdr-text{display:flex;flex-direction:column;align-items:flex-start;gap:1px;min-width:0;flex:1 1 0;overflow:hidden}
    .ldsp-title{font-weight:800;font-size:14px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;letter-spacing:-.02em;text-shadow:0 1px 2px rgba(0,0,0,.2);max-width:100%}
    .ldsp-ver{font-size:10px;color:rgba(255,255,255,.6);line-height:1.2;display:flex;align-items:center;gap:4px;overflow:hidden;max-width:100%}
    .ldsp-learn-trust{display:block;text-align:center;margin-top:8px;font-size:10px;color:var(--txt-dim);text-decoration:none;opacity:.6;transition:opacity .15s,color .15s}
    .ldsp-learn-trust:hover{opacity:1;color:var(--txt-sec)}
    .ldsp-app-name{font-size:10px;font-weight:700;white-space:nowrap;background:linear-gradient(90deg,#a8c0f8,#7a9eef,#7cc9bc,#7a9eef,#a8c0f8);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:gradient-shift 6s ease infinite;will-change:background-position}
    @keyframes gradient-shift{0%{background-position:0% center}50%{background-position:100% center}100%{background-position:0% center}}
    .ldsp-ver-num{background:rgba(255,255,255,.2);padding:2px 8px;border-radius:10px;color:#fff;font-weight:600;font-size:9px;backdrop-filter:blur(4px)}
    .ldsp-site-ver{font-size:9px;color:#fff;text-align:center;font-weight:700;background:rgba(0,0,0,.25);padding:1px 5px;border-radius:5px;letter-spacing:.02em}
    .ldsp-hdr-btns{display:flex;gap:4px;flex-shrink:0;position:relative;z-index:1;margin-left:auto}
    .ldsp-hdr-btns button{width:28px;height:28px;border:none;background:rgba(255,255,255,.12);color:#fff;border-radius:var(--r-sm);font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;outline:none;-webkit-tap-highlight-color:transparent;backdrop-filter:blur(4px);transition:transform .25s var(--ease),background .15s,box-shadow .2s,opacity .2s,visibility .2s}
    .ldsp-hdr-btns button:hover{background:rgba(255,255,255,.25);transform:translateY(-2px) scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .ldsp-hdr-btns button:active{transform:translateY(0) scale(.95)}
    .ldsp-hdr-btns button:focus{outline:none}
    .ldsp-hdr-btns button:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
    .ldsp-hdr-btns button.has-update{background:linear-gradient(135deg,var(--ok),var(--ok-light));animation:pulse-update 3s ease-in-out infinite;position:relative;box-shadow:0 0 15px rgba(16,185,129,.4)}
    .ldsp-hdr-btns button.has-update::after{content:'';position:absolute;top:-3px;right:-3px;width:10px;height:10px;background:var(--err);border-radius:50%;border:2px solid rgba(0,0,0,.2);animation:pulse-dot 2.5s ease infinite}
    @keyframes pulse-update{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    @keyframes pulse-dot{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.15);opacity:.8}}
    .ldsp-update-bubble{position:absolute;top:52px;left:50%;transform:translateX(-50%) translateY(-10px);background:var(--bg-card);border:1px solid var(--border-accent);border-radius:var(--r-md);padding:16px 18px;text-align:center;z-index:100;box-shadow:var(--shadow-lg),var(--glow-accent);opacity:0;pointer-events:none;transition:transform .3s var(--ease-spring),opacity .3s var(--ease);max-width:calc(100% - 24px);width:220px;backdrop-filter:blur(16px);will-change:transform,opacity}
    .ldsp-update-bubble::before{content:'';position:absolute;top:-7px;left:50%;transform:translateX(-50%) rotate(45deg);width:12px;height:12px;background:var(--bg-card);border-left:1px solid var(--border-accent);border-top:1px solid var(--border-accent)}
    .ldsp-update-bubble.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
    .ldsp-update-bubble-close{position:absolute;top:8px;right:10px;font-size:16px;color:var(--txt-mut);transition:color .15s,background .15s;line-height:1;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%}
    .ldsp-update-bubble-close:hover{color:var(--txt);background:var(--bg-hover)}
    .ldsp-update-bubble-icon{font-size:28px;margin-bottom:8px;animation:bounce-in .5s var(--ease-spring)}
    @keyframes bounce-in{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .ldsp-update-bubble-title{font-size:13px;font-weight:700;margin-bottom:6px;color:var(--txt);letter-spacing:-.01em}
    .ldsp-update-bubble-ver{font-size:11px;margin-bottom:12px;color:var(--txt-sec)}
    .ldsp-update-bubble-btn{background:var(--grad);color:#fff;border:none;padding:8px 20px;border-radius:20px;font-size:12px;font-weight:600;transition:transform .2s var(--ease),box-shadow .2s;box-shadow:0 4px 15px rgba(107,140,239,.3)}
    .ldsp-update-bubble-btn:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 6px 20px rgba(107,140,239,.4)}
    .ldsp-update-bubble-btn:active{transform:translateY(0) scale(.98)}
    .ldsp-update-bubble-btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important}
    .ldsp-body{background:var(--bg);position:relative;overflow:hidden;display:flex;flex-direction:column;flex:1;min-height:0}
    .ldsp-announcement{overflow:hidden;background:linear-gradient(90deg,rgba(59,130,246,.1),rgba(107,140,239,.1));border-bottom:1px solid var(--border);padding:0;height:0;opacity:0;transition:height .3s var(--ease),opacity .3s,padding .3s;flex-shrink:0}
    .ldsp-announcement.active{height:24px;min-height:24px;opacity:1;padding:0 10px}
    .ldsp-announcement.warning{background:linear-gradient(90deg,rgba(245,158,11,.15),rgba(239,68,68,.08))}
    .ldsp-announcement.success{background:linear-gradient(90deg,rgba(16,185,129,.12),rgba(34,197,94,.08))}
    .ldsp-announcement-inner{display:flex;align-items:center;height:24px;white-space:nowrap;animation:marquee var(--marquee-duration,20s) linear var(--marquee-iteration,infinite)}
    .ldsp-announcement-inner:hover{animation-play-state:paused}
    .ldsp-announcement-text{font-size:11px;font-weight:500;color:var(--txt-sec);display:flex;align-items:center;gap:6px;padding-right:50px}
    .ldsp-announcement-text::before{content:'ğŸ“¢';font-size:12px}
    .ldsp-announcement.warning .ldsp-announcement-text::before{content:'âš ï¸'}
    .ldsp-announcement.success .ldsp-announcement-text::before{content:'ğŸ‰'}
    @keyframes marquee{0%{transform:translateX(var(--start-x,100%))}100%{transform:translateX(var(--end-x,-100%))}}
    .ldsp-user{display:flex;align-items:stretch;gap:10px;padding:10px var(--pd) 24px;background:var(--bg-card);border-bottom:1px solid var(--border);position:relative;overflow:hidden;flex-shrink:0}
    .ldsp-user::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.3}
    .ldsp-user-left{display:flex;flex-direction:column;flex:1;min-width:0;gap:8px;justify-content:center}
    .ldsp-user-row{display:flex;align-items:center;gap:10px}
    .ldsp-user-actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px;position:relative}
    .ldsp-user-actions.collapsed{max-height:24px;overflow:hidden}
    .ldsp-user-actions-wrap{display:flex;flex-direction:column;gap:4px;flex:1;min-width:0}
    .ldsp-user-actions-toggle{display:none;align-items:center;justify-content:center;gap:3px;padding:4px 10px;background:transparent;border:none;border-radius:6px;font-size:9px;color:var(--txt-mut);cursor:pointer;transition:all .15s;opacity:.7}
    .ldsp-user-actions-toggle:hover{background:var(--bg-hover);color:var(--accent);opacity:1}
    .ldsp-user-actions-toggle.show{display:inline-flex}
    .ldsp-user-actions-toggle svg{width:10px;height:10px;stroke-width:2;transition:transform .2s}
    .ldsp-user-actions-toggle.expanded{color:var(--accent);opacity:1}
    .ldsp-user-actions-toggle.expanded svg{transform:rotate(180deg)}
    .ldsp-avatar{width:var(--av);height:var(--av);border-radius:12px;border:2px solid var(--accent);flex-shrink:0;background:var(--bg-el);position:relative;box-shadow:0 4px 12px rgba(107,140,239,.2);transition:transform .3s var(--ease),box-shadow .3s,border-color .2s}
    .ldsp-avatar:hover{transform:scale(1.08) rotate(-3deg);border-color:var(--accent-light);box-shadow:0 6px 20px rgba(107,140,239,.35),var(--glow-accent)}
    .ldsp-avatar-ph{width:var(--av);height:var(--av);border-radius:12px;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;flex-shrink:0;transition:transform .3s var(--ease),box-shadow .3s;position:relative;box-shadow:0 4px 12px rgba(107,140,239,.25)}
    .ldsp-avatar-ph:hover{transform:scale(1.08) rotate(-3deg);box-shadow:0 6px 20px rgba(107,140,239,.4)}
    .ldsp-avatar-wrap{position:relative;flex-shrink:0}
    .ldsp-avatar-wrap::after{content:'ğŸ”— GitHub';position:absolute;bottom:-20px;left:50%;transform:translateX(-50%) translateY(4px);background:var(--bg-el);color:var(--txt-sec);padding:3px 8px;border-radius:6px;font-size:8px;white-space:nowrap;opacity:0;pointer-events:none;transition:transform .2s var(--ease),opacity .2s;border:1px solid var(--border2);box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .ldsp-avatar-wrap:hover::after{opacity:1;transform:translateX(-50%) translateY(0)}
    .ldsp-user-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}
    .ldsp-user-display-name{font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3;letter-spacing:-.01em;background:linear-gradient(135deg,var(--txt) 0%,var(--txt-sec) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .ldsp-user-handle{font-size:12px;color:var(--txt-mut);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
    .ldsp-user.not-logged .ldsp-avatar,.ldsp-user.not-logged .ldsp-avatar-ph{border:2px dashed var(--warn);animation:pulse-border 3s ease infinite}
    @keyframes pulse-border{0%,100%{border-color:var(--warn)}50%{border-color:rgba(245,158,11,.5)}}
    @keyframes pulse-border-red{0%,100%{border-color:#ef4444}50%{border-color:rgba(239,68,68,.4)}}
    .ldsp-user.not-logged .ldsp-user-display-name{color:var(--warn);-webkit-text-fill-color:var(--warn)}
    .ldsp-login-hint{font-size:9px;color:var(--warn);margin-left:4px;animation:blink 2.5s ease-in-out infinite;background:var(--warn-bg);padding:2px 6px;border-radius:8px;font-weight:500}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.7}}
    .ldsp-user-meta{display:flex;align-items:center;gap:8px;margin-top:3px}

    .ldsp-reading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;border-radius:var(--r-md);aspect-ratio:0.92/1;min-width:100px;max-width:250px;align-self:stretch;position:relative;overflow:visible;border:1px solid var(--border);transition:background .2s,border-color .2s,box-shadow .3s;flex-shrink:0;box-sizing:border-box}
    .ldsp-reading::before{content:'';position:absolute;inset:0;border-radius:inherit;background:linear-gradient(180deg,rgba(255,255,255,.05) 0%,transparent 100%);pointer-events:none}
    .ldsp-reading-icon{font-size:20px;margin-bottom:3px;animation:bounce 3s ease-in-out infinite;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));will-change:transform}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
    .ldsp-reading-time{font-size:13px;font-weight:800;letter-spacing:-.02em}
    .ldsp-reading-label{font-size:9px;opacity:.85;margin-top:2px;font-weight:600;letter-spacing:.02em}
    .ldsp-reading{--rc:#94a3b8}
    .ldsp-reading::after{content:'æœªæ´»åŠ¨ å·²åœæ­¢è®°å½•';position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);font-size:8px;color:var(--err);white-space:nowrap;font-weight:600;letter-spacing:.02em;opacity:.8}
    .ldsp-reading.tracking{animation:reading-glow 3.5s ease-in-out infinite;will-change:box-shadow}
    .ldsp-reading.tracking::after{content:'é˜…è¯»æ—¶é—´è®°å½•ä¸­...';color:var(--rc);opacity:1}
    @keyframes reading-glow{0%,100%{box-shadow:0 0 8px color-mix(in srgb,var(--rc) 40%,transparent),0 0 16px color-mix(in srgb,var(--rc) 20%,transparent),0 0 24px color-mix(in srgb,var(--rc) 10%,transparent)}50%{box-shadow:0 0 16px color-mix(in srgb,var(--rc) 60%,transparent),0 0 32px color-mix(in srgb,var(--rc) 35%,transparent),0 0 48px color-mix(in srgb,var(--rc) 15%,transparent)}}
    .ldsp-reading-ripple{position:absolute;inset:-2px;border-radius:inherit;pointer-events:none;z-index:-1;opacity:0}
    .ldsp-reading.tracking .ldsp-reading-ripple{opacity:1}
    .ldsp-reading.tracking .ldsp-reading-ripple::before,.ldsp-reading.tracking .ldsp-reading-ripple::after{content:'';position:absolute;inset:0;border-radius:inherit;border:2px solid var(--rc);opacity:.5;animation:ripple-expand 4s ease-out infinite;will-change:transform,opacity}
    .ldsp-reading.tracking .ldsp-reading-ripple::after{animation-delay:2s}
    @keyframes ripple-expand{0%{transform:scale(1);opacity:.5;border-width:2px}100%{transform:scale(1.4);opacity:0;border-width:1px}}
    .ldsp-reading.hi{box-shadow:0 0 20px rgba(249,115,22,.2)}
    .ldsp-reading.hi .ldsp-reading-icon{animation:fire 1.2s ease-in-out infinite;will-change:transform}
    @keyframes fire{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .ldsp-reading.max{box-shadow:0 0 25px rgba(236,72,153,.25)}
    .ldsp-reading.max .ldsp-reading-icon{animation:crown 2s ease-in-out infinite;will-change:transform}
    @keyframes crown{0%,100%{transform:rotate(-5deg) scale(1)}50%{transform:rotate(5deg) scale(1.1)}}

    .ldsp-tabs{display:flex;padding:8px 10px;gap:6px;background:var(--bg);border-bottom:1px solid var(--border);flex-shrink:0;container-type:inline-size}
    .ldsp-tab{flex:1;padding:7px 8px;border:none;background:var(--bg-card);color:var(--txt-sec);border-radius:var(--r-sm);font-size:11px;font-weight:600;transition:background .15s,color .15s,border-color .15s,box-shadow .2s;border:1px solid transparent;white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:4px;min-width:0;overflow:hidden}
    .ldsp-tab .ldsp-tab-icon{flex-shrink:0;font-size:12px}
    .ldsp-tab .ldsp-tab-text{overflow:hidden;text-overflow:ellipsis;min-width:1em}
    .ldsp-tab:hover{background:var(--bg-hover);color:var(--txt);border-color:var(--border2);transform:translateY(-1px)}
    .ldsp-tab.active{background:var(--grad);color:#fff;box-shadow:0 4px 15px rgba(107,140,239,.3);border-color:transparent}
    @container (max-width:260px){.ldsp-tab{font-size:10px;padding:6px 5px;gap:2px}.ldsp-tab .ldsp-tab-icon{display:none}}
    @container (max-width:200px){.ldsp-tab{font-size:9px;padding:5px 3px}}
    @media (max-width:340px){.ldsp-tabs{padding:6px 8px;gap:4px}.ldsp-tab{font-size:10px;padding:6px 6px;gap:2px}.ldsp-tab .ldsp-tab-icon{display:none}}
    @media (max-width:280px){.ldsp-tabs{padding:5px 6px;gap:3px}.ldsp-tab{font-size:9px;padding:5px 4px}}
    .ldsp-content{flex:1 1 auto;min-height:0;max-height:calc(var(--h) - 180px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:transparent transparent}
    .ldsp-content.scrolling{scrollbar-color:var(--scrollbar) transparent}
    .ldsp-content::-webkit-scrollbar{width:6px;background:transparent}
    .ldsp-content::-webkit-scrollbar-track{background:transparent}
    .ldsp-content::-webkit-scrollbar-thumb{background:transparent;border-radius:4px;transition:background .3s}
    .ldsp-content.scrolling::-webkit-scrollbar-thumb{background:var(--scrollbar)}
    .ldsp-content::-webkit-scrollbar-button{width:0;height:0;display:none}
    .ldsp-section{display:none;padding:10px}
    .ldsp-section.active{display:block;animation:enter var(--dur) var(--ease-out)}
    @keyframes enter{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
    .ldsp-ring{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg-card);border-radius:var(--r-md);margin-bottom:10px;position:relative;overflow:hidden;border:1px solid var(--border);gap:12px}
    .ldsp-ring::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 0%,rgba(107,140,239,.08) 0%,transparent 70%);pointer-events:none}
    .ldsp-ring-stat{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:50px;gap:4px;z-index:1}
    .ldsp-ring-stat-val{font-size:18px;font-weight:800;letter-spacing:-.02em}
    .ldsp-ring-stat-val.ok{color:var(--ok)}
    .ldsp-ring-stat-val.fail{color:var(--err)}
    .ldsp-ring-stat-lbl{font-size:9px;color:var(--txt-mut);font-weight:500;white-space:nowrap}
    .ldsp-ring-center{display:flex;flex-direction:column;align-items:center;position:relative}
    .ldsp-ring-wrap{position:relative;width:var(--ring);height:var(--ring)}
    .ldsp-ring-wrap svg{transform:rotate(-90deg);width:100%;height:100%;overflow:visible}
    .ldsp-ring-bg{fill:none;stroke:var(--bg-el);stroke-width:7}
    .ldsp-ring-fill{fill:none;stroke:url(#ldsp-grad);stroke-width:7;stroke-linecap:round;transition:stroke-dashoffset 1s var(--ease)}
    .ldsp-ring-fill.anim{animation:ring 1.5s var(--ease) forwards}
    @keyframes ring{from{stroke-dashoffset:var(--circ)}to{stroke-dashoffset:var(--off)}}
    .ldsp-ring-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .ldsp-ring-val{font-size:clamp(12px,calc(var(--ring) * 0.2),18px);font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.02em}
    .ldsp-ring-val.anim{animation:val 1s var(--ease-spring) .5s forwards;opacity:0}
    @keyframes val{from{opacity:0;transform:scale(.6)}60%{transform:scale(1.1)}to{opacity:1;transform:scale(1)}}
    .ldsp-ring-lbl{font-size:9px;color:var(--txt-mut);margin-top:2px;font-weight:500}
    .ldsp-ring-lvl{font-size:12px;font-weight:700;margin-top:8px;padding:4px 14px;border-radius:12px;background-image:linear-gradient(90deg,#64748b 0%,#94a3b8 50%,#64748b 100%);background-size:200% 100%;background-position:0% 50%;color:#fff;box-shadow:0 2px 10px rgba(100,116,139,.35);letter-spacing:.03em;text-shadow:0 1px 2px rgba(0,0,0,.2);transition:transform 2s ease;transform-style:preserve-3d;animation:lvl-shimmer 6s ease-in-out infinite;will-change:background-position}
    .ldsp-ring-lvl:hover{transform:rotateY(360deg);animation-play-state:paused}
    .ldsp-ring-lvl.lv1{background-image:linear-gradient(90deg,#64748b 0%,#94a3b8 50%,#64748b 100%);box-shadow:0 2px 10px rgba(100,116,139,.35);animation-duration:4s}
    .ldsp-ring-lvl.lv2{background-image:linear-gradient(90deg,#3b82f6 0%,#60a5fa 50%,#3b82f6 100%);box-shadow:0 2px 10px rgba(59,130,246,.4);animation-duration:3.5s}
    .ldsp-ring-lvl.lv3{background-image:linear-gradient(90deg,#5070d0 0%,#8aa4f4 30%,#5bb5a6 70%,#5070d0 100%);box-shadow:0 2px 12px rgba(107,140,239,.45);animation-duration:3s}
    .ldsp-ring-lvl.lv4{background-image:linear-gradient(90deg,#f59e0b 0%,#fbbf24 25%,#f97316 50%,#ef4444 75%,#f59e0b 100%);box-shadow:0 2px 15px rgba(245,158,11,.5),0 0 20px rgba(249,115,22,.3);animation-duration:2.5s;animation-name:lvl-shimmer-gold}
    @keyframes lvl-shimmer{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    @keyframes lvl-shimmer-gold{0%,100%{background-position:0% 50%;filter:brightness(1)}50%{background-position:100% 50%;filter:brightness(1.2)}}
    .ldsp-confetti{position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none;overflow:visible;z-index:10}
    .ldsp-confetti-piece{position:absolute;font-size:12px;opacity:0;top:42%;left:50%;transform-origin:center center;text-shadow:0 1px 3px rgba(0,0,0,.3)}
    .ldsp-ring.complete.anim-done .ldsp-confetti-piece{animation:confetti-burst 2s cubic-bezier(.15,.8,.3,1) forwards}
    @keyframes confetti-burst{0%{opacity:1;transform:translate(-50%,-50%) scale(0)}5%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}25%{opacity:1;transform:translate(calc(var(--tx) * 1.2),calc(var(--ty) * 1.2)) rotate(calc(var(--rot) * 0.4)) scale(1.1)}100%{opacity:0;transform:translate(calc(var(--tx) + var(--drift)),calc(var(--ty) + 110px)) rotate(var(--rot)) scale(0.2)}}
    .ldsp-ring-tip{font-size:11px;text-align:center;margin:12px 0 16px;padding:8px 14px;border-radius:20px;font-weight:600;letter-spacing:.02em}
    .ldsp-ring-tip.ok{color:var(--ok);background:linear-gradient(135deg,var(--ok-bg),rgba(16,185,129,.05));border:1px solid rgba(16,185,129,.2)}
    .ldsp-ring-tip.progress{color:var(--accent);background:linear-gradient(135deg,rgba(107,140,239,.1),rgba(6,182,212,.05));border:1px solid rgba(107,140,239,.2)}
    .ldsp-ring-tip.max{color:var(--warn);background:linear-gradient(135deg,rgba(251,191,36,.1),rgba(249,115,22,.05));border:1px solid rgba(251,191,36,.25)}
    .ldsp-item{display:flex;align-items:center;padding:8px 10px;margin-bottom:6px;background:var(--bg-card);border-radius:var(--r-sm);border-left:3px solid var(--border2);animation:item var(--dur) var(--ease-out) backwards;transition:background .15s,border-color .15s,transform .2s var(--ease);border:1px solid var(--border);border-left-width:3px}
    .ldsp-item:nth-child(1){animation-delay:0ms}.ldsp-item:nth-child(2){animation-delay:25ms}.ldsp-item:nth-child(3){animation-delay:50ms}.ldsp-item:nth-child(4){animation-delay:75ms}.ldsp-item:nth-child(5){animation-delay:100ms}.ldsp-item:nth-child(6){animation-delay:125ms}.ldsp-item:nth-child(7){animation-delay:150ms}.ldsp-item:nth-child(8){animation-delay:175ms}.ldsp-item:nth-child(9){animation-delay:200ms}.ldsp-item:nth-child(10){animation-delay:225ms}.ldsp-item:nth-child(11){animation-delay:250ms}.ldsp-item:nth-child(12){animation-delay:275ms}
    @keyframes item{from{opacity:0;transform:translateX(-15px)}to{opacity:1;transform:none}}
    .ldsp-item:hover{background:var(--bg-hover);transform:translateX(4px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .ldsp-item.ok{border-left-color:var(--ok);background:linear-gradient(135deg,var(--ok-bg) 0%,transparent 100%)}
    .ldsp-item.fail{border-left-color:var(--err);background:linear-gradient(135deg,var(--err-bg) 0%,transparent 100%)}
    .ldsp-item-icon{font-size:12px;margin-right:8px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--bg-el)}
    .ldsp-item.ok .ldsp-item-icon{background:var(--ok-bg);color:var(--ok)}
    .ldsp-item.fail .ldsp-item-icon{background:var(--err-bg);color:var(--err)}
    .ldsp-item-name{flex:1;font-size:11px;color:var(--txt-sec);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
    .ldsp-item.ok .ldsp-item-name{color:var(--ok)}
    .ldsp-item-vals{display:flex;align-items:center;gap:3px;font-size:12px;font-weight:700;margin-left:8px}
    .ldsp-item-cur{color:var(--txt);transition:color .2s}
    .ldsp-item-cur.upd{animation:upd .7s var(--ease-spring)}
    @keyframes upd{0%{transform:scale(1)}30%{transform:scale(1.3);background:var(--accent);color:#fff;border-radius:6px;padding:0 4px}100%{transform:scale(1)}}
    .ldsp-item.ok .ldsp-item-cur{color:var(--ok)}
    .ldsp-item.fail .ldsp-item-cur{color:var(--err)}
    .ldsp-item-sep{color:var(--txt-mut);font-weight:400;opacity:.6}
    .ldsp-item-req{color:var(--txt-mut);font-weight:500}
    .ldsp-item-chg{font-size:10px;padding:2px 6px;border-radius:6px;font-weight:700;margin-left:6px;animation:pop var(--dur) var(--ease-spring)}
    @keyframes pop{from{transform:scale(0) rotate(-10deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
    .ldsp-item-chg.up{background:var(--ok-bg);color:var(--ok);box-shadow:0 2px 8px rgba(16,185,129,.2)}
    .ldsp-item-chg.down{background:var(--err-bg);color:var(--err);box-shadow:0 2px 8px rgba(244,63,94,.2)}
    .ldsp-subtabs{display:flex;align-items:center;gap:6px;padding:6px 10px;overflow-x:auto;scrollbar-width:thin;scrollbar-color:var(--scrollbar) transparent;-webkit-overflow-scrolling:touch}
    .ldsp-subtabs::-webkit-scrollbar{height:6px;background:var(--bg-el);border-radius:3px}
    .ldsp-subtabs::-webkit-scrollbar-track{background:var(--bg-el);border-radius:3px}
    .ldsp-subtabs::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:3px;transition:background .3s}
    .ldsp-subtabs::-webkit-scrollbar-thumb:hover{background:var(--accent)}
    .ldsp-subtabs::-webkit-scrollbar-button{width:0;height:0;display:none}
    .ldsp-subtab{padding:6px 12px;border:1px solid var(--border2);background:var(--bg-card);color:var(--txt-sec);border-radius:20px;font-size:10px;font-weight:600;white-space:nowrap;flex-shrink:0;transition:background .15s,color .15s,border-color .15s}
    .ldsp-subtab:hover{border-color:var(--accent);color:var(--accent);background:rgba(107,140,239,.08);transform:translateY(-1px)}
    .ldsp-subtab.active{background:var(--grad);border-color:transparent;color:#fff;box-shadow:0 4px 12px rgba(107,140,239,.25)}
    .ldsp-chart{background:var(--bg-card);border-radius:var(--r-md);padding:12px;margin-bottom:10px;border:1px solid var(--border);position:relative;overflow:hidden}
    .ldsp-chart::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.2}
    .ldsp-chart:last-child{margin-bottom:0}
    .ldsp-chart-title{font-size:12px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:6px;color:var(--txt)}
    .ldsp-chart-sub{font-size:10px;color:var(--txt-mut);font-weight:500;margin-left:auto}
    .ldsp-spark-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .ldsp-spark-row:last-child{margin-bottom:0}
    .ldsp-spark-lbl{width:55px;font-size:10px;color:var(--txt-sec);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600}
    .ldsp-spark-bars{flex:1;display:flex;align-items:flex-end;gap:3px;height:24px}
    .ldsp-spark-bar{flex:1;background:linear-gradient(180deg,var(--accent),var(--accent2));border-radius:3px 3px 0 0;min-height:3px;opacity:.35;position:relative;transition:opacity .2s,height .2s var(--ease)}
    .ldsp-spark-bar:last-child,.ldsp-spark-bar.ldsp-spark-current{opacity:1}
    .ldsp-spark-bar:hover{opacity:1;transform:scaleY(1.15);box-shadow:0 -4px 12px rgba(107,140,239,.3)}
    .ldsp-spark-bar::after{content:attr(data-v);position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(5px);font-size:9px;background:var(--bg-card);color:var(--txt);padding:4px 8px;border-radius:6px;opacity:0;visibility:hidden;white-space:nowrap;pointer-events:none;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .15s var(--ease),opacity .15s,visibility .15s;z-index:100;font-weight:500}
    .ldsp-spark-bar:hover::after{opacity:1;visibility:visible;transform:translateX(-50%) translateY(-4px)}
    .ldsp-spark-val{font-size:11px;font-weight:700;min-width:35px;text-align:right;color:var(--accent)}
    .ldsp-date-labels{display:flex;justify-content:space-between;padding:8px 0 0 60px;margin-right:40px}
    .ldsp-date-lbl{font-size:9px;color:var(--txt-mut);text-align:center;font-weight:500}
    .ldsp-changes{margin-top:8px}
    .ldsp-chg-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);transition:background .15s}
    .ldsp-chg-row:hover{background:var(--bg-glass);margin:0 -6px;padding:8px 6px;border-radius:var(--r-xs)}
    .ldsp-chg-row:last-child{border-bottom:none}
    .ldsp-chg-name{font-size:11px;color:var(--txt-sec);flex:1;font-weight:500}
    .ldsp-chg-cur{font-size:10px;color:var(--txt-mut);margin-right:8px}
    .ldsp-chg-val{font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px}
    .ldsp-chg-val.up{background:var(--ok-bg);color:var(--ok)}
    .ldsp-chg-val.down{background:var(--err-bg);color:var(--err)}
    .ldsp-chg-val.neu{background:var(--bg-el);color:var(--txt-mut)}
    .ldsp-rd-stats{border-radius:var(--r-md);padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;border:1px solid var(--border)}
    .ldsp-rd-stats-icon{font-size:32px;flex-shrink:0;filter:drop-shadow(0 2px 8px rgba(0,0,0,.2))}
    .ldsp-rd-stats-info{flex:1}
    .ldsp-rd-stats-val{font-size:18px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em}
    .ldsp-rd-stats-lbl{font-size:10px;color:var(--txt-mut);margin-top:3px;font-weight:500}
    .ldsp-rd-stats-badge{padding:5px 12px;border-radius:12px;font-size:10px;font-weight:700;transform:translateY(-1px);transition:transform .15s,box-shadow .15s}
    .ldsp-track{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg-card);border-radius:var(--r-sm);margin-bottom:10px;font-size:10px;color:var(--txt-mut);border:1px solid var(--border);font-weight:500}
    .ldsp-track-dot{width:8px;height:8px;border-radius:50%;background:var(--ok);animation:pulse 3s ease-in-out infinite;box-shadow:0 0 10px rgba(16,185,129,.4);will-change:opacity,transform}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1);box-shadow:0 0 10px rgba(16,185,129,.4)}50%{opacity:.7;transform:scale(.9);box-shadow:0 0 5px rgba(16,185,129,.2)}}
    @keyframes gradient-shift{0%{background-position:0% center}50%{background-position:100% center}100%{background-position:0% center}}
    .ldsp-rd-prog{background:var(--bg-card);border-radius:var(--r-md);padding:12px;margin-bottom:10px;border:1px solid var(--border)}
    .ldsp-rd-prog-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .ldsp-rd-prog-title{font-size:11px;color:var(--txt-sec);font-weight:600}
    .ldsp-rd-prog-val{font-size:12px;font-weight:700;color:var(--accent)}
    .ldsp-rd-prog-bar{height:8px;background:var(--bg-el);border-radius:4px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,.1)}
    .ldsp-rd-prog-fill{height:100%;border-radius:4px;transition:width .5s var(--ease);position:relative}
    .ldsp-rd-prog-fill::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,.2) 0%,transparent 100%);border-radius:4px 4px 0 0}
    .ldsp-rd-week{display:flex;justify-content:space-between;align-items:flex-end;height:55px;padding:0 4px;margin:12px 0 8px;gap:4px}
    .ldsp-rd-day{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:0}
    .ldsp-rd-day-bar{width:100%;max-width:18px;background:linear-gradient(180deg,var(--accent) 0%,var(--accent2) 100%);border-radius:4px 4px 0 0;min-height:3px;position:relative;transition:opacity .2s,height .2s var(--ease)}
    .ldsp-rd-day-bar:hover{transform:scaleX(1.2);box-shadow:0 -4px 15px rgba(91,181,166,.35)}
    .ldsp-rd-day-bar::after{content:attr(data-t);position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(5px);background:var(--bg-card);color:var(--txt);padding:4px 8px;border-radius:6px;font-size:9px;font-weight:500;white-space:nowrap;opacity:0;visibility:hidden;pointer-events:none;margin-bottom:4px;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .15s var(--ease),opacity .15s,visibility .15s;z-index:100}
    .ldsp-rd-day-bar:hover::after{opacity:1;visibility:visible;transform:translateX(-50%) translateY(-4px)}
    .ldsp-rd-day-lbl{font-size:9px;color:var(--txt-mut);line-height:1;font-weight:500}
    .ldsp-today-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px}
    .ldsp-today-stat{background:var(--bg-card);border-radius:var(--r-md);padding:12px 10px;text-align:center;border:1px solid var(--border);position:relative;overflow:hidden;transition:background .15s,border-color .15s}
    .ldsp-today-stat:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
    .ldsp-today-stat::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--grad)}
    .ldsp-today-stat-val{font-size:18px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em}
    .ldsp-today-stat-lbl{font-size:10px;color:var(--txt-mut);margin-top:4px;font-weight:500}
    .ldsp-time-info{font-size:10px;color:var(--txt-mut);text-align:center;padding:8px 10px;background:var(--bg-card);border-radius:var(--r-sm);margin-bottom:10px;border:1px solid var(--border);font-weight:500}
    .ldsp-time-info span{color:var(--accent);font-weight:700}
    .ldsp-year-heatmap{padding:10px 14px 10px 0;overflow-x:hidden;overflow-y:auto;max-height:320px;scrollbar-width:thin;scrollbar-color:transparent transparent}
    .ldsp-year-heatmap.scrolling{scrollbar-color:var(--scrollbar) transparent}
    .ldsp-year-heatmap::-webkit-scrollbar{width:6px;background:transparent}
    .ldsp-year-heatmap::-webkit-scrollbar-track{background:transparent}
    .ldsp-year-heatmap::-webkit-scrollbar-thumb{background:transparent;border-radius:4px;transition:background .3s}
    .ldsp-year-heatmap.scrolling::-webkit-scrollbar-thumb{background:var(--scrollbar)}
    .ldsp-year-heatmap::-webkit-scrollbar-button{width:0;height:0;display:none}
    .ldsp-year-wrap{display:flex;flex-direction:column;gap:3px;width:100%;padding-right:6px}
    .ldsp-year-row{display:flex;align-items:center;gap:4px;width:100%;position:relative}
    .ldsp-year-month{width:28px;font-size:8px;font-weight:600;color:var(--txt-mut);text-align:right;flex-shrink:0;line-height:1;position:absolute;left:0;top:50%;transform:translateY(-50%)}
    .ldsp-year-cells{display:grid;grid-template-columns:repeat(14,minmax(9px,1fr));gap:3px;width:100%;align-items:center;margin-left:32px}
    .ldsp-year-cell{width:100%;aspect-ratio:1;border-radius:3px;background:var(--bg-card);border:1px solid var(--border);position:relative;transition:transform .15s var(--ease),box-shadow .15s}
    .ldsp-year-cell:hover{transform:scale(1.6);box-shadow:0 4px 15px rgba(107,140,239,.4);border-color:var(--accent);z-index:10}
    .ldsp-year-cell.l0{background:rgba(107,140,239,.1);border-color:rgba(107,140,239,.18)}
    .ldsp-year-cell.l1{background:rgba(180,230,210,.35);border-color:rgba(180,230,210,.45)}
    .ldsp-year-cell.l2{background:rgba(130,215,180,.5);border-color:rgba(130,215,180,.6)}
    .ldsp-year-cell.l3{background:rgba(90,195,155,.65);border-color:rgba(90,195,155,.75)}
    .ldsp-year-cell.l4{background:linear-gradient(135deg,#6dcfa5,#50c090);border-color:#6dcfa5;box-shadow:0 0 8px rgba(109,207,165,.4)}
    .ldsp-year-cell.empty{background:0 0;border-color:transparent;cursor:default}
    .ldsp-year-cell.empty:hover{transform:none;box-shadow:none}
    .ldsp-year-tip{position:absolute;left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--txt);padding:4px 8px;border-radius:6px;font-size:9px;white-space:nowrap;opacity:0;visibility:hidden;pointer-events:none;border:1px solid var(--border);z-index:1000;line-height:1.3;box-shadow:0 4px 12px rgba(0,0,0,.15);font-weight:500;transition:opacity .15s,visibility .15s}
    .ldsp-year-cell:hover .ldsp-year-tip{opacity:1;visibility:visible}
    .ldsp-year-cell .ldsp-year-tip{bottom:100%;margin-bottom:4px}
    .ldsp-year-row:nth-child(-n+3) .ldsp-year-tip{bottom:auto;top:100%;margin-top:4px;margin-bottom:0}
    .ldsp-year-heatmap.few-rows .ldsp-year-tip{bottom:auto;top:100%;margin-top:4px;margin-bottom:0}
    .ldsp-year-heatmap.few-rows{overflow:visible;padding-bottom:40px}
    .ldsp-year-cell:nth-child(13) .ldsp-year-tip,.ldsp-year-cell:nth-child(14) .ldsp-year-tip{left:auto;right:0;transform:translateX(0)}
    .ldsp-heatmap-legend{display:flex;align-items:center;gap:6px;justify-content:center;font-size:9px;color:var(--txt-mut);padding:8px 0;font-weight:500}
    .ldsp-heatmap-legend-cell{width:10px;height:10px;border-radius:2px;border:1px solid var(--border)}
    .ldsp-empty,.ldsp-loading{text-align:center;padding:30px 16px;color:var(--txt-mut)}
    .ldsp-empty-icon{font-size:36px;margin-bottom:12px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.1))}
    .ldsp-empty-txt{font-size:12px;line-height:1.7;font-weight:500}
    .ldsp-spinner{width:28px;height:28px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px;will-change:transform}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ldsp-mini-loader{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 20px;color:var(--txt-mut)}
    .ldsp-mini-spin{width:32px;height:32px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:14px;will-change:transform}
    .ldsp-mini-txt{font-size:11px;font-weight:500}
    .ldsp-toast{position:absolute;bottom:-55px;left:50%;transform:translateX(-50%) translateY(15px);background:var(--grad);color:#fff;padding:10px 18px;border-radius:20px;font-size:12px;font-weight:600;box-shadow:0 8px 30px rgba(107,140,239,.4);opacity:0;white-space:nowrap;display:flex;align-items:center;gap:8px;z-index:100000;transition:transform .3s var(--ease-spring),opacity .3s;will-change:transform,opacity}
    .ldsp-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .ldsp-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:100001;opacity:0;transition:opacity .3s var(--ease)}
    .ldsp-modal-overlay.show{opacity:1}
    .ldsp-modal{background:var(--bg-card);border-radius:var(--r-xl);padding:24px;max-width:340px;width:90%;box-shadow:var(--shadow-lg),var(--glow-accent);transform:scale(.9) translateY(30px);transition:transform .35s var(--ease-spring);border:1px solid var(--border);backdrop-filter:blur(20px)}
    .ldsp-modal-overlay.show .ldsp-modal{transform:scale(1) translateY(0)}
    .ldsp-modal-hdr{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .ldsp-modal-icon{font-size:28px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.2))}
    .ldsp-modal-title{font-size:17px;font-weight:700;letter-spacing:-.02em}
    .ldsp-modal-body{font-size:13px;color:var(--txt-sec);line-height:1.7;margin-bottom:20px}
    .ldsp-modal-body p{margin:0 0 10px}
    .ldsp-modal-body ul{margin:10px 0;padding-left:0;list-style:none}
    .ldsp-modal-body li{margin:6px 0;padding-left:24px;position:relative}
    .ldsp-modal-body li::before{content:'';position:absolute;left:0;top:6px;width:6px;height:6px;background:var(--accent);border-radius:50%}
    .ldsp-modal-body strong{color:var(--accent);font-weight:600}
    .ldsp-modal-footer{display:flex;gap:12px}
    .ldsp-modal-btn{flex:1;padding:12px 18px;border:none;border-radius:var(--r-md);font-size:13px;font-weight:600;transition:background .15s,transform .2s var(--ease)}
    .ldsp-modal-btn.primary{background:var(--grad);color:#fff;box-shadow:0 4px 15px rgba(107,140,239,.3)}
    .ldsp-modal-btn.primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(107,140,239,.4)}
    .ldsp-modal-btn.primary:active{transform:translateY(0)}
    .ldsp-modal-btn.secondary{background:var(--bg-el);color:var(--txt-sec);border:1px solid var(--border2)}
    .ldsp-modal-btn.secondary:hover{background:var(--bg-hover);border-color:var(--border-accent)}
    .ldsp-modal-btn.danger{background:var(--grad-warm);color:#fff;box-shadow:0 4px 15px rgba(224,122,141,.3)}
    .ldsp-modal-btn.danger:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(224,122,141,.4)}
    .ldsp-modal-btn.danger:active{transform:translateY(0)}
    .ldsp-modal-note{margin-top:14px;font-size:11px;color:var(--txt-mut);text-align:center;font-weight:500}
    .ldsp-confirm-overlay{position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;box-sizing:border-box;background:rgba(18,19,26,.92);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;z-index:20;opacity:0;pointer-events:none;transition:opacity .3s var(--ease);border-radius:inherit;margin:0;padding:0 20px}
    .ldsp-confirm-overlay.show{opacity:1;pointer-events:auto}
    .ldsp-confirm-box{background:linear-gradient(145deg,var(--bg-card),var(--bg));border-radius:var(--r-lg);padding:24px 20px;width:100%;max-width:260px;box-shadow:var(--shadow-lg),0 0 40px rgba(224,122,141,.1);transform:scale(.92) translateY(20px);transition:transform .35s var(--ease-spring);border:1px solid var(--border2);position:relative;overflow:hidden;margin:0 auto}
    .ldsp-confirm-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--grad-warm);opacity:.8}
    .ldsp-confirm-overlay.show .ldsp-confirm-box{transform:scale(1) translateY(0)}
    .ldsp-confirm-icon{text-align:center;font-size:40px;margin-bottom:14px;filter:drop-shadow(0 4px 8px rgba(224,122,141,.3));animation:confirm-icon-bounce .5s var(--ease-spring) .1s both}
    @keyframes confirm-icon-bounce{0%{transform:scale(0) rotate(-20deg);opacity:0}60%{transform:scale(1.15) rotate(5deg)}100%{transform:scale(1) rotate(0);opacity:1}}
    .ldsp-confirm-title{text-align:center;font-size:16px;font-weight:700;margin-bottom:10px;color:#ef4444;letter-spacing:-.02em}
    .ldsp-confirm-msg{text-align:center;font-size:12px;color:var(--txt-sec);line-height:1.7;margin-bottom:20px;padding:0 4px}
    .ldsp-confirm-btns{display:flex;gap:10px}
    .ldsp-confirm-btn{flex:1;padding:11px 14px;border:none;border-radius:var(--r-sm);font-size:12px;font-weight:600;transition:background .15s,transform .15s,box-shadow .15s,border-color .15s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    .ldsp-confirm-btn.cancel{background:var(--bg-el);color:var(--txt-sec);border:1px solid var(--border2)}
    @media (hover:hover){.ldsp-confirm-btn.cancel:hover{background:var(--bg-hover);border-color:var(--border-accent)}}
    .ldsp-confirm-btn.confirm{background:var(--grad-warm);color:#fff;box-shadow:0 4px 15px rgba(224,122,141,.3);border:none}
    @media (hover:hover){.ldsp-confirm-btn.confirm:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(224,122,141,.4)}}
    .ldsp-confirm-btn:active{transform:scale(.96)}
    @media (max-width:480px){.ldsp-confirm-box{padding:20px 16px;max-width:240px}.ldsp-confirm-icon{font-size:36px;margin-bottom:12px}.ldsp-confirm-title{font-size:14px}.ldsp-confirm-msg{font-size:11px;margin-bottom:16px}.ldsp-confirm-btn{padding:10px 12px;font-size:11px}.ldsp-update-bubble{width:200px;padding:14px 16px}.ldsp-update-bubble-icon{font-size:24px;margin-bottom:6px}.ldsp-update-bubble-title{font-size:12px;margin-bottom:5px}.ldsp-update-bubble-ver{font-size:10px;margin-bottom:10px}.ldsp-update-bubble-btn{padding:7px 16px;font-size:11px}}
    @media (max-width:380px){.ldsp-confirm-overlay{padding:0 10px}.ldsp-confirm-box{padding:18px 14px;max-width:230px}.ldsp-confirm-icon{font-size:34px;margin-bottom:10px}.ldsp-confirm-title{font-size:13px}.ldsp-confirm-msg{font-size:10px;margin-bottom:14px}.ldsp-confirm-btn{padding:9px 10px;font-size:10px}}
    @media (max-width:320px){.ldsp-confirm-overlay{padding:0 8px}.ldsp-confirm-box{padding:14px 12px;max-width:200px}.ldsp-confirm-icon{font-size:28px;margin-bottom:8px}.ldsp-confirm-title{font-size:12px}.ldsp-confirm-msg{font-size:9px;margin-bottom:12px;line-height:1.5}.ldsp-confirm-btns{gap:6px}.ldsp-confirm-btn{padding:8px 8px;font-size:9px;border-radius:6px}.ldsp-update-bubble{width:180px;padding:12px 14px}.ldsp-update-bubble-icon{font-size:20px;margin-bottom:5px}.ldsp-update-bubble-title{font-size:11px}.ldsp-update-bubble-ver{font-size:9px;margin-bottom:8px}.ldsp-update-bubble-btn{padding:6px 12px;font-size:10px}}
    .ldsp-no-chg{text-align:center;padding:18px;color:var(--txt-mut);font-size:11px;font-weight:500}
    .ldsp-lb-hdr{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg-card);border-radius:var(--r-md);margin-bottom:10px;border:1px solid var(--border)}
    .ldsp-lb-status{display:flex;align-items:center;gap:10px}
    .ldsp-lb-dot{width:10px;height:10px;border-radius:50%;background:var(--txt-mut);transition:background .2s}
    .ldsp-lb-dot.joined{background:var(--ok);box-shadow:0 0 10px rgba(16,185,129,.4)}
    .ldsp-lb-btn{padding:8px 14px;border:none;border-radius:20px;font-size:11px;font-weight:600;transition:background .15s,color .15s,transform .2s var(--ease)}
    .ldsp-lb-btn.primary{background:var(--grad);color:#fff;box-shadow:0 4px 12px rgba(107,140,239,.25)}
    .ldsp-lb-btn.primary:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(107,140,239,.4)}
    .ldsp-lb-btn.primary:active{transform:translateY(0)}
    .ldsp-lb-btn.secondary{background:var(--bg-el);color:var(--txt-sec);border:1px solid var(--border2)}
    .ldsp-lb-btn.secondary:hover{background:var(--bg-hover);border-color:var(--border-accent)}
    .ldsp-lb-btn.danger{background:var(--err-bg);color:var(--err);border:1px solid rgba(244,63,94,.3)}
    .ldsp-lb-btn.danger:hover{background:var(--err);color:#fff;box-shadow:0 4px 12px rgba(244,63,94,.3)}
    .ldsp-lb-btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
    .ldsp-rank-list{display:flex;flex-direction:column;gap:6px}
    .ldsp-rank-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-card);border-radius:var(--r-md);animation:item var(--dur) var(--ease-out) backwards;border:1px solid var(--border);transition:background .15s,border-color .15s,transform .2s var(--ease)}
    .ldsp-rank-item:hover{background:var(--bg-hover);transform:translateX(4px);box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .ldsp-rank-item.t1{background:linear-gradient(135deg,rgba(255,215,0,.12) 0%,rgba(255,185,0,.05) 100%);border:1px solid rgba(255,215,0,.35);box-shadow:0 4px 20px rgba(255,215,0,.15)}
    .ldsp-rank-item.t2{background:linear-gradient(135deg,rgba(192,192,192,.12) 0%,rgba(160,160,160,.05) 100%);border:1px solid rgba(192,192,192,.35)}
    .ldsp-rank-item.t3{background:linear-gradient(135deg,rgba(205,127,50,.12) 0%,rgba(181,101,29,.05) 100%);border:1px solid rgba(205,127,50,.35)}
    .ldsp-rank-item.me{border-left:3px solid var(--accent);box-shadow:0 0 15px rgba(107,140,239,.1)}
    .ldsp-rank-num{width:28px;height:28px;border-radius:10px;background:var(--bg-el);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--txt-sec);flex-shrink:0}
    .ldsp-rank-item.t1 .ldsp-rank-num{background:linear-gradient(135deg,#ffd700 0%,#ffb700 100%);color:#1a1a1a;font-size:14px;box-shadow:0 4px 12px rgba(255,215,0,.4)}
    .ldsp-rank-item.t2 .ldsp-rank-num{background:linear-gradient(135deg,#e0e0e0 0%,#b0b0b0 100%);color:#1a1a1a;box-shadow:0 4px 12px rgba(192,192,192,.4)}
    .ldsp-rank-item.t3 .ldsp-rank-num{background:linear-gradient(135deg,#cd7f32 0%,#b5651d 100%);color:#fff;box-shadow:0 4px 12px rgba(205,127,50,.4)}
    .ldsp-rank-avatar{width:32px;height:32px;border-radius:10px;border:2px solid var(--border2);flex-shrink:0;background:var(--bg-el);transition:transform .2s var(--ease),border-color .15s}
    .ldsp-rank-item:hover .ldsp-rank-avatar{transform:scale(1.05)}
    .ldsp-rank-item.t1 .ldsp-rank-avatar{border-color:#ffd700;box-shadow:0 0 12px rgba(255,215,0,.3)}
    .ldsp-rank-item.t2 .ldsp-rank-avatar{border-color:#c0c0c0}
    .ldsp-rank-item.t3 .ldsp-rank-avatar{border-color:#cd7f32}
    .ldsp-rank-info{flex:1;min-width:0;display:flex;flex-wrap:wrap;align-items:baseline;gap:3px 5px}
    .ldsp-rank-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ldsp-rank-display-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:85px}
    .ldsp-rank-username{font-size:10px;color:var(--txt-mut);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
    .ldsp-rank-name-only{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ldsp-rank-me-tag{font-size:10px;color:var(--accent);margin-left:3px;font-weight:600;background:rgba(107,140,239,.1);padding:1px 6px;border-radius:8px}
    .ldsp-rank-time{font-size:13px;font-weight:800;color:var(--accent);white-space:nowrap;letter-spacing:-.02em}
    .ldsp-rank-item.t1 .ldsp-rank-time{color:#ffc107;text-shadow:0 0 10px rgba(255,193,7,.3)}
    .ldsp-rank-item.t2 .ldsp-rank-time{color:#b8b8b8}
    .ldsp-rank-item.t3 .ldsp-rank-time{color:#cd7f32}
    .ldsp-lb-empty{text-align:center;padding:40px 20px;color:var(--txt-mut)}
    .ldsp-lb-empty-icon{font-size:48px;margin-bottom:14px;filter:drop-shadow(0 2px 10px rgba(0,0,0,.1))}
    .ldsp-lb-empty-txt{font-size:12px;line-height:1.7;font-weight:500}
    .ldsp-lb-login{text-align:center;padding:40px 20px}
    .ldsp-lb-login-icon{font-size:56px;margin-bottom:16px;filter:drop-shadow(0 4px 15px rgba(0,0,0,.15))}
    .ldsp-lb-login-title{font-size:15px;font-weight:700;margin-bottom:8px;letter-spacing:-.01em}
    .ldsp-lb-login-desc{font-size:11px;color:var(--txt-mut);margin-bottom:20px;line-height:1.7;font-weight:500}
    .ldsp-lb-period{font-size:10px;color:var(--txt-mut);text-align:center;padding:8px 10px;background:var(--bg-card);border-radius:var(--r-sm);margin-bottom:10px;display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;border:1px solid var(--border);font-weight:500}
    .ldsp-lb-period span{color:var(--accent);font-weight:700}
    .ldsp-lb-period .ldsp-update-rule{font-size:9px;opacity:.8}
    /* æ’è¡Œæ¦œå“åº”å¼ */
    @media (max-width:380px){.ldsp-lb-hdr{padding:10px}.ldsp-lb-btn{padding:6px 10px;font-size:10px}.ldsp-lb-period{padding:6px 8px;font-size:9px;gap:6px}.ldsp-lb-empty{padding:30px 15px}.ldsp-lb-empty-icon{font-size:40px;margin-bottom:10px}.ldsp-lb-empty-txt{font-size:11px}.ldsp-lb-login{padding:30px 15px}.ldsp-lb-login-icon{font-size:48px;margin-bottom:12px}.ldsp-lb-login-title{font-size:13px}.ldsp-lb-login-desc{font-size:10px;margin-bottom:16px}.ldsp-rank-item{padding:10px;gap:8px}.ldsp-rank-num{width:24px;height:24px;font-size:10px}.ldsp-rank-avatar{width:34px;height:34px}.ldsp-rank-name{font-size:12px}.ldsp-rank-time{font-size:12px}.ldsp-my-rank{padding:10px}.ldsp-my-rank-lbl{font-size:10px}.ldsp-my-rank-val{font-size:18px}}
    @media (max-width:320px){.ldsp-lb-hdr{padding:8px}.ldsp-lb-status{gap:6px}.ldsp-lb-dot{width:8px;height:8px}.ldsp-lb-btn{padding:5px 8px;font-size:9px}.ldsp-lb-period{padding:5px 6px;font-size:8px;gap:4px}.ldsp-lb-empty{padding:24px 12px}.ldsp-lb-empty-icon{font-size:32px}.ldsp-lb-empty-txt{font-size:10px}.ldsp-lb-login{padding:24px 12px}.ldsp-lb-login-icon{font-size:40px;margin-bottom:10px}.ldsp-lb-login-title{font-size:12px}.ldsp-lb-login-desc{font-size:9px;margin-bottom:12px}.ldsp-rank-list{gap:4px}.ldsp-rank-item{padding:8px;gap:6px}.ldsp-rank-num{width:20px;height:20px;font-size:9px}.ldsp-rank-avatar{width:28px;height:28px}.ldsp-rank-name{font-size:10px}.ldsp-rank-time{font-size:10px}.ldsp-my-rank{padding:8px}.ldsp-my-rank-lbl{font-size:9px}.ldsp-my-rank-val{font-size:16px}}
    .ldsp-lb-refresh{background:var(--bg-el);border:none;font-size:11px;padding:4px 8px;border-radius:6px;transition:background .15s,opacity .2s;opacity:.8}
    .ldsp-lb-refresh:hover{opacity:1;background:var(--bg-hover);transform:scale(1.05)}
    .ldsp-lb-refresh:active{transform:scale(.95)}
    .ldsp-lb-refresh.spinning{animation:ldsp-spin 1s linear infinite}
    .ldsp-lb-refresh:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
    @keyframes ldsp-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .ldsp-my-rank{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--grad);border-radius:var(--r-md);margin-bottom:10px;color:#fff;position:relative;overflow:hidden;box-shadow:0 8px 25px rgba(107,140,239,.3)}
    .ldsp-my-rank::before{content:'';position:absolute;top:-50%;right:-20%;width:100px;height:100px;background:radial-gradient(circle,rgba(255,255,255,.15) 0%,transparent 70%);pointer-events:none}
    .ldsp-my-rank.not-in-top{background:linear-gradient(135deg,#52525b 0%,#3f3f46 100%);box-shadow:0 8px 25px rgba(0,0,0,.2)}
    .ldsp-my-rank-lbl{font-size:11px;opacity:.9;font-weight:500}
    .ldsp-my-rank-val{font-size:20px;font-weight:800;letter-spacing:-.02em;text-shadow:0 2px 8px rgba(0,0,0,.2)}
    .ldsp-my-rank-time{font-size:12px;opacity:.95;font-weight:600}
    .ldsp-not-in-top-hint{font-size:10px;opacity:.7;margin-left:5px}
    .ldsp-join-prompt{background:var(--bg-card);border-radius:var(--r-md);padding:24px 20px;text-align:center;margin-bottom:10px;border:1px solid var(--border);position:relative;overflow:hidden}
    .ldsp-join-prompt::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--grad)}
    .ldsp-join-prompt-icon{font-size:44px;margin-bottom:12px;filter:drop-shadow(0 2px 10px rgba(0,0,0,.15))}
    .ldsp-join-prompt-title{font-size:14px;font-weight:700;margin-bottom:6px;letter-spacing:-.01em}
    .ldsp-join-prompt-desc{font-size:11px;color:var(--txt-mut);line-height:1.7;margin-bottom:16px;font-weight:500}
    .ldsp-privacy-note{font-size:9px;color:var(--txt-mut);margin-top:12px;display:flex;align-items:center;justify-content:center;gap:5px;font-weight:500}
    /* é¢æ¿æ‰‹åŠ¨è°ƒæ•´å¤§å° - ä»…æ¡Œé¢ç«¯ */
    @media (hover:hover) and (pointer:fine){
    #ldsp-panel:not(.collapsed){resize:none}
    .ldsp-resize-handle{position:absolute;z-index:15;opacity:0;transition:opacity .2s}
    #ldsp-panel:hover .ldsp-resize-handle{opacity:1}
    .ldsp-resize-e{right:0;top:1em;bottom:1em;width:6px;cursor:e-resize}
    .ldsp-resize-s{bottom:0;left:1em;right:1em;height:6px;cursor:s-resize}
    .ldsp-resize-se{right:0;bottom:0;width:14px;height:14px;cursor:se-resize}
    .ldsp-resize-se::before{content:'';position:absolute;right:3px;bottom:3px;width:8px;height:8px;border-right:2px solid var(--txt-mut);border-bottom:2px solid var(--txt-mut);opacity:.5;transition:opacity .2s}
    #ldsp-panel:hover .ldsp-resize-se::before{opacity:.8}
    .ldsp-resize-handle:hover::before{opacity:1}
    #ldsp-panel.resizing .ldsp-resize-handle{opacity:1}
    #ldsp-panel.resizing,#ldsp-panel.resizing *{transition:none!important;user-select:none!important}
    }
    @media (prefers-reduced-motion:reduce){#ldsp-panel,#ldsp-panel *{animation:none!important;transition:none!important}#ldsp-panel .ldsp-spinner,#ldsp-panel .ldsp-mini-spin,#ldsp-panel .ldsp-lb-refresh.spinning{animation:spin 1.5s linear infinite!important}}
    /* ========== å“åº”å¼å¸ƒå±€ç³»ç»Ÿ ========== */
    /* å†…å®¹åŒºæœ€å¤§é«˜åº¦ */
    .ldsp-content{max-height:calc(var(--h) - 160px)}
    /* --- é«˜åº¦å“åº”å¼ --- */
    /* çŸ®å±ä¼˜åŒ– (é«˜åº¦<700px): å‡å°é—´è· */
    @media (max-height:700px){.ldsp-user{padding:8px var(--pd) 20px}.ldsp-reading{padding:6px}.ldsp-reading-icon{font-size:18px}.ldsp-reading-time{font-size:12px}.ldsp-reading::after{font-size:7px;bottom:-12px}.ldsp-ring{padding:10px 12px}.ldsp-ring-stat-val{font-size:16px}.ldsp-ring-stat-lbl{font-size:8px}}
    /* çŸ®å±ä¼˜åŒ– (é«˜åº¦<600px): è¿›ä¸€æ­¥å‹ç¼© */
    @media (max-height:600px){.ldsp-hdr{padding:8px 10px;min-height:44px;gap:6px}.ldsp-user{padding:6px var(--pd) 16px;gap:8px}.ldsp-user-actions{gap:4px;margin-top:0}.ldsp-action-btn{padding:4px 6px;font-size:9px}.ldsp-tabs{padding:6px 8px}.ldsp-section{padding:8px}.ldsp-reading{padding:5px}.ldsp-reading-icon{font-size:16px;margin-bottom:2px}.ldsp-reading-time{font-size:11px}.ldsp-reading-label{font-size:8px}.ldsp-reading::after{font-size:6px;bottom:-10px}}
    /* çŸ®å±ä¼˜åŒ– (é«˜åº¦<500px): éšè—æ¬¡è¦å…ƒç´  */
    @media (max-height:500px){.ldsp-user{padding:5px var(--pd) 14px}.ldsp-reading{padding:4px}.ldsp-reading-icon{font-size:14px;margin-bottom:1px}.ldsp-reading-time{font-size:10px}.ldsp-reading-label{font-size:7px}.ldsp-tabs{padding:5px 6px;gap:4px}.ldsp-tab{padding:5px 6px;font-size:9px}.ldsp-section{padding:5px}.ldsp-ring{padding:8px 10px;margin-bottom:8px}.ldsp-ring-wrap{--ring:55px}.ldsp-announcement.active{height:20px;min-height:20px}.ldsp-announcement-text{font-size:9px}}
    /* æçŸ®å± (é«˜åº¦<420px): éšè—æ“ä½œæŒ‰é’® */
    @media (max-height:420px){.ldsp-user-actions{display:none}.ldsp-reading::after{display:none}}
    /* --- å®½åº¦å“åº”å¼ --- */
    /* çª„å±ä¼˜åŒ– (å®½åº¦<380px): æ‰‹æœºç«–å± */
    @media (max-width:380px){#ldsp-panel{--w:260px}#ldsp-panel.collapsed{width:42px!important;height:42px!important;min-width:42px!important;min-height:42px!important;max-height:42px!important}#ldsp-panel.collapsed .ldsp-toggle-logo{width:20px;height:20px}.ldsp-hdr{padding:8px 10px;gap:6px;min-height:46px}.ldsp-hdr-info{gap:5px}.ldsp-site-icon{width:22px;height:22px}.ldsp-site-ver{font-size:7px}.ldsp-title{font-size:11px}.ldsp-app-name{font-size:9px}.ldsp-hdr-btns{gap:3px}.ldsp-hdr-btns button{width:24px;height:24px;font-size:10px}.ldsp-user{gap:8px}.ldsp-avatar,.ldsp-avatar-ph{width:40px;height:40px;border-radius:10px}.ldsp-user-display-name{font-size:14px}.ldsp-user-handle{font-size:10px}.ldsp-reading{padding:5px;max-width:85px}.ldsp-reading-icon{font-size:16px}.ldsp-reading-time{font-size:11px}.ldsp-reading-label{font-size:8px}.ldsp-user-actions{gap:4px}.ldsp-action-btn{font-size:9px;padding:4px 6px;gap:3px}.ldsp-action-icon{font-size:11px}.ldsp-tabs{padding:6px 8px;gap:4px}.ldsp-tab{font-size:9px;padding:5px 6px}.ldsp-section{padding:8px}.ldsp-ring{padding:10px;gap:8px}.ldsp-ring-stat-val{font-size:14px}.ldsp-ring-stat-lbl{font-size:8px}}
    .ldsp-action-btn{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:linear-gradient(135deg,rgba(107,140,239,.08),rgba(90,125,224,.12));border:1px solid rgba(107,140,239,.2);border-radius:8px;font-size:10px;color:var(--accent);transition:background .15s,border-color .15s,transform .15s,box-shadow .15s;font-weight:600;white-space:nowrap;flex:1 1 auto;min-width:fit-content;justify-content:center;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    @media (hover:hover){.ldsp-action-btn:hover{background:linear-gradient(135deg,rgba(107,140,239,.15),rgba(90,125,224,.2));border-color:var(--accent);box-shadow:0 4px 12px rgba(107,140,239,.18)}}
    .ldsp-action-btn:active{background:linear-gradient(135deg,rgba(107,140,239,.18),rgba(90,125,224,.24));transform:scale(.97)}
    .ldsp-action-btn:only-child{flex:0 1 auto}
    .ldsp-action-btn .ldsp-action-icon{flex-shrink:0}
    .ldsp-action-btn .ldsp-action-text{overflow:hidden;text-overflow:ellipsis}
    /* æçª„å±ä¼˜åŒ– (å®½åº¦<320px): å°å±æ‰‹æœº */
    @media (max-width:320px){#ldsp-panel{--w:230px;--min-w:200px}#ldsp-panel.collapsed{width:36px!important;height:36px!important;min-width:36px!important;min-height:36px!important;max-height:36px!important;border-radius:8px}#ldsp-panel.collapsed .ldsp-toggle-logo{width:18px;height:18px}.ldsp-hdr{padding:6px 8px;gap:4px;min-height:38px}.ldsp-hdr-info{gap:4px}.ldsp-site-icon{width:18px;height:18px;border-radius:5px;border-width:1px}.ldsp-site-ver{display:none}.ldsp-title{font-size:10px}.ldsp-app-name{display:none}.ldsp-ver-num{font-size:8px;padding:1px 5px}.ldsp-hdr-btns{gap:2px}.ldsp-hdr-btns button{width:22px;height:22px;font-size:9px;border-radius:5px}.ldsp-user{padding:6px 8px 14px;gap:6px}.ldsp-avatar,.ldsp-avatar-ph{width:36px;height:36px;border-radius:8px;font-size:14px}.ldsp-user-display-name{font-size:13px}.ldsp-user-handle{font-size:9px}.ldsp-reading{padding:4px;max-width:70px}.ldsp-reading-icon{font-size:13px;margin-bottom:1px}.ldsp-reading-time{font-size:9px}.ldsp-reading-label{font-size:6px}.ldsp-user-actions{flex-direction:column;gap:3px}.ldsp-action-btn{flex:1 1 100%;min-width:0;font-size:8px;padding:4px 5px;gap:2px}.ldsp-action-icon{font-size:10px}.ldsp-tabs{padding:4px 6px;gap:3px}.ldsp-tab{font-size:8px;padding:4px 5px;gap:2px}.ldsp-tab .ldsp-tab-icon{display:none}.ldsp-section{padding:6px}.ldsp-ring{padding:8px;gap:6px;margin-bottom:6px}.ldsp-ring-stat{min-width:40px;gap:2px}.ldsp-ring-stat-val{font-size:13px}.ldsp-ring-stat-lbl{font-size:7px}.ldsp-ring-wrap{--ring:50px}}
    /* å°å±æ‰‹æœºç»„åˆä¼˜åŒ– (å®½åº¦<380px ä¸” é«˜åº¦<700px) */
    @media (max-width:380px) and (max-height:700px){.ldsp-user{padding:5px var(--pd) 12px;gap:6px}.ldsp-avatar,.ldsp-avatar-ph{width:36px;height:36px}.ldsp-reading{padding:4px;max-width:65px}.ldsp-reading-icon{font-size:13px;margin-bottom:1px}.ldsp-reading-time{font-size:9px}.ldsp-reading-label{font-size:6px}.ldsp-reading::after{font-size:6px;bottom:-9px}.ldsp-user-actions{gap:3px}.ldsp-action-btn{padding:3px 5px;font-size:8px}.ldsp-ring{padding:8px;margin-bottom:6px}.ldsp-ring-stat-val{font-size:12px}.ldsp-ring-wrap{--ring:48px}}
    /* è¶…å°å±æ‰‹æœº (å®½åº¦<280px) */
    @media (max-width:280px){#ldsp-panel{--w:210px}.ldsp-hdr{padding:5px 6px;min-height:34px}.ldsp-site-icon{width:16px;height:16px}.ldsp-title{font-size:9px}.ldsp-hdr-btns button{width:20px;height:20px;font-size:8px}.ldsp-user{padding:4px 6px 10px;gap:5px}.ldsp-avatar,.ldsp-avatar-ph{width:32px;height:32px;border-radius:6px}.ldsp-user-display-name{font-size:12px}.ldsp-user-handle{font-size:8px}.ldsp-reading{padding:3px;max-width:55px}.ldsp-reading-icon{font-size:11px;margin-bottom:0}.ldsp-reading-time{font-size:8px}.ldsp-reading-label{font-size:5px;margin-top:1px}.ldsp-reading::after{display:none}.ldsp-action-btn{padding:3px 4px;font-size:7px;gap:2px}.ldsp-tabs{padding:3px 5px;gap:2px}.ldsp-tab{font-size:7px;padding:3px 4px}.ldsp-section{padding:4px}.ldsp-ring{padding:6px;gap:4px}.ldsp-ring-stat-val{font-size:11px}.ldsp-ring-stat-lbl{font-size:6px}.ldsp-ring-wrap{--ring:42px}}
    /* ========== å“åº”å¼å¸ƒå±€ç³»ç»Ÿç»“æŸ ========== */
    .ldsp-logout-btn,.ldsp-ticket-btn,.ldsp-melon-btn,.ldsp-ldc-btn{padding:5px 8px}
    .ldsp-logout-btn{background:linear-gradient(135deg,rgba(239,68,68,.06),rgba(220,38,38,.08));border-color:rgba(239,68,68,.15);color:rgba(239,68,68,.7)}
    .ldsp-logout-btn:hover{background:linear-gradient(135deg,rgba(239,68,68,.12),rgba(220,38,38,.16));border-color:rgba(239,68,68,.3);color:#ef4444}
    .ldsp-login-btn{flex:1 1 100%;background:linear-gradient(135deg,rgba(212,168,83,.15),rgba(196,147,57,.2));border-color:rgba(212,168,83,.3);color:var(--warn);animation:login-pulse 2.5s ease-in-out infinite}
    .ldsp-login-btn:hover{background:linear-gradient(135deg,rgba(212,168,83,.25),rgba(196,147,57,.3));border-color:var(--warn)}
    @keyframes login-pulse{0%,100%{box-shadow:0 0 0 0 rgba(212,168,83,.3)}50%{box-shadow:0 0 12px 2px rgba(212,168,83,.2)}}
    .ldsp-ticket-btn .ldsp-ticket-badge{background:var(--err);color:#fff;font-size:8px;padding:2px 5px;border-radius:8px;margin-left:2px;font-weight:700;animation:pulse 3s ease infinite}
    .ldsp-ticket-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg);border-radius:0 0 var(--r-lg) var(--r-lg);z-index:10;display:none;flex-direction:column;overflow:hidden}
    .ldsp-ticket-overlay.show{display:flex}
    .ldsp-ticket-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-ticket-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;color:var(--txt)}
    .ldsp-ticket-close{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--txt-sec);transition:background .15s,color .15s}
    .ldsp-ticket-close:hover{background:var(--err-bg);color:var(--err);border-color:var(--err)}
    .ldsp-ticket-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 10px;background:var(--bg-card);flex-shrink:0}
    .ldsp-ticket-tab{padding:8px 12px;font-size:10px;font-weight:600;color:var(--txt-mut);border-bottom:2px solid transparent;transition:color .15s,border-color .15s}
    .ldsp-ticket-tab.active{color:var(--accent);border-color:var(--accent)}
    .ldsp-ticket-tab:hover:not(.active){color:var(--txt-sec)}
    .ldsp-ticket-body{flex:1;overflow-y:auto;padding:12px;background:var(--bg);display:flex;flex-direction:column}
    .ldsp-ticket-body.detail-mode{padding:0;overflow:hidden}
    .ldsp-ticket-empty{text-align:center;padding:30px 16px;color:var(--txt-mut)}
    .ldsp-ticket-empty-icon{font-size:36px;margin-bottom:10px}
    .ldsp-ticket-list{display:flex;flex-direction:column;gap:8px}
    .ldsp-ticket-item{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px;cursor:pointer;transition:background .15s,border-color .15s}
    .ldsp-ticket-item:hover{background:var(--bg-hover);transform:translateX(3px)}
    .ldsp-ticket-item.has-reply{border-left:3px solid #ef4444;animation:pulse-border-red 3s ease infinite;background:rgba(239,68,68,.05)}
    .ldsp-ticket-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
    .ldsp-ticket-item-type{font-size:10px;color:var(--txt-sec)}
    .ldsp-ticket-item-status{font-size:9px;padding:2px 5px;border-radius:4px}
    .ldsp-ticket-item-status.open{background:var(--ok-bg);color:var(--ok)}
    .ldsp-ticket-item-status.closed{background:var(--bg-el);color:var(--txt-mut)}
    .ldsp-ticket-item-title{font-size:11px;font-weight:600;color:var(--txt);margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-ticket-item-meta{font-size:9px;color:var(--txt-mut);display:flex;gap:6px}
    .ldsp-ticket-form{display:flex;flex-direction:column;gap:10px}
    .ldsp-ticket-form-group{display:flex;flex-direction:column;gap:5px}
    .ldsp-ticket-label{font-size:10px;font-weight:600;color:var(--txt-sec)}
    .ldsp-ticket-types{display:flex;gap:6px;flex-wrap:wrap}
    .ldsp-ticket-type{flex:1;min-width:80px;padding:8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);text-align:center;cursor:pointer;transition:background .15s,border-color .15s}
    .ldsp-ticket-type:hover{border-color:var(--accent)}
    .ldsp-ticket-type.selected{border-color:var(--accent);background:rgba(107,140,239,.1)}
    .ldsp-ticket-type-icon{font-size:16px;display:block;margin-bottom:3px}
    .ldsp-ticket-type-label{font-size:10px;color:var(--txt)}
    .ldsp-ticket-input{padding:8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt)}
    .ldsp-ticket-input:focus{border-color:var(--accent);outline:none}
    .ldsp-ticket-textarea{padding:8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt);min-height:80px;resize:vertical}
    .ldsp-ticket-textarea:focus{border-color:var(--accent);outline:none}
    .ldsp-ticket-submit{padding:10px;background:var(--grad);color:#fff;border:none;border-radius:var(--r-sm);font-size:11px;font-weight:600;cursor:pointer;transition:opacity .15s,transform .2s}
    .ldsp-ticket-submit:hover{box-shadow:0 4px 12px rgba(107,140,239,.3)}
    .ldsp-ticket-submit:disabled{opacity:.5;cursor:not-allowed}
    .ldsp-ticket-detail{display:flex;flex-direction:column;flex:1;min-height:0;background:var(--bg)}
    .ldsp-ticket-detail-top{padding:10px 12px;border-bottom:1px solid var(--border);background:var(--bg-card);flex-shrink:0}
    .ldsp-ticket-back{display:inline-flex;align-items:center;gap:4px;padding:5px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);transition:background .15s,color .15s}
    .ldsp-ticket-back:hover{background:var(--bg-hover);color:var(--txt)}
    .ldsp-ticket-detail-header{margin-top:6px}
    .ldsp-ticket-detail-title{font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;word-break:break-word}
    .ldsp-ticket-detail-meta{display:flex;flex-wrap:wrap;gap:5px;font-size:9px;color:var(--txt-mut);margin-top:5px}
    .ldsp-ticket-detail-meta span{background:var(--bg-el);padding:2px 5px;border-radius:3px}
    .ldsp-ticket-messages{flex:1;overflow-y:auto;padding:10px 12px;display:flex;flex-direction:column;gap:8px;min-height:0}
    .ldsp-ticket-reply{max-width:85%;padding:8px 10px;border-radius:var(--r-sm);font-size:11px;line-height:1.4;word-break:break-word}
    .ldsp-ticket-reply.user{background:linear-gradient(135deg,rgba(107,140,239,.12),rgba(90,125,224,.08));border:1px solid rgba(107,140,239,.2);margin-left:auto;border-bottom-right-radius:3px}
    .ldsp-ticket-reply.admin{background:var(--bg-card);border:1px solid var(--border);margin-right:auto;border-bottom-left-radius:3px}
    .ldsp-ticket-reply-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:9px;color:var(--txt-mut)}
    .ldsp-ticket-reply-author{font-weight:600}
    .ldsp-ticket-reply.admin .ldsp-ticket-reply-author{color:var(--ok)}
    .ldsp-ticket-reply-content{color:var(--txt);white-space:pre-wrap}
    .ldsp-ticket-input-area{border-top:1px solid var(--border);padding:10px 12px;background:var(--bg-card);flex-shrink:0}
    .ldsp-ticket-reply-form{display:flex;gap:6px;align-items:center}
    .ldsp-ticket-reply-input{flex:1;padding:6px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;resize:none;min-height:32px;max-height:50px;color:var(--txt)}
    .ldsp-ticket-reply-input:focus{border-color:var(--accent);outline:none}
    .ldsp-ticket-reply-btn{padding:6px 12px;background:var(--grad);color:#fff;border:none;border-radius:var(--r-sm);font-size:10px;font-weight:600;transition:opacity .15s,transform .2s;flex-shrink:0;height:32px}
    .ldsp-ticket-reply-btn:hover{box-shadow:0 4px 12px rgba(107,140,239,.3)}
    .ldsp-ticket-reply-btn:disabled{opacity:.5;cursor:not-allowed}
    .ldsp-ticket-closed-hint{text-align:center;color:var(--txt-mut);font-size:10px;padding:10px}
    /* åƒç“œåŠ©æ‰‹æ ·å¼ */
    .ldsp-melon-btn{background:linear-gradient(135deg,rgba(74,222,128,.08),rgba(34,197,94,.12));border-color:rgba(74,222,128,.2);color:rgba(34,197,94,.85)}
    .ldsp-melon-btn:hover{background:linear-gradient(135deg,rgba(74,222,128,.15),rgba(34,197,94,.2));border-color:rgba(74,222,128,.35);color:#22c55e}
    /* å¯¼å‡ºå¸–å­æŒ‰é’®æ ·å¼ - ä½¿ç”¨æ©™è‰²è°ƒ */
    .ldsp-export-btn{background:linear-gradient(135deg,rgba(251,146,60,.08),rgba(234,88,12,.12));border-color:rgba(251,146,60,.2);color:rgba(234,88,12,.85)}
    .ldsp-export-btn:hover{background:linear-gradient(135deg,rgba(251,146,60,.15),rgba(234,88,12,.2));border-color:rgba(251,146,60,.35);color:#ea580c}
    /* å¯¼å‡ºå¸–å­é¢æ¿æ ·å¼ */
    .ldsp-export-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg);border-radius:0 0 var(--r-lg) var(--r-lg);z-index:10;display:none;flex-direction:column;overflow:hidden}
    .ldsp-export-overlay.show{display:flex}
    .ldsp-export-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-export-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;color:var(--txt)}
    .ldsp-export-header-actions{display:flex;align-items:center;gap:6px}
    .ldsp-export-refresh{padding:4px 10px;display:flex;align-items:center;justify-content:center;gap:4px;background:linear-gradient(135deg,rgba(107,140,239,.08),rgba(90,125,224,.12));border:1px solid rgba(107,140,239,.2);border-radius:6px;font-size:10px;color:var(--accent);cursor:pointer;transition:all .15s;white-space:nowrap}
    .ldsp-export-refresh:hover{background:linear-gradient(135deg,rgba(107,140,239,.15),rgba(90,125,224,.2));border-color:rgba(107,140,239,.4);color:#5a7de0}
    .ldsp-export-close{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--txt-sec);cursor:pointer;transition:background .15s,color .15s}
    .ldsp-export-close:hover{background:var(--err-bg);color:var(--err);border-color:var(--err)}
    .ldsp-export-body{flex:1;overflow-y:auto;padding:12px;background:var(--bg);display:flex;flex-direction:column;gap:10px}
    .ldsp-export-info{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px;font-size:11px}
    .ldsp-export-info-title{font-weight:600;color:var(--txt);margin-bottom:8px;display:flex;align-items:flex-start;gap:5px;line-height:1.5;font-size:12px}
    .ldsp-export-info-row{display:flex;align-items:center;gap:6px;color:var(--txt-sec);font-size:10px;margin-top:4px}
    .ldsp-export-info-label{color:var(--txt-mut);min-width:50px}
    .ldsp-export-info-value{color:var(--txt);font-weight:500}
    .ldsp-export-info-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
    .ldsp-export-info-category{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;background:var(--accent);color:#fff;border-radius:10px;font-size:9px;font-weight:600}
    .ldsp-export-info-tag{display:inline-flex;align-items:center;padding:2px 8px;background:var(--bg-el);color:var(--txt-sec);border-radius:10px;font-size:9px;font-weight:500;border:1px solid var(--border)}
    .ldsp-export-range{display:flex;align-items:center;gap:8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px;flex-wrap:wrap}
    .ldsp-export-range-label{font-size:10px;color:var(--txt-sec);white-space:nowrap}
    .ldsp-export-range-input{width:70px;padding:5px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt);text-align:center}
    .ldsp-export-range-input:focus{border-color:var(--accent);outline:none}
    .ldsp-export-range-sep{color:var(--txt-mut);font-size:10px}
    .ldsp-export-range-hint{font-size:9px;color:var(--txt-mut);margin-left:auto}
    .ldsp-export-options{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px}
    .ldsp-export-options-title{font-size:10px;color:var(--txt-sec);margin-bottom:8px}
    .ldsp-export-option{display:flex;align-items:center;gap:8px;padding:6px 0}
    .ldsp-export-option input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
    .ldsp-export-option label{font-size:11px;color:var(--txt);cursor:pointer}
    .ldsp-export-format-selector{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px}
    .ldsp-export-format-title{font-size:10px;color:var(--txt-sec);margin-bottom:8px}
    .ldsp-export-format-cards{display:flex;gap:8px}
    .ldsp-export-format-card{flex:1;display:flex;flex-direction:column;align-items:center;padding:12px 8px;background:var(--bg-el);border:2px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .2s}
    .ldsp-export-format-card:hover{border-color:var(--txt-mut);background:var(--bg-hover);transform:translateY(-1px)}
    .ldsp-export-format-card.active{border-color:var(--accent);background:rgba(107,140,239,.1);box-shadow:0 2px 8px rgba(107,140,239,.15)}
    .ldsp-export-format-card input{display:none}
    .ldsp-export-format-card-icon{width:28px;height:28px;margin-bottom:6px;display:flex;align-items:center;justify-content:center}
    .ldsp-export-format-card-icon svg{width:24px;height:24px}
    .ldsp-export-format-card-name{font-size:11px;font-weight:600;color:var(--txt)}
    .ldsp-export-format-card.active .ldsp-export-format-card-name{color:var(--accent)}
    .ldsp-export-actions{display:flex;gap:8px}
    .ldsp-export-btn-start{flex:1;padding:12px;border:none;border-radius:var(--r-md);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;box-shadow:0 2px 8px rgba(34,197,94,.2)}
    .ldsp-export-btn-start:hover{box-shadow:0 4px 16px rgba(34,197,94,.35);transform:translateY(-2px)}
    .ldsp-export-btn-start:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    .ldsp-export-btn-stop{flex:1;padding:12px;border:none;border-radius:var(--r-md);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;box-shadow:0 2px 8px rgba(239,68,68,.2)}
    .ldsp-export-btn-stop:hover{box-shadow:0 4px 16px rgba(239,68,68,.35);transform:translateY(-2px)}
    .ldsp-export-status{text-align:center;padding:14px;color:var(--txt-sec);font-size:11px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md)}
    .ldsp-export-status-icon{font-size:24px;margin-bottom:8px;display:block}
    .ldsp-export-not-topic{text-align:center;padding:40px 20px;color:var(--txt-mut)}
    .ldsp-export-not-topic-icon{font-size:36px;margin-bottom:10px}
    .ldsp-export-not-topic-text{font-size:12px;line-height:1.6}
    /* LDC ç§¯åˆ†æŒ‰é’®æ ·å¼ - ä½¿ç”¨ä¸ä¸»é¢˜ä¸€è‡´çš„è“ç´«è‰²è°ƒ */
    .ldsp-ldc-btn{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(124,58,237,.12));border-color:rgba(139,92,246,.2);color:rgba(139,92,246,.85)}
    .ldsp-ldc-btn:hover{background:linear-gradient(135deg,rgba(139,92,246,.15),rgba(124,58,237,.2));border-color:rgba(139,92,246,.35);color:#8b5cf6}
    /* CDK æŒ‰é’®æ ·å¼ - ä½¿ç”¨é’è‰²è°ƒ */
    .ldsp-cdk-btn{background:linear-gradient(135deg,rgba(6,182,212,.08),rgba(14,165,233,.12));border-color:rgba(6,182,212,.2);color:rgba(6,182,212,.85)}
    .ldsp-cdk-btn:hover{background:linear-gradient(135deg,rgba(6,182,212,.15),rgba(14,165,233,.2));border-color:rgba(6,182,212,.35);color:#06b6d4}
    /* CDK é¢æ¿æ ·å¼ */
    .ldsp-cdk-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg);border-radius:0 0 var(--r-lg) var(--r-lg);z-index:10;display:none;flex-direction:column;overflow:hidden}
    .ldsp-cdk-overlay.show{display:flex}
    .ldsp-cdk-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-cdk-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;color:var(--txt)}
    .ldsp-cdk-header-actions{display:flex;align-items:center;gap:8px}
    .ldsp-cdk-link{color:var(--accent)!important;text-decoration:none!important;font-size:10px!important;font-weight:600!important;opacity:.9;transition:opacity .15s}
    .ldsp-cdk-link:hover{opacity:1}
    .ldsp-cdk-refresh{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;color:var(--txt-sec);cursor:pointer;transition:background .15s,border-color .15s,color .15s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    .ldsp-cdk-refresh:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-cdk-refresh.spinning svg{animation:ldsp-spin .8s linear infinite}
    .ldsp-cdk-refresh svg{width:12px;height:12px;fill:currentColor}
    .ldsp-cdk-close{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--txt-sec);cursor:pointer;transition:background .15s,color .15s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    .ldsp-cdk-close:hover{background:var(--err-bg);color:var(--err);border-color:var(--err)}
    /* CDK Tabs */
    .ldsp-cdk-tabs{display:flex;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-cdk-tab{flex:1;padding:10px 8px;font-size:11px;font-weight:600;color:var(--txt-mut);text-align:center;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;-webkit-tap-highlight-color:transparent}
    .ldsp-cdk-tab:hover{color:var(--txt-sec);background:var(--bg-hover)}
    .ldsp-cdk-tab.active{color:#06b6d4;border-bottom-color:#06b6d4;background:transparent}
    .ldsp-cdk-body{flex:1;overflow-y:auto;padding:12px;background:var(--bg);display:flex;flex-direction:column;gap:10px;container-type:inline-size}
    .ldsp-cdk-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--txt-mut);flex:1}
    .ldsp-cdk-loading .ldsp-spinner{margin-bottom:10px}
    .ldsp-cdk-error{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;text-align:center;color:var(--err);flex:1}
    .ldsp-cdk-error-icon{font-size:32px;margin-bottom:10px}
    .ldsp-cdk-error-msg{font-size:11px;margin-bottom:12px;color:var(--txt-sec)}
    .ldsp-cdk-login-btn{display:inline-block;padding:10px 20px;background:linear-gradient(135deg,#06b6d4,#0ea5e9);color:#fff!important;text-decoration:none!important;border-radius:var(--r-sm);font-size:12px;font-weight:600;transition:all .2s;box-shadow:0 2px 8px rgba(6,182,212,.3)}
    .ldsp-cdk-login-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(6,182,212,.4)}
    .ldsp-cdk-retry-btn{margin-top:8px;padding:8px 16px;background:#06b6d4;color:#fff;border:none;border-radius:var(--r-sm);font-size:11px;cursor:pointer;transition:opacity .15s}
    .ldsp-cdk-retry-btn:hover{opacity:.85}
    /* CDK ç”¨æˆ·å¡ç‰‡ */
    .ldsp-cdk-user-card{display:flex;align-items:center;gap:12px;padding:14px;background:linear-gradient(135deg,var(--bg-card),var(--bg-hover));border:1px solid var(--border);border-radius:var(--r-md);position:relative;overflow:hidden}
    .ldsp-cdk-user-card::before{content:'';position:absolute;top:-50%;right:-30%;width:80%;height:200%;background:radial-gradient(circle,rgba(6,182,212,.08) 0%,transparent 70%);pointer-events:none}
    .ldsp-cdk-user-avatar{width:52px;height:52px;border-radius:50%;border:2px solid rgba(6,182,212,.3);object-fit:cover;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .ldsp-cdk-user-info{flex:1;min-width:0}
    .ldsp-cdk-user-name{font-size:15px;font-weight:700;color:var(--txt);margin-bottom:2px}
    .ldsp-cdk-user-username{font-size:10px;color:var(--txt-mut)}
    .ldsp-cdk-user-level{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:linear-gradient(135deg,rgba(251,191,36,.18),rgba(245,158,11,.1));border:1px solid rgba(251,191,36,.25);border-radius:999px;font-size:10px;color:#f59e0b;font-weight:600;margin-top:6px}
    .ldsp-cdk-score-card{display:flex;flex-direction:column;align-items:center;padding:12px 18px;background:linear-gradient(135deg,rgba(6,182,212,.15),rgba(14,165,233,.08));border:1px solid rgba(6,182,212,.25);border-radius:var(--r-md);min-width:80px;box-shadow:0 4px 12px rgba(6,182,212,.1)}
    .ldsp-cdk-score-label{font-size:9px;color:var(--txt-sec);margin-bottom:3px;text-transform:uppercase;letter-spacing:.3px}
    .ldsp-cdk-score-value{font-size:26px;font-weight:800;color:#06b6d4;text-shadow:0 2px 8px rgba(6,182,212,.25)}
    /* CDK ç”¨æˆ·å¡ç‰‡ - çª„å®½åº¦å“åº”å¼ */
    @container (max-width:280px){.ldsp-cdk-user-card{gap:10px;padding:12px}.ldsp-cdk-user-card::before{display:none}.ldsp-cdk-user-avatar{width:36px;height:36px;flex-shrink:0}.ldsp-cdk-user-info{flex:1;min-width:0}.ldsp-cdk-user-name{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ldsp-cdk-user-username{font-size:9px}.ldsp-cdk-user-level{font-size:9px;padding:2px 8px;margin-top:4px}.ldsp-cdk-score-card{min-width:65px;padding:10px 12px;flex-shrink:0}.ldsp-cdk-score-label{font-size:8px}.ldsp-cdk-score-value{font-size:18px}}
    @container (max-width:220px){.ldsp-cdk-user-card{gap:8px;padding:10px}.ldsp-cdk-user-avatar{width:32px;height:32px}.ldsp-cdk-user-name{font-size:12px}.ldsp-cdk-user-username{font-size:8px}.ldsp-cdk-user-level{font-size:8px;padding:2px 6px;margin-top:3px}.ldsp-cdk-score-card{min-width:55px;padding:8px}.ldsp-cdk-score-label{font-size:7px}.ldsp-cdk-score-value{font-size:16px}}
    /* CDK æœç´¢æ¡† */
    .ldsp-cdk-search{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);transition:border-color .15s}
    .ldsp-cdk-search:focus-within{border-color:var(--accent)}
    .ldsp-cdk-search-icon{color:var(--txt-mut);font-size:14px;flex-shrink:0}
    .ldsp-cdk-search input{flex:1;border:none;background:transparent;font-size:12px;color:var(--txt);outline:none;min-width:0}
    .ldsp-cdk-search input::placeholder{color:var(--txt-mut)}
    .ldsp-cdk-search-clear{width:18px;height:18px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:none;border-radius:50%;cursor:pointer;color:var(--txt-mut);font-size:10px;transition:all .15s;flex-shrink:0;opacity:0;pointer-events:none}
    .ldsp-cdk-search-clear.show{opacity:1;pointer-events:auto}
    .ldsp-cdk-search-clear:hover{background:var(--err-bg);color:var(--err)}
    /* CDK é¢†å–è®°å½•åˆ—è¡¨ */
    .ldsp-cdk-list{display:flex;flex-direction:column;gap:8px}
    .ldsp-cdk-item{display:flex;flex-direction:column;gap:8px;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .2s ease;position:relative;overflow:hidden}
    .ldsp-cdk-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#06b6d4;opacity:0;transition:opacity .2s}
    .ldsp-cdk-item:hover{border-color:rgba(6,182,212,.4);background:var(--bg-hover);transform:translateX(2px)}
    .ldsp-cdk-item:hover::before{opacity:1}
    .ldsp-cdk-item:active{transform:translateX(2px) scale(.99)}
    .ldsp-cdk-item-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .ldsp-cdk-item-name{font-size:13px;font-weight:600;color:var(--txt);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-cdk-item-time{font-size:9px;color:var(--txt-mut);flex-shrink:0;padding:2px 6px;background:var(--bg-hover);border-radius:4px}
    .ldsp-cdk-item-creator{font-size:10px;color:var(--txt-sec);display:flex;align-items:center;gap:4px}
    .ldsp-cdk-item-content{font-size:11px;color:#06b6d4;font-family:monospace;background:rgba(6,182,212,.08);padding:8px 10px;border-radius:var(--r-sm);word-break:break-all;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .ldsp-cdk-item-content-text{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis}
    .ldsp-cdk-item-copy{display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;width:28px;height:28px;background:rgba(6,182,212,.15);border:none;border-radius:6px;color:#06b6d4;font-size:12px;cursor:pointer;transition:all .15s}
    .ldsp-cdk-item-copy:hover{background:rgba(6,182,212,.25);transform:scale(1.05)}
    /* CDK æ•°é‡å¡ç‰‡ */
    .ldsp-cdk-qty-card{display:flex;gap:0;padding:0;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);overflow:hidden}
    .ldsp-cdk-qty-item{flex:1;text-align:center;padding:12px 8px}
    .ldsp-cdk-qty-item.remain{background:linear-gradient(135deg,rgba(34,197,94,.12),rgba(16,185,129,.06));border-right:1px solid var(--border)}
    .ldsp-cdk-qty-item .num{font-size:24px;font-weight:700;line-height:1.2}
    .ldsp-cdk-qty-item.remain .num{color:#22c55e}
    .ldsp-cdk-qty-item.total .num{color:var(--txt)}
    .ldsp-cdk-qty-item .lbl{font-size:9px;color:var(--txt-mut);margin-top:4px}
    /* CDK è¯¦æƒ…é¡µ */
    .ldsp-cdk-detail{display:flex;flex-direction:column;gap:12px;flex:1}
    .ldsp-cdk-detail-header{display:flex;align-items:center;gap:8px;margin-bottom:4px}
    .ldsp-cdk-back-btn{padding:6px 12px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-cdk-back-btn:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-cdk-detail-title{font-size:14px;font-weight:700;color:var(--txt)}
    .ldsp-cdk-detail-meta{font-size:10px;color:var(--txt-sec);margin-bottom:4px}
    .ldsp-cdk-detail-desc{font-size:11px;color:var(--txt-sec);line-height:1.6;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md)}
    .ldsp-cdk-detail-content{padding:12px;background:linear-gradient(135deg,rgba(6,182,212,.08),rgba(14,165,233,.05));border:1px solid rgba(6,182,212,.2);border-radius:var(--r-md)}
    .ldsp-cdk-detail-content-label{font-size:10px;color:var(--txt-mut);margin-bottom:6px}
    .ldsp-cdk-detail-content-value{font-size:14px;color:#06b6d4;font-family:monospace;word-break:break-all;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .ldsp-cdk-detail-copy{padding:4px 10px;background:rgba(6,182,212,.12);border:1px solid rgba(6,182,212,.25);border-radius:var(--r-sm);color:#06b6d4;font-size:10px;cursor:pointer;transition:all .15s}
    .ldsp-cdk-detail-copy:hover{background:rgba(6,182,212,.2);border-color:rgba(6,182,212,.4)}
    .ldsp-cdk-detail-info{display:flex;flex-direction:column;gap:6px}
    .ldsp-cdk-detail-row{display:flex;justify-content:space-between;padding:8px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm)}
    .ldsp-cdk-detail-row .label{font-size:10px;color:var(--txt-mut)}
    .ldsp-cdk-detail-row .value{font-size:10px;color:var(--txt);font-weight:500}
    .ldsp-cdk-detail-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
    .ldsp-cdk-detail-tag{padding:2px 8px;background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);border-radius:999px;font-size:9px;color:#06b6d4}
    .ldsp-cdk-detail-section{margin-top:4px}
    .ldsp-cdk-detail-section-title{font-size:11px;font-weight:600;color:var(--txt-sec);margin-bottom:8px;display:flex;align-items:center;gap:4px}
    .ldsp-cdk-qty-card{display:flex;gap:12px;padding:14px;background:linear-gradient(135deg,var(--bg-card),var(--bg-hover));border:1px solid var(--border);border-radius:var(--r-md)}
    .ldsp-cdk-qty-item{flex:1;text-align:center}
    .ldsp-cdk-qty-item.remain{background:linear-gradient(135deg,rgba(34,197,94,.1),rgba(16,185,129,.05));border:1px solid rgba(34,197,94,.25);border-radius:var(--r-sm);padding:10px 8px}
    .ldsp-cdk-qty-item .num{font-size:22px;font-weight:700;line-height:1.2}
    .ldsp-cdk-qty-item.remain .num{color:#22c55e}
    .ldsp-cdk-qty-item.total .num{color:var(--txt-sec)}
    .ldsp-cdk-qty-item .lbl{font-size:9px;color:var(--txt-mut);margin-top:4px}
    .ldsp-cdk-qty-divider{width:1px;background:var(--border);margin:0 4px}
    /* CDK åˆ—è¡¨å¤´éƒ¨ */
    .ldsp-cdk-list-header{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
    .ldsp-cdk-stats-row{display:flex;align-items:center;justify-content:space-between;font-size:10px;color:var(--txt-sec)}
    .ldsp-cdk-stats-row .total{display:flex;align-items:center;gap:4px}
    .ldsp-cdk-stats-row .total strong{color:#06b6d4;font-size:14px;font-weight:700}
    .ldsp-cdk-stats-row .loaded{color:var(--txt-mut)}
    .ldsp-cdk-load-trigger{padding:14px;text-align:center;font-size:10px;color:var(--txt-mut);background:var(--bg-card);border:1px dashed var(--border);border-radius:var(--r-sm);margin-top:8px;cursor:pointer;transition:all .15s}
    .ldsp-cdk-load-trigger:hover{border-color:var(--accent);color:var(--accent)}
    .ldsp-cdk-load-trigger.loading{display:flex;align-items:center;justify-content:center;gap:8px;cursor:default;border-style:solid;border-color:var(--accent)}
    .ldsp-cdk-load-trigger .ldsp-mini-spin{width:14px;height:14px;border-width:2px}
    .ldsp-cdk-loaded-all{padding:10px;text-align:center;font-size:10px;color:var(--txt-mut);background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:var(--r-sm);margin-top:8px}
    .ldsp-cdk-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;flex:1}
    .ldsp-cdk-empty-icon{font-size:36px;margin-bottom:10px}
    .ldsp-cdk-empty-text{font-size:11px;color:var(--txt-mut)}
    /* è‡ªå®šä¹‰å¼¹å‡ºæ¡†æ ·å¼ - Toast/Alert/Confirm */
    #ldsp-panel .ldsp-toast-container{position:absolute;top:50px;left:0;right:0;z-index:9999;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;padding:0 12px;box-sizing:border-box}
    #ldsp-panel .ldsp-toast{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);box-shadow:0 4px 16px rgba(0,0,0,.2);animation:ldsp-toast-in .3s cubic-bezier(.4,0,.2,1);pointer-events:auto;word-break:break-word;max-width:280px;box-sizing:border-box}
    #ldsp-panel .ldsp-toast.hiding{animation:ldsp-toast-out .25s cubic-bezier(.4,0,.2,1) forwards}
    #ldsp-panel .ldsp-toast-icon{font-size:16px;flex-shrink:0;line-height:1}
    #ldsp-panel .ldsp-toast-content{flex:1;min-width:0}
    #ldsp-panel .ldsp-toast-title{font-size:11px;font-weight:600;color:var(--txt);margin-bottom:2px}
    #ldsp-panel .ldsp-toast-message{font-size:10px;color:var(--txt-sec);line-height:1.5}
    #ldsp-panel .ldsp-toast-close{flex-shrink:0;width:18px;height:18px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;color:var(--txt-mut);cursor:pointer;border-radius:4px;font-size:14px;transition:all .15s;margin:-2px -4px -2px 0}
    #ldsp-panel .ldsp-toast-close:hover{background:var(--bg-el);color:var(--txt-sec)}
    #ldsp-panel .ldsp-toast.success{border-left:3px solid var(--ok)}
    #ldsp-panel .ldsp-toast.success .ldsp-toast-icon{color:var(--ok)}
    #ldsp-panel .ldsp-toast.error{border-left:3px solid var(--err)}
    #ldsp-panel .ldsp-toast.error .ldsp-toast-icon{color:var(--err)}
    #ldsp-panel .ldsp-toast.warning{border-left:3px solid var(--warn)}
    #ldsp-panel .ldsp-toast.warning .ldsp-toast-icon{color:var(--warn)}
    #ldsp-panel .ldsp-toast.info{border-left:3px solid var(--accent)}
    #ldsp-panel .ldsp-toast.info .ldsp-toast-icon{color:var(--accent)}
    @keyframes ldsp-toast-in{from{opacity:0;transform:translateY(-10px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes ldsp-toast-out{from{opacity:1;transform:translateY(0) scale(1)}to{opacity:0;transform:translateY(-10px) scale(.95)}}
    .ldsp-dialog-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999;border-radius:var(--r-lg)}
    .ldsp-dialog{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px 20px;width:85%;max-width:280px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.25)}
    .ldsp-dialog-icon{font-size:32px;margin-bottom:12px}
    .ldsp-dialog-title{font-size:13px;font-weight:700;color:var(--txt);margin-bottom:6px}
    .ldsp-dialog-message{font-size:11px;color:var(--txt-sec);line-height:1.6;margin-bottom:16px;word-break:break-word}
    .ldsp-dialog-actions{display:flex;gap:8px}
    .ldsp-dialog-btn{flex:1;padding:9px 14px;border:none;border-radius:var(--r-sm);font-size:11px;font-weight:600;cursor:pointer;transition:background .15s,opacity .15s}
    .ldsp-dialog-btn-cancel{background:var(--bg-el);color:var(--txt-sec);border:1px solid var(--border)}
    .ldsp-dialog-btn-cancel:hover{background:var(--bg-hover);border-color:var(--txt-mut)}
    .ldsp-dialog-btn-ok{background:var(--accent);color:#fff}
    .ldsp-dialog-btn-ok:hover{opacity:.9;box-shadow:0 4px 12px rgba(107,140,239,.3)}
    .ldsp-dialog-btn-danger{background:var(--err);color:#fff}
    .ldsp-dialog-btn-danger:hover{opacity:.9;box-shadow:0 4px 12px rgba(239,68,68,.3)}
    /* ç¦ç”¨å…¨å±€transitionå¯¹å¼¹çª—çš„å½±å“ - ä½¿ç”¨é«˜æƒé‡é€‰æ‹©å™¨ */
    #ldsp-panel .ldsp-toast-container,#ldsp-panel .ldsp-toast-container *{transition:none!important;animation:none!important}
    #ldsp-panel .ldsp-toast{transition:none!important;animation:none!important}
    #ldsp-panel .ldsp-dialog-overlay,#ldsp-panel .ldsp-dialog-overlay *{transition:none!important}
    #ldsp-panel .ldsp-dialog{transition:none!important}
    @keyframes ldsp-fade-in{from{opacity:0}to{opacity:1}}
    /* LDC ç§¯åˆ†é¢æ¿æ ·å¼ - ä¸å®¢æˆ·ç«¯ä¸»é¢˜é£æ ¼ç»Ÿä¸€ */
    .ldsp-ldc-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg);border-radius:0 0 var(--r-lg) var(--r-lg);z-index:10;display:none;flex-direction:column;overflow:hidden}
    .ldsp-ldc-overlay.show{display:flex}
    .ldsp-ldc-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-ldc-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;color:var(--txt)}
    .ldsp-ldc-header-actions{display:flex;align-items:center;gap:8px}
    .ldsp-ldc-link{color:var(--accent)!important;text-decoration:none!important;font-size:10px!important;font-weight:600!important;opacity:.9;transition:opacity .15s}
    .ldsp-ldc-link:hover{opacity:1}
    .ldsp-ldc-refresh{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;color:var(--txt-sec);cursor:pointer;transition:background .15s,border-color .15s,color .15s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    .ldsp-ldc-refresh:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-ldc-refresh.spinning svg{animation:ldsp-spin .8s linear infinite}
    .ldsp-ldc-refresh svg{width:12px;height:12px;fill:currentColor}
    .ldsp-ldc-close{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--txt-sec);cursor:pointer;transition:background .15s,color .15s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    .ldsp-ldc-close:hover{background:var(--err-bg);color:var(--err);border-color:var(--err)}
    /* LDC Tabs */
    .ldsp-ldc-tabs{display:flex;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-ldc-tab{flex:1;padding:10px 8px;font-size:11px;font-weight:600;color:var(--txt-mut);text-align:center;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;-webkit-tap-highlight-color:transparent}
    .ldsp-ldc-tab:hover{color:var(--txt-sec);background:var(--bg-hover)}
    .ldsp-ldc-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:transparent}
    .ldsp-ldc-body{flex:1;overflow-y:auto;padding:12px;background:var(--bg);display:flex;flex-direction:column;gap:10px;min-height:0}
    .ldsp-ldc-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--txt-mut);flex:1}
    .ldsp-ldc-loading .ldsp-spinner{margin-bottom:10px}
    .ldsp-ldc-error{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;text-align:center;color:var(--err);flex:1}
    .ldsp-ldc-error-icon{font-size:32px;margin-bottom:10px}
    .ldsp-ldc-error-msg{font-size:11px;margin-bottom:12px;color:var(--txt-sec)}
    .ldsp-ldc-login-btn{display:inline-block;padding:10px 20px;background:var(--grad);color:#fff!important;text-decoration:none!important;border-radius:var(--r-sm);font-size:12px;font-weight:600;transition:all .2s;box-shadow:0 2px 8px rgba(107,140,239,.3)}
    .ldsp-ldc-login-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(107,140,239,.4)}
    .ldsp-ldc-retry-btn{margin-top:8px;padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:var(--r-sm);font-size:11px;cursor:pointer;transition:opacity .15s}
    .ldsp-ldc-retry-btn:hover{opacity:.85}
    /* iOS Safari é™åˆ¶æç¤º */
    .ldsp-ldc-ios-guide{display:block;padding:12px;text-align:center;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .ldsp-ldc-ios-icon{font-size:28px;margin-bottom:6px;display:block}
    .ldsp-ldc-ios-title{font-size:13px;font-weight:700;color:var(--txt);margin-bottom:8px}
    .ldsp-ldc-ios-desc{font-size:10px;color:var(--txt-sec);margin-bottom:12px;line-height:1.5;padding:0 4px}
    .ldsp-ldc-ios-desc strong{color:var(--txt);font-weight:600}
    .ldsp-ldc-ios-solutions{margin-bottom:10px}
    .ldsp-ldc-ios-solution{padding:10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);text-align:left;margin-bottom:8px}
    .ldsp-ldc-ios-solution.alt{background:var(--bg-el);border-style:dashed;margin-bottom:0}
    .ldsp-ldc-ios-solution-title{font-size:11px;font-weight:600;color:var(--txt);margin-bottom:4px}
    .ldsp-ldc-ios-solution-desc{font-size:10px;color:var(--txt-sec);margin-bottom:8px;line-height:1.4}
    .ldsp-ldc-ios-solution.alt .ldsp-ldc-ios-solution-desc{margin-bottom:0}
    .ldsp-ldc-ios-btn{display:block;padding:10px 16px;border-radius:var(--r-sm);font-size:11px;font-weight:600;cursor:pointer;text-decoration:none!important;border:none;width:100%;text-align:center;box-sizing:border-box;-webkit-appearance:none;-webkit-tap-highlight-color:transparent}
    .ldsp-ldc-ios-btn.primary{background:var(--grad);color:#fff!important;box-shadow:0 2px 6px rgba(107,140,239,.25)}
    .ldsp-ldc-ios-tip{font-size:9px;color:var(--txt-mut);padding:8px;background:var(--bg-el);border-radius:var(--r-sm);line-height:1.4}
    /* æ¦‚è§ˆé¡µ - ä½™é¢å¡ç‰‡ */
    .ldsp-ldc-balance-card{position:relative;background:linear-gradient(145deg,rgba(139,92,246,.14) 0%,rgba(107,140,239,.16) 50%,rgba(59,130,246,.1) 100%);border:1px solid rgba(139,92,246,.2);border-radius:var(--r-lg);padding:16px 18px 12px;box-shadow:0 4px 16px rgba(139,92,246,.1),0 2px 4px rgba(0,0,0,.05);overflow:hidden;flex-shrink:0}
    .ldsp-ldc-balance-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(139,92,246,.6) 30%,rgba(107,140,239,.8) 50%,rgba(139,92,246,.6) 70%,transparent)}
    .ldsp-ldc-balance-card::after{content:'';position:absolute;top:-50%;right:-30%;width:60%;height:150%;background:radial-gradient(ellipse,rgba(255,255,255,.04) 0%,transparent 70%);pointer-events:none}
    .ldsp-ldc-balance-main{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;z-index:1;flex-wrap:wrap}
    .ldsp-ldc-balance-left{flex:1;min-width:80px}
    .ldsp-ldc-balance-label{font-size:10px;color:var(--txt-mut);margin-bottom:2px}
    .ldsp-ldc-balance-value{font-size:28px;font-weight:700;color:var(--accent);line-height:1.2}
    .ldsp-ldc-balance-right{text-align:right;flex-shrink:0;display:flex;flex-direction:column;gap:4px;min-width:0}
    .ldsp-ldc-balance-sub{font-size:10px;color:var(--txt-mut);display:flex;align-items:center;gap:4px;justify-content:flex-end;flex-wrap:wrap}
    .ldsp-ldc-balance-sub-value{font-weight:600;color:var(--txt-sec)}
    .ldsp-ldc-balance-footer{display:flex;justify-content:flex-end;margin-top:10px;padding-top:8px;border-top:1px solid rgba(139,92,246,.1);position:relative;z-index:1}
    .ldsp-ldc-balance-time{font-size:9px;color:var(--txt-mut);opacity:.6}
    .ldsp-ldc-balance-estimate{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--txt-mut);justify-content:flex-end;flex-wrap:nowrap}
    .ldsp-ldc-balance-estimate-value{font-weight:600}
    .ldsp-ldc-balance-estimate-value.positive{color:var(--ok)}
    .ldsp-ldc-balance-estimate-value.negative{color:var(--err)}
    .ldsp-ldc-balance-estimate-value.neutral{color:var(--txt-mut)}
    .ldsp-ldc-balance-estimate-tip{display:inline-flex;align-items:center;justify-content:center;width:12px;height:12px;border-radius:50%;background:transparent;border:1px solid var(--txt-mut);opacity:.5;cursor:help;font-size:8px;color:var(--txt-mut);transition:opacity .15s;flex-shrink:0}
    .ldsp-ldc-balance-estimate-tip:hover{opacity:.8}
    /* æ¦‚è§ˆé¡µ - ç»Ÿè®¡ç½‘æ ¼ */
    .ldsp-ldc-stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex-shrink:0}
    .ldsp-ldc-stat-card{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md)}
    .ldsp-ldc-stat-card.income{border-left:3px solid var(--ok)}
    .ldsp-ldc-stat-card.expense{border-left:3px solid var(--err)}
    .ldsp-ldc-stat-icon{font-size:18px}
    .ldsp-ldc-stat-info{flex:1;min-width:0}
    .ldsp-ldc-stat-label{font-size:10px;color:var(--txt-mut)}
    .ldsp-ldc-stat-num{font-size:14px;font-weight:700;color:var(--txt)}
    .ldsp-ldc-stat-card.income .ldsp-ldc-stat-num{color:var(--ok)}
    .ldsp-ldc-stat-card.expense .ldsp-ldc-stat-num{color:var(--err)}
    /* æ¦‚è§ˆé¡µ - å›¾è¡¨åŒº */
    .ldsp-ldc-section{display:flex;flex-direction:column;gap:8px;flex-shrink:0}
    .ldsp-ldc-section-header{display:flex;justify-content:space-between;align-items:center}
    .ldsp-ldc-section-title{font-size:11px;font-weight:600;color:var(--txt-sec)}
    .ldsp-ldc-section-summary{font-size:10px;display:flex;gap:8px}
    .ldsp-ldc-section-summary em{font-style:normal;font-weight:600}
    .ldsp-ldc-section-summary em.income{color:var(--ok)}
    .ldsp-ldc-section-summary em.expense{color:var(--err)}
    .ldsp-ldc-chart{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px}
    .ldsp-ldc-chart-bars{display:flex;justify-content:space-around;align-items:flex-end;height:80px;gap:4px;margin-bottom:8px}
    .ldsp-ldc-chart-col{display:flex;flex-direction:column;align-items:center;flex:1;height:100%}
    .ldsp-ldc-chart-bar-group{flex:1;display:flex;align-items:flex-end;gap:2px;width:100%}
    .ldsp-ldc-chart-bar{width:45%;min-height:2px;border-radius:2px 2px 0 0;transition:height .3s}
    .ldsp-ldc-chart-bar.income{background:linear-gradient(to top,var(--ok),rgba(74,222,128,.6))}
    .ldsp-ldc-chart-bar.expense{background:linear-gradient(to top,var(--err),rgba(248,113,113,.6))}
    .ldsp-ldc-chart-label{font-size:9px;color:var(--txt-mut);margin-top:4px}
    .ldsp-ldc-chart-legend{display:flex;justify-content:center;gap:16px;padding-top:8px;border-top:1px solid var(--border)}
    .ldsp-ldc-legend-item{font-size:9px;color:var(--txt-sec);display:flex;align-items:center;gap:4px}
    .ldsp-ldc-legend-item i{width:8px;height:8px;border-radius:2px}
    .ldsp-ldc-legend-item.income i{background:var(--ok)}
    .ldsp-ldc-legend-item.expense i{background:var(--err)}
    .ldsp-ldc-footer{display:flex;justify-content:center;padding-top:8px;border-top:1px solid var(--border)}
    .ldsp-ldc-update-time{font-size:9px;color:var(--txt-mut)}
    .ldsp-ldc-empty{text-align:center;padding:16px;color:var(--txt-mut);font-size:11px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md)}
    /* æ¦‚è§ˆé¡µ - ä¿¡æ¯å¡ç‰‡åŒº */
    .ldsp-ldc-info-section{display:flex;flex-direction:column;gap:8px;margin-top:4px;flex-shrink:0}
    .ldsp-ldc-info-card{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);cursor:pointer;text-decoration:none!important;transition:all .2s ease;position:relative;overflow:hidden}
    .ldsp-ldc-info-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--info-accent,var(--accent));opacity:.6;transition:opacity .2s}
    .ldsp-ldc-info-card:hover{border-color:var(--info-accent,var(--accent));background:linear-gradient(90deg,rgba(var(--info-accent-rgb,107,140,239),.06),transparent);transform:translateX(2px)}
    .ldsp-ldc-info-card:hover::before{opacity:1}
    .ldsp-ldc-info-card:active{transform:translateX(1px);transition-duration:.1s}
    .ldsp-ldc-info-card.faq{--info-accent:#8b5cf6;--info-accent-rgb:139,92,246}
    .ldsp-ldc-info-icon{font-size:20px;flex-shrink:0;filter:drop-shadow(0 2px 4px rgba(0,0,0,.1))}
    .ldsp-ldc-info-content{flex:1;min-width:0}
    .ldsp-ldc-info-title{font-size:11px;font-weight:600;color:var(--txt);margin-bottom:2px;display:flex;align-items:center;gap:6px}
    .ldsp-ldc-info-desc{font-size:9px;color:var(--txt-mut);line-height:1.4;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-ldc-info-arrow{font-size:12px;color:var(--txt-mut);transition:transform .2s,color .2s;flex-shrink:0}
    .ldsp-ldc-info-card:hover .ldsp-ldc-info-arrow{transform:translateX(3px);color:var(--info-accent,var(--accent))}
    /* æ”¯æŒé¡µé¢ */
    .ldsp-ldc-support{display:flex;flex-direction:column;gap:14px;flex:1;min-height:200px}
    .ldsp-ldc-support-header{text-align:center;padding:12px 10px;background:linear-gradient(135deg,rgba(239,68,68,.06),rgba(249,115,22,.04),rgba(107,140,239,.06));border-radius:var(--r-md);border:1px solid rgba(239,68,68,.1)}
    .ldsp-ldc-support-title{font-size:15px;font-weight:700;color:var(--txt);margin-bottom:6px;display:flex;align-items:center;justify-content:center;gap:8px}
    .ldsp-ldc-support-desc{font-size:11px;color:var(--txt-sec);line-height:1.6}
    .ldsp-ldc-support-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .ldsp-ldc-support-card{display:flex;flex-direction:column;align-items:center;padding:18px 14px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);text-decoration:none!important;position:relative;overflow:hidden}
    .ldsp-ldc-support-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--card-accent,var(--border)),transparent);transition:all .3s cubic-bezier(.4,0,.2,1)}
    .ldsp-ldc-support-card::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 0%,var(--card-accent,transparent) 0%,transparent 70%);opacity:0;transition:opacity .3s}
    .ldsp-ldc-support-card:hover{border-color:var(--card-accent,var(--accent));transform:translateY(-4px) scale(1.02);box-shadow:0 12px 28px var(--card-glow,rgba(0,0,0,.15))}
    .ldsp-ldc-support-card:hover::before{height:4px;background:var(--card-accent,var(--accent))}
    .ldsp-ldc-support-card:hover::after{opacity:.08}
    .ldsp-ldc-support-card:active{transform:translateY(-2px) scale(1.01);transition-duration:.1s}
    .ldsp-ldc-support-card.tier-1{--card-accent:#10b981;--card-glow:rgba(16,185,129,.25)}
    .ldsp-ldc-support-card.tier-2{--card-accent:#3b82f6;--card-glow:rgba(59,130,246,.25)}
    .ldsp-ldc-support-card.tier-3{--card-accent:#f59e0b;--card-glow:rgba(245,158,11,.28)}
    .ldsp-ldc-support-card.tier-4{--card-accent:#ef4444;--card-glow:rgba(239,68,68,.28);background:linear-gradient(145deg,var(--bg-card),rgba(239,68,68,.05))}
    .ldsp-ldc-support-card.tier-3::before,.ldsp-ldc-support-card.tier-4::before{animation:ldsp-shimmer 2s ease-in-out infinite}
    @keyframes ldsp-shimmer{0%,100%{opacity:.8}50%{opacity:1}}
    .ldsp-ldc-support-icon{font-size:34px;margin-bottom:10px;filter:drop-shadow(0 3px 8px var(--card-glow,rgba(0,0,0,.1)));transition:transform .3s cubic-bezier(.4,0,.2,1),filter .3s;will-change:transform}
    .ldsp-ldc-support-card:hover .ldsp-ldc-support-icon{animation:ldsp-icon-breath 1.8s cubic-bezier(.45,.05,.55,.95) infinite}
    @keyframes ldsp-icon-breath{0%,100%{transform:scale(1.12) translateY(-2px)}50%{transform:scale(1.18) translateY(-4px)}}
    .ldsp-ldc-support-name{font-size:12px;font-weight:600;color:var(--txt);margin-bottom:8px;transition:color .3s;letter-spacing:.3px}
    .ldsp-ldc-support-card:hover .ldsp-ldc-support-name{color:var(--card-accent,var(--txt))}
    .ldsp-ldc-support-amount{font-size:20px;font-weight:700;color:var(--card-accent,var(--accent));display:flex;align-items:baseline;gap:4px;text-shadow:0 1px 2px var(--card-glow,transparent)}
    .ldsp-ldc-support-amount span{font-size:11px;font-weight:500;color:var(--txt-mut);text-shadow:none}
    .ldsp-ldc-support-badge{position:absolute;top:8px;right:8px;padding:3px 8px;background:linear-gradient(135deg,var(--card-accent,var(--accent)),color-mix(in srgb,var(--card-accent,var(--accent)) 70%,#000));color:#fff;font-size:9px;font-weight:600;border-radius:10px;box-shadow:0 2px 8px var(--card-glow,rgba(0,0,0,.2));animation:ldsp-badge-float 3s ease-in-out infinite;transform-origin:center center;transition:all .2s cubic-bezier(.4,0,.2,1)}
    .ldsp-ldc-support-card:hover .ldsp-ldc-support-badge{animation:ldsp-badge-wiggle .5s ease-in-out;transform:scale(1.1);box-shadow:0 4px 12px var(--card-glow,rgba(0,0,0,.3))}
    @keyframes ldsp-badge-float{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-2px) rotate(2deg)}75%{transform:translateY(1px) rotate(-1deg)}}
    @keyframes ldsp-badge-wiggle{0%{transform:scale(1.1) rotate(0deg)}15%{transform:scale(1.15) rotate(-12deg)}30%{transform:scale(1.12) rotate(10deg)}45%{transform:scale(1.15) rotate(-8deg)}60%{transform:scale(1.12) rotate(6deg)}75%{transform:scale(1.13) rotate(-3deg)}100%{transform:scale(1.1) rotate(0deg)}}
    .ldsp-ldc-support-footer{text-align:center;padding:12px;background:linear-gradient(135deg,var(--bg-card),var(--bg-el));border:1px solid var(--border);border-radius:var(--r-md)}
    .ldsp-ldc-support-footer-text{font-size:10px;color:var(--txt-mut);line-height:1.7}
    .ldsp-ldc-support-footer-text em{font-style:normal;color:var(--accent);font-weight:600}
    .ldsp-ldc-support-heart{display:inline-block;animation:ldsp-heartbeat 1.2s ease-in-out infinite;filter:drop-shadow(0 0 4px rgba(239,68,68,.4))}
    @keyframes ldsp-heartbeat{0%,100%{transform:scale(1)}14%{transform:scale(1.2)}28%{transform:scale(1)}42%{transform:scale(1.15)}70%{transform:scale(1)}}
    /* GitHub Star å¡ç‰‡ - æ·±è‰²æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ */
    .ldsp-github-star-card{display:flex;align-items:center;gap:14px;padding:14px 16px;background:linear-gradient(135deg,#161b22 0%,#0d1117 100%);border:1px solid #30363d;border-radius:var(--r-md);cursor:pointer;text-decoration:none;transition:all .25s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
    .ldsp-github-star-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(88,166,255,.1) 0%,rgba(255,215,0,.1) 100%);opacity:0;transition:opacity .25s}
    .ldsp-github-star-card:hover{border-color:#58a6ff;transform:translateY(-2px);box-shadow:0 8px 24px rgba(88,166,255,.2)}
    .ldsp-github-star-card:hover::before{opacity:1}
    .ldsp-github-star-card:hover .ldsp-github-icon{transform:rotate(-8deg) scale(1.08)}
    .ldsp-github-star-card:hover .ldsp-github-star-icon{animation:ldsp-star-bounce .6s ease-in-out}
    .ldsp-github-icon-wrap{flex-shrink:0;width:36px;height:36px;display:flex;align-items:center;justify-content:center}
    .ldsp-github-icon{width:32px;height:32px;fill:#f0f6fc;transition:all .25s}
    .ldsp-github-star-icon{font-size:16px;line-height:1;filter:drop-shadow(0 0 4px rgba(255,215,0,.4))}
    .ldsp-github-content{flex:1;min-width:0;position:relative;z-index:1}
    .ldsp-github-title{font-size:13px;font-weight:600;color:#f0f6fc;margin-bottom:3px;display:flex;align-items:center;gap:6px}
    .ldsp-github-desc{font-size:10px;color:#8b949e;line-height:1.5}
    .ldsp-github-arrow{flex-shrink:0;font-size:16px;color:#58a6ff;transition:all .25s;opacity:.7}
    .ldsp-github-star-card:hover .ldsp-github-arrow{transform:translateX(4px);opacity:1}
    @keyframes ldsp-star-bounce{0%,100%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.3) rotate(-15deg)}50%{transform:scale(1) rotate(10deg)}75%{transform:scale(1.15) rotate(-5deg)}}
    /* GitHub Star å¡ç‰‡ - æµ…è‰²æ¨¡å¼ */
    #ldsp-panel.light .ldsp-github-star-card{background:linear-gradient(135deg,#ffffff 0%,#f6f8fa 100%);border-color:#d0d7de}
    #ldsp-panel.light .ldsp-github-star-card:hover{border-color:#0969da;box-shadow:0 8px 24px rgba(9,105,218,.15)}
    #ldsp-panel.light .ldsp-github-star-card::before{background:linear-gradient(135deg,rgba(88,166,255,.08) 0%,rgba(255,215,0,.08) 100%)}
    #ldsp-panel.light .ldsp-github-icon{fill:#24292f}
    #ldsp-panel.light .ldsp-github-title{color:#24292f}
    #ldsp-panel.light .ldsp-github-desc{color:#656d76}
    #ldsp-panel.light .ldsp-github-arrow{color:#0969da}
    #ldsp-panel.light .ldsp-github-star-icon{filter:drop-shadow(0 1px 2px rgba(0,0,0,.1))}
    /* äº¤æ˜“è®°å½• */
    /* äº¤æ˜“ç­›é€‰å™¨ */
    .ldsp-ldc-filter-section{display:flex;flex-direction:column;gap:8px;padding-bottom:10px;border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-ldc-filter-row{display:flex;align-items:flex-start;gap:8px}
    .ldsp-ldc-filter-label{font-size:10px;color:var(--txt-mut);min-width:28px;padding-top:5px;flex-shrink:0}
    .ldsp-ldc-filter-chips{display:flex;gap:5px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
    .ldsp-ldc-filter-chips::-webkit-scrollbar{display:none}
    .ldsp-ldc-filter-chips-wrap{flex-wrap:wrap}
    .ldsp-ldc-filter-chip{padding:5px 10px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0;-webkit-tap-highlight-color:transparent}
    .ldsp-ldc-filter-chip:hover{border-color:var(--txt-mut);color:var(--txt)}
    .ldsp-ldc-filter-chip.active{background:rgba(107,140,239,.12);border-color:var(--accent);color:var(--accent);font-weight:600}
    /* äº¤æ˜“åˆ—è¡¨ */
    .ldsp-ldc-trans-content{display:flex;flex-direction:column;gap:8px;flex:1;min-height:0}
    .ldsp-ldc-trans-summary{font-size:10px;color:var(--txt-mut)}
    .ldsp-ldc-trans-list{display:flex;flex-direction:column;gap:6px;overflow-y:auto;flex:1;min-height:120px}
    .ldsp-ldc-trans-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .15s;-webkit-tap-highlight-color:transparent;flex-shrink:0}
    .ldsp-ldc-trans-item:hover{border-color:var(--accent);background:var(--bg-hover)}
    .ldsp-ldc-trans-item:active{transform:scale(.98)}
    .ldsp-ldc-trans-icon{font-size:16px;flex-shrink:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border-radius:6px}
    .ldsp-ldc-trans-info{flex:1;min-width:0}
    .ldsp-ldc-trans-name{font-size:12px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-ldc-trans-meta{font-size:10px;color:var(--txt-mut);margin-top:2px;display:flex;gap:6px;align-items:center}
    .ldsp-ldc-trans-type{padding:2px 6px;border-radius:3px;font-size:9px;font-weight:500}
    /* äº¤æ˜“ç±»å‹é¢œè‰² - æ”¶ç›Šç»¿/æ¶ˆè€—çº¢/è½¬ç§»è“/ç¤¾åŒºç´«/åœ¨çº¿é’ */
    .ldsp-ldc-trans-type.type-receive{background:rgba(74,222,128,.15);color:#22c55e}
    .ldsp-ldc-trans-type.type-payment{background:rgba(248,113,113,.15);color:#ef4444}
    .ldsp-ldc-trans-type.type-transfer{background:rgba(96,165,250,.15);color:#3b82f6}
    .ldsp-ldc-trans-type.type-community{background:rgba(192,132,252,.15);color:#a855f7}
    .ldsp-ldc-trans-type.type-online{background:rgba(45,212,191,.15);color:#14b8a6}
    .ldsp-ldc-trans-type.type-default{background:var(--bg-el);color:var(--txt-sec)}
    .ldsp-ldc-trans-amount{font-size:14px;font-weight:700;flex-shrink:0}
    .ldsp-ldc-trans-amount.income{color:var(--ok)}
    .ldsp-ldc-trans-amount.expense{color:var(--err)}
    .ldsp-ldc-load-more{width:100%;padding:10px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-md);font-size:11px;font-weight:600;color:var(--txt-sec);cursor:pointer;transition:all .15s;flex-shrink:0;display:flex;align-items:center;justify-content:center;gap:6px}
    .ldsp-ldc-load-more:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-ldc-load-more:disabled{opacity:.6;cursor:not-allowed}
    .ldsp-ldc-load-more.loading{pointer-events:none}
    .ldsp-ldc-load-sentinel{width:100%;min-height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .ldsp-ldc-loading-more{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;font-size:11px;color:var(--txt-mut)}
    .ldsp-ldc-empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;flex:1;background:var(--bg-card);border:1px dashed var(--border);border-radius:var(--r-md)}
    .ldsp-ldc-empty-icon{font-size:36px;margin-bottom:10px;opacity:.8}
    .ldsp-ldc-empty-text{font-size:12px;color:var(--txt-mut);text-align:center}
    .ldsp-ldc-empty-hint{font-size:10px;color:var(--txt-mut);margin-top:6px;opacity:.7}
    /* äº¤æ˜“è¯¦æƒ… */
    .ldsp-ldc-detail{display:flex;flex-direction:column;gap:12px}
    .ldsp-ldc-detail-header{display:flex;align-items:center;gap:10px;padding-bottom:10px;border-bottom:1px solid var(--border)}
    .ldsp-ldc-back-btn{padding:6px 10px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-ldc-back-btn:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-ldc-detail-header span{font-size:13px;font-weight:600;color:var(--txt)}
    .ldsp-ldc-detail-amount{text-align:center;padding:16px;border-radius:var(--r-md)}
    .ldsp-ldc-detail-amount.income-bg{background:linear-gradient(135deg,rgba(74,222,128,.08),rgba(34,197,94,.12));border:1px solid rgba(74,222,128,.2)}
    .ldsp-ldc-detail-amount.expense-bg{background:linear-gradient(135deg,rgba(248,113,113,.08),rgba(239,68,68,.12));border:1px solid rgba(248,113,113,.2)}
    .ldsp-ldc-detail-amount-value{font-size:28px;font-weight:700}
    .ldsp-ldc-detail-amount-value.income{color:var(--ok)}
    .ldsp-ldc-detail-amount-value.expense{color:var(--err)}
    .ldsp-ldc-detail-amount-label{font-size:11px;color:var(--txt-mut);margin-top:4px}
    .ldsp-ldc-detail-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);overflow:hidden}
    .ldsp-ldc-detail-row{display:flex;justify-content:space-between;align-items:flex-start;padding:10px 12px;border-bottom:1px solid var(--border)}
    .ldsp-ldc-detail-row:last-child{border-bottom:none}
    .ldsp-ldc-detail-row .label{font-size:11px;color:var(--txt-mut);flex-shrink:0}
    .ldsp-ldc-detail-row .value{font-size:11px;color:var(--txt);text-align:right;word-break:break-all;margin-left:10px}
    .ldsp-ldc-detail-row .value.mono{font-family:monospace;font-size:10px}
    .ldsp-ldc-detail-row .value.status-success{color:var(--ok);font-weight:600}
    .ldsp-ldc-detail-row .value.link{color:var(--accent);text-decoration:none;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block}
    .ldsp-ldc-detail-row .value.link:hover{text-decoration:underline}
    /* å°å–éƒ¨æ ·å¼ */
    .ldsp-shop{display:flex;flex-direction:column;gap:10px;flex:1;min-height:0}
    .ldsp-shop-header{display:flex;align-items:center;justify-content:space-between;gap:6px;flex-shrink:0}
    .ldsp-shop-tabs{display:flex;gap:3px;flex:1;min-width:0}
    .ldsp-shop-tab{padding:5px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;font-weight:600;color:var(--txt-sec);cursor:pointer;transition:all .15s;white-space:nowrap;flex:1;text-align:center;min-width:0}
    .ldsp-shop-tab:hover{border-color:var(--txt-mut);color:var(--txt)}
    .ldsp-shop-tab.active{background:rgba(107,140,239,.12);border-color:var(--accent);color:var(--accent)}
    .ldsp-shop-add-btn{padding:6px 12px;background:var(--grad);border:none;border-radius:var(--r-sm);font-size:10px;font-weight:600;color:#fff;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:4px}
    .ldsp-shop-add-btn:hover{opacity:.9;transform:translateY(-1px)}
    .ldsp-shop-filter{display:flex;gap:6px;flex-wrap:wrap;padding:8px 0;flex-shrink:0;border-bottom:1px solid var(--border);margin-bottom:4px}
    .ldsp-shop-filter-chip{padding:5px 10px;background:var(--bg-el);border:1px solid var(--border);border-radius:999px;font-size:10px;color:var(--txt-sec);cursor:pointer;transition:all .15s;white-space:nowrap}
    .ldsp-shop-filter-chip:hover{border-color:var(--txt-mut);color:var(--txt);background:var(--bg-hover)}
    .ldsp-shop-filter-chip.active{background:rgba(107,140,239,.15);border-color:var(--accent);color:var(--accent);font-weight:600}
    .ldsp-shop-count{font-size:10px;color:var(--txt-mut);padding:4px 0 6px;flex-shrink:0}
    .ldsp-shop-count strong{color:var(--accent);font-weight:600}
    .ldsp-shop-grid{display:flex;flex-wrap:wrap;gap:8px;overflow-y:auto;flex:1;min-height:0;padding-bottom:4px;align-content:flex-start}
    .ldsp-shop-load-sentinel{width:100%;flex-shrink:0;min-height:20px}
    .ldsp-shop-loading-more{width:100%;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 0;color:var(--txt-sec);font-size:11px}
    .ldsp-shop-loading-more .ldsp-spinner{width:16px;height:16px;border-width:2px}
    .ldsp-shop-load-more-hint{width:100%;text-align:center;padding:8px 0;color:var(--txt-mut);font-size:10px}
    .ldsp-shop-loaded-all{width:100%;text-align:center;padding:10px 0;color:var(--txt-mut);font-size:10px}
    .ldsp-shop-no-more{width:100%;text-align:center;padding:12px 0;color:var(--txt-mut);font-size:10px}
    .ldsp-shop-card{width:calc(50% - 4px);background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);overflow:hidden;cursor:pointer;transition:all .2s;position:relative;box-sizing:border-box}
    .ldsp-shop-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .ldsp-shop-card-cover{width:100%;height:70px;display:flex;align-items:center;justify-content:center;font-size:28px;overflow:hidden}
    .ldsp-shop-card-cover img{width:100%;height:100%;object-fit:cover}
    .ldsp-shop-card-body{padding:8px;display:flex;flex-direction:column;gap:4px}
    .ldsp-shop-card-name{font-size:11px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-shop-card-meta{display:flex;align-items:center;gap:6px}
    .ldsp-shop-card-category{font-size:8px;color:#fff;padding:2px 5px;background:linear-gradient(135deg,var(--accent),#8b5cf6);border-radius:3px;font-weight:500}
    .ldsp-shop-card-time{font-size:8px;color:var(--txt-mut);margin-left:auto}
    .ldsp-shop-card-seller{font-size:9px;color:var(--txt-sec);display:flex;align-items:center;gap:3px;overflow:hidden}
    .ldsp-shop-card-seller-avatar{width:14px;height:14px;border-radius:50%;background:var(--bg-el);flex-shrink:0;object-fit:cover}
    .ldsp-shop-card-seller-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-shop-card-sold{margin-left:auto;font-size:8px;color:#f97316;font-weight:600;flex-shrink:0}
    .ldsp-shop-card-footer{display:flex;justify-content:space-between;align-items:center;padding-top:6px;border-top:1px solid var(--border)}
    .ldsp-shop-card-price{font-size:13px;font-weight:700;color:var(--accent);display:flex;align-items:baseline;gap:1px}
    .ldsp-shop-card-price span{font-size:8px;font-weight:500;color:var(--txt-mut)}
    .ldsp-shop-card-price.discounted{color:var(--ok)}
    .ldsp-shop-card-original{font-size:8px;color:var(--txt-mut);text-decoration:line-through;margin-left:3px;opacity:.7}
    .ldsp-shop-card-discount{position:absolute;top:5px;left:4px;min-width:34px;height:28px;padding:0 5px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;color:#fff;background:linear-gradient(135deg,rgba(255,75,75,.88),rgba(235,60,60,.82));border-radius:14px;box-shadow:0 2px 6px rgba(235,60,60,.3);z-index:3;transform:rotate(-8deg);text-shadow:0 1px 1px rgba(0,0,0,.15);letter-spacing:-.2px}
    .ldsp-shop-card-discount::before{content:'';position:absolute;inset:-3px;background:linear-gradient(135deg,rgba(255,90,90,.6),rgba(235,60,60,.45));border-radius:17px;clip-path:polygon(8% 35%,0% 50%,8% 65%,20% 85%,35% 95%,50% 100%,65% 95%,80% 85%,92% 65%,100% 50%,92% 35%,80% 15%,65% 5%,50% 0%,35% 5%,20% 15%);z-index:-1}
    .ldsp-shop-card-discount::after{content:'';position:absolute;top:4px;left:7px;width:10px;height:5px;background:linear-gradient(180deg,rgba(255,255,255,.3),transparent);border-radius:50%;transform:rotate(-15deg)}
    .ldsp-shop-card-views{font-size:8px;color:var(--txt-mut)}
    .ldsp-shop-card-status{position:absolute;top:6px;left:6px;padding:2px 6px;font-size:9px;font-weight:600;border-radius:4px}
    .ldsp-shop-card-status.active{background:rgba(34,197,94,.15);color:#22c55e}
    .ldsp-shop-card-status.inactive{background:rgba(239,68,68,.15);color:#ef4444}
    .ldsp-shop-load-more{width:100%;padding:12px;text-align:center;font-size:11px;color:var(--txt-mut);cursor:pointer;transition:color .15s}
    .ldsp-shop-load-more:hover{color:var(--accent)}
    .ldsp-shop-load-more.loading{pointer-events:none;opacity:.6}
    .ldsp-shop-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;flex:1;text-align:center}
    .ldsp-shop-empty-icon{font-size:40px;margin-bottom:10px;opacity:.7}
    .ldsp-shop-empty-text{font-size:12px;color:var(--txt-mut);margin-bottom:6px}
    .ldsp-shop-empty-hint{font-size:10px;color:var(--txt-mut);opacity:.7}
    /* å°å–éƒ¨è¯¦æƒ…é¡µ */
    .ldsp-shop-detail{display:flex;flex-direction:column;gap:10px;flex:1;min-height:0;overflow-y:auto;padding-bottom:4px}
    .ldsp-shop-detail-header{display:flex;align-items:center;gap:8px;flex-shrink:0}
    .ldsp-shop-back-btn{padding:5px 10px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt-sec);cursor:pointer;transition:all .15s;flex-shrink:0}
    .ldsp-shop-back-btn:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-shop-detail-category{font-size:9px;color:#fff;padding:2px 8px;background:linear-gradient(135deg,var(--accent),#8b5cf6);border-radius:4px;font-weight:500}
    .ldsp-shop-detail-img-wrap{width:100%;aspect-ratio:16/9;max-height:180px;flex-shrink:0;position:relative;border-radius:var(--r-md);overflow:hidden}
    .ldsp-shop-detail-img{width:100%;height:100%;object-fit:cover;background:var(--bg-el)}
    .ldsp-shop-detail-placeholder{width:100%;height:100%;max-height:120px;display:flex;align-items:center;justify-content:center;font-size:36px;background:linear-gradient(135deg,var(--bg-el),var(--bg-card))}
    .ldsp-shop-detail-content{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px 14px}
    .ldsp-shop-detail-name{font-size:15px;font-weight:700;color:var(--txt);margin-bottom:8px;line-height:1.4}
    .ldsp-shop-detail-desc{font-size:11px;color:var(--txt-sec);line-height:1.6;white-space:pre-wrap;word-break:break-word;max-height:100px;overflow-y:auto}
    .ldsp-shop-detail-desc.store-desc{max-height:160px;font-size:12px;line-height:1.7;color:var(--txt);padding:10px 12px;background:var(--bg-el);border-radius:var(--r-sm);margin-top:8px}
    .ldsp-shop-detail-store-owner{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--txt-sec);padding:6px 10px;background:linear-gradient(135deg,rgba(6,182,212,.08),rgba(8,145,178,.05));border:1px solid rgba(6,182,212,.15);border-radius:var(--r-sm);margin-bottom:4px}
    .ldsp-shop-detail-store-owner span{font-weight:600;color:#06b6d4}
    .ldsp-shop-detail.store-detail .ldsp-shop-detail-content{padding:14px 16px}
    .ldsp-shop-detail-price-row{display:flex;align-items:center;gap:6px;padding:10px 12px;background:linear-gradient(135deg,rgba(107,140,239,.1),rgba(139,92,246,.08));border:1px solid rgba(107,140,239,.2);border-radius:var(--r-md)}
    .ldsp-shop-detail-price{font-size:20px;font-weight:700;color:var(--accent)}
    .ldsp-shop-detail-price span{font-size:10px;font-weight:500;color:var(--txt-mut);margin-left:2px}
    .ldsp-shop-detail-price.discounted{color:#22c55e}
    .ldsp-shop-detail-original{font-size:11px;color:var(--txt-mut);text-decoration:line-through}
    .ldsp-shop-detail-discount-badge{padding:2px 6px;background:linear-gradient(135deg,var(--err),#f43f5e);color:#fff;font-size:9px;font-weight:600;border-radius:3px;margin-left:auto}
    .ldsp-shop-detail-info{display:flex;flex-wrap:wrap;gap:6px;font-size:9px;color:var(--txt-mut)}
    .ldsp-shop-detail-info-item{display:flex;align-items:center;gap:3px;padding:3px 6px;background:var(--bg-el);border-radius:var(--r-sm)}
    .ldsp-shop-detail-info-item.stock{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);font-weight:600}
    .ldsp-shop-detail-info-item.stock .available{color:#22c55e;font-weight:700}
    .ldsp-shop-detail-info-item.stock .total{color:var(--txt-mut)}
    .ldsp-shop-detail-info-item.stock.low{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2)}
    .ldsp-shop-detail-info-item.stock.low .available{color:#ef4444}
    .ldsp-shop-detail-info-item.sold{background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.2);color:#fb923c}
    .ldsp-shop-seller{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .15s}
    .ldsp-shop-seller:hover{border-color:var(--accent);background:var(--bg-hover)}
    .ldsp-shop-seller-avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--bg-el);object-fit:cover}
    .ldsp-shop-seller-info{flex:1;min-width:0}
    .ldsp-shop-seller-name{font-size:11px;font-weight:600;color:var(--txt)}
    .ldsp-shop-seller-label{font-size:8px;color:var(--txt-mut)}
    .ldsp-shop-seller-arrow{font-size:12px;color:var(--txt-mut);transition:transform .15s}
    .ldsp-shop-seller:hover .ldsp-shop-seller-arrow{transform:translateX(3px);color:var(--accent)}
    .ldsp-shop-purchase-action{padding:10px;background:#4f7cef !important;border:none !important;border-radius:var(--r-md);font-size:13px !important;font-weight:600 !important;color:#fff !important;cursor:pointer;transition:all .2s;display:block;text-align:center;flex-shrink:0;text-decoration:none !important;box-sizing:border-box}
    .ldsp-shop-purchase-action:hover{background:#3d6be0 !important;box-shadow:0 4px 12px rgba(79,124,239,.35);color:#fff !important}
    /* å°å–éƒ¨è¡¨å• */
    .ldsp-shop-form{display:flex;flex-direction:column;gap:12px;flex:1;min-height:0;overflow-y:auto}
    .ldsp-shop-form-header{display:flex;align-items:center;gap:10px;flex-shrink:0}
    .ldsp-shop-form-title{font-size:14px;font-weight:700;color:var(--txt)}
    .ldsp-shop-form-group{display:flex;flex-direction:column;gap:4px}
    .ldsp-shop-form-label{font-size:10px;font-weight:600;color:var(--txt-sec);display:flex;align-items:center;gap:4px}
    .ldsp-shop-form-label .required{color:var(--err)}
    .ldsp-shop-form-input{padding:10px 12px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:12px;color:var(--txt);transition:border-color .15s;width:100%;box-sizing:border-box}
    .ldsp-shop-form-input:focus{border-color:var(--accent);outline:none}
    .ldsp-shop-form-input::placeholder{color:var(--txt-mut)}
    .ldsp-shop-form-textarea{min-height:80px;resize:vertical;font-family:inherit;line-height:1.5}
    .ldsp-shop-form-select{padding:10px 12px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:12px;color:var(--txt);cursor:pointer;width:100%;box-sizing:border-box}
    .ldsp-shop-form-select:focus{border-color:var(--accent);outline:none}
    .ldsp-shop-form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .ldsp-shop-form-hint{font-size:9px;color:var(--txt-mut);margin-top:2px}
    .ldsp-shop-form-hint-selectable{user-select:text!important;-webkit-user-select:text!important}
    .ldsp-shop-form-hint a{color:var(--link);text-decoration:underline;user-select:text!important}
    .ldsp-shop-form-optional{font-size:9px;font-weight:400;color:var(--txt-mut)}
    .ldsp-shop-form-actions{display:flex;gap:8px;margin-top:auto;padding-top:10px;flex-shrink:0}
    .ldsp-shop-form-btn{flex:1;padding:10px;border:none;border-radius:var(--r-sm);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
    .ldsp-shop-form-btn.primary{background:var(--grad);color:#fff}
    .ldsp-shop-form-btn.primary:hover{opacity:.9}
    .ldsp-shop-form-btn.secondary{background:var(--bg-el);color:var(--txt-sec);border:1px solid var(--border)}
    .ldsp-shop-form-btn.secondary:hover{border-color:var(--txt-mut);color:var(--txt)}
    .ldsp-shop-form-btn:disabled{opacity:.5;cursor:not-allowed}
    /* Shop v2.0 å•†å“ç±»å‹é€‰æ‹© */
    .ldsp-shop-form-types{display:flex;gap:8px}
    .ldsp-shop-type-option{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 8px;background:var(--bg-el);border:2px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .2s}
    .ldsp-shop-type-option:hover{border-color:var(--txt-mut);background:var(--bg-hover)}
    .ldsp-shop-type-option.active{border-color:var(--accent);background:rgba(107,140,239,.08)}
    .ldsp-shop-type-option input{display:none}
    .ldsp-shop-type-icon{font-size:20px;margin-bottom:4px}
    .ldsp-shop-type-name{font-size:11px;font-weight:600;color:var(--txt)}
    .ldsp-shop-type-desc{font-size:9px;color:var(--txt-mut);text-align:center}
    .ldsp-shop-type-link.hidden,.ldsp-shop-type-cdk.hidden{display:none}
    .ldsp-shop-cdk-notice{display:flex;gap:8px;padding:10px;background:linear-gradient(135deg,rgba(234,179,8,.08),rgba(245,158,11,.05));border:1px solid rgba(234,179,8,.2);border-radius:var(--r-sm)}
    .ldsp-shop-cdk-notice-icon{font-size:18px;flex-shrink:0}
    .ldsp-shop-cdk-notice-text{font-size:10px;color:var(--txt-sec);line-height:1.5}
    .ldsp-shop-cdk-notice-text p{margin:0 0 4px}
    .ldsp-shop-cdk-notice-text p:last-child{margin-bottom:0}
    .ldsp-shop-cdk-notice-text strong{color:var(--accent);font-weight:600}
    /* Shop v2.0 CDK ç±»å‹æ ‡ç­¾å’Œåº“å­˜ */
    .ldsp-shop-card-type{position:absolute;top:0;right:0;padding:4px 8px;font-size:9px;font-weight:700;border-radius:0 var(--r-md) 0 8px;z-index:2;letter-spacing:.5px;text-transform:uppercase}
    .ldsp-shop-card-type.cdk{background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:#1c1917;box-shadow:0 2px 8px rgba(251,191,36,.4)}
    .ldsp-shop-card-type.store{background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%);color:#fff;box-shadow:0 2px 8px rgba(6,182,212,.4)}
    /* å°åº—ç‰¹æ®Šå¡ç‰‡æ ·å¼ */
    .ldsp-shop-card.store-card{border-color:rgba(6,182,212,.3)}
    .ldsp-shop-card.store-card:hover{border-color:#06b6d4}
    .ldsp-shop-card.store-card .ldsp-shop-card-footer{border-top:none;padding-top:0}
    .ldsp-shop-card-store-owner{font-size:10px;color:var(--txt-sec);font-weight:500;display:flex;align-items:center;gap:2px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-shop-card-stock{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2)}
    .ldsp-shop-card-stock .available{color:#22c55e;font-weight:700}
    .ldsp-shop-card-stock .divider{color:var(--txt-mut);font-weight:400}
    .ldsp-shop-card-stock .total{color:var(--txt-mut);font-weight:500}
    .ldsp-shop-card-stock.low{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2)}
    .ldsp-shop-card-stock.low .available{color:#ef4444}
    .ldsp-shop-card-stock.out{background:rgba(107,114,128,.1);border-color:rgba(107,114,128,.2)}
    .ldsp-shop-card-stock.out .available{color:#6b7280}
    .ldsp-shop-card.out-of-stock{opacity:.6;filter:grayscale(.3)}
    .ldsp-shop-card.out-of-stock::after{content:'å·²å”®ç½„';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:6px 16px;background:rgba(0,0,0,.7);color:#fff;font-size:12px;font-weight:700;border-radius:20px;z-index:5}
    .ldsp-shop-detail-type-badge{padding:4px 10px;font-size:10px;font-weight:700;border-radius:6px;margin-left:auto;letter-spacing:.5px}
    .ldsp-shop-detail-type-badge.cdk{background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:#1c1917;box-shadow:0 2px 6px rgba(251,191,36,.3)}
    .ldsp-shop-detail-type-badge.store{background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%);color:#fff;box-shadow:0 2px 6px rgba(6,182,212,.3)}
    /* Shop v2.0 è®¢å•åˆ—è¡¨æ ·å¼ */
    .ldsp-order-list{display:flex;flex-direction:column;gap:10px;overflow-y:auto;flex:1;min-height:0;padding:2px}
    .ldsp-order-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px;cursor:pointer;transition:all .2s}
    .ldsp-order-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .ldsp-order-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .ldsp-order-card-id{font-size:11px;color:var(--txt-mut);font-family:monospace}
    .ldsp-order-status{padding:3px 8px;font-size:9px;font-weight:600;border-radius:4px}
    .ldsp-order-status.pending{background:rgba(234,179,8,.15);color:#eab308}
    .ldsp-order-status.paid{background:rgba(59,130,246,.15);color:#3b82f6}
    .ldsp-order-status.delivered{background:rgba(34,197,94,.15);color:#22c55e}
    .ldsp-order-status.cancelled{background:rgba(107,114,128,.15);color:#6b7280}
    .ldsp-order-status.refunded{background:rgba(239,68,68,.15);color:#ef4444}
    .ldsp-order-status.expired{background:rgba(156,163,175,.15);color:#9ca3af}
    .ldsp-order-product{display:flex;gap:10px;align-items:center}
    .ldsp-order-product-img{width:48px;height:48px;object-fit:cover;border-radius:var(--r-sm);background:var(--bg-el)}
    .ldsp-order-product-img-placeholder{width:48px;height:48px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:18px;background:var(--bg-el)}
    .ldsp-order-product-info{flex:1;min-width:0}
    .ldsp-order-product-name{font-size:13px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-order-product-seller{font-size:10px;color:var(--txt-mut);margin-top:2px}
    .ldsp-order-product-price{font-size:14px;font-weight:700;color:var(--accent);white-space:nowrap}
    .ldsp-order-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px dashed var(--border)}
    .ldsp-order-card-time{font-size:10px;color:var(--txt-mut)}
    .ldsp-order-card-actions{display:flex;gap:6px}
    .ldsp-order-btn{padding:5px 12px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;transition:all .15s}
    .ldsp-order-btn:hover{border-color:var(--accent);color:var(--accent)}
    .ldsp-order-btn.primary{border-color:var(--accent);background:var(--accent);color:#fff}
    .ldsp-order-btn.primary:hover{filter:brightness(1.1)}
    .ldsp-order-btn.danger{border-color:var(--err);color:var(--err)}
    .ldsp-order-btn.danger:hover{background:var(--err);color:#fff}
    .ldsp-order-btn:disabled{opacity:.6;cursor:not-allowed}
    .ldsp-order-no{font-size:10px;color:var(--txt-mut);font-family:monospace}
    .ldsp-order-card-body{display:flex;flex-direction:column;gap:8px}
    .ldsp-order-quantity{font-size:11px;color:var(--txt-mut);margin-left:auto}
    .ldsp-order-info{display:flex;justify-content:space-between;font-size:10px;color:var(--txt-mut)}
    .ldsp-order-footer{display:flex;justify-content:space-between;align-items:center;padding-top:8px;margin-top:4px;border-top:1px dashed var(--border)}
    .ldsp-order-amount{font-size:13px;font-weight:600;color:var(--accent)}
    .ldsp-order-actions{display:flex;gap:6px}
    .ldsp-order-back-btn{padding:6px 12px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;transition:all .15s}
    .ldsp-order-back-btn:hover{border-color:var(--accent);color:var(--accent)}
    .ldsp-order-detail-status{padding:8px 12px;border-radius:var(--r-md);border:1px solid;text-align:center;font-size:12px;font-weight:600}
    .ldsp-order-detail-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px 12px;overflow:hidden}
    .ldsp-order-logs{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px;display:flex;flex-direction:column;gap:8px;max-height:150px;overflow-y:auto}
    .ldsp-order-logs-title{font-size:11px;font-weight:600;color:var(--txt-sec);padding-bottom:8px;border-bottom:1px dashed var(--border)}
    .ldsp-order-log-item{display:flex;justify-content:space-between;font-size:10px;color:var(--txt-mut)}
    .ldsp-order-log-action{color:var(--txt)}
    .ldsp-order-copy-btn{padding:8px 16px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;margin-top:10px;transition:all .15s}
    .ldsp-order-copy-btn:hover{border-color:var(--accent);color:var(--accent)}
    .ldsp-order-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:12px;color:var(--txt-mut)}
    .ldsp-order-empty-icon{font-size:40px;opacity:.5}
    .ldsp-order-empty-text{font-size:12px}
    /* Shop v2.0 è®¢å•è¯¦æƒ…é¡µ - é‡æ„ä¼˜åŒ– */
    .ldsp-order-detail{display:flex;flex-direction:column;gap:8px;padding:0;overflow:hidden}
    .ldsp-order-detail-header{display:flex;align-items:center;gap:8px;padding-bottom:4px}
    .ldsp-order-detail-header>span{flex:1;text-align:center;font-size:13px;font-weight:600}
    .ldsp-order-detail-id{font-size:11px;color:var(--txt-mut);font-family:monospace}
    .ldsp-order-detail-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px;display:flex;flex-direction:column;gap:8px}
    .ldsp-order-detail-section-title{font-size:11px;font-weight:600;color:var(--txt-sec);padding-bottom:6px;border-bottom:1px dashed var(--border);display:flex;align-items:center;gap:6px}
    .ldsp-order-detail-product{display:flex;gap:10px;align-items:center}
    .ldsp-order-detail-product-img{width:56px;height:56px;object-fit:cover;border-radius:var(--r-sm);background:var(--bg-el);flex-shrink:0}
    .ldsp-order-detail-product-img-placeholder{width:56px;height:56px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--bg-el);flex-shrink:0}
    .ldsp-order-detail-product-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:3px;overflow:hidden}
    .ldsp-order-detail-product-name{font-size:13px;font-weight:600;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ldsp-order-detail-product-seller{font-size:10px;color:var(--txt-mut)}
    .ldsp-order-detail-row{display:flex;justify-content:space-between;align-items:flex-start;padding:4px 0;gap:8px;border-bottom:1px dashed var(--border)}
    .ldsp-order-detail-row:last-child{border-bottom:none}
    .ldsp-order-detail-row .label{font-size:10px;color:var(--txt-mut);white-space:nowrap;flex-shrink:0;min-width:40px}
    .ldsp-order-detail-row .value{font-size:10px;color:var(--txt);font-weight:500;text-align:right;word-break:break-all;min-width:0;flex:1;overflow:hidden;text-overflow:ellipsis}
    .ldsp-order-detail-row .value.mono{font-family:monospace;font-size:9px;letter-spacing:-.3px}
    .ldsp-order-detail-row .value.price{font-size:13px;font-weight:700;color:var(--accent)}
    .ldsp-order-detail-row .value.status{padding:2px 6px;font-size:9px;font-weight:600;border-radius:3px}
    .ldsp-order-cdk-section{background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.02));border:1px solid rgba(34,197,94,.25);border-radius:var(--r-md);padding:10px}
    .ldsp-order-cdk-title{font-size:11px;font-weight:600;color:#22c55e;margin-bottom:6px;display:flex;align-items:center;gap:4px}
    .ldsp-order-cdk-content{background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);padding:8px 10px;font-size:11px;font-family:monospace;word-break:break-all;white-space:pre-wrap;line-height:1.5;max-height:100px;overflow-y:auto;color:var(--txt)}
    .ldsp-order-cdk-value{font-size:11px;font-family:monospace;color:var(--txt);word-break:break-all;white-space:pre-wrap;line-height:1.5}
    .ldsp-order-cdk-copy{position:absolute;top:6px;right:6px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);cursor:pointer;font-size:11px;transition:all .15s}
    .ldsp-order-cdk-copy:hover{border-color:var(--accent);color:var(--accent)}
    .ldsp-order-cdk-copy.copied{background:var(--accent);border-color:var(--accent);color:#fff}
    .ldsp-order-cdk-actions{display:flex;gap:6px;margin-top:8px}
    .ldsp-order-cdk-btn{flex:1;padding:6px 10px;border:1px solid rgba(34,197,94,.3);border-radius:var(--r-sm);font-size:10px;font-weight:600;color:#22c55e;background:rgba(34,197,94,.08);cursor:pointer;transition:all .15s;text-align:center}
    .ldsp-order-cdk-btn:hover{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.4)}
    .ldsp-order-cdk-btn.copied{background:#22c55e;border-color:#22c55e;color:#fff}
    .ldsp-order-detail-actions{display:flex;gap:8px;padding-top:12px}
    .ldsp-order-detail-btn{flex:1;padding:10px 16px;border:1px solid var(--border);border-radius:var(--r-md);font-size:12px;font-weight:600;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;transition:all .15s;text-align:center}
    .ldsp-order-detail-btn:hover{border-color:var(--accent);color:var(--accent)}
    .ldsp-order-detail-btn.primary{border-color:var(--accent);background:var(--accent);color:#fff}
    .ldsp-order-detail-btn.primary:hover{filter:brightness(1.1)}
    .ldsp-order-detail-btn.danger{border-color:var(--err);color:var(--err)}
    .ldsp-order-detail-btn.danger:hover{background:var(--err);color:#fff}
    /* Shop v2.0 è®¢å•è§’è‰²åˆ‡æ¢ */
    .ldsp-order-role-tabs{display:flex;gap:0;background:var(--bg-el);border-radius:var(--r-md);padding:3px;margin-bottom:12px}
    .ldsp-order-role-tab{flex:1;padding:8px 12px;font-size:11px;font-weight:500;color:var(--txt-mut);background:transparent;border:none;border-radius:var(--r-sm);cursor:pointer;transition:all .15s;text-align:center}
    .ldsp-order-role-tab.active{background:var(--bg-card);color:var(--txt);box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .ldsp-order-role-tab:hover:not(.active){color:var(--txt-sec)}
    /* Shop v2.0 å‘è´§å¯¹è¯æ¡† */
    .ldsp-deliver-dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100001;display:flex;align-items:center;justify-content:center;padding:20px}
    .ldsp-deliver-dialog{background:var(--bg-card);border-radius:var(--r-lg);width:100%;max-width:360px;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .ldsp-deliver-dialog-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);font-size:14px;font-weight:600;color:var(--txt)}
    .ldsp-deliver-dialog-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;font-size:18px;color:var(--txt-mut);cursor:pointer;border-radius:var(--r-sm)}
    .ldsp-deliver-dialog-close:hover{background:var(--bg-el);color:var(--txt)}
    .ldsp-deliver-dialog-body{padding:16px;display:flex;flex-direction:column;gap:12px}
    .ldsp-deliver-dialog-tip{font-size:11px;color:var(--txt-mut);line-height:1.5}
    .ldsp-deliver-dialog-input{width:100%;height:120px;padding:12px;border:1px solid var(--border);border-radius:var(--r-md);font-size:12px;color:var(--txt);background:var(--bg-el);resize:none;font-family:inherit}
    .ldsp-deliver-dialog-input:focus{outline:none;border-color:var(--accent)}
    .ldsp-deliver-dialog-footer{display:flex;gap:10px;padding:12px 16px;border-top:1px solid var(--border)}
    .ldsp-deliver-dialog-btn{flex:1;padding:10px 16px;border:1px solid var(--border);border-radius:var(--r-md);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
    .ldsp-deliver-dialog-btn.cancel{background:var(--bg-el);color:var(--txt-sec)}
    .ldsp-deliver-dialog-btn.cancel:hover{border-color:var(--txt-mut)}
    .ldsp-deliver-dialog-btn.confirm{background:var(--accent);border-color:var(--accent);color:#fff}
    .ldsp-deliver-dialog-btn.confirm:hover{filter:brightness(1.1)}
    .ldsp-deliver-dialog-btn:disabled{opacity:.6;cursor:not-allowed}
    /* Shop v2.0 å•†æˆ·è®¾ç½® */
    .ldsp-merchant-settings{display:flex;flex-direction:column;gap:12px;padding:2px}
    .ldsp-merchant-settings-header{display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px dashed var(--border)}
    .ldsp-merchant-settings-header span{font-size:14px;font-weight:600;color:var(--txt)}
    .ldsp-merchant-stats-card{background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(139,92,246,.02));border:1px solid rgba(139,92,246,.2);border-radius:var(--r-md);padding:14px}
    .ldsp-merchant-stats-title{font-size:12px;font-weight:600;color:var(--accent);margin-bottom:12px}
    .ldsp-merchant-stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .ldsp-merchant-stat{background:var(--bg-card);border-radius:var(--r-sm);padding:10px;text-align:center}
    .ldsp-merchant-stat-value{font-size:18px;font-weight:700;color:var(--txt)}
    .ldsp-merchant-stat-label{font-size:9px;color:var(--txt-mut);margin-top:2px}
    .ldsp-merchant-config-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:14px;display:flex;flex-direction:column;gap:12px}
    .ldsp-merchant-config-title{font-size:12px;font-weight:600;color:var(--txt)}
    .ldsp-merchant-config-status{display:flex;gap:8px}
    .ldsp-merchant-badge{padding:3px 8px;font-size:9px;font-weight:600;border-radius:4px}
    .ldsp-merchant-badge.verified{background:rgba(34,197,94,.15);color:#22c55e}
    .ldsp-merchant-badge.pending{background:rgba(234,179,8,.15);color:#eab308}
    .ldsp-merchant-badge.active{background:rgba(59,130,246,.15);color:#3b82f6}
    .ldsp-merchant-badge.inactive{background:rgba(107,114,128,.15);color:#6b7280}
    .ldsp-merchant-config-info{background:var(--bg-el);border-radius:var(--r-sm);padding:10px}
    .ldsp-merchant-config-row{display:flex;justify-content:space-between;font-size:11px;padding:4px 0}
    .ldsp-merchant-config-row .label{color:var(--txt-mut)}
    .ldsp-merchant-config-row .value{color:var(--txt);font-family:monospace}
    .ldsp-merchant-config-tip{font-size:10px;color:var(--txt-mut);line-height:1.5;padding:8px 10px;background:var(--bg-el);border-radius:var(--r-sm)}
    .ldsp-merchant-form-group{display:flex;flex-direction:column;gap:4px}
    .ldsp-merchant-form-label{font-size:10px;font-weight:600;color:var(--txt-sec)}
    .ldsp-merchant-form-input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:12px;color:var(--txt);background:var(--bg-el)}
    .ldsp-merchant-form-input:focus{outline:none;border-color:var(--accent)}
    .ldsp-merchant-form-hint{font-size:9px;color:var(--txt-mut)}
    .ldsp-merchant-form-input:disabled{opacity:.7;cursor:not-allowed;background:var(--bg-card)}
    .ldsp-merchant-form-actions{display:flex;gap:10px;flex-wrap:wrap}
    .ldsp-merchant-edit-btn{flex:1;padding:10px 16px;border:1px solid var(--accent);border-radius:var(--r-md);font-size:12px;font-weight:600;background:transparent;color:var(--accent);cursor:pointer;transition:all .15s}
    .ldsp-merchant-edit-btn:hover{background:var(--accent);color:#fff}
    .ldsp-merchant-test-btn{padding:10px 16px;border:1px solid #f59e0b;border-radius:var(--r-md);font-size:12px;font-weight:600;background:transparent;color:#f59e0b;cursor:pointer;transition:all .15s}
    .ldsp-merchant-test-btn:hover{background:#f59e0b;color:#fff}
    .ldsp-merchant-test-btn:disabled{opacity:.6;cursor:not-allowed}
    .ldsp-merchant-save-btn{flex:1;padding:10px 16px;border:none;border-radius:var(--r-md);font-size:12px;font-weight:600;background:var(--accent);color:#fff;cursor:pointer;transition:all .15s}
    .ldsp-merchant-save-btn:hover{filter:brightness(1.1)}
    .ldsp-merchant-save-btn:disabled{opacity:.6;cursor:not-allowed}
    .ldsp-merchant-cancel-btn{padding:10px 16px;border:1px solid var(--border);border-radius:var(--r-md);font-size:12px;font-weight:600;color:var(--txt-sec);background:transparent;cursor:pointer;transition:all .15s}
    .ldsp-merchant-cancel-btn:hover{border-color:var(--txt-mut);color:var(--txt)}
    .ldsp-merchant-delete-btn{padding:10px 16px;border:1px solid var(--err);border-radius:var(--r-md);font-size:12px;font-weight:600;color:var(--err);background:transparent;cursor:pointer;transition:all .15s}
    .ldsp-merchant-delete-btn:hover{background:var(--err);color:#fff}
    .ldsp-merchant-delete-btn:disabled{opacity:.6;cursor:not-allowed}
    .ldsp-merchant-config-header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .ldsp-merchant-help-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:14px}
    .ldsp-merchant-help-title{font-size:11px;font-weight:600;color:var(--txt-sec);margin-bottom:10px}
    .ldsp-merchant-help-content,.ldsp-merchant-help-content *{font-size:10px;color:var(--txt-mut);line-height:1.8;user-select:text!important;-webkit-user-select:text!important}
    .ldsp-merchant-help-content p{margin:0}
    .ldsp-merchant-help-content a{color:var(--accent);text-decoration:none}
    .ldsp-merchant-help-content a:hover{text-decoration:underline}
    .ldsp-shop-header-actions{display:flex;gap:8px;align-items:center}
    .ldsp-shop-web-btn{padding:4px 8px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:9px;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;transition:all .15s;text-decoration:none;display:flex;align-items:center;gap:3px;white-space:nowrap}
    .ldsp-shop-web-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(107,140,239,.08)}
    .ldsp-shop-settings-btn{padding:6px 12px;border:1px solid var(--border);border-radius:var(--r-md);font-size:10px;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;transition:all .15s}
    .ldsp-shop-settings-btn:hover{border-color:var(--accent);color:var(--accent)}
    /* Shop v2.0 CDK åº“å­˜ç®¡ç† */
    .ldsp-cdk-manager{display:flex;flex-direction:column;gap:12px;padding:2px}
    .ldsp-cdk-manager-header{display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px dashed var(--border)}
    .ldsp-cdk-manager-header span{font-size:13px;font-weight:600;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ldsp-cdk-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .ldsp-cdk-stat{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px;text-align:center}
    .ldsp-cdk-stat-value{font-size:18px;font-weight:700;color:var(--txt)}
    .ldsp-cdk-stat-label{font-size:9px;color:var(--txt-mut);margin-top:2px}
    .ldsp-cdk-stat.available{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05)}
    .ldsp-cdk-stat.available .ldsp-cdk-stat-value{color:#22c55e}
    .ldsp-cdk-stat.locked{border-color:rgba(234,179,8,.3);background:rgba(234,179,8,.05)}
    .ldsp-cdk-stat.locked .ldsp-cdk-stat-value{color:#eab308}
    .ldsp-cdk-stat.sold{border-color:rgba(59,130,246,.3);background:rgba(59,130,246,.05)}
    .ldsp-cdk-stat.sold .ldsp-cdk-stat-value{color:#3b82f6}
    .ldsp-cdk-upload-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:14px;display:flex;flex-direction:column;gap:10px}
    .ldsp-cdk-upload-title{font-size:11px;font-weight:600;color:var(--txt-sec)}
    .ldsp-cdk-upload-input{width:100%;height:100px;padding:10px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt);background:var(--bg-el);resize:none;font-family:monospace}
    .ldsp-cdk-upload-input:focus{outline:none;border-color:var(--accent)}
    .ldsp-cdk-upload-footer{display:flex;gap:8px;align-items:center}
    .ldsp-cdk-upload-remark{flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt);background:var(--bg-el)}
    .ldsp-cdk-upload-remark:focus{outline:none;border-color:var(--accent)}
    .ldsp-cdk-upload-btn{padding:8px 16px;border:none;border-radius:var(--r-sm);font-size:11px;font-weight:600;background:var(--accent);color:#fff;cursor:pointer;transition:all .15s}
    .ldsp-cdk-upload-btn:hover{filter:brightness(1.1)}
    .ldsp-cdk-upload-btn:disabled{opacity:.6;cursor:not-allowed}
    .ldsp-shop-cdk-mgr-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:14px;display:flex;flex-direction:column;gap:10px;overflow:hidden;min-height:100px}
    .ldsp-shop-cdk-mgr-header{display:flex;justify-content:space-between;align-items:center;font-size:11px;font-weight:600;color:var(--txt-sec);flex-shrink:0}
    .ldsp-shop-cdk-mgr-filter{padding:4px 8px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt);background:var(--bg-el)}
    .ldsp-shop-cdk-mgr-list{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow-y:auto;flex:1}
    .ldsp-shop-cdk-mgr-item{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);min-height:40px}
    .ldsp-shop-cdk-mgr-code{font-size:12px;font-family:'Consolas','Monaco','Courier New',monospace;color:var(--txt);word-break:break-all;line-height:1.4}
    .ldsp-shop-cdk-mgr-meta{display:flex;flex-direction:column;gap:4px;align-items:flex-end;flex-shrink:0}
    .ldsp-shop-cdk-mgr-status{padding:3px 8px;font-size:9px;font-weight:600;border-radius:4px;white-space:nowrap}
    .ldsp-shop-cdk-mgr-status.available{background:rgba(34,197,94,.2);color:#22c55e}
    .ldsp-shop-cdk-mgr-status.locked{background:rgba(234,179,8,.2);color:#eab308}
    .ldsp-shop-cdk-mgr-status.sold{background:rgba(107,114,128,.2);color:#6b7280}
    .ldsp-shop-cdk-mgr-remark{font-size:9px;color:var(--txt-mut);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-shop-cdk-mgr-actions{display:flex;gap:4px;flex-shrink:0}
    .ldsp-shop-cdk-mgr-copy{width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:var(--r-sm);background:var(--bg-card);font-size:12px;cursor:pointer;transition:all .15s;flex-shrink:0}
    .ldsp-shop-cdk-mgr-copy:hover{border-color:var(--accent);background:rgba(107,140,239,.1)}
    .ldsp-shop-cdk-mgr-copy.copied{border-color:#22c55e;background:rgba(34,197,94,.15)}
    .ldsp-shop-cdk-mgr-delete{width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:var(--r-sm);background:var(--bg-card);font-size:14px;color:var(--txt-mut);cursor:pointer;transition:all .15s;flex-shrink:0}
    .ldsp-shop-cdk-mgr-delete:hover{color:#fff;background:var(--err);border-color:var(--err)}
    .ldsp-shop-cdk-mgr-pagination{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px dashed var(--border);font-size:10px;color:var(--txt-mut);flex-shrink:0}
    .ldsp-shop-cdk-mgr-pagination-btns{display:flex;gap:6px}
    .ldsp-shop-cdk-mgr-page-btn{padding:5px 12px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;transition:all .15s}
    .ldsp-shop-cdk-mgr-page-btn:hover:not(:disabled){border-color:var(--accent);color:var(--accent)}
    .ldsp-shop-cdk-mgr-page-btn:disabled{opacity:.5;cursor:not-allowed}
    .ldsp-shop-cdk-mgr-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:10px;color:var(--txt-mut)}
    .ldsp-shop-cdk-mgr-empty-icon{font-size:36px;opacity:.5}
    .ldsp-shop-cdk-mgr-empty-text{font-size:13px;font-weight:500}
    .ldsp-shop-cdk-mgr-empty-hint{font-size:10px}
    .ldsp-shop-my-card-type{position:absolute;top:0;left:0;padding:3px 8px;font-size:8px;font-weight:700;border-radius:var(--r-sm) 0 6px 0;background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:#1c1917;letter-spacing:.3px;z-index:2}
    .ldsp-shop-my-card-stock{display:inline-flex;align-items:center;gap:2px;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2)}
    .ldsp-shop-my-card-stock .available{color:#22c55e;font-weight:700}
    .ldsp-shop-my-card-stock .divider{color:var(--txt-mut)}
    .ldsp-shop-my-card-stock .total{color:var(--txt-mut)}
    .ldsp-shop-my-card-stock.low{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2)}
    .ldsp-shop-my-card-stock.low .available{color:#ef4444}
    /* æˆ‘çš„å•†å“å¡ç‰‡ */
    .ldsp-shop-my-card{display:flex;gap:10px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);position:relative}
    .ldsp-shop-my-card-img-wrap{width:60px;height:60px;flex-shrink:0;position:relative}
    .ldsp-shop-my-card-img{width:60px;height:60px;object-fit:cover;border-radius:var(--r-sm);background:var(--bg-el);flex-shrink:0}
    .ldsp-shop-my-card-img-placeholder{width:60px;height:60px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
    .ldsp-shop-card-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:28px;border-radius:0}
    .ldsp-shop-my-card-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
    .ldsp-shop-my-card-name{font-size:12px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-shop-my-card-meta{font-size:10px;color:var(--txt-mut);display:flex;align-items:center;gap:8px}
    .ldsp-shop-my-card-price{font-size:13px;font-weight:700;color:var(--accent)}
    .ldsp-shop-my-card-actions{display:flex;gap:6px;margin-top:auto}
    .ldsp-shop-my-card-btn{padding:4px 10px;border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);background:var(--bg-el);cursor:pointer;transition:all .15s}
    .ldsp-shop-my-card-btn:hover{border-color:var(--accent);color:var(--accent)}
    .ldsp-shop-my-card-btn.danger:hover{border-color:var(--err);color:var(--err)}
    .ldsp-shop-my-card-status{position:absolute;top:8px;right:8px;padding:2px 6px;font-size:9px;font-weight:600;border-radius:4px}
    .ldsp-shop-my-card-status.active{background:rgba(34,197,94,.15);color:#22c55e}
    .ldsp-shop-my-card-status.inactive{background:rgba(239,68,68,.15);color:#ef4444}
    .ldsp-shop-my-card-status.rejected{background:rgba(239,68,68,.2);color:#dc2626}
    .ldsp-shop-my-card-reason{font-size:9px;color:#dc2626;background:rgba(239,68,68,.08);padding:4px 6px;border-radius:4px;border-left:2px solid #ef4444;margin-bottom:4px;line-height:1.4;word-break:break-all}
    .ldsp-shop-my-list{display:flex;flex-direction:column;gap:8px;overflow-y:auto;flex:1;min-height:0}
    /* LDC/å·¥å•/åƒç“œ/CDK å“åº”å¼é€‚é… */
    @media (max-width:380px){.ldsp-ldc-header,.ldsp-ticket-header,.ldsp-melon-header,.ldsp-cdk-header{padding:8px 10px}.ldsp-ldc-title,.ldsp-ticket-title,.ldsp-melon-title,.ldsp-cdk-title{font-size:12px}.ldsp-ldc-tabs{}.ldsp-ldc-tab,.ldsp-cdk-tab{padding:8px 6px;font-size:10px}.ldsp-ldc-body,.ldsp-ticket-body,.ldsp-melon-body,.ldsp-cdk-body{padding:10px;gap:8px}.ldsp-ldc-balance-card{padding:12px}.ldsp-ldc-balance-main{gap:8px}.ldsp-ldc-balance-value{font-size:24px}.ldsp-ldc-balance-right{gap:3px}.ldsp-ldc-balance-sub,.ldsp-ldc-balance-estimate{font-size:9px}.ldsp-ldc-stats-grid{grid-template-columns:1fr}.ldsp-ldc-stat-card{padding:10px;gap:8px}.ldsp-ldc-stat-icon{font-size:16px}.ldsp-ldc-stat-num{font-size:13px}.ldsp-ldc-chart-bars{height:60px}.ldsp-ldc-filter-section{gap:6px;padding-bottom:8px}.ldsp-ldc-filter-label{font-size:9px;min-width:24px}.ldsp-ldc-filter-chip{padding:4px 8px;font-size:9px}.ldsp-ldc-trans-item{padding:8px}.ldsp-ldc-trans-icon{font-size:14px;width:22px;height:22px}.ldsp-ldc-trans-name{font-size:11px}.ldsp-ldc-trans-amount{font-size:13px}.ldsp-ticket-tabs{padding:0 8px}.ldsp-ticket-tab,.ldsp-melon-tab{padding:6px 10px;font-size:9px}.ldsp-ldc-support{gap:12px}.ldsp-ldc-support-header{padding:10px 8px}.ldsp-ldc-support-title{font-size:13px}.ldsp-ldc-support-grid{gap:8px}.ldsp-ldc-support-card{padding:14px 10px}.ldsp-ldc-support-icon{font-size:28px;margin-bottom:8px}.ldsp-ldc-support-amount{font-size:16px}.ldsp-github-star-card{gap:10px;padding:10px 12px}.ldsp-github-icon-wrap{width:30px;height:30px}.ldsp-github-icon{width:26px;height:26px}.ldsp-github-title{font-size:11px;gap:4px}.ldsp-github-star-icon{font-size:14px}.ldsp-github-desc{font-size:9px}.ldsp-github-arrow{font-size:14px}.ldsp-cdk-user-card{flex-wrap:wrap;gap:10px;padding:12px}.ldsp-cdk-user-card::before{display:none}.ldsp-cdk-user-avatar{width:40px;height:40px}.ldsp-cdk-user-info{flex:1;min-width:80px;display:flex;flex-direction:column;align-items:flex-start}.ldsp-cdk-user-name{font-size:13px}.ldsp-cdk-user-username{font-size:9px}.ldsp-cdk-user-level{font-size:9px;padding:2px 8px;margin-top:4px}.ldsp-cdk-score-card{min-width:70px;padding:10px}.ldsp-cdk-score-label{font-size:8px}.ldsp-cdk-score-value{font-size:20px}.ldsp-cdk-qty-card{flex-direction:column;padding:10px;gap:8px}.ldsp-cdk-qty-item{padding:8px}.ldsp-cdk-qty-item.remain{border-right:none;border-bottom:1px solid var(--border)}.ldsp-cdk-qty-item .num{font-size:20px}.ldsp-cdk-qty-divider{display:none}.ldsp-cdk-item{padding:10px}.ldsp-cdk-item-name{font-size:12px}.ldsp-cdk-item-content{padding:6px 8px;font-size:10px}}
    @media (max-width:320px){.ldsp-ldc-header,.ldsp-ticket-header,.ldsp-melon-header,.ldsp-cdk-header{padding:6px 8px}.ldsp-ldc-title,.ldsp-ticket-title,.ldsp-melon-title,.ldsp-cdk-title{font-size:11px;gap:4px}.ldsp-ldc-header-actions,.ldsp-cdk-header-actions{gap:5px}.ldsp-ldc-link,.ldsp-cdk-link{font-size:9px!important}.ldsp-ldc-refresh,.ldsp-ldc-close,.ldsp-ticket-close,.ldsp-melon-close,.ldsp-cdk-refresh,.ldsp-cdk-close{width:22px;height:22px;font-size:10px}.ldsp-ldc-refresh svg,.ldsp-cdk-refresh svg{width:10px;height:10px}.ldsp-ldc-tab,.ldsp-cdk-tab{padding:6px 4px;font-size:9px}.ldsp-ldc-body,.ldsp-ticket-body,.ldsp-melon-body,.ldsp-cdk-body{padding:8px;gap:6px}.ldsp-ldc-balance-card{padding:10px}.ldsp-ldc-balance-main{flex-direction:column;align-items:stretch;gap:10px}.ldsp-ldc-balance-left{text-align:center}.ldsp-ldc-balance-value{font-size:26px}.ldsp-ldc-balance-right{text-align:center;flex-direction:row;justify-content:center;gap:12px;flex-wrap:wrap;padding-top:8px;border-top:1px dashed rgba(139,92,246,.1)}.ldsp-ldc-balance-sub,.ldsp-ldc-balance-estimate{justify-content:center;font-size:9px}.ldsp-ldc-balance-footer{justify-content:center}.ldsp-ldc-stats-grid{grid-template-columns:1fr;gap:6px}.ldsp-ldc-stat-card{padding:8px;gap:6px;flex-direction:row}.ldsp-ldc-stat-icon{font-size:14px}.ldsp-ldc-stat-label{font-size:9px}.ldsp-ldc-stat-num{font-size:12px}.ldsp-ldc-section-title{font-size:10px}.ldsp-ldc-chart{padding:8px}.ldsp-ldc-chart-bars{height:50px}.ldsp-ldc-chart-label{font-size:8px}.ldsp-ldc-filter-section{gap:5px;padding-bottom:6px}.ldsp-ldc-filter-row{gap:6px}.ldsp-ldc-filter-label{font-size:8px;min-width:20px;padding-top:4px}.ldsp-ldc-filter-chip{padding:3px 6px;font-size:8px}.ldsp-ldc-trans-content{gap:6px}.ldsp-ldc-trans-summary{font-size:9px}.ldsp-ldc-trans-list{gap:4px}.ldsp-ldc-trans-item{padding:6px 8px;gap:6px}.ldsp-ldc-trans-icon{font-size:12px;width:20px;height:20px;border-radius:4px}.ldsp-ldc-trans-name{font-size:10px}.ldsp-ldc-trans-meta{font-size:8px;gap:4px}.ldsp-ldc-trans-type{font-size:8px;padding:1px 4px}.ldsp-ldc-trans-amount{font-size:11px}.ldsp-ldc-detail-amount-value{font-size:22px}.ldsp-ldc-detail-row{padding:8px 10px}.ldsp-ldc-detail-row .label,.ldsp-ldc-detail-row .value{font-size:10px}.ldsp-ticket-tabs{padding:0 6px}.ldsp-ticket-tab,.ldsp-melon-tab{padding:5px 8px;font-size:8px}.ldsp-ticket-item{padding:8px}.ldsp-ticket-item-title{font-size:10px}.ldsp-ticket-item-type,.ldsp-ticket-item-meta{font-size:8px}.ldsp-ldc-support{gap:8px}.ldsp-ldc-support-header{padding:8px 6px}.ldsp-ldc-support-title{font-size:12px;gap:5px}.ldsp-ldc-support-desc{font-size:9px}.ldsp-ldc-support-grid{gap:6px}.ldsp-ldc-support-card{padding:12px 8px}.ldsp-ldc-support-icon{font-size:24px;margin-bottom:6px}.ldsp-ldc-support-name{font-size:10px;margin-bottom:4px}.ldsp-ldc-support-amount{font-size:14px}.ldsp-ldc-support-badge{font-size:8px;padding:2px 5px;top:6px;right:6px}.ldsp-ldc-support-footer{padding:8px}.ldsp-ldc-support-footer-text{font-size:9px}.ldsp-github-star-card{gap:8px;padding:8px 10px}.ldsp-github-icon-wrap{width:26px;height:26px}.ldsp-github-icon{width:22px;height:22px}.ldsp-github-title{font-size:10px;gap:4px;flex-wrap:wrap}.ldsp-github-star-icon{font-size:12px}.ldsp-github-desc{font-size:8px;line-height:1.4}.ldsp-github-arrow{font-size:12px}.ldsp-cdk-user-card{padding:10px;gap:8px}.ldsp-cdk-user-avatar{width:36px;height:36px}.ldsp-cdk-user-name{font-size:12px}.ldsp-cdk-user-username{font-size:8px}.ldsp-cdk-user-level{font-size:8px;padding:2px 6px;margin-top:3px}.ldsp-cdk-score-card{min-width:60px;padding:8px}.ldsp-cdk-score-label{font-size:7px}.ldsp-cdk-score-value{font-size:16px}.ldsp-cdk-search{padding:6px 10px}.ldsp-cdk-search input{font-size:11px}.ldsp-cdk-qty-card{padding:8px;gap:6px}.ldsp-cdk-qty-item{padding:6px}.ldsp-cdk-qty-item .num{font-size:18px}.ldsp-cdk-qty-item .lbl{font-size:8px}.ldsp-cdk-item{padding:8px;gap:6px}.ldsp-cdk-item-name{font-size:11px}.ldsp-cdk-item-time{font-size:8px;padding:1px 4px}.ldsp-cdk-item-creator{font-size:9px}.ldsp-cdk-item-content{padding:5px 7px;font-size:9px;gap:6px}.ldsp-cdk-item-copy{width:24px;height:24px;font-size:10px}.ldsp-cdk-detail-title{font-size:12px}.ldsp-cdk-detail-meta{font-size:9px}.ldsp-cdk-detail-desc{font-size:10px;padding:8px}.ldsp-cdk-detail-content{padding:10px}.ldsp-cdk-detail-content-label{font-size:9px}.ldsp-cdk-detail-content-value{font-size:12px}.ldsp-cdk-detail-copy{font-size:9px}.ldsp-cdk-back-btn{padding:5px 10px;font-size:10px}.ldsp-cdk-detail-row{padding:6px 8px}.ldsp-cdk-detail-row .label,.ldsp-cdk-detail-row .value{font-size:9px}.ldsp-cdk-detail-tag{font-size:8px;padding:1px 6px}}
    @media (max-height:550px){.ldsp-ldc-body,.ldsp-ticket-body,.ldsp-melon-body,.ldsp-cdk-body{padding:8px;gap:6px}.ldsp-ldc-balance-card{padding:10px}.ldsp-ldc-balance-value{font-size:22px}.ldsp-ldc-stats-grid{gap:6px}.ldsp-ldc-stat-card{padding:8px}.ldsp-ldc-chart-bars{height:50px}.ldsp-ldc-section{gap:6px}.ldsp-ldc-filter-section{gap:5px;padding-bottom:6px}.ldsp-ldc-filter-chip{padding:4px 7px}.ldsp-ldc-support{gap:10px}.ldsp-ldc-support-header{padding:10px 8px}.ldsp-ldc-support-grid{gap:8px}.ldsp-ldc-support-card{padding:12px 8px}.ldsp-ldc-support-icon{font-size:26px;margin-bottom:6px}.ldsp-ldc-support-amount{font-size:16px}.ldsp-cdk-user-card{padding:10px;gap:8px}.ldsp-cdk-user-avatar{width:40px;height:40px}.ldsp-cdk-score-card{padding:8px}.ldsp-cdk-score-value{font-size:20px}.ldsp-cdk-qty-card{padding:10px}.ldsp-cdk-qty-item .num{font-size:18px}}
    @media (max-height:450px){.ldsp-ldc-body,.ldsp-cdk-body{padding:6px;gap:5px}.ldsp-ldc-balance-card{padding:8px}.ldsp-ldc-balance-value{font-size:18px}.ldsp-ldc-balance-label,.ldsp-ldc-balance-sub{font-size:9px}.ldsp-ldc-stats-grid{gap:4px}.ldsp-ldc-stat-card{padding:6px}.ldsp-ldc-stat-icon{font-size:12px}.ldsp-ldc-stat-num{font-size:11px}.ldsp-ldc-chart{padding:6px}.ldsp-ldc-chart-bars{height:40px}.ldsp-ldc-section{gap:4px}.ldsp-ldc-filter-section{gap:4px;padding-bottom:5px}.ldsp-ldc-filter-row{gap:4px}.ldsp-ldc-filter-chip{padding:3px 5px;font-size:8px}.ldsp-ldc-trans-item{padding:5px 6px}.ldsp-ldc-footer{padding-top:6px}.ldsp-ldc-support-header{padding:4px 0}.ldsp-ldc-support-title{font-size:12px}.ldsp-ldc-support-desc{font-size:10px}.ldsp-ldc-support-card{padding:8px 6px}.ldsp-ldc-support-icon{font-size:18px;margin-bottom:2px}.ldsp-ldc-support-name{font-size:10px}.ldsp-ldc-support-amount{font-size:12px}.ldsp-ldc-support-footer{padding:6px}.ldsp-ldc-support-footer-text{font-size:9px}.ldsp-cdk-user-card{padding:8px;gap:6px;flex-direction:row;text-align:left}.ldsp-cdk-user-avatar{width:36px;height:36px}.ldsp-cdk-user-name{font-size:12px}.ldsp-cdk-score-card{padding:6px;min-width:60px}.ldsp-cdk-score-value{font-size:16px}.ldsp-cdk-qty-card{padding:6px}.ldsp-cdk-qty-item .num{font-size:16px}.ldsp-cdk-item{padding:6px}}
    .ldsp-melon-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg);border-radius:0 0 var(--r-lg) var(--r-lg);z-index:10;display:none;flex-direction:column;overflow:hidden}
    .ldsp-melon-overlay.show{display:flex}
    .ldsp-melon-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-melon-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;color:var(--txt)}
    .ldsp-melon-header-actions{display:flex;align-items:center;gap:6px}
    .ldsp-melon-refresh{padding:4px 10px;display:flex;align-items:center;justify-content:center;gap:4px;background:linear-gradient(135deg,rgba(74,222,128,.08),rgba(34,197,94,.12));border:1px solid rgba(74,222,128,.2);border-radius:6px;font-size:10px;color:#22c55e;cursor:pointer;transition:all .15s;white-space:nowrap}
    .ldsp-melon-refresh:hover{background:linear-gradient(135deg,rgba(74,222,128,.15),rgba(34,197,94,.2));border-color:rgba(74,222,128,.4);color:#16a34a}
    .ldsp-melon-refresh svg{flex-shrink:0}
    .ldsp-melon-close{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--txt-sec);transition:background .15s,color .15s;cursor:pointer}
    .ldsp-melon-close:hover{background:var(--err-bg);color:var(--err);border-color:var(--err)}
    .ldsp-melon-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 10px;background:var(--bg-card);flex-shrink:0}
    .ldsp-melon-tab{padding:8px 12px;font-size:10px;font-weight:600;color:var(--txt-mut);border-bottom:2px solid transparent;transition:color .15s,border-color .15s;cursor:pointer}
    .ldsp-melon-tab.active{color:var(--accent);border-color:var(--accent)}
    .ldsp-melon-tab:hover:not(.active){color:var(--txt-sec)}
    .ldsp-melon-body{flex:1;overflow-y:auto;padding:12px;background:var(--bg);display:flex;flex-direction:column;gap:10px}
    .ldsp-melon-info{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px;font-size:11px}
    .ldsp-melon-info-title{font-weight:600;color:var(--txt);margin-bottom:6px;display:flex;align-items:center;gap:5px}
    .ldsp-melon-info-row{display:flex;align-items:center;gap:6px;color:var(--txt-sec);font-size:10px;margin-top:4px}
    .ldsp-melon-info-label{color:var(--txt-mut);min-width:50px}
    .ldsp-melon-info-value{color:var(--txt);font-weight:500}
    .ldsp-melon-range{display:flex;align-items:center;gap:8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px;flex-wrap:wrap}
    .ldsp-melon-range-label{font-size:10px;color:var(--txt-sec);white-space:nowrap}
    .ldsp-melon-range-input{width:70px;padding:5px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt);text-align:center}
    .ldsp-melon-range-input:focus{border-color:var(--accent);outline:none}
    .ldsp-melon-range-sep{color:var(--txt-mut);font-size:10px}
    .ldsp-melon-range-hint{font-size:9px;color:var(--txt-mut);margin-left:auto}
    /* æ¨¡å¼é€‰æ‹©å™¨ - å¡ç‰‡å¼è®¾è®¡ */
    .ldsp-melon-mode-selector{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px}
    .ldsp-melon-mode-label{font-size:10px;color:var(--txt-sec);margin-bottom:8px;display:block}
    .ldsp-melon-mode-cards{display:flex;gap:8px}
    .ldsp-melon-mode-card{flex:1;display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-el);border:2px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .2s}
    .ldsp-melon-mode-card:hover{border-color:var(--txt-mut);background:var(--bg)}
    .ldsp-melon-mode-card.active{border-color:var(--accent);background:rgba(107,140,239,.08)}
    .ldsp-melon-mode-card input{display:none}
    .ldsp-melon-mode-card-icon{font-size:20px;flex-shrink:0}
    .ldsp-melon-mode-card-content{flex:1;min-width:0}
    .ldsp-melon-mode-card-title{font-size:11px;font-weight:600;color:var(--txt);margin-bottom:2px}
    .ldsp-melon-mode-card-desc{font-size:9px;color:var(--txt-mut)}
    .ldsp-melon-mode-card.active .ldsp-melon-mode-card-title{color:var(--accent)}
    .ldsp-melon-actions{display:flex;gap:8px}
    .ldsp-melon-btn-summarize{flex:1;padding:10px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border:none;border-radius:var(--r-sm);font-size:12px;font-weight:600;cursor:pointer;transition:opacity .15s,transform .2s,box-shadow .2s;display:flex;align-items:center;justify-content:center;gap:6px}
    .ldsp-melon-btn-summarize:hover{box-shadow:0 4px 16px rgba(34,197,94,.35);transform:translateY(-1px)}
    .ldsp-melon-btn-summarize:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    .ldsp-melon-btn-summarize.loading{background:linear-gradient(135deg,#6b8cef,#5a7de0)}
    /* è¾“å‡ºåŒºåŸŸ */
    .ldsp-melon-output-wrapper{display:flex;flex-direction:column;flex:1;min-height:0}
    .ldsp-melon-output-header{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--bg-card);border:1px solid var(--border);border-bottom:none;border-radius:var(--r-md) var(--r-md) 0 0}
    .ldsp-melon-output-title{font-size:10px;font-weight:600;color:var(--txt-sec)}
    .ldsp-melon-output-actions{display:flex;gap:6px}
    .ldsp-melon-resize-btn{display:flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-melon-resize-btn:hover{background:rgba(107,140,239,.1);border-color:var(--accent);color:var(--accent)}
    .ldsp-melon-copy-btn{display:flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-melon-copy-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .ldsp-melon-output{flex:1;min-height:120px;max-height:200px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px;overflow-y:auto;font-size:12px;line-height:1.6;color:var(--txt);transition:max-height .3s ease}
    .ldsp-melon-output.expanded{max-height:400px}
    .ldsp-melon-output-header+.ldsp-melon-output{border-radius:0 0 var(--r-md) var(--r-md)}
    .ldsp-melon-output:empty::before{content:'ç‚¹å‡»ã€Œç«‹å³åƒç“œã€è·å–å¸–å­æ‘˜è¦...';color:var(--txt-mut);font-style:italic}
    .ldsp-melon-output-content{min-height:20px}
    .ldsp-melon-cursor{display:inline-block;color:var(--accent);animation:ldsp-blink 1s infinite}
    @keyframes ldsp-blink{0%,50%{opacity:1}51%,100%{opacity:0}}
    /* Markdown æ¸²æŸ“ */
    .ldsp-melon-markdown{font-size:12px;line-height:1.7}
    .ldsp-melon-markdown .ldsp-melon-p{margin:6px 0}
    .ldsp-melon-markdown .ldsp-melon-h2,.ldsp-melon-markdown .ldsp-melon-h3{font-size:13px;font-weight:700;margin:12px 0 8px;color:var(--txt);border-bottom:1px solid var(--border);padding-bottom:4px}
    .ldsp-melon-markdown .ldsp-melon-h4,.ldsp-melon-markdown .ldsp-melon-h5{font-size:12px;font-weight:600;margin:10px 0 6px;color:var(--txt)}
    .ldsp-melon-markdown .ldsp-melon-ul,.ldsp-melon-markdown .ldsp-melon-ol{margin:6px 0;padding-left:18px}
    .ldsp-melon-markdown .ldsp-melon-li,.ldsp-melon-markdown .ldsp-melon-oli{margin:3px 0}
    .ldsp-melon-markdown .ldsp-melon-quote{margin:8px 0;padding:8px 12px;background:var(--bg-el);border-left:3px solid var(--accent);border-radius:0 var(--r-sm) var(--r-sm) 0;color:var(--txt-sec);font-style:italic}
    .ldsp-melon-markdown strong{color:var(--accent);font-weight:600}
    .ldsp-melon-markdown .ldsp-melon-inline-code{background:var(--bg-el);padding:2px 5px;border-radius:3px;font-family:monospace;font-size:10px}
    .ldsp-melon-markdown .ldsp-melon-codeblock{background:var(--bg-el);padding:10px;border-radius:var(--r-sm);overflow-x:auto;margin:8px 0}
    .ldsp-melon-markdown .ldsp-melon-codeblock code{background:none;padding:0;font-family:monospace;font-size:10px}
    .ldsp-melon-markdown .ldsp-melon-hr{border:none;border-top:1px solid var(--border);margin:12px 0}
    .ldsp-melon-markdown .ldsp-melon-link{color:var(--accent);text-decoration:none}
    .ldsp-melon-markdown .ldsp-melon-link:hover{text-decoration:underline}
    .ldsp-melon-output h1,.ldsp-melon-output h2,.ldsp-melon-output h3{font-size:13px;font-weight:700;margin:12px 0 8px;color:var(--txt);border-bottom:1px solid var(--border);padding-bottom:4px}
    .ldsp-melon-output h1:first-child,.ldsp-melon-output h2:first-child,.ldsp-melon-output h3:first-child{margin-top:0}
    .ldsp-melon-output h4,.ldsp-melon-output h5{font-size:12px;font-weight:600;margin:10px 0 6px;color:var(--txt)}
    .ldsp-melon-output p{margin:6px 0}
    .ldsp-melon-output ul,.ldsp-melon-output ol{margin:6px 0;padding-left:18px}
    .ldsp-melon-output li{margin:3px 0}
    .ldsp-melon-output blockquote{margin:8px 0;padding:8px 12px;background:var(--bg-el);border-left:3px solid var(--accent);border-radius:0 var(--r-sm) var(--r-sm) 0;color:var(--txt-sec);font-style:italic}
    .ldsp-melon-output strong{color:var(--accent);font-weight:600}
    .ldsp-melon-output code{background:var(--bg-el);padding:2px 5px;border-radius:3px;font-family:monospace;font-size:10px}
    .ldsp-melon-output pre{background:var(--bg-el);padding:10px;border-radius:var(--r-sm);overflow-x:auto;margin:8px 0}
    .ldsp-melon-output pre code{background:none;padding:0}
    .ldsp-melon-output table{width:100%;border-collapse:collapse;margin:8px 0;font-size:10px}
    .ldsp-melon-output th,.ldsp-melon-output td{border:1px solid var(--border);padding:6px 8px;text-align:left}
    .ldsp-melon-output th{background:var(--bg-el);font-weight:600}
    .ldsp-melon-output hr{border:none;border-top:1px solid var(--border);margin:12px 0}
    .ldsp-melon-output a{color:var(--accent);text-decoration:none}
    .ldsp-melon-output a:hover{text-decoration:underline}
    .ldsp-melon-status{text-align:center;padding:20px;color:var(--txt-mut);font-size:11px}
    .ldsp-melon-status-icon{font-size:24px;margin-bottom:8px}
    .ldsp-melon-error{color:var(--err);background:var(--err-bg);padding:10px;border-radius:var(--r-sm);font-size:11px}
    /* å†å²è®°å½• */
    .ldsp-melon-history{display:flex;flex-direction:column;height:100%}
    .ldsp-melon-history-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);margin-bottom:10px}
    .ldsp-melon-history-header-left{display:flex;align-items:center;gap:8px}
    .ldsp-melon-history-count{font-size:10px;color:var(--txt-mut)}
    .ldsp-melon-history-storage-badge{font-size:9px;color:var(--txt-mut);background:var(--bg-el);padding:2px 6px;border-radius:10px}
    .ldsp-melon-history-storage-hint{font-size:10px;color:var(--txt-mut);margin-top:8px}
    .ldsp-melon-history-clear-all{padding:4px 8px;background:var(--err-bg);border:1px solid rgba(239,68,68,.2);border-radius:var(--r-sm);font-size:9px;color:var(--err);cursor:pointer;transition:all .15s}
    .ldsp-melon-history-clear-all:hover{background:var(--err);color:#fff}
    .ldsp-melon-history-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
    .ldsp-melon-history-item{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px;transition:border-color .15s}
    .ldsp-melon-history-item:hover{border-color:var(--accent)}
    .ldsp-melon-history-item-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:6px}
    .ldsp-melon-history-item-title{font-size:11px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
    .ldsp-melon-history-item-meta{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .ldsp-melon-history-mode{font-size:9px;padding:2px 6px;border-radius:10px;font-weight:500}
    .ldsp-melon-history-mode.brief{background:rgba(59,130,246,.1);color:#3b82f6}
    .ldsp-melon-history-mode.detailed{background:rgba(34,197,94,.1);color:#22c55e}
    .ldsp-melon-history-date{font-size:9px;color:var(--txt-mut)}
    .ldsp-melon-history-item-preview{font-size:10px;color:var(--txt-sec);line-height:1.5;margin-bottom:8px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .ldsp-melon-history-item-actions{display:flex;gap:6px}
    .ldsp-melon-history-btn{padding:4px 8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:9px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-melon-history-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .ldsp-melon-history-delete:hover{background:var(--err);border-color:var(--err)}
    .ldsp-melon-history-empty{text-align:center;padding:40px 20px;color:var(--txt-mut)}
    .ldsp-melon-history-empty-icon{font-size:36px;margin-bottom:10px}
    .ldsp-melon-history-empty-text{font-size:12px;font-weight:500;margin-bottom:4px}
    .ldsp-melon-history-empty-hint{font-size:10px;color:var(--txt-mut)}
    .ldsp-melon-history-detail{display:flex;flex-direction:column;height:100%}
    .ldsp-melon-history-detail-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .ldsp-melon-history-detail-actions{display:flex;gap:6px}
    .ldsp-melon-history-back{padding:6px 12px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-melon-history-back:hover{background:var(--bg-card);border-color:var(--accent);color:var(--accent)}
    .ldsp-melon-history-expand-btn{padding:6px 12px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--accent);cursor:pointer;transition:all .15s}
    .ldsp-melon-history-expand-btn:hover{background:rgba(107,140,239,.1);border-color:var(--accent)}
    .ldsp-melon-history-copy-all{padding:6px 12px;background:var(--accent);border:none;border-radius:var(--r-sm);font-size:10px;color:#fff;cursor:pointer;transition:opacity .15s}
    .ldsp-melon-history-copy-all:hover{opacity:.85}
    .ldsp-melon-history-detail-info{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:10px;margin-bottom:10px}
    .ldsp-melon-history-detail-title{font-size:12px;font-weight:600;color:var(--txt);margin-bottom:4px}
    .ldsp-melon-history-detail-meta{font-size:10px;color:var(--txt-mut)}
    .ldsp-melon-history-detail-content{flex:1;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px;overflow-y:auto;font-size:11px;line-height:1.6}
    /* è®¾ç½®é¡µ */
    .ldsp-melon-settings{display:flex;flex-direction:column;gap:12px}
    .ldsp-melon-setting-group{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);padding:12px}
    .ldsp-melon-setting-title{font-size:11px;font-weight:600;color:var(--txt);margin-bottom:10px;display:flex;align-items:center;gap:5px}
    .ldsp-melon-setting-row{display:flex;flex-direction:column;gap:4px;margin-bottom:10px}
    .ldsp-melon-setting-row:last-child{margin-bottom:0}
    .ldsp-melon-setting-label{font-size:10px;color:var(--txt-sec);display:flex;align-items:center;gap:4px}
    .ldsp-melon-setting-input{padding:8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt)}
    .ldsp-melon-setting-input:focus{border-color:var(--accent);outline:none}
    .ldsp-melon-setting-input::placeholder{color:var(--txt-mut)}
    .ldsp-melon-setting-input:disabled{background:var(--bg);color:var(--txt-mut);cursor:not-allowed}
    .ldsp-melon-setting-actions{display:flex;gap:8px}
    .ldsp-melon-setting-btn{flex:1;padding:10px 12px;background:var(--grad);color:#fff;border:none;border-radius:var(--r-sm);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
    .ldsp-melon-setting-btn:hover{box-shadow:0 4px 12px rgba(107,140,239,.3);transform:translateY(-1px)}
    .ldsp-melon-btn-edit{background:linear-gradient(135deg,#6b8cef,#5a7de0)}
    .ldsp-melon-btn-save{background:linear-gradient(135deg,#22c55e,#16a34a)}
    .ldsp-melon-btn-save:hover{box-shadow:0 4px 12px rgba(34,197,94,.35)}
    .ldsp-melon-btn-prompt{background:linear-gradient(135deg,#6b8cef,#5a7de0)}
    .ldsp-melon-setting-textarea{width:100%;padding:8px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:10px;color:var(--txt);resize:vertical;min-height:60px;font-family:monospace;line-height:1.5}
    .ldsp-melon-setting-textarea:focus{border-color:var(--accent);outline:none}
    .ldsp-melon-setting-textarea::placeholder{color:var(--txt-mut);font-size:9px;white-space:pre-wrap}
    .ldsp-melon-prompt-reset{margin-left:6px;cursor:pointer;color:var(--err);font-size:10px;opacity:.6;transition:all .15s}
    .ldsp-melon-prompt-reset:hover{opacity:1;color:var(--err)}
    .ldsp-melon-setting-prompt-actions{display:flex;gap:8px;margin-top:8px}
    .ldsp-melon-setting-security{display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:var(--r-md)}
    .ldsp-melon-setting-security-icon{font-size:14px;flex-shrink:0}
    .ldsp-melon-setting-security-text{font-size:10px;color:var(--txt-sec);line-height:1.4}
    .ldsp-melon-setting-security-text strong{color:var(--ok);font-weight:600}
    .ldsp-melon-setting-hint{font-size:9px;color:var(--txt-mut);margin-top:3px;line-height:1.4}
    .ldsp-melon-setting-hint strong{color:var(--accent);font-weight:500}
    .ldsp-melon-setting-subtitle{font-size:9px;color:var(--txt-mut);font-weight:400;margin-left:4px}
    .ldsp-melon-setting-actions{margin-top:10px}
    .ldsp-melon-prompt-status{font-size:9px;color:var(--txt-mut);margin-left:auto;font-weight:400}
    .ldsp-melon-prompt-status.custom{color:var(--ok)}
    .ldsp-melon-setting-danger{background:var(--err-bg);border-color:rgba(239,68,68,.15);padding:10px 12px}
    .ldsp-melon-setting-danger .ldsp-melon-setting-title{color:var(--err);margin-bottom:2px}
    .ldsp-melon-setting-danger-content{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .ldsp-melon-setting-danger-info{flex:1}
    .ldsp-melon-setting-danger-desc{font-size:9px;color:var(--txt-sec)}
    .ldsp-melon-setting-danger .ldsp-melon-setting-btn{flex:none;padding:8px 16px}
    .ldsp-melon-btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626) !important}
    .ldsp-melon-btn-danger:hover{box-shadow:0 4px 12px rgba(239,68,68,.35) !important}
    .ldsp-melon-warning{background:rgba(212,168,83,.1);border:1px solid rgba(212,168,83,.3);border-radius:var(--r-sm);padding:8px 10px;font-size:10px;color:var(--warn);margin-bottom:8px}
    .ldsp-melon-not-topic{text-align:center;padding:40px 20px;color:var(--txt-mut)}
    .ldsp-melon-not-topic-icon{font-size:36px;margin-bottom:10px}
    .ldsp-melon-not-topic-text{font-size:12px;line-height:1.6}
    .ldsp-melon-not-topic-hint{font-size:10px;color:var(--txt-mut);opacity:.7;margin-top:8px}
    /* å…¨å±å±•å¼€æŸ¥çœ‹å¼¹çª— - ç‹¬ç«‹çš„å˜é‡å®šä¹‰ä»¥æ”¯æŒbodyçº§æŒ‚è½½ */
    .ldsp-melon-viewer-overlay{--bg:#12131a;--bg-card:rgba(24,26,36,.98);--bg-hover:rgba(38,42,56,.95);--bg-el:rgba(32,35,48,.88);--txt:#e4e6ed;--txt-sec:#9499ad;--txt-mut:#5d6275;--accent:#6b8cef;--border:rgba(255,255,255,.06);--r-sm:6px;--r-md:10px;--r-lg:14px;--err:#e07a8d;--err-bg:rgba(224,122,141,.12);position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:99999;display:flex;align-items:center;justify-content:center;animation:ldsp-viewer-fade-in .2s}
    .ldsp-melon-viewer-overlay.light{--bg:rgba(250,251,254,.97);--bg-card:rgba(255,255,255,.98);--bg-hover:rgba(238,242,250,.96);--bg-el:rgba(245,247,252,.94);--txt:#1e2030;--txt-sec:#4a5068;--txt-mut:#8590a6;--accent:#5070d0;--border:rgba(0,0,0,.08);--err:#d45d6e;--err-bg:rgba(212,93,110,.08)}
    @keyframes ldsp-viewer-fade-in{from{opacity:0}to{opacity:1}}
    @keyframes ldsp-viewer-scale-in{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
    .ldsp-melon-viewer{position:absolute;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column;min-width:320px;min-height:240px;max-width:95vw;max-height:90vh;overflow:hidden;animation:ldsp-viewer-scale-in .2s}
    .ldsp-melon-viewer-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border);cursor:move;user-select:none;flex-shrink:0}
    .ldsp-melon-viewer-title{font-size:13px;font-weight:700;color:var(--txt);display:flex;align-items:center;gap:8px}
    .ldsp-melon-viewer-title-icon{font-size:16px}
    .ldsp-melon-viewer-actions{display:flex;gap:6px}
    .ldsp-melon-viewer-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:12px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-melon-viewer-btn:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-melon-viewer-close:hover{background:var(--err-bg);border-color:var(--err);color:var(--err)}
    .ldsp-melon-viewer-body{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg-card)}
    .ldsp-melon-viewer-info{padding:12px 16px;background:var(--bg-el);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-melon-viewer-topic-title{font-size:14px;font-weight:700;color:var(--txt);line-height:1.4;margin-bottom:6px}
    .ldsp-melon-viewer-meta{display:flex;align-items:center;gap:8px;font-size:10px;color:var(--txt-mut)}
    .ldsp-melon-viewer-mode{padding:2px 6px;border-radius:8px;font-weight:600;font-size:9px}
    .ldsp-melon-viewer-mode.brief{background:rgba(34,197,94,.15);color:#22c55e}
    .ldsp-melon-viewer-mode.detailed{background:rgba(107,140,239,.15);color:#6b8cef}
    .ldsp-melon-viewer-content{flex:1;overflow-y:auto;padding:16px;background:var(--bg-card);color:var(--txt);--viewer-font-size:16px}
    .ldsp-melon-viewer-content.font-xs{--viewer-font-size:12px}
    .ldsp-melon-viewer-content.font-sm{--viewer-font-size:14px}
    .ldsp-melon-viewer-content.font-md{--viewer-font-size:16px}
    .ldsp-melon-viewer-content.font-lg{--viewer-font-size:18px}
    .ldsp-melon-viewer-content.font-xl{--viewer-font-size:20px}
    .ldsp-melon-viewer-content .ldsp-melon-markdown{font-size:var(--viewer-font-size,14px);line-height:1.7;color:var(--txt)}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-p{color:var(--txt)}
    .ldsp-melon-viewer-content .ldsp-melon-markdown strong{color:var(--accent)}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-h2,.ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-h3,.ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-h4{color:var(--txt);border-color:var(--border)}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-quote{background:var(--bg-el);border-left-color:var(--accent);color:var(--txt-sec)}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-inline-code{background:var(--bg-el);color:var(--txt)}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-codeblock{background:var(--bg);border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:6px;overflow-x:auto}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-ul,.ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-ol{margin:8px 0;padding-left:20px}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-li,.ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-oli{margin:4px 0;color:var(--txt)}
    .ldsp-melon-viewer-content .ldsp-melon-markdown .ldsp-melon-hr{border:none;border-top:1px solid var(--border);margin:12px 0}
    .ldsp-melon-viewer-content::-webkit-scrollbar{width:6px}
    .ldsp-melon-viewer-content::-webkit-scrollbar-track{background:var(--bg)}
    .ldsp-melon-viewer-content::-webkit-scrollbar-thumb{background:var(--txt-mut);border-radius:3px}
    .ldsp-melon-viewer-content::-webkit-scrollbar-thumb:hover{background:var(--txt-sec)}
    /* å¯¹è¯åŠŸèƒ½æ ·å¼ */
    .ldsp-melon-viewer-chat{padding:12px 16px;border-top:1px solid var(--border);background:var(--bg)}
    .ldsp-melon-chat-input-wrap{display:flex;gap:8px;align-items:center}
    .ldsp-melon-chat-input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:var(--r-md);background:var(--bg-card);color:var(--txt);font-size:13px;outline:none;transition:border-color .15s}
    .ldsp-melon-chat-input:focus{border-color:var(--accent)}
    .ldsp-melon-chat-input::placeholder{color:var(--txt-mut)}
    .ldsp-melon-chat-input:disabled{opacity:.6;cursor:not-allowed}
    .ldsp-melon-chat-send{width:36px;height:36px;border:none;border-radius:var(--r-md);background:linear-gradient(135deg,#10b981,#059669);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
    .ldsp-melon-chat-send:hover:not(:disabled){transform:scale(1.05);box-shadow:0 4px 12px rgba(16,185,129,.3)}
    .ldsp-melon-chat-send:disabled{opacity:.5;cursor:not-allowed}
    .ldsp-melon-chat-send.loading{animation:ldsp-pulse 1s infinite}
    @keyframes ldsp-pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .ldsp-melon-chat-hint{font-size:10px;color:var(--txt-mut);margin-top:6px;text-align:center}
    .ldsp-melon-font-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt-sec);cursor:pointer;transition:all .15s;position:relative}
    .ldsp-melon-font-btn:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-melon-font-dropdown{position:absolute;top:100%;right:0;margin-top:4px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);box-shadow:0 4px 16px rgba(0,0,0,.2);padding:4px;display:none;z-index:10;min-width:70px}
    .ldsp-melon-font-dropdown.show{display:block}
    .ldsp-melon-font-option{padding:6px 10px;font-size:11px;color:var(--txt-sec);cursor:pointer;border-radius:4px;white-space:nowrap;transition:all .1s}
    .ldsp-melon-font-option:hover{background:var(--bg-hover);color:var(--txt)}
    .ldsp-melon-font-option.active{background:rgba(107,140,239,.15);color:var(--accent);font-weight:600}
    .ldsp-melon-chat-msg{margin-bottom:16px;animation:ldsp-slide-up .2s ease-out}
    @keyframes ldsp-slide-up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .ldsp-melon-chat-msg-label{font-size:11px;font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:4px}
    .ldsp-melon-chat-msg.assistant .ldsp-melon-chat-msg-label{color:var(--accent)}
    .ldsp-melon-chat-msg.user .ldsp-melon-chat-msg-label{color:#10b981}
    .ldsp-melon-chat-msg-content{font-size:var(--viewer-font-size,14px);line-height:1.6;color:var(--txt)}
    .ldsp-melon-chat-msg.user .ldsp-melon-chat-msg-content{background:var(--bg-el);padding:10px 14px;border-radius:var(--r-md);border:1px solid var(--border)}
    .ldsp-melon-chat-typing{color:var(--txt-mut);font-style:italic}
    /* è°ƒæ•´å¤§å°æ‰‹æŸ„ */
    .ldsp-melon-resize-handle{position:absolute;background:transparent}
    .ldsp-melon-resize-handle-e{top:10px;right:0;width:6px;height:calc(100% - 20px);cursor:e-resize}
    .ldsp-melon-resize-handle-s{bottom:0;left:10px;width:calc(100% - 20px);height:6px;cursor:s-resize}
    .ldsp-melon-resize-handle-se{bottom:0;right:0;width:16px;height:16px;cursor:se-resize}
    .ldsp-melon-resize-handle-se::before{content:'';position:absolute;right:3px;bottom:3px;width:8px;height:8px;border-right:2px solid var(--txt-mut);border-bottom:2px solid var(--txt-mut);opacity:.5}
    .ldsp-melon-resize-handle-w{top:10px;left:0;width:6px;height:calc(100% - 20px);cursor:w-resize}
    .ldsp-melon-resize-handle-n{top:0;left:10px;width:calc(100% - 20px);height:6px;cursor:n-resize}
    .ldsp-melon-resize-handle-nw{top:0;left:0;width:16px;height:16px;cursor:nw-resize}
    .ldsp-melon-resize-handle-ne{top:0;right:0;width:16px;height:16px;cursor:ne-resize}
    .ldsp-melon-resize-handle-sw{bottom:0;left:0;width:16px;height:16px;cursor:sw-resize}
    /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† */
    .ldsp-melon-confirm-dialog{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:100;animation:ldsp-fade-in .15s}
    .ldsp-melon-confirm-content{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px;width:85%;max-width:280px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.2);animation:ldsp-scale-in .2s}
    @keyframes ldsp-fade-in{from{opacity:0}to{opacity:1}}
    @keyframes ldsp-scale-in{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
    .ldsp-melon-confirm-icon{font-size:32px;margin-bottom:12px}
    .ldsp-melon-confirm-message{font-size:12px;color:var(--txt);line-height:1.6;margin-bottom:16px}
    .ldsp-melon-confirm-actions{display:flex;gap:10px}
    .ldsp-melon-confirm-btn{flex:1;padding:10px 16px;border:none;border-radius:var(--r-sm);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
    .ldsp-melon-confirm-cancel{background:var(--bg-el);color:var(--txt-sec);border:1px solid var(--border)}
    .ldsp-melon-confirm-cancel:hover{background:var(--bg);border-color:var(--txt-mut)}
    .ldsp-melon-confirm-ok{background:var(--err);color:#fff}
    .ldsp-melon-confirm-ok:hover{background:#dc2626;box-shadow:0 4px 12px rgba(239,68,68,.3)}
    .ldsp-user-meta{display:flex;align-items:center;flex-wrap:wrap;margin-top:2px}
    .ldsp-follow-stats{display:flex;gap:6px;padding:2px 0}
    .ldsp-follow-combined{display:inline-flex;align-items:center;gap:3px;padding:2px 0;font-size:10px;color:var(--txt-mut)}
    .ldsp-follow-part{cursor:pointer;transition:color .15s;font-weight:500}
    .ldsp-follow-part:hover{color:var(--accent)}
    .ldsp-follow-sep{color:var(--txt-mut);margin:0 1px}
    .ldsp-follow-num-following,.ldsp-follow-num-followers{font-weight:600;color:var(--txt-sec);transition:color .15s}
    .ldsp-follow-part:hover .ldsp-follow-num-following,.ldsp-follow-part:hover .ldsp-follow-num-followers{color:var(--accent)}
    .ldsp-join-days{display:inline-flex;align-items:center;font-size:10px;color:var(--txt-mut);margin-left:6px;cursor:pointer;transition:color .15s}
    .ldsp-join-days:hover{color:var(--accent)}
    .ldsp-join-days-num{font-weight:600;color:var(--txt-sec);margin:0 2px;transition:color .15s}
    .ldsp-join-days:hover .ldsp-join-days-num{color:var(--accent)}
    .ldsp-follow-stat{display:flex;align-items:center;gap:3px;padding:2px 6px;background:var(--bg-el);border:1px solid var(--border);border-radius:12px;font-size:9px;color:var(--txt-sec);cursor:pointer;transition:all .15s}
    .ldsp-follow-stat:hover{background:var(--bg-hover);border-color:var(--accent);color:var(--accent)}
    .ldsp-follow-stat:active{transform:scale(.98)}
    .ldsp-follow-stat-icon{display:flex;align-items:center;justify-content:center;width:12px;height:12px;opacity:.7}
    .ldsp-follow-stat-icon svg{width:11px;height:11px;stroke-width:2}
    .ldsp-follow-stat:hover .ldsp-follow-stat-icon{opacity:1}
    .ldsp-follow-stat:hover .ldsp-follow-stat-icon svg{stroke:var(--accent)}
    .ldsp-follow-stat-num{font-weight:700;color:var(--txt);font-size:10px}
    .ldsp-follow-stat-label{font-weight:500;font-size:9px}
    .ldsp-follow-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg);border-radius:0 0 var(--r-lg) var(--r-lg);z-index:10;display:none;flex-direction:column;overflow:hidden}
    .ldsp-follow-overlay.show{display:flex}
    .ldsp-follow-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
    .ldsp-follow-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;color:var(--txt)}
    .ldsp-follow-title svg{width:16px;height:16px;stroke:var(--accent);stroke-width:2}
    .ldsp-follow-close{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--txt-sec);cursor:pointer;transition:background .15s,color .15s}
    .ldsp-follow-close:hover{background:var(--err-bg);color:var(--err);border-color:var(--err)}
    .ldsp-follow-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg-card);flex-shrink:0}
    .ldsp-follow-tab{flex:1;display:flex;align-items:center;justify-content:center;gap:4px;padding:9px 10px;font-size:10px;font-weight:600;color:var(--txt-mut);border-bottom:2px solid transparent;cursor:pointer;transition:color .15s,border-color .15s,background .15s}
    .ldsp-follow-tab:hover:not(.active){background:var(--bg-hover)}
    .ldsp-follow-tab.active{color:var(--accent);border-color:var(--accent)}
    .ldsp-follow-tab-icon{display:flex;align-items:center;justify-content:center;width:14px;height:14px}
    .ldsp-follow-tab-icon svg{width:13px;height:13px;stroke-width:2}
    .ldsp-follow-tab.active .ldsp-follow-tab-icon svg{stroke:var(--accent)}
    .ldsp-follow-tab-count{padding:1px 6px;background:var(--bg-el);border-radius:10px;font-size:10px;font-weight:700;color:var(--txt-sec)}
    .ldsp-follow-tab.active .ldsp-follow-tab-count{background:var(--accent);color:#fff}
    .ldsp-follow-body{flex:1;overflow-y:auto;padding:10px;background:var(--bg)}
    .ldsp-follow-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:40px 20px;color:var(--txt-mut)}
    .ldsp-follow-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:40px 20px;text-align:center;color:var(--txt-mut)}
    .ldsp-follow-empty-icon{width:48px;height:48px;opacity:.4}
    .ldsp-follow-empty-icon svg{width:100%;height:100%;stroke-width:1.5}
    .ldsp-follow-list{display:flex;flex-direction:column;gap:5px}
    .ldsp-follow-item{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);cursor:pointer;transition:all .15s;text-decoration:none;position:relative;overflow:hidden}
    .ldsp-follow-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--accent);opacity:0;transition:opacity .15s}
    .ldsp-follow-item:hover{background:var(--bg-hover);border-color:rgba(107,140,239,.4);box-shadow:0 2px 8px rgba(107,140,239,.08)}
    .ldsp-follow-item:hover::before{opacity:1}
    .ldsp-follow-avatar-wrap{flex-shrink:0;position:relative}
    .ldsp-follow-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;background:var(--bg-el);border:2px solid var(--border);transition:border-color .15s,transform .15s}
    .ldsp-follow-item:hover .ldsp-follow-avatar{border-color:var(--accent);transform:scale(1.05)}
    .ldsp-follow-user-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}
    .ldsp-follow-user-name{font-size:12px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-follow-item:hover .ldsp-follow-user-name{color:var(--accent)}
    .ldsp-follow-user-id{font-size:10px;color:var(--txt-mut);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-follow-arrow{flex-shrink:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--txt-mut);opacity:.4;transition:opacity .15s,transform .15s}
    .ldsp-follow-arrow svg{width:14px;height:14px}
    .ldsp-follow-item:hover .ldsp-follow-arrow{opacity:1;transform:translateX(2px);color:var(--accent)}
    .ldsp-activity-content{flex:1;overflow-y:auto;padding:8px}
    .ldsp-activity-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:8px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-md);min-height:32px;box-sizing:border-box}
    .ldsp-activity-search{flex:1;display:flex;align-items:center;gap:6px;min-width:0;height:20px}
    .ldsp-activity-search-icon{color:var(--txt-mut);font-size:12px;flex-shrink:0;line-height:1;display:flex;align-items:center}
    .ldsp-activity-search input{flex:1;border:none;background:transparent;font-size:12px;color:var(--txt);outline:none;min-width:40px;height:20px;line-height:20px;padding:0;margin:0}
    .ldsp-activity-search input::placeholder{color:var(--txt-mut)}
    .ldsp-activity-search-clear{width:16px;height:16px;display:flex;align-items:center;justify-content:center;background:var(--bg-el);border:none;border-radius:50%;cursor:pointer;color:var(--txt-mut);font-size:10px;line-height:1;transition:all .15s;flex-shrink:0;opacity:0;pointer-events:none}
    .ldsp-activity-search-clear.show{opacity:1;pointer-events:auto}
    .ldsp-activity-search-clear:hover{background:var(--err-bg);color:var(--err)}
    .ldsp-activity-toolbar-divider{width:1px;height:18px;background:var(--border);flex-shrink:0;align-self:center}
    .ldsp-activity-batch{display:flex;align-items:center;gap:4px;flex-shrink:0}
    .ldsp-activity-batch-label{font-size:11px;color:var(--txt-mut);white-space:nowrap;line-height:1;display:flex;align-items:center}
    .ldsp-activity-batch-select{padding:0 6px;background:var(--bg-el);border:1px solid var(--border);border-radius:var(--r-sm);font-size:11px;color:var(--txt);cursor:pointer;outline:none;transition:all .15s;width:52px;height:20px;line-height:18px;vertical-align:middle}
    .ldsp-activity-batch-select:hover,.ldsp-activity-batch-select:focus{border-color:var(--accent);background:var(--bg-hover)}
    .ldsp-activity-batch-select.loading{opacity:.5;pointer-events:none;cursor:wait}
    .ldsp-activity-toolbar.loading{position:relative;pointer-events:none}
    .ldsp-activity-toolbar.loading::after{content:'';position:absolute;inset:0;background:rgba(var(--bg-rgb,255,255,255),.6);border-radius:var(--r-md)}
    .ldsp-topic-list.loading{opacity:.4;pointer-events:none;position:relative}
    .ldsp-activity-loading-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(var(--bg-rgb,255,255,255),.8);border-radius:var(--r-md);z-index:10}
    .ldsp-activity-loading-spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:ldsp-spin 0.8s linear infinite}
    .ldsp-activity-loading-text{margin-top:8px;font-size:11px;color:var(--txt-mut)}
    .ldsp-activity-stats{display:flex;align-items:center;font-size:9px;color:var(--txt-mut);margin-bottom:6px;padding:0 2px}
    .ldsp-activity-stats strong{color:var(--accent);font-weight:600}
    .ldsp-topic-list{display:flex;flex-direction:column;gap:6px}
    .ldsp-topic-list-enhanced .ldsp-topic-item{display:flex;flex-direction:row;align-items:center;gap:8px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:var(--r-md);cursor:pointer;transition:all .15s ease;text-decoration:none}
    .ldsp-topic-item:hover{background:var(--bg-hover);border-color:rgba(107,140,239,.5);border-left-color:#5a7de0;transform:translateX(2px);box-shadow:0 2px 8px rgba(107,140,239,.1)}
    .ldsp-topic-main{flex:1;min-width:0;display:flex;flex-direction:column;gap:6px}
    .ldsp-topic-header{display:flex;flex-direction:column;gap:4px}
    .ldsp-topic-title-row{display:flex;align-items:center;gap:5px;min-width:0}
    .ldsp-topic-badges{display:flex;gap:3px;flex-shrink:0}
    .ldsp-topic-badge{padding:1px 4px;border-radius:6px;font-size:8px;font-weight:600;line-height:1.2}
    .ldsp-badge-unread{background:var(--accent);color:#fff}
    .ldsp-badge-new{background:#10b981;color:#fff}
    .ldsp-topic-title{font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
    .ldsp-topic-item:hover .ldsp-topic-title{color:var(--accent)}
    .ldsp-topic-info{display:flex;align-items:center;gap:4px;flex-wrap:wrap;min-height:16px}
    .ldsp-topic-tags{display:flex;gap:3px;flex-wrap:wrap}
    .ldsp-topic-tag{padding:1px 6px;background:rgba(107,140,239,.08);border:1px solid rgba(107,140,239,.2);border-radius:8px;font-size:8px;color:#5a7de0;max-width:55px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-topic-tag-more{padding:1px 5px;background:rgba(107,140,239,.15);border:1px solid rgba(107,140,239,.3);border-radius:8px;font-size:8px;color:#4a6bc9;font-weight:600}
    .ldsp-topic-footer{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .ldsp-topic-posters{display:flex;align-items:center;flex-shrink:0}
    .ldsp-topic-avatar{width:16px;height:16px;border-radius:50%;border:1.5px solid var(--bg-card);margin-left:-5px;object-fit:cover;background:var(--bg-el)}
    .ldsp-topic-avatar:first-child{margin-left:0}
    .ldsp-poster-op{border-color:var(--accent)}
    .ldsp-poster-latest{border-color:#10b981}
    .ldsp-topic-posters-more{margin-left:2px;font-size:8px;color:var(--txt-mut)}
    .ldsp-topic-stats{display:flex;align-items:center;gap:6px;flex:1;justify-content:flex-end;flex-wrap:nowrap;min-width:0}
    .ldsp-topic-stat{display:flex;align-items:center;gap:2px;font-size:9px;color:var(--txt-mut);white-space:nowrap;flex-shrink:0}
    .ldsp-topic-stat svg{width:10px;height:10px;stroke-width:2;opacity:.6;flex-shrink:0}
    .ldsp-topic-stat em{font-style:normal}
    .ldsp-stat-like{color:#ef4444}
    .ldsp-stat-like svg{stroke:#ef4444;opacity:.8}
    .ldsp-topic-time{font-size:9px;color:var(--txt-mut);opacity:.8;white-space:nowrap;flex-shrink:0}
    .ldsp-topic-thumbnail{width:48px;height:48px;flex-shrink:0;border-radius:6px;overflow:hidden;background:var(--bg-el)}
    .ldsp-topic-thumbnail img{width:100%;height:100%;object-fit:cover;transition:transform .15s}
    .ldsp-topic-item:hover .ldsp-topic-thumbnail img{transform:scale(1.05)}
    .ldsp-bookmark-list{display:flex;flex-direction:column;gap:8px}
    .ldsp-bookmark-item{display:flex;flex-direction:column;gap:6px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-left:3px solid #f59e0b;border-radius:var(--r-md);cursor:pointer;transition:all .15s ease;text-decoration:none}
    .ldsp-bookmark-item:hover{background:var(--bg-hover);border-color:rgba(245,158,11,.5);border-left-color:#eab308;transform:translateX(2px);box-shadow:0 2px 8px rgba(245,158,11,.1)}
    .ldsp-bookmark-title{font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .ldsp-bookmark-item:hover .ldsp-bookmark-title{color:#b45309}
    .ldsp-bookmark-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:9px;color:var(--txt-mut);align-items:center}
    .ldsp-bookmark-time{display:flex;align-items:center;gap:3px;white-space:nowrap}
    .ldsp-bookmark-time svg{width:10px;height:10px;stroke-width:2;flex-shrink:0;opacity:.6}
    .ldsp-bookmark-tags{display:flex;flex-wrap:wrap;gap:3px}
    .ldsp-bookmark-tag{padding:1px 6px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:8px;font-size:8px;color:#b45309;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-bookmark-tag-more{padding:1px 5px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);border-radius:8px;font-size:8px;color:#92400e;font-weight:600}
    .ldsp-bookmark-excerpt{font-size:10px;color:var(--txt-sec);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;padding:6px 0 0;word-break:break-word;border-top:1px dashed var(--border);margin-top:2px}
    .ldsp-bookmark-excerpt *{all:revert;font-size:inherit;line-height:inherit;color:inherit;margin:0;padding:0;border:none;background:none;box-shadow:none}
    .ldsp-bookmark-excerpt img{display:inline-block!important;max-width:18px!important;max-height:18px!important;vertical-align:middle!important;margin:0 2px!important;border-radius:2px!important}
    .ldsp-bookmark-excerpt a{color:var(--accent)!important;text-decoration:none!important}
    .ldsp-bookmark-excerpt a:hover{text-decoration:underline!important}
    .ldsp-bookmark-excerpt .emoji{width:18px!important;height:18px!important;vertical-align:middle!important}
    .ldsp-bookmark-excerpt .lightbox,.ldsp-bookmark-excerpt .lightbox img{display:inline!important;max-width:18px!important;max-height:18px!important}
    .ldsp-bookmark-excerpt .anchor{display:none!important}
    .ldsp-reply-list{display:flex;flex-direction:column;gap:8px}
    .ldsp-reply-item{display:flex;flex-direction:column;gap:6px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-left:3px solid #10b981;border-radius:var(--r-md);cursor:pointer;transition:all .15s ease}
    .ldsp-reply-item:hover{background:var(--bg-hover);border-color:rgba(16,185,129,.5);border-left-color:#059669;transform:translateX(2px);box-shadow:0 2px 8px rgba(16,185,129,.1)}
    .ldsp-reply-title{font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .ldsp-reply-item:hover .ldsp-reply-title{color:#059669}
    .ldsp-reply-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:9px;color:var(--txt-mut);align-items:center}
    .ldsp-reply-time,.ldsp-reply-to{display:flex;align-items:center;gap:3px;white-space:nowrap}
    .ldsp-reply-time svg,.ldsp-reply-to svg{width:10px;height:10px;stroke-width:2;flex-shrink:0;opacity:.6}
    .ldsp-reply-to{color:#10b981;font-weight:500}
    .ldsp-reply-excerpt{font-size:10px;color:var(--txt-sec);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;padding:6px 0 0;word-break:break-word;border-top:1px dashed var(--border);margin-top:2px}
    .ldsp-reply-excerpt *{all:revert;font-size:inherit;line-height:inherit;color:inherit;margin:0;padding:0;border:none;background:none;box-shadow:none}
    .ldsp-reply-excerpt img{display:inline-block!important;max-width:16px!important;max-height:16px!important;vertical-align:middle!important;margin:0 2px!important;border-radius:2px!important}
    .ldsp-reply-excerpt a{color:var(--accent)!important;text-decoration:none!important}
    .ldsp-reply-excerpt a:hover{text-decoration:underline!important}
    .ldsp-reply-excerpt .emoji{width:16px!important;height:16px!important;vertical-align:middle!important}
    .ldsp-reply-excerpt .lightbox,.ldsp-reply-excerpt .lightbox img{display:inline!important;max-width:16px!important;max-height:16px!important}
    .ldsp-reply-excerpt .anchor{display:none!important}
    .ldsp-like-list{display:flex;flex-direction:column;gap:8px}
    .ldsp-like-item{display:flex;flex-direction:column;gap:6px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-left:3px solid #ef4444;border-radius:var(--r-md);cursor:pointer;transition:all .15s ease}
    .ldsp-like-item:hover{background:var(--bg-hover);border-color:rgba(239,68,68,.5);border-left-color:#dc2626;transform:translateX(2px);box-shadow:0 2px 8px rgba(239,68,68,.1)}
    .ldsp-like-title{font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .ldsp-like-item:hover .ldsp-like-title{color:#dc2626}
    .ldsp-like-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:9px;color:var(--txt-mut);align-items:center}
    .ldsp-like-time,.ldsp-like-author{display:flex;align-items:center;gap:3px;white-space:nowrap}
    .ldsp-like-time svg,.ldsp-like-author svg{width:10px;height:10px;stroke-width:2;flex-shrink:0;opacity:.6}
    .ldsp-like-author{color:#ef4444;font-weight:500}
    .ldsp-like-author svg{fill:#ef4444;stroke:none;opacity:.8}
    .ldsp-like-excerpt{font-size:10px;color:var(--txt-sec);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;padding:6px 0 0;word-break:break-word;border-top:1px dashed var(--border);margin-top:2px}
    .ldsp-like-excerpt *{all:revert;font-size:inherit;line-height:inherit;color:inherit;margin:0;padding:0;border:none;background:none;box-shadow:none}
    .ldsp-like-excerpt img{display:inline-block!important;max-width:16px!important;max-height:16px!important;vertical-align:middle!important;margin:0 2px!important;border-radius:2px!important}
    .ldsp-like-excerpt a{color:var(--accent)!important;text-decoration:none!important}
    .ldsp-like-excerpt a:hover{text-decoration:underline!important}
    .ldsp-like-excerpt .emoji{width:16px!important;height:16px!important;vertical-align:middle!important}
    .ldsp-like-excerpt .lightbox,.ldsp-like-excerpt .lightbox img{display:inline!important;max-width:16px!important;max-height:16px!important}
    .ldsp-like-excerpt .anchor{display:none!important}
    .ldsp-mytopic-list{display:flex;flex-direction:column;gap:8px}
    .ldsp-mytopic-item{display:flex;flex-direction:column;gap:5px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-left:3px solid #8b5cf6;border-radius:var(--r-md);cursor:pointer;transition:all .15s ease;text-decoration:none}
    .ldsp-mytopic-item:hover{background:var(--bg-hover);border-color:rgba(139,92,246,.5);border-left-color:#7c3aed;transform:translateX(2px);box-shadow:0 2px 8px rgba(139,92,246,.1)}
    .ldsp-mytopic-item.closed{opacity:.7}
    .ldsp-mytopic-item.closed .ldsp-mytopic-title{text-decoration:line-through;color:var(--txt-mut)}
    .ldsp-mytopic-header{display:flex;align-items:flex-start;gap:6px}
    .ldsp-mytopic-title{flex:1;font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .ldsp-mytopic-item:hover .ldsp-mytopic-title{color:#7c3aed}
    .ldsp-mytopic-icons{display:flex;gap:3px;flex-shrink:0}
    .ldsp-mytopic-status{display:flex;align-items:center;justify-content:center;width:14px;height:14px}
    .ldsp-mytopic-status svg{width:11px;height:11px;fill:#8b5cf6}
    .ldsp-mytopic-status.ldsp-mytopic-closed svg{fill:var(--txt-mut);stroke:var(--txt-mut);stroke-width:2}
    .ldsp-mytopic-row{display:flex;align-items:center;flex-wrap:nowrap;gap:6px}
    .ldsp-mytopic-tags{display:flex;flex-wrap:wrap;gap:3px;flex:1;min-width:0}
    .ldsp-mytopic-tag{padding:1px 6px;background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:8px;font-size:8px;color:#7c3aed;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ldsp-mytopic-tag-more{padding:1px 5px;background:rgba(139,92,246,.15);border:1px solid rgba(139,92,246,.3);border-radius:8px;font-size:8px;color:#6d28d9;font-weight:600}
    .ldsp-mytopic-time{display:flex;align-items:center;gap:3px;font-size:8px;color:var(--txt-mut);flex-shrink:0;white-space:nowrap}
    .ldsp-mytopic-time svg{width:9px;height:9px;stroke-width:2;flex-shrink:0;opacity:.7}
    .ldsp-mytopic-meta{display:flex;align-items:center;gap:8px;font-size:9px;color:var(--txt-mut);padding-top:5px;border-top:1px solid var(--border)}
    .ldsp-mytopic-stat{display:flex;align-items:center;gap:2px;white-space:nowrap}
    .ldsp-mytopic-stat svg{width:11px;height:11px;stroke-width:2;flex-shrink:0}
    .ldsp-mytopic-likes{color:#ef4444}
    .ldsp-mytopic-likes svg{stroke:#ef4444}
    .ldsp-mytopic-meta-right{display:flex;align-items:center;gap:6px;margin-left:auto;font-size:8px;white-space:nowrap}
    .ldsp-reaction-list{display:flex;flex-direction:column;gap:8px}
    .ldsp-reaction-item{display:flex;flex-direction:column;gap:6px;padding:10px;background:var(--bg-card);border:1px solid var(--border);border-left:3px solid #06b6d4;border-radius:var(--r-md);cursor:pointer;transition:all .15s ease}
    .ldsp-reaction-item:hover{background:var(--bg-hover);border-color:rgba(6,182,212,.5);border-left-color:#0891b2;transform:translateX(2px);box-shadow:0 2px 8px rgba(6,182,212,.1)}
    .ldsp-reaction-header{display:flex;align-items:center;gap:8px}
    .ldsp-reaction-icon{font-size:16px;flex-shrink:0;display:flex;align-items:center;justify-content:center;width:24px;height:24px;background:rgba(6,182,212,.1);border-radius:6px}
    .ldsp-reaction-title{flex:1;font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .ldsp-reaction-item:hover .ldsp-reaction-title{color:#0891b2}
    .ldsp-reaction-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:9px;color:var(--txt-mut);align-items:center}
    .ldsp-reaction-avatar{width:16px;height:16px;border-radius:50%;flex-shrink:0;object-fit:cover}
    .ldsp-reaction-author{display:flex;align-items:center;gap:3px;white-space:nowrap;color:#06b6d4;font-weight:500}
    .ldsp-reaction-time{display:flex;align-items:center;gap:3px;white-space:nowrap}
    .ldsp-reaction-time svg{width:10px;height:10px;stroke-width:2;flex-shrink:0;opacity:.6}
    .ldsp-reaction-count{padding:1px 5px;background:rgba(6,182,212,.15);border:1px solid rgba(6,182,212,.3);border-radius:8px;font-size:8px;color:#0891b2;font-weight:600}
    .ldsp-reaction-excerpt{font-size:10px;color:var(--txt-sec);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;padding:6px 0 0;word-break:break-word;border-top:1px dashed var(--border);margin-top:2px}
    .ldsp-reaction-excerpt *{all:revert;font-size:inherit;line-height:inherit;color:inherit;margin:0;padding:0;border:none;background:none;box-shadow:none}
    .ldsp-reaction-excerpt img{display:inline-block!important;max-width:16px!important;max-height:16px!important;vertical-align:middle!important;margin:0 2px!important;border-radius:2px!important}
    .ldsp-reaction-excerpt a{color:var(--accent)!important;text-decoration:none!important}
    .ldsp-reaction-excerpt a:hover{text-decoration:underline!important}
    .ldsp-reaction-excerpt .emoji{width:16px!important;height:16px!important;vertical-align:middle!important}
    .ldsp-reaction-excerpt .lightbox,.ldsp-reaction-excerpt .lightbox img{display:inline!important;max-width:16px!important;max-height:16px!important}
    .ldsp-reaction-excerpt .anchor{display:none!important}
    /* æ´»åŠ¨å†…å®¹åŒºå“åº”å¼ */
    @media (max-width:380px){.ldsp-activity-content{padding:8px}.ldsp-topic-list{gap:6px}.ldsp-topic-item{padding:10px;gap:8px}.ldsp-topic-title{font-size:12px}.ldsp-topic-footer{gap:6px}.ldsp-topic-stats{gap:6px}.ldsp-topic-stat{font-size:9px}.ldsp-topic-time{font-size:9px}.ldsp-topic-thumbnail{width:48px;height:48px}.ldsp-bookmark-list,.ldsp-reply-list,.ldsp-like-list,.ldsp-reaction-list,.ldsp-mytopic-list{gap:8px}.ldsp-bookmark-item,.ldsp-reply-item,.ldsp-like-item,.ldsp-reaction-item,.ldsp-mytopic-item{padding:10px}.ldsp-bookmark-title,.ldsp-reply-title,.ldsp-like-title,.ldsp-reaction-title,.ldsp-mytopic-title{font-size:12px}.ldsp-bookmark-meta,.ldsp-reply-meta,.ldsp-like-meta,.ldsp-reaction-meta,.ldsp-mytopic-meta{gap:10px;font-size:9px}.ldsp-follow-stats{gap:6px}.ldsp-follow-stat{padding:3px 6px;font-size:9px}.ldsp-follow-tab{padding:8px 10px;font-size:10px}.ldsp-follow-item{padding:10px;gap:10px}.ldsp-follow-avatar{width:36px;height:36px}.ldsp-follow-user-name{font-size:12px}}
    @media (max-width:320px){.ldsp-activity-content{padding:6px}.ldsp-topic-list{gap:4px}.ldsp-topic-item{padding:8px;gap:6px}.ldsp-topic-title{font-size:11px}.ldsp-topic-footer{gap:4px}.ldsp-topic-stats{gap:4px}.ldsp-topic-stat{font-size:8px}.ldsp-topic-stat svg{width:9px;height:9px}.ldsp-topic-time{font-size:8px}.ldsp-topic-thumbnail{width:40px;height:40px}.ldsp-topic-avatar{width:14px;height:14px;margin-left:-4px}.ldsp-topic-tag{max-width:45px;font-size:7px}.ldsp-bookmark-list,.ldsp-reply-list,.ldsp-like-list,.ldsp-reaction-list,.ldsp-mytopic-list{gap:6px}.ldsp-bookmark-item,.ldsp-reply-item,.ldsp-like-item,.ldsp-reaction-item,.ldsp-mytopic-item{padding:8px}.ldsp-bookmark-title,.ldsp-reply-title,.ldsp-like-title,.ldsp-reaction-title,.ldsp-mytopic-title{font-size:10px}.ldsp-bookmark-meta,.ldsp-reply-meta,.ldsp-like-meta,.ldsp-reaction-meta,.ldsp-mytopic-meta{gap:8px;font-size:8px}.ldsp-bookmark-excerpt,.ldsp-reply-excerpt,.ldsp-like-excerpt,.ldsp-reaction-excerpt{font-size:9px;-webkit-line-clamp:2}.ldsp-bookmark-tag,.ldsp-reply-to,.ldsp-like-author,.ldsp-reaction-author,.ldsp-mytopic-tag{font-size:7px}.ldsp-bookmark-time svg,.ldsp-reply-time svg,.ldsp-like-time svg,.ldsp-reaction-time svg,.ldsp-mytopic-time svg{width:9px;height:9px}.ldsp-follow-stats{gap:4px}.ldsp-follow-stat{padding:2px 4px;font-size:8px}.ldsp-follow-stat-icon{width:10px;height:10px}.ldsp-follow-stat-icon svg{width:9px;height:9px}.ldsp-follow-stat-num{font-size:9px}.ldsp-follow-tab{padding:7px 8px;font-size:9px}.ldsp-follow-tab-icon{width:12px;height:12px}.ldsp-follow-tab-icon svg{width:11px;height:11px}.ldsp-follow-tab-count{font-size:8px;padding:1px 4px}.ldsp-follow-item{padding:8px;gap:8px}.ldsp-follow-avatar{width:32px;height:32px}.ldsp-follow-user-name{font-size:11px}.ldsp-follow-user-id{font-size:9px}}
    @media (max-width:280px){.ldsp-topic-thumbnail{display:none}.ldsp-topic-posters{display:none}.ldsp-topic-stats{justify-content:flex-start}.ldsp-topic-tags{display:none}.ldsp-bookmark-tags,.ldsp-mytopic-tags{display:none}.ldsp-bookmark-excerpt,.ldsp-reply-excerpt,.ldsp-like-excerpt,.ldsp-reaction-excerpt{-webkit-line-clamp:2}.ldsp-follow-stat-label{display:none}.ldsp-follow-arrow{display:none}.ldsp-follow-tab-text{display:none}.ldsp-activity-content{padding:4px}.ldsp-topic-item{padding:6px}.ldsp-topic-title{font-size:10px}.ldsp-bookmark-item,.ldsp-reply-item,.ldsp-like-item,.ldsp-reaction-item,.ldsp-mytopic-item{padding:6px}.ldsp-bookmark-title,.ldsp-reply-title,.ldsp-like-title,.ldsp-reaction-title,.ldsp-mytopic-title{font-size:9px}.ldsp-follow-item{padding:6px;gap:6px}.ldsp-follow-avatar{width:28px;height:28px}.ldsp-follow-user-name{font-size:10px}.ldsp-reaction-icon{width:20px;height:20px;font-size:14px}}
    .ldsp-load-more{display:flex;align-items:center;justify-content:center;padding:12px;color:var(--txt-sec);font-size:10px}
    .ldsp-load-more.loading::after{content:'';width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:ldsp-spin .8s linear infinite;margin-left:6px}
    .ldsp-activity-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--txt-mut)}
    .ldsp-activity-placeholder-icon{font-size:32px;margin-bottom:10px;opacity:.5}
    .ldsp-activity-placeholder-text{font-size:11px}
    .ldsp-tooltip{position:fixed;z-index:2147483647;max-width:220px;padding:6px 10px;background:linear-gradient(135deg,rgba(30,32,48,.96),rgba(24,26,38,.98));color:#e8eaf0;font-size:11px;font-weight:500;line-height:1.4;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.3),0 0 0 1px rgba(255,255,255,.06);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);pointer-events:none;opacity:0;transform:translateY(4px);transition:opacity .15s ease,transform .15s ease;white-space:pre-line;word-break:break-word}
    .ldsp-tooltip.show{opacity:1;transform:translateY(0)}
    .ldsp-tooltip::before{content:'';position:absolute;width:8px;height:8px;background:inherit;transform:rotate(45deg);box-shadow:-1px -1px 0 rgba(255,255,255,.06)}
    .ldsp-tooltip.top::before{bottom:-4px;left:50%;margin-left:-4px}
    .ldsp-tooltip.bottom::before{top:-4px;left:50%;margin-left:-4px}
    .ldsp-tooltip.left::before{bottom:-4px;right:12px}
    .ldsp-tooltip.right::before{bottom:-4px;left:12px}
    #ldsp-panel.light .ldsp-tooltip{background:linear-gradient(135deg,rgba(255,255,255,.98),rgba(248,250,254,.98));color:#2d3148;box-shadow:0 4px 16px rgba(0,0,0,.12),0 0 0 1px rgba(0,0,0,.06)}
    #ldsp-panel.light .ldsp-tooltip::before{box-shadow:-1px -1px 0 rgba(0,0,0,.04)}`;
            }
        };
        
        // ==================== Tooltip ç®¡ç†å™¨ ====================
        const Tooltip = {
            el: null,
            timer: null,
            currentTarget: null,
            
            init() {
                if (this.el) return;
                this.el = document.createElement('div');
                this.el.className = 'ldsp-tooltip';
                document.body.appendChild(this.el);
            },
            
            show(target, text, delay = 400) {
                if (!text || !target) return;
                this.hide();
                this.currentTarget = target;
                this.timer = setTimeout(() => {
                    if (this.currentTarget !== target) return;
                    this.el.textContent = text;
                    this.el.classList.remove('show', 'top', 'bottom', 'left', 'right');
                    
                    // å…ˆæ˜¾ç¤ºä»¥è·å–å°ºå¯¸
                    this.el.style.visibility = 'hidden';
                    this.el.style.display = 'block';
                    
                    const rect = target.getBoundingClientRect();
                    const tipRect = this.el.getBoundingClientRect();
                    const padding = 8;
                    
                    // è®¡ç®—ä½ç½®ï¼ˆä¼˜å…ˆæ˜¾ç¤ºåœ¨ä¸Šæ–¹ï¼‰
                    let top, left;
                    const spaceAbove = rect.top;
                    const spaceBelow = window.innerHeight - rect.bottom;
                    
                    if (spaceAbove >= tipRect.height + padding || spaceAbove > spaceBelow) {
                        // æ˜¾ç¤ºåœ¨ä¸Šæ–¹
                        top = rect.top - tipRect.height - padding;
                        this.el.classList.add('top');
                    } else {
                        // æ˜¾ç¤ºåœ¨ä¸‹æ–¹
                        top = rect.bottom + padding;
                        this.el.classList.add('bottom');
                    }
                    
                    // æ°´å¹³å±…ä¸­ï¼Œä½†ä¸è¶…å‡ºå±å¹•
                    left = rect.left + (rect.width - tipRect.width) / 2;
                    if (left < padding) {
                        left = padding;
                        this.el.classList.add('right');
                    } else if (left + tipRect.width > window.innerWidth - padding) {
                        left = window.innerWidth - tipRect.width - padding;
                        this.el.classList.add('left');
                    }
                    
                    // ç¡®ä¿ä¸è¶…å‡ºé¡¶éƒ¨
                    if (top < padding) top = padding;
                    
                    this.el.style.top = `${top}px`;
                    this.el.style.left = `${left}px`;
                    this.el.style.visibility = '';
                    
                    // æ·»åŠ é¢æ¿ä¸»é¢˜ç±»
                    const panel = document.getElementById('ldsp-panel');
                    if (panel?.classList.contains('light')) {
                        this.el.closest('body').querySelector('.ldsp-tooltip')?.classList.add('light-theme');
                    }
                    
                    requestAnimationFrame(() => this.el.classList.add('show'));
                }, delay);
            },
            
            hide() {
                if (this.timer) {
                    clearTimeout(this.timer);
                    this.timer = null;
                }
                this.currentTarget = null;
                if (this.el) {
                    this.el.classList.remove('show');
                }
            },
            
            // ç»‘å®šåˆ°é¢æ¿
            bindToPanel(panel) {
                this.init();
                
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜
                panel.addEventListener('mouseenter', (e) => {
                    const target = e.target.closest('[title], [data-tip], [data-ldsp-tooltip]');
                    if (!target) return;
                    const text = target.dataset.ldspTooltip || target.dataset.tip || target.getAttribute('title');
                    if (text) {
                        // ä¸´æ—¶ç§»é™¤ title é˜²æ­¢æµè§ˆå™¨é»˜è®¤æç¤º
                        if (target.hasAttribute('title')) {
                            target.dataset.tip = text;
                            target.removeAttribute('title');
                        }
                        this.show(target, text);
                    }
                }, true);
                
                panel.addEventListener('mouseleave', (e) => {
                    const target = e.target.closest('[data-tip], [data-ldsp-tooltip]');
                    if (target) this.hide();
                }, true);
                
                // æ»šåŠ¨å’Œç‚¹å‡»æ—¶éšè—
                panel.addEventListener('scroll', () => this.hide(), true);
                panel.addEventListener('click', () => this.hide(), true);
            }
        };

        // ==================== å·¥å•ç®¡ç†å™¨ ====================
        class TicketManager {
            // è·¨æ ‡ç­¾é¡µå…±äº«çš„ç¼“å­˜ key
            static CACHE_KEY = 'ldsp_ticket_unread';
            static CACHE_TTL = 30 * 1000;  // 30 ç§’ç¼“å­˜æœ‰æ•ˆæœŸ
            
            constructor(oauth, panelBody) {
                this.oauth = oauth;
                this.panelBody = panelBody;
                this.overlay = null;
                this.ticketTypes = [];
                this.tickets = [];
                this.currentTicket = null;
                this.currentView = 'list';
                this.unreadCount = 0;
                this._isOverlayOpen = false;  // å·¥å•é¢æ¿æ˜¯å¦æ‰“å¼€
                this._lastHiddenTime = null;  // é¡µé¢éšè—æ—¶é—´ï¼Œç”¨äºè§¦å‘å¼æ£€æµ‹
                this._checkUnreadPending = false;  // v3.5.2.9: é˜²æ­¢é‡å¤è¯·æ±‚
            }

            async init() {
                this._createOverlay();
                await this._loadTicketTypes();
                this._bindVisibilityHandler();
                // å»¶è¿Ÿ 5 ç§’åé¦–æ¬¡æ£€æŸ¥
                setTimeout(() => this._checkUnread(), 5000);
            }
            
            _bindVisibilityHandler() {
                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶è§¦å‘å¼æ£€æµ‹ï¼ˆåˆ‡æ¢æ ‡ç­¾é¡µã€æœ€å°åŒ–çª—å£ç­‰ï¼‰
                this._visibilityHandler = () => {
                    if (document.hidden) {
                        // é¡µé¢éšè—æ—¶ï¼Œè®°å½•æ—¶é—´
                        this._lastHiddenTime = Date.now();
                    } else {
                        // é¡µé¢æ¢å¤å¯è§æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦è¶…è¿‡10åˆ†é’Ÿé˜ˆå€¼
                        const hiddenDuration = this._lastHiddenTime ? Date.now() - this._lastHiddenTime : 0;
                        const TEN_MINUTES = 10 * 60 * 1000;  // 10åˆ†é’Ÿ
                        if (hiddenDuration >= TEN_MINUTES) {
                            // è¶…è¿‡10åˆ†é’Ÿï¼Œè§¦å‘æ£€æµ‹
                            this._checkUnread();
                        }
                        this._lastHiddenTime = null;
                    }
                };
                document.addEventListener('visibilitychange', this._visibilityHandler);
            }

            _createOverlay() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'ldsp-ticket-overlay';
                this.overlay.innerHTML = `
                    <div class="ldsp-ticket-header">
                        <div class="ldsp-ticket-title">ğŸ“ª å·¥å•ç³»ç»Ÿ</div>
                        <div class="ldsp-ticket-close">Ã—</div>
                    </div>
                    <div class="ldsp-ticket-tabs">
                        <div class="ldsp-ticket-tab active" data-tab="list">æˆ‘çš„å·¥å•</div>
                        <div class="ldsp-ticket-tab" data-tab="create">æäº¤å·¥å•</div>
                    </div>
                    <div class="ldsp-ticket-body"></div>`;
                if (this.panelBody) {
                    this.panelBody.appendChild(this.overlay);
                }
                this._bindEvents();
            }

            _bindEvents() {
                this.overlay.querySelector('.ldsp-ticket-close').addEventListener('click', () => this.hide());
                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('show')) this.hide();
                });
                this.overlay.querySelectorAll('.ldsp-ticket-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.overlay.querySelectorAll('.ldsp-ticket-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const tabName = tab.dataset.tab;
                        if (tabName === 'list') {
                            // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                            this._showListLoading();
                            this._loadTickets().then(() => this._renderList());
                        } else if (tabName === 'create') {
                            this._renderCreate();
                        }
                    });
                });
            }

            async _loadTicketTypes() {
                const defaultTypes = [
                    { id: 'feature_request', label: 'åŠŸèƒ½å»ºè®®', icon: 'ğŸ’¡' },
                    { id: 'bug_report', label: 'BUGåé¦ˆ', icon: 'ğŸ“ª' }
                ];
                try {
                    const result = await this.oauth?.api('/api/tickets/types');
                    const data = result?.data?.data || result?.data;
                    this.ticketTypes = (result?.success && data?.types) ? data.types : defaultTypes;
                } catch (e) {
                    this.ticketTypes = defaultTypes;
                }
            }

            // æ£€æŸ¥æœªè¯»å·¥å•æ•°ï¼ˆè§¦å‘å¼è°ƒç”¨ï¼Œæ”¯æŒè·¨æ ‡ç­¾é¡µç¼“å­˜ï¼‰
            // è§¦å‘æ—¶æœºï¼š1. é¢æ¿æ‰“å¼€ 2. é¡µé¢å¯è§æ€§æ¢å¤(>10åˆ†é’Ÿ) 3. æ•°æ®åŒæ­¥å®Œæˆ
            async _checkUnread(forceRefresh = false) {
                // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!this.oauth?.isLoggedIn()) return;
                
                // v3.5.2.9: é˜²æ­¢å¹¶å‘è¯·æ±‚
                if (this._checkUnreadPending) return;
                
                const now = Date.now();
                
                // 2. æ£€æŸ¥è·¨æ ‡ç­¾é¡µå…±äº«ç¼“å­˜ï¼ˆé™¤éå¼ºåˆ¶åˆ·æ–°ï¼‰
                if (!forceRefresh) {
                    try {
                        const cached = GM_getValue(TicketManager.CACHE_KEY, null);
                        if (cached && (now - cached.time) < TicketManager.CACHE_TTL) {
                            // ä½¿ç”¨ç¼“å­˜æ•°æ®æ›´æ–°å¾½ç« 
                            this.unreadCount = cached.count || 0;
                            this._updateBadge();
                            return;
                        }
                    } catch (e) { /* ç¼“å­˜è¯»å–å¤±è´¥ï¼Œç»§ç»­è¯·æ±‚ */ }
                }
                
                // 3. å‘èµ·è¯·æ±‚
                this._checkUnreadPending = true;
                try {
                    const result = await this.oauth.api('/api/tickets/unread/count');
                    const data = result.data?.data || result.data;
                    if (result.success) {
                        this.unreadCount = data?.count || 0;
                        this._updateBadge();
                        // æ›´æ–°è·¨æ ‡ç­¾é¡µç¼“å­˜
                        try {
                            GM_setValue(TicketManager.CACHE_KEY, { count: this.unreadCount, time: now });
                        } catch (e) { /* ç¼“å­˜å†™å…¥å¤±è´¥ï¼Œå¿½ç•¥ */ }
                    }
                } catch (e) {
                    // é™é»˜å¤±è´¥ï¼ˆæœªç™»å½•ç­‰æƒ…å†µï¼‰
                } finally {
                    this._checkUnreadPending = false;
                }
            }

            _updateBadge() {
                const btn = document.querySelector('.ldsp-ticket-btn');
                if (!btn) return;
                let badge = btn.querySelector('.ldsp-ticket-badge');
                if (this.unreadCount > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'ldsp-ticket-badge';
                        btn.appendChild(badge);
                    }
                    badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
                } else if (badge) {
                    badge.remove();
                }
            }

            async show() {
                this.currentView = 'list';
                this._isOverlayOpen = true;
                const activeTab = this.overlay.querySelector('.ldsp-ticket-tab.active');
                if (activeTab?.dataset.tab === 'create') {
                    this._renderCreate();
                } else {
                    // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    this._showListLoading();
                }
                this.overlay.classList.add('show');
                // å¼‚æ­¥åŠ è½½å·¥å•åˆ—è¡¨
                await this._loadTickets();
                this._updateTabBadge();
                if (activeTab?.dataset.tab !== 'create') {
                    this._renderList();
                }
                // å·¥å•é¢æ¿æ‰“å¼€æ—¶ç«‹å³æ£€æŸ¥ä¸€æ¬¡ï¼ˆè§¦å‘å¼æ£€æµ‹ï¼‰
                if (!document.hidden) {
                    this._checkUnread(true);  // å¼ºåˆ¶åˆ·æ–°ï¼Œå¿½ç•¥ç¼“å­˜
                }
            }

            _updateTabBadge() {
                const listTab = this.overlay.querySelector('.ldsp-ticket-tab[data-tab="list"]');
                if (!listTab) return;
                const hasUnread = this.tickets.some(t => t.has_new_reply);
                listTab.classList.toggle('has-unread', hasUnread);
            }

            _showListLoading() {
                const body = this.overlay.querySelector('.ldsp-ticket-body');
                if (!body) return;
                body.classList.remove('detail-mode');
                body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;flex:1;min-height:120px"><div class="ldsp-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div></div>';
            }

            hide() {
                this._isOverlayOpen = false;
                this.overlay.classList.remove('show');
                this.currentView = 'list';
                this.currentTicket = null;
                this.overlay.querySelectorAll('.ldsp-ticket-tab').forEach(t => t.classList.remove('active'));
                this.overlay.querySelector('.ldsp-ticket-tab[data-tab="list"]')?.classList.add('active');
            }

            async _loadTickets() {
                try {
                    const result = await this.oauth?.api('/api/tickets');
                    const data = result?.data?.data || result?.data;
                    this.tickets = result?.success ? (data?.tickets || []) : [];
                } catch (e) {
                    this.tickets = [];
                }
            }

            _renderList() {
                this.currentView = 'list';
                const body = this.overlay.querySelector('.ldsp-ticket-body');
                body.classList.remove('detail-mode');
                
                if (this.tickets.length === 0) {
                    body.innerHTML = `
                        <div class="ldsp-ticket-empty">
                            <div class="ldsp-ticket-empty-icon">ğŸ“­</div>
                            <div>æš‚æ— å·¥å•è®°å½•</div>
                            <div style="margin-top:6px;font-size:10px">ç‚¹å‡»"æäº¤å·¥å•"åé¦ˆå»ºè®®æˆ–é—®é¢˜</div>
                        </div>`;
                    return;
                }

                body.innerHTML = `
                    <div class="ldsp-ticket-list">
                        ${this.tickets.map(t => `
                            <div class="ldsp-ticket-item ${t.has_new_reply ? 'has-reply' : ''}" data-id="${t.id}">
                                <div class="ldsp-ticket-item-header">
                                    <span class="ldsp-ticket-item-type">${this._getTypeIcon(t.type)} ${this._getTypeLabel(t.type)}</span>
                                    <span class="ldsp-ticket-item-status ${t.status}">${t.status === 'open' ? 'å¤„ç†ä¸­' : 'å·²å…³é—­'}</span>
                                </div>
                                <div class="ldsp-ticket-item-title">${Utils.sanitize(t.title, 50)}</div>
                                <div class="ldsp-ticket-item-meta">
                                    <span>#${t.id}</span>
                                    <span>${this._formatTime(t.created_at)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;

                body.querySelectorAll('.ldsp-ticket-item').forEach(item => {
                    item.addEventListener('click', () => this._showDetail(item.dataset.id));
                });
            }

            _renderCreate() {
                this.currentView = 'create';
                const body = this.overlay.querySelector('.ldsp-ticket-body');
                body.classList.remove('detail-mode');
                
                if (!this.ticketTypes || this.ticketTypes.length === 0) {
                    this.ticketTypes = [
                        { id: 'feature_request', label: 'åŠŸèƒ½å»ºè®®', icon: 'ğŸ’¡' },
                        { id: 'bug_report', label: 'BUGåé¦ˆ', icon: 'ğŸ“ª' }
                    ];
                }
                
                // ä¸åŒç±»å‹çš„ placeholder æç¤º
                const placeholders = {
                    'feature_request': 'è¯·è¯¦ç»†æè¿°æ‚¨çš„åŠŸèƒ½å»ºè®®...',
                    'bug_report': 'è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ï¼Œå»ºè®®åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\n\nâ€¢ æµè§ˆå™¨åŠç‰ˆæœ¬ï¼ˆå¦‚ Chrome 120ï¼‰\nâ€¢ æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows 11ï¼‰\nâ€¢ é—®é¢˜å¤ç°æ­¥éª¤\nâ€¢ é¢„æœŸè¡Œä¸ºä¸å®é™…è¡Œä¸º'
                };
                const defaultPlaceholder = placeholders[this.ticketTypes[0]?.id] || placeholders['feature_request'];
                
                body.innerHTML = `
                    <div class="ldsp-ticket-form">
                        <div class="ldsp-ticket-form-group">
                            <div class="ldsp-ticket-label">å·¥å•ç±»å‹</div>
                            <div class="ldsp-ticket-types">
                                ${this.ticketTypes.map((t, i) => `
                                    <div class="ldsp-ticket-type ${i === 0 ? 'selected' : ''}" data-type="${t.id}">
                                        <span class="ldsp-ticket-type-icon">${t.icon}</span>
                                        <span class="ldsp-ticket-type-label">${t.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="ldsp-ticket-form-group">
                            <div class="ldsp-ticket-label">æ ‡é¢˜ <span style="color:var(--txt-mut);font-weight:400">(4-50å­—)</span></div>
                            <input type="text" class="ldsp-ticket-input" placeholder="ç®€è¦æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®" minlength="4" maxlength="50">
                        </div>
                        <div class="ldsp-ticket-form-group">
                            <div class="ldsp-ticket-label">è¯¦ç»†æè¿° <span style="color:var(--txt-mut);font-weight:400">(8-500å­—)</span></div>
                            <textarea class="ldsp-ticket-textarea" placeholder="${defaultPlaceholder}" minlength="8" maxlength="500"></textarea>
                        </div>
                        <button class="ldsp-ticket-submit">æäº¤å·¥å•</button>
                    </div>`;

                const textarea = body.querySelector('.ldsp-ticket-textarea');
                body.querySelectorAll('.ldsp-ticket-type').forEach(type => {
                    type.addEventListener('click', () => {
                        body.querySelectorAll('.ldsp-ticket-type').forEach(t => t.classList.remove('selected'));
                        type.classList.add('selected');
                        // æ ¹æ®ç±»å‹æ›´æ–° placeholder
                        const selectedType = type.dataset.type;
                        textarea.placeholder = placeholders[selectedType] || placeholders['feature_request'];
                    });
                });

                body.querySelector('.ldsp-ticket-submit').addEventListener('click', () => this._submitTicket());
            }

            async _submitTicket() {
                const body = this.overlay.querySelector('.ldsp-ticket-body');
                const type = body.querySelector('.ldsp-ticket-type.selected')?.dataset.type;
                const title = body.querySelector('.ldsp-ticket-input')?.value.trim();
                const content = body.querySelector('.ldsp-ticket-textarea')?.value.trim();
                const btn = body.querySelector('.ldsp-ticket-submit');

                if (!title || title.length < 4) { LDSPDialog.warning('æ ‡é¢˜è‡³å°‘éœ€è¦4ä¸ªå­—ç¬¦'); return; }
                if (title.length > 50) { LDSPDialog.warning('æ ‡é¢˜æœ€å¤š50ä¸ªå­—ç¬¦'); return; }
                if (!content || content.length < 8) { LDSPDialog.warning('æè¿°è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦'); return; }
                if (content.length > 500) { LDSPDialog.warning('æè¿°æœ€å¤š500ä¸ªå­—ç¬¦'); return; }

                btn.disabled = true;
                btn.textContent = 'æäº¤ä¸­...';

                try {
                    const result = await this.oauth.api('/api/tickets', {
                        method: 'POST',
                        body: JSON.stringify({ type: type || 'feature_request', title, content })
                    });
                    const data = result.data?.data || result.data;
                    if (result.success || data?.success) {
                        await this._loadTickets();
                        this.overlay.querySelectorAll('.ldsp-ticket-tab').forEach(t => t.classList.remove('active'));
                        this.overlay.querySelector('.ldsp-ticket-tab[data-tab="list"]')?.classList.add('active');
                        this._renderList();
                    } else {
                        // æ£€æµ‹ç™»å½•å¤±æ•ˆæƒ…å†µ
                        const errCode = result.error?.code;
                        if (errCode === 'NOT_LOGGED_IN' || errCode === 'AUTH_EXPIRED' || errCode === 'INVALID_TOKEN') {
                            LDSPDialog.error('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•');
                        } else {
                            LDSPDialog.error(result.error?.message || result.error || data?.error || 'æäº¤å¤±è´¥');
                        }
                    }
                } catch (e) {
                    LDSPDialog.error('æäº¤å¤±è´¥: ' + (e.message || 'ç½‘ç»œé”™è¯¯'));
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'æäº¤å·¥å•';
                }
            }

            async _showDetail(ticketId) {
                this.currentView = 'detail';
                const body = this.overlay.querySelector('.ldsp-ticket-body');
                body.classList.add('detail-mode');
                body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;flex:1"><div class="ldsp-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div></div>';

                try {
                    const result = await this.oauth.api(`/api/tickets/${ticketId}`);
                    if (!result.success) {
                        const errCode = result.error?.code;
                        if (errCode === 'NOT_LOGGED_IN' || errCode === 'AUTH_EXPIRED' || errCode === 'INVALID_TOKEN') {
                            throw new Error('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                        }
                        throw new Error(result.error?.message || result.error || 'åŠ è½½å¤±è´¥');
                    }
                    
                    const data = result.data?.data || result.data;
                    const ticket = data?.ticket || data;
                    const replies = ticket?.replies || [];
                    this.currentTicket = ticket;

                    body.innerHTML = `
                        <div class="ldsp-ticket-detail">
                            <div class="ldsp-ticket-detail-top">
                                <div class="ldsp-ticket-back">â† è¿”å›</div>
                                <div class="ldsp-ticket-detail-header">
                                    <div class="ldsp-ticket-detail-title">${Utils.sanitize(ticket.title, 100)}</div>
                                    <div class="ldsp-ticket-detail-meta">
                                        <span>${this._getTypeIcon(ticket.type)} ${this._getTypeLabel(ticket.type)}</span>
                                        <span>#${ticket.id}</span>
                                        <span class="ldsp-ticket-item-status ${ticket.status}">${ticket.status === 'open' ? 'å¤„ç†ä¸­' : 'å·²å…³é—­'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ldsp-ticket-messages">
                                <div class="ldsp-ticket-reply user">
                                    <div class="ldsp-ticket-reply-header">
                                        <span class="ldsp-ticket-reply-author">ğŸ‘¤ æˆ‘</span>
                                        <span>${this._formatTime(ticket.created_at)}</span>
                                    </div>
                                    <div class="ldsp-ticket-reply-content">${Utils.sanitize(ticket.content, 2000)}</div>
                                </div>
                                ${replies.map(r => `
                                    <div class="ldsp-ticket-reply ${r.is_admin ? 'admin' : 'user'}">
                                        <div class="ldsp-ticket-reply-header">
                                            <span class="ldsp-ticket-reply-author">${r.is_admin ? 'ğŸ‘¨â€ğŸ’¼ ' + (r.admin_name || 'ç®¡ç†å‘˜') : 'ğŸ‘¤ æˆ‘'}</span>
                                            <span>${this._formatTime(r.created_at)}</span>
                                        </div>
                                        <div class="ldsp-ticket-reply-content">${Utils.sanitize(r.content, 2000)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="ldsp-ticket-input-area">
                                ${ticket.status === 'open' ? `
                                    <div class="ldsp-ticket-reply-form">
                                        <textarea class="ldsp-ticket-reply-input" placeholder="è¾“å…¥å›å¤..." maxlength="500"></textarea>
                                        <button class="ldsp-ticket-reply-btn">å‘é€</button>
                                    </div>
                                ` : '<div class="ldsp-ticket-closed-hint">æ­¤å·¥å•å·²å…³é—­</div>'}
                            </div>
                        </div>`;

                    body.querySelector('.ldsp-ticket-back').addEventListener('click', () => {
                        this._loadTickets().then(() => this._renderList());
                    });

                    const replyBtn = body.querySelector('.ldsp-ticket-reply-btn');
                    if (replyBtn) {
                        replyBtn.addEventListener('click', () => this._sendReply(ticketId));
                    }
                    
                    requestAnimationFrame(() => {
                        const messagesEl = body.querySelector('.ldsp-ticket-messages');
                        if (messagesEl) messagesEl.scrollTop = messagesEl.scrollHeight;
                    });

                    if (ticket.has_new_reply) {
                        // è·å–å·¥å•è¯¦æƒ…æ—¶å·²è‡ªåŠ¨æ ‡è®°å·²è¯»ï¼Œåªéœ€æ›´æ–°æœ¬åœ°çŠ¶æ€
                        this._checkUnread();
                        const t = this.tickets.find(x => x.id == ticketId);
                        if (t) t.has_new_reply = false;
                        this._updateTabBadge();
                    }
                } catch (e) {
                    body.innerHTML = '<div class="ldsp-ticket-empty"><div class="ldsp-ticket-empty-icon">âŒ</div><div>åŠ è½½å¤±è´¥</div></div>';
                }
            }

            async _sendReply(ticketId) {
                const body = this.overlay.querySelector('.ldsp-ticket-body');
                const input = body.querySelector('.ldsp-ticket-reply-input');
                const btn = body.querySelector('.ldsp-ticket-reply-btn');
                const text = input?.value.trim();

                if (!text) return;

                btn.disabled = true;
                try {
                    const result = await this.oauth.api(`/api/tickets/${ticketId}/reply`, {
                        method: 'POST',
                        body: JSON.stringify({ content: text })
                    });
                    if (result.success) {
                        this._showDetail(ticketId);
                    } else {
                        // æ£€æµ‹ç™»å½•å¤±æ•ˆæƒ…å†µ
                        const errCode = result.error?.code;
                        if (errCode === 'NOT_LOGGED_IN' || errCode === 'AUTH_EXPIRED' || errCode === 'INVALID_TOKEN') {
                            LDSPDialog.error('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•');
                        } else {
                            LDSPDialog.error(result.error?.message || result.error || 'å‘é€å¤±è´¥');
                        }
                    }
                } catch (e) {
                    LDSPDialog.error('ç½‘ç»œé”™è¯¯');
                } finally {
                    btn.disabled = false;
                }
            }

            _getTypeIcon(type) {
                const t = this.ticketTypes.find(x => x.id === type);
                return t?.icon || 'ğŸ’¡';
            }

            _getTypeLabel(type) {
                const t = this.ticketTypes.find(x => x.id === type);
                return t?.label || type;
            }

            _formatTime(ts) {
                if (!ts) return '';
                const d = new Date(ts);
                const now = new Date();
                const diff = (now - d) / 1000;
                if (diff < 60) return 'åˆšåˆš';
                if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
                if (diff < 2592000) return `${Math.floor(diff / 86400)}å¤©å‰`;
                return `${d.getMonth() + 1}/${d.getDate()}`;
            }

            // é”€æ¯æ–¹æ³• - æ¸…ç†å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬
            destroy() {
                this._stopUnreadPoll();
                // ç§»é™¤é¡µé¢å¯è§æ€§ç›‘å¬
                if (this._visibilityHandler) {
                    document.removeEventListener('visibilitychange', this._visibilityHandler);
                    this._visibilityHandler = null;
                }
                if (this.overlay) {
                    this.overlay.remove();
                    this.overlay = null;
                }
            }
        }

        // ==================== è¯é¢˜å¯¼å‡ºå™¨ ====================
        class TopicExporter {
            constructor(panelBody, renderer) {
                this.panelBody = panelBody;
                this.renderer = renderer;
                this.overlay = null;
                this._cache = null;
                this._lastUrl = location.href;
                this._urlTimer = null;
                this._embedImg = true;
                this._format = 'html';
                this._abort = null;
            }

            init() { this._createOverlay(); }

            _createOverlay() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'ldsp-export-overlay';
                this.overlay.innerHTML = `
                    <div class="ldsp-export-header">
                        <div class="ldsp-export-title">ğŸ“¥ å¯¼å‡ºå¸–å­</div>
                        <div class="ldsp-export-header-actions">
                            <div class="ldsp-export-refresh" title="åˆ·æ–°ä¿¡æ¯"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>åˆ·æ–°</div>
                            <div class="ldsp-export-close">Ã—</div>
                        </div>
                    </div>
                    <div class="ldsp-export-body"></div>`;
                this.panelBody?.appendChild(this.overlay);
                this._bindEvents();
            }

            _bindEvents() {
                this.overlay.querySelector('.ldsp-export-close').addEventListener('click', () => this.hide());
                this.overlay.querySelector('.ldsp-export-refresh').addEventListener('click', () => this._refresh());
                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('show')) this.hide();
                });
            }

            async _refresh() {
                const btn = this.overlay.querySelector('.ldsp-export-refresh');
                if (btn.classList.contains('spinning')) return;
                btn.classList.add('spinning');
                this._cache = null;
                await this._renderHome(true);
                setTimeout(() => btn.classList.remove('spinning'), 500);
            }

            _startUrlWatch() {
                if (this._urlTimer) return;
                this._urlTimer = setInterval(() => {
                    if (location.href !== this._lastUrl) {
                        this._lastUrl = location.href;
                        this._cache = null;
                        if (this.overlay.classList.contains('show') && this._getTopicId()) {
                            this._renderHome();
                            this._stopUrlWatch();
                        }
                    }
                }, 800);
            }

            _stopUrlWatch() { if (this._urlTimer) { clearInterval(this._urlTimer); this._urlTimer = null; } }

            show() {
                this._lastUrl = location.href;
                const tid = this._getTopicId();
                if (this._cache && this._cache.id !== tid) this._cache = null;
                this.overlay.classList.add('show');
                this._renderHome();
            }

            hide() { this._stopUrlWatch(); this.overlay.classList.remove('show'); }

            _getTopicId() {
                return location.href.match(/\/t(?:opic)?\/[^\/]+\/(\d+)/)?.[1] || location.href.match(/\/t(?:opic)?\/(\d+)/)?.[1];
            }

            async _getTopicInfo(refresh = false) {
                const tid = this._getTopicId();
                if (!tid) return null;
                if (!refresh && this._cache?.id === tid) return this._cache;
                
                try {
                    const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
                    const res = await fetch(`${location.origin}/t/${tid}.json`, {
                        headers: { 'x-csrf-token': csrf, 'x-requested-with': 'XMLHttpRequest' }
                    });
                    if (!res.ok) throw new Error();
                    const d = await res.json();
                    
                    const catEl = document.querySelector('.badge-category__name, .category-name');
                    const catStyle = document.querySelector('.badge-category')?.getAttribute('style') || '';
                    const tags = d.tags?.length ? d.tags : Array.from(document.querySelectorAll('.discourse-tags .discourse-tag, .topic-header-extra .discourse-tag')).map(e => e.textContent.trim()).filter(Boolean);
                    
                    this._cache = {
                        id: tid, title: d.title || 'æœªçŸ¥æ ‡é¢˜',
                        category: catEl?.textContent?.trim() || '',
                        categoryColor: catStyle.match(/background-color:\s*#([0-9a-fA-F]+)/)?.[1] || '',
                        tags, postsCount: d.posts_count || 1, views: d.views || 0
                    };
                    return this._cache;
                } catch {
                    const catEl = document.querySelector('.badge-category__name, .category-name');
                    return {
                        id: tid, title: document.querySelector('.fancy-title, .topic-title')?.textContent?.trim() || 'å½“å‰è¯é¢˜',
                        category: catEl?.textContent?.trim() || '', categoryColor: '',
                        tags: Array.from(document.querySelectorAll('.discourse-tags .discourse-tag')).map(e => e.textContent.trim()).filter(Boolean),
                        postsCount: 1, views: 0
                    };
                }
            }

            async _fetchPosts(tid, start, end, progress, signal) {
                const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
                const opts = { headers: { 'x-csrf-token': csrf, 'x-requested-with': 'XMLHttpRequest' }, signal };

                progress?.('æ­£åœ¨è·å–å¸–å­åˆ—è¡¨...');
                const idRes = await fetch(`${location.origin}/t/${tid}/post_ids.json?post_number=0&limit=99999`, opts);
                if (!idRes.ok) throw new Error(`è·å–å¸–å­åˆ—è¡¨å¤±è´¥ (${idRes.status})`);
                let pIds = (await idRes.json()).post_ids.slice(Math.max(0, start - 1), end);

                if (start <= 1 && pIds.length) {
                    const mainRes = await fetch(`${location.origin}/t/${tid}.json`, opts);
                    if (mainRes.ok) {
                        const firstId = (await mainRes.json()).post_stream?.posts?.[0]?.id;
                        if (firstId && !pIds.includes(firstId)) pIds.unshift(firstId);
                    }
                }
                if (!pIds.length) throw new Error('æ²¡æœ‰æ‰¾åˆ°å¸–å­å†…å®¹');

                const posts = [], total = Math.ceil(pIds.length / 200);
                for (let i = 0; i < pIds.length; i += 200) {
                    if (signal?.aborted) throw new Error('å¯¼å‡ºå·²å–æ¶ˆ');
                    progress?.(`æ­£åœ¨è·å–å¸–å­å†…å®¹ (${Math.floor(i/200)+1}/${total})...`);
                    const q = pIds.slice(i, i + 200).map(id => `post_ids[]=${id}`).join('&');
                    const res = await fetch(`${location.origin}/t/${tid}/posts.json?${q}&include_suggested=false`, opts);
                    if (!res.ok) throw new Error(`è·å–å¸–å­è¯¦æƒ…å¤±è´¥ (${res.status})`);
                    
                    for (const p of (await res.json()).post_stream.posts) {
                        if (signal?.aborted) throw new Error('å¯¼å‡ºå·²å–æ¶ˆ');
                        let content = p.cooked || '', avatarUrl = p.avatar_template?.replace('{size}', '90') || '';
                        if (this._embedImg) {
                            content = await this._processImages(content);
                            if (avatarUrl) avatarUrl = await this._imgToBase64(avatarUrl.startsWith('http') ? avatarUrl : `${location.origin}${avatarUrl}`);
                        }
                        posts.push({
                            postNumber: p.post_number,
                            author: { username: p.username, name: p.name || p.username, avatarUrl },
                            timestamp: p.created_at, content,
                            replyTo: p.reply_to_post_number ? { postNumber: p.reply_to_post_number, username: p.reply_to_user?.username || '' } : null,
                            likeCount: p.actions_summary?.find(a => a.id === 2)?.count || 0
                        });
                    }
                }
                return posts;
            }

            async _imgToBase64(url) {
                try {
                    const blob = await (await fetch(url)).blob();
                    return new Promise((r, e) => { const rd = new FileReader(); rd.onloadend = () => r(rd.result); rd.onerror = e; rd.readAsDataURL(blob); });
                } catch { return url; }
            }

            async _processImages(html) {
                const div = document.createElement('div');
                div.innerHTML = html;
                for (const img of div.querySelectorAll('img')) {
                    const src = img.getAttribute('src');
                    if (src && !src.startsWith('data:')) {
                        try { img.setAttribute('src', await this._imgToBase64(src.startsWith('http') ? src : `${location.origin}${src}`)); } catch {}
                    }
                }
                return div.innerHTML;
            }

            async _renderHome(refresh = false) {
                const body = this.overlay.querySelector('.ldsp-export-body');
                const tid = this._getTopicId();

                if (!tid) {
                    this._startUrlWatch();
                    body.innerHTML = `<div class="ldsp-export-not-topic"><div class="ldsp-export-not-topic-icon">ğŸ“„</div><div class="ldsp-export-not-topic-text">è¯·å…ˆè¿›å…¥ä¸€ä¸ªè¯é¢˜å¸–å­<br>æ‰èƒ½ä½¿ç”¨å¯¼å‡ºåŠŸèƒ½å“¦~</div></div>`;
                    return;
                }

                this._stopUrlWatch();
                body.innerHTML = `<div class="ldsp-export-status"><div class="ldsp-export-status-icon">â³</div>æ­£åœ¨è·å–è¯é¢˜ä¿¡æ¯...</div>`;

                const info = await this._getTopicInfo(refresh);
                if (!info) { body.innerHTML = `<div class="ldsp-export-status"><div class="ldsp-export-status-icon">âŒ</div>è·å–è¯é¢˜ä¿¡æ¯å¤±è´¥</div>`; return; }

                const total = info.postsCount || 1;
                const hint = total > 100 ? `å…±${total}æ¥¼ï¼Œå†…å®¹è¾ƒå¤šå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´` : `å…±${total}æ¥¼`;
                const catHtml = info.category ? `<span class="ldsp-export-info-category" ${info.categoryColor ? `style="background:#${info.categoryColor}"` : ''}>ğŸ“ ${Utils.escapeHtml(info.category)}</span>` : '';
                const tagsHtml = (info.category || info.tags?.length) ? `<div class="ldsp-export-info-tags">${catHtml}${(info.tags||[]).map(t => `<span class="ldsp-export-info-tag">ğŸ·ï¸ ${Utils.escapeHtml(t)}</span>`).join('')}</div>` : '';

                body.innerHTML = `
                    <div class="ldsp-export-info">
                        <div class="ldsp-export-info-title">ğŸ“‹ ${Utils.escapeHtml(info.title)}</div>
                        ${tagsHtml}
                        <div class="ldsp-export-info-row"><span class="ldsp-export-info-label">è¯é¢˜ID</span><span class="ldsp-export-info-value">${info.id}</span></div>
                        <div class="ldsp-export-info-row"><span class="ldsp-export-info-label">æ€»æ¥¼å±‚</span><span class="ldsp-export-info-value">${total} æ¥¼</span></div>
                        ${info.views ? `<div class="ldsp-export-info-row"><span class="ldsp-export-info-label">æµè§ˆé‡</span><span class="ldsp-export-info-value">${info.views.toLocaleString()}</span></div>` : ''}
                    </div>
                    <div class="ldsp-export-range">
                        <span class="ldsp-export-range-label">æ¥¼å±‚èŒƒå›´</span>
                        <input type="number" class="ldsp-export-range-input" id="export-start" value="1" min="1" max="${total}">
                        <span class="ldsp-export-range-sep">~</span>
                        <input type="number" class="ldsp-export-range-input" id="export-end" value="${total}" min="1" max="${total}">
                        <span class="ldsp-export-range-hint">${hint}</span>
                    </div>
                    <div class="ldsp-export-format-selector">
                        <div class="ldsp-export-format-title">å¯¼å‡ºæ ¼å¼</div>
                        <div class="ldsp-export-format-cards">
                            <label class="ldsp-export-format-card ${this._format === 'html' ? 'active' : ''}" data-format="html"><input type="radio" name="export-format" value="html" ${this._format === 'html' ? 'checked' : ''}><div class="ldsp-export-format-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div><div class="ldsp-export-format-card-name">HTML</div></label>
                            <label class="ldsp-export-format-card ${this._format === 'pdf' ? 'active' : ''}" data-format="pdf"><input type="radio" name="export-format" value="pdf" ${this._format === 'pdf' ? 'checked' : ''}><div class="ldsp-export-format-card-icon"><svg viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="#ef4444" stroke="#dc2626" stroke-width="1"/><polyline points="14 2 14 8 20 8" fill="#fca5a5" stroke="#dc2626" stroke-width="1"/><text x="12" y="16" font-size="6" font-weight="bold" fill="#fff" text-anchor="middle" font-family="Arial">PDF</text></svg></div><div class="ldsp-export-format-card-name">PDF</div></label>
                        </div>
                    </div>
                    <div class="ldsp-export-options">
                        <div class="ldsp-export-options-title">å¯¼å‡ºé€‰é¡¹</div>
                        <div class="ldsp-export-option"><input type="checkbox" id="export-embed-images" ${this._embedImg ? 'checked' : ''}><label for="export-embed-images">åµŒå…¥å›¾ç‰‡ï¼ˆæ–‡ä»¶æ›´å¤§ä½†å¯ç¦»çº¿æŸ¥çœ‹ï¼‰</label></div>
                    </div>
                    <div class="ldsp-export-actions"><button class="ldsp-export-btn-start" id="export-start-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>å¼€å§‹å¯¼å‡º</span></button></div>
                    <div class="ldsp-export-status" id="export-status" style="display:none;"></div>`;

                body.querySelectorAll('.ldsp-export-format-card').forEach(c => c.addEventListener('click', () => {
                    body.querySelectorAll('.ldsp-export-format-card').forEach(x => x.classList.remove('active'));
                    c.classList.add('active'); this._format = c.dataset.format;
                }));
                body.querySelector('#export-embed-images').addEventListener('change', e => { this._embedImg = e.target.checked; });
                body.querySelector('#export-start-btn').addEventListener('click', () => this._doExport(info));
            }

            async _doExport(info) {
                const body = this.overlay.querySelector('.ldsp-export-body');
                const actions = body.querySelector('.ldsp-export-actions');
                const status = body.querySelector('#export-status');
                const start = parseInt(body.querySelector('#export-start').value) || 1;
                const end = parseInt(body.querySelector('#export-end').value) || info.postsCount;

                if (start > end) { this.renderer?.showToast('âŒ èµ·å§‹æ¥¼å±‚ä¸èƒ½å¤§äºç»“æŸæ¥¼å±‚'); return; }

                this._abort = new AbortController();
                actions.innerHTML = `<button class="ldsp-export-btn-stop" id="export-stop-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"/></svg><span>åœæ­¢å¯¼å‡º</span></button>`;
                body.querySelector('#export-stop-btn').addEventListener('click', () => this._abort?.abort());
                status.style.display = 'block';

                const setStatus = msg => { status.innerHTML = `<div class="ldsp-export-status-icon">â³</div>${msg}`; };

                try {
                    setStatus('æ­£åœ¨è·å–å¸–å­å†…å®¹...');
                    const posts = await this._fetchPosts(info.id, start, end, setStatus, this._abort.signal);
                    if (this._abort.signal.aborted) throw new Error('å¯¼å‡ºå·²å–æ¶ˆ');
                    if (!posts.length) throw new Error('æ²¡æœ‰è·å–åˆ°å¸–å­å†…å®¹');

                    setStatus('æ­£åœ¨ç”Ÿæˆæ–‡ä»¶...');
                    const data = { topic: info, posts, exportDate: new Date().toISOString(), postCount: posts.length, range: { start, end } };
                    const html = this._genHTML(data);

                    if (this._format === 'html') this._download(html, this._genFilename(info, 'html'), 'text/html');
                    else this._printPDF(html);

                    status.innerHTML = `<div class="ldsp-export-status-icon">âœ…</div>å¯¼å‡ºæˆåŠŸï¼`;
                    this.renderer?.showToast('âœ… å¯¼å‡ºæˆåŠŸï¼');
                } catch (e) {
                    const msg = e.name === 'AbortError' || e.message === 'å¯¼å‡ºå·²å–æ¶ˆ' ? 'å¯¼å‡ºå·²å–æ¶ˆ' : e.message;
                    status.innerHTML = `<div class="ldsp-export-status-icon">${msg === 'å¯¼å‡ºå·²å–æ¶ˆ' ? 'â¹ï¸' : 'âŒ'}</div>${Utils.escapeHtml(msg)}`;
                    if (msg !== 'å¯¼å‡ºå·²å–æ¶ˆ') this.renderer?.showToast(`âŒ ${msg}`);
                } finally {
                    this._abort = null;
                    actions.innerHTML = `<button class="ldsp-export-btn-start" id="export-start-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>å¼€å§‹å¯¼å‡º</span></button>`;
                    body.querySelector('#export-start-btn').addEventListener('click', () => this._doExport(info));
                }
            }

            _genFilename(info, ext) {
                const n = new Date(), d = `${n.getFullYear()}${String(n.getMonth()+1).padStart(2,'0')}${String(n.getDate()).padStart(2,'0')}`;
                const t = `${String(n.getHours()).padStart(2,'0')}${String(n.getMinutes()).padStart(2,'0')}`;
                return `LDStatusPro_${info.id}_${info.title.replace(/[<>:"/\\|?*]/g,'').substring(0,50)}_${d}_${t}.${ext}`;
            }

            _genHTML(data) {
                const { topic, posts, exportDate, postCount, range } = data;
                const n = new Date(exportDate);
                const ts = `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')} ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
                const postsHtml = posts.map(p => `<div class="post" id="post-${p.postNumber}"><div class="post-header">${p.author.avatarUrl ? `<img src="${p.author.avatarUrl}" alt="${Utils.escapeHtml(p.author.username)}" class="avatar">` : '<div class="avatar-placeholder"></div>'}<div class="author-info"><span class="author-name">${Utils.escapeHtml(p.author.name)}</span><span class="author-username">@${Utils.escapeHtml(p.author.username)}</span><span class="post-time">${new Date(p.timestamp).toLocaleString('zh-CN')}</span></div><span class="post-number">#${p.postNumber}</span></div>${p.replyTo ? `<div class="reply-to">å›å¤ #${p.replyTo.postNumber} @${Utils.escapeHtml(p.replyTo.username)}</div>` : ''}<div class="post-content">${p.content}</div>${p.likeCount > 0 ? `<div class="post-footer"><span class="like-count">â¤ï¸ ${p.likeCount}</span></div>` : ''}</div>`).join('');
                const css = `*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;line-height:1.6;color:#1a1a1a;background:#f5f5f5;padding:20px}.container{max-width:900px;margin:0 auto}.header{background:linear-gradient(135deg,#6b8cef 0%,#5a7de0 100%);color:#fff;padding:24px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 20px rgba(107,140,239,0.3)}.header h1{font-size:20px;font-weight:700;margin-bottom:12px;line-height:1.4}.meta{display:flex;flex-wrap:wrap;gap:16px;font-size:13px;opacity:0.9}.meta-item{display:flex;align-items:center;gap:4px}.badge{background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500}.post{background:#fff;border-radius:10px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}.post-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #f0f0f0}.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;flex-shrink:0}.avatar-placeholder{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#e0e0e0,#c0c0c0);flex-shrink:0}.author-info{flex:1;min-width:0}.author-name{font-weight:600;color:#1a1a1a;margin-right:6px}.author-username{color:#666;font-size:13px}.post-time{color:#999;font-size:12px;margin-left:8px}.post-number{background:#f0f0f0;padding:4px 10px;border-radius:6px;font-size:12px;color:#666;font-weight:500}.reply-to{background:#f8f9fa;border-left:3px solid #6b8cef;padding:8px 12px;margin-bottom:12px;border-radius:0 6px 6px 0;font-size:13px;color:#666}.post-content{font-size:15px;line-height:1.8;word-wrap:break-word}.post-content img{max-width:100%;height:auto;border-radius:8px;margin:8px 0}.post-content blockquote,.post-content aside.quote{background:#f8f9fa;border-left:3px solid #6b8cef;padding:12px 16px;margin:12px 0;border-radius:0 6px 6px 0;color:#555}.post-content pre{background:#1e1e1e;color:#d4d4d4;padding:16px;border-radius:8px;overflow-x:auto;font-size:13px;line-height:1.5}.post-content code{background:#f4f4f4;padding:2px 6px;border-radius:4px;font-size:13px}.post-content pre code{background:none;padding:0}.post-content a{color:#6b8cef;text-decoration:none}.post-content a:hover{text-decoration:underline}.post-footer{margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;font-size:13px;color:#666}.like-count{color:#e74c3c}.topic-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}.topic-category{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;background:rgba(255,255,255,0.25);border-radius:12px;font-size:12px;font-weight:600}.topic-tag{display:inline-flex;align-items:center;padding:4px 10px;background:rgba(255,255,255,0.15);border-radius:12px;font-size:11px;font-weight:500}.footer{text-align:center;padding:20px;color:#999;font-size:12px}.footer a{color:#6b8cef;text-decoration:none}@media print{body{background:#fff;padding:0}.header{box-shadow:none;page-break-after:avoid}.post{box-shadow:none;border:1px solid #e0e0e0;page-break-inside:avoid}}@media(max-width:600px){body{padding:10px}.header{padding:16px}.header h1{font-size:16px}.meta{gap:8px;font-size:12px}.topic-tags{gap:6px;margin-top:10px}.post{padding:12px}.post-header{gap:8px}.avatar,.avatar-placeholder{width:32px;height:32px}.post-content{font-size:14px}}`;
                const tagsHtml = (topic.category || topic.tags?.length) ? `<div class="topic-tags">${topic.category ? `<span class="topic-category" ${topic.categoryColor ? `style="background:#${topic.categoryColor}"` : ''}>ğŸ“ ${Utils.escapeHtml(topic.category)}</span>` : ''}${(topic.tags||[]).map(t => `<span class="topic-tag">ğŸ·ï¸ ${Utils.escapeHtml(t)}</span>`).join('')}</div>` : '';
                return `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>LDStatusPro å¯¼å‡º - ${Utils.escapeHtml(topic.title)} - è¯é¢˜#${topic.id} - ${ts}</title><style>${css}</style></head><body><div class="container"><div class="header"><h1>${Utils.escapeHtml(topic.title)}</h1><div class="meta"><span class="meta-item"><a href="https://github.com/caigg188/LDStatusPro" target="_blank" class="badge" style="color:#fff;text-decoration:none;">LDStatusPro</a></span><span class="meta-item">ğŸ“‹ è¯é¢˜ #${topic.id}</span><span class="meta-item">ğŸ“ ${postCount} æ¥¼ (${range.start}-${range.end})</span>${topic.views ? `<span class="meta-item">ğŸ‘ï¸ ${topic.views.toLocaleString()} æµè§ˆ</span>` : ''}<span class="meta-item">ğŸ“… ${ts}</span></div>${tagsHtml}</div>${postsHtml}<div class="footer">ç”± <a href="https://github.com/caigg188/LDStatusPro" target="_blank">LDStatusPro</a> å¯¼å‡º | æ¥æº: <a href="${location.origin}/t/${topic.id}" target="_blank">${location.origin}/t/${topic.id}</a></div></div></body></html>`;
            }

            _download(content, filename, type) {
                const url = URL.createObjectURL(new Blob([content], { type }));
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            _printPDF(html) {
                const w = window.open('', '_blank');
                if (!w) throw new Error('æ— æ³•æ‰“å¼€æ‰“å°çª—å£ï¼Œè¯·æ£€æŸ¥å¼¹çª—æ‹¦æˆªè®¾ç½®');
                w.document.write(html); w.document.close();
                w.onload = () => setTimeout(() => w.print(), 500);
            }

            destroy() { this._stopUrlWatch(); this.overlay?.remove(); this.overlay = null; }
        }

        // ==================== å…¨å±€å¼¹å‡ºæ¡†ç®¡ç†å™¨ ====================
        const LDSPDialog = {
            _container: null,
            _panel: null,
            // åˆå§‹åŒ–ï¼šè®¾ç½®é¢æ¿æ ¹å…ƒç´ 
            init(panel) {
                this._panel = panel;
            },
            _getContainer() {
                const panel = this._getPanel();
                if (!panel) return null;
                // ç¡®ä¿å®¹å™¨å­˜åœ¨ä¸”åœ¨é¢æ¿ä¸­
                if (!this._container || !this._container.parentElement) {
                    if (this._container) this._container.remove();
                    this._container = document.createElement('div');
                    this._container.className = 'ldsp-toast-container';
                    panel.appendChild(this._container);
                }
                // æ¯æ¬¡éƒ½æ›´æ–°ä½ç½®ï¼Œä½¿ç”¨ fixed å®šä½
                const rect = panel.getBoundingClientRect();
                Object.assign(this._container.style, {
                    position: 'fixed',
                    top: (rect.top + 50) + 'px',
                    left: rect.left + 'px',
                    width: rect.width + 'px',
                    zIndex: '100000',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '8px',
                    pointerEvents: 'none',
                    padding: '0 12px',
                    boxSizing: 'border-box',
                    transition: 'none',
                    animation: 'none'
                });
                return this._container;
            },
            _getPanel() {
                // åªè¿”å›æœ‰æ•ˆçš„é¢æ¿å…ƒç´ ï¼Œä¸å›é€€åˆ° body
                if (this._panel && this._panel.parentElement) return this._panel;
                const panel = document.getElementById('ldsp-panel');
                if (panel) {
                    this._panel = panel;
                    return panel;
                }
                return null; // é¢æ¿ä¸å­˜åœ¨è¿”å› null
            },
            // Toast é€šçŸ¥
            toast(message, type = 'info', duration = 3000) {
                const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
                const titles = { success: 'æˆåŠŸ', error: 'é”™è¯¯', warning: 'è­¦å‘Š', info: 'æç¤º' };
                const colors = { success: 'var(--ok)', error: 'var(--err)', warning: 'var(--warn)', info: 'var(--accent)' };
                const toast = document.createElement('div');
                toast.className = `ldsp-toast ${type}`;
                // å†…è”æ ·å¼ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®ï¼Œå¼ºåˆ¶ç¦ç”¨ transition/animation
                Object.assign(toast.style, {
                    display: 'flex',
                    alignItems: 'flex-start',
                    gap: '10px',
                    padding: '10px 14px',
                    background: 'var(--bg-card)',
                    border: '1px solid var(--border)',
                    borderLeft: `3px solid ${colors[type] || colors.info}`,
                    borderRadius: 'var(--r-md)',
                    boxShadow: '0 4px 16px rgba(0,0,0,.2)',
                    pointerEvents: 'auto',
                    wordBreak: 'break-word',
                    maxWidth: '280px',
                    boxSizing: 'border-box',
                    opacity: '1',
                    transition: 'none',
                    animation: 'none',
                    transform: 'none'
                });
                toast.innerHTML = `
                    <div class="ldsp-toast-icon" style="font-size:16px;flex-shrink:0;line-height:1;color:${colors[type] || colors.info}">${icons[type] || icons.info}</div>
                    <div class="ldsp-toast-content" style="flex:1;min-width:0">
                        <div class="ldsp-toast-title" style="font-size:11px;font-weight:600;color:var(--txt);margin-bottom:2px">${titles[type] || titles.info}</div>
                        <div class="ldsp-toast-message" style="font-size:10px;color:var(--txt-sec);line-height:1.5">${message}</div>
                    </div>
                    <button class="ldsp-toast-close" style="flex-shrink:0;width:18px;height:18px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;color:var(--txt-mut);cursor:pointer;border-radius:4px;font-size:14px;margin:-2px -4px -2px 0">Ã—</button>`;
                const close = () => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-10px) scale(.95)';
                    setTimeout(() => toast.remove(), 250);
                };
                toast.querySelector('.ldsp-toast-close').onclick = close;
                if (duration > 0) setTimeout(close, duration);
                const container = this._getContainer();
                if (container) {
                    container.appendChild(toast);
                }
                return toast;
            },
            // æˆåŠŸæç¤º - ä½¿ç”¨ç³»ç»ŸåŸç”Ÿ alert
            success(message) { alert('âœ… æˆåŠŸ\n\n' + message.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '')); },
            // é”™è¯¯æç¤º - ä½¿ç”¨ç³»ç»ŸåŸç”Ÿ alert
            error(message) { alert('âŒ é”™è¯¯\n\n' + message.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '')); },
            // è­¦å‘Šæç¤º - ä½¿ç”¨ç³»ç»ŸåŸç”Ÿ alert
            warning(message) { alert('âš ï¸ è­¦å‘Š\n\n' + message.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '')); },
            // ä¿¡æ¯æç¤º - ä½¿ç”¨ç³»ç»ŸåŸç”Ÿ alert
            info(message) { alert('â„¹ï¸ æç¤º\n\n' + message.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '')); },
            // ç¡®è®¤å¯¹è¯æ¡† (è¿”å› Promise)
            confirm(message, options = {}) {
                return new Promise((resolve) => {
                    const { title = 'ç¡®è®¤æ“ä½œ', icon = 'âš ï¸', okText = 'ç¡®è®¤', cancelText = 'å–æ¶ˆ', danger = false } = options;
                    const overlay = document.createElement('div');
                    overlay.className = 'ldsp-dialog-overlay';
                    overlay.innerHTML = `
                        <div class="ldsp-dialog">
                            <div class="ldsp-dialog-icon">${icon}</div>
                            <div class="ldsp-dialog-title">${title}</div>
                            <div class="ldsp-dialog-message">${message}</div>
                            <div class="ldsp-dialog-actions">
                                <button class="ldsp-dialog-btn ldsp-dialog-btn-cancel">${cancelText}</button>
                                <button class="ldsp-dialog-btn ${danger ? 'ldsp-dialog-btn-danger' : 'ldsp-dialog-btn-ok'}">${okText}</button>
                            </div>
                        </div>`;
                    let closed = false;
                    const close = (result) => {
                        if (closed) return;
                        closed = true;
                        overlay.style.opacity = '0';
                        setTimeout(() => { overlay.remove(); resolve(result); }, 150);
                    };
                    overlay.querySelector('.ldsp-dialog-btn-cancel').addEventListener('click', (e) => { e.stopPropagation(); close(false); });
                    overlay.querySelector('.ldsp-dialog-btn:last-child').addEventListener('click', (e) => { e.stopPropagation(); close(true); });
                    overlay.querySelector('.ldsp-dialog').addEventListener('click', (e) => e.stopPropagation());
                    overlay.addEventListener('click', () => close(false));
                    this._getPanel().appendChild(overlay);
                });
            },
            // è­¦å‘Šæ¡† (å•æŒ‰é’®)
            alert(message, options = {}) {
                return new Promise((resolve) => {
                    const { title = 'æç¤º', icon = 'â„¹ï¸', okText = 'çŸ¥é“äº†' } = options;
                    const overlay = document.createElement('div');
                    overlay.className = 'ldsp-dialog-overlay';
                    overlay.innerHTML = `
                        <div class="ldsp-dialog">
                            <div class="ldsp-dialog-icon">${icon}</div>
                            <div class="ldsp-dialog-title">${title}</div>
                            <div class="ldsp-dialog-message">${message}</div>
                            <div class="ldsp-dialog-actions">
                                <button class="ldsp-dialog-btn ldsp-dialog-btn-ok">${okText}</button>
                            </div>
                        </div>`;
                    let closed = false;
                    const close = () => {
                        if (closed) return;
                        closed = true;
                        overlay.style.opacity = '0';
                        setTimeout(() => { overlay.remove(); resolve(); }, 150);
                    };
                    overlay.querySelector('.ldsp-dialog-btn-ok').addEventListener('click', (e) => { e.stopPropagation(); close(); });
                    overlay.querySelector('.ldsp-dialog').addEventListener('click', (e) => e.stopPropagation());
                    overlay.addEventListener('click', () => close());
                    this._getPanel().appendChild(overlay);
                });
            }
        };

        // ==================== LDC ç§¯åˆ†ç®¡ç†å™¨ ====================
        class LDCManager {
            static CACHE_KEY = 'ldsp_ldc_cache';
            static CACHE_TTL = 600000; // 10åˆ†é’Ÿ
            static LDC_ORIGIN = 'https://credit.linux.do';
            static TRANS_TYPES = [
                { id: '', label: 'å…¨éƒ¨', icon: 'ğŸ“‹' }, { id: 'receive', label: 'æ”¶ç›Š', icon: 'ğŸ“¥' },
                { id: 'payment', label: 'æ”¯å‡º', icon: 'ğŸ“¤' }, { id: 'transfer', label: 'è½¬ç§»', icon: 'ğŸ”„' },
                { id: 'community', label: 'ç¤¾åŒºåˆ’è½¬', icon: 'ğŸ›ï¸' }, { id: 'online', label: 'åœ¨çº¿æµè½¬', icon: 'ğŸŒ' }
            ];
            static TIME_RANGES = [
                { id: 'today', label: 'ä»Šæ—¥' }, { id: '7days', label: 'è¿‘7å¤©' },
                { id: '30days', label: 'è¿‘30å¤©' }, { id: 'all', label: 'æ‰€æœ‰' }
            ];

            constructor(panelBody) {
                this.panelBody = panelBody;
                this.overlay = null;
                // ç‹¬ç«‹çš„åŠ è½½çŠ¶æ€ä¸è¯·æ±‚ä»¤ç‰Œï¼Œé¿å…è·¨ tab äº’ç›¸é˜»å¡
                this._loadingState = { overview: false, trans: false };
                this._reqToken = { overview: 0, trans: 0 };
                this._tab = 'overview';
                this._trans = { orders: [], page: 1, total: 0, hasMore: false };
                this._order = null;
                this._userId = null;
                this._filter = { timeRange: '7days', type: '' };
                this._isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && /WebKit/.test(navigator.userAgent) && !/CriOS|FxiOS|OPiOS|EdgiOS/.test(navigator.userAgent);
                // iframe æ¡¥æ¥ç›¸å…³
                this._bridge = null;
                this._bridgeReady = null;
                this._requests = new Map();
                this._reqId = 0;
                this._msgHandler = null;
                // v2.0: API é…ç½®
                this._apiUrl = (typeof ApiService !== 'undefined' && ApiService.baseUrl) || 'https://api.ldspro.qzz.io';
                this._tokenKey = `ldsp_${CURRENT_SITE.prefix}_leaderboard_token`;
                this._token = GM_getValue(this._tokenKey, null);
                // å°å–éƒ¨ç›¸å…³
                this._shopView = 'list'; // list, my, form, detail
                
                // ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–
                this._formatError = (resp) => {
                    if (!resp) return 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    // ä¼˜å…ˆä½¿ç”¨ error.message
                    if (resp.error?.message) return resp.error.message;
                    // å…¶æ¬¡ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹çš„ error
                    if (typeof resp.error === 'string') return resp.error;
                    // å°è¯• data.error
                    if (resp.data?.error?.message) return resp.data.error.message;
                    if (typeof resp.data?.error === 'string') return resp.data.error;
                    // å°è¯• message
                    if (resp.message) return resp.message;
                    return 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                };
                this._shopProducts = [];
                this._shopMyProducts = [];
                this._shopCategories = [];
                this._shopCategory = '';
                this._shopProduct = null;
                this._shopEditProduct = null;
                // å°å–éƒ¨ç¼“å­˜
                this._shopProductsCache = new Map(); // categoryId -> { products, timestamp }
                this._shopMyProductsCache = null; // { products, timestamp } æˆ‘çš„å•†å“ç¼“å­˜
                this._shopCategoriesCache = null; // { categories, timestamp }
                this._shopCacheTTL = 60000; // å•†å“åˆ—è¡¨ç¼“å­˜ 1 åˆ†é’Ÿ
                this._shopCategoriesCacheTTL = 300000; // åˆ†ç±»ç¼“å­˜ 5 åˆ†é’Ÿ
                this._shopSubmitting = false; // é˜²é‡å¤æäº¤é”
                this._shopTabClickDebounce = null; // Tab ç‚¹å‡»é˜²æŠ–
                // å•†å“åˆ—è¡¨åˆ†é¡µç›¸å…³
                this._shopPage = 1;
                this._shopPageSize = 20;
                this._shopHasMore = true;
                this._shopLoading = false;
                this._shopScrollObserver = null;
                this._shopTotal = 0; // å½“å‰åˆ†ç±»çš„å•†å“æ€»æ•°
                // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚
                this._userCache = null;
                this._userCacheTime = 0;
                this._userCacheTTL = 60000; // 60s
                this._userPromise = null;
            }

            init() { 
                this._createOverlay();
                this._initBridge();
            }

            _initBridge() {
                // åˆ›å»ºæ¶ˆæ¯ç›‘å¬
                const handler = (e) => {
                    if (e.origin !== LDCManager.LDC_ORIGIN || e.data?.type !== 'ldsp-ldc-response') return;
                    const p = this._requests.get(e.data.requestId);
                    if (p) { this._requests.delete(e.data.requestId); p(e.data); }
                };
                window.addEventListener('message', handler);
                this._msgHandler = handler;
                
                // åˆ›å»ºéšè—çš„ iframe
                const frame = document.createElement('iframe');
                frame.src = LDCManager.LDC_ORIGIN + '/home';
                frame.style.cssText = 'width:0;height:0;opacity:0;position:absolute;border:0;pointer-events:none';
                document.body.appendChild(frame);
                this._bridge = frame;
                
                // ç­‰å¾… iframe åŠ è½½å®Œæˆ
                this._bridgeReady = new Promise(r => {
                    const t = setTimeout(() => r(), 2000);
                    frame.onload = () => { clearTimeout(t); setTimeout(r, 150); };
                });
            }

            _createOverlay() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'ldsp-ldc-overlay';
                this.overlay.innerHTML = `
                    <div class="ldsp-ldc-header">
                        <div class="ldsp-ldc-title">ğŸŸ LDC ç§¯åˆ†</div>
                        <div class="ldsp-ldc-header-actions">
                            <a href="https://credit.linux.do/home" target="_blank" class="ldsp-ldc-link">LINUX DO CREDIT</a>
                            <button class="ldsp-ldc-refresh" title="åˆ·æ–°">
                                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            </button>
                            <div class="ldsp-ldc-close">Ã—</div>
                        </div>
                    </div>
                    <div class="ldsp-ldc-tabs">
                        <div class="ldsp-ldc-tab active" data-tab="overview">ğŸ“Š æ¦‚è§ˆ</div>
                        <div class="ldsp-ldc-tab" data-tab="transactions">ğŸ“œ è®°å½•</div>
                        <div class="ldsp-ldc-tab" data-tab="support">â¤ï¸ æ”¯æŒ</div>
                    </div>
                    <div class="ldsp-ldc-body">
                        <div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>
                    </div>`;
                this.panelBody?.appendChild(this.overlay);
                this._bindEvents();
            }

            _bindEvents() {
                this.overlay.querySelector('.ldsp-ldc-close').addEventListener('click', () => this.hide());
                this.overlay.querySelector('.ldsp-ldc-refresh').addEventListener('click', () => {
                    if (this._tab === 'overview') this._fetchData();
                    else if (this._tab === 'transactions') this._fetchTrans(true);
                });
                this.overlay.querySelectorAll('.ldsp-ldc-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        if (tab.dataset.tab !== this._tab) this._switchTab(tab.dataset.tab);
                    });
                });
                this._escHandler = (e) => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('show')) {
                        this._order ? this._closeDetail() : this.hide();
                    }
                };
                document.addEventListener('keydown', this._escHandler);
            }

            _switchTab(tabId) {
                this._tab = tabId;
                this._order = null;
                this._shopProduct = null;
                this.overlay.querySelectorAll('.ldsp-ldc-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
                if (tabId === 'overview') this._loadCache() || this._fetchData();
                else if (tabId === 'transactions') this._fetchTrans(true);
                else if (tabId === 'support') this._renderSupport();
            }

            show() {
                this.overlay.classList.add('show');
                this._tab = 'overview';
                this._order = null;
                this._shopProduct = null;
                this.overlay.querySelectorAll('.ldsp-ldc-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'overview'));
                this._loadCache() || this._fetchData();
            }
            
            // æ˜¾ç¤ºç‹¬ç«‹çš„å£«å¤šé¢æ¿
            showShop() {
                if (!this.shopOverlay) {
                    this._createShopOverlay();
                }
                this.shopOverlay.classList.add('show');
                this._shopView = 'list';
                this._shopProduct = null;
                // é‡ç½®åˆ†é¡µ
                this._shopPage = 1;
                this._shopHasMore = true;
                this._shopLoading = false;
                this._renderShop();
            }
            
            hideShop() {
                this.shopOverlay?.classList.remove('show');
                this._shopProduct = null;
            }
            
            // åˆ›å»ºç‹¬ç«‹çš„å£«å¤š Overlay
            _createShopOverlay() {
                this.shopOverlay = document.createElement('div');
                this.shopOverlay.className = 'ldsp-ldc-overlay ldsp-shop-overlay';
                this.shopOverlay.innerHTML = `
                    <div class="ldsp-ldc-header">
                        <div class="ldsp-ldc-title">ğŸ” LDå£«å¤š</div>
                        <div class="ldsp-ldc-header-actions">
                            <a href="https://ldst0re.qzz.io/" target="_blank" class="ldsp-ldc-link" title="æ‰“å¼€ç½‘é¡µç‰ˆ">ğŸŒ ç½‘é¡µç‰ˆ</a>
                            <button class="ldsp-ldc-refresh" title="åˆ·æ–°">
                                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            </button>
                            <div class="ldsp-ldc-close">Ã—</div>
                        </div>
                    </div>
                    <div class="ldsp-ldc-body">
                        <div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>
                    </div>`;
                this.panelBody?.appendChild(this.shopOverlay);
                this._bindShopOverlayEvents();
            }
            
            _bindShopOverlayEvents() {
                this.shopOverlay.querySelector('.ldsp-ldc-close').addEventListener('click', () => this.hideShop());
                this.shopOverlay.querySelector('.ldsp-ldc-refresh').addEventListener('click', () => {
                    if (this._shopView === 'list') this._refreshShopList();
                    else if (this._shopView === 'my') this._refreshShopMy();
                    else if (this._shopView === 'orders') this._renderShopOrders();
                });
                // ESC å…³é—­
                this._shopEscHandler = (e) => {
                    if (e.key === 'Escape' && this.shopOverlay?.classList.contains('show')) {
                        if (this._shopProduct) {
                            this._shopProduct = null;
                            this._renderShopList();
                        } else {
                            this.hideShop();
                        }
                    }
                };
                document.addEventListener('keydown', this._shopEscHandler);
            }

            hide() { this.overlay.classList.remove('show'); this._order = null; }

            _loadCache() {
                try {
                    const c = GM_getValue(LDCManager.CACHE_KEY, null);
                    // æ£€æŸ¥ç¼“å­˜æœ‰æ•ˆæ€§ï¼šæ—¶é—´æœªè¿‡æœŸä¸”åŒ…å« estimatedIncrease å­—æ®µï¼ˆv3.5.2.4+ æ–°å¢ï¼‰
                    if (c && Date.now() - c.time < LDCManager.CACHE_TTL && 'estimatedIncrease' in c) {
                        // ä»ç¼“å­˜æ¢å¤ userId
                        if (c.userId) this._userId = c.userId;
                        this._renderOverview(c);
                        return true;
                    }
                } catch {}
                return false;
            }

            _saveCache(data) {
                // ç¼“å­˜ä¸­ä¿å­˜ userId
                try { GM_setValue(LDCManager.CACHE_KEY, { ...data, userId: this._userId, time: Date.now() }); } catch {}
            }

            // å¸¦ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯è·å–ï¼Œå‡å°‘é‡å¤è¯·æ±‚
            async _getUserInfo(force = false) {
                const now = Date.now();
                if (!force && this._userCache && (now - this._userCacheTime) < this._userCacheTTL) {
                    return this._userCache;
                }
                if (this._userPromise) return this._userPromise;
                this._userPromise = (async () => {
                    const user = await this._request('https://credit.linux.do/api/v1/oauth/user-info');
                    this._userCache = user || null;
                    this._userCacheTime = Date.now();
                    this._userPromise = null;
                    return user;
                })();
                return this._userPromise;
            }

            async _fetchData() {
                const token = ++this._reqToken.overview;
                this._loadingState.overview = true;
                const _body = this.overlay.querySelector('.ldsp-ldc-body');
                const btn = this.overlay.querySelector('.ldsp-ldc-refresh');
                _body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                try {
                    const user = await this._getUserInfo(true);
                    if (!user || user._authError) {
                        this._showLoginGuide('auth');
                        return;
                    }
                    if (user._timeoutError) { this._showLoginGuide('timeout'); return; }
                    if (user._networkError) { this._showLoginGuide('network'); return; }
                    if (user._bridgeError) { this._showLoginGuide('timeout'); return; }

                    this._userId = user.id || user.user_id || null;
                    // nickname æ˜¯æ˜¾ç¤ºåï¼Œusername æ‰æ˜¯ linux.do çš„ç”¨æˆ·å
                    const displayName = user.nickname || user.username || 'User';
                    const ldUsername = user.username; // linux.do ç”¨æˆ·å
                    const communityBalance = parseFloat(user.community_balance ?? user['community-balance'] ?? 0);
                    
                    const data = {
                        username: displayName,
                        credits: user.available_balance || '0',
                        dailyLimit: user.remain_quota || '0',
                        incomeTotal: user.total_receive || '0',
                        expenseTotal: user.total_payment || '0',
                        dailyStats: [],
                        estimatedIncrease: null,
                        updateTime: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                    };

                    // å¹¶è¡Œè·å– gamification_score ä¸ 7æ—¥ç»Ÿè®¡ï¼ŒåŠ é€ŸåŠ è½½
                    const statsPromise = this._request('https://credit.linux.do/api/v1/dashboard/stats/daily?days=7');
                    let gamificationScore = null;
                    let gamificationPromise = Promise.resolve(null);
                    if (ldUsername) {
                        if (window.location.hostname === 'linux.do') {
                            gamificationPromise = (async () => {
                                try {
                                    const headers = buildAuthHeaders(`/u/${ldUsername}.json`, { 'Accept': 'application/json' });
                                    const resp = await fetch(`/u/${ldUsername}.json`, { credentials: 'include', headers });
                                    if (resp.ok) {
                                        const ldData = await resp.json();
                                        return ldData?.user?.gamification_score;
                                    }
                                } catch {}
                                return null;
                            })();
                        } else {
                            gamificationPromise = (async () => {
                                const ldUserData = await this._fetchGamificationScore(ldUsername);
                                return ldUserData?.gamification_score;
                            })();
                        }
                    }

                    const [stats, gScore] = await Promise.all([statsPromise, gamificationPromise]);
                    if (gScore !== null && gScore !== undefined) gamificationScore = parseFloat(gScore);
                    
                    // è®¡ç®—ä»Šæ—¥é¢„ä¼°å¢åŠ 
                    if (gamificationScore !== null && !isNaN(communityBalance)) {
                        data.estimatedIncrease = gamificationScore - communityBalance;
                    }

                    // è·å–7å¤©ç»Ÿè®¡
                    if (stats && Array.isArray(stats)) {
                        data.dailyStats = stats.map(i => ({
                            date: i.date, dateShort: i.date.substring(5).replace('-', '/'),
                            income: parseFloat(i.income) || 0, expense: parseFloat(i.expense) || 0
                        }));
                    }
                    // åªæ¸²æŸ“ä»ç„¶å¤„äº overview çš„è¯·æ±‚
                    if (token === this._reqToken.overview && this._tab === 'overview') {
                        this._renderOverview(data);
                        this._saveCache(data);
                    }
                } catch { if (token === this._reqToken.overview) this._showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'); }
                finally {
                    if (token === this._reqToken.overview) this._loadingState.overview = false;
                    btn?.classList.remove('spinning');
                }
            }

            // è·å– linux.do ç”¨æˆ·çš„ gamification_score
            async _fetchGamificationScore(username) {
                if (!username) return null;
                const headers = buildAuthHeaders(`https://linux.do/u/${username}.json`, { 'Accept': 'application/json' });
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'GET',
                        url: `https://linux.do/u/${username}.json`,
                        withCredentials: true,
                        timeout: 10000,
                        headers,
                        onload: r => {
                            if (r.status === 200) {
                                try {
                                    const data = JSON.parse(r.responseText);
                                    resolve(data?.user || null);
                                    return;
                                } catch {}
                            }
                            resolve(null);
                        },
                        onerror: () => resolve(null),
                        ontimeout: () => resolve(null)
                    });
                });
            }

            _showLoginGuide(reason = 'auth') {
                const body = this.overlay.querySelector('.ldsp-ldc-body');
                this.overlay.querySelector('.ldsp-ldc-refresh')?.classList.remove('spinning');
                this._loading = false;
                
                const isTimeout = reason === 'timeout';
                const isNetwork = reason === 'network';
                
                const icon = isTimeout ? 'â±ï¸' : isNetwork ? 'ğŸŒ' : 'ğŸ”';
                const title = isTimeout ? 'è¯·æ±‚è¶…æ—¶' : isNetwork ? 'ç½‘ç»œé”™è¯¯' : 'éœ€è¦ç™»å½•';
                const desc = isTimeout 
                    ? 'è·å–æ•°æ®è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœªç™»å½• LDC ç«™ç‚¹ã€‚è¯·å…ˆè®¿é—® LDC å®˜ç½‘ç¡®è®¤å·²ç™»å½•ï¼Œç„¶åè¿”å›é‡è¯•ã€‚'
                    : isNetwork 
                    ? 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•å…ˆè®¿é—® LDC å®˜ç½‘ç™»å½•ã€‚'
                    : 'è¯·å…ˆç™»å½• LDC å®˜ç½‘ï¼Œç™»å½•åè¿”å›æ­¤é¡µé¢åˆ·æ–°å³å¯è·å–æ•°æ®ã€‚';
                
                body.innerHTML = `
                    <div class="ldsp-ldc-ios-guide">
                        <div class="ldsp-ldc-ios-icon">${icon}</div>
                        <div class="ldsp-ldc-ios-title">${title}</div>
                        <div class="ldsp-ldc-ios-desc">${desc}</div>
                        <div class="ldsp-ldc-ios-solutions">
                            <div class="ldsp-ldc-ios-solution">
                                <div class="ldsp-ldc-ios-solution-title">âœ… è§£å†³æ–¹æ¡ˆ</div>
                                <div class="ldsp-ldc-ios-solution-desc">è®¿é—® LDC å®˜ç½‘å®Œæˆç™»å½•</div>
                                <a href="https://credit.linux.do/home" target="_blank" class="ldsp-ldc-ios-btn primary">æ‰“å¼€ LDC å®˜ç½‘ç™»å½• â†—</a>
                            </div>
                        </div>
                        <button class="ldsp-ldc-retry-btn" style="margin-top:12px">ğŸ”„ é‡è¯•</button>
                        <div class="ldsp-ldc-ios-tip">ğŸ’¡ ç™»å½•åè¿”å›æ­¤é¡µé¢ç‚¹å‡»é‡è¯•å³å¯</div>
                    </div>`;
                body.querySelector('.ldsp-ldc-retry-btn')?.addEventListener('click', () => {
                    if (this._tab === 'overview') this._fetchData();
                    else if (this._tab === 'transactions') this._fetchTrans(true);
                });
            }

            // ä¼˜å…ˆä½¿ç”¨ iframe æ¡¥æ¥æ–¹å¼è¯·æ±‚ï¼ˆå…¼å®¹ iOS Safariï¼‰ï¼›é iOS ç›´æ¥ä½¿ç”¨ GM æ›´å¿«
            async _request(url, method = 'GET', data = null) {
                // æ¡Œé¢/å®‰å“ï¼šç›´æ¥ GMï¼Œé¿å… iframe é¢å¤–ç­‰å¾…
                if (!this._isIOS) {
                    return this._requestViaGM(url, method, data);
                }

                // iOSï¼šå…ˆæ¡¥æ¥ï¼Œè®¾ç½®è¾ƒçŸ­è¶…æ—¶ï¼›å¤±è´¥åå† GM å…œåº•
                const bridgeResult = await this._requestViaBridge(url, method, data, 2000);
                if (bridgeResult && !bridgeResult._bridgeError) return bridgeResult;
                return await this._requestViaGM(url, method, data);
            }

            // iframe æ¡¥æ¥è¯·æ±‚
            async _requestViaBridge(url, method = 'GET', data = null, timeoutMs = 15000) {
                if (this._bridgeReady) await this._bridgeReady;
                if (!this._bridge) return { _bridgeError: true, _error: 'æ¡¥æ¥æœªå°±ç»ª' };
                
                return new Promise((resolve) => {
                    const id = ++this._reqId;
                    const timeout = setTimeout(() => { 
                        this._requests.delete(id); 
                        debugBridgeLog('LDC bridge timeout', { url, method });
                        resolve({ _bridgeError: true, _timeoutError: true, _error: 'è¯·æ±‚è¶…æ—¶' }); 
                    }, timeoutMs);
                    
                    this._requests.set(id, ({ status, data: respData }) => {
                        clearTimeout(timeout);
                        if (status === 200) {
                            // LDC API è¿”å›æ ¼å¼ï¼š{ code: 200, data: {...} }
                            if (respData?.data !== undefined) {
                                resolve(respData.data);
                            } else if (respData?._error || respData?.error_msg) {
                                resolve({ _error: respData._error || respData.error_msg });
                            } else {
                                resolve(respData);
                            }
                        } else if (status === 401 || status === 403) {
                            debugBridgeLog('LDC bridge auth fail', { url, status });
                            resolve({ _authError: true });
                        } else {
                            debugBridgeLog('LDC bridge status', { url, status });
                            resolve({ _bridgeError: true, _error: respData?._error || `è¯·æ±‚å¤±è´¥ (${status})` });
                        }
                    });
                    
                    try {
                        this._bridge.contentWindow.postMessage({ 
                            type: 'ldsp-ldc-request', 
                            requestId: id, 
                            url,
                            method,
                            data 
                        }, LDCManager.LDC_ORIGIN);
                    } catch (e) {
                        clearTimeout(timeout);
                        this._requests.delete(id);
                        debugBridgeLog('LDC bridge postMessage error', e?.message || e);
                        resolve({ _bridgeError: true, _error: 'å‘é€è¯·æ±‚å¤±è´¥' });
                    }
                });
            }

            // GM_xmlhttpRequest æ–¹å¼è¯·æ±‚ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
            _requestViaGM(url, method = 'GET', data = null) {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method, url,
                        withCredentials: true,
                        timeout: 15000,
                        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json', 'Referer': 'https://credit.linux.do/home' },
                        data: data ? JSON.stringify(data) : undefined,
                        onload: r => {
                            if (r.status === 200) {
                    try { const j = JSON.parse(r.responseText); resolve(j?.data ?? null); return; } catch {}
                }
                if (r.status === 401 || r.status === 403) {
                    debugBridgeLog('LDC GM auth fail', { url, status: r.status });
                    resolve({ _authError: true });
                    return;
                }
                debugBridgeLog('LDC GM unexpected status', { url, status: r.status });
                resolve(null);
            },
            onerror: () => { debugBridgeLog('LDC GM network error', url); resolve({ _networkError: true }); },
            ontimeout: () => { debugBridgeLog('LDC GM timeout', url); resolve({ _timeoutError: true }); }
        });
    });
}

            _renderOverview(data) {
                const body = this.overlay.querySelector('.ldsp-ldc-body');
                
                // è®¡ç®—7å¤©ç»Ÿè®¡
                const stats7d = data.dailyStats.reduce((acc, d) => ({
                    income: acc.income + d.income,
                    expense: acc.expense + d.expense
                }), { income: 0, expense: 0 });

                // ç”Ÿæˆé¢„ä¼°å¢åŠ  HTML
                let estimateHtml = '';
                if (data.estimatedIncrease !== null && data.estimatedIncrease !== undefined) {
                    const est = data.estimatedIncrease;
                    const estClass = est > 0 ? 'positive' : est < 0 ? 'negative' : 'neutral';
                    const estText = est > 0 ? `+${est.toFixed(2)}` : est < 0 ? `${est.toFixed(2)}` : '0.00';
                    estimateHtml = `
                        <div class="ldsp-ldc-balance-estimate">
                            <span class="ldsp-ldc-balance-estimate-tip" data-ldsp-tooltip="é¢„ä¼°åˆ†æ•°ä»…ä¾›å‚è€ƒï¼Œæ¯æ—¥å‡Œæ™¨å¤±æ•ˆ">?</span>
                            <span>é¢„ä¼°å˜åŒ–</span>
                            <span class="ldsp-ldc-balance-estimate-value ${estClass}">${estText}</span>
                        </div>`;
                }

                // ç”Ÿæˆè¿·ä½ æŸ±çŠ¶å›¾
                const maxVal = Math.max(...data.dailyStats.flatMap(d => [d.income, d.expense]), 1);
                const chartHtml = data.dailyStats.length > 0 ? `
                    <div class="ldsp-ldc-chart">
                        <div class="ldsp-ldc-chart-bars">
                            ${data.dailyStats.map(d => {
                                const incomeH = Math.round((d.income / maxVal) * 100);
                                const expenseH = Math.round((d.expense / maxVal) * 100);
                                return `<div class="ldsp-ldc-chart-col" title="${d.dateShort}\næ”¶å…¥: +${d.income.toFixed(2)}\næ”¯å‡º: -${d.expense.toFixed(2)}">
                                    <div class="ldsp-ldc-chart-bar-group">
                                        <div class="ldsp-ldc-chart-bar income" style="height:${incomeH}%"></div>
                                        <div class="ldsp-ldc-chart-bar expense" style="height:${expenseH}%"></div>
                                    </div>
                                    <span class="ldsp-ldc-chart-label">${d.dateShort.split('/')[1]}</span>
                                </div>`;
                            }).join('')}
                        </div>
                        <div class="ldsp-ldc-chart-legend">
                            <span class="ldsp-ldc-legend-item income"><i></i>æ”¶å…¥</span>
                            <span class="ldsp-ldc-legend-item expense"><i></i>æ”¯å‡º</span>
                        </div>
                    </div>` : '';

                body.innerHTML = `
                    <div class="ldsp-ldc-balance-card">
                        <div class="ldsp-ldc-balance-main">
                            <div class="ldsp-ldc-balance-left">
                                <div class="ldsp-ldc-balance-label">ğŸŸå¯ç”¨ä½™é¢ï¼š</div>
                                <div class="ldsp-ldc-balance-value">${Utils.escapeHtml(data.credits)}</div>
                            </div>
                            <div class="ldsp-ldc-balance-right">
                                <div class="ldsp-ldc-balance-sub">ä»Šæ—¥å‰©ä½™é¢åº¦ <span class="ldsp-ldc-balance-sub-value">${Utils.escapeHtml(data.dailyLimit)}</span></div>
                                ${estimateHtml}
                            </div>
                        </div>
                        <div class="ldsp-ldc-balance-footer">
                            <span class="ldsp-ldc-balance-time">æ•°æ®æ›´æ–°äºï¼š${Utils.escapeHtml(data.updateTime)}</span>
                        </div>
                    </div>
                    <div class="ldsp-ldc-stats-grid">
                        <div class="ldsp-ldc-stat-card income">
                            <div class="ldsp-ldc-stat-icon">ğŸ“ˆ</div>
                            <div class="ldsp-ldc-stat-info">
                                <div class="ldsp-ldc-stat-label">æ€»æ”¶å…¥</div>
                                <div class="ldsp-ldc-stat-num">+${Utils.escapeHtml(data.incomeTotal)}</div>
                            </div>
                        </div>
                        <div class="ldsp-ldc-stat-card expense">
                            <div class="ldsp-ldc-stat-icon">ğŸ“‰</div>
                            <div class="ldsp-ldc-stat-info">
                                <div class="ldsp-ldc-stat-label">æ€»æ”¯å‡º</div>
                                <div class="ldsp-ldc-stat-num">-${Utils.escapeHtml(data.expenseTotal)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="ldsp-ldc-section">
                        <div class="ldsp-ldc-section-header">
                            <span class="ldsp-ldc-section-title">ğŸ“Š è¿‘7å¤©æ”¶æ”¯</span>
                            <span class="ldsp-ldc-section-summary">
                                <em class="income">+${stats7d.income.toFixed(2)}</em>
                                <em class="expense">-${stats7d.expense.toFixed(2)}</em>
                            </span>
                        </div>
                        ${chartHtml || '<div class="ldsp-ldc-empty">æš‚æ— æ•°æ®</div>'}
                    </div>
                    <div class="ldsp-ldc-info-section">
                        <a href="https://linux.do/t/topic/1353235" target="_blank" rel="noopener" class="ldsp-ldc-info-card faq">
                            <span class="ldsp-ldc-info-icon">ğŸ“–</span>
                            <div class="ldsp-ldc-info-content">
                                <div class="ldsp-ldc-info-title">Credit FAQ & ç§¯åˆ†è§„åˆ™</div>
                                <div class="ldsp-ldc-info-desc">äº†è§£ LDC ç§¯åˆ†çš„è·å–æ–¹å¼ã€ä½¿ç”¨è§„åˆ™å’Œå¸¸è§é—®é¢˜</div>
                            </div>
                            <span class="ldsp-ldc-info-arrow">â†’</span>
                        </a>
                    </div>`;
            }

            _getTimeRange() {
                const now = new Date(), todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const end = new Date(todayStart); end.setDate(end.getDate() + 1);
                let start = new Date(todayStart);
                const r = this._filter.timeRange;
                if (r === 'today') start = todayStart;
                else if (r === '7days') start.setDate(start.getDate() - 6);
                else if (r === '30days') start.setDate(start.getDate() - 29);
                else start.setFullYear(start.getFullYear() - 1);
                const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T00:00:00+08:00`;
                return { startTime: fmt(start), endTime: fmt(end) };
            }

            async _fetchTrans(refresh = false, more = false) {
                const token = ++this._reqToken.trans;
                this._loadingState.trans = true;
                const currentTab = this._tab; // ä¿å­˜å‘èµ·è¯·æ±‚æ—¶çš„ tab çŠ¶æ€
                const _body = this.overlay.querySelector('.ldsp-ldc-body');
                const btn = this.overlay.querySelector('.ldsp-ldc-refresh');
                if (!more) { btn?.classList.add('spinning'); this._trans = { orders: [], page: 1, total: 0, hasMore: false }; this._renderTransUI(true); }
                const page = more ? this._trans.page + 1 : 1;

                try {
                    // ç¡®ä¿ _userId å·²è®¾ç½®ï¼Œç”¨äºå‡†ç¡®åˆ¤æ–­æ”¶æ”¯
                    if (!this._userId) {
                        const user = await this._getUserInfo();
                        if (user && !user._authError) {
                            this._userId = user.id || user.user_id || null;
                        }
                    }
                    // æ£€æŸ¥ tab æ˜¯å¦å·²åˆ‡æ¢ï¼Œæ˜¯åˆ™æ”¾å¼ƒæ¸²æŸ“
                    if (this._tab !== currentTab) return;
                    const { startTime, endTime } = this._getTimeRange();
                    const payload = { page, page_size: 20, startTime, endTime };
                    if (this._filter.type) payload.type = this._filter.type;
                    const result = await this._request('https://credit.linux.do/api/v1/order/transactions', 'POST', payload);
                    // è¯·æ±‚è¿”å›åå†æ¬¡æ£€æŸ¥ tab çŠ¶æ€
                    if (this._tab !== currentTab || token !== this._reqToken.trans) return;
                    if (result?._authError) { this._showError('è¯·å…ˆç™»å½• credit.linux.do', true); return; }
                    if (!result) { this._showError('è·å–æ•°æ®å¤±è´¥'); return; }
                    const orders = result.orders || [], total = result.total || 0;
                    this._trans.orders = more ? [...this._trans.orders, ...orders] : orders;
                    this._trans.page = page;
                    this._trans.total = total;
                    this._trans.hasMore = this._trans.orders.length < total;
                    this._renderTransUI();
                } catch { if (!more && this._tab === currentTab && token === this._reqToken.trans) this._showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'); }
                finally {
                    if (token === this._reqToken.trans) this._loadingState.trans = false;
                    btn?.classList.remove('spinning');
                }
            }

            _renderTransUI(loading = false) {
                const body = this.overlay.querySelector('.ldsp-ldc-body');
                const { orders, total, hasMore } = this._trans;
                const filterHtml = this._getFilterHtml();
                let content;
                if (loading) {
                    content = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                } else if (!orders.length) {
                    const tl = LDCManager.TIME_RANGES.find(t => t.id === this._filter.timeRange)?.label || '';
                    const tp = this._filter.type ? (LDCManager.TRANS_TYPES.find(t => t.id === this._filter.type)?.label || '') : '';
                    content = `<div class="ldsp-ldc-empty-state"><div class="ldsp-ldc-empty-icon">ğŸ“­</div><div class="ldsp-ldc-empty-text">æš‚æ— äº¤æ˜“è®°å½•</div>
                        ${tl || tp ? `<div class="ldsp-ldc-empty-hint">ç­›é€‰æ¡ä»¶ï¼š${tl}${tp ? ` Â· ${tp}` : ''}</div>` : ''}</div>`;
                } else {
                    const list = orders.map(o => {
                        const ti = LDCManager.TRANS_TYPES.find(t => t.id === o.type) || { icon: 'ğŸ“‹', label: o.type };
                        // æ”¶æ”¯åˆ¤æ–­ï¼šä¼˜å…ˆé€šè¿‡ payee/payer åˆ¤æ–­ï¼ŒåŒæ—¶å¤„ç† amount å¯èƒ½ä¸ºè´Ÿæ•°çš„æƒ…å†µ
                        const isIncome = this._userId 
                            ? o.payee_user_id === this._userId && o.payer_user_id !== this._userId
                            : (o.type === 'receive' || o.type === 'community' || o.payer_user_id === 0);
                        // ä½¿ç”¨ç»å¯¹å€¼ï¼Œå› ä¸º API è¿”å›çš„ amount å¯èƒ½å·²ç»æ˜¯è´Ÿæ•°
                        const amt = Math.abs(parseFloat(o.amount) || 0);
                        return `<div class="ldsp-ldc-trans-item" data-order-id="${o.id}">
                            <div class="ldsp-ldc-trans-icon">${ti.icon}</div>
                            <div class="ldsp-ldc-trans-info"><div class="ldsp-ldc-trans-name">${Utils.escapeHtml(o.order_name || o.app_name || 'æœªçŸ¥')}</div>
                            <div class="ldsp-ldc-trans-meta"><span>${Utils.escapeHtml(this._fmtTime(o.trade_time || o.created_at))}</span>
                            <span class="ldsp-ldc-trans-type type-${o.type || 'default'}">${ti.label}</span></div></div>
                            <div class="ldsp-ldc-trans-amount ${isIncome ? 'income' : 'expense'}">${isIncome ? '+' : '-'}${amt.toFixed(2)}</div></div>`;
                    }).join('');
                    // å°† sentinel æ”¾åœ¨ trans-list å†…éƒ¨ï¼Œè¿™æ ·æ»šåŠ¨æ—¶æ‰èƒ½æ­£ç¡®è§¦å‘
                    content = `<div class="ldsp-ldc-trans-summary">å…± ${total} æ¡è®°å½•${orders.length < total ? `ï¼Œå·²åŠ è½½ ${orders.length} æ¡` : ''}</div>
                        <div class="ldsp-ldc-trans-list">${list}${hasMore ? `<div class="ldsp-ldc-load-sentinel"></div>` : ''}</div>`;
                }
                body.innerHTML = `${filterHtml}<div class="ldsp-ldc-trans-content">${content}</div>`;
                this._bindFilterEvents(body);
                this._bindTransEvents();
            }

            _bindTransEvents() {
                const body = this.overlay.querySelector('.ldsp-ldc-body');
                body.querySelectorAll('.ldsp-ldc-trans-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const o = this._trans.orders.find(x => String(x.id) === item.dataset.orderId);
                        if (o) this._showDetail(o);
                    });
                });
                // ç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
                this._setupInfiniteScroll(body);
            }

            _setupInfiniteScroll(body) {
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (this._scrollHandler) {
                    body.removeEventListener('scroll', this._scrollHandler);
                }
                
                const sentinel = body.querySelector('.ldsp-ldc-load-sentinel');
                if (!sentinel || !this._trans.hasMore) return;
                
                // æ‰¾åˆ°å®é™…çš„æ»šåŠ¨å®¹å™¨ (.ldsp-ldc-trans-list)
                const scrollContainer = body.querySelector('.ldsp-ldc-trans-list');
                if (!scrollContainer) return;
                
                // ä½¿ç”¨ IntersectionObserver å®ç°é«˜æ€§èƒ½æ»šåŠ¨åŠ è½½
                if (this._scrollObserver) {
                    this._scrollObserver.disconnect();
                }
                
                this._scrollObserver = new IntersectionObserver(async (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting && !this._loadingState.trans && this._trans.hasMore) {
                        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                        sentinel.innerHTML = '<div class="ldsp-ldc-loading-more"><div class="ldsp-mini-spin" style="width:14px;height:14px"></div><span>åŠ è½½ä¸­...</span></div>';
                        await this._fetchTrans(false, true);
                    }
                }, {
                    root: scrollContainer,
                    rootMargin: '100px',
                    threshold: 0
                });
                
                this._scrollObserver.observe(sentinel);
            }

            // ==================== å°å–éƒ¨åŠŸèƒ½ ====================
            // é»˜è®¤åˆ†ç±»ï¼ˆä¸æ•°æ®åº“ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨æ•°å­— IDï¼‰
            static SHOP_CATEGORIES = [
                { id: 1, name: 'AI', icon: 'ğŸ¤–' },
                { id: 2, name: 'å­˜å‚¨', icon: 'ğŸ’¾' },
                { id: 3, name: 'å°é¸¡', icon: 'ğŸ”' },
                { id: 4, name: 'å’¨è¯¢', icon: 'ğŸ’¬' }
            ];

            // è§£åŒ…åµŒå¥—çš„ API å“åº” { success, data: { success, data: {...} } } -> å†…å±‚ data
            _unwrapShopResponse(resp) {
                if (resp?.success && resp.data?.success && resp.data?.data) {
                    return { success: true, data: resp.data.data };
                }
                return resp;
            }

            async _fetchShopCategories(forceRefresh = false) {
                const now = Date.now();
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
                if (!forceRefresh && this._shopCategoriesCache && (now - this._shopCategoriesCache.timestamp < this._shopCategoriesCacheTTL)) {
                    return this._shopCategoriesCache.categories;
                }
                try {
                    const resp = this._unwrapShopResponse(await this._shopRequest('/api/shop/categories'));
                    if (resp?.success && resp.data?.categories) {
                        this._shopCategories = resp.data.categories;
                        this._shopCategoriesCache = { categories: resp.data.categories, timestamp: now };
                        return resp.data.categories;
                    }
                } catch {}
                return LDCManager.SHOP_CATEGORIES;
            }

            async _fetchShopProducts(categoryId = '', forceRefresh = false, page = 1, append = false) {
                const cacheKey = categoryId || '__all__';
                const now = Date.now();
                // é¦–æ¬¡åŠ è½½æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
                if (page === 1 && !forceRefresh) {
                    const cached = this._shopProductsCache.get(cacheKey);
                    if (cached && (now - cached.timestamp < this._shopCacheTTL)) {
                        this._shopHasMore = cached.hasMore !== false;
                        this._shopTotal = cached.total || cached.products.length; // ä»ç¼“å­˜æ¢å¤æ€»æ•°
                        return cached.products;
                    }
                }
                try {
                    let url = `/api/shop/products?page=${page}&pageSize=${this._shopPageSize}`;
                    if (categoryId) url += `&categoryId=${encodeURIComponent(categoryId)}`;
                    const resp = this._unwrapShopResponse(await this._shopRequest(url));
                    if (resp?.success && resp.data?.products) {
                        const products = resp.data.products;
                        const total = resp.data.pagination?.total || resp.data.total || products.length;
                        this._shopHasMore = (page * this._shopPageSize) < total;
                        // ä¿å­˜æ€»æ•°ç”¨äºæ˜¾ç¤º
                        if (page === 1) {
                            this._shopTotal = total;
                        }
                        
                        if (page === 1) {
                            this._shopProductsCache.set(cacheKey, { products, timestamp: now, hasMore: this._shopHasMore, total });
                            return products;
                        } else {
                            // è¿½åŠ æ¨¡å¼ä¸æ›´æ–°ç¼“å­˜ï¼Œä»…è¿”å›æ–°æ•°æ®
                            return products;
                        }
                    }
                } catch {}
                this._shopHasMore = false;
                return [];
            }
            
            // æ¸…é™¤å•†å“ç¼“å­˜ï¼ˆå‘å¸ƒ/æ›´æ–°/åˆ é™¤åè°ƒç”¨ï¼‰
            _invalidateShopCache() {
                this._shopProductsCache.clear();
                this._shopMyProductsCache = null;
            }

            async _fetchMyProducts(forceRefresh = false) {
                const now = Date.now();
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
                if (!forceRefresh && this._shopMyProductsCache && (now - this._shopMyProductsCache.timestamp < this._shopCacheTTL)) {
                    return this._shopMyProductsCache.products;
                }
                try {
                    const resp = this._unwrapShopResponse(await this._shopRequest('/api/shop/my-products'));
                    if (resp?.success && resp.data?.products) {
                        this._shopMyProductsCache = { products: resp.data.products, timestamp: now };
                        return resp.data.products;
                    }
                } catch {}
                return [];
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆæœ‰ Tokenï¼‰
            _hasToken() {
                const tokenKey = `ldsp_${CURRENT_SITE.prefix}_leaderboard_token`;
                return !!GM_getValue(tokenKey, null);
            }

            async _createProduct(data) {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!this._hasToken()) {
                    return { success: false, error: 'è¯·å…ˆåœ¨æ’è¡Œæ¦œé¢æ¿ä¸­ç™»å½•åå†å‘å¸ƒç‰©å“' };
                }
                try {
                    const resp = this._unwrapShopResponse(await this._shopRequest('/api/shop/products', 'POST', data));
                    return resp;
                } catch (e) {
                    return { success: false, error: e.message || 'åˆ›å»ºå¤±è´¥' };
                }
            }

            async _updateProduct(id, data) {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!this._hasToken()) {
                    return { success: false, error: 'è¯·å…ˆåœ¨æ’è¡Œæ¦œé¢æ¿ä¸­ç™»å½•åå†æ“ä½œ' };
                }
                try {
                    const resp = this._unwrapShopResponse(await this._shopRequest(`/api/shop/my-products/${id}`, 'PUT', data));
                    return resp;
                } catch (e) {
                    return { success: false, error: e.message || 'æ›´æ–°å¤±è´¥' };
                }
            }

            async _toggleProductStatus(id, active, product = null) {
                try {
                    // ä¸‹æ¶ä½¿ç”¨ offline æ¥å£
                    if (!active) {
                        const resp = this._unwrapShopResponse(await this._shopRequest(`/api/shop/my-products/${id}/offline`, 'POST'));
                        return resp;
                    } else {
                        // é‡æ–°ä¸Šæ¶ - å‘é€å•†å“å½“å‰æ•°æ®è§¦å‘åç«¯çŠ¶æ€æ›´æ–°
                        // åç«¯ä¼šè‡ªåŠ¨å°† offline çŠ¶æ€æ”¹ä¸º pending
                        const data = product ? {
                            name: product.name,
                            categoryId: product.category_id,
                            description: product.description,
                            price: product.price,
                            discount: product.discount,
                            imageUrl: product.image_url || '',
                            paymentLink: product.payment_link
                        } : {};
                        const resp = this._unwrapShopResponse(await this._shopRequest(`/api/shop/my-products/${id}`, 'PUT', data));
                        return resp;
                    }
                } catch (e) {
                    return { success: false, error: e.message || 'æ“ä½œå¤±è´¥' };
                }
            }

            async _deleteMyProduct(id) {
                try {
                    const resp = this._unwrapShopResponse(await this._shopRequest(`/api/shop/my-products/${id}`, 'DELETE'));
                    return resp;
                } catch (e) {
                    return { success: false, error: e.message || 'åˆ é™¤å¤±è´¥' };
                }
            }

            async _recordProductView(id) {
                // è°ƒç”¨å•†å“è¯¦æƒ… API æ¥è®°å½•æµè§ˆé‡
                // åç«¯ä¼šè‡ªåŠ¨åŸºäº IP åšé˜²åˆ·å¤„ç†ï¼ˆ1å°æ—¶å†…åŒIPåªè®¡1æ¬¡ï¼‰
                try {
                    const resp = this._unwrapShopResponse(await this._shopRequest(`/api/shop/products/${id}`));
                    if (resp?.success && resp.data?.product) {
                        const newViewCount = resp.data.product.view_count || 0;
                        // æ›´æ–°è¯¦æƒ…é¡µé¢æ˜¾ç¤ºçš„æµè§ˆé‡ï¼ˆå¦‚æœé¡µé¢è¿˜åœ¨å±•ç¤ºè¿™ä¸ªå•†å“ï¼‰
                        if (this._shopProduct?.id === id) {
                            this._shopProduct.view_count = newViewCount;
                            // æ›´æ–° DOM ä¸­çš„æµè§ˆé‡æ˜¾ç¤º
                            const viewEl = this.overlay.querySelector('.ldsp-shop-detail-info-item');
                            if (viewEl && viewEl.textContent.includes('ğŸ‘')) {
                                viewEl.textContent = `ğŸ‘ ${newViewCount}`;
                            }
                        }
                    }
                } catch (e) {
                    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
                    console.log('[LDStatus Pro Shop] Record view failed:', e.message);
                }
            }

            async _shopRequest(path, method = 'GET', body = null) {
                const API_BASE = (typeof ApiService !== 'undefined' && ApiService.baseUrl) || 'https://api.ldspro.qzz.io';
                const url = API_BASE + path;
                
                // è·å– JWT Token ç”¨äºè®¤è¯ï¼ˆå­˜å‚¨é”®æ ¼å¼ï¼šldsp_{site_prefix}_leaderboard_tokenï¼‰
                // CURRENT_SITE.prefix å¯¹äº linux.do æ˜¯ 'linux_do'
                const tokenKey = `ldsp_${CURRENT_SITE.prefix}_leaderboard_token`;
                const token = GM_getValue(tokenKey, null);
                
                // è°ƒè¯•æ—¥å¿—
                console.log('[LDStatus Pro Shop] Request:', { url, method, tokenKey, hasToken: !!token, tokenPreview: token ? token.substring(0, 20) + '...' : null });
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                return new Promise((resolve, reject) => {
                    GM_xmlhttpRequest({
                        method,
                        url,
                        headers,
                        data: body ? JSON.stringify(body) : undefined,
                        withCredentials: true,
                        timeout: 15000,
                        onload: r => {
                            if (r.status >= 200 && r.status < 300) {
                                try {
                                    resolve(JSON.parse(r.responseText));
                                } catch {
                                    resolve({ success: false, error: 'å“åº”è§£æå¤±è´¥' });
                                }
                            } else {
                                try {
                                    const err = JSON.parse(r.responseText);
                                    // ç¡®ä¿ error æ˜¯å­—ç¬¦ä¸²
                                    const errMsg = typeof err.error === 'string' ? err.error :
                                                   (err.error?.message || err.message || `è¯·æ±‚å¤±è´¥ (${r.status})`);
                                    resolve({ success: false, error: errMsg });
                                } catch {
                                    resolve({ success: false, error: `è¯·æ±‚å¤±è´¥ (${r.status})` });
                                }
                            }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }
            
            // è·å–å½“å‰æ´»åŠ¨çš„å£«å¤š body å®¹å™¨ï¼ˆæ”¯æŒç‹¬ç«‹å£«å¤šé¢æ¿å’Œ LDC å†…çš„å£«å¤šï¼‰
            _getShopBody() {
                // ä¼˜å…ˆæ£€æŸ¥ç‹¬ç«‹å£«å¤šé¢æ¿
                if (this.shopOverlay?.classList.contains('show')) {
                    return this.shopOverlay.querySelector('.ldsp-ldc-body');
                }
                // å¦åˆ™è¿”å› LDC overlay çš„ body
                return this.overlay.querySelector('.ldsp-ldc-body');
            }

            async _renderShop() {
                const body = this._getShopBody();
                body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                
                // é‡ç½®åˆ†é¡µçŠ¶æ€
                this._shopPage = 1;
                this._shopHasMore = true;
                this._shopLoading = false;
                
                // å¹¶è¡Œè·å–åˆ†ç±»å’Œå•†å“
                const [categories, products] = await Promise.all([
                    this._fetchShopCategories(),
                    this._fetchShopProducts(this._shopCategory, false, 1)
                ]);
                
                this._shopCategories = categories.length > 0 ? categories : LDCManager.SHOP_CATEGORIES;
                this._shopProducts = products;
                this._shopView = 'list';
                this._renderShopList();
            }

            // åˆ·æ–°ç‰©å“åˆ—è¡¨ï¼ˆç‚¹å‡»å½“å‰Tabæ—¶è°ƒç”¨ï¼Œå¸¦1åˆ†é’Ÿç¼“å­˜é™åˆ¶ï¼‰
            async _refreshShopList() {
                const body = this._getShopBody();
                const cacheKey = this._shopCategory || '__all__';
                const cached = this._shopProductsCache.get(cacheKey);
                const now = Date.now();
                
                // æ£€æŸ¥æ˜¯å¦åœ¨1åˆ†é’Ÿå†…ï¼ˆç¼“å­˜æœ‰æ•ˆï¼‰
                if (cached && (now - cached.timestamp < this._shopCacheTTL)) {
                    // ç¼“å­˜æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆä¸è¯·æ±‚ï¼‰
                    return;
                }
                
                // é‡ç½®åˆ†é¡µçŠ¶æ€
                this._shopPage = 1;
                this._shopHasMore = true;
                this._shopLoading = false;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const grid = body.querySelector('.ldsp-shop-grid') || body.querySelector('.ldsp-shop-empty');
                if (grid) grid.innerHTML = `<div class="ldsp-ldc-loading" style="grid-column:1/-1"><div class="ldsp-spinner"></div><div>åˆ·æ–°ä¸­...</div></div>`;
                
                // å¼ºåˆ¶åˆ·æ–°è·å–æ•°æ®
                this._shopProducts = await this._fetchShopProducts(this._shopCategory, true, 1);
                this._renderShopList();
            }

            // åˆ·æ–°æˆ‘çš„ç‰©å“ï¼ˆç‚¹å‡»å½“å‰Tabæ—¶è°ƒç”¨ï¼Œå¸¦1åˆ†é’Ÿç¼“å­˜é™åˆ¶ï¼‰
            async _refreshShopMy() {
                const body = this._getShopBody();
                const now = Date.now();
                
                // æ£€æŸ¥æ˜¯å¦åœ¨1åˆ†é’Ÿå†…ï¼ˆç¼“å­˜æœ‰æ•ˆï¼‰
                if (this._shopMyProductsCache && (now - this._shopMyProductsCache.timestamp < this._shopCacheTTL)) {
                    // ç¼“å­˜æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆä¸è¯·æ±‚ï¼‰
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const list = body.querySelector('.ldsp-shop-my-list') || body.querySelector('.ldsp-shop-empty');
                if (list) list.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åˆ·æ–°ä¸­...</div></div>`;
                
                // å¼ºåˆ¶åˆ·æ–°è·å–æ•°æ®å¹¶é‡æ–°æ¸²æŸ“
                this._shopMyProducts = await this._fetchMyProducts(true);
                // ç›´æ¥æ¸²æŸ“æˆ‘çš„ç‰©å“é¡µé¢ï¼ˆæ•°æ®å·²è·å–ï¼‰
                this._renderShopMyWithData();
            }
            
            // ä½¿ç”¨å·²æœ‰æ•°æ®æ¸²æŸ“æˆ‘çš„ç‰©å“ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
            _renderShopMyWithData() {
                const body = this._getShopBody();
                this._shopView = 'my';
                
                const products = this._shopMyProducts;
                const categories = this._shopCategories;
                
                const productList = products.length > 0 ? products.map(p => {
                    const hasImg = p.image_url && p.image_url.trim();
                    const cat = categories.find(c => c.id === p.category_id);
                    const catIcon = p.category_icon || cat?.icon || 'ğŸ“¦';
                    const catName = p.category_name || cat?.name || 'å…¶ä»–';
                    const status = p.status || 'pending';
                    const statusMap = {
                        'approved': { text: 'åœ¨å”®', class: 'active' },
                        'pending': { text: 'å¾…å®¡æ ¸', class: 'inactive' },
                        'rejected': { text: 'å·²æ‹’ç»', class: 'inactive rejected' },
                        'offline': { text: 'å·²ä¸‹æ¶', class: 'inactive' }
                    };
                    const statusInfo = statusMap[status] || statusMap['pending'];
                    const myCardBgColor = this._getRandomLightColor(p.id);
                    // è·å–æ‹’ç»/ä¸‹æ¶åŸå› 
                    const statusReason = p.status_reason || p.reject_reason;
                    const isAdminAction = p.status_action === 'admin_offline' || p.status_admin;
                    // v2.0: å•†å“ç±»å‹å’Œåº“å­˜ï¼ˆä¼˜å…ˆä½¿ç”¨ availableStock æˆ– cdkStats.availableï¼‰
                    const productType = p.product_type || 'link';
                    const isCdk = productType === 'cdk';
                    const stock = parseInt(p.stock) || 0;
                    const availableStock = p.availableStock !== undefined ? p.availableStock : (p.cdkStats?.available ?? stock);
                    const isLowStock = isCdk && stock !== -1 && availableStock <= 5 && availableStock > 0;
                    const isOutOfStock = isCdk && stock !== -1 && availableStock <= 0;
                    
                    return `<div class="ldsp-shop-my-card" data-product-id="${p.id}">
                        <div class="ldsp-shop-my-card-status ${statusInfo.class}">${statusInfo.text}</div>
                        ${isCdk ? `<div class="ldsp-shop-my-card-type">CDK</div>` : ''}
                        ${hasImg ? `<div class="ldsp-shop-my-card-img-wrap"><img class="ldsp-shop-my-card-img" src="${Utils.escapeHtml(p.image_url)}" alt="${Utils.escapeHtml(p.name)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="ldsp-shop-my-card-img-placeholder" style="display:none;background:${myCardBgColor}">${catIcon}</div></div>` : 
                        `<div class="ldsp-shop-my-card-img-placeholder" style="background:${myCardBgColor}">${catIcon}</div>`}
                        <div class="ldsp-shop-my-card-info">
                            <div class="ldsp-shop-my-card-name">${Utils.escapeHtml(p.name)}</div>
                            ${(status === 'rejected' || status === 'offline') && statusReason ? `<div class="ldsp-shop-my-card-reason">${isAdminAction ? 'âš ï¸ ç®¡ç†å‘˜ä¸‹æ¶: ' : (status === 'rejected' ? 'âŒ æ‹’ç»åŸå› : ' : 'ğŸ“ åŸå› : ')}${Utils.escapeHtml(statusReason)}</div>` : ''}
                            <div class="ldsp-shop-my-card-meta">
                                <span>${catIcon} ${Utils.escapeHtml(catName)}</span>
                                ${isCdk ? `<span class="ldsp-shop-my-card-stock${isOutOfStock ? ' low' : isLowStock ? ' low' : ''}"><span class="available">${stock === -1 ? 'âˆ' : availableStock}</span><span class="divider">/</span><span class="total">${p.cdkStats?.total || stock || 0}</span></span>` : ''}
                                <span>ğŸ‘ï¸ ${p.view_count || 0}</span>
                            </div>
                            <div class="ldsp-shop-my-card-price">${parseFloat(p.price).toFixed(2)} LDC</div>
                            <div class="ldsp-shop-my-card-actions">
                                <button class="ldsp-shop-my-card-btn" data-action="edit" data-id="${p.id}">ç¼–è¾‘</button>
                                ${isCdk ? `<button class="ldsp-shop-my-card-btn" data-action="manage-cdk" data-id="${p.id}">CDKåº“å­˜</button>` : ''}
                                ${status === 'approved' ? `<button class="ldsp-shop-my-card-btn danger" data-action="toggle" data-id="${p.id}">ä¸‹æ¶</button>` : ''}
                                ${status === 'offline' ? `<button class="ldsp-shop-my-card-btn" data-action="toggle" data-id="${p.id}">é‡æ–°ä¸Šæ¶</button>` : ''}
                                ${status !== 'approved' ? `<button class="ldsp-shop-my-card-btn danger" data-action="delete" data-id="${p.id}">åˆ é™¤</button>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('') : '';

                body.innerHTML = `
                    <div class="ldsp-shop">
                        <div class="ldsp-shop-header">
                            <div class="ldsp-shop-tabs">
                                <div class="ldsp-shop-tab" data-view="list">ğŸª å¹¿åœº</div>
                                <div class="ldsp-shop-tab active" data-view="my">ğŸ“¦ æˆ‘çš„</div>
                                <div class="ldsp-shop-tab" data-view="orders">ğŸ“‹ è®¢å•</div>
                                <div class="ldsp-shop-tab" data-view="settings">âš™ï¸ è®¾ç½®</div>
                            </div>
                            <button class="ldsp-shop-add-btn" data-action="add">â• å‘å¸ƒ</button>
                        </div>
                        ${products.length > 0 ? `<div class="ldsp-shop-my-list">${productList}</div>` : 
                        `<div class="ldsp-shop-empty"><div class="ldsp-shop-empty-icon">ğŸ“­</div><div class="ldsp-shop-empty-text">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒç‰©å“</div><div class="ldsp-shop-empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å‘å¸ƒæ‚¨çš„ç¬¬ä¸€ä¸ªç‰©å“</div></div>`}
                    </div>`;

                this._bindShopMyEvents(body);
            }

            _renderShopList() {
                const body = this._getShopBody();
                const categories = this._shopCategories;
                const products = this._shopProducts;
                
                // ä¿®å¤ï¼šä½¿ç”¨ String è½¬æ¢ç¡®ä¿æ¯”è¾ƒæ­£ç¡®
                const currentCategory = String(this._shopCategory || '');
                // è·å–å½“å‰åˆ†ç±»åç§°ç”¨äºæ˜¾ç¤º
                const currentCat = categories.find(c => String(c.id) === currentCategory);
                const categoryLabel = currentCat ? `${currentCat.icon || 'ğŸ“¦'} ${currentCat.name}` : 'ğŸ·ï¸ å…¨éƒ¨';
                
                const categoryChips = [
                    `<div class="ldsp-shop-filter-chip${!currentCategory ? ' active' : ''}" data-category="">ğŸ·ï¸ å…¨éƒ¨</div>`,
                    ...categories.map(c => `<div class="ldsp-shop-filter-chip${currentCategory === String(c.id) ? ' active' : ''}" data-category="${c.id}">${c.icon || 'ğŸ“¦'} ${c.name}</div>`)
                ].join('');

                const productCards = products.length > 0 ? products.map(p => this._renderShopCard(p, categories)).join('') : '';
                
                // æ·»åŠ åŠ è½½æ›´å¤šå“¨å…µ
                const loadMoreHtml = this._shopHasMore ? '<div class="ldsp-shop-load-sentinel"><div class="ldsp-shop-load-more-hint">â¬‡ï¸ æ»šåŠ¨åŠ è½½æ›´å¤š</div></div>' : (products.length > 0 ? '<div class="ldsp-shop-loaded-all">âœ… å·²åŠ è½½å…¨éƒ¨</div>' : '');

                body.innerHTML = `
                    <div class="ldsp-shop">
                        <div class="ldsp-shop-header">
                            <div class="ldsp-shop-tabs">
                                <div class="ldsp-shop-tab active" data-view="list">ğŸª å¹¿åœº</div>
                                <div class="ldsp-shop-tab" data-view="my">ğŸ“¦ æˆ‘çš„</div>
                                <div class="ldsp-shop-tab" data-view="orders">ğŸ“‹ è®¢å•</div>
                                <div class="ldsp-shop-tab" data-view="settings">âš™ï¸ è®¾ç½®</div>
                            </div>
                            <button class="ldsp-shop-add-btn" data-action="add">â• å‘å¸ƒ</button>
                        </div>
                        <div class="ldsp-shop-filter">${categoryChips}</div>
                        <div class="ldsp-shop-count">${categoryLabel} å…± <strong>${this._shopTotal}</strong> ä»¶ç‰©å“</div>
                        ${products.length > 0 ? `<div class="ldsp-shop-grid">${productCards}${loadMoreHtml}</div>` : 
                        `<div class="ldsp-shop-empty"><div class="ldsp-shop-empty-icon">ğŸª</div><div class="ldsp-shop-empty-text">æš‚æ— ç‰©å“</div><div class="ldsp-shop-empty-hint">å¿«æ¥å‘å¸ƒç¬¬ä¸€ä¸ªç‰©å“å§~</div></div>`}
                    </div>`;

                this._bindShopListEvents(body);
            }
            
            // æ ¼å¼åŒ–å¤´åƒ URL
            _formatAvatar(avatar, username) {
                if (avatar && avatar.trim()) return avatar.trim();
                return '';
            }
            
            // ç”Ÿæˆéšæœºæµ…è‰²èƒŒæ™¯
            _getRandomLightColor(seed) {
                const colors = [
                    'linear-gradient(135deg,#e0f2fe,#bae6fd)', // æµ…è“
                    'linear-gradient(135deg,#fce7f3,#fbcfe8)', // æµ…ç²‰
                    'linear-gradient(135deg,#d1fae5,#a7f3d0)', // æµ…ç»¿
                    'linear-gradient(135deg,#fef3c7,#fde68a)', // æµ…é»„
                    'linear-gradient(135deg,#ede9fe,#ddd6fe)', // æµ…ç´«
                    'linear-gradient(135deg,#ffedd5,#fed7aa)', // æµ…æ©™
                    'linear-gradient(135deg,#e0e7ff,#c7d2fe)', // æµ…é–è“
                    'linear-gradient(135deg,#f5f5f4,#e7e5e4)'  // æµ…ç°
                ];
                const index = seed ? Math.abs(seed) % colors.length : Math.floor(Math.random() * colors.length);
                return colors[index];
            }
            
            // æ¸²æŸ“å•ä¸ªå•†å“å¡ç‰‡
            // v2.0: æ”¯æŒ product_type (link/cdk/store), stock, sold_count
            _renderShopCard(p, categories) {
                const price = parseFloat(p.price) || 0;
                const discount = parseFloat(p.discount) || 1;
                const finalPrice = (price * discount).toFixed(2);
                const hasDiscount = discount < 1;
                const hasImg = p.image_url && p.image_url.trim();
                const cat = categories.find(c => c.id === p.category_id);
                const catIcon = p.category_icon || cat?.icon || 'ğŸ“¦';
                const catName = p.category_name || cat?.name || 'å…¶ä»–';
                const sellerAvatar = this._formatAvatar(p.seller_avatar, p.seller_username);
                const updateTime = this._formatRelativeTime(p.updated_at || p.created_at);
                const bgColor = this._getRandomLightColor(p.id);
                
                // v2.0: å•†å“ç±»å‹å’Œåº“å­˜
                const productType = p.product_type || 'link';
                const isCdk = productType === 'cdk';
                const isStore = productType === 'store';
                const stock = parseInt(p.stock) || 0;
                const soldCount = parseInt(p.sold_count) || 0;
                const availableStock = p.availableStock !== undefined ? p.availableStock : stock;
                const isLowStock = isCdk && stock !== -1 && availableStock <= 5 && availableStock > 0;
                const isOutOfStock = isCdk && stock !== -1 && availableStock <= 0;
                
                // CDK åº“å­˜æ˜¾ç¤ºï¼šå‰©ä½™/æ€»è®¡
                const totalStock = isCdk ? (p.cdkStats?.total || stock) : 0;
                const stockClass = isOutOfStock ? 'out' : isLowStock ? 'low' : '';
                
                // å°åº—ç±»å‹ä½¿ç”¨ç‹¬ç«‹å¡ç‰‡æ ·å¼
                if (isStore) {
                    const storeOwner = p.seller_username || p.seller_name || 'åº—ä¸»';
                    return `<div class="ldsp-shop-card store-card" data-product-id="${p.id}">
                        <div class="ldsp-shop-card-type store">å‹æƒ…å°åº—</div>
                        <div class="ldsp-shop-card-cover" style="${hasImg ? '' : `background:${bgColor}`}">
                            ${hasImg ? `<img src="${Utils.escapeHtml(p.image_url)}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="ldsp-shop-card-placeholder" style="display:none;background:${bgColor}">ğŸª</div>` : 'ğŸª'}
                        </div>
                        <div class="ldsp-shop-card-body">
                            <div class="ldsp-shop-card-name">${Utils.escapeHtml(p.name)}</div>
                            <div class="ldsp-shop-card-meta">
                                <span class="ldsp-shop-card-time">${updateTime}</span>
                            </div>
                            <div class="ldsp-shop-card-footer">
                                <span class="ldsp-shop-card-store-owner">ğŸ‘¤ ${Utils.escapeHtml(storeOwner)}</span>
                                <div class="ldsp-shop-card-views">ğŸ‘${p.view_count || 0}</div>
                            </div>
                        </div>
                    </div>`;
                }
                
                return `<div class="ldsp-shop-card${isOutOfStock ? ' out-of-stock' : ''}" data-product-id="${p.id}">
                    ${isCdk ? `<div class="ldsp-shop-card-type cdk">CDK</div>` : ''}
                    ${hasDiscount ? `<div class="ldsp-shop-card-discount">-${Math.round((1 - discount) * 100)}%</div>` : ''}
                    <div class="ldsp-shop-card-cover" style="${hasImg ? '' : `background:${bgColor}`}">
                        ${hasImg ? `<img src="${Utils.escapeHtml(p.image_url)}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="ldsp-shop-card-placeholder" style="display:none;background:${bgColor}">${catIcon}</div>` : catIcon}
                    </div>
                    <div class="ldsp-shop-card-body">
                        <div class="ldsp-shop-card-name">${Utils.escapeHtml(p.name)}</div>
                        <div class="ldsp-shop-card-meta">
                            <span class="ldsp-shop-card-category">${Utils.escapeHtml(catName)}</span>
                            ${isCdk ? `<span class="ldsp-shop-card-stock${stockClass ? ' ' + stockClass : ''}"><span class="available">${stock === -1 ? 'âˆ' : availableStock}</span><span class="divider">/</span><span class="total">${stock === -1 ? 'âˆ' : totalStock}</span></span>` : ''}
                            <span class="ldsp-shop-card-time">${updateTime}</span>
                        </div>
                        <div class="ldsp-shop-card-seller">
                            <img class="ldsp-shop-card-seller-avatar" src="${sellerAvatar}" alt="" onerror="this.style.display='none'">
                            <span class="ldsp-shop-card-seller-name">${Utils.escapeHtml(p.seller_username || 'åŒ¿å')}</span>
                            ${isCdk && soldCount > 0 ? `<span class="ldsp-shop-card-sold">å·²å”®${soldCount}</span>` : ''}
                        </div>
                        <div class="ldsp-shop-card-footer">
                            <div class="ldsp-shop-card-price${hasDiscount ? ' discounted' : ''}">${finalPrice}<span>LDC</span>${hasDiscount ? `<span class="ldsp-shop-card-original">${price.toFixed(2)}</span>` : ''}</div>
                            <div class="ldsp-shop-card-views">ğŸ‘${p.view_count || 0}</div>
                        </div>
                    </div>
                </div>`;
            }
            
            // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
            _formatRelativeTime(timestamp) {
                if (!timestamp) return '';
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                if (minutes < 1) return 'åˆšåˆš';
                if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
                if (hours < 24) return `${hours}å°æ—¶å‰`;
                if (days < 30) return `${days}å¤©å‰`;
                return new Date(timestamp).toLocaleDateString('zh-CN');
            }

            _bindShopListEvents(body) {
                // è®¾ç½®ç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
                this._setupShopInfiniteScroll(body);
                
                // Tab åˆ‡æ¢ï¼ˆå¸¦é˜²æŠ–å’Œåˆ·æ–°é€»è¾‘ï¼‰
                body.querySelectorAll('.ldsp-shop-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        // é˜²æŠ–ï¼š300ms å†…é‡å¤ç‚¹å‡»å¿½ç•¥
                        if (this._shopTabClickDebounce) {
                            clearTimeout(this._shopTabClickDebounce);
                        }
                        this._shopTabClickDebounce = setTimeout(() => {
                            this._shopTabClickDebounce = null;
                        }, 300);
                        
                        const targetView = tab.dataset.view;
                        const isCurrentView = this._shopView === 'list' && targetView === 'list';
                        
                        if (targetView === 'my') {
                            // åˆ‡æ¢åˆ°æˆ‘çš„
                            this._renderShopMy();
                        } else if (targetView === 'orders') {
                            // åˆ‡æ¢åˆ°è®¢å•
                            this._renderShopOrders();
                        } else if (targetView === 'settings') {
                            // åˆ‡æ¢åˆ°è®¾ç½®
                            this._renderMerchantSettings();
                        } else if (isCurrentView) {
                            // ç‚¹å‡»å½“å‰æ‰€åœ¨çš„å¹¿åœºTabï¼Œè§¦å‘åˆ·æ–°
                            this._refreshShopList();
                        }
                    });
                });
                
                // åˆ†ç±»ç­›é€‰
                body.querySelectorAll('.ldsp-shop-filter-chip').forEach(chip => {
                    chip.addEventListener('click', async () => {
                        const category = chip.dataset.category || '';
                        const currentCategory = String(this._shopCategory || '');
                        if (category !== currentCategory) {
                            this._shopCategory = category;
                            // é‡ç½®åˆ†é¡µçŠ¶æ€
                            this._shopPage = 1;
                            this._shopHasMore = true;
                            this._shopLoading = false;
                            // å…ˆæ›´æ–° UI çŠ¶æ€å†åŠ è½½
                            body.querySelectorAll('.ldsp-shop-filter-chip').forEach(c => {
                                c.classList.toggle('active', (c.dataset.category || '') === category);
                            });
                            // æ˜¾ç¤ºåŠ è½½ä¸­
                            const grid = body.querySelector('.ldsp-shop-grid') || body.querySelector('.ldsp-shop-empty');
                            if (grid) grid.innerHTML = `<div class="ldsp-ldc-loading" style="grid-column:1/-1"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                            this._shopProducts = await this._fetchShopProducts(category, false, 1);
                            this._renderShopList();
                        }
                    });
                });
                
                // å‘å¸ƒæŒ‰é’®
                body.querySelector('.ldsp-shop-add-btn')?.addEventListener('click', () => {
                    this._shopEditProduct = null;
                    this._renderShopForm();
                });
                
                // å•†å“å¡ç‰‡ç‚¹å‡»
                body.querySelectorAll('.ldsp-shop-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const id = parseInt(card.dataset.productId);
                        const product = this._shopProducts.find(p => p.id === id);
                        if (product) {
                            // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®
                            const shopGrid = body.querySelector('.ldsp-shop-grid');
                            this._shopListScrollTop = shopGrid?.parentElement?.scrollTop || body.scrollTop || 0;
                            this._showProductDetail(product);
                        }
                    });
                });
            }
            
            // è®¾ç½®å•†å“åˆ—è¡¨ç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
            _setupShopInfiniteScroll(body) {
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨
                if (this._shopScrollObserver) {
                    this._shopScrollObserver.disconnect();
                    this._shopScrollObserver = null;
                }
                
                const sentinel = body.querySelector('.ldsp-shop-load-sentinel');
                if (!sentinel || !this._shopHasMore) return;
                
                const grid = body.querySelector('.ldsp-shop-grid');
                if (!grid) return;
                
                // ä½¿ç”¨ IntersectionObserver å®ç°é«˜æ€§èƒ½æ»šåŠ¨åŠ è½½
                this._shopScrollObserver = new IntersectionObserver(async (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting && !this._shopLoading && this._shopHasMore) {
                        this._shopLoading = true;
                        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                        sentinel.innerHTML = '<div class="ldsp-shop-loading-more"><div class="ldsp-mini-spin" style="width:16px;height:16px;border-width:2px"></div><span>åŠ è½½ä¸­...</span></div>';
                        
                        // åŠ è½½ä¸‹ä¸€é¡µ
                        this._shopPage++;
                        const newProducts = await this._fetchShopProducts(this._shopCategory, false, this._shopPage);
                        
                        if (newProducts.length > 0) {
                            // è¿½åŠ æ–°å•†å“åˆ°åˆ—è¡¨
                            this._shopProducts = [...this._shopProducts, ...newProducts];
                            // è¿½åŠ æ–°å¡ç‰‡åˆ° DOM
                            const newCards = newProducts.map(p => this._renderShopCard(p, this._shopCategories)).join('');
                            sentinel.insertAdjacentHTML('beforebegin', newCards);
                            // ç»‘å®šæ–°å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶
                            const allCards = grid.querySelectorAll('.ldsp-shop-card');
                            allCards.forEach(card => {
                                if (!card._bound) {
                                    card._bound = true;
                                    card.addEventListener('click', () => {
                                        const id = parseInt(card.dataset.productId);
                                        const product = this._shopProducts.find(p => p.id === id);
                                        if (product) {
                                            this._shopListScrollTop = grid.scrollTop || 0;
                                            this._showProductDetail(product);
                                        }
                                    });
                                }
                            });
                        }
                        
                        // æ›´æ–°å“¨å…µçŠ¶æ€
                        if (this._shopHasMore) {
                            sentinel.innerHTML = '<div class="ldsp-shop-load-more-hint">â¬‡ï¸ æ»šåŠ¨åŠ è½½æ›´å¤š</div>';
                        } else {
                            sentinel.innerHTML = '<div class="ldsp-shop-loaded-all">âœ… å·²åŠ è½½å…¨éƒ¨</div>';
                        }
                        
                        this._shopLoading = false;
                    }
                }, {
                    root: grid,
                    rootMargin: '100px',
                    threshold: 0
                });
                
                this._shopScrollObserver.observe(sentinel);
            }

            async _renderShopMy(forceRefresh = true) {
                const body = this._getShopBody();
                body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                
                this._shopMyProducts = await this._fetchMyProducts(forceRefresh);
                // ä½¿ç”¨ç»Ÿä¸€çš„æ¸²æŸ“å‡½æ•°ï¼ˆåŒ…å«v2.0åŠŸèƒ½ï¼šCDKæ ‡è®°ã€åº“å­˜æ˜¾ç¤ºã€CDKç®¡ç†æŒ‰é’®ç­‰ï¼‰
                this._renderShopMyWithData();
            }

            _bindShopMyEvents(body) {
                // Tab åˆ‡æ¢ï¼ˆå¸¦é˜²æŠ–å’Œåˆ·æ–°é€»è¾‘ï¼‰
                body.querySelectorAll('.ldsp-shop-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        // é˜²æŠ–ï¼š300ms å†…é‡å¤ç‚¹å‡»å¿½ç•¥
                        if (this._shopTabClickDebounce) {
                            clearTimeout(this._shopTabClickDebounce);
                        }
                        this._shopTabClickDebounce = setTimeout(() => {
                            this._shopTabClickDebounce = null;
                        }, 300);
                        
                        const targetView = tab.dataset.view;
                        const isCurrentView = this._shopView === 'my' && targetView === 'my';
                        
                        if (targetView === 'list') {
                            // åˆ‡æ¢åˆ°å¹¿åœº
                            this._shopCategory = '';
                            this._renderShop();
                        } else if (targetView === 'orders') {
                            // åˆ‡æ¢åˆ°è®¢å•
                            this._renderShopOrders();
                        } else if (targetView === 'settings') {
                            // åˆ‡æ¢åˆ°è®¾ç½®
                            this._renderMerchantSettings();
                        } else if (isCurrentView) {
                            // ç‚¹å‡»å½“å‰æ‰€åœ¨çš„æˆ‘çš„Tabï¼Œè§¦å‘åˆ·æ–°
                            this._refreshShopMy();
                        }
                    });
                });
                
                // å‘å¸ƒæŒ‰é’®
                body.querySelector('.ldsp-shop-add-btn')?.addEventListener('click', () => {
                    this._shopEditProduct = null;
                    this._renderShopForm();
                });
                
                // ç¼–è¾‘/ä¸Šä¸‹æ¶æŒ‰é’®
                body.querySelectorAll('.ldsp-shop-my-card-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const id = parseInt(btn.dataset.id);
                        const action = btn.dataset.action;
                        const product = this._shopMyProducts.find(p => p.id === id);
                        
                        if (action === 'edit' && product) {
                            this._shopEditProduct = product;
                            this._renderShopForm();
                        } else if (action === 'toggle' && product) {
                            btn.disabled = true;
                            const originalText = btn.textContent;
                            btn.textContent = 'å¤„ç†ä¸­...';
                            const isApproved = product.status === 'approved';
                            const resp = await this._toggleProductStatus(id, !isApproved, product);
                            if (resp?.success) {
                                LDSPDialog.success('æ“ä½œæˆåŠŸ');
                                this._invalidateShopCache();
                                this._renderShopMy();
                            } else {
                                btn.disabled = false;
                                btn.textContent = originalText;
                                LDSPDialog.error(this._formatError(resp));
                            }
                        } else if (action === 'manage-cdk' && product) {
                            // v2.0: CDK åº“å­˜ç®¡ç†
                            this._shopEditProduct = product;
                            this._renderCdkManager(product.id);
                        } else if (action === 'delete' && product) {
                            const confirmed = await LDSPDialog.confirm(`ç¡®å®šè¦åˆ é™¤ã€Œ${Utils.escapeHtml(product.name)}ã€å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, { title: 'åˆ é™¤ç¡®è®¤', icon: 'ğŸ—‘ï¸', danger: true });
                            if (confirmed) {
                                btn.disabled = true;
                                const originalText = btn.textContent;
                                btn.textContent = 'åˆ é™¤ä¸­...';
                                const resp = await this._deleteMyProduct(id);
                                if (resp?.success) {
                                    LDSPDialog.success('ç‰©å“å·²åˆ é™¤');
                                    this._invalidateShopCache();
                                    this._renderShopMy();
                                } else {
                                    btn.disabled = false;
                                    btn.textContent = originalText;
                                    LDSPDialog.error(this._formatError(resp));
                                }
                            }
                        }
                    });
                });
            }

            _renderShopForm() {
                const body = this._getShopBody();
                const isEdit = !!this._shopEditProduct;
                const p = this._shopEditProduct || {};
                const categories = this._shopCategories;
                
                // å•†å“ç±»å‹ï¼šlink (é»˜è®¤ï¼Œå¤–éƒ¨æ”¯ä»˜é“¾æ¥) æˆ– cdk (å¹³å°å†…æ”¯ä»˜ + è‡ªåŠ¨å‘è´§)
                const productType = p.product_type || 'link';
                const isLinkType = productType === 'link';
                
                const categoryOptions = categories.map(c => 
                    `<option value="${c.id}"${p.category_id === c.id ? ' selected' : ''}>${c.icon || 'ğŸ“¦'} ${c.name}</option>`
                ).join('');

                body.innerHTML = `
                    <div class="ldsp-shop-form">
                        <div class="ldsp-shop-form-header">
                            <button class="ldsp-shop-back-btn">â† è¿”å›</button>
                            <div class="ldsp-shop-form-title">${isEdit ? 'ç¼–è¾‘ç‰©å“' : 'å‘å¸ƒç‰©å“'}</div>
                        </div>
                        <div class="ldsp-shop-form-group">
                            <label class="ldsp-shop-form-label">ç‰©å“åç§° <span class="required">*</span></label>
                            <input type="text" class="ldsp-shop-form-input" id="shop-name" placeholder="è¯·è¾“å…¥ç‰©å“åç§°" value="${Utils.escapeHtml(p.name || '')}" maxlength="100">
                        </div>
                        <div class="ldsp-shop-form-group">
                            <label class="ldsp-shop-form-label">ç‰©å“åˆ†ç±» <span class="required">*</span></label>
                            <select class="ldsp-shop-form-select" id="shop-category">${categoryOptions}</select>
                        </div>
                        <div class="ldsp-shop-form-group">
                            <label class="ldsp-shop-form-label">ç‰©å“æè¿° <span class="required">*</span></label>
                            <textarea class="ldsp-shop-form-input ldsp-shop-form-textarea" id="shop-desc" placeholder="è¯¦ç»†æè¿°æ‚¨çš„ç‰©å“ä¿¡æ¯ä»¥åŠæœåŠ¡æ–¹å¼..." maxlength="1000">${Utils.escapeHtml(p.description || '')}</textarea>
                        </div>
                        <div class="ldsp-shop-form-row">
                            <div class="ldsp-shop-form-group">
                                <label class="ldsp-shop-form-label">ä»·æ ¼ (LDC) <span class="required">*</span></label>
                                <input type="number" class="ldsp-shop-form-input" id="shop-price" placeholder="0.00" min="0" step="0.01" value="${p.price || ''}">
                            </div>
                            <div class="ldsp-shop-form-group">
                                <label class="ldsp-shop-form-label">æŠ˜æ‰£</label>
                                <input type="number" class="ldsp-shop-form-input" id="shop-discount" placeholder="1 (æ— æŠ˜æ‰£)" min="0" max="1" step="0.01" value="${p.discount !== undefined && p.discount !== 1 ? p.discount : ''}">
                                <span class="ldsp-shop-form-hint">0-1ä¹‹é—´ï¼Œå¦‚ 0.8 è¡¨ç¤ºå…«æŠ˜</span>
                            </div>
                        </div>
                        ${!isEdit ? `
                        <div class="ldsp-shop-form-group">
                            <label class="ldsp-shop-form-label">ç‰©å“ç±»å‹ <span class="required">*</span></label>
                            <div class="ldsp-shop-form-types">
                                <label class="ldsp-shop-type-option${isLinkType ? ' active' : ''}">
                                    <input type="radio" name="shop-type" value="link" ${isLinkType ? 'checked' : ''}>
                                    <span class="ldsp-shop-type-icon">ğŸ”—</span>
                                    <span class="ldsp-shop-type-name">é“¾æ¥ç±»å‹</span>
                                    <span class="ldsp-shop-type-desc">æä¾›å¤–éƒ¨æ”¯ä»˜é“¾æ¥</span>
                                </label>
                                <label class="ldsp-shop-type-option${!isLinkType ? ' active' : ''}">
                                    <input type="radio" name="shop-type" value="cdk" ${!isLinkType ? 'checked' : ''}>
                                    <span class="ldsp-shop-type-icon">ğŸ«</span>
                                    <span class="ldsp-shop-type-name">CDK ç±»å‹</span>
                                    <span class="ldsp-shop-type-desc">å¹³å°å†…æ”¯ä»˜+è‡ªåŠ¨å‘è´§</span>
                                </label>
                            </div>
                        </div>` : ''}
                        <div class="ldsp-shop-form-group ldsp-shop-type-link${isLinkType ? '' : ' hidden'}">
                            <label class="ldsp-shop-form-label">ç§¯åˆ†æµè½¬é“¾æ¥ <span class="required">*</span></label>
                            <input type="url" class="ldsp-shop-form-input" id="shop-payment-url" placeholder="https://credit.linux.do/paying/..." value="${Utils.escapeHtml(p.payment_link || '')}">
                            <span class="ldsp-shop-form-hint ldsp-shop-form-hint-selectable">LDCç§¯åˆ†æµè½¬é“¾æ¥ï¼Œè·å–å¯å‚ç…§ï¼š<a href="https://linux.do/t/topic/1356124" target="_blank" rel="noopener">åˆ›å»ºè‡ªå·±çš„ç§¯åˆ†æµè½¬é“¾æ¥</a></span>
                        </div>
                        <div class="ldsp-shop-form-group ldsp-shop-type-cdk${!isLinkType ? '' : ' hidden'}">
                            <label class="ldsp-shop-form-label">CDK å¡å¯† <span class="ldsp-shop-form-optional">(å¯é€‰)</span></label>
                            <textarea class="ldsp-shop-form-input ldsp-shop-form-textarea" id="shop-cdk-codes" placeholder="æ¯è¡Œä¸€ä¸ª CDKï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ &#10;ç‰©å“å‘å¸ƒåä¹Ÿå¯åœ¨ã€Œæˆ‘çš„ç‰©å“ã€ä¸­ç®¡ç† CDK åº“å­˜" rows="4"></textarea>
                            <span class="ldsp-shop-form-hint">ğŸ’¡ å‘å¸ƒ CDK ç‰©å“å‰è¯·å…ˆåœ¨ã€Œæ”¶æ¬¾è®¾ç½®ã€ä¸­é…ç½® LDC æ”¶æ¬¾ä¿¡æ¯</span>
                        </div>
                        <div class="ldsp-shop-form-group">
                            <label class="ldsp-shop-form-label">ç‰©å“å›¾ç‰‡ (å¯é€‰)</label>
                            <input type="url" class="ldsp-shop-form-input" id="shop-image" placeholder="https://..." value="${Utils.escapeHtml(p.image_url || '')}">
                            <span class="ldsp-shop-form-hint">å›¾ç‰‡URLåœ°å€ï¼Œå»ºè®®ä½¿ç”¨ https é“¾æ¥</span>
                        </div>
                        <div class="ldsp-shop-form-actions">
                            <button class="ldsp-shop-form-btn secondary" data-action="cancel">å–æ¶ˆ</button>
                            <button class="ldsp-shop-form-btn primary" data-action="submit">${isEdit ? 'ä¿å­˜ä¿®æ”¹' : 'å‘å¸ƒç‰©å“'}</button>
                        </div>
                    </div>`;

                this._bindShopFormEvents(body, isEdit);
            }

            _bindShopFormEvents(body, isEdit) {
                // è¿”å›/å–æ¶ˆæŒ‰é’®
                body.querySelector('.ldsp-shop-back-btn')?.addEventListener('click', () => {
                    isEdit ? this._renderShopMy() : this._renderShopList();
                });
                body.querySelector('[data-action="cancel"]')?.addEventListener('click', () => {
                    isEdit ? this._renderShopMy() : this._renderShopList();
                });
                
                // å•†å“ç±»å‹åˆ‡æ¢ï¼ˆä»…æ–°å»ºæ—¶å¯é€‰ï¼‰
                body.querySelectorAll('input[name="shop-type"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        const type = radio.value;
                        body.querySelectorAll('.ldsp-shop-type-option').forEach(opt => {
                            opt.classList.toggle('active', opt.querySelector('input').value === type);
                        });
                        body.querySelector('.ldsp-shop-type-link')?.classList.toggle('hidden', type !== 'link');
                        body.querySelector('.ldsp-shop-type-cdk')?.classList.toggle('hidden', type !== 'cdk');
                        // æ›´æ–°æäº¤æŒ‰é’®æ–‡å­—
                        const submitBtn = body.querySelector('[data-action="submit"]');
                        if (submitBtn && !submitBtn.disabled) {
                            submitBtn.textContent = type === 'cdk' ? 'å‘å¸ƒå¹¶ä¸Šä¼ CDK' : 'å‘å¸ƒç‰©å“';
                        }
                    });
                });
                
                // æäº¤æŒ‰é’®
                body.querySelector('[data-action="submit"]')?.addEventListener('click', async () => {
                    // é˜²é‡å¤æäº¤
                    if (this._shopSubmitting) {
                        return;
                    }
                    
                    const name = body.querySelector('#shop-name')?.value?.trim();
                    const categoryIdRaw = body.querySelector('#shop-category')?.value;
                    const categoryId = categoryIdRaw ? parseInt(categoryIdRaw, 10) : null;
                    const description = body.querySelector('#shop-desc')?.value?.trim();
                    const price = parseFloat(body.querySelector('#shop-price')?.value) || 0;
                    const discount = parseFloat(body.querySelector('#shop-discount')?.value) || 1;
                    const imageUrl = body.querySelector('#shop-image')?.value?.trim();
                    
                    // v2.0: å•†å“ç±»å‹
                    const productType = isEdit ? (this._shopEditProduct?.product_type || 'link') : 
                                        (body.querySelector('input[name="shop-type"]:checked')?.value || 'link');
                    const paymentLink = body.querySelector('#shop-payment-url')?.value?.trim();

                    // å¢å¼ºéªŒè¯ï¼ˆä¸æœåŠ¡ç«¯ä¿æŒä¸€è‡´ï¼‰
                    if (!name) { LDSPDialog.warning('è¯·è¾“å…¥ç‰©å“åç§°'); return; }
                    if (name.length < 2 || name.length > 50) { LDSPDialog.warning('ç‰©å“åç§°éœ€è¦2-50ä¸ªå­—ç¬¦'); return; }
                    if (!categoryId || isNaN(categoryId)) { LDSPDialog.warning('è¯·é€‰æ‹©ç‰©å“åˆ†ç±»'); return; }
                    if (!description) { LDSPDialog.warning('è¯·è¾“å…¥ç‰©å“æè¿°'); return; }
                    if (description.length < 10 || description.length > 1000) { LDSPDialog.warning('ç‰©å“æè¿°éœ€è¦10-1000ä¸ªå­—ç¬¦'); return; }
                    if (price <= 0 || price > 99999999) { LDSPDialog.warning('è¯·è¾“å…¥æœ‰æ•ˆä»·æ ¼ï¼ˆ0-99999999ï¼‰'); return; }
                    if (discount < 0.01 || discount > 1) { LDSPDialog.warning('æŠ˜æ‰£èŒƒå›´ä¸º0.01-1'); return; }
                    
                    // æ ¹æ®å•†å“ç±»å‹éªŒè¯
                    if (productType === 'link') {
                        if (!paymentLink) { LDSPDialog.warning('è¯·è¾“å…¥ç§¯åˆ†æµè½¬é“¾æ¥'); return; }
                        if (!paymentLink.startsWith('https://credit.linux.do/')) {
                            LDSPDialog.warning('ç§¯åˆ†æµè½¬é“¾æ¥å¿…é¡»æ˜¯ credit.linux.do çš„é“¾æ¥'); return;
                        }
                    }
                    
                    // å›¾ç‰‡URLéªŒè¯ï¼ˆå¯é€‰å­—æ®µï¼‰
                    if (imageUrl && !imageUrl.startsWith('https://')) {
                        LDSPDialog.warning('å›¾ç‰‡é“¾æ¥è¯·ä½¿ç”¨ https å¼€å¤´çš„å®‰å…¨é“¾æ¥'); return;
                    }

                    // v2.0: CDK å•†å“å¯ä»¥ç›´æ¥å¡«å…¥ CDK
                    const cdkCodes = body.querySelector('#shop-cdk-codes')?.value?.trim();
                    
                    const data = { 
                        name, categoryId, description, price, discount, imageUrl,
                        productType,
                        paymentLink: productType === 'link' ? paymentLink : undefined,
                        cdkCodes: productType === 'cdk' && cdkCodes ? cdkCodes : undefined
                    };
                    
                    const btn = body.querySelector('[data-action="submit"]');
                    btn.disabled = true;
                    btn.textContent = productType === 'cdk' && cdkCodes ? 'å‘å¸ƒå¹¶ä¸Šä¼ CDK...' : 'æäº¤ä¸­...';
                    this._shopSubmitting = true;

                    let resp;
                    if (isEdit) {
                        resp = await this._updateProduct(this._shopEditProduct.id, data);
                    } else {
                        resp = await this._createProduct(data);
                    }

                    this._shopSubmitting = false;
                    if (resp?.success) {
                        this._shopEditProduct = null;
                        this._invalidateShopCache(); // æ¸…é™¤ç¼“å­˜
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        const cdkInfo = resp.data?.cdkImported ? `<br>å·²å¯¼å…¥ ${resp.data.cdkImported} æ¡ CDK` : '';
                        LDSPDialog.success(`${isEdit ? 'ç‰©å“å·²æ›´æ–°' : 'ç‰©å“æäº¤æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸'}${cdkInfo}`);
                        this._renderShopMy();
                    } else {
                        btn.disabled = false;
                        const pType = body.querySelector('input[name="shop-type"]:checked')?.value || 'link';
                        btn.textContent = isEdit ? 'ä¿å­˜ä¿®æ”¹' : (pType === 'cdk' ? 'å‘å¸ƒå¹¶ä¸Šä¼ CDK' : 'å‘å¸ƒç‰©å“');
                        LDSPDialog.error(this._formatError(resp));
                    }
                });
            }

            async _showProductDetail(product) {
                this._shopProduct = product;
                this._shopView = 'detail';
                
                // è®°å½•æµè§ˆé‡ï¼ˆé€šè¿‡è·å–è¯¦æƒ… API è‡ªåŠ¨è®°å½•ï¼‰
                this._recordProductView(product.id);
                
                const body = this._getShopBody();
                const categories = this._shopCategories;
                const cat = categories.find(c => c.id === product.category_id);
                const catIcon = product.category_icon || cat?.icon || 'ğŸ“¦';
                const catName = product.category_name || cat?.name || 'å…¶ä»–';
                
                const price = parseFloat(product.price) || 0;
                const discount = parseFloat(product.discount) || 1;
                const finalPrice = (price * discount).toFixed(2);
                const hasDiscount = discount < 1;
                const hasImg = product.image_url && product.image_url.trim();
                
                // v2.0: å•†å“ç±»å‹
                const productType = product.product_type || 'link';
                const isCdk = productType === 'cdk';
                const isStore = productType === 'store';
                const stock = parseInt(product.stock) || 0;
                const soldCount = parseInt(product.sold_count) || 0;
                const availableStock = product.availableStock !== undefined ? product.availableStock : stock;
                // æ€»åº“å­˜åº”ä½¿ç”¨å®é™… CDK æ•°é‡ï¼ˆcdkStats.totalï¼‰ï¼Œè€Œä¸æ˜¯åˆå§‹åº“å­˜å€¼
                const totalStock = product.cdkStats?.total || stock;
                const canPurchase = product.canPurchase !== false;
                const isOutOfStock = isCdk && stock !== -1 && availableStock <= 0;
                
                // æ ¼å¼åŒ–æ—¶é—´
                const createdAt = product.created_at ? new Date(product.created_at).toLocaleString('zh-CN') : 'â€”';
                const _updatedAt = product.updated_at ? new Date(product.updated_at).toLocaleString('zh-CN') : createdAt;

                // æ ¼å¼åŒ–å–å®¶å¤´åƒ
                const sellerAvatar = this._formatAvatar(product.seller_avatar, product.seller_username);
                
                // æ— å›¾ç‰‡æ—¶çš„å ä½èƒŒæ™¯
                const bgColor = this._getRandomLightColor(product.id);
                
                // å°åº—ç±»å‹ä½¿ç”¨ç‹¬ç«‹è¯¦æƒ…é¡µ
                if (isStore) {
                    const storeOwner = product.seller_username || product.seller_name || 'åº—ä¸»';
                    body.innerHTML = `
                        <div class="ldsp-shop-detail store-detail">
                            <div class="ldsp-shop-detail-header">
                                <button class="ldsp-shop-back-btn">â†</button>
                                <span class="ldsp-shop-detail-category">ğŸª å°åº—</span>
                                <span class="ldsp-shop-detail-type-badge store">ğŸ¬ å‹æƒ…å°åº—</span>
                            </div>
                            ${hasImg ? 
                                `<div class="ldsp-shop-detail-img-wrap"><img class="ldsp-shop-detail-img" src="${Utils.escapeHtml(product.image_url)}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="ldsp-shop-detail-placeholder" style="display:none;background:${bgColor}">ğŸª</div></div>` : 
                                `<div class="ldsp-shop-detail-placeholder" style="background:${bgColor}">ğŸª</div>`
                            }
                            <div class="ldsp-shop-detail-content">
                                <div class="ldsp-shop-detail-name">${Utils.escapeHtml(product.name)}</div>
                                <div class="ldsp-shop-detail-store-owner">ğŸ‘¤ åº—ä¸»ï¼š<span>${Utils.escapeHtml(storeOwner)}</span></div>
                                <div class="ldsp-shop-detail-desc store-desc">${Utils.escapeHtml(product.description || 'æš‚æ— æè¿°')}</div>
                            </div>
                            <div class="ldsp-shop-detail-info">
                                <span class="ldsp-shop-detail-info-item">ğŸ‘ ${product.view_count || 0}</span>
                                <span class="ldsp-shop-detail-info-item">ğŸ“… ${this._formatRelativeTime(product.updated_at || product.created_at)}</span>
                            </div>
                            <a href="${Utils.escapeHtml(product.payment_link || '')}" target="_blank" class="ldsp-shop-purchase-action" rel="noopener" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">ğŸª ç«‹å³å‰å¾€</a>
                        </div>`;
                    this._bindProductDetailEvents(body);
                    return;
                }
                
                // v2.0: æ ¹æ®å•†å“ç±»å‹ç”Ÿæˆè´­ä¹°æŒ‰é’®
                let purchaseButton = '';
                if (isCdk) {
                    if (isOutOfStock) {
                        purchaseButton = `<button class="ldsp-shop-purchase-action" disabled style="opacity:.5;cursor:not-allowed;background:#999!important">ğŸ˜¢ å·²å”®ç½„</button>`;
                    } else if (!canPurchase) {
                        purchaseButton = `<button class="ldsp-shop-purchase-action" disabled style="opacity:.5;cursor:not-allowed;background:#999!important">ğŸš« æš‚åœé”€å”®</button>`;
                    } else {
                        purchaseButton = `<button class="ldsp-shop-purchase-action" data-action="buy-cdk" data-product-id="${product.id}">ğŸ›’ ç«‹å³å…‘æ¢ (${finalPrice} LDC)</button>`;
                    }
                } else {
                    purchaseButton = `<a href="${Utils.escapeHtml(product.payment_link || '')}" target="_blank" class="ldsp-shop-purchase-action" rel="noopener">ğŸ›’ ç«‹å³å…‘æ¢</a>`;
                }
                
                body.innerHTML = `
                    <div class="ldsp-shop-detail">
                        <div class="ldsp-shop-detail-header">
                            <button class="ldsp-shop-back-btn">â†</button>
                            <span class="ldsp-shop-detail-category">${catIcon} ${Utils.escapeHtml(catName)}</span>
                            ${isCdk ? '<span class="ldsp-shop-detail-type-badge cdk">ğŸ« CDKè‡ªåŠ¨å‘è´§</span>' : ''}
                        </div>
                        ${hasImg ? 
                            `<div class="ldsp-shop-detail-img-wrap"><img class="ldsp-shop-detail-img" src="${Utils.escapeHtml(product.image_url)}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="ldsp-shop-detail-placeholder" style="display:none;background:${bgColor}">${catIcon}</div></div>` : 
                            `<div class="ldsp-shop-detail-placeholder" style="background:${bgColor}">${catIcon}</div>`
                        }
                        <div class="ldsp-shop-detail-content">
                            <div class="ldsp-shop-detail-name">${Utils.escapeHtml(product.name)}</div>
                            <div class="ldsp-shop-detail-desc">${Utils.escapeHtml(product.description || 'æš‚æ— æè¿°')}</div>
                        </div>
                        <div class="ldsp-shop-detail-price-row">
                            <div class="ldsp-shop-detail-price${hasDiscount ? ' discounted' : ''}">${finalPrice} <span>LDC</span></div>
                            ${hasDiscount ? `<div class="ldsp-shop-detail-original">${price.toFixed(2)}</div>` : ''}
                            ${hasDiscount ? `<div class="ldsp-shop-detail-discount-badge">-${Math.round((1 - discount) * 100)}%</div>` : ''}
                        </div>
                        <div class="ldsp-shop-detail-info">
                            <span class="ldsp-shop-detail-info-item">ğŸ‘ ${product.view_count || 0}</span>
                            ${isCdk ? `<span class="ldsp-shop-detail-info-item stock${isOutOfStock ? ' low' : ''}">ğŸ“¦ <span class="available">${stock === -1 ? 'âˆ' : availableStock}</span>/<span class="total">${stock === -1 ? 'âˆ' : totalStock}</span></span>` : ''}
                            ${isCdk && soldCount > 0 ? `<span class="ldsp-shop-detail-info-item sold">ğŸ”¥ å·²å”®${soldCount}</span>` : ''}
                            <span class="ldsp-shop-detail-info-item">ğŸ“… ${this._formatRelativeTime(product.updated_at || product.created_at)}</span>
                        </div>
                        <div class="ldsp-shop-seller" data-username="${Utils.escapeHtml(product.seller_username || '')}">
                            <img class="ldsp-shop-seller-avatar" src="${sellerAvatar}" alt="" onerror="this.style.display='none'">
                            <div class="ldsp-shop-seller-info">
                                <div class="ldsp-shop-seller-name">@${Utils.escapeHtml(product.seller_username || 'æœªçŸ¥')}</div>
                                <div class="ldsp-shop-seller-label">ç«‹å³è”ç³»æä¾›è€… ğŸ“§</div>
                            </div>
                            <span class="ldsp-shop-seller-arrow">â†’</span>
                        </div>
                        ${purchaseButton}
                    </div>`;

                this._bindProductDetailEvents(body);
            }

            _bindProductDetailEvents(body) {
                // è¿”å›æŒ‰é’®
                body.querySelector('.ldsp-shop-back-btn')?.addEventListener('click', () => {
                    this._shopProduct = null;
                    this._renderShopList();
                    // æ¢å¤æ»šåŠ¨ä½ç½®
                    if (this._shopListScrollTop) {
                        requestAnimationFrame(() => {
                            const newBody = this._getShopBody();
                            const shopContainer = newBody?.querySelector('.ldsp-shop');
                            if (shopContainer) {
                                shopContainer.scrollTop = this._shopListScrollTop;
                            } else if (newBody) {
                                newBody.scrollTop = this._shopListScrollTop;
                            }
                        });
                    }
                });
                
                // å–å®¶ç‚¹å‡»
                body.querySelector('.ldsp-shop-seller')?.addEventListener('click', () => {
                    const username = body.querySelector('.ldsp-shop-seller')?.dataset?.username;
                    if (username) {
                        window.open(`https://linux.do/u/${username}`, '_blank');
                    }
                });
                
                // v2.0: CDK è´­ä¹°æŒ‰é’®
                body.querySelector('[data-action="buy-cdk"]')?.addEventListener('click', async (e) => {
                    const btn = e.target;
                    const productId = parseInt(btn.dataset.productId);
                    if (!productId) return;
                    
                    // ç¡®è®¤è´­ä¹°
                    const product = this._shopProduct;
                    if (!product) return;
                    
                    const price = parseFloat(product.price) || 0;
                    const discount = parseFloat(product.discount) || 1;
                    const finalPrice = (price * discount).toFixed(2);
                    
                    const confirmed = await LDSPDialog.confirm(`ç¡®è®¤å…‘æ¢ã€Œ${Utils.escapeHtml(product.name)}ã€ï¼Ÿ<br><br>ğŸ’° ä»·æ ¼ï¼š<strong>${finalPrice} LDC</strong><br><br>æ”¯ä»˜åç³»ç»Ÿå°†è‡ªåŠ¨å‘æ”¾ CDK åˆ°æ‚¨çš„è®¢å•ä¸­ã€‚`, { title: 'ç¡®è®¤å…‘æ¢', icon: 'ğŸ›’' });
                    if (!confirmed) return;
                    
                    btn.disabled = true;
                    btn.textContent = 'åˆ›å»ºè®¢å•ä¸­...';
                    
                    try {
                        const resp = await this._createOrder(productId, 1);
                        if (resp?.success && resp.data?.paymentUrl) {
                            // è·³è½¬æ”¯ä»˜é¡µé¢
                            window.open(resp.data.paymentUrl, '_blank');
                            btn.textContent = 'å·²è·³è½¬æ”¯ä»˜é¡µé¢';
                            btn.style.background = '#22c55e';
                            
                            // è®¡ç®—æœ‰æ•ˆæœŸæç¤º
                            let expireHint = '';
                            if (resp.data.expireAt) {
                                expireHint = '<br>â° è®¢å•æœ‰æ•ˆæœŸ <strong>1å°æ—¶</strong>ï¼Œè¯·å°½å¿«å®Œæˆæ”¯ä»˜';
                            }
                            
                            // æç¤ºç”¨æˆ·
                            setTimeout(() => {
                                LDSPDialog.alert(`è®¢å•å·²åˆ›å»ºï¼š<strong>${resp.data.orderNo}</strong><br><br>ğŸ“ è¯·åœ¨æ–°çª—å£ä¸­å®Œæˆæ”¯ä»˜${expireHint}<br>âœ… æ”¯ä»˜å®Œæˆå CDK å°†è‡ªåŠ¨å‘æ”¾<br>ğŸ“‹ å¯åœ¨ã€Œæˆ‘çš„è®¢å•ã€ä¸­æŸ¥çœ‹çŠ¶æ€`, { title: 'è®¢å•åˆ›å»ºæˆåŠŸ', icon: 'ğŸ‰' });
                            }, 500);
                        } else {
                            btn.disabled = false;
                            btn.textContent = `ğŸ›’ ç«‹å³å…‘æ¢ (${finalPrice} LDC)`;
                            LDSPDialog.error(this._formatError(resp));
                        }
                    } catch (error) {
                        btn.disabled = false;
                        btn.textContent = `ğŸ›’ ç«‹å³å…‘æ¢ (${finalPrice} LDC)`;
                        LDSPDialog.error('åˆ›å»ºè®¢å•å¤±è´¥: ' + error.message);
                    }
                });
            }
            
            // v2.0: åˆ›å»ºè®¢å• API
            async _createOrder(productId, quantity = 1) {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: `${this._apiUrl}/api/shop/orders`,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this._token}`
                        },
                        data: JSON.stringify({ productId, quantity }),
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // ==================== v2.0: æˆ‘çš„è®¢å•åŠŸèƒ½ ====================
            // è·å–æˆ‘çš„è®¢å•åˆ—è¡¨
            async _fetchMyOrders(role = 'buyer', status = '') {
                return new Promise(resolve => {
                    let url = `${this._apiUrl}/api/shop/orders?role=${role}`;
                    if (status) url += `&status=${status}`;
                    GM_xmlhttpRequest({
                        method: 'GET',
                        url,
                        headers: { 'Authorization': `Bearer ${this._token}` },
                        onload: r => {
                            try {
                                const resp = JSON.parse(r.responseText);
                                resolve(resp?.data?.orders || []);
                            } catch { resolve([]); }
                        },
                        onerror: () => resolve([]),
                        ontimeout: () => resolve([])
                    });
                });
            }

            // è·å–è®¢å•è¯¦æƒ…
            async _fetchOrderDetail(orderNo, role = 'buyer') {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'GET',
                        url: `${this._apiUrl}/api/shop/orders/${orderNo}?role=${role}`,
                        headers: { 'Authorization': `Bearer ${this._token}` },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // å–æ¶ˆè®¢å•
            async _cancelOrder(orderNo) {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: `${this._apiUrl}/api/shop/orders/${orderNo}/cancel`,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this._token}`
                        },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // åˆ·æ–°è®¢å•æ”¯ä»˜çŠ¶æ€ï¼ˆä¸»åŠ¨æŸ¥è¯¢ LDCï¼‰
            async _refreshOrderStatus(orderNo) {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: `${this._apiUrl}/api/shop/orders/${orderNo}/refresh`,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this._token}`
                        },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // æ‰‹åŠ¨å‘è´§ (å–å®¶)
            async _deliverOrder(orderNo, content) {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: `${this._apiUrl}/api/shop/orders/${orderNo}/deliver`,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this._token}`
                        },
                        data: JSON.stringify({ content }),
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // æ¸²æŸ“æˆ‘çš„è®¢å•é¡µé¢
            async _renderShopOrders() {
                const body = this._getShopBody();
                body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                
                this._shopView = 'orders';
                this._shopOrderRole = this._shopOrderRole || 'buyer';
                this._shopOrders = await this._fetchMyOrders(this._shopOrderRole);
                
                this._renderShopOrdersUI();
            }

            // æ¸²æŸ“è®¢å•åˆ—è¡¨ UI
            _renderShopOrdersUI() {
                const body = this._getShopBody();
                const orders = this._shopOrders || [];
                const role = this._shopOrderRole || 'buyer';
                
                const statusMap = {
                    'pending': { text: 'å¾…æ”¯ä»˜', color: '#f59e0b', icon: 'â³' },
                    'paying': { text: 'æ”¯ä»˜ä¸­', color: '#3b82f6', icon: 'ğŸ’³' },
                    'paid': { text: 'å¾…å‘è´§', color: '#f97316', icon: 'ğŸ“¦' },
                    'delivered': { text: 'å·²å‘è´§', color: '#22c55e', icon: 'âœ…' },
                    'refunded': { text: 'å·²é€€æ¬¾', color: '#8b5cf6', icon: 'â†©ï¸' },
                    'expired': { text: 'å·²è¿‡æœŸ', color: '#6b7280', icon: 'âŒ›' },
                    'cancelled': { text: 'å·²å–æ¶ˆ', color: '#ef4444', icon: 'âŒ' }
                };

                const orderList = orders.length > 0 ? orders.map(o => {
                    const status = statusMap[o.status] || { text: o.status, color: '#6b7280', icon: 'ğŸ“‹' };
                    const product = o.product || {};
                    const createTime = this._formatRelativeTime(new Date(o.created_at).getTime());
                    
                    // è®¡ç®—å¾…æ”¯ä»˜è®¢å•å‰©ä½™æœ‰æ•ˆæœŸ
                    let expireHint = '';
                    if (o.status === 'pending' && o.pay_expired_at) {
                        const expireTime = new Date(o.pay_expired_at.replace(' ', 'T') + '+08:00').getTime();
                        const remaining = expireTime - Date.now();
                        if (remaining > 0) {
                            const mins = Math.floor(remaining / 60000);
                            expireHint = `<span class="ldsp-order-expire" style="font-size:10px;color:#f59e0b;margin-left:6px">â° ${mins}åˆ†é’Ÿåè¿‡æœŸ</span>`;
                        } else {
                            expireHint = `<span class="ldsp-order-expire" style="font-size:10px;color:#ef4444;margin-left:6px">âš ï¸ å³å°†è¿‡æœŸ</span>`;
                        }
                    }
                    
                    return `<div class="ldsp-order-card" data-order-no="${o.order_no}">
                        <div class="ldsp-order-card-header">
                            <span class="ldsp-order-no">è®¢å•å·: ${o.order_no}</span>
                            <span class="ldsp-order-status" style="color:${status.color}">${status.icon} ${status.text}${expireHint}</span>
                        </div>
                        <div class="ldsp-order-card-body">
                            <div class="ldsp-order-product">
                                <span class="ldsp-order-product-name">${Utils.escapeHtml(product.name || 'ç‰©å“')}</span>
                                <span class="ldsp-order-quantity">x${o.quantity || 1}</span>
                            </div>
                            <div class="ldsp-order-info">
                                <span>${role === 'buyer' ? 'å–å®¶' : 'ä¹°å®¶'}: ${Utils.escapeHtml(role === 'buyer' ? o.seller_username : o.buyer_username)}</span>
                                <span>${createTime}</span>
                            </div>
                            <div class="ldsp-order-footer">
                                <span class="ldsp-order-amount">ğŸ’° ${parseFloat(o.amount).toFixed(2)} LDC</span>
                                <div class="ldsp-order-actions">
                                    ${o.status === 'pending' && role === 'buyer' ? `<button class="ldsp-order-btn" data-action="cancel" data-order="${o.order_no}">å–æ¶ˆ</button>` : ''}
                                    ${o.status === 'paid' && role === 'seller' ? `<button class="ldsp-order-btn primary" data-action="deliver" data-order="${o.order_no}">å‘è´§</button>` : ''}
                                    ${o.status === 'delivered' && role === 'buyer' ? `<button class="ldsp-order-btn primary" data-action="view-cdk" data-order="${o.order_no}">æŸ¥çœ‹CDK</button>` : ''}
                                    <button class="ldsp-order-btn" data-action="detail" data-order="${o.order_no}">è¯¦æƒ…</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('') : '';

                body.innerHTML = `
                    <div class="ldsp-shop">
                        <div class="ldsp-shop-header">
                            <div class="ldsp-shop-tabs">
                                <div class="ldsp-shop-tab" data-view="list">ğŸª å¹¿åœº</div>
                                <div class="ldsp-shop-tab" data-view="my">ğŸ“¦ æˆ‘çš„</div>
                                <div class="ldsp-shop-tab active" data-view="orders">ğŸ“‹ è®¢å•</div>
                                <div class="ldsp-shop-tab" data-view="settings">âš™ï¸ è®¾ç½®</div>
                            </div>
                        </div>
                        <div class="ldsp-order-role-tabs">
                            <div class="ldsp-order-role-tab${role === 'buyer' ? ' active' : ''}" data-role="buyer">ğŸ›’ æˆ‘ä¹°çš„</div>
                            <div class="ldsp-order-role-tab${role === 'seller' ? ' active' : ''}" data-role="seller">ğŸ“¤ æˆ‘å–çš„</div>
                        </div>
                        ${orders.length > 0 ? `<div class="ldsp-order-list">${orderList}</div>` : 
                        `<div class="ldsp-shop-empty"><div class="ldsp-shop-empty-icon">${role === 'buyer' ? 'ğŸ›’' : 'ğŸ“¤'}</div><div class="ldsp-shop-empty-text">${role === 'buyer' ? 'æ‚¨è¿˜æ²¡æœ‰å…‘æ¢è¿‡ç‰©å“' : 'è¿˜æ²¡æœ‰äººå…‘æ¢æ‚¨çš„ç‰©å“'}</div></div>`}
                    </div>`;

                this._bindShopOrdersEvents(body);
            }

            // ç»‘å®šè®¢å•é¡µé¢äº‹ä»¶
            _bindShopOrdersEvents(body) {
                // Tab åˆ‡æ¢
                body.querySelectorAll('.ldsp-shop-tab').forEach(tab => {
                    tab.addEventListener('click', async () => {
                        const targetView = tab.dataset.view;
                        if (targetView === 'list') {
                            this._shopCategory = '';
                            this._renderShop();
                        } else if (targetView === 'my') {
                            this._renderShopMy();
                        } else if (targetView === 'orders') {
                            // ç‚¹å‡»å½“å‰æ‰€åœ¨çš„è®¢å•Tabï¼Œåˆ·æ–°åˆ—è¡¨
                            this._shopOrders = await this._fetchMyOrders(this._shopOrderRole);
                            this._renderShopOrdersUI();
                        } else if (targetView === 'settings') {
                            this._renderMerchantSettings();
                        }
                    });
                });

                // ä¹°å®¶/å–å®¶è§’è‰²åˆ‡æ¢
                body.querySelectorAll('.ldsp-order-role-tab').forEach(tab => {
                    tab.addEventListener('click', async () => {
                        const targetRole = tab.dataset.role;
                        if (targetRole !== this._shopOrderRole) {
                            this._shopOrderRole = targetRole;
                            body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                            this._shopOrders = await this._fetchMyOrders(targetRole);
                            this._renderShopOrdersUI();
                        }
                    });
                });

                // è®¢å•æ“ä½œæŒ‰é’®
                body.querySelectorAll('.ldsp-order-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const action = btn.dataset.action;
                        const orderNo = btn.dataset.order;

                        if (action === 'cancel') {
                            const confirmed = await LDSPDialog.confirm('ç¡®å®šè¦å–æ¶ˆè¯¥è®¢å•å—ï¼Ÿ', { title: 'å–æ¶ˆè®¢å•', icon: 'ğŸš«', danger: true });
                            if (confirmed) {
                                btn.disabled = true;
                                btn.textContent = 'å–æ¶ˆä¸­...';
                                const resp = await this._cancelOrder(orderNo);
                                if (resp?.success) {
                                    this._shopOrders = await this._fetchMyOrders(this._shopOrderRole);
                                    this._renderShopOrdersUI();
                                } else {
                                    btn.disabled = false;
                                    btn.textContent = 'å–æ¶ˆ';
                                    LDSPDialog.error(this._formatError(resp));
                                }
                            }
                        } else if (action === 'deliver') {
                            this._showDeliverDialog(orderNo);
                        } else if (action === 'detail' || action === 'view-cdk') {
                            this._showOrderDetail(orderNo, action === 'view-cdk');
                        }
                    });
                });
            }

            // æ˜¾ç¤ºå‘è´§å¯¹è¯æ¡†
            _showDeliverDialog(orderNo) {
                const dialog = document.createElement('div');
                dialog.className = 'ldsp-deliver-dialog-overlay';
                dialog.innerHTML = `
                    <div class="ldsp-deliver-dialog">
                        <div class="ldsp-deliver-dialog-header">
                            <span>ğŸ“¦ å‘è´§</span>
                            <button class="ldsp-deliver-dialog-close">Ã—</button>
                        </div>
                        <div class="ldsp-deliver-dialog-body">
                            <div class="ldsp-deliver-dialog-tip">è¯·è¾“å…¥éœ€è¦å‘é€ç»™ä¹°å®¶çš„å†…å®¹ï¼ˆCDKã€é“¾æ¥ã€å¯†ç ç­‰ï¼‰</div>
                            <textarea class="ldsp-deliver-dialog-input" placeholder="è¾“å…¥å‘è´§å†…å®¹..."></textarea>
                        </div>
                        <div class="ldsp-deliver-dialog-footer">
                            <button class="ldsp-deliver-dialog-btn cancel">å–æ¶ˆ</button>
                            <button class="ldsp-deliver-dialog-btn confirm">ç¡®è®¤å‘è´§</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);

                const close = () => dialog.remove();
                dialog.querySelector('.ldsp-deliver-dialog-close').addEventListener('click', close);
                dialog.querySelector('.ldsp-deliver-dialog-btn.cancel').addEventListener('click', close);
                dialog.addEventListener('click', (e) => { if (e.target === dialog) close(); });

                const confirmBtn = dialog.querySelector('.ldsp-deliver-dialog-btn.confirm');
                const textarea = dialog.querySelector('.ldsp-deliver-dialog-input');
                
                confirmBtn.addEventListener('click', async () => {
                    const content = textarea.value.trim();
                    if (!content) {
                        LDSPDialog.warning('è¯·è¾“å…¥å‘è´§å†…å®¹');
                        return;
                    }
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'å‘è´§ä¸­...';
                    const resp = await this._deliverOrder(orderNo, content);
                    if (resp?.success) {
                        close();
                        LDSPDialog.success('å‘è´§æˆåŠŸ');
                        this._shopOrders = await this._fetchMyOrders(this._shopOrderRole);
                        this._renderShopOrdersUI();
                    } else {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ç¡®è®¤å‘è´§';
                        LDSPDialog.error(this._formatError(resp));
                    }
                });

                textarea.focus();
            }

            // ========== å•†æˆ·æ”¶æ¬¾è®¾ç½® ==========
            
            // è·å–å•†æˆ·é…ç½®
            async _fetchMerchantConfig() {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'GET',
                        url: `${this._apiUrl}/api/shop/merchant/config`,
                        headers: { 'Authorization': `Bearer ${this._token}` },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // ä¿å­˜å•†æˆ·é…ç½®
            async _saveMerchantConfig(ldcPid, ldcKey) {
                console.log('[LDC] Saving merchant config...', { ldcPid: ldcPid?.substring(0, 4) + '****', hasKey: !!ldcKey, apiUrl: this._apiUrl });
                // å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œ Base64 ç¼–ç ï¼Œé¿å… Cloudflare WAF æ‹¦æˆª
                const encodedKey = btoa(ldcKey);
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: `${this._apiUrl}/api/shop/merchant/config`,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this._token}`
                        },
                        data: JSON.stringify({ ldcPid, ldcKeyEncoded: encodedKey }),
                        onload: r => {
                            try { 
                                resolve(JSON.parse(r.responseText)); 
                            } catch (e) { 
                                console.error('[LDC] Save merchant config parse error:', e, 'Status:', r.status, 'Response:', r.responseText?.substring(0, 500));
                                resolve({ success: false, error: `è§£æå“åº”å¤±è´¥ (HTTP ${r.status})` }); 
                            }
                        },
                        onerror: (e) => {
                            console.error('[LDC] Save merchant config network error:', e);
                            resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' });
                        },
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // åˆ é™¤å•†æˆ·é…ç½®
            async _deleteMerchantConfig() {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'DELETE',
                        url: `${this._apiUrl}/api/shop/merchant/config`,
                        headers: { 'Authorization': `Bearer ${this._token}` },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // æµ‹è¯• LDC å›è°ƒé…ç½®
            async _testMerchantCallback() {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: `${this._apiUrl}/api/shop/merchant/test-callback`,
                        headers: { 'Authorization': `Bearer ${this._token}` },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // æ¸²æŸ“å•†æˆ·æ”¶æ¬¾è®¾ç½®é¡µé¢
            async _renderMerchantSettings() {
                const body = this._getShopBody();
                body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                
                const resp = await this._fetchMerchantConfig();
                // è§£åŒ…åµŒå¥—çš„ data (åç«¯è¿”å› {success, data: {success, data: {...}}})
                const config = resp?.data?.data || resp?.data || {};
                const stats = config.stats || {};
                const isConfigured = !!config.configured;
                
                body.innerHTML = `
                    <div class="ldsp-shop">
                        <div class="ldsp-shop-header">
                            <div class="ldsp-shop-tabs">
                                <div class="ldsp-shop-tab" data-view="list">ğŸª å¹¿åœº</div>
                                <div class="ldsp-shop-tab" data-view="my">ğŸ“¦ æˆ‘çš„</div>
                                <div class="ldsp-shop-tab" data-view="orders">ğŸ“‹ è®¢å•</div>
                                <div class="ldsp-shop-tab active" data-view="settings">âš™ï¸ è®¾ç½®</div>
                            </div>
                        </div>
                        
                        ${isConfigured ? `
                        <div class="ldsp-merchant-stats-card">
                            <div class="ldsp-merchant-stats-title">ğŸ“Š CDKåˆ†å‘æ”¶å…¥ç»Ÿè®¡</div>
                            <div class="ldsp-merchant-stats-grid">
                                <div class="ldsp-merchant-stat">
                                    <div class="ldsp-merchant-stat-value">${stats.totalOrders || 0}</div>
                                    <div class="ldsp-merchant-stat-label">æ€»è®¢å•</div>
                                </div>
                                <div class="ldsp-merchant-stat">
                                    <div class="ldsp-merchant-stat-value">${parseFloat(stats.totalRevenue || 0).toFixed(2)}</div>
                                    <div class="ldsp-merchant-stat-label">æ€»æ”¶å…¥ (LDC)</div>
                                </div>
                                <div class="ldsp-merchant-stat">
                                    <div class="ldsp-merchant-stat-value">${stats.thisMonthOrders || 0}</div>
                                    <div class="ldsp-merchant-stat-label">æœ¬æœˆè®¢å•</div>
                                </div>
                                <div class="ldsp-merchant-stat">
                                    <div class="ldsp-merchant-stat-value">${parseFloat(stats.thisMonthRevenue || 0).toFixed(2)}</div>
                                    <div class="ldsp-merchant-stat-label">æœ¬æœˆæ”¶å…¥ (LDC)</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="ldsp-merchant-config-card">
                            <div class="ldsp-merchant-config-header">
                                <div class="ldsp-merchant-config-title">ğŸ’³ LDC æ”¶æ¬¾é…ç½®</div>
                                ${isConfigured ? `
                                <div class="ldsp-merchant-config-status">
                                    <span class="ldsp-merchant-badge ${config.isVerified ? 'verified' : 'pending'}">${config.isVerified ? 'âœ“ å·²éªŒè¯' : 'â³ å¾…éªŒè¯'}</span>
                                    <span class="ldsp-merchant-badge ${config.isActive ? 'active' : 'inactive'}">${config.isActive ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            ${!isConfigured ? `
                            <div class="ldsp-merchant-config-tip">
                                ğŸ’¡ é…ç½® LDC æ”¶æ¬¾åï¼Œæ‚¨å‘å¸ƒçš„ CDK ç‰©å“å¯æ”¯æŒå¹³å°å†…æ”¯ä»˜å’Œè‡ªåŠ¨å‘è´§ã€‚
                            </div>
                            ` : ''}
                            
                            <div class="ldsp-merchant-form-group">
                                <label class="ldsp-merchant-form-label">Client ID (PID)</label>
                                <input type="text" class="ldsp-merchant-form-input" id="merchant-pid" 
                                    value="${isConfigured ? Utils.escapeHtml(config.ldcPid || '') : ''}"
                                    placeholder="${isConfigured ? '' : 'è¯·è¾“å…¥æ‚¨çš„ LDC Client ID'}"
                                    ${isConfigured ? 'disabled' : ''}>
                            </div>
                            <div class="ldsp-merchant-form-group">
                                <label class="ldsp-merchant-form-label">Client Key</label>
                                <input type="password" class="ldsp-merchant-form-input" id="merchant-key" 
                                    value="${isConfigured ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : ''}"
                                    placeholder="${isConfigured ? '' : 'è¯·è¾“å…¥æ‚¨çš„ LDC Client Key'}"
                                    ${isConfigured ? 'disabled' : ''}>
                                <div class="ldsp-merchant-form-hint">${isConfigured ? 'å¯†é’¥å·²å®‰å…¨å­˜å‚¨ï¼Œä¿®æ”¹æ—¶éœ€é‡æ–°è¾“å…¥' : 'å¯†é’¥å°†å®‰å…¨åŠ å¯†å­˜å‚¨ï¼Œä¸ä¼šæ˜æ–‡æ˜¾ç¤º'}</div>
                            </div>
                            
                            <div class="ldsp-merchant-form-actions">
                                ${isConfigured ? `
                                <button class="ldsp-merchant-edit-btn" id="merchant-edit-btn">âœï¸ ç¼–è¾‘é…ç½®</button>
                                <button class="ldsp-merchant-test-btn" id="merchant-test-btn">ğŸ”” æµ‹è¯•é€šçŸ¥</button>
                                <button class="ldsp-merchant-save-btn" id="merchant-save-btn" style="display:none">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                <button class="ldsp-merchant-cancel-btn" id="merchant-cancel-btn" style="display:none">å–æ¶ˆ</button>
                                <button class="ldsp-merchant-delete-btn">ğŸ—‘ï¸ åˆ é™¤é…ç½®</button>
                                ` : `
                                <button class="ldsp-merchant-save-btn">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                `}
                            </div>
                        </div>
                        
                        <div class="ldsp-merchant-help-card">
                            <div class="ldsp-merchant-help-title">â“ å¦‚ä½•è·å– LDC æ”¶æ¬¾å‡­è¯</div>
                            <div class="ldsp-merchant-help-content">
                                <p>1. è®¿é—® <a href="https://credit.linux.do/merchant" target="_blank" rel="noopener">LDC é›†å¸‚</a></p>
                                <p>2. åˆ›å»ºæ–°åº”ç”¨ï¼Œé…ç½®ä»¥ä¸‹åœ°å€ï¼š</p>
                                <p style="margin-top:6px">âš ï¸ <b>é€šçŸ¥åœ°å€</b>ï¼ˆnotify_urlï¼ŒæœåŠ¡å™¨å¼‚æ­¥é€šçŸ¥ï¼Œå¿…å¡«ï¼‰ï¼š</p>
                                <p style="margin-left:12px;font-family:monospace;font-size:11px;color:#3b82f6;word-break:break-all">https://api.ldspro.qzz.io/api/shop/ldc/notify</p>
                                <p style="margin-top:6px">âš ï¸ <b>å›è°ƒåœ°å€</b>ï¼ˆreturn_urlï¼Œæ”¯ä»˜åæµè§ˆå™¨è·³è½¬ï¼‰ï¼š</p>
                                <p style="margin-left:12px;font-family:monospace;font-size:11px;color:#3b82f6;word-break:break-all">https://api.ldspro.qzz.io/api/shop/ldc/return</p>
                                <p style="margin-top:8px">3. åœ¨åº”ç”¨è¯¦æƒ…é¡µè·å– Client ID å’Œ Client Key</p>
                                <p>4. å¡«å†™åˆ°ä¸Šæ–¹é…ç½®è¡¨å•å¹¶ä¿å­˜</p>
                                <p style="margin-top:8px;font-size:11px;color:#94a3b8">ğŸ’¡ æç¤ºï¼š<b style="color:#ef4444">é€šçŸ¥åœ°å€</b>æ˜¯æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å‘è´§çš„å…³é”®ï¼Œè¯·åŠ¡å¿…æ­£ç¡®é…ç½®</p>
                            </div>
                        </div>
                    </div>
                `;
                
                this._bindMerchantSettingsEvents(body, isConfigured, config);
            }

            // ç»‘å®šå•†æˆ·è®¾ç½®äº‹ä»¶
            _bindMerchantSettingsEvents(body, isConfigured, config) {
                // Tab åˆ‡æ¢
                body.querySelectorAll('.ldsp-shop-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetView = tab.dataset.view;
                        if (targetView === 'list') {
                            this._shopCategory = '';
                            this._renderShop();
                        } else if (targetView === 'my') {
                            this._renderShopMy();
                        } else if (targetView === 'orders') {
                            this._renderShopOrders();
                        }
                        // ç‚¹å‡»å½“å‰è®¾ç½®Tabä¸åšä»»ä½•æ“ä½œ
                    });
                });
                
                // ç¼–è¾‘é…ç½®æŒ‰é’®ï¼ˆä»…å·²é…ç½®æ—¶æ˜¾ç¤ºï¼‰
                const editBtn = body.querySelector('#merchant-edit-btn');
                const saveBtn = body.querySelector('#merchant-save-btn');
                const cancelBtn = body.querySelector('#merchant-cancel-btn');
                const pidInput = body.querySelector('#merchant-pid');
                const keyInput = body.querySelector('#merchant-key');
                
                editBtn?.addEventListener('click', () => {
                    // å¯ç”¨è¾“å…¥æ¡†ï¼Œåˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                    pidInput.disabled = false;
                    keyInput.disabled = false;
                    keyInput.value = ''; // æ¸…ç©ºå¯†é’¥ï¼Œéœ€è¦é‡æ–°è¾“å…¥
                    keyInput.placeholder = 'è¯·é‡æ–°è¾“å…¥ Client Key';
                    editBtn.style.display = 'none';
                    saveBtn.style.display = '';
                    cancelBtn.style.display = '';
                    body.querySelector('.ldsp-merchant-delete-btn').style.display = 'none';
                    pidInput.focus();
                });
                
                // å–æ¶ˆç¼–è¾‘æŒ‰é’®
                cancelBtn?.addEventListener('click', () => {
                    // æ¢å¤åŸçŠ¶æ€
                    this._renderMerchantSettings();
                });
                
                // ä¿å­˜é…ç½®
                body.querySelector('.ldsp-merchant-save-btn')?.addEventListener('click', async () => {
                    const pid = pidInput?.value?.trim();
                    const key = keyInput?.value?.trim();
                    
                    if (!pid || !key) {
                        LDSPDialog.warning('è¯·å¡«å†™å®Œæ•´çš„ Client ID å’Œ Client Key');
                        return;
                    }
                    
                    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”å¯†é’¥æ˜¯å ä½ç¬¦ï¼Œéœ€è¦é‡æ–°è¾“å…¥
                    if (isConfigured && key === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
                        LDSPDialog.warning('è¯·é‡æ–°è¾“å…¥ Client Key');
                        keyInput.focus();
                        return;
                    }
                    
                    const btn = body.querySelector('.ldsp-merchant-save-btn');
                    btn.disabled = true;
                    btn.textContent = 'éªŒè¯ä¸­...';
                    
                    const resp = await this._saveMerchantConfig(pid, key);
                    if (resp?.success) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒè­¦å‘Š
                        const data = resp?.data || resp;
                        if (data.callbackWarning) {
                            LDSPDialog.warning(`é…ç½®å·²ä¿å­˜ï¼Œä½†é€šçŸ¥åœ°å€éªŒè¯æœ‰è­¦å‘Šï¼š<br><br>${Utils.escapeHtml(data.callbackWarning)}<br><br>è¯·ç¡®ä¿ LDC åå°çš„é€šçŸ¥åœ°å€è®¾ç½®ä¸ºï¼š<br><code style="font-size:11px;background:#333;padding:2px 6px;border-radius:3px">${Utils.escapeHtml(data.expectedNotifyUrl)}</code>`);
                        } else {
                            LDSPDialog.success('é…ç½®ä¿å­˜æˆåŠŸ');
                        }
                        this._renderMerchantSettings();
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'ğŸ’¾ ä¿å­˜é…ç½®';
                        LDSPDialog.error(this._formatError(resp));
                    }
                });
                
                // æµ‹è¯•é€šçŸ¥æŒ‰é’®
                body.querySelector('#merchant-test-btn')?.addEventListener('click', async () => {
                    const btn = body.querySelector('#merchant-test-btn');
                    btn.disabled = true;
                    btn.textContent = 'æµ‹è¯•ä¸­...';
                    
                    const resp = await this._testMerchantCallback();
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”” æµ‹è¯•é€šçŸ¥';
                    
                    if (resp?.success) {
                        const data = resp?.data || resp;
                        const testData = data.data || data;
                        if (testData.status === 'ok') {
                            LDSPDialog.success(`âœ… é€šçŸ¥æµ‹è¯•æˆåŠŸï¼<br><br>æ‚¨çš„é€šçŸ¥åœ°å€é…ç½®æ­£ç¡®ï¼š<br><code style="font-size:11px;background:#333;padding:2px 6px;border-radius:3px">${Utils.escapeHtml(testData.notifyUrl)}</code>`);
                        } else {
                            LDSPDialog.warning(`âš ï¸ ${Utils.escapeHtml(data.message || 'é€šçŸ¥æµ‹è¯•å®Œæˆ')}<br><br>è¯·ç¡®ä¿ LDC åå°çš„é€šçŸ¥åœ°å€è®¾ç½®æ­£ç¡®ï¼š<br><code style="font-size:11px;background:#333;padding:2px 6px;border-radius:3px">${Utils.escapeHtml(testData.notifyUrl)}</code>${testData.hint ? '<br><br>ğŸ’¡ ' + Utils.escapeHtml(testData.hint) : ''}`);
                        }
                    } else {
                        LDSPDialog.error(this._formatError(resp));
                    }
                });

                // åˆ é™¤é…ç½®
                body.querySelector('.ldsp-merchant-delete-btn')?.addEventListener('click', async () => {
                    const confirmed = await LDSPDialog.confirm('ç¡®å®šè¦åˆ é™¤æ”¶æ¬¾é…ç½®å—ï¼Ÿ<br><br>åˆ é™¤åæ‚¨çš„ CDK ç‰©å“å°†æ— æ³•è¿›è¡Œå¹³å°å†…æ”¯ä»˜ã€‚', { title: 'åˆ é™¤é…ç½®', icon: 'âš ï¸', danger: true });
                    if (!confirmed) return;
                    
                    const btn = body.querySelector('.ldsp-merchant-delete-btn');
                    btn.disabled = true;
                    btn.textContent = 'åˆ é™¤ä¸­...';
                    
                    const resp = await this._deleteMerchantConfig();
                    if (resp?.success) {
                        LDSPDialog.success('é…ç½®å·²åˆ é™¤');
                        this._renderMerchantSettings();
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'ğŸ—‘ï¸ åˆ é™¤é…ç½®';
                        LDSPDialog.error(this._formatError(resp));
                    }
                });
            }

            // ========== CDK åº“å­˜ç®¡ç† ==========
            
            // è·å– CDK åˆ—è¡¨
            async _fetchCdkList(productId, options = {}) {
                return new Promise(resolve => {
                    let url = `${this._apiUrl}/api/shop/products/${productId}/cdk?page=${options.page || 1}`;
                    if (options.status && options.status !== 'all') url += `&status=${options.status}`;
                    if (options.batchNo) url += `&batchNo=${options.batchNo}`;
                    GM_xmlhttpRequest({
                        method: 'GET',
                        url,
                        headers: { 'Authorization': `Bearer ${this._token}` },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // ä¸Šä¼  CDK
            async _uploadCdk(productId, codes, remark = '') {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: `${this._apiUrl}/api/shop/products/${productId}/cdk`,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this._token}`
                        },
                        data: JSON.stringify({ codes, remark }),
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // åˆ é™¤ CDK
            async _deleteCdk(productId, cdkId) {
                return new Promise(resolve => {
                    GM_xmlhttpRequest({
                        method: 'DELETE',
                        url: `${this._apiUrl}/api/shop/products/${productId}/cdk/${cdkId}`,
                        headers: { 'Authorization': `Bearer ${this._token}` },
                        onload: r => {
                            try { resolve(JSON.parse(r.responseText)); }
                            catch { resolve({ success: false, error: 'è§£æå“åº”å¤±è´¥' }); }
                        },
                        onerror: () => resolve({ success: false, error: 'ç½‘ç»œé”™è¯¯' }),
                        ontimeout: () => resolve({ success: false, error: 'è¯·æ±‚è¶…æ—¶' })
                    });
                });
            }

            // æ¸²æŸ“ CDK ç®¡ç†é¡µé¢
            async _renderCdkManager(productId) {
                const body = this._getShopBody();
                body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                
                // ä¿ç•™ç­›é€‰å’Œåˆ†é¡µçŠ¶æ€ï¼Œé™¤éæ˜¯é¦–æ¬¡è¿›å…¥
                if (!this._cdkState || this._cdkState.productId !== productId) {
                    this._cdkState = { productId, page: 1, status: 'all' };
                }
                
                const resp = await this._fetchCdkList(productId, {
                    page: this._cdkState.page,
                    status: this._cdkState.status
                });
                if (!resp?.success) {
                    LDSPDialog.error(this._formatError(resp));
                    this._renderShopMy();
                    return;
                }
                
                const data = resp.data || {};
                const cdks = data.cdks || [];
                const stats = data.stats || {};
                const pagination = data.pagination || {};
                const product = this._shopEditProduct || {};
                const currentStatus = this._cdkState.status || 'all';
                
                body.innerHTML = `
                    <div class="ldsp-cdk-manager">
                        <div class="ldsp-cdk-manager-header">
                            <button class="ldsp-order-back-btn">â† è¿”å›</button>
                            <span>CDK åº“å­˜ç®¡ç† - ${Utils.escapeHtml(product.name || '')}</span>
                        </div>
                        
                        <div class="ldsp-cdk-stats-grid">
                            <div class="ldsp-cdk-stat available">
                                <div class="ldsp-cdk-stat-value">${stats.available || 0}</div>
                                <div class="ldsp-cdk-stat-label">å¯ç”¨</div>
                            </div>
                            <div class="ldsp-cdk-stat locked">
                                <div class="ldsp-cdk-stat-value">${stats.locked || 0}</div>
                                <div class="ldsp-cdk-stat-label">é”å®š</div>
                            </div>
                            <div class="ldsp-cdk-stat sold">
                                <div class="ldsp-cdk-stat-value">${stats.sold || 0}</div>
                                <div class="ldsp-cdk-stat-label">å·²å”®</div>
                            </div>
                            <div class="ldsp-cdk-stat total">
                                <div class="ldsp-cdk-stat-value">${stats.total || 0}</div>
                                <div class="ldsp-cdk-stat-label">æ€»è®¡</div>
                            </div>
                        </div>
                        
                        <div class="ldsp-cdk-upload-section">
                            <div class="ldsp-cdk-upload-title">ğŸ“¤ æ‰¹é‡ä¸Šä¼  CDK</div>
                            <textarea class="ldsp-cdk-upload-input" id="cdk-upload-codes" placeholder="æ¯è¡Œä¸€ä¸ªCDKï¼Œè‡ªåŠ¨å»é‡å»ç©ºè¡Œ"></textarea>
                            <div class="ldsp-cdk-upload-footer">
                                <input type="text" class="ldsp-cdk-upload-remark" id="cdk-upload-remark" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
                                <button class="ldsp-cdk-upload-btn">ä¸Šä¼ </button>
                            </div>
                        </div>
                        
                        <div class="ldsp-shop-cdk-mgr-section">
                            <div class="ldsp-shop-cdk-mgr-header">
                                <span>ğŸ“‹ CDK åˆ—è¡¨</span>
                                <div class="ldsp-shop-cdk-mgr-filter-wrap">
                                    <select class="ldsp-shop-cdk-mgr-filter" id="cdk-filter-status">
                                        <option value="all"${currentStatus === 'all' ? ' selected' : ''}>å…¨éƒ¨</option>
                                        <option value="available"${currentStatus === 'available' ? ' selected' : ''}>å¯ç”¨</option>
                                        <option value="locked"${currentStatus === 'locked' ? ' selected' : ''}>é”å®š</option>
                                        <option value="sold"${currentStatus === 'sold' ? ' selected' : ''}>å·²å”®</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${cdks.length > 0 ? `
                            <div class="ldsp-shop-cdk-mgr-list">
                                ${cdks.map(c => `
                                    <div class="ldsp-shop-cdk-mgr-item" data-id="${c.id}">
                                        <div class="ldsp-shop-cdk-mgr-code" title="${Utils.escapeHtml(c.code)}">${Utils.escapeHtml(c.code)}</div>
                                        <div class="ldsp-shop-cdk-mgr-meta">
                                            <span class="ldsp-shop-cdk-mgr-status ${c.status}">${c.status === 'available' ? 'âœ“ å¯ç”¨' : c.status === 'locked' ? 'â³ é”å®š' : 'âœ— å·²å”®'}</span>
                                            ${c.remark ? `<span class="ldsp-shop-cdk-mgr-remark" title="${Utils.escapeHtml(c.remark)}">${Utils.escapeHtml(c.remark)}</span>` : ''}
                                        </div>
                                        <div class="ldsp-shop-cdk-mgr-actions">
                                            <button class="ldsp-shop-cdk-mgr-copy" data-code="${Utils.escapeHtml(c.code)}" title="å¤åˆ¶CDK">ğŸ“‹</button>
                                            ${c.status === 'available' ? `<button class="ldsp-shop-cdk-mgr-delete" data-id="${c.id}" title="åˆ é™¤æ­¤CDK">Ã—</button>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${pagination.totalPages > 1 ? `
                            <div class="ldsp-shop-cdk-mgr-pagination">
                                <span>ç¬¬ ${pagination.page} / ${pagination.totalPages} é¡µ</span>
                                <div class="ldsp-shop-cdk-mgr-pagination-btns">
                                    <button class="ldsp-shop-cdk-mgr-page-btn" data-page="${pagination.page - 1}" ${pagination.page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                                    <button class="ldsp-shop-cdk-mgr-page-btn" data-page="${pagination.page + 1}" ${pagination.page >= pagination.totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                                </div>
                            </div>
                            ` : ''}
                            ` : `
                            <div class="ldsp-shop-cdk-mgr-empty">
                                <div class="ldsp-shop-cdk-mgr-empty-icon">ğŸ“¦</div>
                                <div class="ldsp-shop-cdk-mgr-empty-text">æš‚æ—  CDK</div>
                                <div class="ldsp-shop-cdk-mgr-empty-hint">åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­æ·»åŠ  CDK</div>
                            </div>
                            `}
                        </div>
                    </div>
                `;
                
                this._bindCdkManagerEvents(body, productId);
            }

            // ç»‘å®š CDK ç®¡ç†äº‹ä»¶
            _bindCdkManagerEvents(body, productId) {
                // è¿”å›æŒ‰é’®
                body.querySelector('.ldsp-order-back-btn')?.addEventListener('click', () => {
                    this._renderShopMy();
                });
                
                // ä¸Šä¼  CDK
                body.querySelector('.ldsp-cdk-upload-btn')?.addEventListener('click', async () => {
                    const codesInput = body.querySelector('#cdk-upload-codes');
                    const remarkInput = body.querySelector('#cdk-upload-remark');
                    const codes = codesInput?.value?.trim();
                    const remark = remarkInput?.value?.trim();
                    
                    if (!codes) {
                        LDSPDialog.warning('è¯·è¾“å…¥ CDK');
                        return;
                    }
                    
                    const btn = body.querySelector('.ldsp-cdk-upload-btn');
                    btn.disabled = true;
                    btn.textContent = 'ä¸Šä¼ ä¸­...';
                    
                    const resp = await this._uploadCdk(productId, codes, remark);
                    if (resp?.success) {
                        const data = resp.data || {};
                        LDSPDialog.success(`ä¸Šä¼ æˆåŠŸï¼<br>ğŸ“¥ å¯¼å…¥: ${data.imported || 0} æ¡<br>ğŸ”„ é‡å¤è·³è¿‡: ${data.duplicates || 0} æ¡<br>ğŸ“¦ å½“å‰åº“å­˜: ${data.stock || 0} æ¡`);
                        this._renderCdkManager(productId);
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'ä¸Šä¼ ';
                        LDSPDialog.error(this._formatError(resp));
                    }
                });
                
                // çŠ¶æ€ç­›é€‰
                body.querySelector('#cdk-filter-status')?.addEventListener('change', async (e) => {
                    this._cdkState.status = e.target.value;
                    this._cdkState.page = 1;
                    this._renderCdkManager(productId);
                });
                
                // åˆ†é¡µ
                body.querySelectorAll('.ldsp-shop-cdk-mgr-page-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const page = parseInt(btn.dataset.page);
                        if (page && !btn.disabled) {
                            this._cdkState.page = page;
                            this._renderCdkManager(productId);
                        }
                    });
                });
                
                // å¤åˆ¶å•ä¸ª CDK
                body.querySelectorAll('.ldsp-shop-cdk-mgr-copy').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const code = btn.dataset.code;
                        if (!code) return;
                        
                        const doCopy = () => {
                            btn.classList.add('copied');
                            btn.textContent = 'âœ“';
                            setTimeout(() => {
                                btn.classList.remove('copied');
                                btn.textContent = 'ğŸ“‹';
                            }, 1500);
                        };
                        
                        if (navigator.clipboard?.writeText) {
                            try {
                                await navigator.clipboard.writeText(code);
                                doCopy();
                            } catch {
                                // é™çº§æ–¹æ¡ˆ
                                const textarea = document.createElement('textarea');
                                textarea.value = code;
                                textarea.style.cssText = 'position:fixed;left:-9999px';
                                document.body.appendChild(textarea);
                                textarea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textarea);
                                doCopy();
                            }
                        } else {
                            // é™çº§æ–¹æ¡ˆ
                            const textarea = document.createElement('textarea');
                            textarea.value = code;
                            textarea.style.cssText = 'position:fixed;left:-9999px';
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            doCopy();
                        }
                    });
                });
                
                // åˆ é™¤å•ä¸ª CDK
                body.querySelectorAll('.ldsp-shop-cdk-mgr-delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const cdkId = parseInt(btn.dataset.id);
                        const confirmed = await LDSPDialog.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª CDK å—ï¼Ÿ', { title: 'åˆ é™¤ CDK', icon: 'ğŸ—‘ï¸', danger: true });
                        if (confirmed) {
                            btn.disabled = true;
                            const resp = await this._deleteCdk(productId, cdkId);
                            if (resp?.success) {
                                this._renderCdkManager(productId);
                            } else {
                                btn.disabled = false;
                                LDSPDialog.error(this._formatError(resp));
                            }
                        }
                    });
                });
            }

            // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
            async _showOrderDetail(orderNo, showCdk = false) {
                const body = this._getShopBody();
                body.innerHTML = `<div class="ldsp-ldc-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;

                // ä½¿ç”¨å½“å‰è§’è‰²è·å–è®¢å•è¯¦æƒ…
                const role = this._shopOrderRole || 'buyer';
                const resp = await this._fetchOrderDetail(orderNo, role);
                if (!resp?.success || !resp?.data?.order) {
                    LDSPDialog.error(this._formatError(resp));
                    this._renderShopOrdersUI();
                    return;
                }

                const order = resp.data.order;
                const logs = resp.data.logs || [];
                const product = order.product || {};
                const statusMap = {
                    'pending': { text: 'å¾…æ”¯ä»˜', color: '#f59e0b', icon: 'â³' },
                    'paying': { text: 'æ”¯ä»˜ä¸­', color: '#3b82f6', icon: 'ğŸ’³' },
                    'paid': { text: 'å¾…å‘è´§', color: '#f97316', icon: 'ğŸ“¦' },
                    'delivered': { text: 'å·²å®Œæˆ', color: '#22c55e', icon: 'âœ…' },
                    'refunded': { text: 'å·²é€€æ¬¾', color: '#8b5cf6', icon: 'â†©ï¸' },
                    'expired': { text: 'å·²è¿‡æœŸ', color: '#6b7280', icon: 'âŒ›' },
                    'cancelled': { text: 'å·²å–æ¶ˆ', color: '#ef4444', icon: 'âŒ' }
                };
                const status = statusMap[order.status] || { text: order.status, color: '#6b7280', icon: 'ğŸ“‹' };
                const fmtDate = (d) => d ? new Date(d).toLocaleString('zh-CN', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';

                body.innerHTML = `
                    <div class="ldsp-order-detail">
                        <div class="ldsp-order-detail-header">
                            <button class="ldsp-order-back-btn">â†</button>
                            <span>è®¢å•è¯¦æƒ…</span>
                            <div style="width:32px"></div>
                        </div>
                        <div class="ldsp-order-detail-status" style="background:${status.color}12;border-color:${status.color}40">
                            <span style="color:${status.color}">${status.icon} ${status.text}</span>
                        </div>
                        <div class="ldsp-order-detail-card">
                            <div class="ldsp-order-detail-row"><span class="label">è®¢å•å·</span><span class="value mono" title="${order.order_no}">${order.order_no}</span></div>
                            <div class="ldsp-order-detail-row"><span class="label">å•†å“</span><span class="value" title="${Utils.escapeHtml(product.name || '-')}">${Utils.escapeHtml(product.name || '-')}</span></div>
                            <div class="ldsp-order-detail-row"><span class="label">æ•°é‡</span><span class="value">${order.quantity || 1}</span></div>
                            <div class="ldsp-order-detail-row"><span class="label">é‡‘é¢</span><span class="value price">${parseFloat(order.amount).toFixed(2)} LDC</span></div>
                            <div class="ldsp-order-detail-row"><span class="label">${role === 'buyer' ? 'å–å®¶' : 'ä¹°å®¶'}</span><span class="value">${Utils.escapeHtml(role === 'buyer' ? order.seller_username : order.buyer_username)}</span></div>
                            <div class="ldsp-order-detail-row"><span class="label">ä¸‹å•</span><span class="value">${fmtDate(order.created_at)}</span></div>
                            ${order.paid_at ? `<div class="ldsp-order-detail-row"><span class="label">æ”¯ä»˜</span><span class="value">${fmtDate(order.paid_at)}</span></div>` : ''}
                            ${order.delivered_at ? `<div class="ldsp-order-detail-row"><span class="label">å‘è´§</span><span class="value">${fmtDate(order.delivered_at)}</span></div>` : ''}
                        </div>
                        ${order.status === 'pending' && role === 'buyer' ? (() => {
                            // è®¡ç®—å¾…æ”¯ä»˜è®¢å•å‰©ä½™æœ‰æ•ˆæœŸ
                            let expireInfo = '';
                            if (order.pay_expired_at) {
                                const expireTime = new Date(order.pay_expired_at.replace(' ', 'T') + '+08:00').getTime();
                                const remaining = expireTime - Date.now();
                                if (remaining > 0) {
                                    const mins = Math.floor(remaining / 60000);
                                    const secs = Math.floor((remaining % 60000) / 1000);
                                    expireInfo = `<div style="font-size:11px;color:#f59e0b;font-weight:600;margin-bottom:6px">â° å‰©ä½™æ”¯ä»˜æ—¶é—´ï¼š${mins}åˆ†${secs}ç§’</div>`;
                                } else {
                                    expireInfo = `<div style="font-size:11px;color:#ef4444;font-weight:600;margin-bottom:6px">âš ï¸ è®¢å•å³å°†è¿‡æœŸï¼Œè¯·å°½å¿«æ”¯ä»˜</div>`;
                                }
                            }
                            return `
                            <div class="ldsp-order-pending-notice" style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:var(--r-md);padding:10px 12px">
                                ${expireInfo}
                                <div style="display:flex;align-items:center;gap:8px">
                                    <div style="font-size:9px;color:var(--txt-sec);line-height:1.4;flex:1">å·²æ”¯ä»˜ï¼Ÿç‚¹å‡»åˆ·æ–°æŸ¥è¯¢è®¢å•çŠ¶æ€</div>
                                    <button class="ldsp-order-refresh-btn" data-order="${order.order_no}" style="padding:5px 10px;background:#f59e0b;color:#fff;border:none;border-radius:var(--r-sm);font-size:9px;font-weight:600;cursor:pointer;white-space:nowrap">ğŸ”„ åˆ·æ–°</button>
                                </div>
                            </div>
                        `;
                        })() : ''}
                        ${order.status === 'delivered' && order.deliveryContent ? `
                            <div class="ldsp-order-cdk-section">
                                <div class="ldsp-order-cdk-title">${role === 'buyer' ? 'ğŸ« æ‚¨è´­ä¹°çš„ CDK' : 'ğŸ“¤ å·²å‘è´§å†…å®¹'}</div>
                                <div class="ldsp-order-cdk-content">${Utils.escapeHtml(order.deliveryContent)}</div>
                                <div class="ldsp-order-cdk-actions">
                                    <button class="ldsp-order-cdk-btn" data-action="copy" data-content="${Utils.escapeHtml(order.deliveryContent)}">ğŸ“‹ ä¸€é”®å¤åˆ¶</button>
                                </div>
                            </div>
                        ` : ''}
                        ${logs.length > 0 ? `
                            <div class="ldsp-order-logs">
                                <div class="ldsp-order-logs-title">ğŸ“‹ è®¢å•è®°å½•</div>
                                ${logs.slice(0, 5).map(log => `
                                    <div class="ldsp-order-log-item">
                                        <span class="ldsp-order-log-action">${Utils.escapeHtml(log.action)}</span>
                                        <span class="ldsp-order-log-time">${fmtDate(log.created_at)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>`;

                // è¿”å›æŒ‰é’®
                body.querySelector('.ldsp-order-back-btn')?.addEventListener('click', () => {
                    this._renderShopOrdersUI();
                });

                // åˆ·æ–°æ”¯ä»˜çŠ¶æ€æŒ‰é’®
                body.querySelector('.ldsp-order-refresh-btn')?.addEventListener('click', async (e) => {
                    const btn = e.target;
                    const orderNo = btn.dataset.order;
                    
                    btn.disabled = true;
                    btn.textContent = 'â³ æŸ¥è¯¢ä¸­...';
                    
                    const resp = await this._refreshOrderStatus(orderNo);
                    
                    if (resp?.success) {
                        if (resp.data?.status === 'delivered') {
                            alert('âœ… æ”¯ä»˜æˆåŠŸï¼Œå·²è‡ªåŠ¨å‘è´§ï¼');
                            this._showOrderDetail(orderNo, true); // åˆ·æ–°é¡µé¢æ˜¾ç¤º CDK
                        } else if (resp.data?.status === 'paid') {
                            alert('âœ… æ”¯ä»˜æˆåŠŸï¼Œç­‰å¾…å–å®¶å‘è´§');
                            this._showOrderDetail(orderNo);
                        } else {
                            alert(`â„¹ï¸ ${resp.data?.message || 'è®¢å•å°šæœªæ”¯ä»˜'}`);
                            btn.disabled = false;
                            btn.textContent = 'ğŸ”„ åˆ·æ–°æ”¯ä»˜çŠ¶æ€';
                        }
                    } else {
                        alert(`âŒ ${this._formatError(resp)}`);
                        btn.disabled = false;
                        btn.textContent = 'ğŸ”„ åˆ·æ–°æ”¯ä»˜çŠ¶æ€';
                    }
                });

                // å¤åˆ¶æŒ‰é’®ï¼ˆCDK ä¸€é”®å¤åˆ¶ï¼‰
                body.querySelector('.ldsp-order-cdk-btn[data-action="copy"]')?.addEventListener('click', (e) => {
                    const btn = e.target;
                    const content = btn.dataset.content;
                    if (!content) return;
                    
                    const doCopy = () => {
                        btn.classList.add('copied');
                        btn.textContent = 'âœ… å·²å¤åˆ¶';
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btn.textContent = 'ğŸ“‹ ä¸€é”®å¤åˆ¶';
                        }, 2000);
                    };
                    
                    if (navigator.clipboard?.writeText) {
                        navigator.clipboard.writeText(content).then(doCopy).catch(() => {
                            // é™çº§æ–¹æ¡ˆ
                            const textarea = document.createElement('textarea');
                            textarea.value = content;
                            textarea.style.cssText = 'position:fixed;left:-9999px';
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            doCopy();
                        });
                    } else {
                        // é™çº§æ–¹æ¡ˆ
                        const textarea = document.createElement('textarea');
                        textarea.value = content;
                        textarea.style.cssText = 'position:fixed;left:-9999px';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        doCopy();
                    }
                });
            }

            static SUPPORT_TIERS = [
                { id: 1, name: 'åšçš„ä¸é”™', amount: 5, icon: 'ğŸŒ±', url: 'https://credit.linux.do/paying/online?token=cf4a5cd58a11fe68a6191c5e3bcca9a34fb8f4eb951eca46bbb0a40042b7e0ea' },
                { id: 2, name: 'å¤§åŠ›æ”¯æŒ', amount: 10, icon: 'ğŸš€', badge: 'çƒ­é—¨', url: 'https://credit.linux.do/paying/online?token=8f4f08c0ceb719c922d105a3be4c2d6d890aa17b47b73fa756510aa1abdc1bf7' },
                { id: 3, name: 'æ·±å¾—æˆ‘å¿ƒ', amount: 25, icon: 'â¤ï¸', badge: 'ç«çˆ†', url: 'https://credit.linux.do/paying/online?token=7a3d6fb647a275b55c248ad58b546e02905f7a05c08579906773bd323c2e2242' },
                { id: 4, name: 'ç¤¾åŒºè´¡çŒ®è€…', amount: 50, icon: 'ğŸ‘‘', badge: 'å°Šäº«', url: 'https://credit.linux.do/paying/online?token=78d243962c635d1fe2deaecd2e8c59abf778113d25b1e5d05364c8a586fd5384' }
            ];

            _renderSupport() {
                const body = this.overlay.querySelector('.ldsp-ldc-body');
                const tiers = LDCManager.SUPPORT_TIERS.map(t => `
                    <a href="${t.url}" target="_blank" class="ldsp-ldc-support-card tier-${t.id}" rel="noopener">
                        ${t.badge ? `<span class="ldsp-ldc-support-badge">${t.badge}</span>` : ''}
                        <div class="ldsp-ldc-support-icon">${t.icon}</div>
                        <div class="ldsp-ldc-support-name">${t.name}</div>
                        <div class="ldsp-ldc-support-amount">${t.amount} <span>LDC</span></div>
                    </a>`).join('');
                body.innerHTML = `
                    <div class="ldsp-ldc-support">
                        <div class="ldsp-ldc-support-header">
                            <div class="ldsp-ldc-support-title"><span class="ldsp-ldc-support-heart">ğŸ’–</span>æ”¯æŒ LDStatus Pro</div>
                            <div class="ldsp-ldc-support-desc">æ„Ÿè°¢æ‚¨ä½¿ç”¨ LDStatus Proï¼<br>æ‚¨çš„æ”¯æŒæ˜¯æˆ‘æŒç»­å¼€å‘çš„åŠ¨åŠ›</div>
                        </div>
                        <a href="https://github.com/caigg188/LDStatusPro" target="_blank" rel="noopener" class="ldsp-github-star-card">
                            <div class="ldsp-github-icon-wrap"><svg class="ldsp-github-icon" viewBox="0 0 98 96"><path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"/></svg></div>
                            <div class="ldsp-github-content"><div class="ldsp-github-title">åœ¨ GitHub ä¸Š Star ä¸€ä¸‹<span class="ldsp-github-star-icon">â­</span></div>
                            <div class="ldsp-github-desc">æ‚¨çš„ Star æ˜¯å¯¹ä½œè€…æœ€å¥½çš„é¼“åŠ±</div></div>
                            <span class="ldsp-github-arrow">â†’</span>
                        </a>
                        <div class="ldsp-ldc-support-grid">${tiers}</div>
                        <div class="ldsp-ldc-support-footer"><div class="ldsp-ldc-support-footer-text">ğŸ™ æ¯ä¸€ä»½æ”¯æŒéƒ½å°†ç”¨äº<em>æœåŠ¡å™¨ç»´æŠ¤</em>å’Œ<em>åŠŸèƒ½å¼€å‘</em><br>æ„Ÿè°¢ç¤¾åŒºæ¯ä¸€ä½ç”¨æˆ·çš„ä¿¡ä»»ä¸é™ªä¼´</div></div>
                    </div>`;
            }

            _showDetail(o) {
                this._order = o;
                const body = this.overlay.querySelector('.ldsp-ldc-body');
                // ä½¿ç”¨ç»å¯¹å€¼ï¼Œå› ä¸º API è¿”å›çš„ amount å¯èƒ½å·²ç»æ˜¯è´Ÿæ•°
                const amt = Math.abs(parseFloat(o.amount) || 0);
                const ti = LDCManager.TRANS_TYPES.find(t => t.id === o.type) || { icon: 'ğŸ“‹', label: o.type };
                // æ”¶æ”¯åˆ¤æ–­ï¼šä¼˜å…ˆé€šè¿‡ payee/payer åˆ¤æ–­
                const inc = this._userId 
                    ? o.payee_user_id === this._userId && o.payer_user_id !== this._userId
                    : (o.type === 'receive' || o.type === 'community' || o.payer_user_id === 0);
                const row = (l, v, cls = '') => `<div class="ldsp-ldc-detail-row"><span class="label">${l}</span><span class="value${cls ? ' ' + cls : ''}">${v}</span></div>`;
                body.innerHTML = `<div class="ldsp-ldc-detail">
                    <div class="ldsp-ldc-detail-header"><button class="ldsp-ldc-back-btn">â† è¿”å›</button><span>äº¤æ˜“è¯¦æƒ…</span></div>
                    <div class="ldsp-ldc-detail-amount ${inc ? 'income-bg' : 'expense-bg'}">
                        <div class="ldsp-ldc-detail-amount-value ${inc ? 'income' : 'expense'}">${inc ? '+' : '-'}${amt.toFixed(2)}</div>
                        <div class="ldsp-ldc-detail-amount-label">LDC</div>
                    </div>
                    <div class="ldsp-ldc-detail-card">
                        ${row('äº¤æ˜“çŠ¶æ€', o.status === 'success' ? 'âœ“ æˆåŠŸ' : o.status, 'status-' + o.status)}
                        ${row('äº¤æ˜“ç±»å‹', `<span class="ldsp-ldc-trans-type type-${o.type || 'default'}" style="font-size:11px">${ti.icon} ${ti.label}</span>`)}
                        ${row('è®¢å•åç§°', Utils.escapeHtml(o.order_name || 'â€”'))}
                        ${o.app_name ? row('åº”ç”¨åç§°', Utils.escapeHtml(o.app_name)) : ''}
                        ${row('äº¤æ˜“æ—¶é—´', Utils.escapeHtml(this._fmtTime(o.trade_time || o.created_at, true)))}
                        ${row('è®¢å•å·', Utils.escapeHtml(o.order_no || 'â€”'), 'mono')}
                        ${o.payee_username ? row('æ”¶æ¬¾æ–¹', Utils.escapeHtml(o.payee_username)) : ''}
                        ${o.payer_username ? row('ä»˜æ¬¾æ–¹', Utils.escapeHtml(o.payer_username)) : ''}
                        ${o.remark ? row('å¤‡æ³¨', Utils.escapeHtml(o.remark)) : ''}
                        ${o.app_homepage_url ? `<div class="ldsp-ldc-detail-row"><span class="label">åº”ç”¨é“¾æ¥</span><a class="value link" href="${Utils.escapeHtml(o.app_homepage_url)}" target="_blank">${Utils.escapeHtml(o.app_homepage_url)}</a></div>` : ''}
                    </div></div>`;
                body.querySelector('.ldsp-ldc-back-btn')?.addEventListener('click', () => this._closeDetail());
            }

            _closeDetail() { this._order = null; this._renderTransUI(); }

            _fmtTime(t, full = false) {
                if (!t) return 'â€”';
                try {
                    const d = new Date(t);
                    return full ? d.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })
                        : d.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                } catch { return 'â€”'; }
            }

            _showError(msg, login = false) {
                const body = this.overlay.querySelector('.ldsp-ldc-body');
                this.overlay.querySelector('.ldsp-ldc-refresh')?.classList.remove('spinning');
                this._loading = false;
                const icon = msg.includes('è¶…æ—¶') ? 'â±ï¸' : msg.includes('ç½‘ç»œ') ? 'ğŸŒ' : msg.includes('ç™»å½•') ? 'ğŸ”' : 'ğŸ˜•';
                const isTrans = this._tab === 'transactions';
                const filter = isTrans ? this._getFilterHtml() : '';
                body.innerHTML = `${filter}<div class="ldsp-ldc-error"><div class="ldsp-ldc-error-icon">${icon}</div>
                    <div class="ldsp-ldc-error-msg">${Utils.escapeHtml(msg)}</div>
                    ${login ? '<a href="https://credit.linux.do" target="_blank" class="ldsp-ldc-login-btn">å»ç™»å½• â†’</a>' : ''}
                    <button class="ldsp-ldc-retry-btn">ğŸ”„ é‡è¯•</button></div>`;
                if (isTrans) this._bindFilterEvents(body);
                body.querySelector('.ldsp-ldc-retry-btn')?.addEventListener('click', () => {
                    this._tab === 'overview' ? this._fetchData() : this._fetchTrans(true);
                });
            }

            _getFilterHtml() {
                const tr = LDCManager.TIME_RANGES.map(t => `<div class="ldsp-ldc-filter-chip${this._filter.timeRange === t.id ? ' active' : ''}" data-time="${t.id}">${t.label}</div>`).join('');
                const tp = LDCManager.TRANS_TYPES.map(t => `<div class="ldsp-ldc-filter-chip${this._filter.type === t.id ? ' active' : ''}" data-type="${t.id}">${t.icon} ${t.label}</div>`).join('');
                return `<div class="ldsp-ldc-filter-section"><div class="ldsp-ldc-filter-row"><span class="ldsp-ldc-filter-label">æ—¶é—´</span><div class="ldsp-ldc-filter-chips">${tr}</div></div>
                    <div class="ldsp-ldc-filter-row"><span class="ldsp-ldc-filter-label">ç±»å‹</span><div class="ldsp-ldc-filter-chips ldsp-ldc-filter-chips-wrap">${tp}</div></div></div>`;
            }

            _bindFilterEvents(el) {
                el.querySelectorAll('[data-time]').forEach(c => c.addEventListener('click', () => {
                    if (c.dataset.time !== this._filter.timeRange) { this._filter.timeRange = c.dataset.time; this._fetchTrans(true); }
                }));
                el.querySelectorAll('[data-type]').forEach(c => c.addEventListener('click', () => {
                    if (c.dataset.type !== this._filter.type) { this._filter.type = c.dataset.type; this._fetchTrans(true); }
                }));
            }

            destroy() {
                if (this._escHandler) { document.removeEventListener('keydown', this._escHandler); this._escHandler = null; }
                if (this._scrollObserver) { this._scrollObserver.disconnect(); this._scrollObserver = null; }
                // æ¸…ç† iframe æ¡¥æ¥
                if (this._msgHandler) { window.removeEventListener('message', this._msgHandler); this._msgHandler = null; }
                if (this._bridge) { this._bridge.remove(); this._bridge = null; }
                this._requests.clear();
                if (this.overlay) { this.overlay.remove(); this.overlay = null; }
            }
        }

        // ==================== CDK ç®¡ç†å™¨ ====================
        // é€šè¿‡ iframe æ¡¥æ¥è·å– cdk.linux.do æ•°æ®
        class CDKManager {
            static CDK_ORIGIN = 'https://cdk.linux.do';

            constructor(panelBody, renderer) {
                this.panelBody = panelBody;
                this.renderer = renderer;
                this.overlay = null;
                this._loading = false;
                this._tab = 'home';
                this._userInfo = null;
                this._received = { results: [], total: 0, page: 1 };
                this._project = null;
                this._search = '';
                this._searchTimer = null;
                this._bridge = null;
                this._bridgeReady = null;
                this._requests = new Map();
                this._reqId = 0;
            }

            init() {
                this._createOverlay();
                this._initBridge();
            }

            _initBridge() {
                const handler = (e) => {
                    if (e.origin !== CDKManager.CDK_ORIGIN || e.data?.type !== 'ldsp-cdk-response') return;
                    const p = this._requests.get(e.data.requestId);
                    if (p) { this._requests.delete(e.data.requestId); p(e.data); }
                };
                window.addEventListener('message', handler);
                this._msgHandler = handler;
                
                const frame = document.createElement('iframe');
                frame.src = CDKManager.CDK_ORIGIN + '/dashboard';
                frame.style.cssText = 'width:0;height:0;opacity:0;position:absolute;border:0;pointer-events:none';
                document.body.appendChild(frame);
                this._bridge = frame;
                
                this._bridgeReady = new Promise(r => {
                    const t = setTimeout(() => r(), 5000);
                    frame.onload = () => { clearTimeout(t); setTimeout(r, 300); };
                });
            }

            _createOverlay() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'ldsp-cdk-overlay';
                this.overlay.innerHTML = `
                    <div class="ldsp-cdk-header">
                        <div class="ldsp-cdk-title">ğŸ CDK ç³»ç»Ÿ</div>
                        <div class="ldsp-cdk-header-actions">
                            <a href="https://cdk.linux.do" target="_blank" class="ldsp-cdk-link">CDK.LINUX.DO</a>
                            <button class="ldsp-cdk-refresh" title="åˆ·æ–°">
                                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            </button>
                            <div class="ldsp-cdk-close">Ã—</div>
                        </div>
                    </div>
                    <div class="ldsp-cdk-tabs">
                        <div class="ldsp-cdk-tab active" data-tab="home">ğŸ  é¦–é¡µ</div>
                        <div class="ldsp-cdk-tab" data-tab="received">ğŸ“‹ é¢†å–è®°å½•</div>
                    </div>
                    <div class="ldsp-cdk-body">
                        <div class="ldsp-cdk-loading">
                            <div class="ldsp-spinner"></div>
                            <div>åŠ è½½ä¸­...</div>
                        </div>
                    </div>`;
                if (this.panelBody) {
                    this.panelBody.appendChild(this.overlay);
                }
                this._bindEvents();
            }

            _bindEvents() {
                this.overlay.querySelector('.ldsp-cdk-close').addEventListener('click', () => this.hide());
                this.overlay.querySelector('.ldsp-cdk-refresh').addEventListener('click', () => {
                    this._tab === 'home' ? this._fetchUserInfo() : this._fetchReceived();
                });
                this.overlay.querySelectorAll('.ldsp-cdk-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        if (tab.dataset.tab !== this._tab) this._switchTab(tab.dataset.tab);
                    });
                });
                this._escHandler = (e) => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('show')) {
                        this._project ? this._closeDetail() : this.hide();
                    }
                };
                document.addEventListener('keydown', this._escHandler);
            }

            _switchTab(tabId) {
                this._tab = tabId;
                this._project = null;
                this.overlay.querySelectorAll('.ldsp-cdk-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
                if (tabId === 'home') {
                    this._userInfo ? this._renderHome(this._userInfo) : this._fetchUserInfo();
                } else {
                    this._search = '';
                    this._received = { results: [], total: 0, page: 1 };
                    this._fetchReceived();
                }
            }

            show() {
                this.overlay.classList.add('show');
                this._tab = 'home';
                this._project = null;
                this.overlay.querySelectorAll('.ldsp-cdk-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'home'));
                this._userInfo ? this._renderHome(this._userInfo) : this._fetchUserInfo();
            }

            hide() {
                this.overlay.classList.remove('show');
                this._project = null;
            }

            async _fetchUserInfo() {
                if (this._loading) return;
                this._loading = true;
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                const btn = this.overlay.querySelector('.ldsp-cdk-refresh');
                btn?.classList.add('spinning');
                body.innerHTML = `<div class="ldsp-cdk-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;

                try {
                    const data = await this._request('https://cdk.linux.do/api/v1/oauth/user-info');
                    if (data._authError) { 
                        this._showError('è¯·å…ˆç™»å½• cdk.linux.do ååˆ·æ–°', true); 
                        return; 
                    }
                    if (data._error) { 
                        // è¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯æ—¶ï¼Œæç¤ºç”¨æˆ·å¯èƒ½éœ€è¦ç™»å½•
                        const isTimeout = data._error.includes('è¶…æ—¶');
                        this._showError(isTimeout ? 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¡®è®¤å·²ç™»å½• cdk.linux.do åé‡è¯•' : data._error, isTimeout); 
                        return; 
                    }
                    this._userInfo = data.data;
                    this._renderHome(this._userInfo);
                } catch (e) {
                    this._showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                } finally {
                    this._loading = false;
                    btn?.classList.remove('spinning');
                }
            }

            _renderHome(user) {
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                
                const avatarUrl = user.avatar_url || '';
                const nickname = user.nickname || user.username || 'User';
                const username = user.username || '';
                const userId = user.id || user.user_id || '';
                const trustLevel = user.trust_level || 0;
                const score = user.score || 0;
                
                body.innerHTML = `
                    <div class="ldsp-cdk-user-card">
                        ${avatarUrl ? `<img class="ldsp-cdk-user-avatar" src="${Utils.escapeHtml(avatarUrl)}" alt="avatar" onerror="this.style.display='none'">` : '<div class="ldsp-cdk-user-avatar" style="display:flex;align-items:center;justify-content:center;background:var(--bg-hover);font-size:24px">ğŸ‘¤</div>'}
                        <div class="ldsp-cdk-user-info">
                            <div class="ldsp-cdk-user-name">${Utils.escapeHtml(nickname)}</div>
                            <div class="ldsp-cdk-user-username">@${Utils.escapeHtml(username)}${userId ? ` <span style="color:var(--txt-mut);font-size:10px">#${userId}</span>` : ''}</div>
                            <div class="ldsp-cdk-user-level">
                                <span>ğŸ… LV ${trustLevel}</span>
                            </div>
                        </div>
                        <div class="ldsp-cdk-score-card">
                            <div class="ldsp-cdk-score-label">CDK åˆ†æ•°</div>
                            <div class="ldsp-cdk-score-value">${score}</div>
                        </div>
                    </div>
                    <div style="padding:14px;background:linear-gradient(135deg,rgba(6,182,212,.06),rgba(14,165,233,.03));border:1px solid rgba(6,182,212,.15);border-radius:var(--r-md);font-size:11px;color:var(--txt-sec);line-height:1.7">
                        <div style="font-weight:600;color:var(--txt);margin-bottom:8px;display:flex;align-items:center;gap:6px"><span style="font-size:14px">ğŸ’¡</span>å…³äº CDK åˆ†æ•°</div>
                        <div>CDK åˆ†æ•°ç”¨äºå‚ä¸ç¤¾åŒºé¡¹ç›®çš„æŠ½å¥–å’Œé¢†å–æ´»åŠ¨ï¼Œå¾ˆå¤šé¡¹ç›®ä¼šè®¾ç½®CDKåˆ†æ•°è¦æ±‚ã€‚</div>
                        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;color:var(--txt-mut)">ğŸ¥‡ é€šè¿‡è·å–å¾½ç« æ¥æé«˜CDKåˆ†æ•°</div>
                    </div>
                    <div style="text-align:center;margin-top:auto;padding-top:12px">
                        <a href="https://cdk.linux.do" target="_blank" style="display:inline-flex;align-items:center;gap:4px;color:#06b6d4;font-size:11px;text-decoration:none;padding:8px 16px;background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.2);border-radius:var(--r-sm);transition:all .15s" onmouseover="this.style.background='rgba(6,182,212,.15)'" onmouseout="this.style.background='rgba(6,182,212,.08)'">ğŸ”— è®¿é—® CDK ç³»ç»Ÿå®Œæ•´åŠŸèƒ½</a>
                    </div>`;
            }

            async _fetchReceived(loadMore = false) {
                if (this._loading) return;
                this._loading = true;
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                const btn = this.overlay.querySelector('.ldsp-cdk-refresh');
                const trigger = body?.querySelector('.ldsp-cdk-load-trigger');
                if (!loadMore) {
                    btn?.classList.add('spinning');
                    this._received = { results: [], total: 0, page: 1 };
                    body.innerHTML = `<div class="ldsp-cdk-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;
                } else if (trigger) {
                    trigger.innerHTML = '<div class="ldsp-mini-spin"></div>åŠ è½½ä¸­...';
                    trigger.classList.add('loading');
                }
                const page = loadMore ? this._received.page + 1 : 1;

                try {
                    const search = this._search ? `&search=${encodeURIComponent(this._search)}` : '';
                    const data = await this._request(`https://cdk.linux.do/api/v1/projects/received?current=${page}&size=20${search}`);
                    if (data._authError) { this._showError('è¯·å…ˆç™»å½• cdk.linux.do', true); return; }
                    if (data._error) { this._showError(data._error); return; }

                    const results = data.data?.results || [];
                    this._received.results = loadMore ? [...this._received.results, ...results] : results;
                    this._received.total = data.data?.total || 0;
                    this._received.page = page;
                    this._renderReceived(loadMore);
                } catch (e) {
                    this._showError('ç½‘ç»œé”™è¯¯');
                } finally {
                    this._loading = false;
                    btn?.classList.remove('spinning');
                }
            }

            _renderReceived(append = false) {
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                const { results, total } = this._received;
                const hasMore = results.length < total;

                if (!append) {
                    let html = `<div class="ldsp-cdk-list-header">
                        <div class="ldsp-cdk-search"><span class="ldsp-cdk-search-icon">ğŸ”</span>
                            <input type="text" placeholder="æœç´¢é¡¹ç›®åç§°æˆ–åˆ›å»ºè€…..." value="${Utils.escapeHtml(this._search)}">
                            <button class="ldsp-cdk-search-clear ${this._search ? 'show' : ''}">Ã—</button></div>
                        ${total > 0 ? `<div class="ldsp-cdk-stats-row"><span class="total">ğŸ“¦ å…± <strong>${total}</strong> æ¡è®°å½•</span><span class="loaded">å·²åŠ è½½ ${results.length} æ¡</span></div>` : ''}
                    </div>`;

                    if (!results.length) {
                        html += `<div class="ldsp-cdk-empty"><div class="ldsp-cdk-empty-icon">ğŸ“­</div>
                            <div class="ldsp-cdk-empty-text">${this._search ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•' : 'æš‚æ— é¢†å–è®°å½•'}</div></div>`;
                    } else {
                        html += '<div class="ldsp-cdk-list ldsp-cdk-scroll-list">' + this._renderReceivedItems(results) + '</div>';
                        html += hasMore ? '<div class="ldsp-cdk-load-trigger">â¬‡ï¸ æ»šåŠ¨åŠ è½½æ›´å¤š</div>' : `<div class="ldsp-cdk-loaded-all">âœ… å·²å…¨éƒ¨åŠ è½½</div>`;
                    }
                    body.innerHTML = html;
                    this._bindReceivedEvents(body);
                } else {
                    const list = body.querySelector('.ldsp-cdk-scroll-list');
                    const trigger = body.querySelector('.ldsp-cdk-load-trigger');
                    const loaded = body.querySelector('.ldsp-cdk-stats-row .loaded');
                    if (list) {
                        const startIdx = results.length - 20;
                        list.insertAdjacentHTML('beforeend', this._renderReceivedItems(results.slice(Math.max(0, startIdx))));
                        this._bindItemEvents(list);
                    }
                    if (loaded) loaded.textContent = `å·²åŠ è½½ ${results.length} æ¡`;
                    if (trigger) {
                        trigger.outerHTML = hasMore ? '<div class="ldsp-cdk-load-trigger">â¬‡ï¸ æ»šåŠ¨åŠ è½½æ›´å¤š</div>' : `<div class="ldsp-cdk-loaded-all">âœ… å·²å…¨éƒ¨åŠ è½½</div>`;
                    }
                }
            }

            _renderReceivedItems(items) {
                return items.map(item => `
                    <div class="ldsp-cdk-item" data-id="${Utils.escapeHtml(item.project_id)}">
                        <div class="ldsp-cdk-item-header">
                            <div class="ldsp-cdk-item-name">${Utils.escapeHtml(item.project_name)}</div>
                            <div class="ldsp-cdk-item-time">ğŸ“… ${this._formatTime(item.received_at)}</div>
                        </div>
                        <div class="ldsp-cdk-item-creator">ğŸ‘¤ ${Utils.escapeHtml(item.project_creator_nickname || item.project_creator)}</div>
                        <div class="ldsp-cdk-item-content">
                            <span class="ldsp-cdk-item-content-text">${Utils.escapeHtml(item.content)}</span>
                            <button class="ldsp-cdk-item-copy" data-content="${Utils.escapeHtml(item.content)}" title="å¤åˆ¶å†…å®¹">ğŸ“‹</button>
                        </div>
                    </div>`).join('');
            }

            _bindReceivedEvents(el) {
                const input = el.querySelector('.ldsp-cdk-search input');
                const clear = el.querySelector('.ldsp-cdk-search-clear');
                input?.addEventListener('input', (e) => {
                    clear?.classList.toggle('show', !!e.target.value);
                    clearTimeout(this._searchTimer);
                    this._searchTimer = setTimeout(() => { this._search = e.target.value.trim(); this._fetchReceived(); }, 500);
                });
                clear?.addEventListener('click', () => { input.value = ''; clear.classList.remove('show'); this._search = ''; this._fetchReceived(); });
                this._bindItemEvents(el);
                // ç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                body?.removeEventListener('scroll', this._scrollHandler);
                this._scrollHandler = () => {
                    if (this._loading) return;
                    const { scrollTop, scrollHeight, clientHeight } = body;
                    if (scrollHeight - scrollTop - clientHeight < 80) {
                        const { results, total } = this._received;
                        if (results.length < total) this._fetchReceived(true);
                    }
                };
                body?.addEventListener('scroll', this._scrollHandler, { passive: true });
            }

            _bindItemEvents(el) {
                el.querySelectorAll('.ldsp-cdk-item:not([data-bound])').forEach(item => {
                    item.dataset.bound = '1';
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.ldsp-cdk-item-copy')) this._fetchDetail(item.dataset.id);
                    });
                });
                el.querySelectorAll('.ldsp-cdk-item-copy:not([data-bound])').forEach(btn => {
                    btn.dataset.bound = '1';
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this._copy(btn, btn.dataset.content);
                    });
                });
            }

            async _copy(btn, text) {
                try { await navigator.clipboard.writeText(text); btn.innerHTML = 'âœ…'; } catch { btn.innerHTML = 'âŒ'; }
                setTimeout(() => btn.innerHTML = 'ğŸ“‹', 1500);
            }

            async _fetchDetail(id) {
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                body.innerHTML = `<div class="ldsp-cdk-loading"><div class="ldsp-spinner"></div><div>åŠ è½½è¯¦æƒ…...</div></div>`;
                try {
                    const data = await this._request(`https://cdk.linux.do/api/v1/projects/${id}`);
                    if (data._error) { this._showError(data._error); return; }
                    this._project = data.data;
                    this._renderDetail(data.data);
                } catch (e) {
                    this._showError('è·å–è¯¦æƒ…å¤±è´¥');
                }
            }

            _renderDetail(p) {
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                const status = p.status === 0 ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ';
                const statusColor = p.status === 0 ? '#22c55e' : 'var(--txt-mut)';
                const tags = p.tags?.length ? `<div class="ldsp-cdk-detail-tags">${p.tags.map(t => `<span class="ldsp-cdk-detail-tag">${Utils.escapeHtml(t)}</span>`).join('')}</div>` : '';
                const total = p.total_items || 0, remain = p.available_items_count || 0;
                // æ„å»ºè¦æ±‚åˆ—è¡¨
                const reqs = [];
                if (p.minimum_trust_level > 0) reqs.push(['ğŸ… æœ€ä½ä¿¡ä»»ç­‰çº§', `LV ${p.minimum_trust_level}`]);
                if (typeof p.risk_level === 'number') reqs.push(['â­ æœ€ä½ç”¨æˆ·åˆ†æ•°', 100 - p.risk_level]);
                if (p.allow_same_ip === false) reqs.push(['ğŸŒ IPé™åˆ¶', 'é™åˆ¶åŒä¸€IP']);
                const reqsHtml = reqs.length ? reqs.map(([l, v]) => `<div class="ldsp-cdk-detail-row"><span class="label">${l}</span><span class="value">${v}</span></div>`).join('') : '<div class="ldsp-cdk-detail-row"><span class="label">ğŸ“‹ é¢†å–è¦æ±‚</span><span class="value">æ— ç‰¹æ®Šè¦æ±‚</span></div>';
                const rows = [
                    ['å¼€å§‹æ—¶é—´', this._formatTime(p.start_time, true)],
                    ['ç»“æŸæ—¶é—´', this._formatTime(p.end_time, true)],
                    ['åˆ›å»ºæ—¶é—´', this._formatTime(p.created_at, true)]
                ].map(([l, v]) => `<div class="ldsp-cdk-detail-row"><span class="label">${l}</span><span class="value">${v}</span></div>`).join('');

                body.innerHTML = `<div class="ldsp-cdk-detail">
                    <div class="ldsp-cdk-detail-header"><button class="ldsp-cdk-back-btn">â† è¿”å›</button></div>
                    <div class="ldsp-cdk-detail-title">${Utils.escapeHtml(p.name)}</div>
                    <div class="ldsp-cdk-detail-meta">åˆ›å»ºè€…: ${Utils.escapeHtml(p.creator_nickname || p.creator_username)} Â· <span style="color:${statusColor}">${status}</span>${p.is_completed ? ' Â· âœ… å·²é¢†å–' : ''}</div>
                    ${tags}${p.description ? `<div class="ldsp-cdk-detail-desc">${Utils.escapeHtml(p.description)}</div>` : ''}
                    ${p.received_content ? `<div class="ldsp-cdk-detail-content"><div class="ldsp-cdk-detail-content-label">ğŸ åˆ†å‘å†…å®¹</div>
                        <div class="ldsp-cdk-detail-content-value"><span>${Utils.escapeHtml(p.received_content)}</span>
                        <button class="ldsp-cdk-detail-copy" data-content="${Utils.escapeHtml(p.received_content)}">ğŸ“‹</button></div></div>` : ''}
                    <div class="ldsp-cdk-qty-card">
                        <div class="ldsp-cdk-qty-item remain"><div class="num">${remain}</div><div class="lbl">å‰©ä½™æ•°é‡</div></div>
                        <div class="ldsp-cdk-qty-item total"><div class="num">${total}</div><div class="lbl">æ€»æ•°é‡</div></div>
                    </div>
                    <div class="ldsp-cdk-detail-section"><div class="ldsp-cdk-detail-section-title">ğŸ“‹ é¢†å–è¦æ±‚</div><div class="ldsp-cdk-detail-info">${reqsHtml}</div></div>
                    <div class="ldsp-cdk-detail-section"><div class="ldsp-cdk-detail-section-title">ğŸ“… æ—¶é—´ä¿¡æ¯</div><div class="ldsp-cdk-detail-info">${rows}</div></div></div>`;

                body.querySelector('.ldsp-cdk-back-btn')?.addEventListener('click', () => this._closeDetail());
                const copyBtn = body.querySelector('.ldsp-cdk-detail-copy');
                copyBtn?.addEventListener('click', () => this._copy(copyBtn, copyBtn.dataset.content));
            }

            _closeDetail() { this._project = null; this._renderReceived(); }

            _formatTime(t, full = false) {
                if (!t) return 'â€”';
                try {
                    const d = new Date(t);
                    if (full) return d.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    const diff = Date.now() - d, mins = Math.floor(diff / 60000), hrs = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
                    if (mins < 1) return 'åˆšåˆš';
                    if (mins < 60) return `${mins}åˆ†é’Ÿå‰`;
                    if (hrs < 24) return `${hrs}å°æ—¶å‰`;
                    if (days < 7) return `${days}å¤©å‰`;
                    return d.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                } catch { return 'â€”'; }
            }

            async _request(url) {
                if (this._bridgeReady) await this._bridgeReady;
                if (!this._bridge) return { _error: 'æ¡¥æ¥æœªå°±ç»ª' };
                
                return new Promise((resolve) => {
                    const id = ++this._reqId;
                    const timeout = setTimeout(() => { this._requests.delete(id); resolve({ _error: 'è¯·æ±‚è¶…æ—¶' }); }, 15000);
                    this._requests.set(id, ({ status, data }) => {
                        clearTimeout(timeout);
                        if (status === 200) {
                            resolve(data._error ? { _error: data._error } : (data.error_msg ? { _error: data.error_msg } : data));
                        } else if (status === 401 || status === 403) {
                            resolve({ _authError: true });
                        } else {
                            debugBridgeLog('CDK bridge status', { url, status });
                            resolve({ _error: data._error || `è¯·æ±‚å¤±è´¥ (${status})` });
                        }
                    });
                    try {
                        this._bridge.contentWindow.postMessage({ type: 'ldsp-cdk-request', requestId: id, url }, CDKManager.CDK_ORIGIN);
                    } catch (e) {
                        clearTimeout(timeout);
                        this._requests.delete(id);
                        debugBridgeLog('CDK bridge postMessage error', e?.message || e);
                        resolve({ _error: 'å‘é€è¯·æ±‚å¤±è´¥' });
                    }
                });
            }

            _showError(msg, showLogin = false) {
                const body = this.overlay.querySelector('.ldsp-cdk-body');
                this.overlay.querySelector('.ldsp-cdk-refresh')?.classList.remove('spinning');
                this._loading = false;
                const icon = msg.includes('è¶…æ—¶') ? 'â±ï¸' : msg.includes('ç½‘ç»œ') ? 'ğŸŒ' : msg.includes('ç™»å½•') ? 'ğŸ”' : 'ğŸ˜•';
                body.innerHTML = `<div class="ldsp-cdk-error"><div class="ldsp-cdk-error-icon">${icon}</div>
                    <div class="ldsp-cdk-error-msg">${Utils.escapeHtml(msg)}</div>
                    ${showLogin ? '<a href="https://cdk.linux.do" target="_blank" class="ldsp-cdk-login-btn">å»ç™»å½• â†’</a>' : ''}
                    <button class="ldsp-cdk-retry-btn">ğŸ”„ é‡è¯•</button></div>`;
                body.querySelector('.ldsp-cdk-retry-btn')?.addEventListener('click', () => {
                    this._tab === 'home' ? this._fetchUserInfo() : this._fetchReceived();
                });
            }

            destroy() {
                if (this._escHandler) { document.removeEventListener('keydown', this._escHandler); this._escHandler = null; }
                if (this._searchTimer) clearTimeout(this._searchTimer);
                if (this._msgHandler) { window.removeEventListener('message', this._msgHandler); this._msgHandler = null; }
                if (this._bridge) { this._bridge.remove(); this._bridge = null; }
                this._requests.clear();
                if (this.overlay) { this.overlay.remove(); this.overlay = null; }
            }
        }

        // ==================== åƒç“œåŠ©æ‰‹ ====================
        class MelonHelper {
            static STORAGE_KEY = 'ldsp_melon_config';
            static HISTORY_KEY = 'ldsp_melon_history';
            
            // ç®€ç•¥æ€»ç»“æç¤ºè¯
            static PROMPT_BRIEF = `ç”¨ç®€æ´çš„æ–¹å¼æ€»ç»“ä»¥ä¸‹è®ºå›è®¨è®ºï¼š`;

            // è¯¦ç»†æ€»ç»“æç¤ºè¯
            static PROMPT_DETAILED = `è¯¦ç»†åˆ†æå’Œæ€»ç»“ä»¥ä¸‹è®ºå›è®¨è®ºï¼š`;

            constructor(panelBody, renderer) {
                this.panelBody = panelBody;
                this.renderer = renderer;
                this.overlay = null;
                this.config = this._loadConfig();
                this.history = this._loadHistory();
                this._abortController = null;
                this._isEditing = false;
                this._topicCache = null;
                this._currentOutput = '';  // å½“å‰è¾“å‡ºçš„åŸå§‹æ–‡æœ¬
                this._summaryMode = 'detailed';  // é»˜è®¤è¯¦ç»†æ¨¡å¼
                this._lastUrl = location.href;  // ä¸Šæ¬¡URL
                this._urlCheckInterval = null;  // URLæ£€æµ‹å®šæ—¶å™¨
            }

            _loadConfig() {
                try {
                    const saved = GM_getValue(MelonHelper.STORAGE_KEY, null);
                    const defaultConfig = {
                        apiUrl: '',
                        apiKey: '',
                        model: 'gpt-4o-mini',
                        promptBrief: '',
                        promptDetailed: ''
                    };
                    return saved ? { ...defaultConfig, ...JSON.parse(saved) } : defaultConfig;
                } catch {
                    return { apiUrl: '', apiKey: '', model: 'gpt-4o-mini', promptBrief: '', promptDetailed: '' };
                }
            }

            _saveConfig() {
                try {
                    GM_setValue(MelonHelper.STORAGE_KEY, JSON.stringify(this.config));
                } catch (e) {
                    Logger.error('[MelonHelper] Save config failed:', e);
                }
            }

            _loadHistory() {
                try {
                    const saved = GM_getValue(MelonHelper.HISTORY_KEY, null);
                    return saved ? JSON.parse(saved) : [];
                } catch {
                    return [];
                }
            }

            _saveHistory() {
                try {
                    GM_setValue(MelonHelper.HISTORY_KEY, JSON.stringify(this.history));
                } catch (e) {
                    Logger.error('[MelonHelper] Save history failed:', e);
                }
            }

            _addToHistory(topicId, title, summary, mode) {
                // ä»¥ topicId + mode ä¸ºä¸»é”®ï¼ŒåŒä¸€è¯é¢˜çš„ç®€ç•¥å’Œè¯¦ç»†ç‰ˆå¯ä»¥åŒæ—¶å­˜åœ¨
                const historyKey = `${topicId}_${mode}`;
                const existingIndex = this.history.findIndex(h => `${h.topicId}_${h.mode}` === historyKey);
                const record = {
                    topicId,
                    title,
                    summary,
                    mode,
                    timestamp: Date.now()
                };
                if (existingIndex >= 0) {
                    this.history[existingIndex] = record;
                } else {
                    this.history.unshift(record);
                }
                // æœ€å¤šä¿ç•™ 100 æ¡
                if (this.history.length > 100) {
                    this.history = this.history.slice(0, 100);
                }
                this._saveHistory();
            }

            _clearHistory() {
                this.history = [];
                this._saveHistory();
            }

            init() {
                this._createOverlay();
            }

            _createOverlay() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'ldsp-melon-overlay';
                this.overlay.innerHTML = `
                    <div class="ldsp-melon-header">
                        <div class="ldsp-melon-title">ğŸ‰ åƒç“œåŠ©æ‰‹</div>
                        <div class="ldsp-melon-header-actions">
                            <div class="ldsp-melon-refresh" title="åˆ·æ–°æ•°æ®"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>åˆ·æ–°</div>
                            <div class="ldsp-melon-close">Ã—</div>
                        </div>
                    </div>
                    <div class="ldsp-melon-tabs">
                        <div class="ldsp-melon-tab active" data-tab="home">é¦–é¡µ</div>
                        <div class="ldsp-melon-tab" data-tab="history">å†å²</div>
                        <div class="ldsp-melon-tab" data-tab="settings">è®¾ç½®</div>
                    </div>
                    <div class="ldsp-melon-body"></div>`;
                if (this.panelBody) {
                    this.panelBody.appendChild(this.overlay);
                }
                this._bindEvents();
            }

            _bindEvents() {
                this.overlay.querySelector('.ldsp-melon-close').addEventListener('click', () => this.hide());
                this.overlay.querySelector('.ldsp-melon-refresh').addEventListener('click', () => this._handleRefresh());
                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('show')) this.hide();
                });
                this.overlay.querySelectorAll('.ldsp-melon-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.overlay.querySelectorAll('.ldsp-melon-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const tabName = tab.dataset.tab;
                        if (tabName === 'home') {
                            this._renderHome();
                        } else if (tabName === 'history') {
                            this._renderHistory();
                        } else if (tabName === 'settings') {
                            this._renderSettings();
                        }
                    });
                });
                
            }

            async _handleRefresh() {
                const refreshBtn = this.overlay.querySelector('.ldsp-melon-refresh');
                if (!refreshBtn || refreshBtn.classList.contains('disabled')) return;
                
                // è·å–å½“å‰æ´»åŠ¨çš„æ ‡ç­¾é¡µ
                const activeTab = this.overlay.querySelector('.ldsp-melon-tab.active');
                const tabName = activeTab?.dataset.tab;
                
                // æ¸…é™¤ç¼“å­˜
                this._topicCache = null;
                
                // æ ¹æ®å½“å‰æ ‡ç­¾é¡µåˆ·æ–°
                if (tabName === 'home') {
                    await this._renderHome(true);
                } else if (tabName === 'history') {
                    this._renderHistory();
                }
                // è®¾ç½®é¡µä¸éœ€è¦åˆ·æ–°
            }
            
            // URL ç›‘å¬ - ä»…åœ¨é¢æ¿æ‰“å¼€ä¸”éè¯é¢˜é¡µæ—¶å¯åŠ¨
            _startUrlWatch() {
                if (this._urlCheckInterval) return;
                this._urlCheckInterval = setInterval(() => {
                    const currentUrl = location.href;
                    if (currentUrl !== this._lastUrl) {
                        this._lastUrl = currentUrl;
                        this._topicCache = null;  // æ¸…ç©ºè¯é¢˜ç¼“å­˜
                        
                        // å¦‚æœé¢æ¿æ‰“å¼€ä¸”åœ¨é¦–é¡µï¼Œæ£€æµ‹åˆ°è¯é¢˜ ID æœ‰å˜åŒ–æ—¶åˆ·æ–°
                        if (this.overlay.classList.contains('show')) {
                            const activeTab = this.overlay.querySelector('.ldsp-melon-tab.active');
                            if (activeTab?.dataset.tab === 'home') {
                                const newTopicId = this._getTopicId();
                                // åªæœ‰å½“è¿›å…¥æ–°è¯é¢˜æ—¶æ‰åˆ·æ–°ï¼ˆä»éè¯é¢˜é¡µè¿›å…¥è¯é¢˜é¡µï¼‰
                                if (newTopicId) {
                                    this._renderHome();
                                    // æˆåŠŸè¿›å…¥è¯é¢˜ååœæ­¢è½®è¯¢ï¼Œé¿å…é¢‘ç¹åˆ·æ–°
                                    this._stopUrlWatch();
                                }
                            }
                        }
                    }
                }, 800);  // é™ä½æ£€æµ‹é¢‘ç‡
            }
            
            _stopUrlWatch() {
                if (this._urlCheckInterval) {
                    clearInterval(this._urlCheckInterval);
                    this._urlCheckInterval = null;
                }
            }

            show() {
                // æ›´æ–° URL è®°å½•
                this._lastUrl = location.href;
                
                // æ£€æŸ¥æ˜¯å¦åˆ‡æ¢äº†è¯é¢˜ï¼Œå¦‚æœæ˜¯åˆ™æ¸…ç©ºç¼“å­˜
                const currentTopicId = this._getTopicId();
                if (this._topicCache && this._topicCache.id !== currentTopicId) {
                    this._topicCache = null;
                    Logger.log('[MelonHelper] Topic changed, clearing cache');
                }
                
                this.overlay.classList.add('show');
                const activeTab = this.overlay.querySelector('.ldsp-melon-tab.active');
                if (activeTab?.dataset.tab === 'settings') {
                    this._renderSettings();
                } else {
                    this._renderHome();
                }
            }

            hide() {
                // åœæ­¢ URL ç›‘å¬
                this._stopUrlWatch();
                // ä¸­æ­¢æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
                if (this._abortController) {
                    this._abortController.abort();
                    this._abortController = null;
                }
                this.overlay.classList.remove('show');
            }

            _getTopicId() {
                return window.location.href.match(/\/t(?:opic)?\/[^\/]+\/(\d+)/)?.[1] || 
                       window.location.href.match(/\/t(?:opic)?\/(\d+)/)?.[1];
            }

            _getReplyCount() {
                const el = document.querySelector('.timeline-replies');
                if (!el) return 0;
                const txt = el.textContent.trim();
                return parseInt(txt.includes('/') ? txt.split('/')[1] : txt) || 0;
            }

            async _getTopicInfo(forceRefresh = false) {
                const topicId = this._getTopicId();
                if (!topicId) return null;
                
                // ä½¿ç”¨ç¼“å­˜ï¼ˆåŒä¸€è¯é¢˜ä¸é‡å¤è¯·æ±‚ï¼‰
                if (!forceRefresh && this._topicCache && this._topicCache.id === topicId) {
                    Logger.log('[MelonHelper] Using cached topic info');
                    return this._topicCache;
                }
                
                try {
                    Logger.log('[MelonHelper] Fetching topic info for:', topicId);
                    const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
                    const response = await fetch(`${location.origin}/t/${topicId}.json`, {
                        headers: {
                            'x-csrf-token': csrf,
                            'x-requested-with': 'XMLHttpRequest'
                        }
                    });
                    if (!response.ok) {
                        Logger.warn('[MelonHelper] Topic API response not ok:', response.status);
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    Logger.log('[MelonHelper] Topic data received:', { title: data.title, posts_count: data.posts_count });
                    
                    this._topicCache = {
                        id: topicId,
                        title: data.title || 'æœªçŸ¥æ ‡é¢˜',
                        category: data.category_id ? (document.querySelector('.category-name')?.textContent || '') : '',
                        postsCount: data.posts_count || 1,
                        replyCount: Math.max(0, (data.posts_count || 1) - 1),
                        views: data.views || 0,
                        likeCount: data.like_count || 0,
                        createdAt: data.created_at,
                        lastPostedAt: data.last_posted_at
                    };
                    return this._topicCache;
                } catch (e) {
                    Logger.error('[MelonHelper] Get topic info failed:', e);
                    // é™çº§ï¼šä»é¡µé¢ DOM è·å–
                    const fallbackInfo = {
                        id: topicId,
                        title: document.querySelector('.fancy-title, .topic-title')?.textContent?.trim() || 'å½“å‰è¯é¢˜',
                        replyCount: this._getReplyCount(),
                        postsCount: Math.max(1, this._getReplyCount() + 1),
                        views: 0
                    };
                    Logger.log('[MelonHelper] Using fallback info:', fallbackInfo);
                    return fallbackInfo;
                }
            }

            async _fetchDialogues(topicId, start, end, progressCallback) {
                Logger.log('[MelonHelper] Fetching dialogues:', { topicId, start, end });
                const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
                const opts = {
                    headers: {
                        'x-csrf-token': csrf,
                        'x-requested-with': 'XMLHttpRequest'
                    }
                };

                // è·å–å¸–å­IDåˆ—è¡¨
                progressCallback?.('æ­£åœ¨è·å–å¸–å­åˆ—è¡¨...');
                const idRes = await fetch(`${location.origin}/t/${topicId}/post_ids.json?post_number=0&limit=99999`, opts);
                if (!idRes.ok) throw new Error(`è·å–å¸–å­åˆ—è¡¨å¤±è´¥ (${idRes.status})`);
                const idData = await idRes.json();
                Logger.log('[MelonHelper] Total post IDs:', idData.post_ids?.length);
                
                let pIds = idData.post_ids.slice(Math.max(0, start - 1), end);
                Logger.log('[MelonHelper] Selected post IDs count:', pIds.length);

                // å¦‚æœåŒ…å«ç¬¬1æ¥¼ï¼Œè·å–ä¸»å¸–ä¿¡æ¯ç¡®ä¿ç¬¬ä¸€æ¥¼IDæ­£ç¡®
                if (start <= 1 && pIds.length > 0) {
                    const mainRes = await fetch(`${location.origin}/t/${topicId}.json`, opts);
                    if (mainRes.ok) {
                        const mainData = await mainRes.json();
                        const firstId = mainData.post_stream?.posts?.[0]?.id;
                        if (firstId && !pIds.includes(firstId)) {
                            pIds.unshift(firstId);
                            Logger.log('[MelonHelper] Added first post ID:', firstId);
                        }
                    }
                }

                if (pIds.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°å¸–å­å†…å®¹');
                }

                let text = '';
                const totalBatches = Math.ceil(pIds.length / 200);
                
                // åˆ†æ‰¹è·å–å¸–å­è¯¦æƒ…ï¼ˆæ¯æ‰¹200æ¡ï¼‰
                for (let i = 0; i < pIds.length; i += 200) {
                    const batchNum = Math.floor(i / 200) + 1;
                    progressCallback?.(`æ­£åœ¨è·å–å¸–å­å†…å®¹ (${batchNum}/${totalBatches})...`);
                    
                    const chunk = pIds.slice(i, i + 200);
                    const q = chunk.map(id => `post_ids[]=${id}`).join('&');
                    const res = await fetch(`${location.origin}/t/${topicId}/posts.json?${q}&include_suggested=false`, opts);
                    if (!res.ok) throw new Error(`è·å–å¸–å­è¯¦æƒ…å¤±è´¥ (${res.status})`);
                    const data = await res.json();
                    
                    Logger.log('[MelonHelper] Batch', batchNum, 'posts count:', data.post_stream?.posts?.length);

                    text += data.post_stream.posts.map(p => {
                        let content = p.cooked || '';

                        // å¤„ç†å›¾ç‰‡
                        content = content.replace(
                            /<div class="lightbox-wrapper">\s*<a class="lightbox" href="([^"]+)"(?:\s+data-download-href="([^"]+)")?[^>]*title="([^"]*)"[^>]*>[\s\S]*?<\/a>\s*<\/div>/gi,
                            (match, hrefUrl, downloadHref, title) => {
                                let imgUrl = hrefUrl || `${location.origin}${downloadHref || ''}`;
                                const filename = title || 'å›¾ç‰‡';
                                return `\n[å›¾ç‰‡: ${filename}](${imgUrl})\n`;
                            }
                        );

                        // å¤„ç†é™„ä»¶
                        content = content.replace(
                            /<a class="attachment" href="([^"]+)"[^>]*>([^<]+)<\/a>/gi,
                            (match, url, name) => `\n[é™„ä»¶: ${name.trim()}](${url})\n`
                        );

                        // å¤„ç†emoji
                        content = content.replace(
                            /<img[^>]+class="emoji[^>]*alt="([^"]*)"[^>]*>/gi,
                            '$1 '
                        );

                        // å¤„ç†å¼•ç”¨å—
                        content = content.replace(
                            /<aside class="quote(?:-modified)?[^>]*>[\s\S]*?<blockquote>([\s\S]*?)<\/blockquote>[\s\S]*?<\/aside>/gi,
                            (match, quoteInner) => {
                                let cleanQuote = quoteInner.replace(/<[^>]+>/g, '').trim();
                                return `\n[å¼•ç”¨]\n${cleanQuote}\n[/å¼•ç”¨]\n`;
                            }
                        );

                        // ç§»é™¤æ‰€æœ‰HTMLæ ‡ç­¾
                        content = content.replace(/<[^>]+>/g, '').trim();

                        // æ ¼å¼åŒ–è¾“å‡º
                        const userName = p.name || p.username;
                        const userPart = `${userName}ï¼ˆ${p.username}ï¼‰`;
                        let replyPart = '';

                        if (p.reply_to_post_number && p.reply_to_user) {
                            const replyToName = p.reply_to_user.name || p.reply_to_user.username;
                            const replyToUsername = p.reply_to_user.username;
                            replyPart = `-å›å¤[${p.reply_to_post_number}æ¥¼] ${replyToName}ï¼ˆ${replyToUsername}ï¼‰`;
                        }

                        return `[${p.post_number}æ¥¼] ${userPart}${replyPart}:\n${content}`;
                    }).join('\n\n');
                }

                return text;
            }

            async _renderHome(forceRefresh = false) {
                const body = this.overlay.querySelector('.ldsp-melon-body');
                const topicId = this._getTopicId();

                if (!topicId) {
                    // éè¯é¢˜é¡µï¼Œå¯åŠ¨ URL ç›‘å¬ç­‰å¾…ç”¨æˆ·è¿›å…¥è¯é¢˜
                    this._startUrlWatch();
                    body.innerHTML = `
                        <div class="ldsp-melon-not-topic">
                            <div class="ldsp-melon-not-topic-icon">ğŸˆ</div>
                            <div class="ldsp-melon-not-topic-text">è¯·å…ˆè¿›å…¥ä¸€ä¸ªè¯é¢˜å¸–å­<br>æ‰èƒ½ä½¿ç”¨åƒç“œåŠ©æ‰‹å“¦~</div>
                            <div class="ldsp-melon-not-topic-hint">è¿›å…¥è¯é¢˜åä¼šè‡ªåŠ¨åˆ·æ–°</div>
                        </div>`;
                    return;
                }

                // å·²åœ¨è¯é¢˜é¡µï¼Œåœæ­¢ URL ç›‘å¬
                this._stopUrlWatch();

                // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                body.innerHTML = `<div class="ldsp-melon-status"><div class="ldsp-melon-status-icon">â³</div>æ­£åœ¨è·å–è¯é¢˜ä¿¡æ¯...</div>`;

                const info = await this._getTopicInfo(forceRefresh);
                if (!info) {
                    body.innerHTML = `<div class="ldsp-melon-error">âŒ è·å–è¯é¢˜ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•</div>`;
                    return;
                }

                const totalPosts = info.postsCount || 1;
                const defaultEnd = totalPosts;
                const rangeHint = totalPosts > 100 ? `å…±${totalPosts}æ¥¼ï¼Œå†…å®¹è¾ƒå¤šå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´` : `å…±${totalPosts}æ¥¼`;

                // æ£€æŸ¥æ˜¯å¦å·²é…ç½® API
                const hasConfig = this.config.apiUrl && this.config.apiKey;

                body.innerHTML = `
                    <div class="ldsp-melon-info">
                        <div class="ldsp-melon-info-title">ğŸ“‹ ${Utils.escapeHtml(info.title)}</div>
                        <div class="ldsp-melon-info-row">
                            <span class="ldsp-melon-info-label">æ€»æ¥¼å±‚</span>
                            <span class="ldsp-melon-info-value">${totalPosts} æ¥¼</span>
                        </div>
                        ${info.views ? `<div class="ldsp-melon-info-row">
                            <span class="ldsp-melon-info-label">æµè§ˆé‡</span>
                            <span class="ldsp-melon-info-value">${info.views.toLocaleString()}</span>
                        </div>` : ''}
                        ${info.likeCount ? `<div class="ldsp-melon-info-row">
                            <span class="ldsp-melon-info-label">ç‚¹èµæ•°</span>
                            <span class="ldsp-melon-info-value">${info.likeCount}</span>
                        </div>` : ''}
                    </div>
                    ${!hasConfig ? `<div class="ldsp-melon-warning">âš ï¸ è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­é…ç½® API ä¿¡æ¯</div>` : ''}
                    <div class="ldsp-melon-range">
                        <span class="ldsp-melon-range-label">æ¥¼å±‚èŒƒå›´</span>
                        <input type="number" class="ldsp-melon-range-input" id="melon-start" value="1" min="1" max="${totalPosts}">
                        <span class="ldsp-melon-range-sep">~</span>
                        <input type="number" class="ldsp-melon-range-input" id="melon-end" value="${defaultEnd}" min="1" max="${totalPosts}">
                        <span class="ldsp-melon-range-hint">${rangeHint}</span>
                    </div>
                    <div class="ldsp-melon-mode-selector">
                        <span class="ldsp-melon-mode-label">æ€»ç»“æ¨¡å¼</span>
                        <div class="ldsp-melon-mode-cards">
                            <label class="ldsp-melon-mode-card ${this._summaryMode === 'brief' ? 'active' : ''}">
                                <input type="radio" name="melon-mode" value="brief" ${this._summaryMode === 'brief' ? 'checked' : ''}>
                                <div class="ldsp-melon-mode-card-icon">âš¡</div>
                                <div class="ldsp-melon-mode-card-content">
                                    <div class="ldsp-melon-mode-card-title">ç®€ç•¥æ¨¡å¼</div>
                                    <div class="ldsp-melon-mode-card-desc">~150å­—å¿«é€Ÿæ¦‚è¦</div>
                                </div>
                            </label>
                            <label class="ldsp-melon-mode-card ${this._summaryMode === 'detailed' ? 'active' : ''}">
                                <input type="radio" name="melon-mode" value="detailed" ${this._summaryMode === 'detailed' ? 'checked' : ''}>
                                <div class="ldsp-melon-mode-card-icon">ğŸ“Š</div>
                                <div class="ldsp-melon-mode-card-content">
                                    <div class="ldsp-melon-mode-card-title">è¯¦ç»†æ¨¡å¼</div>
                                    <div class="ldsp-melon-mode-card-desc">å®Œæ•´ç»“æ„åŒ–åˆ†æ</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="ldsp-melon-actions">
                        <button class="ldsp-melon-btn-summarize" id="melon-summarize" ${!hasConfig ? 'disabled' : ''}>
                            <span>ğŸ‰</span>
                            <span>ç«‹å³åƒç“œ</span>
                        </button>
                    </div>
                    <div class="ldsp-melon-output-wrapper">
                        <div class="ldsp-melon-output-header" style="display:none;">
                            <span class="ldsp-melon-output-title">ğŸ“ æ€»ç»“ç»“æœ</span>
                            <div class="ldsp-melon-output-actions">
                                <button class="ldsp-melon-resize-btn" id="melon-expand" title="åœ¨æ–°çª—å£ä¸­å±•å¼€æŸ¥çœ‹">
                                    <span>ğŸ”</span>
                                    <span>å±•å¼€</span>
                                </button>
                                <button class="ldsp-melon-copy-btn" id="melon-copy" title="å¤åˆ¶åˆ°å‰ªè´´æ¿">
                                    <span>ğŸ“‹</span>
                                    <span>å¤åˆ¶</span>
                                </button>
                            </div>
                        </div>
                        <div class="ldsp-melon-output" id="melon-output"></div>
                    </div>`;

                // ç»‘å®šæ¨¡å¼é€‰æ‹©
                body.querySelectorAll('input[name="melon-mode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this._summaryMode = e.target.value;
                        // æ›´æ–°å¡ç‰‡activeçŠ¶æ€
                        body.querySelectorAll('.ldsp-melon-mode-card').forEach(card => {
                            card.classList.toggle('active', card.querySelector('input').value === e.target.value);
                        });
                    });
                });

                // ç»‘å®šå¤åˆ¶æŒ‰é’®
                body.querySelector('#melon-copy').addEventListener('click', () => this._copyOutput());
                
                // ç»‘å®šå±•å¼€æŒ‰é’® - æ‰“å¼€ç‹¬ç«‹å¤§çª—å£
                body.querySelector('#melon-expand').addEventListener('click', () => {
                    if (this._currentOutput) {
                        this._showViewer({
                            title: info.title,
                            summary: this._currentOutput,
                            mode: this._summaryMode,
                            topicId: info.id
                        });
                    }
                });

                body.querySelector('#melon-summarize').addEventListener('click', () => this._doSummarize(info));
            }

            async _copyOutput() {
                if (!this._currentOutput) {
                    return;
                }
                try {
                    await navigator.clipboard.writeText(this._currentOutput);
                    const copyBtn = this.overlay.querySelector('#melon-copy');
                    if (copyBtn) {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<span>âœ…</span><span>å·²å¤åˆ¶</span>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                        }, 1500);
                    }
                } catch (e) {
                    Logger.error('[MelonHelper] Copy failed:', e);
                }
            }

            async _doSummarize(topicInfo) {
                const body = this.overlay.querySelector('.ldsp-melon-body');
                const btn = body.querySelector('#melon-summarize');
                const output = body.querySelector('#melon-output');
                const outputHeader = body.querySelector('.ldsp-melon-output-header');
                const startInput = body.querySelector('#melon-start');
                const endInput = body.querySelector('#melon-end');

                const start = parseInt(startInput.value) || 1;
                const end = parseInt(endInput.value) || topicInfo.postsCount;

                Logger.log('[MelonHelper] Starting summarize:', { topicId: topicInfo.id, start, end, mode: this._summaryMode });

                if (start > end) {
                    output.innerHTML = '<div class="ldsp-melon-error">âŒ èµ·å§‹æ¥¼å±‚ä¸èƒ½å¤§äºç»“æŸæ¥¼å±‚</div>';
                    return;
                }

                if (start < 1) {
                    output.innerHTML = '<div class="ldsp-melon-error">âŒ èµ·å§‹æ¥¼å±‚ä¸èƒ½å°äº1</div>';
                    return;
                }

                if (!this.config.apiUrl || !this.config.apiKey) {
                    output.innerHTML = '<div class="ldsp-melon-error">âŒ è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­é…ç½® API åœ°å€å’Œå¯†é’¥</div>';
                    return;
                }

                btn.disabled = true;
                btn.classList.add('loading');
                this._currentOutput = '';  // æ¸…ç©ºå½“å‰è¾“å‡º
                outputHeader.style.display = 'none';  // éšè—å¤åˆ¶æŒ‰é’®
                
                const updateStatus = (msg) => {
                    btn.innerHTML = `<span>â³</span><span>${msg}</span>`;
                };
                
                updateStatus('è·å–å¸–å­å†…å®¹...');
                output.innerHTML = '<div class="ldsp-melon-status"><div class="ldsp-melon-status-icon">ğŸ”„</div>æ­£åœ¨è·å–å¸–å­å†…å®¹...</div>';

                try {
                    // 1. è·å–å¸–å­å†…å®¹
                    const dialogues = await this._fetchDialogues(topicInfo.id, start, end, updateStatus);
                    
                    Logger.log('[MelonHelper] Dialogues length:', dialogues?.length);
                    
                    if (!dialogues || dialogues.trim().length < 20) {
                        throw new Error('è·å–å¸–å­å†…å®¹å¤±è´¥æˆ–å†…å®¹ä¸ºç©º');
                    }

                    updateStatus('AI åˆ†æä¸­...');
                    output.innerHTML = '<div class="ldsp-melon-output-content"></div><div class="ldsp-melon-cursor">â–Œ</div>';

                    // 2. æ ¹æ®æ¨¡å¼é€‰æ‹©æç¤ºè¯ï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯ï¼‰
                    const prompt = this._summaryMode === 'brief' 
                        ? (this.config.promptBrief || MelonHelper.PROMPT_BRIEF)
                        : (this.config.promptDetailed || MelonHelper.PROMPT_DETAILED);
                    const userContent = `è¯é¢˜æ ‡é¢˜: ${topicInfo.title}\n\nå¸–å­å†…å®¹ (ç¬¬${start}æ¥¼ ~ ç¬¬${end}æ¥¼):\n${dialogues}`;

                    Logger.log('[MelonHelper] Calling AI, content length:', userContent.length, 'mode:', this._summaryMode);
                    this._abortController = new AbortController();

                    // 3. æµå¼è°ƒç”¨ AI æ¥å£
                    await this._callAIStream(prompt, userContent, this._abortController.signal, (chunk) => {
                        // å¢é‡æ›´æ–°
                        this._currentOutput += chunk;
                        const contentDiv = output.querySelector('.ldsp-melon-output-content');
                        if (contentDiv) {
                            contentDiv.innerHTML = this._renderMarkdown(this._currentOutput);
                            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                            output.scrollTop = output.scrollHeight;
                        }
                    });
                    
                    // ç§»é™¤å…‰æ ‡
                    const cursor = output.querySelector('.ldsp-melon-cursor');
                    if (cursor) cursor.remove();
                    
                    Logger.log('[MelonHelper] AI response complete, length:', this._currentOutput?.length);
                    
                    // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
                    outputHeader.style.display = 'flex';

                    // ä¿å­˜åˆ°å†å²
                    this._addToHistory(topicInfo.id, topicInfo.title, this._currentOutput, this._summaryMode);
                    
                    this.renderer?.showToast('âœ… åƒç“œå®Œæˆï¼');

                } catch (e) {
                    Logger.error('[MelonHelper] Summarize error:', e);
                    // ç§»é™¤å…‰æ ‡
                    const cursor = output.querySelector('.ldsp-melon-cursor');
                    if (cursor) cursor.remove();
                    
                    if (e.name === 'AbortError') {
                        output.innerHTML = '<div class="ldsp-melon-status"><div class="ldsp-melon-status-icon">â¹ï¸</div>å·²å–æ¶ˆ</div>';
                    } else {
                        output.innerHTML = `<div class="ldsp-melon-error">âŒ ${Utils.escapeHtml(e.message || 'è¯·æ±‚å¤±è´¥')}</div>`;
                    }
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    btn.innerHTML = '<span>ğŸ‰</span><span>ç«‹å³åƒç“œ</span>';
                    this._abortController = null;
                }
            }

            // æµå¼ AI è°ƒç”¨
            async _callAIStream(systemPrompt, userContent, signal, onChunk, messages = null) {
                const { apiUrl, apiKey, model } = this.config;

                // æ„å»ºæ¶ˆæ¯æ•°ç»„ï¼ˆæ”¯æŒå¯¹è¯å†å²ï¼‰
                const msgArray = messages || [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userContent }
                ];

                // æ„å»ºæµå¼è¯·æ±‚ä½“
                const requestBody = {
                    model: model || 'gpt-4o-mini',
                    messages: msgArray,
                    max_tokens: 4096,
                    temperature: 0.7,
                    stream: true  // å¯ç”¨æµå¼è¾“å‡º
                };

                Logger.log('[MelonHelper] Calling AI API (stream):', apiUrl);

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: signal
                    });

                    Logger.log('[MelonHelper] API response status:', response.status);

                    if (!response.ok) {
                        let errMsg = `è¯·æ±‚å¤±è´¥ (${response.status})`;
                        try {
                            const errData = await response.json();
                            errMsg = errData.error?.message || errMsg;
                            Logger.error('[MelonHelper] API error response:', errData);
                        } catch {}
                        throw new Error(errMsg);
                    }

                    // å¤„ç† SSE æµå¼å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';  // ä¿ç•™æœªå®Œæˆçš„è¡Œ

                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (!trimmed || trimmed === 'data: [DONE]') continue;
                            if (!trimmed.startsWith('data: ')) continue;

                            try {
                                const json = JSON.parse(trimmed.slice(6));
                                const content = json.choices?.[0]?.delta?.content;
                                if (content) {
                                    onChunk(content);
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                                Logger.log('[MelonHelper] SSE parse skip:', trimmed);
                            }
                        }
                    }

                    Logger.log('[MelonHelper] Stream complete');
                } catch (e) {
                    if (e.name === 'AbortError') {
                        throw e;
                    }
                    Logger.error('[MelonHelper] Stream fetch error:', e);
                    if (e.message === 'Failed to fetch' || e.name === 'TypeError') {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è¯¥ API æ˜¯å¦æ”¯æŒè·¨åŸŸè¯·æ±‚');
                    }
                    throw e;
                }
            }

            _renderMarkdown(md) {
                if (!md) return '';
                
                let html = md;
                
                // 1. ä¿æŠ¤ä»£ç å—ï¼Œå…ˆæå–å‡ºæ¥
                const codeBlocks = [];
                html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                    const placeholder = `%%CODEBLOCK_${codeBlocks.length}%%`;
                    codeBlocks.push(`<pre class="ldsp-melon-codeblock"><code>${Utils.escapeHtml(code.trim())}</code></pre>`);
                    return placeholder;
                });
                
                // 2. è¡Œå†…ä»£ç 
                const inlineCodes = [];
                html = html.replace(/`([^`\n]+)`/g, (match, code) => {
                    const placeholder = `%%INLINECODE_${inlineCodes.length}%%`;
                    inlineCodes.push(`<code class="ldsp-melon-inline-code">${Utils.escapeHtml(code)}</code>`);
                    return placeholder;
                });
                
                // 3. æ ‡é¢˜ - æ”¯æŒ emoji å¼€å¤´çš„æ ‡é¢˜
                html = html.replace(/^#### (.+)$/gm, '<h5 class="ldsp-melon-h5">$1</h5>');
                html = html.replace(/^### (.+)$/gm, '<h4 class="ldsp-melon-h4">$1</h4>');
                html = html.replace(/^## (.+)$/gm, '<h3 class="ldsp-melon-h3">$1</h3>');
                html = html.replace(/^# (.+)$/gm, '<h2 class="ldsp-melon-h2">$1</h2>');
                
                // 4. ç²—ä½“ - ä¿®å¤è·¨è¡Œå’Œ emoji åçš„æƒ…å†µ
                html = html.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/__([^_]+?)__/g, '<strong>$1</strong>');
                
                // 5. æ–œä½“
                html = html.replace(/(?<!\*)\*([^*\n]+?)\*(?!\*)/g, '<em>$1</em>');
                html = html.replace(/(?<!_)_([^_\n]+?)_(?!_)/g, '<em>$1</em>');
                
                // 6. å¼•ç”¨å—
                html = html.replace(/^> (.+)$/gm, '<blockquote class="ldsp-melon-quote">$1</blockquote>');
                html = html.replace(/<\/blockquote>\n<blockquote class="ldsp-melon-quote">/g, '<br>');
                
                // 7. æ— åºåˆ—è¡¨
                html = html.replace(/^[-*] (.+)$/gm, '<li class="ldsp-melon-li">$1</li>');
                html = html.replace(/((?:<li class="ldsp-melon-li">[^<]*<\/li>\n?)+)/g, '<ul class="ldsp-melon-ul">$1</ul>');
                
                // 8. æœ‰åºåˆ—è¡¨
                html = html.replace(/^\d+\. (.+)$/gm, '<li class="ldsp-melon-oli">$1</li>');
                html = html.replace(/((?:<li class="ldsp-melon-oli">[^<]*<\/li>\n?)+)/g, '<ol class="ldsp-melon-ol">$1</ol>');
                
                // 9. é“¾æ¥
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="ldsp-melon-link">$1</a>');
                
                // 10. åˆ†éš”çº¿
                html = html.replace(/^---+$/gm, '<hr class="ldsp-melon-hr">');
                html = html.replace(/^\*\*\*+$/gm, '<hr class="ldsp-melon-hr">');
                
                // 11. æ®µè½å¤„ç†
                html = html.replace(/\n\n+/g, '</p><p class="ldsp-melon-p">');
                html = html.replace(/\n/g, '<br>');
                
                // 12. æ¸…ç†
                html = html.replace(/<p class="ldsp-melon-p"><\/p>/g, '');
                html = html.replace(/<p class="ldsp-melon-p">(<h[2-5])/g, '$1');
                html = html.replace(/(<\/h[2-5]>)<\/p>/g, '$1');
                html = html.replace(/<p class="ldsp-melon-p">(<ul)/g, '$1');
                html = html.replace(/(<\/ul>)<\/p>/g, '$1');
                html = html.replace(/<p class="ldsp-melon-p">(<ol)/g, '$1');
                html = html.replace(/(<\/ol>)<\/p>/g, '$1');
                html = html.replace(/<p class="ldsp-melon-p">(<blockquote)/g, '$1');
                html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
                html = html.replace(/<p class="ldsp-melon-p">(<pre)/g, '$1');
                html = html.replace(/(<\/pre>)<\/p>/g, '$1');
                html = html.replace(/<br><(h[2-5]|ul|ol|blockquote|pre)/g, '<$1');
                html = html.replace(/<\/(h[2-5]|ul|ol|blockquote|pre)><br>/g, '</$1>');
                
                // 13. æ¢å¤ä»£ç å—
                codeBlocks.forEach((block, i) => {
                    html = html.replace(`%%CODEBLOCK_${i}%%`, block);
                });
                inlineCodes.forEach((code, i) => {
                    html = html.replace(`%%INLINECODE_${i}%%`, code);
                });
                
                return `<div class="ldsp-melon-markdown"><p class="ldsp-melon-p">${html}</p></div>`;
            }

            _renderSettings() {
                const body = this.overlay.querySelector('.ldsp-melon-body');
                const hasConfig = this.config.apiUrl && this.config.apiKey;
                // å¦‚æœå·²æœ‰é…ç½®ï¼Œé»˜è®¤ä¸å¯ç¼–è¾‘çŠ¶æ€
                const isEditing = !hasConfig || this._isEditing;
                
                body.innerHTML = `
                    <div class="ldsp-melon-settings">
                        <div class="ldsp-melon-setting-security">
                            <div class="ldsp-melon-setting-security-icon">ğŸ”’</div>
                            <div class="ldsp-melon-setting-security-text">
                                <strong>æ•°æ®å®‰å…¨</strong> Â· æ‚¨çš„ API Key ç­‰é…ç½®ä»…ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨
                            </div>
                        </div>
                        <div class="ldsp-melon-setting-group">
                            <div class="ldsp-melon-setting-title">ğŸ”‘ API é…ç½®</div>
                            <div class="ldsp-melon-setting-row">
                                <label class="ldsp-melon-setting-label">API åœ°å€ <span style="color:var(--err)">*</span></label>
                                <input type="text" class="ldsp-melon-setting-input" id="melon-api-url" 
                                    placeholder="https://api.openai.com/v1/chat/completions" 
                                    value="${Utils.escapeHtml(this.config.apiUrl || '')}"
                                    ${!isEditing ? 'disabled' : ''}>
                                <div class="ldsp-melon-setting-hint">âš ï¸ å®Œæ•´æ ¼å¼: https://xxxxxx<strong>/v1/chat/completions</strong>ï¼ˆåˆ«æ¼æ‰åç¼€ï¼‰</div>
                            </div>
                            <div class="ldsp-melon-setting-row">
                                <label class="ldsp-melon-setting-label">API Key <span style="color:var(--err)">*</span></label>
                                <input type="${isEditing ? 'text' : 'password'}" class="ldsp-melon-setting-input" id="melon-api-key" 
                                    placeholder="sk-..." 
                                    value="${Utils.escapeHtml(this.config.apiKey || '')}"
                                    ${!isEditing ? 'disabled' : ''}>
                            </div>
                            <div class="ldsp-melon-setting-row">
                                <label class="ldsp-melon-setting-label">æ¨¡å‹åç§°</label>
                                <input type="text" class="ldsp-melon-setting-input" id="melon-model" 
                                    placeholder="gemini-2.0-flash" 
                                    value="${Utils.escapeHtml(this.config.model || 'gpt-4o-mini')}"
                                    ${!isEditing ? 'disabled' : ''}>
                                <div class="ldsp-melon-setting-hint">åªå¡«ä¸€ä¸ªæ¨¡å‹åï¼Œæ¨è: <strong>gemini-2.0-flash</strong>ã€<strong>claude-3-haiku</strong>ã€<strong>deepseek-v3</strong></div>
                            </div>
                            <div class="ldsp-melon-setting-actions">
                                ${isEditing ? `
                                    <button class="ldsp-melon-setting-btn ldsp-melon-btn-save" id="melon-save-settings">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                ` : `
                                    <button class="ldsp-melon-setting-btn ldsp-melon-btn-edit" id="melon-edit-settings">âœï¸ ä¿®æ”¹é…ç½®</button>
                                `}
                            </div>
                        </div>
                        <div class="ldsp-melon-setting-group">
                            <div class="ldsp-melon-setting-title">ğŸ“ è‡ªå®šä¹‰æç¤ºè¯ <span class="ldsp-melon-setting-subtitle">ï¼ˆå¯é€‰ï¼Œç•™ç©ºç”¨é»˜è®¤ï¼‰</span></div>
                            <div class="ldsp-melon-setting-row">
                                <label class="ldsp-melon-setting-label">
                                    ç®€ç•¥æ¨¡å¼
                                    <span class="ldsp-melon-prompt-reset" data-prompt="brief" title="æ¸…ç©ºå¹¶æ¢å¤é»˜è®¤">ğŸ—‘ï¸</span>
                                    <span class="ldsp-melon-prompt-status ${this.config.promptBrief ? 'custom' : ''}">${this.config.promptBrief ? 'âœ… å·²è‡ªå®šä¹‰' : 'é»˜è®¤'}</span>
                                </label>
                                <textarea class="ldsp-melon-setting-textarea" id="melon-prompt-brief" 
                                    placeholder="${Utils.escapeHtml(MelonHelper.PROMPT_BRIEF.trim())}"
                                    rows="4">${Utils.escapeHtml(this.config.promptBrief || '')}</textarea>
                            </div>
                            <div class="ldsp-melon-setting-row">
                                <label class="ldsp-melon-setting-label">
                                    è¯¦ç»†æ¨¡å¼
                                    <span class="ldsp-melon-prompt-reset" data-prompt="detailed" title="æ¸…ç©ºå¹¶æ¢å¤é»˜è®¤">ğŸ—‘ï¸</span>
                                    <span class="ldsp-melon-prompt-status ${this.config.promptDetailed ? 'custom' : ''}">${this.config.promptDetailed ? 'âœ… å·²è‡ªå®šä¹‰' : 'é»˜è®¤'}</span>
                                </label>
                                <textarea class="ldsp-melon-setting-textarea" id="melon-prompt-detailed" 
                                    placeholder="${Utils.escapeHtml(MelonHelper.PROMPT_DETAILED.trim())}"
                                    rows="6">${Utils.escapeHtml(this.config.promptDetailed || '')}</textarea>
                            </div>
                            <div class="ldsp-melon-setting-actions">
                                <button class="ldsp-melon-setting-btn ldsp-melon-btn-prompt" id="melon-save-prompts">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
                            </div>
                        </div>
                        <div class="ldsp-melon-setting-group ldsp-melon-setting-danger">
                            <div class="ldsp-melon-setting-danger-content">
                                <div class="ldsp-melon-setting-danger-info">
                                    <div class="ldsp-melon-setting-title">ğŸ—‘ï¸ é‡ç½®é…ç½®</div>
                                    <div class="ldsp-melon-setting-danger-desc">æ¸…ç©º API é…ç½®å’Œè‡ªå®šä¹‰æç¤ºè¯</div>
                                </div>
                                <button class="ldsp-melon-setting-btn ldsp-melon-btn-danger" id="melon-clear-all-data">é‡ç½®</button>
                            </div>
                        </div>
                    </div>`;

                if (isEditing) {
                    body.querySelector('#melon-save-settings').addEventListener('click', () => {
                        const apiUrl = body.querySelector('#melon-api-url').value.trim();
                        const apiKey = body.querySelector('#melon-api-key').value.trim();
                        const model = body.querySelector('#melon-model').value.trim() || 'gpt-4o-mini';
                        
                        // éªŒè¯å¿…å¡«é¡¹
                        if (!apiUrl) {
                            this.renderer?.showToast('âš ï¸ è¯·è¾“å…¥ API åœ°å€');
                            return;
                        }
                        if (!apiKey) {
                            this.renderer?.showToast('âš ï¸ è¯·è¾“å…¥ API Key');
                            return;
                        }
                        
                        // ç®€å•éªŒè¯ URL æ ¼å¼
                        if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
                            this.renderer?.showToast('âš ï¸ API åœ°å€æ ¼å¼ä¸æ­£ç¡®');
                            return;
                        }
                        
                        this.config.apiUrl = apiUrl;
                        this.config.apiKey = apiKey;
                        this.config.model = model;
                        this._saveConfig();
                        this._isEditing = false;
                        this.renderer?.showToast('âœ… è®¾ç½®å·²ä¿å­˜');
                        this._renderSettings();  // é‡æ–°æ¸²æŸ“ä¸ºä¸å¯ç¼–è¾‘çŠ¶æ€
                    });
                } else {
                    body.querySelector('#melon-edit-settings').addEventListener('click', () => {
                        this._isEditing = true;
                        this._renderSettings();  // é‡æ–°æ¸²æŸ“ä¸ºå¯ç¼–è¾‘çŠ¶æ€
                    });
                }
                
                // ä¿å­˜æç¤ºè¯æŒ‰é’®
                body.querySelector('#melon-save-prompts')?.addEventListener('click', () => {
                    const promptBrief = body.querySelector('#melon-prompt-brief').value.trim();
                    const promptDetailed = body.querySelector('#melon-prompt-detailed').value.trim();
                    this.config.promptBrief = promptBrief;
                    this.config.promptDetailed = promptDetailed;
                    this._saveConfig();
                    this.renderer?.showToast('âœ… æç¤ºè¯å·²ä¿å­˜');
                    // æ›´æ–°çŠ¶æ€æç¤º
                    const hintBrief = body.querySelector('#melon-prompt-brief')?.parentElement?.querySelector('.ldsp-melon-setting-hint');
                    const hintDetailed = body.querySelector('#melon-prompt-detailed')?.parentElement?.querySelector('.ldsp-melon-setting-hint');
                    if (hintBrief) hintBrief.textContent = promptBrief ? 'âœ… å·²è‡ªå®šä¹‰' : 'ğŸ’¡ ä½¿ç”¨é»˜è®¤æç¤ºè¯';
                    if (hintDetailed) hintDetailed.textContent = promptDetailed ? 'âœ… å·²è‡ªå®šä¹‰' : 'ğŸ’¡ ä½¿ç”¨é»˜è®¤æç¤ºè¯';
                });
                
                // æ¢å¤é»˜è®¤æç¤ºè¯
                body.querySelectorAll('.ldsp-melon-prompt-reset').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const type = btn.dataset.prompt;
                        if (type === 'brief') {
                            body.querySelector('#melon-prompt-brief').value = '';
                            this.config.promptBrief = '';
                        } else {
                            body.querySelector('#melon-prompt-detailed').value = '';
                            this.config.promptDetailed = '';
                        }
                        this._saveConfig();
                        this.renderer?.showToast('âœ… å·²æ¢å¤é»˜è®¤æç¤ºè¯');
                    });
                });
                
                // é‡ç½®é…ç½®æŒ‰é’®ï¼ˆåªæ¸…ç©ºé…ç½®å’Œæç¤ºè¯ï¼Œä¸æ¸…ç©ºå†å²è®°å½•ï¼‰
                body.querySelector('#melon-clear-all-data')?.addEventListener('click', () => {
                    this._showConfirm('ç¡®å®šè¦é‡ç½®é…ç½®å—ï¼Ÿ<br>å°†æ¸…ç©º API é…ç½®å’Œè‡ªå®šä¹‰æç¤ºè¯ï¼Œå†å²è®°å½•ä¸å—å½±å“ã€‚', () => {
                        // æ¸…ç©ºé…ç½®å’Œæç¤ºè¯
                        this.config = { apiUrl: '', apiKey: '', model: 'gpt-4o-mini', promptBrief: '', promptDetailed: '' };
                        this._saveConfig();
                        this._isEditing = false;
                        this.renderer?.showToast('âœ… é…ç½®å·²é‡ç½®');
                        this._renderSettings();
                    });
                });
            }

            _renderHistory() {
                const body = this.overlay.querySelector('.ldsp-melon-body');
                
                if (this.history.length === 0) {
                    body.innerHTML = `
                        <div class="ldsp-melon-history-empty">
                            <div class="ldsp-melon-history-empty-icon">ğŸ“­</div>
                            <div class="ldsp-melon-history-empty-text">æš‚æ— å†å²è®°å½•</div>
                            <div class="ldsp-melon-history-empty-hint">ä½¿ç”¨åƒç“œåŠ©æ‰‹æ€»ç»“è¯é¢˜åä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡Œ</div>
                            <div class="ldsp-melon-history-storage-hint">ğŸ’¾ æ•°æ®ä»…å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°</div>
                        </div>`;
                    return;
                }
                
                const historyHtml = this.history.map((h, idx) => {
                    const date = new Date(h.timestamp);
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    const modeLabel = h.mode === 'brief' ? 'ç®€ç•¥' : 'è¯¦ç»†';
                    const previewText = h.summary.slice(0, 100).replace(/\n/g, ' ') + (h.summary.length > 100 ? '...' : '');
                    
                    return `
                        <div class="ldsp-melon-history-item" data-index="${idx}">
                            <div class="ldsp-melon-history-item-header">
                                <span class="ldsp-melon-history-item-title" title="${Utils.escapeHtml(h.title)}">${Utils.escapeHtml(h.title)}</span>
                                <span class="ldsp-melon-history-item-meta">
                                    <span class="ldsp-melon-history-mode ${h.mode}">${modeLabel}</span>
                                    <span class="ldsp-melon-history-date">${dateStr}</span>
                                </span>
                            </div>
                            <div class="ldsp-melon-history-item-preview">${Utils.escapeHtml(previewText)}</div>
                            <div class="ldsp-melon-history-item-actions">
                                <button class="ldsp-melon-history-btn ldsp-melon-history-view" data-idx="${idx}" title="æŸ¥çœ‹å®Œæ•´å†…å®¹">ğŸ‘ï¸ æŸ¥çœ‹</button>
                                <button class="ldsp-melon-history-btn ldsp-melon-history-expand" data-idx="${idx}" title="å±•å¼€å¤§çª—å£æŸ¥çœ‹">ğŸ” å±•å¼€</button>
                                <button class="ldsp-melon-history-btn ldsp-melon-history-copy" data-idx="${idx}" title="å¤åˆ¶åˆ°å‰ªè´´æ¿">ğŸ“‹ å¤åˆ¶</button>
                                <button class="ldsp-melon-history-btn ldsp-melon-history-goto" data-topic="${h.topicId}" title="è·³è½¬åˆ°è¯é¢˜">ğŸ”— è¯é¢˜</button>
                                <button class="ldsp-melon-history-btn ldsp-melon-history-delete" data-idx="${idx}" title="åˆ é™¤æ­¤è®°å½•">ğŸ—‘ï¸</button>
                            </div>
                        </div>`;
                }).join('');
                
                body.innerHTML = `
                    <div class="ldsp-melon-history">
                        <div class="ldsp-melon-history-header">
                            <div class="ldsp-melon-history-header-left">
                                <span class="ldsp-melon-history-count">å…± ${this.history.length} æ¡è®°å½•</span>
                                <span class="ldsp-melon-history-storage-badge">ğŸ’¾ æœ¬åœ°å­˜å‚¨</span>
                            </div>
                            <button class="ldsp-melon-history-clear-all" id="melon-clear-history">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
                        </div>
                        <div class="ldsp-melon-history-list">
                            ${historyHtml}
                        </div>
                    </div>`;
                
                // ç»‘å®šäº‹ä»¶ - ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤æ¡†
                body.querySelector('#melon-clear-history').addEventListener('click', () => {
                    this._showConfirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚', () => {
                        this._clearHistory();
                        this.renderer?.showToast('âœ… å†å²è®°å½•å·²æ¸…ç©º');
                        this._renderHistory();
                    });
                });
                
                body.querySelectorAll('.ldsp-melon-history-view').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        this._showHistoryDetail(idx);
                    });
                });
                
                body.querySelectorAll('.ldsp-melon-history-copy').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const idx = parseInt(btn.dataset.idx);
                        const record = this.history[idx];
                        if (record) {
                            try {
                                await navigator.clipboard.writeText(record.summary);
                                btn.textContent = 'âœ… å·²å¤åˆ¶';
                                setTimeout(() => { btn.innerHTML = 'ğŸ“‹ å¤åˆ¶'; }, 1500);
                            } catch (e) {
                                Logger.error('[MelonHelper] Copy history failed:', e);
                            }
                        }
                    });
                });
                
                body.querySelectorAll('.ldsp-melon-history-goto').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const topicId = btn.dataset.topic;
                        window.open(`${location.origin}/t/${topicId}`, '_blank');
                    });
                });
                
                body.querySelectorAll('.ldsp-melon-history-delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        this.history.splice(idx, 1);
                        this._saveHistory();
                        this.renderer?.showToast('âœ… å·²åˆ é™¤');
                        this._renderHistory();
                    });
                });
                
                // ç»‘å®šå±•å¼€æŒ‰é’® - æ‰“å¼€ç‹¬ç«‹å¤§çª—å£
                body.querySelectorAll('.ldsp-melon-history-expand').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        const record = this.history[idx];
                        if (record) {
                            this._showViewer({
                                title: record.title,
                                summary: record.summary,
                                mode: record.mode,
                                topicId: record.topicId,
                                timestamp: record.timestamp
                            });
                        }
                    });
                });
            }

            _showHistoryDetail(idx) {
                const record = this.history[idx];
                if (!record) return;
                
                const body = this.overlay.querySelector('.ldsp-melon-body');
                const date = new Date(record.timestamp);
                const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                const modeLabel = record.mode === 'brief' ? 'ç®€ç•¥æ¨¡å¼' : 'è¯¦ç»†æ¨¡å¼';
                
                body.innerHTML = `
                    <div class="ldsp-melon-history-detail">
                        <div class="ldsp-melon-history-detail-header">
                            <button class="ldsp-melon-history-back" id="melon-history-back">â† è¿”å›åˆ—è¡¨</button>
                            <div class="ldsp-melon-history-detail-actions">
                                <button class="ldsp-melon-history-expand-btn" id="melon-history-expand">ğŸ” å±•å¼€</button>
                                <button class="ldsp-melon-history-copy-all" id="melon-history-copy-all">ğŸ“‹ å¤åˆ¶</button>
                            </div>
                        </div>
                        <div class="ldsp-melon-history-detail-info">
                            <div class="ldsp-melon-history-detail-title">${Utils.escapeHtml(record.title)}</div>
                            <div class="ldsp-melon-history-detail-meta">${modeLabel} Â· ${dateStr}</div>
                        </div>
                        <div class="ldsp-melon-history-detail-content">
                            ${this._renderMarkdown(record.summary)}
                        </div>
                    </div>`;
                
                body.querySelector('#melon-history-back').addEventListener('click', () => {
                    this._renderHistory();
                });
                
                // å±•å¼€æŸ¥çœ‹æŒ‰é’®
                body.querySelector('#melon-history-expand').addEventListener('click', () => {
                    this._showViewer({
                        title: record.title,
                        summary: record.summary,
                        mode: record.mode,
                        topicId: record.topicId,
                        timestamp: record.timestamp
                    });
                });
                
                body.querySelector('#melon-history-copy-all').addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(record.summary);
                        const btn = body.querySelector('#melon-history-copy-all');
                        btn.textContent = 'âœ… å·²å¤åˆ¶';
                        setTimeout(() => { btn.innerHTML = 'ğŸ“‹ å¤åˆ¶'; }, 1500);
                    } catch (e) {
                        Logger.error('[MelonHelper] Copy detail failed:', e);
                    }
                });
            }

            destroy() {
                this._stopUrlWatch();
                this._closeViewer();
                if (this._abortController) {
                    this._abortController.abort();
                    this._abortController = null;
                }
                if (this.overlay) {
                    this.overlay.remove();
                    this.overlay = null;
                }
            }
            
            // æ˜¾ç¤ºå…¨å±å¯è°ƒæ•´å¤§å°çš„æŸ¥çœ‹å™¨ï¼ˆæ”¯æŒå¯¹è¯åŠŸèƒ½ï¼‰
            _showViewer(data) {
                // ç§»é™¤å·²å­˜åœ¨çš„ viewer
                this._closeViewer();
                
                const dateStr = data.timestamp 
                    ? new Date(data.timestamp).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                    : 'åˆšåˆš';
                const modeLabel = data.mode === 'brief' ? 'ç®€ç•¥' : 'è¯¦ç»†';
                
                // æ£€æµ‹å½“å‰ä¸»é¢˜
                const isLightTheme = document.querySelector('#ldsp-panel.light') !== null;
                
                // åˆå§‹åŒ–å¯¹è¯å†å²
                this._chatMessages = [
                    { role: 'system', content: `ä½ æ˜¯ä¸€ä¸ªå¸®åŠ©ç”¨æˆ·ç†è§£è®ºå›å¸–å­å†…å®¹çš„åŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯å¸–å­çš„æ€»ç»“ï¼š\n\n${data.summary}\n\nè¯·åŸºäºè¿™ä¸ªæ€»ç»“å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœé—®é¢˜è¶…å‡ºæ€»ç»“å†…å®¹èŒƒå›´ï¼Œè¯·å‘ŠçŸ¥ç”¨æˆ·ã€‚` },
                    { role: 'assistant', content: data.summary }
                ];
                this._chatAbortController = null;
                
                const overlay = document.createElement('div');
                overlay.className = 'ldsp-melon-viewer-overlay' + (isLightTheme ? ' light' : '');
                overlay.innerHTML = `
                    <div class="ldsp-melon-viewer" style="width:700px;height:600px;">
                        <div class="ldsp-melon-viewer-header">
                            <div class="ldsp-melon-viewer-title">
                                <span class="ldsp-melon-viewer-title-icon">ğŸˆ</span>
                                <span>åƒç“œè¯¦æƒ…</span>
                            </div>
                            <div class="ldsp-melon-viewer-actions">
                                <div class="ldsp-melon-font-btn" id="viewer-font" title="è°ƒæ•´å­—ä½“å¤§å°">
                                    <span>Aa</span>
                                    <div class="ldsp-melon-font-dropdown" id="font-dropdown">
                                        <div class="ldsp-melon-font-option" data-size="xs">å°</div>
                                        <div class="ldsp-melon-font-option" data-size="sm">è¾ƒå°</div>
                                        <div class="ldsp-melon-font-option active" data-size="md">æ ‡å‡†</div>
                                        <div class="ldsp-melon-font-option" data-size="lg">è¾ƒå¤§</div>
                                        <div class="ldsp-melon-font-option" data-size="xl">å¤§</div>
                                    </div>
                                </div>
                                <button class="ldsp-melon-viewer-btn" id="viewer-copy" title="å¤åˆ¶å…¨éƒ¨å†…å®¹">ğŸ“‹</button>
                                <button class="ldsp-melon-viewer-btn" id="viewer-goto" title="è·³è½¬åˆ°è¯é¢˜">ğŸ”—</button>
                                <button class="ldsp-melon-viewer-btn ldsp-melon-viewer-close" id="viewer-close" title="å…³é—­">âœ•</button>
                            </div>
                        </div>
                        <div class="ldsp-melon-viewer-body">
                            <div class="ldsp-melon-viewer-info">
                                <div class="ldsp-melon-viewer-topic-title">${Utils.escapeHtml(data.title)}</div>
                                <div class="ldsp-melon-viewer-meta">
                                    <span class="ldsp-melon-viewer-mode ${data.mode}">${modeLabel}æ¨¡å¼</span>
                                    <span>${dateStr}</span>
                                </div>
                            </div>
                            <div class="ldsp-melon-viewer-content" id="viewer-chat-content">
                                <div class="ldsp-melon-chat-msg assistant">
                                    <div class="ldsp-melon-chat-msg-label">ğŸ“ AI æ€»ç»“</div>
                                    <div class="ldsp-melon-chat-msg-content">${this._renderMarkdown(data.summary)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="ldsp-melon-viewer-chat">
                            <div class="ldsp-melon-chat-input-wrap">
                                <input type="text" class="ldsp-melon-chat-input" id="viewer-chat-input" placeholder="è¾“å…¥é—®é¢˜ç»§ç»­è¿½é—®..." />
                                <button class="ldsp-melon-chat-send" id="viewer-chat-send" title="å‘é€">
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                </button>
                            </div>
                            <div class="ldsp-melon-chat-hint">ğŸ’¡ åŸºäºä»¥ä¸Šæ€»ç»“å†…å®¹è¿›è¡Œè¿½é—®</div>
                        </div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-e"></div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-s"></div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-se"></div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-w"></div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-n"></div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-nw"></div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-ne"></div>
                        <div class="ldsp-melon-resize-handle ldsp-melon-resize-handle-sw"></div>
                    </div>`;
                
                document.body.appendChild(overlay);
                this._viewerOverlay = overlay;
                
                const viewer = overlay.querySelector('.ldsp-melon-viewer');
                const header = overlay.querySelector('.ldsp-melon-viewer-header');
                const chatInput = overlay.querySelector('#viewer-chat-input');
                const chatSendBtn = overlay.querySelector('#viewer-chat-send');
                const chatContent = overlay.querySelector('#viewer-chat-content');
                
                // å¯¹è¯å‘é€åŠŸèƒ½
                const sendChat = async () => {
                    const question = chatInput.value.trim();
                    if (!question) return;
                    if (!this.config.apiUrl || !this.config.apiKey) {
                        this.renderer?.showToast('âš ï¸ è¯·å…ˆé…ç½® API');
                        return;
                    }
                    
                    chatInput.value = '';
                    chatInput.disabled = true;
                    chatSendBtn.disabled = true;
                    chatSendBtn.classList.add('loading');
                    
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    const userMsgEl = document.createElement('div');
                    userMsgEl.className = 'ldsp-melon-chat-msg user';
                    userMsgEl.innerHTML = `
                        <div class="ldsp-melon-chat-msg-label">ğŸ™‹ ä½ çš„é—®é¢˜</div>
                        <div class="ldsp-melon-chat-msg-content">${Utils.escapeHtml(question)}</div>`;
                    chatContent.appendChild(userMsgEl);
                    
                    // æ·»åŠ  AI å“åº”å ä½
                    const aiMsgEl = document.createElement('div');
                    aiMsgEl.className = 'ldsp-melon-chat-msg assistant';
                    aiMsgEl.innerHTML = `
                        <div class="ldsp-melon-chat-msg-label">ğŸ¤– AI å›å¤</div>
                        <div class="ldsp-melon-chat-msg-content"><span class="ldsp-melon-chat-typing">æ€è€ƒä¸­...</span></div>`;
                    chatContent.appendChild(aiMsgEl);
                    chatContent.scrollTop = chatContent.scrollHeight;
                    
                    // æ›´æ–°å¯¹è¯å†å²
                    this._chatMessages.push({ role: 'user', content: question });
                    
                    let aiResponse = '';
                    this._chatAbortController = new AbortController();
                    
                    try {
                        await this._callAIStream(null, null, this._chatAbortController.signal, (chunk) => {
                            aiResponse += chunk;
                            const contentEl = aiMsgEl.querySelector('.ldsp-melon-chat-msg-content');
                            if (contentEl) {
                                contentEl.innerHTML = this._renderMarkdown(aiResponse);
                                chatContent.scrollTop = chatContent.scrollHeight;
                            }
                        }, this._chatMessages);
                        
                        // ä¿å­˜ AI å“åº”åˆ°å¯¹è¯å†å²
                        this._chatMessages.push({ role: 'assistant', content: aiResponse });
                        
                    } catch (e) {
                        Logger.error('[MelonHelper] Chat error:', e);
                        const contentEl = aiMsgEl.querySelector('.ldsp-melon-chat-msg-content');
                        if (contentEl) {
                            if (e.name === 'AbortError') {
                                contentEl.innerHTML = '<span style="color:var(--txt-mut)">å·²å–æ¶ˆ</span>';
                            } else {
                                contentEl.innerHTML = `<span style="color:#ef4444">âŒ ${Utils.escapeHtml(e.message || 'è¯·æ±‚å¤±è´¥')}</span>`;
                            }
                        }
                        // ç§»é™¤å¤±è´¥çš„ç”¨æˆ·æ¶ˆæ¯
                        this._chatMessages.pop();
                    } finally {
                        chatInput.disabled = false;
                        chatSendBtn.disabled = false;
                        chatSendBtn.classList.remove('loading');
                        this._chatAbortController = null;
                        chatInput.focus();
                    }
                };
                
                chatSendBtn.addEventListener('click', sendChat);
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChat();
                    }
                });
                
                // å…³é—­æŒ‰é’®
                overlay.querySelector('#viewer-close').addEventListener('click', () => this._closeViewer());
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) this._closeViewer();
                });
                
                // ESC å…³é—­
                this._viewerEscHandler = (e) => {
                    if (e.key === 'Escape') this._closeViewer();
                };
                document.addEventListener('keydown', this._viewerEscHandler);
                
                // å¤åˆ¶æŒ‰é’® - å¤åˆ¶æ‰€æœ‰å¯¹è¯å†…å®¹
                overlay.querySelector('#viewer-copy').addEventListener('click', async () => {
                    try {
                        // æ”¶é›†æ‰€æœ‰å¯¹è¯å†…å®¹
                        let allContent = `è¯é¢˜ï¼š${data.title}\n\n`;
                        this._chatMessages.forEach(msg => {
                            if (msg.role === 'assistant') {
                                allContent += `ã€AIã€‘\n${msg.content}\n\n`;
                            } else if (msg.role === 'user') {
                                allContent += `ã€é—®ã€‘${msg.content}\n\n`;
                            }
                        });
                        await navigator.clipboard.writeText(allContent.trim());
                        const btn = overlay.querySelector('#viewer-copy');
                        btn.textContent = 'âœ…';
                        setTimeout(() => { btn.textContent = 'ğŸ“‹'; }, 1500);
                    } catch (e) {
                        Logger.error('[MelonHelper] Copy viewer content failed:', e);
                    }
                });
                
                // è·³è½¬æŒ‰é’®
                overlay.querySelector('#viewer-goto').addEventListener('click', () => {
                    if (data.topicId) {
                        window.open(`${location.origin}/t/${data.topicId}`, '_blank');
                    }
                });
                
                // å­—ä½“å¤§å°è°ƒèŠ‚
                const fontBtn = overlay.querySelector('#viewer-font');
                const fontDropdown = overlay.querySelector('#font-dropdown');
                const viewerContent = overlay.querySelector('#viewer-chat-content');
                
                // ä»å­˜å‚¨ä¸­è¯»å–å­—ä½“å¤§å°è®¾ç½®
                const savedFontSize = GM_getValue('ldsp_melon_font_size', 'md');
                if (savedFontSize !== 'md') {
                    viewerContent.className = `ldsp-melon-viewer-content font-${savedFontSize}`;
                    fontDropdown.querySelectorAll('.ldsp-melon-font-option').forEach(opt => {
                        opt.classList.toggle('active', opt.dataset.size === savedFontSize);
                    });
                }
                
                fontBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    fontDropdown.classList.toggle('show');
                });
                
                fontDropdown.querySelectorAll('.ldsp-melon-font-option').forEach(opt => {
                    opt.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const size = opt.dataset.size;
                        // æ›´æ–°æ ·å¼
                        viewerContent.className = `ldsp-melon-viewer-content font-${size}`;
                        // æ›´æ–°é€‰ä¸­çŠ¶æ€
                        fontDropdown.querySelectorAll('.ldsp-melon-font-option').forEach(o => {
                            o.classList.toggle('active', o.dataset.size === size);
                        });
                        // ä¿å­˜è®¾ç½®
                        GM_setValue('ldsp_melon_font_size', size);
                        // å…³é—­ä¸‹æ‹‰
                        fontDropdown.classList.remove('show');
                    });
                });
                
                // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰èœå•
                overlay.addEventListener('click', () => {
                    fontDropdown.classList.remove('show');
                });
                
                // æ‹–æ‹½ç§»åŠ¨
                let isDragging = false;
                let startX, startY, startLeft, startTop;
                
                header.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.ldsp-melon-viewer-btn')) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = viewer.getBoundingClientRect();
                    startLeft = rect.left;
                    startTop = rect.top;
                    viewer.style.position = 'fixed';
                    viewer.style.left = `${startLeft}px`;
                    viewer.style.top = `${startTop}px`;
                    viewer.style.transform = 'none';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', this._viewerMoveHandler = (e) => {
                    if (!isDragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    viewer.style.left = `${startLeft + dx}px`;
                    viewer.style.top = `${startTop + dy}px`;
                });
                
                document.addEventListener('mouseup', this._viewerUpHandler = () => {
                    isDragging = false;
                });
                
                // è°ƒæ•´å¤§å°
                let isResizing = false;
                let resizeDir = '';
                let resizeStartX, resizeStartY, resizeStartW, resizeStartH, resizeStartL, resizeStartT;
                
                overlay.querySelectorAll('.ldsp-melon-resize-handle').forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        resizeDir = handle.className.replace('ldsp-melon-resize-handle ldsp-melon-resize-handle-', '');
                        resizeStartX = e.clientX;
                        resizeStartY = e.clientY;
                        const rect = viewer.getBoundingClientRect();
                        resizeStartW = rect.width;
                        resizeStartH = rect.height;
                        resizeStartL = rect.left;
                        resizeStartT = rect.top;
                        viewer.style.position = 'fixed';
                        viewer.style.left = `${resizeStartL}px`;
                        viewer.style.top = `${resizeStartT}px`;
                        viewer.style.transform = 'none';
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                document.addEventListener('mousemove', this._viewerResizeHandler = (e) => {
                    if (!isResizing) return;
                    const dx = e.clientX - resizeStartX;
                    const dy = e.clientY - resizeStartY;
                    let newW = resizeStartW, newH = resizeStartH;
                    let newL = resizeStartL, newT = resizeStartT;
                    
                    if (resizeDir.includes('e')) newW = Math.max(320, resizeStartW + dx);
                    if (resizeDir.includes('w')) {
                        newW = Math.max(320, resizeStartW - dx);
                        newL = resizeStartL + (resizeStartW - newW);
                    }
                    if (resizeDir.includes('s')) newH = Math.max(240, resizeStartH + dy);
                    if (resizeDir.includes('n')) {
                        newH = Math.max(240, resizeStartH - dy);
                        newT = resizeStartT + (resizeStartH - newH);
                    }
                    
                    viewer.style.width = `${newW}px`;
                    viewer.style.height = `${newH}px`;
                    viewer.style.left = `${newL}px`;
                    viewer.style.top = `${newT}px`;
                });
                
                document.addEventListener('mouseup', this._viewerResizeUpHandler = () => {
                    isResizing = false;
                });
            }
            
            _closeViewer() {
                // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å¯¹è¯è¯·æ±‚
                if (this._chatAbortController) {
                    this._chatAbortController.abort();
                    this._chatAbortController = null;
                }
                // æ¸…ç†å¯¹è¯å†å²
                this._chatMessages = null;
                
                if (this._viewerOverlay) {
                    this._viewerOverlay.remove();
                    this._viewerOverlay = null;
                }
                if (this._viewerEscHandler) {
                    document.removeEventListener('keydown', this._viewerEscHandler);
                    this._viewerEscHandler = null;
                }
                if (this._viewerMoveHandler) {
                    document.removeEventListener('mousemove', this._viewerMoveHandler);
                    this._viewerMoveHandler = null;
                }
                if (this._viewerUpHandler) {
                    document.removeEventListener('mouseup', this._viewerUpHandler);
                    this._viewerUpHandler = null;
                }
                if (this._viewerResizeHandler) {
                    document.removeEventListener('mousemove', this._viewerResizeHandler);
                    this._viewerResizeHandler = null;
                }
                if (this._viewerResizeUpHandler) {
                    document.removeEventListener('mouseup', this._viewerResizeUpHandler);
                    this._viewerResizeUpHandler = null;
                }
            }
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            _showConfirm(message, onConfirm) {
                const existingDialog = this.overlay.querySelector('.ldsp-melon-confirm-dialog');
                if (existingDialog) existingDialog.remove();
                
                const dialog = document.createElement('div');
                dialog.className = 'ldsp-melon-confirm-dialog';
                dialog.innerHTML = `
                    <div class="ldsp-melon-confirm-content">
                        <div class="ldsp-melon-confirm-icon">âš ï¸</div>
                        <div class="ldsp-melon-confirm-message">${message}</div>
                        <div class="ldsp-melon-confirm-actions">
                            <button class="ldsp-melon-confirm-btn ldsp-melon-confirm-cancel">å–æ¶ˆ</button>
                            <button class="ldsp-melon-confirm-btn ldsp-melon-confirm-ok">ç¡®è®¤</button>
                        </div>
                    </div>`;
                
                dialog.querySelector('.ldsp-melon-confirm-cancel').addEventListener('click', () => dialog.remove());
                dialog.querySelector('.ldsp-melon-confirm-ok').addEventListener('click', () => {
                    dialog.remove();
                    onConfirm();
                });
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) dialog.remove();
                });
                
                this.overlay.appendChild(dialog);
            }
        }

        // ==================== å…³æ³¨/ç²‰ä¸ç®¡ç†å™¨ ====================
        class FollowManager {
            static CACHE_KEY = 'ldsp_follow_cache';
            
            // SVG å›¾æ ‡å®šä¹‰
            static ICONS = {
                // å…³æ³¨ï¼šäºº+å³ç®­å¤´ï¼ˆè¡¨ç¤ºæˆ‘å…³æ³¨çš„äºº/å‘å¤–å…³æ³¨ï¼‰
                following: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="10" cy="8" r="4"/><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M19 8h4m-2-2v4"/></svg>',
                // ç²‰ä¸ï¼šäºº+å¿ƒå½¢ï¼ˆè¡¨ç¤ºå–œæ¬¢æˆ‘çš„äººï¼‰
                followers: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="10" cy="8" r="4"/><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M19.5 10.5c-.6-.6-1.5-.6-2.1 0l-.4.4-.4-.4c-.6-.6-1.5-.6-2.1 0-.6.6-.6 1.5 0 2.1l2.5 2.4 2.5-2.4c.6-.6.6-1.5 0-2.1z"/></svg>',
                // ç”¨æˆ·ç»„å›¾æ ‡ï¼ˆç”¨äºæ ‡é¢˜ï¼‰
                users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/><circle cx="17" cy="10" r="3"/><path d="M21 21v-1.5a3 3 0 0 0-3-3h-1"/></svg>',
                // å•äººå›¾æ ‡ï¼ˆç”¨äºç©ºçŠ¶æ€ï¼‰
                user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4"/><path d="M4 21v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2"/></svg>'
            };
            
            constructor(network, storage, panelBody, renderer) {
                this.network = network;
                this.storage = storage;
                this.panelBody = panelBody;
                this.renderer = renderer;
                this.overlay = null;
                this.following = [];
                this.followers = [];
                this.followingCount = 0;
                this.followersCount = 0;
                this.cakedate = null;
                this.animatedAvatar = null;
                this._loaded = false;
                this._loading = false;
                this._profileLoaded = false;
            }

            async init() {
                // å…ˆä»ç¼“å­˜åŠ è½½æ•°é‡æ˜¾ç¤º
                this._loadFromCache();
                this._createOverlay();
            }
            
            // ä»æœ¬åœ°ç¼“å­˜åŠ è½½
            _loadFromCache() {
                try {
                    const username = this.storage.getUser();
                    if (!username) return;
                    
                    const cacheKey = `${FollowManager.CACHE_KEY}_${CURRENT_SITE.prefix}_${username}`;
                    const cached = GM_getValue(cacheKey, null);
                    if (cached && typeof cached === 'object') {
                        this.followingCount = cached.followingCount || 0;
                        this.followersCount = cached.followersCount || 0;
                        this.cakedate = cached.cakedate || null;
                        this.animatedAvatar = cached.animatedAvatar || null;
                        // ç«‹å³æ›´æ–°æ˜¾ç¤º
                        this._updateStats();
                        this._updateDays();
                    }
                } catch (e) {
                    // ç¼“å­˜è¯»å–å¤±è´¥ï¼Œå¿½ç•¥
                }
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            _saveToCache() {
                try {
                    const username = this.storage.getUser();
                    if (!username) return;
                    
                    const cacheKey = `${FollowManager.CACHE_KEY}_${CURRENT_SITE.prefix}_${username}`;
                    GM_setValue(cacheKey, {
                        followingCount: this.followingCount,
                        followersCount: this.followersCount,
                        cakedate: this.cakedate,
                        animatedAvatar: this.animatedAvatar,
                        time: Date.now()
                    });
                } catch (e) {
                    // ç¼“å­˜å†™å…¥å¤±è´¥ï¼Œå¿½ç•¥
                }
            }

            _createOverlay() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'ldsp-follow-overlay';
                this.overlay.innerHTML = `
                    <div class="ldsp-follow-header">
                        <div class="ldsp-follow-title">${FollowManager.ICONS.users} å…³æ³¨ä¸ç²‰ä¸</div>
                        <div class="ldsp-follow-close">Ã—</div>
                    </div>
                    <div class="ldsp-follow-tabs">
                        <div class="ldsp-follow-tab active" data-tab="following">
                            <span class="ldsp-follow-tab-icon">${FollowManager.ICONS.following}</span>
                            <span class="ldsp-follow-tab-text">å…³æ³¨</span>
                            <span class="ldsp-follow-tab-count">${this.followingCount}</span>
                        </div>
                        <div class="ldsp-follow-tab" data-tab="followers">
                            <span class="ldsp-follow-tab-icon">${FollowManager.ICONS.followers}</span>
                            <span class="ldsp-follow-tab-text">ç²‰ä¸</span>
                            <span class="ldsp-follow-tab-count">${this.followersCount}</span>
                        </div>
                    </div>
                    <div class="ldsp-follow-body"></div>`;
                if (this.panelBody) {
                    this.panelBody.appendChild(this.overlay);
                }
                this._bindEvents();
            }

            _bindEvents() {
                this.overlay.querySelector('.ldsp-follow-close').addEventListener('click', () => this.hide());
                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('show')) this.hide();
                });
                this.overlay.querySelectorAll('.ldsp-follow-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.overlay.querySelectorAll('.ldsp-follow-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const tabName = tab.dataset.tab;
                        this._renderList(tabName);
                    });
                });
            }

            async loadData(forceRefresh = false) {
                if (this._loading) return;
                if (this._loaded && !forceRefresh) return;
                
                this._loading = true;
                const username = this.storage.getUser();
                if (!username) {
                    this._loading = false;
                    return;
                }

                // ä¿å­˜æ—§çš„æ•°é‡ç”¨äºæ¯”è¾ƒ
                const oldFollowingCount = this.followingCount;
                const oldFollowersCount = this.followersCount;

                const baseUrl = `https://${CURRENT_SITE.domain}`;
                
                try {
                    const [followingRes, followersRes] = await Promise.all([
                        this.network.fetchJson(`${baseUrl}/u/${username}/follow/following`, { headers: buildAuthHeaders(`${baseUrl}/u/${username}/follow/following`, { 'Accept': 'application/json' }) }),
                        this.network.fetchJson(`${baseUrl}/u/${username}/follow/followers`, { headers: buildAuthHeaders(`${baseUrl}/u/${username}/follow/followers`, { 'Accept': 'application/json' }) })
                    ]);
                    
                    this.following = Array.isArray(followingRes) ? followingRes : [];
                    this.followers = Array.isArray(followersRes) ? followersRes : [];
                    this.followingCount = this.following.length;
                    this.followersCount = this.followers.length;
                    this._loaded = true;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ–åˆ™æ›´æ–°ç¼“å­˜
                    if (this.followingCount !== oldFollowingCount || this.followersCount !== oldFollowersCount) {
                        this._saveToCache();
                    }
                    
                    // æ›´æ–°æ˜¾ç¤º
                    this._updateStats();
                    this._updateTabCounts();
                } catch (e) {
                    Logger.warn('Failed to load follow data:', e.message);
                    // åŠ è½½å¤±è´¥æ—¶ä¿æŒç¼“å­˜çš„æ•°é‡ï¼Œä¸æ¸…é›¶
                } finally {
                    this._loading = false;
                }
            }
            
            // åŠ è½½ç”¨æˆ· profile æ•°æ®ï¼ˆcakedate, animated_avatarï¼‰
            async loadProfile() {
                if (this._profileLoaded) return;
                
                const username = this.storage.getUser();
                if (!username) return;
                
                const baseUrl = `https://${CURRENT_SITE.domain}`;
                
                try {
                    const profileUrl = `${baseUrl}/u/${encodeURIComponent(username)}.json`;
                    const profileRes = await this.network.fetchJson(profileUrl, { headers: buildAuthHeaders(profileUrl, { 'Accept': 'application/json' }) });
                    if (profileRes && profileRes.user) {
                        const user = profileRes.user;
                        let hasChanges = false;
                        
                        // è·å– cakedate
                        if (user.cakedate && user.cakedate !== this.cakedate) {
                            this.cakedate = user.cakedate;
                            this._updateDays();
                            hasChanges = true;
                        }
                        
                        // è·å– animated_avatar
                        if (user.animated_avatar) {
                            const animatedUrl = user.animated_avatar.startsWith('http') 
                                ? user.animated_avatar 
                                : `${baseUrl}${user.animated_avatar}`;
                            // åªæœ‰åŠ¨æ€å¤´åƒå˜åŒ–æ—¶æ‰æ›´æ–°
                            if (animatedUrl !== this.animatedAvatar) {
                                this.animatedAvatar = animatedUrl;
                                // é€šè¿‡ renderer æ¸²æŸ“å¤´åƒ
                                if (this.renderer) {
                                    this.renderer.renderAvatar(animatedUrl);
                                }
                                hasChanges = true;
                            }
                        }
                        
                        this._profileLoaded = true;
                        if (hasChanges) {
                            this._saveToCache();
                        }
                    }
                } catch (e) {
                    Logger.warn('Failed to load user profile:', e.message);
                }
            }
            
            // æ›´æ–°æ³¨å†Œå¤©æ•°æ˜¾ç¤º
            _updateDays() {
                const daysNumEl = document.querySelector('.ldsp-join-days-num');
                const siteEl = document.querySelector('.ldsp-join-days-site');
                const joinDaysEl = document.querySelector('.ldsp-join-days');
                
                if (!this.cakedate) {
                    if (joinDaysEl) joinDaysEl.style.display = 'none';
                    return;
                }
                
                try {
                    const joinDate = new Date(this.cakedate);
                    const now = new Date();
                    const diffTime = Math.abs(now - joinDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const siteShort = CURRENT_SITE.domain === 'linux.do' ? 'Lç«™' : 'IFç«™';
                    const siteFull = CURRENT_SITE.domain === 'linux.do' ? 'Linux.do' : 'IDCFlare';
                    if (siteEl) siteEl.textContent = siteShort;
                    if (daysNumEl) daysNumEl.textContent = diffDays;
                    if (joinDaysEl) {
                        joinDaysEl.style.display = '';
                        // è®¾ç½®æ‚¬æµ®æç¤ºï¼šäºxxxxå¹´xxæœˆxxæ—¥åŠ å…¥xxç«™
                        const year = joinDate.getFullYear();
                        const month = joinDate.getMonth() + 1;
                        const day = joinDate.getDate();
                        joinDaysEl.title = `äº${year}å¹´${month}æœˆ${day}æ—¥åŠ å…¥${siteFull}`;
                    }
                } catch (e) {
                    if (joinDaysEl) joinDaysEl.style.display = 'none';
                }
            }

            _updateStats() {
                // æ”¯æŒæ–°çš„åˆå¹¶æŒ‰é’®æ ·å¼
                const combinedEl = document.querySelector('.ldsp-follow-combined');
                if (combinedEl) {
                    const followingNum = combinedEl.querySelector('.ldsp-follow-num-following');
                    const followersNum = combinedEl.querySelector('.ldsp-follow-num-followers');
                    if (followingNum) followingNum.textContent = this.followingCount;
                    if (followersNum) followersNum.textContent = this.followersCount;
                }
                // å…¼å®¹æ—§æ ·å¼
                const statsEl = document.querySelector('.ldsp-follow-stats');
                if (statsEl) {
                    const following = statsEl.querySelector('.ldsp-follow-stat-following .ldsp-follow-stat-num');
                    const followers = statsEl.querySelector('.ldsp-follow-stat-followers .ldsp-follow-stat-num');
                    if (following) following.textContent = this.followingCount;
                    if (followers) followers.textContent = this.followersCount;
                }
            }

            _updateTabCounts() {
                const followingTab = this.overlay.querySelector('.ldsp-follow-tab[data-tab="following"] .ldsp-follow-tab-count');
                const followersTab = this.overlay.querySelector('.ldsp-follow-tab[data-tab="followers"] .ldsp-follow-tab-count');
                if (followingTab) followingTab.textContent = this.followingCount;
                if (followersTab) followersTab.textContent = this.followersCount;
            }

            async show() {
                this.overlay.classList.add('show');
                const body = this.overlay.querySelector('.ldsp-follow-body');
                body.innerHTML = '<div class="ldsp-follow-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>';
                
                // åŠ è½½æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡åŠ è½½ï¼‰
                if (!this._loaded) {
                    await this.loadData();
                }
                
                // æ¸²æŸ“å½“å‰æ¿€æ´»çš„tab
                const activeTab = this.overlay.querySelector('.ldsp-follow-tab.active');
                this._renderList(activeTab?.dataset.tab || 'following');
            }

            hide() {
                this.overlay.classList.remove('show');
            }

            _renderList(type = 'following') {
                const body = this.overlay.querySelector('.ldsp-follow-body');
                const list = type === 'following' ? this.following : this.followers;
                const emptyText = type === 'following' ? 'è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº' : 'è¿˜æ²¡æœ‰ç²‰ä¸';
                const emptyIcon = type === 'following' ? FollowManager.ICONS.user : FollowManager.ICONS.followers;
                
                if (list.length === 0) {
                    body.innerHTML = `
                        <div class="ldsp-follow-empty">
                            <div class="ldsp-follow-empty-icon">${emptyIcon}</div>
                            <div>${emptyText}</div>
                        </div>`;
                    return;
                }

                const baseUrl = `https://${CURRENT_SITE.domain}`;
                body.innerHTML = `
                    <div class="ldsp-follow-list">
                        ${list.map(user => {
                            const avatarUrl = this._getAvatarUrl(user.avatar_template, user.animated_avatar, 64);
                            const displayName = user.name || user.username;
                            return `
                                <a href="${baseUrl}/u/${user.username}" target="_blank" class="ldsp-follow-item" data-username="${user.username}">
                                    <div class="ldsp-follow-avatar-wrap">
                                        <img class="ldsp-follow-avatar" src="${avatarUrl}" alt="${Utils.escapeHtml(user.username)}" loading="lazy">
                                    </div>
                                    <div class="ldsp-follow-user-info">
                                        <div class="ldsp-follow-user-name">${Utils.escapeHtml(displayName)}</div>
                                        <div class="ldsp-follow-user-id">@${Utils.escapeHtml(user.username)}</div>
                                    </div>
                                    <div class="ldsp-follow-arrow">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 18l6-6-6-6"/>
                                        </svg>
                                    </div>
                                </a>`;
                        }).join('')}
                    </div>`;
            }

            _getAvatarUrl(template, animatedAvatar, size = 64) {
                if (!template) return '';
                // ä¼˜å…ˆä½¿ç”¨åŠ¨ç”»å¤´åƒ
                if (animatedAvatar) {
                    return `https://${CURRENT_SITE.domain}${animatedAvatar}`;
                }
                // æ›¿æ¢sizeå ä½ç¬¦
                let url = template.replace('{size}', size);
                // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ·»åŠ åŸŸå
                if (url.startsWith('/')) {
                    url = `https://${CURRENT_SITE.domain}${url}`;
                }
                return url;
            }

            getStats() {
                return {
                    following: this.followingCount,
                    followers: this.followersCount
                };
            }

            destroy() {
                if (this.overlay) {
                    this.overlay.remove();
                    this.overlay = null;
                }
            }
        }

        // ==================== é¢æ¿æ¸²æŸ“å™¨ ====================
        class Renderer {
            constructor(panel) {
                this.panel = panel;
                this.prevValues = new Map();
                this.lastPct = -1;
            }

            // æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯
            renderUser(name, level, isOK, reqs, displayName = null) {
                const _done = reqs.filter(r => r.isSuccess).length;
                const $ = this.panel.$;
                // XSS é˜²æŠ¤ï¼šä½¿ç”¨ textContent è€Œä¸æ˜¯ innerHTMLï¼Œå¹¶æ¸…ç†è¾“å…¥
                const safeName = Utils.sanitize(name, 30);
                const safeDisplayName = Utils.sanitize(displayName, 100);
                // å¦‚æœæœ‰ displayName åˆ™æ˜¾ç¤º displayName + @usernameï¼Œå¦åˆ™åªæ˜¾ç¤º username
                if (safeDisplayName && safeDisplayName !== safeName) {
                    $.userDisplayName.textContent = safeDisplayName;
                    $.userHandle.textContent = `@${safeName}`;
                    $.userHandle.style.display = '';
                } else {
                    $.userDisplayName.textContent = safeName;
                    $.userHandle.textContent = '';
                    $.userHandle.style.display = 'none';
                }
            }

            renderReqs(reqs, level = null) {
                const done = reqs.filter(r => r.isSuccess).length, remain = reqs.length - done;
                const pct = Math.round(done / reqs.length * 100), cfg = Screen.getConfig();
                const r = cfg.ringSize / 2 - 8, circ = 2 * Math.PI * r, off = circ * (1 - pct / 100);
                const anim = this.lastPct === -1 || this.lastPct !== pct || this.panel.animRing;
                this.lastPct = pct; this.panel.animRing = false;

                const pl = level !== null ? parseInt(level, 10) : NaN;
                let lv = !isNaN(pl) ? pl : (this.panel.cachedLevel ?? (typeof (this.panel.oauth?.getUserInfo?.()?.trust_level ?? this.panel.oauth?.getUserInfo?.()?.trustLevel) === 'number' ? this.panel.oauth.getUserInfo().trust_level : 2));
                if (level !== null && !isNaN(pl)) this.panel.cachedLevel = lv;

                const canUp = lv < 3, tgt = canUp ? lv + 1 : lv;
                const [tipText, tipClass] = !canUp ? [lv >= 4 ? 'ğŸ† å·²è¾¾æœ€é«˜ç­‰çº§' : 'ğŸ–ï¸ å·²è¾¾æ™®é€šç”¨æˆ·æœ€é«˜ç­‰çº§', 'max'] : remain > 0 ? [`â³ è·å‡çº§è¿˜éœ€å®Œæˆ ${remain} é¡¹è¦æ±‚`, 'progress'] : ['ğŸ‰ å·²æ»¡è¶³å‡çº§æ¡ä»¶', 'ok'];

                const colors = ['#5070d0','#5bb5a6','#f97316','#22c55e','#eab308','#ec4899','#f43f5e','#6b8cef'];
                const shapes = 'â—â– â˜…â¤âœ¨â€';
                const confetti = pct === 100 ? Array.from({length:28},(_,i)=>{const a=(i/28)*360+(Math.random()-.5)*25,rad=a*Math.PI/180,d=55+Math.random()*45;return`<span class="ldsp-confetti-piece" style="color:${colors[i%8]};--tx:${Math.cos(rad)*d}px;--ty:${Math.sin(rad)*d*.7}px;--drift:${(Math.random()-.5)*40}px;--rot:${(Math.random()-.5)*900}deg;animation-delay:${Math.random()*.06}s">${shapes[Math.floor(Math.random()*6)]}</span>`}).join('') : '';

                const h = [`<div class="ldsp-ring${pct===100?' complete':''}">`, pct===100?`<div class="ldsp-confetti">${confetti}</div>`:''];
                h.push(`<div class="ldsp-ring-stat"><div class="ldsp-ring-stat-val ok">âœ“${done}</div><div class="ldsp-ring-stat-lbl">å·²è¾¾æ ‡</div></div>`,
                    `<div class="ldsp-ring-center"><div class="ldsp-ring-wrap"><svg width="${cfg.ringSize}" height="${cfg.ringSize}" viewBox="0 0 ${cfg.ringSize} ${cfg.ringSize}"><defs><linearGradient id="ldsp-grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#5070d0"/><stop offset="100%" style="stop-color:#5bb5a6"/></linearGradient></defs><circle class="ldsp-ring-bg" cx="${cfg.ringSize/2}" cy="${cfg.ringSize/2}" r="${r}"/><circle class="ldsp-ring-fill${anim?' anim':''}" cx="${cfg.ringSize/2}" cy="${cfg.ringSize/2}" r="${r}" stroke-dasharray="${circ}" stroke-dashoffset="${anim?circ:off}" style="--circ:${circ};--off:${off}"/></svg><div class="ldsp-ring-txt"><div class="ldsp-ring-val${anim?' anim':''}">${pct}%</div><div class="ldsp-ring-lbl">å®Œæˆåº¦</div></div></div><div class="ldsp-ring-lvl lv${lv}">${canUp?`Lv${lv} â†’ Lv${tgt}`:`Lv${lv} â˜…`}</div></div>`,
                    `<div class="ldsp-ring-stat"><div class="ldsp-ring-stat-val fail">â—‹${remain}</div><div class="ldsp-ring-stat-lbl">å¾…å®Œæˆ</div></div></div>`,
                    `<div class="ldsp-ring-tip ${tipClass}">${tipText}</div>`);

                for (const req of reqs) {
                    const name = Utils.simplifyName(req.name), prev = this.prevValues.get(req.name);
                    const upd = prev !== undefined && prev !== req.currentValue;
                    const chg = req.change ? `<span class="ldsp-item-chg ${req.change>0?'up':'down'}">${req.change>0?'+':''}${req.change}</span>` : '';
                    h.push(`<div class="ldsp-item ${req.isSuccess?'ok':'fail'}"><span class="ldsp-item-icon">${req.isSuccess?'âœ“':'â—‹'}</span><span class="ldsp-item-name">${name}</span><div class="ldsp-item-vals"><span class="ldsp-item-cur${upd?' upd':''}">${req.currentValue}</span><span class="ldsp-item-sep">/</span><span class="ldsp-item-req">${req.requiredValue}</span></div>${chg}</div>`);
                    this.prevValues.set(req.name, req.currentValue);
                }
                h.push(`<a class="ldsp-learn-trust" href="https://linux.do/t/topic/2460" target="_blank" rel="noopener">äº†è§£è®ºå›ä¿¡ä»»ç­‰çº§ â†’</a>`);
                this.panel.$.reqs.innerHTML = h.join('');

                if (pct === 100) setTimeout(() => this.panel.$.reqs.querySelector('.ldsp-ring.complete')?.classList.add('anim-done'), anim ? 950 : 50);
            }

            // æ¸²æŸ“é˜…è¯»å¡ç‰‡ï¼ˆå¸¦ç¼“å­˜ï¼Œé¿å…é¢‘ç¹æ›´æ–°å¯¼è‡´åŠ¨ç”»é—ªçƒï¼‰
            renderReading(minutes, isTracking = true) {
                const lv = Utils.getReadingLevel(minutes);
                const timeStr = Utils.formatReadingTime(minutes);
                const $ = this.panel.$;
                
                // ç¼“å­˜ä¸Šæ¬¡æ¸²æŸ“çš„çŠ¶æ€ï¼Œé¿å…ä¸å¿…è¦çš„ DOM æ“ä½œå’Œæ ·å¼æ›´æ–°
                const cacheKey = `${lv.label}|${timeStr}|${isTracking}|${minutes >= 180}|${minutes >= 450}`;
                if (this._readingCache === cacheKey) return;
                this._readingCache = cacheKey;
                
                // åªæ›´æ–°å˜åŒ–çš„å†…å®¹
                if ($.readingIcon.textContent !== lv.icon) $.readingIcon.textContent = lv.icon;
                if ($.readingTime.textContent !== timeStr) $.readingTime.textContent = timeStr;
                if ($.readingLabel.textContent !== lv.label) $.readingLabel.textContent = lv.label;
                
                // åªåœ¨é¢œè‰²å˜åŒ–æ—¶æ›´æ–°æ ·å¼ï¼ˆé¿å…é‡ç½®åŠ¨ç”»ï¼‰
                if (this._readingColor !== lv.color) {
                    this._readingColor = lv.color;
                    $.reading.style.cssText = `background:${lv.bg};color:${lv.color};--rc:${lv.color}`;
                    $.readingTime.style.color = lv.color;
                    $.readingLabel.style.color = lv.color;
                }
                
                // tracking ç±»è¡¨ç¤ºæ­£åœ¨è¿½è¸ªï¼Œæ˜¾ç¤ºæ³¢æµªæ•ˆæœå’Œ"é˜…è¯»æ—¶é—´è®°å½•ä¸­..."
                $.reading.classList.toggle('tracking', isTracking);
                // hi ç±»è¡¨ç¤ºé˜…è¯»æ—¶é—´è¾¾åˆ°æ²‰æµ¸é˜…è¯»(180-450åˆ†é’Ÿ)
                $.reading.classList.toggle('hi', minutes >= 180 && minutes < 450);
                // max ç±»è¡¨ç¤ºé˜…è¯»æ—¶é—´è¾¾åˆ°æé™(450åˆ†é’Ÿ+)
                $.reading.classList.toggle('max', minutes >= 450);
            }

            // æ¸²æŸ“å¤´åƒ
            renderAvatar(url) {
                const wrap = this.panel.$.user.querySelector('.ldsp-avatar-wrap');
                if (!wrap) return;
                const el = wrap.querySelector('.ldsp-avatar-ph, .ldsp-avatar');
                if (!el) return;
                const img = document.createElement('img');
                img.className = 'ldsp-avatar';
                img.src = url;
                img.alt = 'Avatar';
                img.onerror = () => {
                    const ph = document.createElement('div');
                    ph.className = 'ldsp-avatar-ph';
                    ph.textContent = 'ğŸ‘¤';
                    img.replaceWith(ph);
                };
                el.replaceWith(img);
            }

            renderTrends(tab) {
                const tabs = [['today','â˜€ï¸','ä»Šæ—¥'],['week','ğŸ“…','æœ¬å‘¨'],['month','ğŸ“Š','æœ¬æœˆ'],['year','ğŸ“ˆ','æœ¬å¹´'],['all','ğŸŒ','å…¨éƒ¨']];
                this.panel.$.trends.innerHTML = `<div class="ldsp-subtabs">${tabs.map(([id,i,l])=>`<div class="ldsp-subtab${tab===id?' active':''}" data-tab="${id}">${i} ${l}</div>`).join('')}</div><div class="ldsp-trend-content"></div>`;
            }

            getTrendFields(reqs) {
                return CONFIG.TREND_FIELDS.map(f => { const r = reqs.find(x => x.name.includes(f.search)); return r ? {...f, req: r, name: r.name} : null; }).filter(Boolean);
            }

            renderTodayTrend(reqs, rt, td) {
                if (!td) return `<div class="ldsp-empty"><div class="ldsp-empty-icon">â˜€ï¸</div><div class="ldsp-empty-txt">ä»Šæ—¥é¦–æ¬¡è®¿é—®<br>æ•°æ®å°†ä»ç°åœ¨å¼€å§‹ç»Ÿè®¡</div></div>`;
                const now = new Date(), start = new Date(td.startTs), lv = Utils.getReadingLevel(rt), pct = Math.min(rt/600*100,100);
                const startStr = `${start.getHours()}:${String(start.getMinutes()).padStart(2,'0')}`, nowStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
                let h = `<div class="ldsp-time-info">ä»Šæ—¥ 00:00 ~ ${nowStr} (é¦–æ¬¡è®°å½•äº ${startStr})</div><div class="ldsp-rd-stats" style="background:${lv.bg.replace('0.15','0.08')}"><div class="ldsp-rd-stats-icon">${lv.icon}</div><div class="ldsp-rd-stats-info"><div class="ldsp-rd-stats-val">${Utils.formatReadingTime(rt)}</div><div class="ldsp-rd-stats-lbl">ä»Šæ—¥ç´¯è®¡é˜…è¯»</div></div><div class="ldsp-rd-stats-badge" style="background:${lv.bg};color:${lv.color};box-shadow:0 3px 12px ${lv.bg.replace('0.15','0.4')},inset 0 1px 0 rgba(255,255,255,.25)">${lv.label}</div></div><div class="ldsp-rd-prog"><div class="ldsp-rd-prog-hdr"><span class="ldsp-rd-prog-title">ğŸ“– é˜…è¯»ç›®æ ‡ (10å°æ—¶)</span><span class="ldsp-rd-prog-val">${Math.round(pct)}%</span></div><div class="ldsp-rd-prog-bar"><div class="ldsp-rd-prog-fill" style="width:${pct}%;background:${lv.bg.replace('0.15','1')}"></div></div></div>`;
                if (reqs?.length) {
                    const chgs = reqs.map(r=>({name:Utils.simplifyName(r.name),diff:r.currentValue-(td.startData[r.name]||0)})).filter(c=>c.diff!==0).sort((a,b)=>b.diff-a.diff);
                    const pos = chgs.filter(c=>c.diff>0).length, neg = chgs.filter(c=>c.diff<0).length;
                    h += `<div class="ldsp-today-stats"><div class="ldsp-today-stat"><div class="ldsp-today-stat-val">${pos}</div><div class="ldsp-today-stat-lbl">ğŸ“ˆ å¢é•¿é¡¹</div></div><div class="ldsp-today-stat"><div class="ldsp-today-stat-val">${neg}</div><div class="ldsp-today-stat-lbl">ğŸ“‰ ä¸‹é™é¡¹</div></div></div>`;
                    h += chgs.length ? `<div class="ldsp-chart"><div class="ldsp-chart-title">ğŸ“Š ä»Šæ—¥å˜åŒ–æ˜ç»†</div><div class="ldsp-changes">${chgs.map(c=>`<div class="ldsp-chg-row"><span class="ldsp-chg-name">${c.name}</span><span class="ldsp-chg-val ${c.diff>0?'up':'down'}">${c.diff>0?'+':''}${c.diff}</span></div>`).join('')}</div></div>` : `<div class="ldsp-no-chg">ä»Šæ—¥æš‚æ— æ•°æ®å˜åŒ–</div>`;
                }
                return h;
            }

            renderWeekTrend(hist, reqs, hm, tracker) {
                let h = this._renderWeekChart(tracker);
                if (reqs?.length) {
                    const recent = hist.filter(x => x.ts > Date.now()-7*86400000);
                    if (recent.length >= 1) {
                        const daily = hm.aggregateDaily(recent, reqs, 7), trends = [];
                        for (const f of this.getTrendFields(reqs)) {
                            const d = this._calcDailyTrend(daily, f.name, 7);
                            if (d.values.some(v => v > 0)) trends.push({label: f.label, ...d, current: f.req.currentValue});
                        }
                        if (trends.length) {
                            h += `<div class="ldsp-chart"><div class="ldsp-chart-title">ğŸ“ˆ æœ¬å‘¨æ¯æ—¥å¢é‡<span class="ldsp-chart-sub">æ¯æ—¥ç´¯ç§¯é‡</span></div>${this._renderSparkRows(trends)}${trends[0].dates.length?`<div class="ldsp-date-labels">${trends[0].dates.map(d=>`<span class="ldsp-date-lbl">${d}</span>`).join('')}</div>`:''}</div>`;
                        }
                    }
                }
                return h;
            }

            renderMonthTrend(hist, reqs, hm, tracker) {
                let h = this._renderMonthChart(tracker);
                if (reqs?.length && hist.length >= 1) {
                    const weekly = hm.aggregateWeekly(hist, reqs), trends = [];
                    for (const f of this.getTrendFields(reqs)) {
                        const d = this._calcWeeklyTrend(weekly, f.name);
                        if (d.values.length) trends.push({label: f.label, ...d, current: f.req.currentValue});
                    }
                    if (trends.length) {
                        h += `<div class="ldsp-chart"><div class="ldsp-chart-title">ğŸ“ˆ æœ¬æœˆæ¯å‘¨å¢é‡<span class="ldsp-chart-sub">æ¯å‘¨ç´¯ç§¯é‡</span></div>${this._renderSparkRows(trends,true)}${trends[0].labels?.length?`<div class="ldsp-date-labels" style="padding-left:60px">${trends[0].labels.map(l=>`<span class="ldsp-date-lbl">${l}</span>`).join('')}</div>`:''}</div>`;
                    }
                }
                return h;
            }

            renderYearTrend(hist, reqs, hm, tracker) {
                let h = this._renderYearChart(tracker);
                if (reqs?.length) {
                    // v3.5.2.9: åªå–å½“å‰å¹´çš„æ•°æ®ï¼Œè€Œä¸æ˜¯è¿‡å»365å¤©
                    const currentYear = new Date().getFullYear();
                    const yearStart = new Date(currentYear, 0, 1).getTime();
                    const recent = hist.filter(x => x.ts >= yearStart);
                    if (recent.length >= 1) {
                        const monthly = hm.aggregateMonthly(recent, reqs), trends = [];
                        for (const f of this.getTrendFields(reqs)) {
                            const d = this._calcMonthlyTrend(monthly, f.name);
                            if (d.values.some(v => v > 0)) trends.push({label: f.label, ...d, current: f.req.currentValue});
                        }
                        if (trends.length) {
                            h += `<div class="ldsp-chart"><div class="ldsp-chart-title">ğŸ“Š æœ¬å¹´æ¯æœˆå¢é‡<span class="ldsp-chart-sub">æ¯æœˆç´¯ç§¯é‡</span></div>`;
                            trends.forEach(t => { const m = Math.max(...t.values,1); h += `<div class="ldsp-spark-row"><span class="ldsp-spark-lbl">${t.label}</span><div class="ldsp-spark-bars" style="max-width:100%">${t.values.map((v,i)=>`<div class="ldsp-spark-bar" style="height:${Math.max(v/m*16,2)}px" data-v="${i+1}æœˆ: ${v}"></div>`).join('')}</div><span class="ldsp-spark-val">${t.current}</span></div>`; });
                            h += `</div>`;
                        }
                    }
                }
                return h;
            }

            renderAllTrend(hist, reqs, tracker) {
                const total = tracker.getTotalTime();
                const rd = tracker.storage.get('readingTime', null);
                const days = rd?.dailyData ? Object.keys(rd.dailyData).length : 1;
                const avg = Math.round(total / Math.max(days, 1)), lv = Utils.getReadingLevel(avg);
                let h = `<div class="ldsp-time-info">å…±è®°å½• <span>${days}</span> å¤©é˜…è¯»æ•°æ®</div>`;
                if (total > 0) h += `<div class="ldsp-rd-stats" style="background:${lv.bg.replace('0.15','0.08')}"><div class="ldsp-rd-stats-icon">${lv.icon}</div><div class="ldsp-rd-stats-info"><div class="ldsp-rd-stats-val">${Utils.formatReadingTime(total)}</div><div class="ldsp-rd-stats-lbl">ç´¯è®¡é˜…è¯»æ—¶é—´ Â· æ—¥å‡ ${Utils.formatReadingTime(avg)}</div></div><div class="ldsp-rd-stats-badge" style="background:${lv.bg};color:${lv.color};box-shadow:0 3px 12px ${lv.bg.replace('0.15','0.4')},inset 0 1px 0 rgba(255,255,255,.25)">${lv.label}</div></div>`;
                if (reqs?.length && hist.length >= 1) {
                    const oldest = hist[0], newest = hist.at(-1), rec = hist.length, span = Math.ceil((Date.now()-oldest.ts)/86400000);
                    if (span > days) h = h.replace(`å…±è®°å½• <span>${days}</span> å¤©é˜…è¯»æ•°æ®`, `å…±è®°å½• <span>${rec}</span> å¤©æ•°æ®${span>rec?` Â· è·¨åº¦ ${span} å¤©`:''}`);
                    const chgs = reqs.map(r=>({name:Utils.simplifyName(r.name),diff:(newest.data[r.name]||0)-(oldest.data[r.name]||0),current:r.currentValue,required:r.requiredValue})).filter(c=>c.diff!==0||c.current>0);
                    if (chgs.length) h += `<div class="ldsp-chart"><div class="ldsp-chart-title">ğŸ“Š ç´¯è®¡å˜åŒ– <span style="font-size:9px;color:var(--txt-mut);font-weight:normal">(${rec}å¤©)</span></div><div class="ldsp-changes">${chgs.map(c=>`<div class="ldsp-chg-row"><span class="ldsp-chg-name">${c.name}</span><span class="ldsp-chg-cur">${c.current}/${c.required}</span>${c.diff?`<span class="ldsp-chg-val ${c.diff>0?'up':'down'}">${c.diff>0?'+':''}${c.diff}</span>`:''}</div>`).join('')}</div></div>`;
                    if (rec >= 2) {
                        const avgChgs = reqs.map(r=>({name:Utils.simplifyName(r.name),avg:Math.round(((newest.data[r.name]||0)-(oldest.data[r.name]||0))/Math.max(rec-1,1)*10)/10})).filter(c=>c.avg>0);
                        if (avgChgs.length) h += `<div class="ldsp-chart"><div class="ldsp-chart-title">ğŸ“ˆ æ—¥å‡å¢é‡</div><div class="ldsp-changes">${avgChgs.map(c=>`<div class="ldsp-chg-row"><span class="ldsp-chg-name">${c.name}</span><span class="ldsp-chg-val up">+${c.avg}</span></div>`).join('')}</div></div>`;
                    }
                }
                return h;
            }

            _renderSparkRows(trends, isWk = false) {
                // v3.5.2.9: ä¸ºæ¡å½¢å›¾æ·»åŠ æ‚¬æµ®æç¤ºï¼ˆä½¿ç”¨ data-v é…åˆ CSS ::afterï¼‰
                // ç§»é™¤å†…è” opacity è®¾ç½®ï¼Œç»Ÿä¸€ç”± CSS æ§åˆ¶ï¼Œé¿å…æ°”æ³¡æç¤ºç»§æ‰¿é€æ˜åº¦
                return trends.map(t => { 
                    const m = Math.max(...t.values,1); 
                    const tipLabels = isWk ? (t.labels || []) : (t.dates || []);
                    return `<div class="ldsp-spark-row"><span class="ldsp-spark-lbl">${t.label}</span><div class="ldsp-spark-bars">${t.values.map((v,i)=>{
                        const tip = tipLabels[i] ? `${tipLabels[i]}: ${v}` : `${v}`;
                        const isLast = i === t.values.length - 1;
                        // ä½¿ç”¨ class è€Œéå†…è” opacityï¼Œç¡®ä¿æ°”æ³¡æç¤ºä¸å—å½±å“
                        return `<div class="ldsp-spark-bar${isLast ? ' ldsp-spark-current' : ''}" style="height:${Math.max(v/m*20,2)}px" data-v="${tip}"></div>`;
                    }).join('')}</div><span class="ldsp-spark-val">${t.current}</span></div>`; 
                }).join('');
            }

            _renderWeekChart(tracker) {
                const days = tracker.getWeekHistory(), max = Math.max(...days.map(d=>d.minutes),60), total = days.reduce((s,d)=>s+d.minutes,0);
                return `<div class="ldsp-chart"><div class="ldsp-chart-title">â±ï¸ 7å¤©é˜…è¯»æ—¶é—´<span class="ldsp-chart-sub">å…± ${Utils.formatReadingTime(total)} Â· æ—¥å‡ ${Utils.formatReadingTime(Math.round(total/7))}</span></div><div class="ldsp-rd-week">${days.map(d=>`<div class="ldsp-rd-day"><div class="ldsp-rd-day-bar" style="height:${Math.max(d.minutes/max*45,3)}px;opacity:${d.isToday?1:0.7}" data-t="${Utils.formatReadingTime(d.minutes)}"></div><span class="ldsp-rd-day-lbl">${d.day}</span></div>`).join('')}</div></div>`;
            }

            _renderMonthChart(tracker) {
                const td = new Date(), [yr,mo,cd] = [td.getFullYear(),td.getMonth(),td.getDate()], dim = new Date(yr,mo+1,0).getDate();
                const days = []; let max = 1, total = 0;
                for (let d = 1; d <= dim; d++) {
                    const isT = d===cd, isFut = d>cd, mins = isFut ? 0 : (isT ? tracker.getTodayTime() : tracker.getTimeForDate(new Date(yr,mo,d).toDateString()));
                    if (!isFut) { max = Math.max(max, mins); total += mins; }
                    days.push({d, mins: Math.max(mins,0), isT, isFut});
                }
                const fs = dim>=31?'7px':(dim>=28?'8px':'9px');
                return `<div class="ldsp-chart"><div class="ldsp-chart-title">â±ï¸ æœ¬æœˆé˜…è¯»æ—¶é—´<span class="ldsp-chart-sub">å…± ${Utils.formatReadingTime(total)} Â· æ—¥å‡ ${Utils.formatReadingTime(cd>0?Math.round(total/cd):0)}</span></div><div class="ldsp-rd-week" style="height:100px;align-items:flex-end;gap:1px">${days.map(dy=>`<div class="ldsp-rd-day" style="margin:0 1px;flex:1;min-width:2px"><div class="ldsp-rd-day-bar" style="height:${max>0?(dy.mins>0?Math.max(dy.mins/max*45,2):1):1}px;opacity:${dy.isFut?0.35:(dy.isT?1:0.75)};background:var(--accent2);width:100%;border-radius:3px 3px 0 0" data-t="${dy.d}æ—¥: ${dy.isFut?'0åˆ†é’Ÿ (æœªåˆ°)':Utils.formatReadingTime(dy.mins)}"></div><div class="ldsp-rd-day-lbl" style="margin-top:3px;font-size:${fs}">${dy.d}</div></div>`).join('')}</div></div>`;
            }

            _renderYearChart(tracker) {
                const today = new Date();
                const year = today.getFullYear();
                const data = tracker.getYearData();

                const jan1 = new Date(year, 0, 1);
                const blanks = jan1.getDay() === 0 ? 6 : jan1.getDay() - 1;

                let total = 0;
                data.forEach(m => total += m);

                const days = Array(blanks).fill({ empty: true });
                let d = new Date(jan1);
                while (d <= today) {
                    days.push({
                        date: new Date(d),
                        mins: Math.max(data.get(d.toDateString()) || 0, 0),
                        month: d.getMonth(),
                        day: d.getDate()
                    });
                    d.setDate(d.getDate() + 1);
                }

                const COLS = 14;
                while (days.length % COLS) days.push({ empty: true });

                const rows = [];
                for (let i = 0; i < days.length; i += COLS) {
                    rows.push(days.slice(i, i + COLS));
                }

                const monthRows = new Map();
                rows.forEach((r, i) => {
                    r.forEach(day => {
                        if (!day.empty) {
                            const m = day.month;
                            if (!monthRows.has(m)) monthRows.set(m, { start: i, end: i });
                            else monthRows.get(m).end = i;
                        }
                    });
                });

                const labels = new Map();
                monthRows.forEach((info, m) => {
                    const mid = Math.floor((info.start + info.end) / 2);
                    if (!labels.has(mid)) labels.set(mid, CONFIG.MONTHS[m]);
                });

                // v3.5.2.9: å½“è¡Œæ•°å°‘äº4è¡Œæ—¶æ·»åŠ  few-rows ç±»ï¼Œè®©tooltipå‘ä¸‹æ˜¾ç¤ºé¿å…è¢«é®æŒ¡
                const fewRowsClass = rows.length < 4 ? ' few-rows' : '';
                let html = `<div class="ldsp-chart"><div class="ldsp-chart-title">â±ï¸ æœ¬å¹´é˜…è¯»æ—¶é—´<span class="ldsp-chart-sub">å…± ${Utils.formatReadingTime(total)}</span></div><div class="ldsp-year-heatmap${fewRowsClass}"><div class="ldsp-year-wrap">`;

                rows.forEach((row, i) => {
                    const lbl = labels.get(i) || '';
                    html += `<div class="ldsp-year-row"><span class="ldsp-year-month">${lbl}</span><div class="ldsp-year-cells">`;
                    row.forEach(day => {
                        if (day.empty) {
                            html += `<div class="ldsp-year-cell empty"></div>`;
                        } else {
                            const lv = Utils.getHeatmapLevel(day.mins);
                            html += `<div class="ldsp-year-cell l${lv}"><div class="ldsp-year-tip">${day.month + 1}/${day.day}<br>${Utils.formatReadingTime(day.mins)}</div></div>`;
                        }
                    });
                    html += `</div></div>`;
                });

                html += `</div><div class="ldsp-heatmap-legend"><span>&lt;1åˆ†</span>`;
                const legendColors = ['rgba(107,140,239,.1)', 'rgba(180,230,210,.35)', 'rgba(130,215,180,.5)', 'rgba(90,195,155,.65)', 'linear-gradient(135deg,#6dcfa5,#50c090)'];
                for (let i = 0; i <= 4; i++) html += `<div class="ldsp-heatmap-legend-cell" style="background:${legendColors[i]}"></div>`;
                html += `<span>&gt;5å°æ—¶</span></div></div></div>`;

                return html;
            }

            _calcDailyTrend(daily, name, maxDays) {
                const sorted = [...daily.keys()].sort((a, b) => new Date(a) - new Date(b)).slice(-maxDays);
                return {
                    values: sorted.map(d => Math.max(daily.get(d)[name] || 0, 0)),
                    dates: sorted.map(d => Utils.formatDate(new Date(d).getTime(), 'short'))
                };
            }

            _calcWeeklyTrend(weekly, name) {
                const sorted = [...weekly.keys()].sort((a, b) => a - b);
                return {
                    values: sorted.map(i => Math.max(weekly.get(i).data[name] || 0, 0)),
                    labels: sorted.map(i => weekly.get(i).label)
                };
            }

            _calcMonthlyTrend(monthly, name) {
                const sorted = [...monthly.keys()].sort((a, b) => new Date(a) - new Date(b));
                return {
                    values: sorted.map(m => Math.max(monthly.get(m)[name] || 0, 0)),
                    dates: sorted.map(m => `${new Date(m).getMonth() + 1}æœˆ`)
                };
            }

            // Toast æç¤º
            showToast(msg) {
                const toast = document.createElement('div');
                toast.className = 'ldsp-toast';
                toast.innerHTML = msg;
                this.panel.el.appendChild(toast);
                requestAnimationFrame(() => toast.classList.add('show'));
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            // ç™»å½•æç¤ºæ¨¡æ€æ¡†
            showLoginPrompt(isUpgrade = false) {
                const overlay = document.createElement('div');
                overlay.className = 'ldsp-modal-overlay';
                overlay.innerHTML = `
                    <div class="ldsp-modal">
                        <div class="ldsp-modal-hdr"><span class="ldsp-modal-icon">${isUpgrade ? 'ğŸ‰' : 'ğŸ‘‹'}</span><span class="ldsp-modal-title">${isUpgrade ? 'å‡çº§åˆ° v3.0' : 'æ¬¢è¿ä½¿ç”¨ LDStatus Pro'}</span></div>
                        <div class="ldsp-modal-body">
                            ${isUpgrade ? `<p>v3.0 ç‰ˆæœ¬æ–°å¢äº† <strong>äº‘åŒæ­¥</strong> åŠŸèƒ½ï¼</p><p>ç™»å½•åï¼Œä½ çš„é˜…è¯»æ•°æ®å°†è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ï¼Œæ”¯æŒè·¨æµè§ˆå™¨ã€è·¨è®¾å¤‡è®¿é—®ã€‚</p>` : `<p>ç™»å½• Linux.do è´¦å·åå¯ä»¥ï¼š</p><ul><li>â˜ï¸ é˜…è¯»æ•°æ®äº‘ç«¯åŒæ­¥</li><li>ğŸ”„ è·¨æµè§ˆå™¨/è®¾å¤‡åŒæ­¥</li><li>ğŸ† æŸ¥çœ‹/åŠ å…¥é˜…è¯»æ’è¡Œæ¦œ</li></ul>`}
                        </div>
                        <div class="ldsp-modal-footer">
                            <button class="ldsp-modal-btn primary" id="ldsp-modal-login">ğŸš€ ç«‹å³ç™»å½•</button>
                            <button class="ldsp-modal-btn secondary" id="ldsp-modal-skip">ç¨åå†è¯´</button>
                        </div>
                        <div class="ldsp-modal-note">ç™»å½•ä»…ç”¨äºäº‘åŒæ­¥ï¼Œä¸ç™»å½•ä¹Ÿå¯æ­£å¸¸ä½¿ç”¨æœ¬åœ°åŠŸèƒ½</div>
                    </div>`;
                this.panel.el.appendChild(overlay);
                requestAnimationFrame(() => overlay.classList.add('show'));
                return overlay;
            }

            renderLeaderboard(tab) {
                const tabs = [['daily','ğŸ“… æ—¥æ¦œ'],['weekly','ğŸ“Š å‘¨æ¦œ'],['monthly','ğŸ“ˆ æœˆæ¦œ']];
                this.panel.$.leaderboard.innerHTML = `<div class="ldsp-subtabs">${tabs.map(([id,l])=>`<div class="ldsp-subtab${tab===id?' active':''}" data-lb="${id}">${l}</div>`).join('')}</div><div class="ldsp-lb-content"></div>`;
            }
            renderLeaderboardLogin() { return `<div class="ldsp-lb-login"><div class="ldsp-lb-login-icon">ğŸ”</div><div class="ldsp-lb-login-title">éœ€è¦ç™»å½•</div><div class="ldsp-lb-login-desc">ç™»å½•åå¯ä»¥ï¼š<br>â˜ï¸ é˜…è¯»æ•°æ®äº‘ç«¯åŒæ­¥<br>ğŸ† æŸ¥çœ‹/åŠ å…¥æ’è¡Œæ¦œ</div><button class="ldsp-lb-btn primary" id="ldsp-lb-login">ğŸš€ ç«‹å³ç™»å½•</button><div class="ldsp-privacy-note"><span>ğŸ”’</span><span>ä»…è·å–åŸºæœ¬ä¿¡æ¯ï¼Œç”¨äºæ•°æ®åŒæ­¥</span></div></div>`; }
            renderLeaderboardJoin() { return `<div class="ldsp-join-prompt"><div class="ldsp-join-prompt-icon">ğŸ†</div><div class="ldsp-join-prompt-title">åŠ å…¥é˜…è¯»æ’è¡Œæ¦œ</div><div class="ldsp-join-prompt-desc">åŠ å…¥åå¯ä»¥æŸ¥çœ‹æ’è¡Œæ¦œï¼Œä½ çš„é˜…è¯»æ—¶é—´å°†ä¸å…¶ä»–ç”¨æˆ·ä¸€èµ·å±•ç¤º<br>è¿™æ˜¯å®Œå…¨å¯é€‰çš„ï¼Œéšæ—¶å¯ä»¥é€€å‡º</div><button class="ldsp-lb-btn primary" id="ldsp-lb-join">âœ¨ åŠ å…¥æ’è¡Œæ¦œ</button><div class="ldsp-privacy-note"><span>ğŸ”’</span><span>ä»…å±•ç¤ºç”¨æˆ·åå’Œé˜…è¯»æ—¶é—´</span></div></div>`; }

            renderLeaderboardData(data, uid, joined, type = 'daily') {
                const fmtInt = ms => { const m = Math.round(ms/60000); return m < 60 ? `æ¯ ${m} åˆ†é’Ÿæ›´æ–°` : `æ¯ ${Math.round(m/60)} å°æ—¶æ›´æ–°`; };
                const rules = { daily: fmtInt(CONFIG.CACHE.LEADERBOARD_DAILY_TTL), weekly: fmtInt(CONFIG.CACHE.LEADERBOARD_WEEKLY_TTL), monthly: fmtInt(CONFIG.CACHE.LEADERBOARD_MONTHLY_TTL) };
                if (!data?.rankings?.length) return `<div class="ldsp-lb-empty"><div class="ldsp-lb-empty-icon">ğŸ“­</div><div class="ldsp-lb-empty-txt">æš‚æ— æ’è¡Œæ•°æ®<br>æˆä¸ºç¬¬ä¸€ä¸ªä¸Šæ¦œçš„äººå§ï¼</div></div>`;
                let h = `<div class="ldsp-lb-period"><button class="ldsp-lb-refresh" data-type="${type}" title="æ‰‹åŠ¨åˆ·æ–°">ğŸ”„</button>${data.period?`ğŸ“… ç»Ÿè®¡å‘¨æœŸ: <span>${data.period}</span>`:''}<span class="ldsp-update-rule">ğŸ”„ ${rules[type]}</span></div>`;
                if (data.myRank && joined) h += `<div class="ldsp-my-rank${data.myRank.in_top?'':' not-in-top'}"><div><div class="ldsp-my-rank-lbl">æˆ‘çš„æ’å${data.myRank.in_top?'':'<span class="ldsp-not-in-top-hint">ï¼ˆæœªå…¥æ¦œï¼‰</span>'}</div><div class="ldsp-my-rank-val">${data.myRank.rank?`#${data.myRank.rank}`:(data.myRank.rank_display||'--')}</div></div><div class="ldsp-my-rank-time">${Utils.formatReadingTime(data.myRank.minutes)}</div></div>`;
                h += '<div class="ldsp-rank-list">';
                const base = `https://${CURRENT_SITE.domain}`;
                data.rankings.forEach((u,i) => {
                    const r = i+1, me = uid && u.user_id===uid, cls = [r<=3?`t${r}`:'', me?'me':''].filter(Boolean).join(' ');
                    const av = u.avatar_url ? (u.avatar_url.startsWith('http')?u.avatar_url:`${base}${u.avatar_url}`) : '';
                    const su = Utils.escapeHtml(Utils.sanitize(u.username,30)), sn = Utils.escapeHtml(Utils.sanitize(u.name,100));
                    const nm = sn?.trim() ? `<span class="ldsp-rank-display-name">${sn}</span><span class="ldsp-rank-username">@${su}</span>` : `<span class="ldsp-rank-name-only">${su}</span>`;
                    h += `<div class="ldsp-rank-item ${cls}" style="animation-delay:${i*30}ms"><div class="ldsp-rank-num">${r<=3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][r-1]:r}</div>${av?`<img class="ldsp-rank-avatar" src="${av}" onerror="this.outerHTML='<div class=\\'ldsp-rank-avatar\\' style=\\'display:flex;align-items:center;justify-content:center;font-size:12px\\'>ğŸ‘¤</div>'">`:'<div class="ldsp-rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:12px">ğŸ‘¤</div>'}<div class="ldsp-rank-info">${nm}${me?'<span class="ldsp-rank-me-tag">(æˆ‘)</span>':''}</div><div class="ldsp-rank-time">${Utils.formatReadingTime(u.minutes)}</div></div>`;
                });
                h += '</div>';
                if (joined) h += `<div style="margin-top:12px;text-align:center"><button class="ldsp-lb-btn danger" id="ldsp-lb-quit" style="font-size:9px;padding:4px 8px">é€€å‡ºæ’è¡Œæ¦œ</button></div>`;
                return h;
            }
            renderLeaderboardLoading() { return `<div class="ldsp-mini-loader"><div class="ldsp-mini-spin"></div><div class="ldsp-mini-txt">åŠ è½½æ’è¡Œæ¦œ...</div></div>`; }
            renderLeaderboardError(msg) { return `<div class="ldsp-lb-empty"><div class="ldsp-lb-empty-icon">âŒ</div><div class="ldsp-lb-empty-txt">${msg}</div><button class="ldsp-lb-btn secondary" id="ldsp-lb-retry" style="margin-top:12px">ğŸ”„ é‡è¯•</button></div>`; }

            renderActivity(tab) {
                const tabs = [['read','ğŸ“–','å·²è¯»'],['bookmarks','â­','æ”¶è—'],['replies','ğŸ’¬','å›å¤'],['reactions','ğŸ¤','äº’åŠ¨'],['likes','â¤ï¸','èµè¿‡'],['topics','ğŸ“','æˆ‘çš„è¯é¢˜']];
                this.panel.$.activity.innerHTML = `<div class="ldsp-subtabs">${tabs.map(([id,i,l])=>`<div class="ldsp-subtab${tab===id?' active':''}" data-activity="${id}">${i} ${l}</div>`).join('')}</div><div class="ldsp-activity-content"></div>`;
            }
            renderActivityLoading() { return `<div class="ldsp-mini-loader"><div class="ldsp-mini-spin"></div><div class="ldsp-mini-txt">åŠ è½½ä¸­...</div></div>`; }
            renderActivityEmpty(icon, msg) { return `<div class="ldsp-lb-empty"><div class="ldsp-lb-empty-icon">${icon}</div><div class="ldsp-lb-empty-txt">${msg}</div></div>`; }
            renderActivityError(msg) { return `<div class="ldsp-lb-empty"><div class="ldsp-lb-empty-icon">âŒ</div><div class="ldsp-lb-empty-txt">${msg}</div><button class="ldsp-lb-btn secondary ldsp-activity-retry" style="margin-top:12px">ğŸ”„ é‡è¯•</button></div>`; }

            renderTopicListWithSearch(topics, hasMore, search = '', batchSize = 20, totalLoaded = 0) {
                const toolbar = `<div class="ldsp-activity-toolbar"><div class="ldsp-activity-search"><span class="ldsp-activity-search-icon">ğŸ”</span><input type="text" placeholder="æœç´¢æ ‡é¢˜æˆ–æ ‡ç­¾..." value="${Utils.escapeHtml(search)}"><button class="ldsp-activity-search-clear ${search ? 'show' : ''}">Ã—</button></div><div class="ldsp-activity-toolbar-divider"></div><div class="ldsp-activity-batch"><span class="ldsp-activity-batch-label">åŠ è½½</span><select class="ldsp-activity-batch-select"><option value="20"${batchSize===20?' selected':''}>20</option><option value="50"${batchSize===50?' selected':''}>50</option><option value="100"${batchSize===100?' selected':''}>100</option><option value="200"${batchSize===200?' selected':''}>200</option><option value="300"${batchSize===300?' selected':''}>300</option></select></div></div>`;
                const stats = `<div class="ldsp-activity-stats">å·²åŠ è½½ <strong>${totalLoaded}</strong> æ¡${search ? ` Â· åŒ¹é… <strong>${topics.length}</strong> æ¡` : ''}</div>`;
                if (!topics?.length) return toolbar + stats + this.renderActivityEmpty('ğŸ“­', search ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è¯é¢˜' : 'æš‚æ— å·²è¯»è¯é¢˜');
                return toolbar + stats + this._renderTopicItems(topics, hasMore);
            }

            _renderTopicItems(topics, hasMore) {
                const ic = { reply:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>', view:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>', like:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>' };
                const getAv = u => { if(!u?.avatar_template)return''; let t=u.avatar_template; if(t.startsWith('/'))t=`https://${CURRENT_SITE.domain}${t}`; return t.replace('{size}',36); };
                const getThumb = t => { if(!t.thumbnails?.length)return null; const s=t.thumbnails.find(x=>x.max_width&&x.max_width<=200); return s?.url||t.thumbnails[t.thumbnails.length-1]?.url||t.image_url; };
                let h = '<div class="ldsp-topic-list ldsp-topic-list-enhanced">';
                topics.forEach((t,i) => {
                    const title = Utils.escapeHtml(t.title||'æ— æ ‡é¢˜'), pc = t.posts_count||0, v = t.views||0, lc = t.like_count||0;
                    const ur = t.unread_posts||t.unread||0, np = t.new_posts||0, tags = t.tags||[], rt = Utils.formatRelativeTime(t.bumped_at);
                    const url = `https://${CURRENT_SITE.domain}/t/topic/${t.id}`, thumb = getThumb(t), ps = t.postersInfo||[];
                    const badge = ur>0?`<span class="ldsp-topic-badge ldsp-badge-unread">${ur}</span>`:np>0?`<span class="ldsp-topic-badge ldsp-badge-new">${np}</span>`:'';
                    const tagsH = tags.length?`<div class="ldsp-topic-tags">${tags.slice(0,2).map(x=>`<span class="ldsp-topic-tag">${Utils.escapeHtml(x)}</span>`).join('')}${tags.length>2?`<span class="ldsp-topic-tag-more">+${tags.length-2}</span>`:''}</div>`:'';
                    let psH = ps.length?'<div class="ldsp-topic-posters">'+ps.slice(0,3).map((p,j)=>`<img src="${getAv(p)}" class="ldsp-topic-avatar ${p.description?.includes('åŸå§‹å‘å¸–äºº')?'ldsp-poster-op':p.extras?.includes('latest')?'ldsp-poster-latest':''}" title="${Utils.escapeHtml(p.name||p.username)}" style="z-index:${5-j}" loading="lazy">`).join('')+(ps.length>3?`<span class="ldsp-topic-posters-more">+${ps.length-3}</span>`:'')+'</div>':'';
                    h += `<a href="${url}" target="_blank" class="ldsp-topic-item" style="animation-delay:${i*20}ms"><div class="ldsp-topic-main"><div class="ldsp-topic-header"><div class="ldsp-topic-title-row">${badge?`<div class="ldsp-topic-badges">${badge}</div>`:''}<div class="ldsp-topic-title" title="${title}">${title}</div></div><div class="ldsp-topic-info">${tagsH}</div></div><div class="ldsp-topic-footer">${psH}<div class="ldsp-topic-stats"><span class="ldsp-topic-stat" title="å›å¤">${ic.reply}<em>${pc}</em></span><span class="ldsp-topic-stat" title="é˜…è¯»">${ic.view}<em>${v>=1000?(v/1000).toFixed(1)+'k':v}</em></span>${lc>0?`<span class="ldsp-topic-stat ldsp-stat-like" title="ç‚¹èµ">${ic.like}<em>${lc}</em></span>`:''}<span class="ldsp-topic-time">${rt}</span></div></div></div>${thumb?`<div class="ldsp-topic-thumbnail"><img src="${thumb}" loading="lazy"></div>`:''}</a>`;
                });
                return h+'</div>'+(hasMore?'<div class="ldsp-load-more"><div class="ldsp-load-more-spinner"></div><span>åŠ è½½æ›´å¤š...</span></div>':'');
            }

            renderTopicList(topics, hasMore) {
                if (!topics?.length) return this.renderActivityEmpty('ğŸ“­', 'æš‚æ— å·²è¯»è¯é¢˜');
                return this._renderTopicItems(topics, hasMore);
            }

            renderBookmarkList(bm, hasMore) {
                if (!bm?.length) return this.renderActivityEmpty('â­', 'æš‚æ— æ”¶è—');
                return this._renderBookmarkItems(bm, hasMore);
            }

            renderBookmarkListWithSearch(bookmarks, hasMore, search = '', batchSize = 20, totalLoaded = 0) {
                const toolbar = `<div class="ldsp-activity-toolbar"><div class="ldsp-activity-search"><span class="ldsp-activity-search-icon">ğŸ”</span><input type="text" placeholder="æœç´¢æ ‡é¢˜æˆ–æ ‡ç­¾..." value="${Utils.escapeHtml(search)}"><button class="ldsp-activity-search-clear ${search ? 'show' : ''}">Ã—</button></div><div class="ldsp-activity-toolbar-divider"></div><div class="ldsp-activity-batch"><span class="ldsp-activity-batch-label">åŠ è½½</span><select class="ldsp-activity-batch-select"><option value="20"${batchSize===20?' selected':''}>20</option><option value="50"${batchSize===50?' selected':''}>50</option><option value="100"${batchSize===100?' selected':''}>100</option><option value="200"${batchSize===200?' selected':''}>200</option><option value="300"${batchSize===300?' selected':''}>300</option></select></div></div>`;
                const stats = `<div class="ldsp-activity-stats">å·²åŠ è½½ <strong>${totalLoaded}</strong> æ¡${search ? ` Â· åŒ¹é… <strong>${bookmarks.length}</strong> æ¡` : ''}</div>`;
                if (!bookmarks?.length) return toolbar + stats + this.renderActivityEmpty('â­', search ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ”¶è—' : 'æš‚æ— æ”¶è—');
                return toolbar + stats + this._renderBookmarkItems(bookmarks, hasMore);
            }

            _renderBookmarkItems(bm, hasMore) {
                const ic = { clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', calendar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' };
                let h = '<div class="ldsp-bookmark-list">';
                bm.forEach((b,i) => {
                    const title = Utils.escapeHtml(b.title||b.fancy_title||'æ— æ ‡é¢˜'), tags = b.tags||[], rt = Utils.formatRelativeTime(b.bumped_at), ct = Utils.formatDateTime(b.created_at), url = b.bookmarkable_url||'#', ex = b.excerpt||'';
                    const tagsH = tags.length?`<div class="ldsp-bookmark-tags">${tags.slice(0,4).map(t=>`<span class="ldsp-bookmark-tag">${Utils.escapeHtml(t)}</span>`).join('')}${tags.length>4?`<span class="ldsp-bookmark-tag-more">+${tags.length-4}</span>`:''}</div>`:'';
                    h += `<div class="ldsp-bookmark-item" data-url="${url}" style="animation-delay:${i*30}ms"><div class="ldsp-bookmark-title">${title}</div><div class="ldsp-bookmark-meta"><span class="ldsp-bookmark-time" title="æ”¶è—æ—¶é—´">${ic.calendar}${ct||'--'}</span><span class="ldsp-bookmark-time" title="æœ€åæ´»åŠ¨">${ic.clock}${rt||'--'}</span></div>${tagsH}${ex?`<div class="ldsp-bookmark-excerpt">${ex}</div>`:''}</div>`;
                });
                return h+'</div>'+(hasMore?'<div class="ldsp-load-more"><div class="ldsp-load-more-spinner"></div><span>åŠ è½½æ›´å¤š...</span></div>':'');
            }

            renderReplyList(rp, hasMore) {
                if (!rp?.length) return this.renderActivityEmpty('ğŸ’¬', 'æš‚æ— å›å¤');
                const ic = { clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', reply:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>' };
                let h = '<div class="ldsp-reply-list">';
                rp.forEach((r,i) => {
                    const title = Utils.escapeHtml(r.title||'æ— æ ‡é¢˜'), ex = r.excerpt||'', rt = Utils.formatRelativeTime(r.created_at), url = `https://${CURRENT_SITE.domain}/t/topic/${r.topic_id}/${r.post_number}`;
                    h += `<div class="ldsp-reply-item" data-url="${url}" style="animation-delay:${i*30}ms"><div class="ldsp-reply-title">${title}</div><div class="ldsp-reply-meta"><span class="ldsp-reply-time" title="å›å¤æ—¶é—´">${ic.clock}${rt||'--'}</span>${r.reply_to_post_number?`<span class="ldsp-reply-to" title="å›å¤æ¥¼å±‚">${ic.reply}#${r.reply_to_post_number}</span>`:''}</div>${ex?`<div class="ldsp-reply-excerpt">${ex}</div>`:''}</div>`;
                });
                return h+'</div>'+(hasMore?'<div class="ldsp-load-more"><div class="ldsp-load-more-spinner"></div><span>åŠ è½½æ›´å¤š...</span></div>':'');
            }

            renderLikeList(lk, hasMore) {
                if (!lk?.length) return this.renderActivityEmpty('â¤ï¸', 'æš‚æ— èµè¿‡å†…å®¹');
                const ic = { clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', user:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' };
                let h = '<div class="ldsp-like-list">';
                lk.forEach((l,i) => {
                    const title = Utils.escapeHtml(l.title||'æ— æ ‡é¢˜'), ex = l.excerpt||'', rt = Utils.formatRelativeTime(l.created_at), url = `https://${CURRENT_SITE.domain}/t/topic/${l.topic_id}/${l.post_number}`;
                    const name = Utils.escapeHtml(l.name||l.username||'åŒ¿å');
                    h += `<div class="ldsp-like-item" data-url="${url}" style="animation-delay:${i*30}ms"><div class="ldsp-like-title">${title}</div><div class="ldsp-like-meta"><span class="ldsp-like-time" title="ç‚¹èµæ—¶é—´">${ic.clock}${rt||'--'}</span><span class="ldsp-like-author" title="ä½œè€…ï¼š@${l.username}">${ic.user}${name}</span></div>${ex?`<div class="ldsp-like-excerpt">${ex}</div>`:''}</div>`;
                });
                return h+'</div>'+(hasMore?'<div class="ldsp-load-more"><div class="ldsp-load-more-spinner"></div><span>åŠ è½½æ›´å¤š...</span></div>':'');
            }

            renderMyTopicList(tp, hasMore) {
                if (!tp?.length) return this.renderActivityEmpty('ğŸ“', 'æš‚æ— å‘å¸ƒçš„è¯é¢˜');
                const ic = { reply:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>', view:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>', heart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>', clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', calendar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>', pin:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/></svg>', lock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>' };
                let h = '<div class="ldsp-mytopic-list">';
                tp.forEach((t,i) => {
                    const title = Utils.escapeHtml(t.title||t.fancy_title||'æ— æ ‡é¢˜'), pc = t.posts_count||0, v = t.views||0, lc = t.like_count||0, tags = t.tags||[];
                    const rt = Utils.formatRelativeTime(t.bumped_at), ct = Utils.formatDateTime(t.created_at), url = `https://${CURRENT_SITE.domain}/t/topic/${t.id}`;
                    const tagsH = tags.length?`<div class="ldsp-mytopic-tags">${tags.slice(0,3).map(x=>`<span class="ldsp-mytopic-tag">${Utils.escapeHtml(x)}</span>`).join('')}${tags.length>3?`<span class="ldsp-mytopic-tag-more">+${tags.length-3}</span>`:''}</div>`:'';
                    const st = (t.pinned?`<span class="ldsp-mytopic-status" title="å·²ç½®é¡¶">${ic.pin}</span>`:'')+(t.closed?`<span class="ldsp-mytopic-status ldsp-mytopic-closed" title="å·²å…³é—­">${ic.lock}</span>`:'');
                    h += `<a href="${url}" target="_blank" class="ldsp-mytopic-item${t.closed?' closed':''}" style="animation-delay:${i*30}ms" title="${title}"><div class="ldsp-mytopic-header"><div class="ldsp-mytopic-title">${title}</div>${st?`<div class="ldsp-mytopic-icons">${st}</div>`:''}</div><div class="ldsp-mytopic-row">${tagsH}<span class="ldsp-mytopic-time" title="åˆ›å»ºæ—¶é—´">${ic.calendar}${ct||'--'}</span></div><div class="ldsp-mytopic-meta"><span class="ldsp-mytopic-stat" title="å›å¤æ•°">${ic.reply}${pc}</span><span class="ldsp-mytopic-stat" title="æµè§ˆé‡">${ic.view}${v}</span><span class="ldsp-mytopic-stat ldsp-mytopic-likes" title="ç‚¹èµæ•°">${ic.heart}${lc}</span><div class="ldsp-mytopic-meta-right"><span class="ldsp-mytopic-time" title="æœ€åæ´»åŠ¨">${ic.clock}${rt||'--'}</span></div></div></a>`;
                });
                return h+'</div>'+(hasMore?'<div class="ldsp-load-more"><div class="ldsp-load-more-spinner"></div><span>åŠ è½½æ›´å¤š...</span></div>':'');
            }

            renderReactionList(rc, hasMore) {
                if (!rc?.length) return this.renderActivityEmpty('ğŸ­', 'æš‚æ— äº’åŠ¨è®°å½•');
                const icClk = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>';
                const getAv = u => { if(!u?.avatar_template)return''; let t=u.avatar_template; return (t.startsWith('/')?`https://${CURRENT_SITE.domain}${t}`:t).replace('{size}',36); };
                const emojiMap = {'+1':'ğŸ‘','-1':'ğŸ‘','laughing':'ğŸ˜‚','heart':'â¤ï¸','open_mouth':'ğŸ˜®','cry':'ğŸ˜¢','angry':'ğŸ˜ ','thinking':'ğŸ¤”','clap':'ğŸ‘','fire':'ğŸ”¥','tada':'ğŸ‰','rocket':'ğŸš€','eyes':'ğŸ‘€','confused':'ğŸ˜•','star':'â­','pray':'ğŸ™','folded_hands':'ğŸ™','grinning_face':'ğŸ˜€','rofl':'ğŸ¤£','melting_face':'ğŸ« ','distorted_face':'ğŸ¥´','zany_face':'ğŸ¤ª'};
                const getEmoji = v => emojiMap[v] || emojiMap[v.replace(/^(tieba_|bili_|twemoji_)/,'')] || (v.length<=4?v:'ğŸ‘');
                let h = '<div class="ldsp-reaction-list">';
                rc.forEach((r,i) => {
                    const p = r.post||{}, pu = p.user||{}, rd = r.reaction||{};
                    const title = Utils.escapeHtml(p.topic_title||p.topic?.title||'æ— æ ‡é¢˜'), ex = p.excerpt||'', rt = Utils.formatRelativeTime(r.created_at);
                    const url = `https://${CURRENT_SITE.domain}/t/topic/${p.topic_id}/${p.post_number}`;
                    const name = Utils.escapeHtml(pu.name||pu.username||p.username||'åŒ¿å'), un = pu.username||p.username, av = getAv(pu);
                    const rv = rd.reaction_value||'+1', ri = getEmoji(rv), cnt = rd.reaction_users_count||1;
                    h += `<div class="ldsp-reaction-item" data-url="${url}" style="animation-delay:${i*30}ms"><div class="ldsp-reaction-header"><div class="ldsp-reaction-icon" title="${rv}">${ri}</div><div class="ldsp-reaction-title">${title}</div></div><div class="ldsp-reaction-meta">${av?`<img src="${av}" class="ldsp-reaction-avatar" loading="lazy">`:''}<span class="ldsp-reaction-author" title="ä½œè€…ï¼š@${un}">${name}</span><span class="ldsp-reaction-time" title="äº’åŠ¨æ—¶é—´">${icClk}${rt||'--'}</span>${cnt>1?`<span class="ldsp-reaction-count" title="å…±${cnt}äºº">+${cnt-1}</span>`:''}</div>${ex?`<div class="ldsp-reaction-excerpt">${ex}</div>`:''}</div>`;
                });
                return h+'</div>'+(hasMore?'<div class="ldsp-load-more"><div class="ldsp-load-more-spinner"></div><span>åŠ è½½æ›´å¤š...</span></div>':'');
            }
        }

        // ==================== æˆ‘çš„æ´»åŠ¨ç®¡ç†å™¨ ==
        class ActivityManager {
            constructor(network) {
                this.network = network;
                this._cache = new Map();
                this._loading = new Map();
                this._pageState = new Map(); // è®°å½•æ¯ä¸ªå­tabçš„åˆ†é¡µçŠ¶æ€
            }

            // è·å–å·²è¯»è¯é¢˜åˆ—è¡¨ï¼ˆå•é¡µï¼‰
            async _fetchReadPage(page = 0) {
                const url = page > 0 
                    ? `https://${CURRENT_SITE.domain}/read.json?page=${page}`
                    : `https://${CURRENT_SITE.domain}/read.json`;
                
                const response = await this.network.fetchJson(url, {
                    headers: {
                        'Accept': 'application/json, text/javascript, */*; q=0.01',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Discourse-Present': 'true',
                        'Discourse-Logged-In': 'true'
                    },
                    credentials: 'include'
                });

                if (!response || !response.topic_list) {
                    throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                }

                // æ„å»ºç”¨æˆ·IDåˆ°ç”¨æˆ·ä¿¡æ¯çš„æ˜ å°„
                const usersMap = {};
                if (response.users && Array.isArray(response.users)) {
                    response.users.forEach(user => {
                        usersMap[user.id] = user;
                    });
                }

                // ä¸ºæ¯ä¸ªè¯é¢˜é™„åŠ å‘å¸–äººä¿¡æ¯
                const topics = (response.topic_list.topics || []).map(topic => {
                    if (topic.posters && topic.posters.length > 0) {
                        topic.postersInfo = topic.posters.map(poster => {
                            const user = usersMap[poster.user_id];
                            return user ? { ...user, description: poster.description, extras: poster.extras } : null;
                        }).filter(Boolean);
                    }
                    return topic;
                });

                return {
                    topics: topics,
                    hasMore: !!response.topic_list.more_topics_url
                };
            }

            // æ‰¹é‡è·å–å·²è¯»è¯é¢˜åˆ—è¡¨ï¼ˆè·å–100æ¡ï¼‰
            async getReadTopics(startPage = 0, batchSize = 100) {
                const cacheKey = `read_batch_${startPage}`;
                
                // æ£€æŸ¥ç¼“å­˜ï¼ˆ1åˆ†é’Ÿæœ‰æ•ˆï¼‰
                const cached = this._cache.get(cacheKey);
                if (cached && Date.now() - cached.time < 60000) {
                    return cached.data;
                }

                // é˜²æ­¢é‡å¤è¯·æ±‚
                if (this._loading.get(cacheKey)) {
                    return new Promise((resolve) => {
                        const check = () => {
                            if (!this._loading.get(cacheKey)) {
                                resolve(this._cache.get(cacheKey)?.data);
                            } else {
                                setTimeout(check, 100);
                            }
                        };
                        check();
                    });
                }

                this._loading.set(cacheKey, true);

                try {
                    const allTopics = [];
                    let currentPage = startPage;
                    let hasMore = true;
                    const perPage = 30; // æ¯é¡µçº¦30æ¡
                    const maxPages = Math.ceil(batchSize / perPage);

                    // å¾ªç¯è·å–ç›´åˆ°è¾¾åˆ°100æ¡æˆ–æ²¡æœ‰æ›´å¤šæ•°æ®
                    for (let i = 0; i < maxPages && hasMore && allTopics.length < batchSize; i++) {
                        const pageResult = await this._fetchReadPage(currentPage);
                        const existingIds = new Set(allTopics.map(t => t.id));
                        const newTopics = pageResult.topics.filter(t => !existingIds.has(t.id));
                        allTopics.push(...newTopics);
                        hasMore = pageResult.hasMore;
                        currentPage++;
                    }

                    const result = {
                        topics: allTopics.slice(0, batchSize),
                        hasMore: hasMore || allTopics.length >= batchSize,
                        page: currentPage - 1
                    };

                    this._cache.set(cacheKey, { data: result, time: Date.now() });
                    return result;
                } catch (e) {
                    throw new Error(e.message || 'è·å–å·²è¯»è¯é¢˜å¤±è´¥');
                } finally {
                    this._loading.set(cacheKey, false);
                }
            }

            // è·å–æ”¶è—åˆ—è¡¨
            async getBookmarks(page = 0, username) {
                if (!username) throw new Error('æœªç™»å½•');
                
                const cacheKey = `bookmarks_${page}`;
                
                // æ£€æŸ¥ç¼“å­˜ï¼ˆ1åˆ†é’Ÿæœ‰æ•ˆï¼‰
                const cached = this._cache.get(cacheKey);
                if (cached && Date.now() - cached.time < 60000) {
                    return cached.data;
                }

                // é˜²æ­¢é‡å¤è¯·æ±‚
                if (this._loading.get(cacheKey)) {
                    return new Promise((resolve) => {
                        const check = () => {
                            if (!this._loading.get(cacheKey)) {
                                resolve(this._cache.get(cacheKey)?.data);
                            } else {
                                setTimeout(check, 100);
                            }
                        };
                        check();
                    });
                }

                this._loading.set(cacheKey, true);

                try {
                    const url = `https://${CURRENT_SITE.domain}/u/${encodeURIComponent(username)}/bookmarks.json?page=${page}`;
                    
                    const response = await this.network.fetchJson(url, {
                        headers: {
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Discourse-Present': 'true',
                            'Discourse-Logged-In': 'true'
                        },
                        credentials: 'include'
                    });

                    if (!response || !response.user_bookmark_list) {
                        throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                    }

                    const result = {
                        bookmarks: response.user_bookmark_list.bookmarks || [],
                        hasMore: !!response.user_bookmark_list.more_bookmarks_url,
                        page: page
                    };

                    this._cache.set(cacheKey, { data: result, time: Date.now() });
                    return result;
                } catch (e) {
                    throw new Error(e.message || 'è·å–æ”¶è—åˆ—è¡¨å¤±è´¥');
                } finally {
                    this._loading.set(cacheKey, false);
                }
            }

            // è·å–å›å¤åˆ—è¡¨
            async getReplies(offset = 0, username) {
                if (!username) throw new Error('æœªç™»å½•');
                
                const cacheKey = `replies_${offset}`;
                
                // æ£€æŸ¥ç¼“å­˜ï¼ˆ1åˆ†é’Ÿæœ‰æ•ˆï¼‰
                const cached = this._cache.get(cacheKey);
                if (cached && Date.now() - cached.time < 60000) {
                    return cached.data;
                }

                // é˜²æ­¢é‡å¤è¯·æ±‚
                if (this._loading.get(cacheKey)) {
                    return new Promise((resolve) => {
                        const check = () => {
                            if (!this._loading.get(cacheKey)) {
                                resolve(this._cache.get(cacheKey)?.data);
                            } else {
                                setTimeout(check, 100);
                            }
                        };
                        check();
                    });
                }

                this._loading.set(cacheKey, true);

                try {
                    const url = `https://${CURRENT_SITE.domain}/user_actions.json?offset=${offset}&username=${encodeURIComponent(username)}&filter=5`;
                    
                    const response = await this.network.fetchJson(url, {
                        headers: {
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Discourse-Present': 'true',
                            'Discourse-Logged-In': 'true'
                        },
                        credentials: 'include'
                    });

                    if (!response || !response.user_actions) {
                        throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                    }

                    const replies = response.user_actions || [];
                    const result = {
                        replies: replies,
                        hasMore: replies.length >= 30, // æ¯é¡µ30æ¡ï¼Œå¦‚æœè¿”å›30æ¡è¯´æ˜å¯èƒ½è¿˜æœ‰æ›´å¤š
                        offset: offset
                    };

                    this._cache.set(cacheKey, { data: result, time: Date.now() });
                    return result;
                } catch (e) {
                    throw new Error(e.message || 'è·å–å›å¤åˆ—è¡¨å¤±è´¥');
                } finally {
                    this._loading.set(cacheKey, false);
                }
            }

            // è·å–èµè¿‡åˆ—è¡¨
            async getLikes(offset = 0, username) {
                if (!username) throw new Error('æœªç™»å½•');
                
                const cacheKey = `likes_${offset}`;
                
                // æ£€æŸ¥ç¼“å­˜ï¼ˆ1åˆ†é’Ÿæœ‰æ•ˆï¼‰
                const cached = this._cache.get(cacheKey);
                if (cached && Date.now() - cached.time < 60000) {
                    return cached.data;
                }

                // é˜²æ­¢é‡å¤è¯·æ±‚
                if (this._loading.get(cacheKey)) {
                    return new Promise((resolve) => {
                        const check = () => {
                            if (!this._loading.get(cacheKey)) {
                                resolve(this._cache.get(cacheKey)?.data);
                            } else {
                                setTimeout(check, 100);
                            }
                        };
                        check();
                    });
                }

                this._loading.set(cacheKey, true);

                try {
                    const url = `https://${CURRENT_SITE.domain}/user_actions.json?offset=${offset}&username=${encodeURIComponent(username)}&filter=1`;
                    
                    const response = await this.network.fetchJson(url, {
                        headers: {
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Discourse-Present': 'true',
                            'Discourse-Logged-In': 'true'
                        },
                        credentials: 'include'
                    });

                    if (!response || !response.user_actions) {
                        throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                    }

                    const likes = response.user_actions || [];
                    const result = {
                        likes: likes,
                        hasMore: likes.length >= 30, // æ¯é¡µ30æ¡ï¼Œå¦‚æœè¿”å›30æ¡è¯´æ˜å¯èƒ½è¿˜æœ‰æ›´å¤š
                        offset: offset
                    };

                    this._cache.set(cacheKey, { data: result, time: Date.now() });
                    return result;
                } catch (e) {
                    throw new Error(e.message || 'è·å–èµè¿‡åˆ—è¡¨å¤±è´¥');
                } finally {
                    this._loading.set(cacheKey, false);
                }
            }

            // è·å–æˆ‘çš„è¯é¢˜åˆ—è¡¨
            async getMyTopics(page = 0, username) {
                if (!username) throw new Error('æœªç™»å½•');
                
                const cacheKey = `topics_${page}`;
                
                // æ£€æŸ¥ç¼“å­˜ï¼ˆ1åˆ†é’Ÿæœ‰æ•ˆï¼‰
                const cached = this._cache.get(cacheKey);
                if (cached && Date.now() - cached.time < 60000) {
                    return cached.data;
                }

                // é˜²æ­¢é‡å¤è¯·æ±‚
                if (this._loading.get(cacheKey)) {
                    return new Promise((resolve) => {
                        const check = () => {
                            if (!this._loading.get(cacheKey)) {
                                resolve(this._cache.get(cacheKey)?.data);
                            } else {
                                setTimeout(check, 100);
                            }
                        };
                        check();
                    });
                }

                this._loading.set(cacheKey, true);

                try {
                    const url = page > 0
                        ? `https://${CURRENT_SITE.domain}/topics/created-by/${encodeURIComponent(username)}.json?page=${page}`
                        : `https://${CURRENT_SITE.domain}/topics/created-by/${encodeURIComponent(username)}.json`;
                    
                    const response = await this.network.fetchJson(url, {
                        headers: {
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Discourse-Present': 'true',
                            'Discourse-Logged-In': 'true'
                        },
                        credentials: 'include'
                    });

                    if (!response || !response.topic_list) {
                        throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                    }

                    const topics = response.topic_list.topics || [];
                    const result = {
                        topics: topics,
                        hasMore: topics.length >= 30, // æ¯é¡µ30æ¡
                        page: page
                    };

                    this._cache.set(cacheKey, { data: result, time: Date.now() });
                    return result;
                } catch (e) {
                    throw new Error(e.message || 'è·å–æˆ‘çš„è¯é¢˜å¤±è´¥');
                } finally {
                    this._loading.set(cacheKey, false);
                }
            }

            // è·å–äº’åŠ¨è®°å½•ï¼ˆreactionsï¼‰
            async getReactions(beforeId = null, username) {
                if (!username) throw new Error('æœªç™»å½•');
                
                const cacheKey = `reactions_${beforeId || 'first'}`;
                
                // æ£€æŸ¥ç¼“å­˜ï¼ˆ1åˆ†é’Ÿæœ‰æ•ˆï¼‰
                const cached = this._cache.get(cacheKey);
                if (cached && Date.now() - cached.time < 60000) {
                    return cached.data;
                }

                // é˜²æ­¢é‡å¤è¯·æ±‚
                if (this._loading.get(cacheKey)) {
                    return new Promise((resolve) => {
                        const check = () => {
                            if (!this._loading.get(cacheKey)) {
                                resolve(this._cache.get(cacheKey)?.data);
                            } else {
                                setTimeout(check, 100);
                            }
                        };
                        check();
                    });
                }

                this._loading.set(cacheKey, true);

                try {
                    let url = `https://${CURRENT_SITE.domain}/discourse-reactions/posts/reactions.json?username=${encodeURIComponent(username)}`;
                    if (beforeId) {
                        url += `&before_reaction_user_id=${beforeId}`;
                    }
                    
                    const response = await this.network.fetchJson(url, {
                        headers: {
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Discourse-Present': 'true',
                            'Discourse-Logged-In': 'true'
                        },
                        credentials: 'include'
                    });

                    if (!response || !Array.isArray(response)) {
                        throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                    }

                    const reactions = response || [];
                    // è·å–æœ€åä¸€æ¡è®°å½•çš„ id ç”¨äºåˆ†é¡µ
                    const lastId = reactions.length > 0 ? reactions[reactions.length - 1].id : null;
                    
                    const result = {
                        reactions: reactions,
                        hasMore: reactions.length >= 20, // æ¯é¡µçº¦20æ¡ï¼Œå¦‚æœè¿”å›20æ¡è¯´æ˜å¯èƒ½è¿˜æœ‰æ›´å¤š
                        lastId: lastId
                    };

                    this._cache.set(cacheKey, { data: result, time: Date.now() });
                    return result;
                } catch (e) {
                    throw new Error(e.message || 'è·å–äº’åŠ¨è®°å½•å¤±è´¥');
                } finally {
                    this._loading.set(cacheKey, false);
                }
            }

            // æ¸…é™¤ç¼“å­˜å’Œåˆ†é¡µçŠ¶æ€
            clearCache(type) {
                if (type) {
                    // æ¸…é™¤ç‰¹å®šç±»å‹çš„ç¼“å­˜
                    for (const key of this._cache.keys()) {
                        if (key.startsWith(type)) {
                            this._cache.delete(key);
                        }
                    }
                    // åŒæ—¶æ¸…é™¤åˆ†é¡µçŠ¶æ€
                    this._pageState.delete(type);
                } else {
                    this._cache.clear();
                    this._pageState.clear();
                }
            }

            // è·å–åˆ†é¡µçŠ¶æ€
            getPageState(type) {
                return this._pageState.get(type) || { page: 0, allTopics: [], hasMore: true, search: '', batchSize: 20 };
            }

            // è®¾ç½®åˆ†é¡µçŠ¶æ€
            setPageState(type, state) {
                this._pageState.set(type, state);
            }
        }

        // ==================== ä¸»é¢æ¿ç±» ====================
        class Panel {
            constructor() {
                this._initManagers();
                this._initState();
                this._initUI();
                this._initCloudServices();
                this._initEventListeners();
                this._initTimers();
            }
            
            // åˆå§‹åŒ–ç®¡ç†å™¨å®ä¾‹
            _initManagers() {
                this.storage = new Storage();
                this.network = new Network();
                this.historyMgr = new HistoryManager(this.storage);
                this.tracker = new ReadingTracker(this.storage);
                this.notifier = new Notifier(this.storage);
                this.activityMgr = new ActivityManager(this.network);

                // æ’è¡Œæ¦œç›¸å…³ï¼ˆä»…æ”¯æŒçš„ç«™ç‚¹ï¼‰
                this.hasLeaderboard = CURRENT_SITE.supportsLeaderboard;
                if (this.hasLeaderboard) {
                    this.oauth = new OAuthManager(this.storage, this.network);
                    this.leaderboard = new LeaderboardManager(this.oauth, this.tracker, this.storage);
                    this.cloudSync = new CloudSyncManager(this.storage, this.oauth, this.tracker);
                    this.cloudSync.setHistoryManager(this.historyMgr);
                    this.lbTab = this.storage.getGlobal('leaderboardTab', 'daily');
                }
            }
            
            // åˆå§‹åŒ–çŠ¶æ€å˜é‡
            _initState() {
                this.prevReqs = [];
                this.trendTab = this.storage.getGlobal('trendTab', 'today');
                // å…¼å®¹æ€§ï¼šä¿®å¤æ—§ç‰ˆæœ¬çš„æ— æ•ˆ tab å€¼
                if (!['today', 'week', 'month', 'year', 'all'].includes(this.trendTab)) {
                    this.trendTab = 'today';
                    this.storage.setGlobal('trendTab', 'today');
                }
                this.avatar = this.storage.get('userAvatar', null);
                this.readingTime = 0;
                this.username = null;
                this.animRing = true;
                this.cachedHistory = [];
                this.cachedReqs = [];
                this.loading = false;
                this._readingTimer = null;
                this._destroyed = false;  // é”€æ¯æ ‡è®°
                this._followDataLoaded = false;
                this._followProfileLoaded = false;
                
                // æˆ‘çš„æ´»åŠ¨ç›¸å…³çŠ¶æ€
                this.activitySubTab = 'read';  // é»˜è®¤å­tab
                this._activityScrollHandler = null;  // æ»šåŠ¨äº‹ä»¶å¤„ç†å™¨
            }
            
            // åˆå§‹åŒ– UI
            _initUI() {
                Styles.inject();
                this._createPanel();
                this.renderer = new Renderer(this);
                this._bindEvents();
                this._restore();
                this.fetch();

                // åˆå§‹åŒ–å…¨å±€å¼¹çª—ç®¡ç†å™¨ï¼ˆä¼ å…¥é¢æ¿æ ¹å…ƒç´ ï¼‰
                LDSPDialog.init(this.el);
                // ç®¡ç†å™¨æ”¹ä¸ºæŒ‰éœ€æ‡’åŠ è½½ï¼Œå‡å°‘é¦–å±å¼€é”€
                this._loadAvatarFromCache();
                // è½»é‡é¢„å–å…³æ³¨/ç²‰ä¸/å…¥ç«™å¤©æ•°ï¼ˆç©ºé—²æ—¶æ‰§è¡Œï¼Œä¸é˜»å¡é¦–å±ï¼‰
                requestIdleCallback(() => {
                    const fm = this._ensureFollowManager();
                    fm?.loadData().catch(e => Logger.warn('FollowManager prefetch error:', e));
                    fm?.loadProfile().catch(e => Logger.warn('FollowManager profile prefetch error:', e));
                });
            }

            // ==================== æ‡’åŠ è½½å„åŠŸèƒ½ç®¡ç†å™¨ ====================
            _ensureTicketManager() {
                if (!this.hasLeaderboard || !this.oauth) return null;
                if (!this.ticketManager) {
                    this.ticketManager = new TicketManager(this.oauth, this.$.panelBody);
                    this.ticketManager.init().catch(e => Logger.warn('TicketManager init error:', e));
                }
                return this.ticketManager;
            }

            _ensureMelonHelper() {
                if (!this.melonHelper) {
                    this.melonHelper = new MelonHelper(this.$.panelBody, this.renderer);
                    this.melonHelper.init();
                }
                return this.melonHelper;
            }

            _ensureTopicExporter() {
                if (!this.topicExporter) {
                    this.topicExporter = new TopicExporter(this.$.panelBody, this.renderer);
                    this.topicExporter.init();
                }
                return this.topicExporter;
            }

            _ensureLdcManager() {
                if (CURRENT_SITE.domain !== 'linux.do') return null;
                if (!this.ldcManager) {
                    this.ldcManager = new LDCManager(this.$.panelBody, this.renderer);
                    this.ldcManager.init();
                }
                return this.ldcManager;
            }

            _ensureCdkManager() {
                if (CURRENT_SITE.domain !== 'linux.do') return null;
                if (!this.cdkManager) {
                    this.cdkManager = new CDKManager(this.$.panelBody, this.renderer);
                    this.cdkManager.init();
                }
                return this.cdkManager;
            }

            _ensureFollowManager() {
                if (!this.followManager) {
                    this.followManager = new FollowManager(this.network, this.storage, this.$.panelBody, this.renderer);
                    this.followManager.init();
                }
                // æ‡’åŠ è½½æ•°æ®ä¸ç”¨æˆ·æ¡£æ¡ˆï¼Œé¿å…é¦–å±è¯·æ±‚
                if (!this._followDataLoaded) {
                    this._followDataLoaded = true;
                    requestIdleCallback(() => {
                        this.followManager.loadData().catch(e => Logger.warn('FollowManager load error:', e));
                    });
                }
                if (!this._followProfileLoaded) {
                    this._followProfileLoaded = true;
                    requestIdleCallback(() => {
                        this.followManager.loadProfile().catch(e => Logger.warn('FollowManager profile error:', e));
                    });
                }
                return this.followManager;
            }
            
            // åˆå§‹åŒ–äº‘æœåŠ¡
            _initCloudServices() {
                // æ£€æŸ¥å¾…å¤„ç†çš„ OAuth ç™»å½•ç»“æœï¼ˆç»Ÿä¸€åŒçª—å£æ¨¡å¼ï¼‰
                let justLoggedIn = false;
                if (this.hasLeaderboard && this.oauth) {
                    justLoggedIn = this._checkPendingOAuthLogin();
                }

                if (!this.hasLeaderboard) return;
                
                // æ³¨å†ŒåŒæ­¥çŠ¶æ€å›è°ƒ
                this.cloudSync.setSyncStateCallback(syncing => {
                    if (this._destroyed) return;
                    if (this.$.btnCloudSync) {
                        this.$.btnCloudSync.disabled = syncing;
                        this.$.btnCloudSync.textContent = syncing ? 'â³' : 'â˜ï¸';
                        this.$.btnCloudSync.title = syncing ? 'åŒæ­¥ä¸­...' : 'äº‘åŒæ­¥';
                    }
                    // äº‘åŒæ­¥å®Œæˆæ—¶æ£€æŸ¥æœªè¯»å·¥å•
                    if (!syncing) this.ticketManager?._checkUnread();
                });

                if (this.oauth.isLoggedIn() && !justLoggedIn) {
                    this._initLoggedInUser();
                } else if (justLoggedIn) {
                    if (this.oauth.isJoined()) this.leaderboard.startSync();
                } else {
                    this._checkLoginPrompt();
                }
            }
            
            // åˆå§‹åŒ–å·²ç™»å½•ç”¨æˆ·
            _initLoggedInUser() {
                const oauthUser = this.oauth.getUserInfo();
                if (oauthUser?.username) {
                    const currentUser = this.storage.getUser();
                    if (currentUser !== oauthUser.username) {
                        this.storage.setUser(oauthUser.username);
                        this.storage.invalidateCache();
                        this.storage.migrate(oauthUser.username);
                    }
                    this._updateUserInfoFromOAuth(oauthUser);
                }
                // ä¸²è¡ŒåŒ–åŒæ­¥è¯·æ±‚
                this.cloudSync.onPageLoad()
                    .then(() => this.cloudSync.syncRequirementsOnLoad())
                    .then(() => {
                        // åŒæ­¥å®Œæˆåæ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è·å–æœ€æ–°æ•°æ®
                        this._cloudReqsCache = null;
                        this._cloudReqsCacheTime = 0;
                    })
                    .catch(e => Logger.warn('CloudSync error:', e));
                this._syncPrefs();
                if (this.oauth.isJoined()) this.leaderboard.startSync();
                this._updateLoginUI();
            }
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            _initEventListeners() {
                // çª—å£å¤§å°å˜åŒ–
                this._resizeHandler = Utils.debounce(() => this._onResize(), 250);
                window.addEventListener('resize', this._resizeHandler);
                
                // è®¢é˜… Token è¿‡æœŸäº‹ä»¶
                EventBus.on('auth:expired', () => {
                    this.renderer?.showToast('âš ï¸ ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    this._updateLoginUI();
                });
                
                // è®¢é˜…é˜…è¯»æ•°æ®åŒæ­¥å®Œæˆäº‹ä»¶
                EventBus.on('reading:synced', ({ merged, source }) => {
                    Logger.log(`é˜…è¯»æ•°æ®å·²åŒæ­¥: ${merged} å¤©, æ¥æº: ${source}`);
                    // æ›´æ–°æœ¬åœ°é˜…è¯»æ—¶é—´å˜é‡
                    this.readingTime = this.tracker.getTodayTime();
                    // æ¸…é™¤å¹´åº¦ç¼“å­˜
                    this.tracker._yearCache = null;
                    // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨è¶‹åŠ¿é¡µé¢ï¼ˆé€šè¿‡ DOM æŸ¥è¯¢ï¼‰
                    const trendsActive = this.el?.querySelector('.ldsp-tab[data-tab="trends"].active');
                    if (trendsActive) {
                        // ä½¿ç”¨ç¼“å­˜çš„å†å²å’Œè¦æ±‚æ•°æ®é‡æ–°æ¸²æŸ“è¶‹åŠ¿é¡µé¢
                        this._renderTrends(this.cachedHistory || [], this.cachedReqs || []);
                    }
                    // æ›´æ–°é¡¶éƒ¨é˜…è¯»æ—¶é—´æ˜¾ç¤º
                    this.renderer.renderReading(this.readingTime, this.tracker.isActive);
                    // æ•°æ®åŒæ­¥å®Œæˆåè§¦å‘å·¥å•æœªè¯»æ£€æµ‹
                    this.ticketManager?._checkUnread();
                });
            }
            
            // åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡
            _initTimers() {
                // å®šæœŸåˆ·æ–°æ•°æ®ï¼ˆåªæœ‰é¢†å¯¼è€…æ ‡ç­¾é¡µæ‰§è¡Œï¼‰
                this._refreshTimer = setInterval(() => {
                    if (!this._destroyed && TabLeader.isLeader()) {
                        this.fetch();
                    }
                }, CONFIG.INTERVALS.REFRESH);
                
                // v3.5.2.9: ä¼˜åŒ–è¯·æ±‚æ—¶åºï¼Œé¿å…å¹¶å‘å¯¼è‡´429
                // å…¬å‘ŠåŠ è½½å»¶è¿Ÿåˆ° 3 ç§’åï¼ˆåœ¨äº‘åŒæ­¥ä¸‹è½½å®Œæˆä¹‹åï¼‰
                setTimeout(() => !this._destroyed && this._loadAnnouncement(), 3000);
                
                // ç‰ˆæœ¬æ£€æŸ¥å»¶è¿Ÿåˆ° 4 ç§’å
                setTimeout(() => !this._destroyed && this._checkUpdate(true), 4000);
            }

            _createPanel() {
                this.el = document.createElement('div');
                this.el.id = 'ldsp-panel';
                this.el.setAttribute('role', 'complementary');
                this.el.setAttribute('aria-label', `${CURRENT_SITE.name} ä¿¡ä»»çº§åˆ«é¢æ¿`);

                this.el.innerHTML = `
                    <div class="ldsp-hdr">
                        <div class="ldsp-hdr-info">
                            <div class="ldsp-site-wrap">
                                <img class="ldsp-site-icon" src="${CURRENT_SITE.icon}" alt="${CURRENT_SITE.name}">
                                <span class="ldsp-site-ver">v${GM_info.script.version}</span>
                            </div>
                            <div class="ldsp-hdr-text">
                                <span class="ldsp-title">${CURRENT_SITE.name}</span>
                                <span class="ldsp-ver"><span class="ldsp-app-name">LDStatus Pro</span></span>
                            </div>
                        </div>
                        <div class="ldsp-hdr-btns">
                            <button class="ldsp-update" title="æ£€æŸ¥æ›´æ–°" aria-label="æ£€æŸ¥æ›´æ–°">ğŸ”</button>
                            <button class="ldsp-cloud-sync" title="äº‘åŒæ­¥" aria-label="äº‘åŒæ­¥" style="display:none">â˜ï¸</button>
                            <button class="ldsp-refresh" title="åˆ·æ–°æ•°æ®" aria-label="åˆ·æ–°æ•°æ®">ğŸ”„</button>
                            <button class="ldsp-theme" title="åˆ‡æ¢ä¸»é¢˜" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                            <button class="ldsp-toggle" title="æŠ˜å é¢æ¿" aria-label="æŠ˜å é¢æ¿"><span class="ldsp-toggle-arrow">â—€</span><svg class="ldsp-toggle-logo" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="ldsp-logo-grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#8fa8f8"/><stop offset="100%" stop-color="#7ed4c4"/></linearGradient></defs><path d="M 31,4 A 28,28 0 1,1 11,52" fill="none" stroke="url(#ldsp-logo-grad)" stroke-width="8" stroke-linecap="round"/><rect x="25" y="26" width="12" height="12" rx="3" fill="url(#ldsp-logo-grad)" transform="rotate(45 31 32)"/></svg></button>
                        </div>
                    </div>
                    <div class="ldsp-update-bubble" style="display:none">
                        <div class="ldsp-update-bubble-close">Ã—</div>
                        <div class="ldsp-update-bubble-icon">ğŸ‰</div>
                        <div class="ldsp-update-bubble-title">å‘ç°æ–°ç‰ˆæœ¬</div>
                        <div class="ldsp-update-bubble-ver"></div>
                        <button class="ldsp-update-bubble-btn">ğŸš€ ç«‹å³æ›´æ–°</button>
                    </div>
                    <div class="ldsp-body">
                        <div class="ldsp-announcement">
                            <div class="ldsp-announcement-inner">
                                <span class="ldsp-announcement-text"></span>
                            </div>
                        </div>
                        <div class="ldsp-user">
                            <div class="ldsp-user-left">
                                <div class="ldsp-user-row">
                                    <div class="ldsp-avatar-wrap" data-clickable><div class="ldsp-avatar-ph">ğŸ‘¤</div></div>
                                    <div class="ldsp-user-info">
                                        <div class="ldsp-user-display-name">åŠ è½½ä¸­...</div>
                                        <div class="ldsp-user-handle"></div>
                                    </div>
                                </div>
                                <div class="ldsp-user-meta">
                                    <div class="ldsp-follow-combined">
                                        <span class="ldsp-follow-part ldsp-follow-following" data-clickable data-tab="following" title="æŸ¥çœ‹å…³æ³¨åˆ—è¡¨">å…³æ³¨ <span class="ldsp-follow-num-following">-</span></span>
                                        <span class="ldsp-follow-sep">Â·</span>
                                        <span class="ldsp-follow-part ldsp-follow-followers" data-clickable data-tab="followers" title="æŸ¥çœ‹ç²‰ä¸åˆ—è¡¨"><span class="ldsp-follow-num-followers">-</span> ç²‰ä¸</span>
                                    </div>
                                    <span class="ldsp-join-days">æ¥<span class="ldsp-join-days-site"></span><span class="ldsp-join-days-num">-</span>å¤©</span>
                                </div>
                                <div class="ldsp-user-actions-wrap">
                                    <div class="ldsp-user-actions collapsed">
                                        <div class="ldsp-action-btn ldsp-login-btn" data-clickable title="ç‚¹å‡»ç™»å½•"><span class="ldsp-action-icon">ğŸ”‘</span><span class="ldsp-action-text">ç‚¹å‡»ç™»å½•</span></div>
                                        <div class="ldsp-action-btn ldsp-logout-btn" data-clickable title="æ³¨é”€ç™»å½•"><span class="ldsp-action-icon">â»</span><span class="ldsp-action-text">æ³¨é”€</span></div>
                                        ${CURRENT_SITE.domain === 'linux.do' ? '<div class="ldsp-action-btn ldsp-ldc-btn" data-clickable title="Linux Do Credit"><span class="ldsp-action-icon">ğŸŸ</span><span class="ldsp-action-text">LDC</span></div>' : ''}
                                        ${CURRENT_SITE.domain === 'linux.do' ? '<div class="ldsp-action-btn ldsp-shop-btn" data-clickable title="LDå£«å¤š"><span class="ldsp-action-icon">ğŸ”</span><span class="ldsp-action-text">å£«å¤š</span></div>' : ''}
                                        ${CURRENT_SITE.domain === 'linux.do' ? '<div class="ldsp-action-btn ldsp-cdk-btn" data-clickable title="CDK ç³»ç»Ÿ"><span class="ldsp-action-icon">ğŸ</span><span class="ldsp-action-text">CDK</span></div>' : ''}
                                        <div class="ldsp-action-btn ldsp-melon-btn" data-clickable title="AI å¸–å­æ€»ç»“"><span class="ldsp-action-icon">ğŸ‰</span><span class="ldsp-action-text">æ€»ç»“</span></div>
                                        <div class="ldsp-action-btn ldsp-export-btn" data-clickable title="å¯¼å‡ºå¸–å­ä¸ºPDF/HTML"><span class="ldsp-action-icon">ğŸ“¥</span><span class="ldsp-action-text">å¯¼å‡º</span></div>
                                        <div class="ldsp-action-btn ldsp-ticket-btn" data-clickable title="å·¥å•ç³»ç»Ÿ"><span class="ldsp-action-icon">ğŸ“ª</span><span class="ldsp-action-text">å·¥å•</span></div>
                                    </div>
                                    <div class="ldsp-user-actions-toggle" data-clickable title="å±•å¼€æ›´å¤šæŒ‰é’®"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg><span class="ldsp-toggle-text">å±•å¼€æ›´å¤š</span></div>
                                </div>
                            </div>
                            <div class="ldsp-reading" data-clickable title="ç‚¹å‡»è®¿é—® LDStatus Pro å®˜ç½‘">
                                <div class="ldsp-reading-ripple"></div>
                                <span class="ldsp-reading-icon">ğŸŒ±</span>
                                <span class="ldsp-reading-time">--</span>
                                <span class="ldsp-reading-label">ä»Šæ—¥é˜…è¯»</span>
                            </div>
                        </div>
                        <div class="ldsp-tabs">
                            <button class="ldsp-tab active" data-tab="reqs"><span class="ldsp-tab-icon">ğŸ“‹</span><span class="ldsp-tab-text">è¦æ±‚</span></button>
                            <button class="ldsp-tab" data-tab="trends"><span class="ldsp-tab-icon">ğŸ“ˆ</span><span class="ldsp-tab-text">è¶‹åŠ¿</span></button>
                            ${this.hasLeaderboard ? '<button class="ldsp-tab" data-tab="leaderboard"><span class="ldsp-tab-icon">ğŸ†</span><span class="ldsp-tab-text">æ’è¡Œ</span></button>' : ''}
                            <button class="ldsp-tab" data-tab="activity"><span class="ldsp-tab-icon">ğŸ‘¤</span><span class="ldsp-tab-text">æˆ‘çš„</span></button>
                        </div>
                        <div class="ldsp-content">
                            <div id="ldsp-reqs" class="ldsp-section active"><div class="ldsp-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div></div>
                            <div id="ldsp-trends" class="ldsp-section"><div class="ldsp-empty"><div class="ldsp-empty-icon">ğŸ“Š</div><div class="ldsp-empty-txt">æš‚æ— å†å²æ•°æ®</div></div></div>
                            ${this.hasLeaderboard ? '<div id="ldsp-leaderboard" class="ldsp-section"><div class="ldsp-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div></div>' : ''}
                            <div id="ldsp-activity" class="ldsp-section"><div class="ldsp-empty"><div class="ldsp-empty-icon">ğŸ‘¤</div><div class="ldsp-empty-txt">é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æŸ¥çœ‹</div></div></div>
                        </div>
                        <div class="ldsp-confirm-overlay">
                            <div class="ldsp-confirm-box">
                                <div class="ldsp-confirm-icon">â»</div>
                                <div class="ldsp-confirm-title">ç¡®è®¤æ³¨é”€ç™»å½•å—ï¼Ÿ</div>
                                <div class="ldsp-confirm-msg">é€€å‡ºåæ’è¡Œæ¦œå’Œäº‘åŒæ­¥åŠŸèƒ½å°†ä¸å¯ç”¨</div>
                                <div class="ldsp-confirm-btns">
                                    <button class="ldsp-confirm-btn cancel">å–æ¶ˆ</button>
                                    <button class="ldsp-confirm-btn confirm">ç¡®è®¤æ³¨é”€</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ldsp-resize-handle ldsp-resize-e"></div>
                    <div class="ldsp-resize-handle ldsp-resize-s"></div>
                    <div class="ldsp-resize-handle ldsp-resize-se"></div>`;

                document.body.appendChild(this.el);
                
                // åˆå§‹åŒ–resizeåŠŸèƒ½ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
                this._initResize();
                
                // ç»‘å®šè‡ªå®šä¹‰ Tooltip
                Tooltip.bindToPanel(this.el);

                this.$ = {
                    header: this.el.querySelector('.ldsp-hdr'),
                    announcement: this.el.querySelector('.ldsp-announcement'),
                    announcementText: this.el.querySelector('.ldsp-announcement-text'),
                    user: this.el.querySelector('.ldsp-user'),
                    userDisplayName: this.el.querySelector('.ldsp-user-display-name'),
                    userHandle: this.el.querySelector('.ldsp-user-handle'),
                    ticketBtn: this.el.querySelector('.ldsp-ticket-btn'),
                    melonBtn: this.el.querySelector('.ldsp-melon-btn'),
                    exportBtn: this.el.querySelector('.ldsp-export-btn'),
                    ldcBtn: this.el.querySelector('.ldsp-ldc-btn'),
                    shopBtn: this.el.querySelector('.ldsp-shop-btn'),
                    cdkBtn: this.el.querySelector('.ldsp-cdk-btn'),
                    logoutBtn: this.el.querySelector('.ldsp-logout-btn'),
                    loginBtn: this.el.querySelector('.ldsp-login-btn'),
                    actionsArea: this.el.querySelector('.ldsp-user-actions'),
                    actionsToggle: this.el.querySelector('.ldsp-user-actions-toggle'),
                    confirmOverlay: this.el.querySelector('.ldsp-confirm-overlay'),
                    confirmCancel: this.el.querySelector('.ldsp-confirm-btn.cancel'),
                    confirmOk: this.el.querySelector('.ldsp-confirm-btn.confirm'),
                    panelBody: this.el.querySelector('.ldsp-body'),
                    reading: this.el.querySelector('.ldsp-reading'),
                    readingIcon: this.el.querySelector('.ldsp-reading-icon'),
                    readingTime: this.el.querySelector('.ldsp-reading-time'),
                    readingLabel: this.el.querySelector('.ldsp-reading-label'),
                    tabs: this.el.querySelectorAll('.ldsp-tab'),
                    sections: this.el.querySelectorAll('.ldsp-section'),
                    reqs: this.el.querySelector('#ldsp-reqs'),
                    trends: this.el.querySelector('#ldsp-trends'),
                    leaderboard: this.el.querySelector('#ldsp-leaderboard'),
                    activity: this.el.querySelector('#ldsp-activity'),
                    btnToggle: this.el.querySelector('.ldsp-toggle'),
                    btnRefresh: this.el.querySelector('.ldsp-refresh'),
                    btnTheme: this.el.querySelector('.ldsp-theme'),
                    btnUpdate: this.el.querySelector('.ldsp-update'),
                    btnCloudSync: this.el.querySelector('.ldsp-cloud-sync'),
                    updateBubble: this.el.querySelector('.ldsp-update-bubble'),
                    updateBubbleVer: this.el.querySelector('.ldsp-update-bubble-ver'),
                    updateBubbleBtn: this.el.querySelector('.ldsp-update-bubble-btn'),
                    updateBubbleClose: this.el.querySelector('.ldsp-update-bubble-close')
                };
            }

            _bindEvents() {
                // æ‹–æ‹½ï¼ˆæ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸ï¼‰
                let dragging = false, ox, oy, moved = false, sx, sy;
                const THRESHOLD = 5;

                const getPos = e => e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };

                // ä¿å­˜æ‹–æ‹½å¼€å§‹å‰çš„æ ·å¼ï¼Œä»¥ä¾¿åœ¨æ²¡æœ‰å®é™…ç§»åŠ¨æ—¶æ¢å¤
                let dragStartStyles = null;
                
                const startDrag = e => {
                    if (!this.el.classList.contains('collapsed') && e.target.closest('button')) return;
                    const p = getPos(e);
                    dragging = true;
                    moved = false;
                    // è·å–å½“å‰ä½ç½®
                    const rect = this.el.getBoundingClientRect();
                    
                    // ä¿å­˜æ‹–æ‹½å¼€å§‹å‰çš„æ ·å¼
                    dragStartStyles = {
                        left: this.el.style.left,
                        right: this.el.style.right,
                        top: this.el.style.top
                    };
                    
                    this.el.classList.add('no-trans');
                    // ç»Ÿä¸€åˆ‡æ¢åˆ° left å®šä½è¿›è¡Œæ‹–æ‹½
                    this.el.style.left = rect.left + 'px';
                    this.el.style.right = 'auto';
                    ox = p.x - rect.left;
                    oy = p.y - rect.top;
                    sx = p.x;
                    sy = p.y;
                    e.preventDefault();
                };

                const updateDrag = e => {
                    if (!dragging) return;
                    const p = getPos(e);
                    if (Math.abs(p.x - sx) > THRESHOLD || Math.abs(p.y - sy) > THRESHOLD) moved = true;
                    const { innerWidth: vw, innerHeight: vh } = window;
                    const w = this.el.offsetWidth, h = this.el.offsetHeight;
                    this.el.style.left = Math.max(8, Math.min(p.x - ox, vw - w - 8)) + 'px';
                    this.el.style.top = Math.max(8, Math.min(p.y - oy, vh - h - 8)) + 'px';
                };

                const endDrag = () => {
                    if (!dragging) return;
                    dragging = false;
                    this.el.classList.remove('no-trans');
                    
                    // å¦‚æœæ²¡æœ‰å®é™…ç§»åŠ¨ï¼Œæ¢å¤æ‹–æ‹½å¼€å§‹å‰çš„æ ·å¼
                    // è¿™æ ·ç‚¹å‡»æŠ˜å é¢æ¿æ—¶å°±ä¸ä¼šå› ä¸º hover ç¼©æ”¾å¯¼è‡´ä½ç½®åç§»
                    if (!moved) {
                        if (dragStartStyles) {
                            this.el.style.left = dragStartStyles.left;
                            this.el.style.right = dragStartStyles.right;
                            this.el.style.top = dragStartStyles.top;
                        }
                        dragStartStyles = null;
                        return;
                    }
                    dragStartStyles = null;
                    
                    // æ ¹æ®æœ€ç»ˆä½ç½®å†³å®šå®šä½æ¨¡å¼å’Œå±•å¼€æ–¹å‘
                    const rect = this.el.getBoundingClientRect();
                    const { innerWidth: vw } = window;
                    const centerX = rect.left + rect.width / 2;
                    const alignRight = centerX > vw / 2;
                    
                    if (alignRight) {
                        // åˆ‡æ¢åˆ° right å®šä½
                        const rightDist = Math.round(vw - rect.right);
                        this.el.style.right = rightDist + 'px';
                        this.el.style.left = 'auto';
                    }
                    // å·¦ä¾§ä¿æŒ left å®šä½ï¼ˆåœ¨ startDrag ä¸­å·²è®¾ç½®ï¼‰
                    
                    // æ›´æ–°å±•å¼€æ–¹å‘ç±»
                    this.el.classList.toggle('expand-left', alignRight);
                    this.el.classList.toggle('expand-right', !alignRight);
                    
                    // æ›´æ–°ç®­å¤´æ–¹å‘
                    this._updateArrow();
                    
                    this._savePosition();
                };

                // é¼ æ ‡äº‹ä»¶
                this.$.header.addEventListener('mousedown', e => !this.el.classList.contains('collapsed') && startDrag(e));
                this.el.addEventListener('mousedown', e => this.el.classList.contains('collapsed') && startDrag(e));
                document.addEventListener('mousemove', updateDrag);
                document.addEventListener('mouseup', endDrag);
                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯æ‹–æ‹½ï¼‰
                this.$.header.addEventListener('touchstart', e => !this.el.classList.contains('collapsed') && startDrag(e), { passive: false });
                this.el.addEventListener('touchstart', e => this.el.classList.contains('collapsed') && startDrag(e), { passive: false });
                document.addEventListener('touchmove', updateDrag, { passive: false });
                document.addEventListener('touchend', e => {
                    const wasDragging = dragging;
                    const isCollapsed = this.el.classList.contains('collapsed');
                    endDrag();
                    // è§¦æ‘¸æœªç§»åŠ¨ä¸”æ˜¯æŠ˜å çŠ¶æ€ï¼Œè§†ä¸ºç‚¹å‡»å±•å¼€
                    if (wasDragging && !moved && isCollapsed) {
                        this._toggle();
                    }
                    // ç§»åŠ¨ç«¯ï¼šæ¸…é™¤æŠ˜å  logo çš„ hover æ®‹ç•™æ•ˆæœ
                    if (isCollapsed && wasDragging) {
                        this.el.classList.add('no-hover-effect');
                        setTimeout(() => this.el.classList.remove('no-hover-effect'), 50);
                    }
                });

                // æŒ‰é’®äº‹ä»¶
                this.$.btnToggle.addEventListener('click', e => {
                    e.stopPropagation();
                    if (moved) { moved = false; return; }
                    this._toggle();
                });

                this.$.btnRefresh.addEventListener('click', () => {
                    if (this.loading) return;
                    this.animRing = true;
                    this.fetch();
                    // åˆ·æ–°æ•°æ®æ—¶åŒæ­¥æ£€æŸ¥æœªè¯»å·¥å•
                    this.ticketManager?._checkUnread();
                });

                this.$.btnTheme.addEventListener('click', () => this._switchTheme());
                this.$.btnUpdate.addEventListener('click', () => this._checkUpdate());
                
                // å½©è›‹ï¼šç‚¹å‡»å¤´åƒæ‰“å¼€GitHubä»“åº“
                this.$.user.addEventListener('click', e => {
                    if (e.target.closest('.ldsp-avatar-wrap')) {
                        window.open('https://github.com/caigg188/LDStatusPro', '_blank');
                    }
                });
                
                // æ³¨é”€ç™»å½•æŒ‰é’®ä¸ç¡®è®¤å¼¹çª—
                const showLogoutConfirm = () => {
                    if (!this.hasLeaderboard || !this.oauth?.isLoggedIn()) {
                        this.renderer.showToast('â„¹ï¸ å½“å‰æœªç™»å½•');
                        return;
                    }
                    this.$.confirmOverlay?.classList.add('show');
                };
                const hideLogoutConfirm = () => {
                    this.$.confirmOverlay?.classList.remove('show');
                };
                const doLogout = () => {
                    hideLogoutConfirm();
                    this.oauth.logout();
                    this.leaderboard?.stopSync();
                    this.renderer.showToast('âœ… å·²é€€å‡ºç™»å½•');
                    this._updateLoginUI();
                    this._renderLeaderboard();
                };
                // æ³¨é”€æŒ‰é’®ç‚¹å‡»
                this.$.logoutBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showLogoutConfirm();
                });
                // ç¡®è®¤å¼¹çª—æŒ‰é’®
                this.$.confirmCancel?.addEventListener('click', hideLogoutConfirm);
                this.$.confirmOk?.addEventListener('click', doLogout);
                // ç‚¹å‡»é®ç½©å…³é—­
                this.$.confirmOverlay?.addEventListener('click', (e) => {
                    if (e.target === this.$.confirmOverlay) hideLogoutConfirm();
                });
                
                // äº‘åŒæ­¥æŒ‰é’®ï¼ˆçŠ¶æ€ç”± CloudSyncManager çš„å›è°ƒè‡ªåŠ¨ç®¡ç†ï¼‰
                this.$.btnCloudSync?.addEventListener('click', async () => {
                    if (!this.hasLeaderboard || !this.oauth?.isLoggedIn()) return;
                    if (this.cloudSync.isSyncing()) return;  // æ­£åœ¨åŒæ­¥ä¸­ï¼Œå¿½ç•¥ç‚¹å‡»
                    try {
                        await this.cloudSync.fullSync();
                        this.renderer.showToast('âœ… æ•°æ®åŒæ­¥å®Œæˆ');
                        this.renderer.renderReading(this.tracker.getTodayTime(), this.tracker.isActive);
                        // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                        if (this.$.btnCloudSync) {
                            this.$.btnCloudSync.textContent = 'âœ…';
                            setTimeout(() => {
                                if (this.$.btnCloudSync) this.$.btnCloudSync.textContent = 'â˜ï¸';
                            }, 1000);
                        }
                    } catch (e) {
                        // v3.5.2.9: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼åŒ–
                        this.renderer.showToast(ErrorFormatter.withIcon(e));
                        // æ˜¾ç¤ºå¤±è´¥çŠ¶æ€
                        if (this.$.btnCloudSync) {
                            this.$.btnCloudSync.textContent = 'âŒ';
                            setTimeout(() => {
                                if (this.$.btnCloudSync) this.$.btnCloudSync.textContent = 'â˜ï¸';
                            }, 10000);
                        }
                    }
                });

                // å·¥å•æŒ‰é’®
                this.$.ticketBtn?.addEventListener('click', e => {
                    e.stopPropagation();
                    if (!this.hasLeaderboard || !this.oauth?.isLoggedIn()) {
                        this.renderer.showToast('âš ï¸ è¯·å…ˆç™»å½•åä½¿ç”¨å·¥å•åŠŸèƒ½');
                        return;
                    }
                    const mgr = this._ensureTicketManager();
                    mgr?.show();
                });

                // åƒç“œåŠ©æ‰‹æŒ‰é’®
                this.$.melonBtn?.addEventListener('click', e => {
                    e.stopPropagation();
                    this._ensureMelonHelper()?.show();
                });

                // å¯¼å‡ºå¸–å­æŒ‰é’®
                this.$.exportBtn?.addEventListener('click', e => {
                    e.stopPropagation();
                    this._ensureTopicExporter()?.show();
                });

                // LDC ç§¯åˆ†æŒ‰é’®ï¼ˆä»… linux.doï¼‰
                this.$.ldcBtn?.addEventListener('click', e => {
                    e.stopPropagation();
                    this._ensureLdcManager()?.show();
                });

                // å£«å¤šæŒ‰é’®ï¼ˆä»… linux.doï¼‰
                this.$.shopBtn?.addEventListener('click', e => {
                    e.stopPropagation();
                    this._ensureLdcManager()?.showShop();
                });

                // CDK æŒ‰é’®ï¼ˆä»… linux.doï¼‰
                this.$.cdkBtn?.addEventListener('click', e => {
                    e.stopPropagation();
                    this._ensureCdkManager()?.show();
                });
                
                // æŒ‰é’®åŒºåŸŸå±•å¼€/æ”¶èµ·
                this.$.actionsToggle?.addEventListener('click', e => {
                    e.stopPropagation();
                    const area = this.$.actionsArea;
                    const toggle = this.$.actionsToggle;
                    if (!area || !toggle) return;
                    
                    const isCollapsed = area.classList.contains('collapsed');
                    if (isCollapsed) {
                        area.classList.remove('collapsed');
                        toggle.classList.add('expanded');
                        toggle.querySelector('.ldsp-toggle-text').textContent = 'æ”¶èµ·';
                    } else {
                        area.classList.add('collapsed');
                        toggle.classList.remove('expanded');
                        toggle.querySelector('.ldsp-toggle-text').textContent = 'å±•å¼€æ›´å¤š';
                    }
                });
                
                // æ£€æŸ¥æŒ‰é’®åŒºåŸŸæ˜¯å¦éœ€è¦å±•å¼€/æ”¶èµ·åŠŸèƒ½ï¼ˆå»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå·²æ¸²æŸ“ï¼‰
                requestAnimationFrame(() => this._checkActionsOverflow());
                
                // å…³æ³¨/ç²‰ä¸åˆ†åˆ«ç‚¹å‡»
                this.el.querySelectorAll('.ldsp-follow-part').forEach(part => {
                    part.addEventListener('click', e => {
                        e.stopPropagation();
                        const username = this.storage.getUser();
                        if (!username) {
                            this.renderer.showToast('âš ï¸ è¯·å…ˆç™»å½•è®ºå›');
                            return;
                        }
                        const fm = this._ensureFollowManager();
                        if (fm) {
                            // æ ¹æ®ç‚¹å‡»çš„åŒºåŸŸæ‰“å¼€å¯¹åº”åˆ—è¡¨
                            const tabName = part.dataset.tab || 'following';
                            const tabs = fm.overlay.querySelectorAll('.ldsp-follow-tab');
                            tabs.forEach(t => t.classList.remove('active'));
                            const targetTab = fm.overlay.querySelector(`.ldsp-follow-tab[data-tab="${tabName}"]`);
                            targetTab?.classList.add('active');
                            fm.show();
                        }
                    });
                });
                
                // å…¼å®¹æ—§æ ·å¼çš„å…³æ³¨/ç²‰ä¸ç»Ÿè®¡ç‚¹å‡»
                this.el.querySelectorAll('.ldsp-follow-stat').forEach(stat => {
                    stat.addEventListener('click', e => {
                        e.stopPropagation();
                        const username = this.storage.getUser();
                        if (!username) {
                            this.renderer.showToast('âš ï¸ è¯·å…ˆç™»å½•è®ºå›');
                            return;
                        }
                        const fm = this._ensureFollowManager();
                        if (fm) {
                            // è®¾ç½®æ¿€æ´»çš„tab
                            const isFollowing = stat.classList.contains('ldsp-follow-stat-following');
                            const tabs = fm.overlay.querySelectorAll('.ldsp-follow-tab');
                            tabs.forEach(t => t.classList.remove('active'));
                            const targetTab = fm.overlay.querySelector(`.ldsp-follow-tab[data-tab="${isFollowing ? 'following' : 'followers'}"]`);
                            targetTab?.classList.add('active');
                            fm.show();
                        }
                    });
                });
                
                // é˜…è¯»å¡ç‰‡ç‚¹å‡»å½©è›‹ - è·³è½¬åˆ°å®˜ç½‘ï¼ˆåŠ¨æ€URLï¼‰
                this.$.reading?.addEventListener('click', async e => {
                    e.stopPropagation();
                    const url = await this.cloudSync?.getWebsiteUrl() || 'https://ldspro.qzz.io/';
                    window.open(url, '_blank');
                });

                // æ ‡ç­¾é¡µåˆ‡æ¢
                this.$.tabs.forEach((tab, i) => {
                    tab.addEventListener('click', () => {
                        this.$.tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
                        this.$.sections.forEach(s => s.classList.remove('active'));
                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                        this.el.querySelector(`#ldsp-${tab.dataset.tab}`).classList.add('active');

                        if (tab.dataset.tab === 'reqs') {
                            this.animRing = true;
                            this.cachedReqs.length && this.renderer.renderReqs(this.cachedReqs);
                        } else if (tab.dataset.tab === 'leaderboard') {
                            this._renderLeaderboard();
                        } else if (tab.dataset.tab === 'activity') {
                            this._renderActivity();
                        }
                    });

                    tab.addEventListener('keydown', e => {
                        if (['ArrowRight', 'ArrowLeft'].includes(e.key)) {
                            e.preventDefault();
                            const next = e.key === 'ArrowRight' ? (i + 1) % this.$.tabs.length : (i - 1 + this.$.tabs.length) % this.$.tabs.length;
                            this.$.tabs[next].click();
                            this.$.tabs[next].focus();
                        }
                    });
                });
                
                // ç›‘å¬ Token è¿‡æœŸäº‹ä»¶ï¼Œåˆ·æ–° UI
                window.addEventListener('ldsp_token_expired', () => {
                    this.renderer.showToast('âš ï¸ ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    this._renderLeaderboard();
                });
                
                // æ»šåŠ¨æ¡è‡ªåŠ¨éšè—ï¼šæ»šåŠ¨æ—¶æ˜¾ç¤ºï¼Œåœæ­¢åéšè—
                this._initScrollbarAutoHide();
            }
            
            _initScrollbarAutoHide() {
                // ä½¿ç”¨é—­åŒ…å­˜å‚¨çŠ¶æ€ï¼Œé¿å…æ±¡æŸ“å®ä¾‹å±æ€§
                const timers = new WeakMap();
                const showScrollbar = (el) => {
                    if (this._programmaticScroll) return; // å¿½ç•¥ç¨‹åºæ€§æ»šåŠ¨
                    el.classList.add('scrolling');
                    clearTimeout(timers.get(el));
                    timers.set(el, setTimeout(() => el.classList.remove('scrolling'), 800));
                };
                // äº‹ä»¶å§”æ‰˜ï¼šæ•è·æ‰€æœ‰å¯æ»šåŠ¨å…ƒç´ çš„æ»šåŠ¨äº‹ä»¶
                this.el.addEventListener('scroll', (e) => {
                    const t = e.target;
                    if (t.classList.contains('ldsp-content') || 
                        t.classList.contains('ldsp-subtabs') || 
                        t.classList.contains('ldsp-year-heatmap')) {
                        showScrollbar(t);
                    }
                }, { capture: true, passive: true });
            }
            
            // ç¨‹åºæ€§æ»šåŠ¨ï¼ˆä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ï¼‰
            _scrollTo(el, top) {
                this._programmaticScroll = true;
                el.scrollTop = top;
                requestAnimationFrame(() => { this._programmaticScroll = false; });
            }
            
            // æ£€æŸ¥æŒ‰é’®åŒºåŸŸæ˜¯å¦éœ€è¦å±•å¼€/æ”¶èµ·åŠŸèƒ½
            _checkActionsOverflow() {
                const area = this.$.actionsArea;
                const toggle = this.$.actionsToggle;
                if (!area || !toggle) return;
                
                // è·å–æ‰€æœ‰å¯è§çš„æ“ä½œæŒ‰é’®ï¼ˆæ’é™¤ç™»å½•æŒ‰é’®ï¼Œå› ä¸ºå®ƒå’Œæ³¨é”€æŒ‰é’®äº’æ–¥æ˜¾ç¤ºï¼‰
                const buttons = Array.from(area.querySelectorAll('.ldsp-action-btn')).filter(btn => {
                    const style = getComputedStyle(btn);
                    return style.display !== 'none';
                });
                
                if (buttons.length === 0) {
                    toggle.classList.remove('show');
                    area.classList.remove('collapsed');
                    return;
                }
                
                // ä¸´æ—¶ç§»é™¤æŠ˜å çŠ¶æ€æ¥è®¡ç®—å®é™…é«˜åº¦
                const _wasCollapsed = area.classList.contains('collapsed');
                area.classList.remove('collapsed');
                
                // å¼ºåˆ¶é‡æ’ä»¥è·å–æ­£ç¡®çš„å¸ƒå±€ä¿¡æ¯
                area.offsetHeight;
                
                // é€šè¿‡æ¯”è¾ƒæŒ‰é’®ä½ç½®æ¥åˆ¤æ–­è¡Œæ•°
                const firstBtn = buttons[0];
                const firstTop = firstBtn.getBoundingClientRect().top;
                let rows = 1;
                let lastTop = firstTop;
                
                for (const btn of buttons) {
                    const btnTop = btn.getBoundingClientRect().top;
                    if (btnTop > lastTop + 5) { // å…è®¸5pxè¯¯å·®
                        rows++;
                        lastTop = btnTop;
                    }
                }
                
                // è¶…è¿‡2è¡Œåˆ™æ˜¾ç¤ºå±•å¼€æŒ‰é’®å¹¶æŠ˜å ï¼ˆæŠ˜å ååªæ˜¾ç¤º1è¡Œï¼‰
                if (rows > 2) {
                    toggle.classList.add('show');
                    area.classList.add('collapsed');
                } else {
                    toggle.classList.remove('show');
                    area.classList.remove('collapsed');
                }
            }

            _restore() {
                const isCollapsed = this.storage.getGlobal('collapsed', false);
                if (isCollapsed) {
                    this.el.classList.add('collapsed');
                }

                const theme = this.storage.getGlobal('theme', 'light');
                if (theme === 'light') this.el.classList.add('light');
                this.$.btnTheme.textContent = theme === 'dark' ? 'ğŸŒ“' : 'â˜€ï¸';

                requestAnimationFrame(() => {
                    // _restorePosition ä¼šè®¾ç½®ä½ç½®å’Œ expand-left/expand-right ç±»
                    this._restorePosition();
                    // æ›´æ–°ç®­å¤´æ–¹å‘
                    this._updateArrow();
                });
            }

            _updateExpandDir() {
                const rect = this.el.getBoundingClientRect();
                const center = rect.left + rect.width / 2;
                const alignRight = center > innerWidth / 2;
                this.el.classList.toggle('expand-left', alignRight);
                this.el.classList.toggle('expand-right', !alignRight);
            }
            
            _updateArrow() {
                const isCollapsed = this.el.classList.contains('collapsed');
                const alignRight = this.el.classList.contains('expand-left');
                const arrow = this.$.btnToggle.querySelector('.ldsp-toggle-arrow');
                if (arrow) {
                    // æŠ˜å æ—¶ç®­å¤´æŒ‡å‘å±•å¼€æ–¹å‘ï¼Œå±•å¼€æ—¶ç®­å¤´æŒ‡å‘æŠ˜å æ–¹å‘
                    if (isCollapsed) {
                        arrow.textContent = alignRight ? 'â—€' : 'â–¶';
                    } else {
                        arrow.textContent = alignRight ? 'â–¶' : 'â—€';
                    }
                }
            }

            _onResize() {
                const cfg = Screen.getConfig();
                const el = this.el;
                const isCollapsed = el.classList.contains('collapsed');
                
                // çª—å£å˜åŒ–æ—¶æ¢å¤ä½ç½®ï¼ˆä¼šåŒæ—¶æ›´æ–° expand-left/expand-right ç±»ï¼‰
                this._restorePosition();
                
                // é‡æ–°æ£€æµ‹æŒ‰é’®åŒºåŸŸæº¢å‡ºï¼ˆå»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿å¸ƒå±€å·²æ›´æ–°ï¼‰
                requestAnimationFrame(() => this._checkActionsOverflow());
                
                if (isCollapsed) return;
                
                // æ›´æ–°CSSå˜é‡
                el.style.setProperty('--w', `${cfg.width}px`);
                el.style.setProperty('--h', `${cfg.maxHeight}px`);
                el.style.setProperty('--fs', `${cfg.fontSize}px`);
                el.style.setProperty('--pd', `${cfg.padding}px`);
                el.style.setProperty('--av', `${cfg.avatarSize}px`);
                el.style.setProperty('--ring', `${cfg.ringSize}px`);
                
                el.style.width = `${cfg.width}px`;
                el.style.maxHeight = `${cfg.maxHeight}px`;
            }
            
            /**
             * ä¿å­˜ä½ç½®ï¼ˆæ‹–æ‹½åè°ƒç”¨ï¼‰
             * 
             * å­˜å‚¨æ ¼å¼ï¼š{ topRatio, anchorX, alignRight }
             * ç›´æ¥ä» inline style è¯»å–ä½ç½®ï¼Œé¿å…ç²¾åº¦ç´¯ç§¯è¯¯å·®
             */
            _savePosition() {
                const el = this.el;
                const rect = el.getBoundingClientRect();
                const { innerWidth: vw, innerHeight: vh } = window;
                
                const centerX = rect.left + rect.width / 2;
                const alignRight = centerX > vw / 2;
                
                // ç›´æ¥ä» inline style è¯»å–é”šç‚¹ä½ç½®ï¼Œå–æ•´é¿å…ç²¾åº¦é—®é¢˜
                let anchorX;
                if (alignRight) {
                    const styleRight = parseFloat(el.style.right);
                    anchorX = !isNaN(styleRight) ? Math.round(styleRight) : Math.round(vw - rect.right);
                } else {
                    const styleLeft = parseFloat(el.style.left);
                    anchorX = !isNaN(styleLeft) ? Math.round(styleLeft) : Math.round(rect.left);
                }
                
                this.storage.setGlobalNow('position', { 
                    topRatio: rect.top / vh,
                    anchorX,
                    alignRight 
                });
            }
            
            /**
             * æ¢å¤ä½ç½®
             * æ ¹æ® alignRight ä½¿ç”¨ä¸åŒçš„å®šä½æ¨¡å¼ï¼Œé”šå®šè¾¹ç¼˜ä½ç½®ä¸å˜
             */
            _restorePosition() {
                const el = this.el;
                const pos = this.storage.getGlobal('position');
                const { innerWidth: vw, innerHeight: vh } = window;
                const margin = 8;
                const isCollapsed = el.classList.contains('collapsed');
                const cfg = Screen.getConfig();
                
                // æŠ˜å çŠ¶æ€å°ºå¯¸å¸¸é‡
                const COLLAPSED_SIZE = 48;
                const panelWidth = isCollapsed ? COLLAPSED_SIZE : (parseInt(el.style.width) || cfg.width);
                const panelHeight = isCollapsed ? COLLAPSED_SIZE : (parseInt(el.style.maxHeight) || cfg.maxHeight);
                
                let alignRight = true;
                let anchorX = 20;
                let top;
                
                if (pos && typeof pos.alignRight === 'boolean') {
                    alignRight = pos.alignRight;
                    anchorX = pos.anchorX ?? 20;
                    top = pos.topRatio !== undefined ? pos.topRatio * vh : pos.top;
                } else if (pos && (pos.left !== undefined || pos.leftDist !== undefined)) {
                    // å…¼å®¹æ—§æ ¼å¼
                    const leftDist = parseFloat(pos.left || pos.leftDist);
                    top = parseFloat(pos.top || 0);
                    alignRight = leftDist + panelWidth / 2 > vw / 2;
                    anchorX = alignRight ? (vw - leftDist - panelWidth) : leftDist;
                } else if (pos && pos.rightDist !== undefined) {
                    // å…¼å®¹ä¸Šä¸€ç‰ˆæœ¬æ ¼å¼
                    alignRight = pos.alignRight;
                    anchorX = alignRight ? pos.rightDist : pos.leftDist;
                    top = pos.topRatio !== undefined ? pos.topRatio * vh : 0;
                } else {
                    // é»˜è®¤ä½ç½®
                    top = vh - panelHeight - 20;
                }
                
                // ç¡®ä¿åœ¨è§†å£å†…
                top = Math.max(margin, Math.min(top, vh - panelHeight - margin));
                anchorX = Math.max(margin, Math.min(anchorX, vw - panelWidth - margin));
                
                // å–æ•´é¿å…ç²¾åº¦é—®é¢˜
                anchorX = Math.round(anchorX);
                top = Math.round(top);
                
                if (alignRight) {
                    // é å³ï¼šä½¿ç”¨ right å®šä½
                    el.style.right = `${anchorX}px`;
                    el.style.left = 'auto';
                } else {
                    // é å·¦ï¼šä½¿ç”¨ left å®šä½
                    el.style.left = `${anchorX}px`;
                    el.style.right = 'auto';
                }
                el.style.top = `${top}px`;
                
                // æ›´æ–°å±•å¼€æ–¹å‘ç±»
                el.classList.toggle('expand-left', alignRight);
                el.classList.toggle('expand-right', !alignRight);
            }

            // åˆå§‹åŒ–é¢æ¿æ‰‹åŠ¨è°ƒæ•´å¤§å°åŠŸèƒ½ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
            _initResize() {
                // æ£€æµ‹æ˜¯å¦ä¸ºæ¡Œé¢ç«¯ï¼ˆæœ‰é¼ æ ‡æ‚¬åœèƒ½åŠ›ä¸”æ˜¯ç²¾ç¡®æŒ‡é’ˆï¼‰
                if (!window.matchMedia('(hover:hover) and (pointer:fine)').matches) return;
                
                const el = this.el;
                const handles = el.querySelectorAll('.ldsp-resize-handle');
                if (!handles.length) return;
                
                let startX, startY, startW, startH, startLeft, startTop, direction;
                const minW = 220, maxW = 420, minH = 300;
                
                const onMouseMove = (e) => {
                    if (!direction) return;
                    e.preventDefault();
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    const { innerWidth: vw, innerHeight: vh } = window;
                    
                    // æ ¹æ®æ–¹å‘è°ƒæ•´å°ºå¯¸
                    if (direction.includes('e')) {
                        const newW = Math.max(minW, Math.min(maxW, startW + dx));
                        // ç¡®ä¿ä¸è¶…å‡ºå³è¾¹ç•Œ
                        if (startLeft + newW <= vw - 8) {
                            el.style.width = `${newW}px`;
                            el.style.setProperty('--w', `${newW}px`);
                        }
                    }
                    if (direction.includes('s')) {
                        const newH = Math.max(minH, Math.min(vh - startTop - 20, startH + dy));
                        el.style.maxHeight = `${newH}px`;
                        el.style.setProperty('--h', `${newH}px`);
                    }
                };
                
                const onMouseUp = () => {
                    if (!direction) return;
                    direction = null;
                    el.classList.remove('resizing');
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    
                    // ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰çš„å°ºå¯¸
                    this.storage.setGlobalNow('customSize', {
                        width: parseInt(el.style.width),
                        height: parseInt(el.style.maxHeight)
                    });
                };
                
                handles.forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        if (el.classList.contains('collapsed')) return;
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // åˆ¤æ–­è°ƒæ•´æ–¹å‘
                        if (handle.classList.contains('ldsp-resize-e')) direction = 'e';
                        else if (handle.classList.contains('ldsp-resize-s')) direction = 's';
                        else if (handle.classList.contains('ldsp-resize-se')) direction = 'se';
                        
                        const rect = el.getBoundingClientRect();
                        startX = e.clientX;
                        startY = e.clientY;
                        startW = rect.width;
                        startH = rect.height;
                        startLeft = rect.left;
                        startTop = rect.top;
                        
                        el.classList.add('resizing');
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });
                });
                
                // æ¢å¤ç”¨æˆ·è‡ªå®šä¹‰çš„å°ºå¯¸
                const customSize = this.storage.getGlobal('customSize');
                if (customSize) {
                    if (customSize.width >= minW && customSize.width <= maxW) {
                        el.style.width = `${customSize.width}px`;
                        el.style.setProperty('--w', `${customSize.width}px`);
                    }
                    if (customSize.height >= minH) {
                        const maxH = window.innerHeight - 50;
                        const h = Math.min(customSize.height, maxH);
                        el.style.maxHeight = `${h}px`;
                        el.style.setProperty('--h', `${h}px`);
                    }
                }
            }

            /**
             * é¢æ¿å±•å¼€/æŠ˜å åˆ‡æ¢
             * 
             * è®¾è®¡åŸåˆ™ï¼š
             * - å·¦ä¾§é¢æ¿ï¼ˆé å·¦å¯¹é½ï¼‰ï¼šæŠ˜å /å±•å¼€æ—¶ä¿æŒå·¦è¾¹ç¼˜ä½ç½®ä¸å˜
             * - å³ä¾§é¢æ¿ï¼ˆé å³å¯¹é½ï¼‰ï¼šæŠ˜å /å±•å¼€æ—¶ä¿æŒå³è¾¹ç¼˜ä½ç½®ä¸å˜
             * 
             * å®ç°æ–¹å¼ï¼š
             * - è¯»å–å·²ä¿å­˜çš„ alignRight æ¥ç¡®å®šå¯¹é½æ–¹å‘ï¼ˆé¿å…å› å°ºå¯¸å˜åŒ–å¯¼è‡´åˆ¤æ–­ä¸ä¸€è‡´ï¼‰
             * - æ ¹æ®å½“å‰å®šä½æ¨¡å¼è¯»å–æ­£ç¡®çš„é”šç‚¹ä½ç½®
             * - left å®šä½çš„é¢æ¿å– left å€¼ï¼Œright å®šä½çš„é¢æ¿å– right å€¼
             */
            _toggle() {
                if (this._toggleAnimating) return;
                this._toggleAnimating = true;
                
                const el = this.el;
                const isCurrentlyCollapsed = el.classList.contains('collapsed');
                const willCollapse = !isCurrentlyCollapsed;
                const { innerWidth: vw } = window;
                
                // ä»å·²ä¿å­˜çš„ä½ç½®è·å–å¯¹é½æ–¹å‘ï¼Œé¿å…å› é¢æ¿å°ºå¯¸å˜åŒ–å¯¼è‡´åˆ¤æ–­ä¸ä¸€è‡´
                const savedPos = this.storage.getGlobal('position');
                const alignRight = savedPos?.alignRight ?? el.classList.contains('expand-left');
                
                // 1. ç«‹å³ç¦ç”¨è¿‡æ¸¡å’Œæ¸…é™¤ transformï¼ˆé¿å… hover ç¼©æ”¾æ•ˆæœå½±å“ä½ç½®è®¡ç®—ï¼‰
                el.classList.add('no-trans');
                el.classList.remove('anim');
                el.style.transform = 'none';
                
                // å¼ºåˆ¶åº”ç”¨æ ·å¼
                void el.offsetWidth;
                
                // 2. è·å–å½“å‰é”šç‚¹ä½ç½®ï¼ˆç›´æ¥ä½¿ç”¨ä¿å­˜çš„å€¼æœ€å¯é ï¼‰
                let anchorX = savedPos?.anchorX;
                
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å€¼ï¼Œä» style æˆ– rect è®¡ç®—
                if (anchorX === undefined || anchorX === null) {
                    if (alignRight) {
                        const styleRight = parseFloat(el.style.right);
                        if (!isNaN(styleRight)) {
                            anchorX = styleRight;
                        } else {
                            const rect = el.getBoundingClientRect();
                            anchorX = vw - rect.right;
                        }
                    } else {
                        const styleLeft = parseFloat(el.style.left);
                        if (!isNaN(styleLeft)) {
                            anchorX = styleLeft;
                        } else {
                            const rect = el.getBoundingClientRect();
                            anchorX = rect.left;
                        }
                    }
                }
                
                // 3. è®¾ç½®å®šä½æ¨¡å¼ï¼ˆå–æ•´é¿å…ç²¾åº¦é—®é¢˜ï¼‰
                anchorX = Math.round(anchorX);
                if (alignRight) {
                    el.style.right = anchorX + 'px';
                    el.style.left = 'auto';
                } else {
                    el.style.left = anchorX + 'px';
                    el.style.right = 'auto';
                }
                
                // æ¸…é™¤å†…è” transformï¼ˆè®© CSS ç±»æ§åˆ¶ï¼‰
                el.style.transform = '';
                
                // æ›´æ–°å±•å¼€æ–¹å‘ç±»
                el.classList.toggle('expand-left', alignRight);
                el.classList.toggle('expand-right', !alignRight);
                
                // 4. å¼ºåˆ¶æµè§ˆå™¨åº”ç”¨å®šä½æ¨¡å¼
                void el.offsetWidth;
                
                // 5. å¯ç”¨è¿‡æ¸¡åŠ¨ç”»
                el.classList.remove('no-trans');
                el.classList.add('anim');
                
                // 6. åˆ‡æ¢æŠ˜å çŠ¶æ€ï¼ˆä½¿ç”¨ rAF ç¡®ä¿è¿‡æ¸¡ç”Ÿæ•ˆï¼‰
                requestAnimationFrame(() => {
                    el.classList.toggle('collapsed');
                    
                    // æ›´æ–°ç®­å¤´æ–¹å‘
                    this._updateArrow();
                    
                    // ä¿å­˜æŠ˜å çŠ¶æ€
                    this.storage.setGlobalNow('collapsed', willCollapse);
                    
                    // å±•å¼€æ—¶çš„é¢å¤–å¤„ç†
                    if (!willCollapse) {
                        this.animRing = true;
                        this.cachedReqs.length && setTimeout(() => this.renderer.renderReqs(this.cachedReqs), 100);
                    }

                    // 7. åŠ¨ç”»ç»“æŸåæ¸…ç†çŠ¶æ€
                    setTimeout(() => {
                        el.classList.remove('anim');
                        // ä¿å­˜ä½ç½®ï¼ˆä¿æŒå½“å‰çš„ alignRightï¼Œåªæ›´æ–° anchorX å’Œ topï¼‰
                        this._savePositionKeepAlign(alignRight);
                        this._toggleAnimating = false;
                    }, 420);
                });
            }
            
            /**
             * ä¿å­˜ä½ç½®ï¼Œä½†ä¿æŒæŒ‡å®šçš„å¯¹é½æ–¹å‘
             * å®Œå…¨ä» inline style è¯»å–ä½ç½®å€¼ï¼Œé¿å… getBoundingClientRect åœ¨åŠ¨ç”»æœŸé—´çš„ä¸ç¨³å®šå€¼
             */
            _savePositionKeepAlign(alignRight) {
                const el = this.el;
                const { innerWidth: vw, innerHeight: vh } = window;
                
                // ç›´æ¥ä» inline style è¯»å–é”šç‚¹ä½ç½®
                let anchorX;
                if (alignRight) {
                    const styleRight = parseFloat(el.style.right);
                    // å¦‚æœ style.right æ˜¯ 'auto' æˆ–æ— æ•ˆå€¼ï¼Œä» rect è®¡ç®—
                    if (!isNaN(styleRight)) {
                        anchorX = Math.round(styleRight);
                    } else {
                        const rect = el.getBoundingClientRect();
                        anchorX = Math.round(vw - rect.right);
                    }
                } else {
                    const styleLeft = parseFloat(el.style.left);
                    // å¦‚æœ style.left æ˜¯ 'auto' æˆ–æ— æ•ˆå€¼ï¼Œä» rect è®¡ç®—
                    if (!isNaN(styleLeft)) {
                        anchorX = Math.round(styleLeft);
                    } else {
                        const rect = el.getBoundingClientRect();
                        anchorX = Math.round(rect.left);
                    }
                }
                
                // ç¡®ä¿ anchorX åœ¨åˆç†èŒƒå›´å†…ï¼ˆé˜²æ­¢ä¿å­˜æ— æ•ˆå€¼ï¼‰
                anchorX = Math.max(8, anchorX);
                
                // top ä¹Ÿä» style è¯»å–ï¼Œé¿å…åŠ¨ç”»æœŸé—´ getBoundingClientRect çš„ä¸ç¨³å®š
                const styleTop = parseFloat(el.style.top);
                const topRatio = !isNaN(styleTop) ? styleTop / vh : undefined;
                
                // å¦‚æœæœ‰æœ‰æ•ˆçš„ topRatioï¼Œåˆ™ä¿å­˜ï¼›å¦åˆ™ä¿ç•™ä¹‹å‰çš„å€¼
                if (topRatio !== undefined) {
                    this.storage.setGlobalNow('position', { 
                        topRatio,
                        anchorX,
                        alignRight 
                    });
                } else {
                    // åªæ›´æ–° anchorXï¼Œä¿ç•™ä¹‹å‰çš„ topRatio
                    const oldPos = this.storage.getGlobal('position') || {};
                    this.storage.setGlobalNow('position', { 
                        ...oldPos,
                        anchorX,
                        alignRight 
                    });
                }
            }

            _switchTheme() {
                const light = this.el.classList.toggle('light');
                this.$.btnTheme.textContent = light ? 'â˜€ï¸' : 'ğŸŒ“';
                this.storage.setGlobalNow('theme', light ? 'light' : 'dark');
            }

            // ä»ç¼“å­˜åŠ è½½å¤´åƒï¼ˆä¼˜å…ˆåŠ¨æ€å¤´åƒï¼‰
            _loadAvatarFromCache() {
                // 1. ä¼˜å…ˆä½¿ç”¨ç¼“å­˜çš„åŠ¨æ€å¤´åƒ
                if (this.followManager?.animatedAvatar) {
                    this.renderer.renderAvatar(this.followManager.animatedAvatar);
                    return;
                }
                // 2. å…¶æ¬¡ä½¿ç”¨ç¼“å­˜çš„æ™®é€šå¤´åƒ
                if (this.avatar) {
                    this.renderer.renderAvatar(this.avatar);
                    return;
                }
                // 3. éƒ½æ²¡æœ‰åˆ™å°è¯•ä»é¡µé¢è·å–
                const el = document.querySelector('.current-user img.avatar');
                if (el) {
                    this._updateAvatar(el.src);
                }
            }

            // æ›´æ–°æ™®é€šå¤´åƒï¼ˆä»é¡µé¢è·å–æ—¶è°ƒç”¨ï¼‰
            _updateAvatar(url) {
                if (!url) return;
                if (url.startsWith('/')) url = `https://${CURRENT_SITE.domain}${url}`;
                url = url.replace(PATTERNS.AVATAR_SIZE, '/128/');
                // åªæœ‰å¤´åƒå˜åŒ–æ—¶æ‰æ›´æ–°
                if (this.avatar === url) return;
                this.avatar = url;
                this.storage.set('userAvatar', url);
                // åªæœ‰åœ¨æ²¡æœ‰åŠ¨æ€å¤´åƒæ—¶æ‰æ¸²æŸ“æ™®é€šå¤´åƒ
                if (!this.followManager?.animatedAvatar) {
                    this.renderer.renderAvatar(url);
                }
            }

            _startReadingUpdate() {
                if (this._readingTimer) return;
                this._readingTimer = setInterval(() => {
                    this.readingTime = this.tracker.getTodayTime();
                    this.renderer.renderReading(this.readingTime, this.tracker.isActive);
                }, CONFIG.INTERVALS.READING_UPDATE);
            }

            _setLoading(v) {
                this.loading = v;
                this.$.btnRefresh.disabled = v;
                this.$.btnRefresh.style.animation = v ? 'spin 1s linear infinite' : '';
            }

            async fetch() {
                if (this.loading) return;
                this._setLoading(true);
                this.$.reqs.innerHTML = `<div class="ldsp-loading"><div class="ldsp-spinner"></div><div>åŠ è½½ä¸­...</div></div>`;

                try {
                    const url = CURRENT_SITE.apiUrl;
                    
                    // ä½¿ç”¨ network.fetchï¼ˆåŒ…å« GM_xmlhttpRequest ç»•è¿‡è·¨åŸŸï¼Œä»¥åŠ fallbackï¼‰
                    const html = await this.network.fetch(url);
                    
                    if (!html) {
                        throw new Error('æ— æ³•è·å–æ•°æ®');
                    }
                    
                    await this._parse(html);
                } catch (e) {
                    // v3.5.2.9: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼åŒ–
                    this._showError(ErrorFormatter.format(e));
                    // å³ä½¿è·å–å‡çº§è¦æ±‚å¤±è´¥ï¼Œä¹Ÿè¦ç¡®ä¿é˜…è¯»è¿½è¸ªå™¨æ­£å¸¸åˆå§‹åŒ–
                    this._ensureTrackerInitialized();
                } finally {
                    this._setLoading(false);
                }
            }
            
            // ç¡®ä¿é˜…è¯»è¿½è¸ªå™¨å·²åˆå§‹åŒ–ï¼ˆåœ¨ç½‘ç»œé”™è¯¯ç­‰æƒ…å†µä¸‹ï¼‰
            _ensureTrackerInitialized() {
                // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨åœ¨è¿è¡Œï¼Œè¯´æ˜å·²åˆå§‹åŒ–
                if (this._readingTimer) return;
                
                // å°è¯•ä» OAuth è·å–ç”¨æˆ·å
                let username = this.username;
                if (!username && this.oauth?.isLoggedIn()) {
                    const oauthUser = this.oauth.getUserInfo();
                    if (oauthUser?.username) {
                        username = oauthUser.username;
                        this.storage.setUser(username);
                        this.username = username;
                    }
                }
                
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·å
                if (!username) {
                    username = this.storage.getUser();
                    if (username) this.username = username;
                }
                
                // åˆå§‹åŒ–é˜…è¯»è¿½è¸ªå™¨
                this.tracker.init(username || 'anonymous');
                this._startReadingUpdate();
                this.readingTime = this.tracker.getTodayTime();
                this.renderer.renderReading(this.readingTime, this.tracker.isActive);
                
                Logger.log(`é˜…è¯»è¿½è¸ªå™¨å·²é™çº§åˆå§‹åŒ–: ${username || 'anonymous'}`);
            }

            _showError(msg) {
                this.$.reqs.innerHTML = `<div class="ldsp-empty"><div class="ldsp-empty-icon">âŒ</div><div class="ldsp-empty-txt">${Utils.escapeHtml(msg)}</div></div>`;
            }

            // æ›´æ–°ä¿¡ä»»ç­‰çº§åˆ°æœåŠ¡ç«¯å’Œæœ¬åœ°ç¼“å­˜
            async _updateTrustLevel(connectLevel) {
                // åŒæ—¶æ£€æŸ¥ oauth å’Œ cloudSync.oauth çš„ç™»å½•çŠ¶æ€
                if (!this.oauth?.isLoggedIn() || !this.cloudSync?.oauth?.isLoggedIn()) return;
                
                const userInfo = this.oauth.getUserInfo();
                // v3.4.7: å…¼å®¹ trust_level å’Œ trustLevel ä¸¤ç§å‘½åæ ¼å¼
                const currentLevel = userInfo?.trust_level ?? userInfo?.trustLevel;
                
                // åªæœ‰å½“ç­‰çº§å˜åŒ–æ—¶æ‰æ›´æ–°
                if (currentLevel === connectLevel) return;
                
                try {
                    // æ›´æ–°æœåŠ¡ç«¯ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„ oauth å®ä¾‹ï¼‰
                    const result = await this.oauth.api('/api/user/trust-level', {
                        method: 'POST',
                        body: { trust_level: connectLevel }
                    });
                    
                    if (result?.success) {
                        // æ›´æ–°æœ¬åœ°ç¼“å­˜
                        const updatedUserInfo = { ...userInfo, trust_level: connectLevel };
                        this.oauth.setUserInfo(updatedUserInfo);
                    }
                } catch (e) { /* åŒæ­¥å¤±è´¥ï¼Œå¿½ç•¥ */ }
            }

            // å½“æ²¡æœ‰å‡çº§è¦æ±‚è¡¨æ ¼æ—¶æ˜¾ç¤ºå¤‡é€‰å†…å®¹
            // ä¼˜å…ˆçº§ï¼š1. æœåŠ¡ç«¯åŒæ­¥çš„æ•°æ® 2. summary API æ•°æ®
            async _showFallbackStats(username, level) {
                const $ = this.$;
                
                // ä¼˜å…ˆä» OAuth è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ›´å¯é ï¼Œå°¤å…¶åœ¨ç§»åŠ¨ç«¯ï¼‰
                let effectiveUsername = username;
                let numLevel = parseInt(level) || 0;
                
                if (this.oauth?.isLoggedIn()) {
                    const oauthUser = this.oauth.getUserInfo();
                    // ä¼˜å…ˆä½¿ç”¨ OAuth ä¸­çš„ç”¨æˆ·å
                    if (oauthUser?.username) {
                        effectiveUsername = oauthUser.username;
                    }
                    // v3.5.1: ä½¿ç”¨ä¼ å…¥çš„ç­‰çº§å’Œ OAuth ç¼“å­˜ä¸­è¾ƒé«˜çš„å€¼
                    // ä¼ å…¥çš„ç­‰çº§æ¥è‡ª connect é¡µé¢è§£æï¼Œæ˜¯æœ€æ–°çš„
                    // OAuth ç¼“å­˜å¯èƒ½æ˜¯ç™»å½•æ—¶çš„æ—§ç­‰çº§
                    const oauthTrustLevel = oauthUser?.trust_level ?? oauthUser?.trustLevel;
                    if (typeof oauthTrustLevel === 'number') {
                        numLevel = Math.max(numLevel, oauthTrustLevel);
                        // å¦‚æœä¼ å…¥çš„ç­‰çº§æ›´é«˜ï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜
                        if (parseInt(level) > oauthTrustLevel) {
                            const updatedUser = { ...oauthUser, trust_level: parseInt(level) };
                            this.oauth.setUserInfo(updatedUser);
                        }
                    }
                }
                
                // ç¡®ä¿é˜…è¯»è¿½è¸ªå™¨å·²åˆå§‹åŒ–ï¼ˆ_showFallbackStats å¯èƒ½åœ¨ tracker.init ä¹‹å‰è¢«è°ƒç”¨ï¼‰
                if (effectiveUsername && effectiveUsername !== 'æœªçŸ¥') {
                    if (!this.username) {
                        this.storage.setUser(effectiveUsername);
                        this.username = effectiveUsername;
                    }
                    this.tracker.init(effectiveUsername);
                    this._startReadingUpdate();
                    this.readingTime = this.tracker.getTodayTime();
                    this.renderer.renderReading(this.readingTime, this.tracker.isActive);
                } else {
                    // å³ä½¿æ²¡æœ‰ç”¨æˆ·åï¼Œä¹Ÿåˆå§‹åŒ–åŒ¿åæ¨¡å¼è¿½è¸ª
                    this.tracker.init('anonymous');
                    this._startReadingUpdate();
                }
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                if (effectiveUsername && effectiveUsername !== 'æœªçŸ¥') {
                    $.userDisplayName.textContent = effectiveUsername;
                    $.userHandle.textContent = '';
                    $.userHandle.style.display = 'none';
                }
                
                // === æ–¹æ¡ˆ1ï¼šä¼˜å…ˆä»æœåŠ¡ç«¯è·å–å·²åŒæ­¥çš„å‡çº§è¦æ±‚æ•°æ® ===
                // è¿™äº›æ•°æ®æ˜¯æ¡Œé¢ç«¯è§£æ connect é¡µé¢åä¸Šä¼ çš„ï¼Œæœ€å®Œæ•´å‡†ç¡®
                if (this.oauth?.isLoggedIn() && this.cloudSync) {
                    this.$.reqs.innerHTML = `<div class="ldsp-loading"><div class="ldsp-spinner"></div><div>æ­£åœ¨è·å–äº‘ç«¯æ•°æ®...</div></div>`;
                    try {
                        const cloudData = await this._fetchCloudRequirements();
                        if (cloudData && cloudData.length > 0) {
                            return this._renderCloudRequirements(cloudData, effectiveUsername, numLevel);
                        }
                    } catch (e) { /* äº‘ç«¯è·å–å¤±è´¥ï¼Œç»§ç»­å°è¯• summary */ }
                }
                
                // === æ–¹æ¡ˆ2ï¼šä» summary API è·å–ç»Ÿè®¡æ•°æ® ===
                if (effectiveUsername && effectiveUsername !== 'æœªçŸ¥') {
                    this.$.reqs.innerHTML = `<div class="ldsp-loading"><div class="ldsp-spinner"></div><div>æ­£åœ¨è·å–ç»Ÿè®¡æ•°æ®...</div></div>`;
                    const summaryData = await this._fetchSummaryData(effectiveUsername);
                    if (summaryData && Object.keys(summaryData).length > 0) {
                        return this._renderSummaryData(summaryData, effectiveUsername, numLevel);
                    }
                }
                
                // å¦‚æœæ— æ³•è·å– summary æ•°æ®ï¼Œæ˜¾ç¤ºç®€è¦ä¿¡æ¯
                this.$.reqs.innerHTML = `
                    <div class="ldsp-empty">
                        <div class="ldsp-empty-icon">ğŸ“Š</div>
                        <div class="ldsp-empty-txt">
                            <div style="margin-bottom:8px;">å½“å‰ä¿¡ä»»ç­‰çº§ï¼š<b style="color:#5a7de0;">${numLevel}</b></div>
                            <div style="font-size:12px;color:#6b7280;">æš‚æ— å‡çº§è¿›åº¦æ•°æ®</div>
                            <div style="margin-top:10px;font-size:11px;color:#9ca3af;">
                                <a href="https://linux.do/t/topic/2460" target="_blank" style="color:#5a7de0;text-decoration:none;">ğŸ“– æŸ¥çœ‹å®Œæ•´ä¿¡ä»»ç­‰çº§è¯´æ˜</a>
                            </div>
                        </div>
                    </div>`;
                
                // åˆå§‹åŒ– todayDataï¼ˆç”¨äºä»Šæ—¥è¶‹åŠ¿æ˜¾ç¤ºï¼‰
                const todayData = this._getTodayData();
                if (!todayData) {
                    this._setTodayData({}, true);
                }
                
                // ä½ä¿¡ä»»ç­‰çº§ç”¨æˆ·ä¹Ÿå¯ä»¥æŸ¥çœ‹é˜…è¯»æ—¶é—´è¶‹åŠ¿
                const history = this.historyMgr.getHistory();
                this.cachedHistory = history;
                this.cachedReqs = []; // ç©ºçš„å‡çº§è¦æ±‚æ•°ç»„
                this._renderTrends(history, []);
            }

            /**
             * ä»æœåŠ¡ç«¯è·å–æœ€è¿‘åŒæ­¥çš„å‡çº§è¦æ±‚æ•°æ®
             * v3.5.2.4 ä¼˜åŒ–ï¼šæ·»åŠ  30 åˆ†é’Ÿç¼“å­˜ï¼Œå‡å°‘é‡å¤è¯·æ±‚
             * äº‘ç«¯æ•°æ®ä¸»è¦ç”¨äºå†å²å¯¹æ¯”ï¼Œå®æ—¶æ•°æ®ä» LinuxDo è·å–
             * @param {boolean} forceRefresh - æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
             * @returns {Array|null} - å‡çº§è¦æ±‚æ•°ç»„æˆ– null
             */
            async _fetchCloudRequirements(forceRefresh = false) {
                // å‰ç½®ç™»å½•æ£€æŸ¥ï¼Œé¿å…æ— æ•ˆè¯·æ±‚
                if (!this.cloudSync?.oauth?.isLoggedIn()) return null;
                
                const now = Date.now();
                const CACHE_TTL = 30 * 60 * 1000; // 30 åˆ†é’Ÿç¼“å­˜ï¼ˆäº‘ç«¯æ•°æ®ç”¨äºå†å²å¯¹æ¯”ï¼Œä¸éœ€è¦é¢‘ç¹åˆ·æ–°ï¼‰
                
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
                if (!forceRefresh && this._cloudReqsCache && this._cloudReqsCacheTime) {
                    if ((now - this._cloudReqsCacheTime) < CACHE_TTL) {
                        Logger.log('[CloudReqs] Using cached data, age:', Math.round((now - this._cloudReqsCacheTime) / 1000), 's');
                        return this._cloudReqsCache;
                    }
                }
                
                try {
                    // è·å–æœ€è¿‘ä¸€å¤©çš„å†å²æ•°æ®
                    const result = await this.cloudSync.oauth.api('/api/requirements/history?days=1');
                    if (!result?.success || !result.data?.history?.length) {
                        return null;
                    }
                    
                    // å–æœ€æ–°çš„ä¸€æ¡è®°å½•
                    const latestRecord = result.data.history[result.data.history.length - 1];
                    if (!latestRecord?.data) return null;
                    
                    // è½¬æ¢ä¸ºå‡çº§è¦æ±‚æ•°ç»„æ ¼å¼
                    const reqs = [];
                    for (const [name, value] of Object.entries(latestRecord.data)) {
                        if (name === 'é˜…è¯»æ—¶é—´(åˆ†é’Ÿ)') continue; // è·³è¿‡é˜…è¯»æ—¶é—´
                        reqs.push({
                            name,
                            currentValue: value,
                            requiredValue: 0, // ä»é…ç½®è·å–
                            isSuccess: false,
                            change: 0,
                            isReverse: /ä¸¾æŠ¥|ç¦è¨€|å°ç¦/.test(name)
                        });
                    }
                    
                    const reqsData = reqs.length > 0 ? reqs : null;
                    
                    // æ›´æ–°ç¼“å­˜
                    this._cloudReqsCache = reqsData;
                    this._cloudReqsCacheTime = now;
                    
                    return reqsData;
                } catch (e) {
                    return null;
                }
            }

            /**
             * æ¸²æŸ“ä»äº‘ç«¯è·å–çš„å‡çº§è¦æ±‚æ•°æ®
             * @param {Array} cloudReqs - äº‘ç«¯æ•°æ®æ•°ç»„
             * @param {string} username - ç”¨æˆ·å
             * @param {number} level - ä¿¡ä»»ç­‰çº§
             */
            _renderCloudRequirements(cloudReqs, username, level) {
                // 2-4çº§ç”¨æˆ·çš„å‡çº§/ä¿æŒè¦æ±‚é…ç½®ï¼ˆåŸºäº connect é¡µé¢çš„ 14 é¡¹è¦æ±‚ï¼‰
                const LEVEL_2_PLUS_REQUIREMENTS = {
                    'è®¿é—®æ¬¡æ•°': 50,           // 50%
                    'å›å¤çš„è¯é¢˜': 10,
                    'æµè§ˆçš„è¯é¢˜': 500,
                    'æµè§ˆçš„è¯é¢˜ï¼ˆæ‰€æœ‰æ—¶é—´ï¼‰': 200,
                    'å·²è¯»å¸–å­': 20000,
                    'å·²è¯»å¸–å­ï¼ˆæ‰€æœ‰æ—¶é—´ï¼‰': 500,
                    'è¢«ä¸¾æŠ¥çš„å¸–å­': 5,         // æœ€å¤š5ä¸ªï¼ˆåå‘ï¼‰
                    'å‘èµ·ä¸¾æŠ¥çš„ç”¨æˆ·': 5,       // æœ€å¤š5ä¸ªï¼ˆåå‘ï¼‰
                    'ç‚¹èµ': 30,
                    'è·èµ': 20,
                    'è·èµï¼šå•æ—¥æœ€é«˜æ•°é‡': 7,
                    'è·èµï¼šç‚¹èµç”¨æˆ·æ•°é‡': 5,
                    'è¢«ç¦è¨€ï¼ˆè¿‡å» 6 ä¸ªæœˆï¼‰': 0, // å¿…é¡»ä¸º0ï¼ˆåå‘ï¼‰
                    'è¢«å°ç¦ï¼ˆè¿‡å» 6 ä¸ªæœˆï¼‰': 0  // å¿…é¡»ä¸º0ï¼ˆåå‘ï¼‰
                };
                
                // ä¸ºäº‘ç«¯æ•°æ®å¡«å……è¦æ±‚å€¼
                const reqs = cloudReqs.map(req => {
                    const requiredValue = LEVEL_2_PLUS_REQUIREMENTS[req.name] ?? 0;
                    const isReverse = /ä¸¾æŠ¥|ç¦è¨€|å°ç¦/.test(req.name);
                    const isSuccess = isReverse 
                        ? req.currentValue <= requiredValue 
                        : req.currentValue >= requiredValue;
                    
                    return {
                        ...req,
                        requiredValue,
                        isSuccess,
                        isReverse
                    };
                });
                
                // æŒ‰ç…§é…ç½®é¡ºåºæ’åº
                const orderedNames = Object.keys(LEVEL_2_PLUS_REQUIREMENTS);
                const orderedReqs = reqs.sort((a, b) => {
                    const idxA = orderedNames.indexOf(a.name);
                    const idxB = orderedNames.indexOf(b.name);
                    if (idxA === -1 && idxB === -1) return 0;
                    if (idxA === -1) return 1;
                    if (idxB === -1) return -1;
                    return idxA - idxB;
                });
                
                // æ£€æŸ¥æ˜¯å¦è¾¾æ ‡
                const isOK = orderedReqs.every(r => r.isSuccess);
                
                // ä¿å­˜å†å²æ•°æ®
                const histData = {};
                orderedReqs.forEach(r => histData[r.name] = r.currentValue);
                const history = this.historyMgr.addHistory(histData, this.readingTime);
                
                // ä¿å­˜ä»Šæ—¥æ•°æ®
                const todayData = this._getTodayData();
                this._setTodayData(histData, !todayData);
                
                // è·å–æ˜¾ç¤ºåç§°
                let displayName = null;
                if (this.hasLeaderboard && this.oauth?.isLoggedIn()) {
                    const oauthUser = this.oauth.getUserInfo();
                    if (oauthUser?.name && oauthUser.name !== oauthUser.username) {
                        displayName = oauthUser.name;
                    }
                }
                
                // æ¸²æŸ“
                this.renderer.renderUser(username, level.toString(), isOK, orderedReqs, displayName);
                this.renderer.renderReqs(orderedReqs, level);
                
                this.cachedHistory = history;
                this.cachedReqs = orderedReqs;
                
                this._renderTrends(history, orderedReqs);
                this._setLastVisit(histData);
                this.prevReqs = orderedReqs;
                
                return true;
            }
            
            /**
             * ä» summary.json API è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ® (ä½¿ç”¨ user_summary å­—æ®µ)
             * @param {string} username - ç”¨æˆ·å
             * @returns {Object|null} - ç»Ÿè®¡æ•°æ®å¯¹è±¡æˆ–null
             */
            async _fetchSummaryData(username) {
                try {
                    const baseUrl = `https://${CURRENT_SITE.domain}`;
                    const data = {};
                    
                    // ä¼˜å…ˆä½¿ç”¨ summary.json APIï¼ˆDiscourse æ ‡å‡† APIï¼‰çš„ user_summary å­—æ®µ
                    const jsonUrl = `${baseUrl}/u/${encodeURIComponent(username)}/summary.json`;
                    
                    // å°è¯•å¤šç§æ–¹å¼è·å–æ•°æ®ï¼Œå…¼å®¹ä¸åŒçš„ç”¨æˆ·è„šæœ¬ç®¡ç†å™¨
                    let jsonText = null;
                    
                    // æ–¹æ³•1: ä½¿ç”¨ GM_xmlhttpRequest
                    try {
                        jsonText = await this.network.fetch(jsonUrl, { maxRetries: 2, timeout: 10000, headers: buildAuthHeaders(jsonUrl) });
                    } catch (e) { /* GM fetch å¤±è´¥ */ }
                    
                    // æ–¹æ³•2: å¦‚æœ GM æ–¹å¼å¤±è´¥ï¼Œå°è¯•åŸç”Ÿ fetchï¼ˆåŒæºè¯·æ±‚æ›´å¯é ï¼‰
                    if (!jsonText) {
                        try {
                            const headers = buildAuthHeaders(jsonUrl, { 'Accept': 'application/json' });
                            const response = await fetch(jsonUrl, { 
                                credentials: 'include',
                                headers
                            });
                            if (response.ok) {
                                jsonText = await response.text();
                            }
                        } catch (e) { /* native fetch å¤±è´¥ */ }
                    }
                    
                    if (jsonText) {
                        try {
                            const json = JSON.parse(jsonText);
                            
                            // ä» user_summary å­—æ®µæå–ç»Ÿè®¡æ•°æ®
                            const stats = json?.user_summary;
                            if (stats) {
                                // æ˜ å°„ Discourse API å­—æ®µåˆ°æ˜¾ç¤ºåç§°
                                if (stats.days_visited !== undefined) data['è®¿é—®å¤©æ•°'] = stats.days_visited;
                                if (stats.topics_entered !== undefined) data['æµè§ˆè¯é¢˜'] = stats.topics_entered;
                                if (stats.posts_read_count !== undefined) data['å·²è¯»å¸–å­'] = stats.posts_read_count;
                                if (stats.likes_given !== undefined) data['é€å‡ºèµ'] = stats.likes_given;
                                if (stats.likes_received !== undefined) data['è·èµ'] = stats.likes_received;
                                if (stats.post_count !== undefined) data['å›å¤'] = stats.post_count;
                                if (stats.topic_count !== undefined) data['åˆ›å»ºè¯é¢˜'] = stats.topic_count;
                                // é¢å¤–æœ‰ç”¨çš„å­—æ®µ
                                if (stats.time_read !== undefined) data['é˜…è¯»æ—¶é—´'] = Math.round(stats.time_read / 60); // ç§’è½¬åˆ†é’Ÿ
                                
                                if (Object.keys(data).length > 0) {
                                    return data;
                                }
                            }
                        } catch (e) { /* JSON è§£æå¤±è´¥ */ }
                    }
                    
                    // æ–¹æ³•Bï¼šå›é€€åˆ° HTML è§£æ
                    const url = `${baseUrl}/u/${encodeURIComponent(username)}/summary`;
                    let html = null;
                    
                    // å…ˆå°è¯• GM_xmlhttpRequest
                    try {
                        html = await this.network.fetch(url, { maxRetries: 2, headers: buildAuthHeaders(url) });
                    } catch (e) { /* GM fetch å¤±è´¥ */ }
                    
                    // å¤‡ç”¨ï¼šåŸç”Ÿ fetch
                    if (!html) {
                        try {
                            const headers = buildAuthHeaders(url);
                            const resp = await fetch(url, { credentials: 'include', headers });
                            if (resp.ok) {
                                html = await resp.text();
                            }
                        } catch (e) { /* native fetch å¤±è´¥ */ }
                    }
                    
                    if (!html) {
                        return null;
                    }
                    
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    
                    // è¾…åŠ©å‡½æ•°ï¼šè§£ææ•°å€¼ï¼ˆæ”¯æŒ kã€m ç­‰ç¼©å†™å’Œé€—å·åˆ†éš”ï¼‰
                    const parseValue = (text) => {
                        if (!text) return 0;
                        const cleaned = text.replace(/,/g, '').trim();
                        const match = cleaned.match(/([\d.]+)\s*([kmä¸‡äº¿])?/i);
                        if (!match) return 0;
                        let value = parseFloat(match[1]);
                        const suffix = match[2]?.toLowerCase();
                        if (suffix === 'k' || suffix === 'ä¸‡') value *= 1000;
                        if (suffix === 'm' || suffix === 'äº¿') value *= 1000000;
                        return Math.round(value);
                    };
                    
                    // æ–¹æ³•1ï¼šé€šè¿‡ class åç§°æŸ¥æ‰¾ç»Ÿè®¡é¡¹ï¼ˆDiscourse æ ‡å‡†ç»“æ„ï¼‰
                    const statItems = doc.querySelectorAll('li[class*="stats-"], .stat-item, .user-stat');
                    statItems.forEach(item => {
                        const className = item.className || '';
                        const valueEl = item.querySelector('.value .number, .value, .stat-value');
                        if (!valueEl) return;
                        
                        // ä¼˜å…ˆä» title è·å–å®Œæ•´æ•°å€¼
                        let value = 0;
                        const titleAttr = valueEl.getAttribute('title') || item.getAttribute('title');
                        if (titleAttr) {
                            value = parseValue(titleAttr);
                        } else {
                            value = parseValue(valueEl.textContent);
                        }
                        
                        // æ ¹æ® class åç§°æ˜ å°„
                        if (className.includes('days-visited')) data['è®¿é—®å¤©æ•°'] = value;
                        else if (className.includes('topics-entered')) data['æµè§ˆè¯é¢˜'] = value;
                        else if (className.includes('posts-read')) data['å·²è¯»å¸–å­'] = value;
                        else if (className.includes('likes-given')) data['é€å‡ºèµ'] = value;
                        else if (className.includes('likes-received')) data['è·èµ'] = value;
                        else if (className.includes('post-count')) data['å›å¤'] = value;
                        else if (className.includes('topic-count')) data['åˆ›å»ºè¯é¢˜'] = value;
                        else if (className.includes('solved-count')) data['è§£å†³æ–¹æ¡ˆ'] = value;
                    });
                    
                    // æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1æ²¡æ‰¾åˆ°æ•°æ®ï¼Œå°è¯•é€šè¿‡æ ‡ç­¾æ–‡æœ¬åŒ¹é…
                    if (Object.keys(data).length === 0) {
                        // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½åŒ…å«ç»Ÿè®¡æ•°æ®çš„å…ƒç´ 
                        const allStats = doc.querySelectorAll('.stats-section li, .top-section li, .user-summary-stat');
                        allStats.forEach(item => {
                            const text = item.textContent.trim();
                            const labelEl = item.querySelector('.label, .stat-label');
                            const valueEl = item.querySelector('.value, .number, .stat-value');
                            
                            if (!labelEl && !valueEl) return;
                            
                            const label = (labelEl?.textContent || '').toLowerCase().trim();
                            let value = 0;
                            
                            if (valueEl) {
                                const titleAttr = valueEl.getAttribute('title') || item.getAttribute('title');
                                value = parseValue(titleAttr || valueEl.textContent);
                            }
                            
                            // æ ¹æ®æ ‡ç­¾æ–‡æœ¬åŒ¹é…
                            if (label.includes('è®¿é—®') || label.includes('visited') || text.includes('è®¿é—®å¤©æ•°')) {
                                data['è®¿é—®å¤©æ•°'] = value;
                            } else if (label.includes('æµè§ˆ') && label.includes('è¯é¢˜') || label.includes('topics') || text.includes('æµè§ˆçš„è¯é¢˜')) {
                                data['æµè§ˆè¯é¢˜'] = value;
                            } else if (label.includes('å·²è¯»') || label.includes('é˜…è¯»') || label.includes('posts read') || text.includes('å·²è¯»å¸–å­')) {
                                data['å·²è¯»å¸–å­'] = value;
                            } else if (label.includes('é€å‡º') || label.includes('given') || text.includes('å·²é€å‡º')) {
                                data['é€å‡ºèµ'] = value;
                            } else if (label.includes('æ”¶åˆ°') || label.includes('received') || text.includes('å·²æ”¶åˆ°')) {
                                data['è·èµ'] = value;
                            } else if (label.includes('å¸–å­') && !label.includes('å·²è¯»') || label.includes('åˆ›å»ºçš„å¸–å­') || text.includes('åˆ›å»ºçš„å¸–å­')) {
                                data['å›å¤'] = value;
                            } else if (label.includes('åˆ›å»º') && label.includes('è¯é¢˜') || text.includes('åˆ›å»ºçš„è¯é¢˜')) {
                                data['åˆ›å»ºè¯é¢˜'] = value;
                            }
                        });
                    }
                    
                    // æ–¹æ³•3ï¼šé€šç”¨æ–‡æœ¬è§£æï¼ˆä½œä¸ºæœ€åæ‰‹æ®µï¼‰
                    if (Object.keys(data).length === 0) {
                        const statsText = doc.body?.textContent || '';
                        // å°è¯•åŒ¹é… "æ•°å­—+æ ‡ç­¾" çš„æ¨¡å¼
                        const patterns = [
                            { regex: /([\d,.]+[km]?)\s*è®¿é—®å¤©æ•°/i, key: 'è®¿é—®å¤©æ•°' },
                            { regex: /([\d,.]+[km]?)\s*æµè§ˆçš„?è¯é¢˜/i, key: 'æµè§ˆè¯é¢˜' },
                            { regex: /([\d,.]+[km]?)\s*å·²è¯»å¸–å­/i, key: 'å·²è¯»å¸–å­' },
                            { regex: /([\d,.]+[km]?)\s*å·²?é€å‡º/i, key: 'é€å‡ºèµ' },
                            { regex: /([\d,.]+[km]?)\s*å·²?æ”¶åˆ°/i, key: 'è·èµ' },
                            { regex: /([\d,.]+[km]?)\s*åˆ›å»ºçš„å¸–å­/i, key: 'å›å¤' }
                        ];
                        patterns.forEach(p => {
                            const match = statsText.match(p.regex);
                            if (match) data[p.key] = parseValue(match[1]);
                        });
                    }
                    
                    return Object.keys(data).length > 0 ? data : null;
                } catch (e) {
                    return null;
                }
            }
            
            /**
             * æ¸²æŸ“ summary ç»Ÿè®¡æ•°æ®ï¼ˆä½ä¿¡ä»»ç­‰çº§ç”¨æˆ·ï¼‰
             * ä½¿ç”¨ä¸ 2 çº§ç”¨æˆ·ç›¸åŒçš„ renderReqs æ–¹æ³•æ˜¾ç¤ºè¿›åº¦
             */
            _renderSummaryData(data, username, level) {
                // æ„å»ºè¦æ±‚æ•°æ®ç»“æ„ï¼ˆç”¨äºæ˜¾ç¤ºå’Œè¶‹åŠ¿ï¼‰
                const reqs = [];
                
                // è¿™æ˜¯ connect é¡µé¢è·å–å¤±è´¥æ—¶çš„ fallback æ–¹æ¡ˆ
                // summary API åªèƒ½æä¾›æœ‰é™çš„ç´¯è®¡ç»Ÿè®¡æ•°æ®ï¼ˆçº¦8é¡¹ï¼‰
                // æ³¨æ„ï¼šsummary API è¿”å›çš„æ˜¯ç´¯è®¡æ€»æ•°ï¼Œè€Œ 2â†’3 çº§å‡çº§è¦æ±‚æ˜¯"è¿‡å»100å¤©"çš„æ•°æ®
                // å› æ­¤è¿™é‡Œçš„æ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½å®Œå…¨ä»£è¡¨å‡çº§è¿›åº¦
                // å‡çº§è¦æ±‚å‚è€ƒ: https://linux.do/t/topic/2460
                let statsConfig;
                
                if (level === 0) {
                    // 0çº§å‡1çº§è¦æ±‚ï¼š
                    // - è¿›å…¥5ä¸ªè¯é¢˜ã€é˜…è¯»30ç¯‡å¸–å­ã€é˜…è¯»10åˆ†é’Ÿ
                    statsConfig = [
                        { key: 'æµè§ˆè¯é¢˜', required: 5 },
                        { key: 'å·²è¯»å¸–å­', required: 30 },
                        { key: 'é˜…è¯»æ—¶é—´', required: 10 }  // 10åˆ†é’Ÿ
                    ];
                } else if (level === 1) {
                    // 1çº§å‡2çº§è¦æ±‚ï¼š
                    // - è®¿é—®15å¤©ã€æµè§ˆ20è¯é¢˜ã€é˜…è¯»100å¸–å­ã€é˜…è¯»60åˆ†é’Ÿ
                    // - é€å‡ºå’Œæ”¶åˆ°å„1ä¸ªèµã€å›å¤3ä¸ªä¸åŒè¯é¢˜
                    statsConfig = [
                        { key: 'è®¿é—®å¤©æ•°', required: 15 },
                        { key: 'æµè§ˆè¯é¢˜', required: 20 },
                        { key: 'å·²è¯»å¸–å­', required: 100 },
                        { key: 'é˜…è¯»æ—¶é—´', required: 60 },  // 60åˆ†é’Ÿ
                        { key: 'é€å‡ºèµ', required: 1 },
                        { key: 'è·èµ', required: 1 },
                        { key: 'å›å¤', required: 3 }  // 3ä¸ªä¸åŒè¯é¢˜
                    ];
                } else {
                    // 2çº§åŠä»¥ä¸Šç”¨æˆ·ï¼šä»…æ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼Œä¸æ˜¾ç¤ºå‡çº§è¦æ±‚
                    // é‡è¦ï¼š2çº§ç”¨æˆ·çš„å‡çº§è¿›åº¦åº”ä» connect é¡µé¢è·å–ï¼ˆæœ‰è¯¦ç»†çš„100å¤©å†…æ•°æ®ï¼‰
                    // è¿™é‡Œåªæ˜¯ connect é¡µé¢å®Œå…¨æ— æ³•è·å–æ—¶çš„å…œåº•æ–¹æ¡ˆ
                    // summary API è¿”å›çš„æ˜¯ç´¯è®¡æ•°æ®ï¼Œæ— æ³•åæ˜ çœŸå®çš„å‡çº§è¿›åº¦
                    statsConfig = [
                        { key: 'è®¿é—®å¤©æ•°', required: 0, isStats: true },
                        { key: 'æµè§ˆè¯é¢˜', required: 0, isStats: true },
                        { key: 'å·²è¯»å¸–å­', required: 0, isStats: true },
                        { key: 'é€å‡ºèµ', required: 0, isStats: true },
                        { key: 'è·èµ', required: 0, isStats: true },
                        { key: 'å›å¤', required: 0, isStats: true },
                        { key: 'åˆ›å»ºè¯é¢˜', required: 0, isStats: true },
                        { key: 'é˜…è¯»æ—¶é—´', required: 0, isStats: true }
                    ];
                }
                
                statsConfig.forEach(config => {
                    // è·å–å½“å‰å€¼ï¼ˆå¦‚æœæ²¡æœ‰æ•°æ®åˆ™é»˜è®¤ä¸º 0ï¼‰
                    const currentValue = data[config.key] !== undefined ? data[config.key] : 0;
                    const requiredValue = config.required;
                    const isSuccess = currentValue >= requiredValue;
                    const prev = this.prevReqs.find(p => p.name === config.key);
                    
                    reqs.push({
                        name: config.key,
                        currentValue,
                        requiredValue,
                        isSuccess,
                        change: prev ? currentValue - prev.currentValue : 0,
                        isReverse: false
                    });
                });
                
                // å¦‚æœæ²¡æœ‰ä»»ä½•é…ç½®é¡¹ï¼Œè¿”å› false
                if (reqs.length === 0) return false;
                
                // æ£€æŸ¥å‡çº§æ¡ä»¶
                const requiredItems = reqs.filter(r => r.requiredValue > 0);
                const metItems = requiredItems.filter(r => r.isSuccess);
                const isOK = requiredItems.length > 0 && metItems.length === requiredItems.length;
                
                // é€šçŸ¥æ£€æŸ¥
                this.notifier.check(reqs);
                
                // ä¿å­˜å†å²æ•°æ®
                const histData = {};
                reqs.forEach(r => histData[r.name] = r.currentValue);
                const history = this.historyMgr.addHistory(histData, this.readingTime);
                
                // ä¿å­˜ä»Šæ—¥æ•°æ®
                const todayData = this._getTodayData();
                this._setTodayData(histData, !todayData);
                
                // è·å– OAuth ç”¨æˆ·ä¿¡æ¯ä¸­çš„æ˜¾ç¤ºåç§°
                let displayName = null;
                if (this.hasLeaderboard && this.oauth?.isLoggedIn()) {
                    const oauthUser = this.oauth.getUserInfo();
                    if (oauthUser?.name && oauthUser.name !== oauthUser.username) {
                        displayName = oauthUser.name;
                    }
                }
                
                // æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®ï¼ˆä¸ 2 çº§ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„ renderReqs æ–¹æ³•ï¼‰
                this.renderer.renderUser(username, level.toString(), isOK, reqs, displayName);
                this.renderer.renderReqs(reqs, level);
                
                // ä¿å­˜ç¼“å­˜
                this.cachedHistory = history;
                this.cachedReqs = reqs;
                this.prevReqs = reqs;
                
                // 0-1çº§ç”¨æˆ·ä¹Ÿè§¦å‘æ•°æ®åŒæ­¥ï¼ˆé˜…è¯»æ—¶é—´ç­‰ï¼‰
                if (this.hasLeaderboard && this.cloudSync && this.oauth?.isLoggedIn()) {
                    // åŒæ­¥é˜…è¯»æ—¶é—´æ•°æ®
                    this.cloudSync.upload().catch(() => {});
                }
                
                // æ¸²æŸ“è¶‹åŠ¿
                this._renderTrends(history, reqs);
                
                return true;
            }
            
            async _parse(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                
                // å°è¯•è·å–ç”¨æˆ·åï¼ˆå³ä½¿æ²¡æœ‰å‡çº§è¦æ±‚æ•°æ®ä¹Ÿå¯èƒ½æœ‰ç”¨æˆ·ä¿¡æ¯ï¼‰
                const avatarEl = doc.querySelector('img[src*="avatar"]');
                
                // å°è¯•ä»é¡µé¢æå–ç”¨æˆ·åå’Œä¿¡ä»»ç­‰çº§
                let username = null;
                let level = '?';
                let connectLevel = null;  // ä» connect é¡µé¢è·å–çš„ç­‰çº§ï¼ˆæœ€æ–°ï¼‰
                
                // 1. ä¼˜å…ˆä» h1 æ ‡ç­¾è·å–ç­‰çº§ä¿¡æ¯: "ä½ å¥½ï¼Œæ˜µç§° (username) Xçº§ç”¨æˆ·"
                const h1El = doc.querySelector('h1');
                if (h1El) {
                    const h1Text = h1El.textContent;
                    const h1Match = h1Text.match(PATTERNS.TRUST_LEVEL_H1);
                    if (h1Match) {
                        username = h1Match[1];  // æ‹¬å·å†…çš„ username
                        connectLevel = parseInt(h1Match[2]) || 0;
                        level = connectLevel.toString();
                    }
                }
                
                // 2. ä»å¤´åƒ alt è·å–ç”¨æˆ·åï¼ˆå¤‡ç”¨ï¼‰
                if (!username && avatarEl?.alt) {
                    username = avatarEl.alt;
                }
                
                // 3. æŸ¥æ‰¾åŒ…å«ä¿¡ä»»çº§åˆ«çš„åŒºå—è·å–æ›´å¤šä¿¡æ¯
                const section = [...doc.querySelectorAll('.bg-white.p-6.rounded-lg')].find(d => d.querySelector('h2')?.textContent.includes('ä¿¡ä»»çº§åˆ«'));
                

                
                // å¦‚æœæ²¡æ‰¾åˆ° sectionï¼Œæ£€æŸ¥åŸå› 
                if (!section) {
                    // æ£€æŸ¥æ˜¯å¦è¿”å›äº†é”™è¯¯çš„é¡µé¢ï¼ˆä¸»ç«™è€Œé connectï¼‰
                    const isMainSite = html?.includes('æ¬¢è¿æ¥åˆ° LINUX DO') || doc.querySelector('title')?.textContent?.includes('LINUX DO -');
                    const isConnectPage = html?.includes('ä¿¡ä»»çº§åˆ«') || html?.includes('trust level');
                    
                    if (isMainSite && !isConnectPage) {
                        // è¿”å›äº†ä¸»ç«™é¡µé¢ï¼Œè¯´æ˜ connect è®¤è¯å¤±è´¥ï¼ˆå¸¸è§äº iOS Safari + Stayï¼‰
                        // ä½¿ç”¨ OAuth ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯
                        let oauthUsername = username;
                        let oauthLevel = level;
                        
                        if (this.oauth?.isLoggedIn()) {
                            const oauthUser = this.oauth.getUserInfo();
                            if (oauthUser?.username) oauthUsername = oauthUser.username;
                            const trustLevel = oauthUser?.trust_level ?? oauthUser?.trustLevel;
                            if (typeof trustLevel === 'number') oauthLevel = trustLevel.toString();
                        }
                        
                        // ç›´æ¥ä½¿ç”¨ fallback æ˜¾ç¤ºï¼Œä¸å¼¹çª—æ‰“æ‰°ç”¨æˆ·
                        console.warn('[LDStatus Pro] Connect é¡µé¢è®¤è¯å¤±è´¥ï¼Œä½¿ç”¨ summary æ•°æ®');
                        return await this._showFallbackStats(oauthUsername, oauthLevel);
                    }
                    
                    return await this._showFallbackStats(username, level);
                }
                
                if (section) {
                    const heading = section.querySelector('h2').textContent;
                    const match = heading.match(PATTERNS.TRUST_LEVEL);
                    if (match) {
                        if (!username) username = match[1];
                        if (connectLevel === null) {
                            connectLevel = parseInt(match[2]) || 0;
                            level = match[2];
                        }
                    }
                }
                
                // æ— è®ºæ˜¯å¦æœ‰å‡çº§è¦æ±‚ï¼Œåªè¦èƒ½è¯†åˆ«ç”¨æˆ·å°±åˆå§‹åŒ–é˜…è¯»è¿½è¸ª
                if (username && username !== 'æœªçŸ¥') {
                    this.storage.setUser(username);
                    this.username = username;
                    this.tracker.init(username);
                    this._startReadingUpdate();
                } else {
                    // å³ä½¿æ²¡æœ‰ç”¨æˆ·åï¼Œä¹Ÿå°è¯•ä½¿ç”¨åŒ¿åæ¨¡å¼åˆå§‹åŒ–é˜…è¯»è¿½è¸ª
                    this.tracker.init('anonymous');
                    this._startReadingUpdate();
                }

                if (avatarEl) this._updateAvatar(avatarEl.src);

                this.readingTime = this.tracker.getTodayTime();
                this.renderer.renderReading(this.readingTime, this.tracker.isActive);
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä¸”ä» connect è·å–åˆ°äº†ç­‰çº§ä¿¡æ¯ï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜å’ŒæœåŠ¡ç«¯
                if (connectLevel !== null && this.oauth?.isLoggedIn()) {
                    this._updateTrustLevel(connectLevel);
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å‡çº§è¦æ±‚åŒºå—ï¼Œfallback åˆ° summary æ•°æ®
                if (!section) {
                    return await this._showFallbackStats(username, level);
                }

                const rows = section.querySelectorAll('table tr');
                const reqs = [];

                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].querySelectorAll('td');
                    if (cells.length < 3) continue;

                    const name = cells[0].textContent.trim();
                    const curMatch = cells[1].textContent.match(PATTERNS.NUMBER);
                    const reqMatch = cells[2].textContent.match(PATTERNS.NUMBER);
                    const currentValue = curMatch ? +curMatch[1] : 0;
                    const requiredValue = reqMatch ? +reqMatch[1] : 0;
                    const isSuccess = cells[1].classList.contains('text-green-500');
                    const prev = this.prevReqs.find(p => p.name === name);

                    reqs.push({
                        name, currentValue, requiredValue, isSuccess,
                        change: prev ? currentValue - prev.currentValue : 0,
                        isReverse: PATTERNS.REVERSE.test(name)
                    });
                }

                const orderedReqs = Utils.reorderRequirements(reqs);
                const isOK = !section.querySelector('p.text-red-500');

                this.notifier.check(orderedReqs);

                const histData = {};
                orderedReqs.forEach(r => histData[r.name] = r.currentValue);
                const history = this.historyMgr.addHistory(histData, this.readingTime);

                // è§¦å‘å‡çº§è¦æ±‚æ•°æ®ä¸Šä¼ ï¼ˆtrust_level >= 2 æ—¶å¼‚æ­¥ä¸Šä¼ ï¼‰
                if (this.hasLeaderboard && this.cloudSync && this.oauth?.isLoggedIn()) {
                    this.cloudSync.uploadRequirements().catch(() => {});
                }

                const todayData = this._getTodayData();
                this._setTodayData(histData, !todayData);

                // å¦‚æœå·²ç™»å½•ï¼Œä¼˜å…ˆä½¿ç”¨ OAuth ç”¨æˆ·ä¿¡æ¯ä¸­çš„ name
                let displayName = null;
                if (this.hasLeaderboard && this.oauth?.isLoggedIn()) {
                    const oauthUser = this.oauth.getUserInfo();
                    if (oauthUser?.name && oauthUser.name !== oauthUser.username) {
                        displayName = oauthUser.name;
                    }
                }
                this.renderer.renderUser(username, level, isOK, orderedReqs, displayName);
                this.renderer.renderReqs(orderedReqs, level);

                this.cachedHistory = history;
                this.cachedReqs = orderedReqs;

                this._renderTrends(history, orderedReqs);
                this._setLastVisit(histData);
                this.prevReqs = orderedReqs;
            }

            _getTodayData() {
                const stored = this.storage.get('todayData', null);
                return stored?.date === Utils.getTodayKey() ? stored : null;
            }

            _setTodayData(data, isStart = false) {
                const today = Utils.getTodayKey();
                const existing = this._getTodayData();
                const now = Date.now();

                this.storage.set('todayData', isStart || !existing
                    ? { date: today, startData: data, startTs: now, currentData: data, currentTs: now }
                    : { ...existing, currentData: data, currentTs: now }
                );
            }

            _setLastVisit(data) {
                this.storage.set('lastVisit', { ts: Date.now(), data });
            }

            _renderTrends(history, reqs) {
                this.renderer.renderTrends(this.trendTab);

                this.$.trends.querySelectorAll('.ldsp-subtab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.trendTab = tab.dataset.tab;
                        this.storage.setGlobal('trendTab', this.trendTab);
                        this.$.trends.querySelectorAll('.ldsp-subtab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this._renderTrendContent(history, reqs);
                    });
                });

                this._renderTrendContent(history, reqs);
            }

            _renderTrendContent(history, reqs) {
                const container = this.$.trends.querySelector('.ldsp-trend-content');

                if (this.trendTab === 'year') {
                    container.innerHTML = `<div class="ldsp-mini-loader"><div class="ldsp-mini-spin"></div><div class="ldsp-mini-txt">åŠ è½½æ•°æ®ä¸­...</div></div>`;
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            container.innerHTML = this.renderer.renderYearTrend(history, reqs, this.historyMgr, this.tracker);
                            // è‡ªåŠ¨æ»šåŠ¨çƒ­åŠ›å›¾åˆ°todayä½ç½®ï¼ˆåº•éƒ¨ï¼‰ï¼Œä½¿ç”¨ç¨‹åºæ€§æ»šåŠ¨é¿å…æ˜¾ç¤ºæ»šåŠ¨æ¡
                            const heatmap = container.querySelector('.ldsp-year-heatmap');
                            if (heatmap) {
                                requestAnimationFrame(() => this._scrollTo(heatmap, heatmap.scrollHeight));
                            }
                        }, 50);
                    });
                    return;
                }

                const fns = {
                    // ä½¿ç”¨ tracker.getTodayTime() è·å–å®æ—¶é˜…è¯»æ—¶é—´ï¼Œè€Œä¸æ˜¯ç¼“å­˜çš„ this.readingTime
                    today: () => this.renderer.renderTodayTrend(reqs, this.tracker.getTodayTime(), this._getTodayData()),
                    week: () => this.renderer.renderWeekTrend(history, reqs, this.historyMgr, this.tracker),
                    month: () => this.renderer.renderMonthTrend(history, reqs, this.historyMgr, this.tracker),
                    all: () => this.renderer.renderAllTrend(history, reqs, this.tracker)
                };

                container.innerHTML = fns[this.trendTab]?.() || '';
            }

            /**
             * åŠ è½½å¹¶æ˜¾ç¤ºç³»ç»Ÿå…¬å‘Šï¼ˆå…¬å¼€æ¥å£ï¼Œä¸éœ€è¦ç™»å½•ï¼‰
             */
            async _loadAnnouncement() {
                try {
                    const result = await new Promise((resolve, reject) => {
                        GM_xmlhttpRequest({
                            method: 'GET',
                            url: `${CONFIG.LEADERBOARD_API}/api/config/announcement`,
                            headers: { 'Content-Type': 'application/json' },
                            timeout: 10000,
                            onload: res => {
                                if (res.status >= 200 && res.status < 300) {
                                    try {
                                        resolve(JSON.parse(res.responseText));
                                    } catch (e) {
                                        reject(new Error('Parse error'));
                                    }
                                } else {
                                    reject(new Error(`HTTP ${res.status}`));
                                }
                            },
                            onerror: () => reject(new Error('Network error')),
                            ontimeout: () => reject(new Error('Timeout'))
                        });
                    });
                    
                    if (!result.success || !result.data) return;
                    
                    // å¤„ç†å¯èƒ½çš„åŒé‡åµŒå¥—: result.data.data æˆ– result.data
                    const announcement = result.data.data || result.data;
                    if (!announcement.enabled) return;
                    
                    // v3.3.3: æ”¯æŒå¤šæ¡å…¬å‘Š - å…¼å®¹æ—§ç‰ˆå•æ¡å…¬å‘Šæ ¼å¼
                    let items = [];
                    if (Array.isArray(announcement.items) && announcement.items.length > 0) {
                        items = announcement.items;
                    } else if (announcement.content) {
                        // å…¼å®¹æ—§ç‰ˆå•æ¡å…¬å‘Šæ ¼å¼
                        items = [{
                            content: announcement.content,
                            type: announcement.type || 'info',
                            expiresAt: announcement.expiresAt || null
                        }];
                    }
                    
                    // è¿‡æ»¤å·²è¿‡æœŸçš„å…¬å‘Š
                    const now = Date.now();
                    items = items.filter(item => !item.expiresAt || item.expiresAt > now);
                    
                    if (items.length === 0) {
                        return;
                    }
                    
                    // æ˜¾ç¤ºå…¬å‘Š
                    this._showAnnouncements(items);
                } catch (e) {
                    console.warn('[Announcement] Load failed:', e.message);
                }
            }

            /**
             * æ˜¾ç¤ºå¤šæ¡å…¬å‘Šè½®æ’­
             * @param {Array} items - å…¬å‘Šæ•°ç»„ [{content, type, expiresAt}, ...]
             */
            _showAnnouncements(items) {
                if (!this.$.announcement || !this.$.announcementText) return;
                
                // æ¸…é™¤ä¹‹å‰çš„è½®æ’­å®šæ—¶å™¨
                if (this._announcementTimer) {
                    clearTimeout(this._announcementTimer);
                    this._announcementTimer = null;
                }
                
                this._announcementItems = items;
                this._announcementIndex = 0;
                
                // æ˜¾ç¤ºç¬¬ä¸€æ¡å…¬å‘Š
                this._displayCurrentAnnouncement();
                
                // æ˜¾ç¤ºå…¬å‘Šæ 
                requestAnimationFrame(() => {
                    this.$.announcement.classList.add('active');
                });
            }
            
            /**
             * å®‰æ’ä¸‹ä¸€æ¡å…¬å‘Šçš„åˆ‡æ¢ï¼ˆä½¿ç”¨åŠ¨ç”»ç»“æŸäº‹ä»¶ï¼‰
             */
            _scheduleNextAnnouncement() {
                if (this._announcementItems.length <= 1) return;
                
                const inner = this.$.announcement.querySelector('.ldsp-announcement-inner');
                if (!inner) return;
                
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨
                if (this._announcementEndHandler) {
                    inner.removeEventListener('animationend', this._announcementEndHandler);
                }
                
                // æ·»åŠ æ–°çš„åŠ¨ç”»ç»“æŸç›‘å¬å™¨
                this._announcementEndHandler = () => {
                    this._announcementIndex = (this._announcementIndex + 1) % this._announcementItems.length;
                    this._displayCurrentAnnouncement();
                };
                inner.addEventListener('animationend', this._announcementEndHandler, { once: true });
            }
            
            /**
             * æ˜¾ç¤ºå½“å‰ç´¢å¼•çš„å…¬å‘Š
             */
            _displayCurrentAnnouncement() {
                const item = this._announcementItems[this._announcementIndex];
                if (!item) return;
                
                // è®¾ç½®å…¬å‘Šç±»å‹æ ·å¼
                this.$.announcement.className = 'ldsp-announcement active';
                if (item.type && item.type !== 'info') {
                    this.$.announcement.classList.add(item.type);
                }
                
                // è®¾ç½®å…¬å‘Šå†…å®¹ï¼ˆå¸¦åºå·ï¼Œå¦‚æœå¤šæ¡ï¼‰
                const prefix = this._announcementItems.length > 1 
                    ? `[${this._announcementIndex + 1}/${this._announcementItems.length}] ` 
                    : '';
                this.$.announcementText.textContent = prefix + item.content;
                
                // é‡ç½®åŠ¨ç”»å¹¶è®¡ç®—æ»šåŠ¨å‚æ•°
                const inner = this.$.announcement.querySelector('.ldsp-announcement-inner');
                if (inner) {
                    inner.style.animation = 'none';
                    inner.offsetHeight; // è§¦å‘é‡æ’
                    
                    // è®¡ç®—æ–‡å­—å®é™…å®½åº¦å’Œå®¹å™¨å®½åº¦
                    const textWidth = this.$.announcementText.scrollWidth;
                    const containerWidth = this.$.announcement.clientWidth;
                    
                    // è®¡ç®—æ»šåŠ¨è·ç¦»ï¼šä»å®¹å™¨å³ä¾§å¼€å§‹ï¼Œæ»šåŠ¨åˆ°æ–‡å­—å®Œå…¨ç¦»å¼€å·¦ä¾§
                    // èµ·ç‚¹ï¼š100%ï¼ˆå®¹å™¨å®½åº¦ï¼‰
                    // ç»ˆç‚¹ï¼š-(textWidth / containerWidth * 100)%
                    const endX = -Math.ceil((textWidth / containerWidth) * 100);
                    this.$.announcement.style.setProperty('--start-x', '100%');
                    this.$.announcement.style.setProperty('--end-x', `${endX}%`);
                    
                    // æ ¹æ®æ€»æ»šåŠ¨è·ç¦»è®¾ç½®é€Ÿåº¦ï¼ˆæ¯ç§’çº¦ 50pxï¼‰
                    const totalDistance = containerWidth + textWidth;
                    const duration = Math.max(8, Math.min(60, totalDistance / 50));
                    this.$.announcement.style.setProperty('--marquee-duration', `${duration}s`);
                    
                    // å•æ¡å…¬å‘Šæ— é™å¾ªç¯ï¼Œå¤šæ¡å…¬å‘Šæ’­æ”¾ä¸€æ¬¡ååˆ‡æ¢
                    const iteration = this._announcementItems.length > 1 ? '1' : 'infinite';
                    this.$.announcement.style.setProperty('--marquee-iteration', iteration);
                    
                    inner.style.animation = '';
                }
                
                // å¦‚æœæ˜¯å¤šæ¡å…¬å‘Šï¼Œç›‘å¬åŠ¨ç”»ç»“æŸååˆ‡æ¢
                if (this._announcementItems.length > 1) {
                    this._scheduleNextAnnouncement();
                }
            }

            async _checkUpdate(autoCheck = false) {
                const url = 'https://raw.githubusercontent.com/caigg188/LDStatusPro/main/LDStatusPro.user.js';
                this.$.btnUpdate.textContent = 'â³';

                try {
                    const text = await this.network.fetch(url, { maxRetries: 1 });
                    const match = text.match(PATTERNS.VERSION);
                    if (match) {
                        const remote = match[1];
                        const current = GM_info.script.version;
                        if (Utils.compareVersion(remote, current) > 0) {
                            this.$.btnUpdate.textContent = 'ğŸ†•';
                            this.$.btnUpdate.title = `æ–°ç‰ˆæœ¬ v${remote}`;
                            this.$.btnUpdate.classList.add('has-update');
                            this._remoteVersion = remote;
                            this._updateUrl = url;
                            
                            // æ£€æŸ¥æ˜¯å¦å·²ç»æç¤ºè¿‡è¿™ä¸ªç‰ˆæœ¬
                            const dismissedVer = this.storage.getGlobal('dismissedUpdateVer', '');
                            const shouldShowBubble = autoCheck 
                                ? (dismissedVer !== remote)  // è‡ªåŠ¨æ£€æŸ¥ï¼šåªæœ‰æœªå¿½ç•¥çš„ç‰ˆæœ¬æ‰æ˜¾ç¤º
                                : true;  // æ‰‹åŠ¨æ£€æŸ¥ï¼šæ€»æ˜¯æ˜¾ç¤º
                            
                            if (shouldShowBubble) {
                                this._showUpdateBubble(current, remote);
                            }
                            
                            this.$.btnUpdate.onclick = () => this._showUpdateBubble(current, remote);
                        } else {
                            this.$.btnUpdate.textContent = 'âœ…';
                            this.$.btnUpdate.title = 'å·²æ˜¯æœ€æ–°ç‰ˆæœ¬';
                            this.$.btnUpdate.classList.remove('has-update');
                            if (!autoCheck) {
                                this.renderer.showToast('âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                            }
                            setTimeout(() => {
                                this.$.btnUpdate.textContent = 'ğŸ”';
                                this.$.btnUpdate.title = 'æ£€æŸ¥æ›´æ–°';
                            }, 2000);
                        }
                    }
                } catch (e) {
                    this.$.btnUpdate.textContent = 'âŒ';
                    this.$.btnUpdate.title = 'æ£€æŸ¥å¤±è´¥';
                    if (!autoCheck) {
                        this.renderer.showToast('âŒ æ£€æŸ¥æ›´æ–°å¤±è´¥');
                    }
                    setTimeout(() => {
                        this.$.btnUpdate.textContent = 'ğŸ”';
                        this.$.btnUpdate.title = 'æ£€æŸ¥æ›´æ–°';
                    }, 2000);
                }
            }

            _showUpdateBubble(current, remote) {
                this.$.updateBubbleVer.innerHTML = `<span style="color:var(--txt-mut)">v${current}</span> â†’ <span style="color:var(--accent);font-weight:700">v${remote}</span>`;
                this.$.updateBubble.style.display = 'block';
                // å»¶è¿Ÿä¸€å¸§æ·»åŠ åŠ¨ç”»ç±»ï¼Œç¡®ä¿è¿‡æ¸¡æ•ˆæœç”Ÿæ•ˆ
                requestAnimationFrame(() => {
                    this.$.updateBubble.classList.add('show');
                });
                
                // ç»‘å®šå…³é—­æŒ‰é’®
                this.$.updateBubbleClose.onclick = () => this._hideUpdateBubble(true);
                
                // ç»‘å®šæ›´æ–°æŒ‰é’®
                this.$.updateBubbleBtn.onclick = () => this._doUpdate();
            }

            _hideUpdateBubble(dismiss = false) {
                // å¦‚æœç”¨æˆ·ä¸»åŠ¨å…³é—­ï¼Œè®°å½•å·²å¿½ç•¥çš„ç‰ˆæœ¬
                if (dismiss && this._remoteVersion) {
                    this.storage.setGlobalNow('dismissedUpdateVer', this._remoteVersion);
                }
                
                this.$.updateBubble.classList.remove('show');
                setTimeout(() => {
                    this.$.updateBubble.style.display = 'none';
                }, 300);
            }

            _doUpdate() {
                this.$.updateBubbleBtn.disabled = true;
                this.$.updateBubbleBtn.textContent = 'â³ æ›´æ–°ä¸­...';
                
                // æ‰“å¼€æ›´æ–°é“¾æ¥ï¼ŒTampermonkey ä¼šè‡ªåŠ¨å¼¹å‡ºæ›´æ–°ç¡®è®¤
                window.open(this._updateUrl || 'https://raw.githubusercontent.com/caigg188/LDStatusPro/main/LDStatusPro.user.js');
                
                // æç¤ºç”¨æˆ·
                setTimeout(() => {
                    this.$.updateBubbleBtn.textContent = 'âœ… è¯·åœ¨å¼¹å‡ºçª—å£ç¡®è®¤æ›´æ–°';
                    setTimeout(() => {
                        this._hideUpdateBubble();
                        this.$.updateBubbleBtn.disabled = false;
                        this.$.updateBubbleBtn.textContent = 'ğŸš€ ç«‹å³æ›´æ–°';
                    }, 3000);
                }, 1000);
            }

            // ========== ç™»å½•ç›¸å…³ ==========

            _updateLoginUI() {
                // æ— æ’è¡Œæ¦œç«™ç‚¹éšè—ç™»å½•ç›¸å…³æŒ‰é’®
                if (!this.hasLeaderboard) {
                    if (this.$.btnCloudSync) this.$.btnCloudSync.style.display = 'none';
                    if (this.$.logoutBtn) this.$.logoutBtn.style.display = 'none';
                    if (this.$.ticketBtn) this.$.ticketBtn.style.display = 'none';
                    if (this.$.loginBtn) this.$.loginBtn.style.display = 'none';
                    return;
                }
                const logged = this.oauth.isLoggedIn();
                const forumLogged = !!this.storage.getUser();  // è®ºå›ç™»å½•çŠ¶æ€
                this.$.user.classList.toggle('not-logged', !logged);

                // æ˜¾ç¤º/éšè—äº‘åŒæ­¥æŒ‰é’®
                if (this.$.btnCloudSync) {
                    this.$.btnCloudSync.style.display = logged ? '' : 'none';
                }

                // æ˜¾ç¤º/éšè—æ³¨é”€æŒ‰é’®å’Œå·¥å•æŒ‰é’®ï¼ˆæœªç™»å½•æ—¶éƒ½éšè—ï¼‰
                if (this.$.logoutBtn) {
                    this.$.logoutBtn.style.display = logged ? '' : 'none';
                }
                if (this.$.ticketBtn) {
                    this.$.ticketBtn.style.display = logged ? '' : 'none';
                }
                // æ˜¾ç¤º/éšè—ç™»å½•æŒ‰é’®ï¼ˆå·²ç™»å½•æ—¶éšè—ï¼‰
                if (this.$.loginBtn) {
                    this.$.loginBtn.style.display = logged ? 'none' : '';
                }
                
                // æ˜¾ç¤º/éšè—å…³æ³¨ç²‰ä¸å’Œå¤©æ•°ï¼ˆè®ºå›æœªç™»å½•æ—¶éšè—æ•´ä¸ªå®¹å™¨ï¼‰
                const userMeta = this.el.querySelector('.ldsp-user-meta');
                if (userMeta) {
                    userMeta.style.display = forumLogged ? '' : 'none';
                }

                if (!logged) {
                    this._bindUserLogin();
                }
            }

            _bindLoginButton() {
                if (this._loginBtnBound || !this.$.loginBtn) return;
                this._loginBtnBound = true;
                this.$.loginBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (!this.oauth?.isLoggedIn()) {
                        await this._doLogin();
                    }
                });
            }

            _bindUserLogin() {
                if (this._userLoginBound) return;
                this._userLoginBound = true;

                const handle = async e => {
                    if (!this.oauth.isLoggedIn() && this.$.user.classList.contains('not-logged')) {
                        e.stopPropagation();
                        await this._doLogin();
                    }
                };

                this.$.user.querySelector('.ldsp-avatar-wrap')?.addEventListener('click', handle);
                this.$.userDisplayName.addEventListener('click', handle);
                
                // ç»‘å®šç™»å½•æŒ‰é’®
                this._bindLoginButton();
            }

            /**
             * æ£€æŸ¥å¹¶å¤„ç†å¾…å¤„ç†çš„ OAuth ç™»å½•ç»“æœ
             * ç»Ÿä¸€åŒçª—å£ç™»å½•æ¨¡å¼ï¼šç”¨æˆ·æˆæƒåä¼šè·³è½¬å›åŸé¡µé¢ï¼Œç™»å½•ç»“æœé€šè¿‡ URL hash ä¼ é€’
             * æ•°æ®åœ¨è„šæœ¬æœ€å¼€å§‹å°±è¢«æ•è·åˆ° _pendingOAuthData å…¨å±€å˜é‡
             */
            _checkPendingOAuthLogin() {
                console.log('[OAuth] _checkPendingOAuthLogin called, _pendingOAuthData:', _pendingOAuthData ? 'present' : 'null');
                // ä¼˜å…ˆä½¿ç”¨è„šæœ¬å¯åŠ¨æ—¶æ•è·çš„æ•°æ®ï¼ˆé¿å… Discourse è·¯ç”±å¤„ç†æ‰ hashï¼‰
                let pendingResult = _pendingOAuthData;
                _pendingOAuthData = null; // æ¸…é™¤å·²ä½¿ç”¨çš„æ•°æ®
                
                // å¤‡ç”¨ï¼šå†æ¬¡å°è¯•ä» URL hash è¯»å–
                if (!pendingResult) {
                    console.log('[OAuth] No early captured data, trying URL hash fallback...');
                    pendingResult = this.oauth._checkUrlHashLogin();
                }
                
                console.log('[OAuth] pendingResult:', pendingResult ? { success: pendingResult.success, hasToken: !!pendingResult.token, hasUser: !!pendingResult.user } : 'null');
                
                if (pendingResult?.success && pendingResult.token && pendingResult.user) {
                    console.log('[OAuth] âœ… Processing login result for user:', pendingResult.user?.username);
                    // ã€å…³é”®ã€‘å…ˆåŒæ­¥ä¿å­˜ç™»å½•ä¿¡æ¯ï¼Œç¡®ä¿åç»­çš„ isLoggedIn() æ£€æŸ¥èƒ½è¿”å› true
                    this.oauth.setToken(pendingResult.token);
                    this.oauth.setUserInfo(pendingResult.user);
                    this.oauth.setJoined(pendingResult.isJoined || false);
                    // å¤„ç†ç™»å½•ç»“æœï¼ˆå¼‚æ­¥æ“ä½œå¦‚åŒæ­¥ã€UIæ›´æ–°ç­‰ï¼‰
                    this._handlePendingLoginResult(pendingResult);
                    return true; // è¿”å› true è¡¨ç¤ºæœ‰ç™»å½•ç»“æœè¢«å¤„ç†
                } else {
                    console.log('[OAuth] No valid pending login result');
                    return false;
                }
            }

            // å¤„ç†å¾…å¤„ç†çš„ç™»å½•ç»“æœï¼ˆç™»å½•ä¿¡æ¯å·²åœ¨ _checkPendingOAuthLogin ä¸­åŒæ­¥ä¿å­˜ï¼‰
            async _handlePendingLoginResult(result) {
                try {
                    this.renderer.showToast('âœ… ç™»å½•æˆåŠŸ');
                    
                    // åŒæ­¥ç”¨æˆ·ååˆ° storage
                    if (result.user?.username) {
                        this.storage.setUser(result.user.username);
                        this.storage.invalidateCache();
                        this.storage.migrate(result.user.username);
                        this._updateUserInfoFromOAuth(result.user);
                    }
                    
                    this._updateLoginUI();
                    await this._syncPrefs();
                    
                    // ç™»å½•æˆåŠŸåé‡æ–°è·å– connect é¡µé¢æ•°æ®ï¼ˆæ­¤æ—¶ OAuth ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®ï¼Œå¯ä»¥æ­£ç¡®æ˜¾ç¤ºä¿¡ä»»ç­‰çº§ï¼‰
                    this.fetch();
                    
                    // é¦–æ¬¡ç™»å½•åçš„å®Œæ•´åŒæ­¥ï¼šé˜…è¯»æ•°æ® + è¦æ±‚æ•°æ®
                    this.cloudSync.fullSync().then(() => {
                        // é˜…è¯»æ•°æ®åŒæ­¥å®Œæˆåï¼ŒåŒæ­¥è¦æ±‚æ•°æ®ï¼ˆä¿¡ä»»ç­‰çº§è¿›åº¦ï¼‰
                        return this.cloudSync.syncRequirementsOnLoad();
                    }).then(() => {
                        // åŒæ­¥å®Œæˆåæ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è·å–æœ€æ–°æ•°æ®
                        this._cloudReqsCache = null;
                        this._cloudReqsCacheTime = 0;
                    }).catch(e => console.warn('[CloudSync]', e));
                } catch (e) {
                    console.error('[OAuth] Handle pending login error:', e);
                }
            }

            async _doLogin() {
                try {
                    this.renderer.showToast('â³ æ­£åœ¨è·³è½¬åˆ°æˆæƒé¡µé¢...');
                    // ç»Ÿä¸€åŒçª—å£ç™»å½•ï¼šlogin() ä¼šè·³è½¬é¡µé¢ï¼Œä¸ä¼šè¿”å›
                    // ç™»å½•æˆåŠŸåé¡µé¢ä¼šè·³è½¬å›æ¥ï¼Œç”± _checkPendingOAuthLogin å¤„ç†ç»“æœ
                    await this.oauth.login();
                    // å¦‚æœ login() è¿”å›äº†ç”¨æˆ·ï¼ˆä» localStorage è¯»å–çš„å¾…å¤„ç†ç»“æœï¼‰ï¼Œå¤„ç†å®ƒ
                    // æ³¨æ„ï¼šæ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºé¡µé¢ä¼šè·³è½¬
                } catch (e) {
                    this.renderer.showToast(`âŒ ${e.message}`);
                }
            }

            // ä½¿ç”¨ OAuth ç”¨æˆ·ä¿¡æ¯æ›´æ–°ç•Œé¢
            _updateUserInfoFromOAuth(user) {
                if (!user) return;
                const $ = this.$;
                // æ˜¾ç¤ºç”¨æˆ·åå’Œæ˜µç§°
                if (user.name && user.name !== user.username) {
                    $.userDisplayName.textContent = user.name;
                    $.userHandle.textContent = `@${user.username}`;
                    $.userHandle.style.display = '';
                } else {
                    $.userDisplayName.textContent = user.username;
                    $.userHandle.textContent = '';
                    $.userHandle.style.display = 'none';
                }
                // æ›´æ–°å¤´åƒï¼ˆå¦‚æœæœ‰ï¼‰
                if (user.avatar_url) {
                    this._updateAvatar(user.avatar_url.startsWith('http') ? user.avatar_url : `https://linux.do${user.avatar_url}`);
                }
            }

            _checkLoginPrompt() {
                const KEY = 'ldsp_login_prompt_version';
                const VER = '3.0';
                if (this.storage.getGlobal(KEY, null) === VER) {
                    this._updateLoginUI();
                    return;
                }

                const hasData = this.storage.get('readingTime', null);
                const isUpgrade = hasData && Object.keys(hasData.dailyData || {}).length > 0;

                setTimeout(() => {
                    const overlay = this.renderer.showLoginPrompt(isUpgrade);
                    this._bindLoginPrompt(overlay, KEY, VER);
                }, 1500);
            }

            _bindLoginPrompt(overlay, key, ver) {
                const close = (skipped = false) => {
                    overlay.classList.remove('show');
                    setTimeout(() => overlay.remove(), 300);
                    this.storage.setGlobalNow(key, ver);
                    skipped && this._updateLoginUI();
                };

                const loginBtn = overlay.querySelector('#ldsp-modal-login');
                loginBtn?.addEventListener('click', async () => {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'â³ è·³è½¬ä¸­...';
                    try {
                        // ç»Ÿä¸€åŒçª—å£ç™»å½•ï¼šä¼šè·³è½¬åˆ°æˆæƒé¡µé¢
                        // ç™»å½•æˆåŠŸåè¿”å›æ­¤é¡µé¢ï¼Œç”± _checkPendingOAuthLogin å¤„ç†
                        await this.oauth.login();
                        // æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºé¡µé¢ä¼šè·³è½¬
                    } catch (e) {
                        this.renderer.showToast(`âŒ ${e.message}`);
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'ğŸš€ ç«‹å³ç™»å½•';
                    }
                });

                overlay.querySelector('#ldsp-modal-skip')?.addEventListener('click', () => close(true));
                overlay.addEventListener('click', e => e.target === overlay && close(true));
            }

            async _syncPrefs() {
                if (!this.hasLeaderboard || !this.oauth.isLoggedIn()) return;
                try {
                    const result = await this.oauth.api('/api/user/status');
                    if (result.success && result.data) {
                        this.oauth.setJoined(result.data.isJoined || false);
                        if (this.oauth.isJoined()) this.leaderboard.startSync();
                    }
                } catch (e) {
                    console.warn('[Prefs]', e);
                }
            }

            // ========== æˆ‘çš„æ´»åŠ¨ ==========

            async _renderActivity() {
                if (!this.$.activity) return;

                // æ£€æŸ¥è®ºå›ç™»å½•çŠ¶æ€ï¼šæœªç™»å½•æ—¶æ˜¾ç¤ºç™»å½•æç¤º
                const username = this.storage.getUser();
                if (!username) {
                    this.$.activity.innerHTML = `
                        <div class="ldsp-lb-login">
                            <div class="ldsp-lb-login-icon">ğŸ”</div>
                            <div class="ldsp-lb-login-title">éœ€è¦ç™»å½•</div>
                            <div class="ldsp-lb-login-desc">è¯·å…ˆç™»å½•è®ºå›åå†æŸ¥çœ‹æ‚¨çš„æ´»åŠ¨æ•°æ®</div>
                        </div>`;
                    return;
                }

                this.renderer.renderActivity(this.activitySubTab);

                // ç»‘å®šå­tabç‚¹å‡»äº‹ä»¶
                this.$.activity.querySelectorAll('.ldsp-subtab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.activity;
                        this.activitySubTab = tabId;
                        this.$.activity.querySelectorAll('.ldsp-subtab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        // æ¸…é™¤ç¼“å­˜å¼ºåˆ¶é‡æ–°åŠ è½½
                        this.activityMgr.clearCache(tabId);
                        this._renderActivityContent();
                    });
                });

                await this._renderActivityContent();
            }

            async _renderActivityContent() {
                const container = this.$.activity.querySelector('.ldsp-activity-content');
                if (!container) return;

                // æ¸…ç†ä¹‹å‰çš„æ»šåŠ¨äº‹ä»¶
                this._cleanupActivityScroll();

                container.innerHTML = this.renderer.renderActivityLoading();

                try {
                    switch (this.activitySubTab) {
                        case 'read':
                            await this._loadReadTopics(container);
                            break;
                        case 'bookmarks':
                            await this._loadBookmarks(container);
                            break;
                        case 'replies':
                            await this._loadReplies(container);
                            break;
                        case 'likes':
                            await this._loadLikes(container);
                            break;
                        case 'reactions':
                            await this._loadReactions(container);
                            break;
                        case 'topics':
                            await this._loadMyTopics(container);
                            break;
                        default:
                            container.innerHTML = this.renderer.renderActivityEmpty('ğŸ“­', 'è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»');
                    }
                } catch (e) {
                    container.innerHTML = this.renderer.renderActivityError(e.message || 'åŠ è½½å¤±è´¥');
                    container.querySelector('.ldsp-activity-retry')?.addEventListener('click', () => {
                        this.activityMgr.clearCache(this.activitySubTab);
                        this._renderActivityContent();
                    });
                }
            }

            async _loadReadTopics(container, searchOnly = false, targetBatchSize = null) {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const username = this.storage.getUser();
                if (!username) {
                    container.innerHTML = this.renderer.renderActivityEmpty('ğŸ”’', 'è¯·å…ˆç™»å½•è®ºå›');
                    return;
                }
                
                // è·å–å½“å‰åˆ†é¡µçŠ¶æ€
                let state = this.activityMgr.getPageState('read');
                
                // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ï¼Œé‡ç½®çŠ¶æ€
                if (!state.allTopics || state.allTopics.length === 0) {
                    state = { page: 0, allTopics: [], hasMore: true, search: '', batchSize: 20 };
                }

                // ä½¿ç”¨ targetBatchSize æˆ– state.batchSize
                const batchSize = targetBatchSize || state.batchSize || 20;
                if (targetBatchSize) {
                    state.batchSize = targetBatchSize;
                }

                // å¦‚æœåªæ˜¯æœç´¢è¿‡æ»¤ï¼Œä¸åŠ è½½æ–°æ•°æ®
                if (!searchOnly) {
                    try {
                        // éœ€è¦åŠ è½½æ›´å¤šæ•°æ®ï¼šè®¡ç®—è¿˜éœ€è¦å¤šå°‘æ¡
                        const needMore = batchSize - state.allTopics.length;
                        if (needMore > 0 && state.hasMore) {
                            const result = await this.activityMgr.getReadTopics(state.page, needMore);
                            
                            // åˆå¹¶è¯é¢˜ï¼ˆé¿å…é‡å¤ï¼‰
                            const existingIds = new Set(state.allTopics.map(t => t.id));
                            const newTopics = result.topics.filter(t => !existingIds.has(t.id));
                            state.allTopics = [...state.allTopics, ...newTopics];
                            state.hasMore = result.hasMore;
                            state.page = result.page + 1;
                            
                            this.activityMgr.setPageState('read', state);
                        }
                    } catch (e) {
                        if (state.allTopics.length === 0) throw e;
                        this.renderer.showToast(`âš ï¸ ${e.message}`);
                    }
                }

                // æ ¹æ®æœç´¢è¯è¿‡æ»¤
                const search = state.search || '';
                let filteredTopics = state.allTopics;
                if (search) {
                    const kw = search.toLowerCase();
                    filteredTopics = state.allTopics.filter(t => 
                        (t.title && t.title.toLowerCase().includes(kw)) ||
                        (t.tags && t.tags.some(tag => tag.toLowerCase().includes(kw)))
                    );
                }

                container.innerHTML = this.renderer.renderTopicListWithSearch(filteredTopics, state.hasMore && !search, search, batchSize, state.allTopics.length);

                // ç»‘å®šæœç´¢äº‹ä»¶
                this._bindReadSearchEvents(container, state);

                // ç»‘å®šç€‘å¸ƒæµæ»šåŠ¨åŠ è½½ï¼ˆæœç´¢æ—¶ç¦ç”¨ï¼‰
                if (state.hasMore && !search) {
                    this._bindActivityScroll(container);
                }
            }

            _bindReadSearchEvents(container, state) {
                const input = container.querySelector('.ldsp-activity-search input');
                const clear = container.querySelector('.ldsp-activity-search-clear');
                const batchSelect = container.querySelector('.ldsp-activity-batch-select');
                
                const doSearch = () => {
                    clearTimeout(this._readSearchTimer);
                    state.search = input.value.trim();
                    this.activityMgr.setPageState('read', state);
                    this._loadReadTopics(container, true);
                };
                
                input?.addEventListener('input', (e) => {
                    clear?.classList.toggle('show', !!e.target.value);
                    clearTimeout(this._readSearchTimer);
                    // å¢åŠ é˜²æŠ–æ—¶é—´åˆ°600msï¼Œé¿å…è¾“å…¥ä¸­æ–­
                    this._readSearchTimer = setTimeout(doSearch, 600);
                });
                
                // å›è½¦é”®ç«‹å³æœç´¢
                input?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        doSearch();
                    }
                });
                
                clear?.addEventListener('click', () => {
                    input.value = '';
                    clear.classList.remove('show');
                    state.search = '';
                    this.activityMgr.setPageState('read', state);
                    this._loadReadTopics(container, true);
                });

                batchSelect?.addEventListener('change', async (e) => {
                    const newBatchSize = parseInt(e.target.value, 10);
                    state.batchSize = newBatchSize;
                    this.activityMgr.setPageState('read', state);
                    
                    // å¦‚æœéœ€è¦åŠ è½½æ›´å¤šæ•°æ®
                    if (newBatchSize > state.allTopics.length && state.hasMore) {
                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        const toolbar = container.querySelector('.ldsp-activity-toolbar');
                        const topicList = container.querySelector('.ldsp-topic-list');
                        toolbar?.classList.add('loading');
                        batchSelect.classList.add('loading');
                        
                        if (topicList) {
                            topicList.classList.add('loading');
                            // æ·»åŠ åŠ è½½æç¤ºè¦†ç›–å±‚
                            const loadingOverlay = document.createElement('div');
                            loadingOverlay.className = 'ldsp-activity-loading-overlay';
                            loadingOverlay.innerHTML = `<div class="ldsp-activity-loading-spinner"></div><div class="ldsp-activity-loading-text">æ­£åœ¨åŠ è½½ ${newBatchSize} æ¡æ•°æ®...</div>`;
                            topicList.style.position = 'relative';
                            topicList.appendChild(loadingOverlay);
                        }
                        
                        await this._loadReadTopics(container, false, newBatchSize);
                    } else {
                        // æ•°æ®è¶³å¤Ÿï¼Œåªéœ€é‡æ–°æ¸²æŸ“
                        await this._loadReadTopics(container, true, newBatchSize);
                    }
                });
            }

            async _loadBookmarks(container, searchOnly = false, targetBatchSize = null) {
                // è·å–å½“å‰ç”¨æˆ·å
                const username = this.storage.getUser();
                if (!username) {
                    container.innerHTML = this.renderer.renderActivityEmpty('ğŸ”’', 'è¯·å…ˆç™»å½•è®ºå›');
                    return;
                }

                // è·å–å½“å‰åˆ†é¡µçŠ¶æ€
                let state = this.activityMgr.getPageState('bookmarks');
                
                // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ï¼Œé‡ç½®çŠ¶æ€
                if (!state.allItems || state.allItems.length === 0) {
                    state = { page: 0, allItems: [], hasMore: true, search: '', batchSize: 20 };
                }

                // ä½¿ç”¨ targetBatchSize æˆ– state.batchSize
                const batchSize = targetBatchSize || state.batchSize || 20;
                if (targetBatchSize) {
                    state.batchSize = targetBatchSize;
                }

                // å¦‚æœåªæ˜¯æœç´¢è¿‡æ»¤ï¼Œä¸åŠ è½½æ–°æ•°æ®
                if (!searchOnly) {
                    try {
                        // éœ€è¦åŠ è½½æ›´å¤šæ•°æ®ï¼šè®¡ç®—è¿˜éœ€è¦å¤šå°‘æ¡
                        const needMore = batchSize - state.allItems.length;
                        if (needMore > 0 && state.hasMore) {
                            // å¾ªç¯åŠ è½½ç›´åˆ°è¾¾åˆ°ç›®æ ‡æ•°é‡
                            while (state.allItems.length < batchSize && state.hasMore) {
                                const result = await this.activityMgr.getBookmarks(state.page, username);
                                
                                // åˆå¹¶æ”¶è—ï¼ˆé¿å…é‡å¤ï¼‰
                                const existingIds = new Set(state.allItems.map(b => b.id));
                                const newItems = result.bookmarks.filter(b => !existingIds.has(b.id));
                                state.allItems = [...state.allItems, ...newItems];
                                state.hasMore = result.hasMore;
                                state.page = result.page + 1;
                                
                                this.activityMgr.setPageState('bookmarks', state);
                                
                                if (newItems.length === 0) break;
                            }
                        }
                    } catch (e) {
                        if (state.allItems.length === 0) throw e;
                        this.renderer.showToast(`âš ï¸ ${e.message}`);
                    }
                }

                // æ ¹æ®æœç´¢è¯è¿‡æ»¤
                const search = state.search || '';
                let filteredItems = state.allItems;
                if (search) {
                    const kw = search.toLowerCase();
                    filteredItems = state.allItems.filter(b => 
                        (b.title && b.title.toLowerCase().includes(kw)) ||
                        (b.fancy_title && b.fancy_title.toLowerCase().includes(kw)) ||
                        (b.tags && b.tags.some(tag => tag.toLowerCase().includes(kw))) ||
                        (b.excerpt && b.excerpt.toLowerCase().includes(kw))
                    );
                }

                container.innerHTML = this.renderer.renderBookmarkListWithSearch(filteredItems, state.hasMore && !search, search, batchSize, state.allItems.length);
                this._bindBookmarkClicks(container);

                // ç»‘å®šæœç´¢äº‹ä»¶
                this._bindBookmarkSearchEvents(container, state);

                // ç»‘å®šç€‘å¸ƒæµæ»šåŠ¨åŠ è½½ï¼ˆæœç´¢æ—¶ç¦ç”¨ï¼‰
                if (state.hasMore && !search) {
                    this._bindActivityScroll(container, 'bookmarks');
                }
            }

            _bindBookmarkSearchEvents(container, state) {
                const input = container.querySelector('.ldsp-activity-search input');
                const clear = container.querySelector('.ldsp-activity-search-clear');
                const batchSelect = container.querySelector('.ldsp-activity-batch-select');
                
                const doSearch = () => {
                    clearTimeout(this._bookmarkSearchTimer);
                    state.search = input.value.trim();
                    this.activityMgr.setPageState('bookmarks', state);
                    this._loadBookmarks(container, true);
                };
                
                input?.addEventListener('input', (e) => {
                    clear?.classList.toggle('show', !!e.target.value);
                    clearTimeout(this._bookmarkSearchTimer);
                    // å¢åŠ é˜²æŠ–æ—¶é—´åˆ°600msï¼Œé¿å…è¾“å…¥ä¸­æ–­
                    this._bookmarkSearchTimer = setTimeout(doSearch, 600);
                });
                
                // å›è½¦é”®ç«‹å³æœç´¢
                input?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        doSearch();
                    }
                });
                
                clear?.addEventListener('click', () => {
                    input.value = '';
                    clear.classList.remove('show');
                    state.search = '';
                    this.activityMgr.setPageState('bookmarks', state);
                    this._loadBookmarks(container, true);
                });

                batchSelect?.addEventListener('change', async (e) => {
                    const newBatchSize = parseInt(e.target.value, 10);
                    state.batchSize = newBatchSize;
                    this.activityMgr.setPageState('bookmarks', state);
                    
                    // å¦‚æœéœ€è¦åŠ è½½æ›´å¤šæ•°æ®
                    if (newBatchSize > state.allItems.length && state.hasMore) {
                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        const toolbar = container.querySelector('.ldsp-activity-toolbar');
                        const list = container.querySelector('.ldsp-bookmark-list');
                        toolbar?.classList.add('loading');
                        batchSelect.classList.add('loading');
                        
                        if (list) {
                            list.classList.add('loading');
                            const loadingOverlay = document.createElement('div');
                            loadingOverlay.className = 'ldsp-activity-loading-overlay';
                            loadingOverlay.innerHTML = `<div class="ldsp-activity-loading-spinner"></div><div class="ldsp-activity-loading-text">æ­£åœ¨åŠ è½½ ${newBatchSize} æ¡æ•°æ®...</div>`;
                            list.style.position = 'relative';
                            list.appendChild(loadingOverlay);
                        }
                        
                        await this._loadBookmarks(container, false, newBatchSize);
                    } else {
                        // æ•°æ®è¶³å¤Ÿï¼Œåªéœ€é‡æ–°æ¸²æŸ“
                        await this._loadBookmarks(container, true, newBatchSize);
                    }
                });
            }

            async _loadReplies(container) {
                // è·å–å½“å‰ç”¨æˆ·å
                const username = this.storage.getUser();
                if (!username) {
                    container.innerHTML = this.renderer.renderActivityEmpty('ğŸ”’', 'è¯·å…ˆç™»å½•è®ºå›');
                    return;
                }

                // è·å–å½“å‰åˆ†é¡µçŠ¶æ€
                let state = this.activityMgr.getPageState('replies');
                
                // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ï¼Œé‡ç½®çŠ¶æ€
                if (!state.allItems || state.allItems.length === 0) {
                    state = { offset: 0, allItems: [], hasMore: true };
                }

                try {
                    const result = await this.activityMgr.getReplies(state.offset, username);
                    
                    // åˆå¹¶å›å¤ï¼ˆé¿å…é‡å¤ï¼Œä½¿ç”¨ post_id ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                    const existingIds = new Set(state.allItems.map(r => r.post_id));
                    const newItems = result.replies.filter(r => !existingIds.has(r.post_id));
                    state.allItems = [...state.allItems, ...newItems];
                    state.hasMore = result.hasMore;
                    
                    this.activityMgr.setPageState('replies', state);

                    container.innerHTML = this.renderer.renderReplyList(state.allItems, state.hasMore);
                    this._bindReplyClicks(container);

                    // ç»‘å®šç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
                    if (state.hasMore) {
                        this._bindActivityScroll(container, 'replies');
                    }
                } catch (e) {
                    if (state.allItems && state.allItems.length > 0) {
                        // å¦‚æœå·²æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå·²æœ‰æ•°æ®å¹¶æç¤ºåŠ è½½æ›´å¤šå¤±è´¥
                        container.innerHTML = this.renderer.renderReplyList(state.allItems, false);
                        this._bindReplyClicks(container);
                        this.renderer.showToast(`âš ï¸ ${e.message}`);
                    } else {
                        throw e;
                    }
                }
            }

            _bindReplyClicks(container) {
                container.querySelectorAll('.ldsp-reply-item[data-url]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯excerptå†…çš„é“¾æ¥ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
                        if (e.target.closest('.ldsp-reply-excerpt a')) {
                            return;
                        }
                        e.preventDefault();
                        const url = item.dataset.url;
                        if (url && url !== '#') {
                            window.open(url, '_blank');
                        }
                    });
                });
            }

            async _loadLikes(container) {
                // è·å–å½“å‰ç”¨æˆ·å
                const username = this.storage.getUser();
                if (!username) {
                    container.innerHTML = this.renderer.renderActivityEmpty('ğŸ”’', 'è¯·å…ˆç™»å½•è®ºå›');
                    return;
                }

                // è·å–å½“å‰åˆ†é¡µçŠ¶æ€
                let state = this.activityMgr.getPageState('likes');
                
                // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ï¼Œé‡ç½®çŠ¶æ€
                if (!state.allItems || state.allItems.length === 0) {
                    state = { offset: 0, allItems: [], hasMore: true };
                }

                try {
                    const result = await this.activityMgr.getLikes(state.offset, username);
                    
                    // åˆå¹¶èµè¿‡ï¼ˆé¿å…é‡å¤ï¼Œä½¿ç”¨ post_id ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                    const existingIds = new Set(state.allItems.map(l => l.post_id));
                    const newItems = result.likes.filter(l => !existingIds.has(l.post_id));
                    state.allItems = [...state.allItems, ...newItems];
                    state.hasMore = result.hasMore;
                    
                    this.activityMgr.setPageState('likes', state);

                    container.innerHTML = this.renderer.renderLikeList(state.allItems, state.hasMore);
                    this._bindLikeClicks(container);

                    // ç»‘å®šç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
                    if (state.hasMore) {
                        this._bindActivityScroll(container, 'likes');
                    }
                } catch (e) {
                    if (state.allItems && state.allItems.length > 0) {
                        // å¦‚æœå·²æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå·²æœ‰æ•°æ®å¹¶æç¤ºåŠ è½½æ›´å¤šå¤±è´¥
                        container.innerHTML = this.renderer.renderLikeList(state.allItems, false);
                        this._bindLikeClicks(container);
                        this.renderer.showToast(`âš ï¸ ${e.message}`);
                    } else {
                        throw e;
                    }
                }
            }

            _bindLikeClicks(container) {
                container.querySelectorAll('.ldsp-like-item[data-url]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯excerptå†…çš„é“¾æ¥ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
                        if (e.target.closest('.ldsp-like-excerpt a')) {
                            return;
                        }
                        e.preventDefault();
                        const url = item.dataset.url;
                        if (url && url !== '#') {
                            window.open(url, '_blank');
                        }
                    });
                });
            }

            async _loadMyTopics(container) {
                // è·å–å½“å‰ç”¨æˆ·å
                const username = this.storage.getUser();
                if (!username) {
                    container.innerHTML = this.renderer.renderActivityEmpty('ğŸ”’', 'è¯·å…ˆç™»å½•è®ºå›');
                    return;
                }

                // è·å–å½“å‰åˆ†é¡µçŠ¶æ€
                let state = this.activityMgr.getPageState('topics');
                
                // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ï¼Œé‡ç½®çŠ¶æ€
                if (!state.allItems || state.allItems.length === 0) {
                    state = { page: 0, allItems: [], hasMore: true };
                }

                try {
                    const result = await this.activityMgr.getMyTopics(state.page, username);
                    
                    // åˆå¹¶è¯é¢˜ï¼ˆé¿å…é‡å¤ï¼Œä½¿ç”¨ id ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                    const existingIds = new Set(state.allItems.map(t => t.id));
                    const newItems = result.topics.filter(t => !existingIds.has(t.id));
                    state.allItems = [...state.allItems, ...newItems];
                    state.hasMore = result.hasMore;
                    
                    this.activityMgr.setPageState('topics', state);

                    container.innerHTML = this.renderer.renderMyTopicList(state.allItems, state.hasMore);

                    // ç»‘å®šç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
                    if (state.hasMore) {
                        this._bindActivityScroll(container, 'topics');
                    }
                } catch (e) {
                    if (state.allItems && state.allItems.length > 0) {
                        // å¦‚æœå·²æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå·²æœ‰æ•°æ®å¹¶æç¤ºåŠ è½½æ›´å¤šå¤±è´¥
                        container.innerHTML = this.renderer.renderMyTopicList(state.allItems, false);
                        this.renderer.showToast(`âš ï¸ ${e.message}`);
                    } else {
                        throw e;
                    }
                }
            }

            async _loadReactions(container) {
                // è·å–å½“å‰ç”¨æˆ·å
                const username = this.storage.getUser();
                if (!username) {
                    container.innerHTML = this.renderer.renderActivityEmpty('ğŸ”’', 'è¯·å…ˆç™»å½•è®ºå›');
                    return;
                }

                // è·å–å½“å‰åˆ†é¡µçŠ¶æ€
                let state = this.activityMgr.getPageState('reactions');
                
                // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ï¼Œé‡ç½®çŠ¶æ€
                if (!state.allItems || state.allItems.length === 0) {
                    state = { lastId: null, allItems: [], hasMore: true };
                }

                try {
                    const result = await this.activityMgr.getReactions(state.lastId, username);
                    
                    // åˆå¹¶äº’åŠ¨è®°å½•ï¼ˆé¿å…é‡å¤ï¼Œä½¿ç”¨ id ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                    const existingIds = new Set(state.allItems.map(r => r.id));
                    const newItems = result.reactions.filter(r => !existingIds.has(r.id));
                    state.allItems = [...state.allItems, ...newItems];
                    state.hasMore = result.hasMore;
                    state.lastId = result.lastId;
                    
                    this.activityMgr.setPageState('reactions', state);

                    container.innerHTML = this.renderer.renderReactionList(state.allItems, state.hasMore);
                    this._bindReactionClicks(container);

                    // ç»‘å®šç€‘å¸ƒæµæ»šåŠ¨åŠ è½½
                    if (state.hasMore) {
                        this._bindActivityScroll(container, 'reactions');
                    }
                } catch (e) {
                    if (state.allItems && state.allItems.length > 0) {
                        // å¦‚æœå·²æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå·²æœ‰æ•°æ®å¹¶æç¤ºåŠ è½½æ›´å¤šå¤±è´¥
                        container.innerHTML = this.renderer.renderReactionList(state.allItems, false);
                        this._bindReactionClicks(container);
                        this.renderer.showToast(`âš ï¸ ${e.message}`);
                    } else {
                        throw e;
                    }
                }
            }

            _bindReactionClicks(container) {
                container.querySelectorAll('.ldsp-reaction-item[data-url]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯excerptå†…çš„é“¾æ¥ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
                        if (e.target.closest('.ldsp-reaction-excerpt a')) {
                            return;
                        }
                        e.preventDefault();
                        const url = item.dataset.url;
                        if (url && url !== '#') {
                            window.open(url, '_blank');
                        }
                    });
                });
            }

            _bindActivityScroll(container, type = 'read') {
                const content = this.el.querySelector('.ldsp-content');
                if (!content) return;

                let isLoading = false;
                const threshold = 100; // è·ç¦»åº•éƒ¨100pxæ—¶è§¦å‘åŠ è½½

                this._activityScrollHandler = async () => {
                    if (isLoading) return;
                    
                    const scrollTop = content.scrollTop;
                    const scrollHeight = content.scrollHeight;
                    const clientHeight = content.clientHeight;

                    if (scrollHeight - scrollTop - clientHeight < threshold) {
                        const state = this.activityMgr.getPageState(type);
                        if (!state.hasMore) return;

                        isLoading = true;
                        const loadMoreEl = container.querySelector('.ldsp-load-more');
                        if (loadMoreEl) {
                            loadMoreEl.classList.add('loading');
                        }

                        try {
                            // åŠ è½½ä¸‹ä¸€é¡µ
                            let result, newItems;
                            const username = this.storage.getUser();
                            
                            if (type === 'bookmarks') {
                                result = await this.activityMgr.getBookmarks(state.page, username);
                                const existingIds = new Set(state.allItems.map(b => b.id));
                                newItems = result.bookmarks.filter(b => !existingIds.has(b.id));
                                state.allItems = [...state.allItems, ...newItems];
                                state.hasMore = result.hasMore;
                                state.page = result.page + 1;
                                this.activityMgr.setPageState(type, state);
                                // æ ¹æ®æœç´¢è¯è¿‡æ»¤
                                const search = state.search || '';
                                const batchSize = state.batchSize || 20;
                                let filteredItems = state.allItems;
                                if (search) {
                                    const kw = search.toLowerCase();
                                    filteredItems = state.allItems.filter(b => 
                                        (b.title && b.title.toLowerCase().includes(kw)) ||
                                        (b.fancy_title && b.fancy_title.toLowerCase().includes(kw)) ||
                                        (b.tags && b.tags.some(tag => tag.toLowerCase().includes(kw))) ||
                                        (b.excerpt && b.excerpt.toLowerCase().includes(kw))
                                    );
                                }
                                container.innerHTML = this.renderer.renderBookmarkListWithSearch(filteredItems, state.hasMore && !search, search, batchSize, state.allItems.length);
                                this._bindBookmarkClicks(container);
                                this._bindBookmarkSearchEvents(container, state);
                            } else if (type === 'replies') {
                                state.offset += 30;
                                result = await this.activityMgr.getReplies(state.offset, username);
                                const existingIds = new Set(state.allItems.map(r => r.post_id));
                                newItems = result.replies.filter(r => !existingIds.has(r.post_id));
                                state.allItems = [...state.allItems, ...newItems];
                                state.hasMore = result.hasMore;
                                this.activityMgr.setPageState(type, state);
                                container.innerHTML = this.renderer.renderReplyList(state.allItems, state.hasMore);
                                this._bindReplyClicks(container);
                            } else if (type === 'likes') {
                                state.offset += 30;
                                result = await this.activityMgr.getLikes(state.offset, username);
                                const existingIds = new Set(state.allItems.map(l => l.post_id));
                                newItems = result.likes.filter(l => !existingIds.has(l.post_id));
                                state.allItems = [...state.allItems, ...newItems];
                                state.hasMore = result.hasMore;
                                this.activityMgr.setPageState(type, state);
                                container.innerHTML = this.renderer.renderLikeList(state.allItems, state.hasMore);
                                this._bindLikeClicks(container);
                            } else if (type === 'topics') {
                                state.page++;
                                result = await this.activityMgr.getMyTopics(state.page, username);
                                const existingIds = new Set(state.allItems.map(t => t.id));
                                newItems = result.topics.filter(t => !existingIds.has(t.id));
                                state.allItems = [...state.allItems, ...newItems];
                                state.hasMore = result.hasMore;
                                this.activityMgr.setPageState(type, state);
                                container.innerHTML = this.renderer.renderMyTopicList(state.allItems, state.hasMore);
                            } else if (type === 'reactions') {
                                result = await this.activityMgr.getReactions(state.lastId, username);
                                const existingIds = new Set(state.allItems.map(r => r.id));
                                newItems = result.reactions.filter(r => !existingIds.has(r.id));
                                state.allItems = [...state.allItems, ...newItems];
                                state.hasMore = result.hasMore;
                                state.lastId = result.lastId;
                                this.activityMgr.setPageState(type, state);
                                container.innerHTML = this.renderer.renderReactionList(state.allItems, state.hasMore);
                                this._bindReactionClicks(container);
                            } else {
                                // å·²è¯»è¯é¢˜ï¼šæ»šåŠ¨åŠ è½½ä½¿ç”¨é»˜è®¤å¤§å°ï¼ˆçº¦30æ¡/é¡µï¼‰
                                // state.page å­˜å‚¨çš„æ˜¯ä¸‹ä¸€é¡µçš„é¡µç 
                                result = await this.activityMgr.getReadTopics(state.page, 30);
                                const existingIds = new Set(state.allTopics.map(t => t.id));
                                newItems = result.topics.filter(t => !existingIds.has(t.id));
                                state.allTopics = [...state.allTopics, ...newItems];
                                state.hasMore = result.hasMore;
                                state.page = result.page + 1;  // ä¸‹ä¸€æ¬¡ä»ä¸‹ä¸€é¡µå¼€å§‹
                                this.activityMgr.setPageState(type, state);
                                // æ ¹æ®æœç´¢è¯è¿‡æ»¤
                                const search = state.search || '';
                                const batchSize = state.batchSize || 20;
                                let filteredTopics = state.allTopics;
                                if (search) {
                                    const kw = search.toLowerCase();
                                    filteredTopics = state.allTopics.filter(t => 
                                        (t.title && t.title.toLowerCase().includes(kw)) ||
                                        (t.tags && t.tags.some(tag => tag.toLowerCase().includes(kw)))
                                    );
                                }
                                container.innerHTML = this.renderer.renderTopicListWithSearch(filteredTopics, state.hasMore && !search, search, batchSize, state.allTopics.length);
                                this._bindReadSearchEvents(container, state);
                            }
                            
                            if (state.hasMore) {
                                // ç»§ç»­ç›‘å¬
                                isLoading = false;
                            } else {
                                this._cleanupActivityScroll();
                            }
                        } catch (e) {
                            this.renderer.showToast(`âš ï¸ åŠ è½½æ›´å¤šå¤±è´¥: ${e.message}`);
                            // å›é€€é¡µç /åç§»ï¼ˆreactions ä½¿ç”¨ lastIdï¼Œä¸éœ€è¦å›é€€ï¼‰
                            if (type === 'replies' || type === 'likes') {
                                state.offset -= 30;
                            } else if (type !== 'reactions') {
                                state.page--;
                            }
                            this.activityMgr.setPageState(type, state);
                            isLoading = false;
                            
                            if (loadMoreEl) {
                                loadMoreEl.classList.remove('loading');
                                loadMoreEl.innerHTML = '<span>åŠ è½½å¤±è´¥ï¼Œå‘ä¸‹æ»šåŠ¨é‡è¯•</span>';
                            }
                        }
                    }
                };

                content.addEventListener('scroll', this._activityScrollHandler, { passive: true });
            }

            _bindBookmarkClicks(container) {
                container.querySelectorAll('.ldsp-bookmark-item[data-url]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯excerptå†…çš„é“¾æ¥ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
                        if (e.target.closest('.ldsp-bookmark-excerpt a')) {
                            return;
                        }
                        e.preventDefault();
                        const url = item.dataset.url;
                        if (url && url !== '#') {
                            window.open(url, '_blank');
                        }
                    });
                });
            }

            _cleanupActivityScroll() {
                if (this._activityScrollHandler) {
                    const content = this.el.querySelector('.ldsp-content');
                    if (content) {
                        content.removeEventListener('scroll', this._activityScrollHandler);
                    }
                    this._activityScrollHandler = null;
                }
                // é‡ç½®åˆ†é¡µçŠ¶æ€
                this.activityMgr.setPageState('read', { page: 0, allTopics: [], hasMore: true, search: '', batchSize: 20 });
                this.activityMgr.setPageState('bookmarks', { page: 0, allItems: [], hasMore: true });
                this.activityMgr.setPageState('replies', { offset: 0, allItems: [], hasMore: true });
                this.activityMgr.setPageState('likes', { offset: 0, allItems: [], hasMore: true });
                this.activityMgr.setPageState('reactions', { lastId: null, allItems: [], hasMore: true });
                this.activityMgr.setPageState('topics', { page: 0, allItems: [], hasMore: true });
            }

            // ========== æ’è¡Œæ¦œ ==========

            async _renderLeaderboard() {
                if (!this.hasLeaderboard || !this.$.leaderboard) return;

                const logged = this.oauth.isLoggedIn();
                const joined = this.oauth.isJoined();

                this.renderer.renderLeaderboard(this.lbTab, logged, joined);

                this.$.leaderboard.querySelectorAll('.ldsp-subtab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.lbTab = tab.dataset.lb;
                        this.storage.setGlobal('leaderboardTab', this.lbTab);
                        this.$.leaderboard.querySelectorAll('.ldsp-subtab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this._renderLeaderboardContent();
                    });
                });

                await this._renderLeaderboardContent();
            }

            async _renderLeaderboardContent() {
                if (!this.hasLeaderboard) return;

                const container = this.$.leaderboard.querySelector('.ldsp-lb-content');
                if (!container) return;

                const logged = this.oauth.isLoggedIn();
                const joined = this.oauth.isJoined();

                if (!logged) {
                    container.innerHTML = this.renderer.renderLeaderboardLogin();
                    const loginBtn = container.querySelector('#ldsp-lb-login');
                    if (loginBtn) {
                        loginBtn.onclick = async () => {
                            loginBtn.disabled = true;
                            loginBtn.textContent = 'â³ è·³è½¬ä¸­...';
                            try {
                                // ç»Ÿä¸€åŒçª—å£ç™»å½•ï¼šä¼šè·³è½¬åˆ°æˆæƒé¡µé¢
                                await this.oauth.login();
                                // æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºé¡µé¢ä¼šè·³è½¬
                            } catch (e) {
                                this.renderer.showToast(`âŒ ${e.message}`);
                                loginBtn.disabled = false;
                                loginBtn.textContent = 'ğŸš€ ç«‹å³ç™»å½•';
                            }
                        };
                    }
                    return;
                }

                if (!joined) {
                    container.innerHTML = this.renderer.renderLeaderboardJoin();
                    const joinBtn = container.querySelector('#ldsp-lb-join');
                    if (joinBtn) {
                        joinBtn.onclick = async () => {
                            joinBtn.disabled = true;
                            joinBtn.textContent = 'â³ åŠ å…¥ä¸­...';
                            try {
                                await this.leaderboard.join();
                                this.leaderboard.startSync();
                                this.renderer.showToast('âœ… å·²æˆåŠŸåŠ å…¥æ’è¡Œæ¦œ');
                                await this._renderLeaderboardContent();
                            } catch (e) {
                                // v3.5.2.9: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼åŒ–
                                this.renderer.showToast(ErrorFormatter.withIcon(e));
                                joinBtn.disabled = false;
                                joinBtn.textContent = 'âœ¨ åŠ å…¥æ’è¡Œæ¦œ';
                            }
                        };
                    }
                    return;
                }

                container.innerHTML = this.renderer.renderLeaderboardLoading();

                try {
                    const data = await this.leaderboard.getLeaderboard(this.lbTab);
                    const user = this.oauth.getUserInfo();
                    container.innerHTML = this.renderer.renderLeaderboardData(data, user?.id, joined, this.lbTab);
                    this._bindLeaderboardEvents(container, joined);
                } catch (e) {
                    // v3.5.2.9: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼åŒ–
                    container.innerHTML = this.renderer.renderLeaderboardError(ErrorFormatter.format(e));
                    container.querySelector('#ldsp-lb-retry')?.addEventListener('click', () => {
                        this.leaderboard.clearCache();
                        this._renderLeaderboardContent();
                    });
                }
            }

            // ç»‘å®šæ’è¡Œæ¦œå†…å®¹åŒºçš„äº‹ä»¶ï¼ˆç»Ÿä¸€ç»‘å®šï¼Œé¿å…ä»£ç é‡å¤ï¼‰
            _bindLeaderboardEvents(container, joined) {
                // æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
                const refreshBtn = container.querySelector('.ldsp-lb-refresh');
                if (refreshBtn) {
                    refreshBtn.onclick = async (e) => {
                        const btn = e.target;
                        const type = btn.dataset.type;
                        if (btn.disabled) return;
                        
                        const cooldown = this.leaderboard.getRefreshCooldown(type);
                        if (cooldown > 0) {
                            this.renderer.showToast(`â³ è¯·ç­‰å¾… ${cooldown} ç§’åå†åˆ·æ–°`);
                            return;
                        }
                        
                        btn.disabled = true;
                        btn.classList.add('spinning');
                        
                        try {
                            const result = await this.leaderboard.forceRefresh(type);
                            this.renderer.showToast(result.fromCache ? 'ğŸ“¦ è·å–ç¼“å­˜æ•°æ®' : 'âœ… å·²åˆ·æ–°æ’è¡Œæ¦œ');
                            const userData = this.oauth.getUserInfo();
                            container.innerHTML = this.renderer.renderLeaderboardData(result.data, userData?.id, joined, type);
                            this._bindLeaderboardEvents(container, joined);
                        } catch (err) {
                            // v3.5.2.9: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼åŒ–
                            this.renderer.showToast(ErrorFormatter.withIcon(err));
                            btn.disabled = false;
                            btn.classList.remove('spinning');
                        }
                    };
                }

                // é€€å‡ºæ’è¡Œæ¦œæŒ‰é’®
                const quitBtn = container.querySelector('#ldsp-lb-quit');
                if (quitBtn) {
                    quitBtn.onclick = async () => {
                        const confirmed = await LDSPDialog.confirm('ç¡®å®šè¦é€€å‡ºæ’è¡Œæ¦œå—ï¼Ÿ', { title: 'é€€å‡ºæ’è¡Œæ¦œ', icon: 'ğŸšª', danger: true });
                        if (!confirmed) return;
                        quitBtn.disabled = true;
                        quitBtn.textContent = 'é€€å‡ºä¸­...';
                        try {
                            await this.leaderboard.quit();
                            this.leaderboard.stopSync();
                            this.renderer.showToast('âœ… å·²é€€å‡ºæ’è¡Œæ¦œ');
                            await this._renderLeaderboardContent();
                        } catch (e) {
                            // v3.5.2.9: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼åŒ–
                            this.renderer.showToast(ErrorFormatter.withIcon(e));
                            quitBtn.disabled = false;
                            quitBtn.textContent = 'é€€å‡ºæ’è¡Œæ¦œ';
                        }
                    };
                }
            }

            destroy() {
                if (this._destroyed) return;
                this._destroyed = true;
                
                // æ¸…ç†å®šæ—¶å™¨
                if (this._refreshTimer) {
                    clearInterval(this._refreshTimer);
                    this._refreshTimer = null;
                }
                if (this._readingTimer) {
                    clearInterval(this._readingTimer);
                    this._readingTimer = null;
                }
                
                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                if (this._resizeHandler) {
                    window.removeEventListener('resize', this._resizeHandler);
                }
                
                // æ¸…ç†é˜…è¯»è¿½è¸ªå™¨
                this.tracker?.destroy();
                
                // æ¸…ç†æ’è¡Œæ¦œç›¸å…³
                if (this.hasLeaderboard) {
                    this.leaderboard?.destroy();
                    this.cloudSync?.destroy();
                }
                
                // æ¸…ç†å·¥å•ç®¡ç†å™¨
                this.ticketManager?.destroy();

                // æ¸…ç†åƒç“œåŠ©æ‰‹
                this.melonHelper?.destroy();

                // æ¸…ç† LDC ç®¡ç†å™¨
                this.ldcManager?.destroy();

                // æ¸…ç† CDK ç®¡ç†å™¨
                this.cdkManager?.destroy();
                
                // æ¸…ç†å…³æ³¨/ç²‰ä¸ç®¡ç†å™¨
                this.followManager?.destroy();
                
                // ä¿å­˜æ•°æ®
                this.storage?.flush();
                
                // æ¸…ç†äº‹ä»¶æ€»çº¿
                EventBus.clear();
                
                // ç§»é™¤é¢æ¿
                this.el?.remove();
                
                Logger.log('Panel destroyed');
            }
        }

        // ==================== å¯åŠ¨ ====================
        async function startup() {
            // åˆå§‹åŒ–å…¨å±€é¢†å¯¼è€…ç®¡ç†å™¨ï¼ˆå¿…é¡»åœ¨å…¶ä»–ç»„ä»¶ä¹‹å‰ï¼‰
            TabLeader.init();
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ requestIdleCallback åœ¨ç©ºé—²æ—¶åŠ è½½éå…³é”®é…ç½®
            requestIdleCallback(() => {
                Network.loadReadingLevels().catch(() => {});
            }, { timeout: 3000 });
            
            // åˆ›å»ºé¢æ¿
            try {
                new Panel();
            } catch (e) {
                Logger.error('Panel initialization failed:', e);
            }
        }

        // ç¡®ä¿ DOM å°±ç»ªåå¯åŠ¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startup, { once: true });
        } else {
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ¸²æŸ“
            requestAnimationFrame(startup);
        }

    })();
